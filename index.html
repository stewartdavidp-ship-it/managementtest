<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Game Shelf Command Center</title>
    <meta name="version" content="8.2.1">
    <meta name="gs-app-id" content="management">
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    <style>
        * { box-sizing: border-box; }
        body { margin: 0; font-family: system-ui, -apple-system, sans-serif; background: #0f172a; color: #e2e8f0; }
        .animate-spin { animation: spin 1s linear infinite; }
        @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
        .fade-in { animation: fadeIn 0.2s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body>
    <div id="root"><div style="display:flex;align-items:center;justify-content:center;min-height:100vh;"><div style="text-align:center;"><div style="margin-bottom:20px;"><svg viewBox="0 0 100 100" width="64" height="64" xmlns="http://www.w3.org/2000/svg"><defs><linearGradient id="gsLoadGrad" x1="0%" y1="0%" x2="100%" y2="100%"><stop offset="0%" style="stop-color:#667eea"/><stop offset="100%" style="stop-color:#764ba2"/></linearGradient></defs><rect x="5" y="5" width="90" height="90" rx="20" fill="url(#gsLoadGrad)"/><g transform="rotate(-12, 35, 50)"><rect x="15" y="28" width="28" height="36" rx="4" fill="white"/><circle cx="43" cy="46" r="6" fill="white"/><text x="29" y="54" font-family="Arial" font-size="20" font-weight="bold" fill="#667eea" text-anchor="middle">G</text></g><g transform="rotate(12, 65, 50)"><rect x="57" y="28" width="28" height="36" rx="4" fill="rgba(255,255,255,0.9)"/><circle cx="57" cy="46" r="6" fill="url(#gsLoadGrad)"/><text x="71" y="54" font-family="Arial" font-size="20" font-weight="bold" fill="#764ba2" text-anchor="middle">S</text></g></svg></div>Loading...</div></div></div>

    <script type="text/babel">
    console.log('Command Center v8.2.1 starting...');
    
    // =========================================================================
    // FIREBASE CONFIG
    // =========================================================================
    
    const FIREBASE_CONFIG = {
        apiKey: "AIzaSyBQVwn8vOrFTzLlm2MYIPBwgZV2xR9AuhM",
        authDomain: "word-boxing.firebaseapp.com",
        databaseURL: "https://word-boxing-default-rtdb.firebaseio.com",
        projectId: "word-boxing"
    };
    
    // Custom domain mapping for repos
    // Maps repo full names to their custom domains
    const CUSTOM_DOMAINS = {
        'stewartdavidp-ship-it/gameshelf': 'gameshelf.co'
    };
    
    // Initialize Firebase
    let firebaseApp = null;
    let firebaseAuth = null;
    let firebaseDb = null;
    
    try {
        if (!firebase.apps.length) {
            firebaseApp = firebase.initializeApp(FIREBASE_CONFIG);
        } else {
            firebaseApp = firebase.apps[0];
        }
        firebaseAuth = firebase.auth();
        firebaseDb = firebase.database();
        console.log('Firebase initialized successfully');
    } catch (e) {
        console.error('Firebase init error:', e);
    }
    
    // =========================================================================
    // VERSION UTILITIES
    // =========================================================================
    
    function extractVersionFromHTML(content) {
        // Pattern 1: <meta name="version" content="1.0.0">
        const metaMatch = content.match(/<meta\s+name=["']version["']\s+content=["']([^"']+)["']/i);
        if (metaMatch) return metaMatch[1];
        
        // Pattern 2: <meta content="1.0.0" name="version">
        const metaMatch2 = content.match(/<meta\s+content=["']([^"']+)["']\s+name=["']version["']/i);
        if (metaMatch2) return metaMatch2[1];
        
        // Pattern 3: <!-- VERSION: 1.0.0 -->
        const commentMatch = content.match(/<!--\s*VERSION:\s*([^\s]+)\s*-->/i);
        if (commentMatch) return commentMatch[1];
        
        // Pattern 4: const APP_VERSION = '1.0.0' or "1.0.0"
        const constMatch = content.match(/(?:const|let|var)\s+(?:APP_)?VERSION\s*=\s*['"]([^'"]+)['"]/i);
        if (constMatch) return constMatch[1];
        
        // Pattern 5: data-version="1.0.0" on html or body tag
        const dataMatch = content.match(/data-version=["']([^"']+)["']/i);
        if (dataMatch) return dataMatch[1];
        
        // Pattern 6: "version": "1.0.0" in package.json style or inline JSON
        const jsonMatch = content.match(/["']version["']\s*:\s*["']([^"']+)["']/i);
        if (jsonMatch) return jsonMatch[1];
        
        // Pattern 7: @version 1.0.0 in JSDoc style comments
        const jsdocMatch = content.match(/@version\s+(\d+\.\d+\.\d+)/i);
        if (jsdocMatch) return jsdocMatch[1];
        
        // Pattern 8: Version 1.0.0 or v1.0.0 in title or comments
        const titleMatch = content.match(/(?:Version|v)[\s:]*(\d+\.\d+\.\d+)/i);
        if (titleMatch) return titleMatch[1];
        
        return null;
    }
    
    // Find ALL version-like strings in HTML for debugging
    function findAllVersionStrings(content) {
        const versions = [];
        
        // Helper to check if a match is inside a comment
        function isInComment(matchIndex) {
            const lineStart = content.lastIndexOf('\n', matchIndex) + 1;
            const lineContent = content.substring(lineStart, matchIndex);
            // Skip if line starts with // or * (comment) or contains Pattern/Example keywords
            return /^\s*(\/\/|\*|#)/.test(lineContent) || /Pattern|Example|e\.g\.|like/i.test(lineContent);
        }
        
        // Meta tag versions
        const metaMatches = content.matchAll(/<meta\s+[^>]*name=["']version["'][^>]*content=["']([^"']+)["'][^>]*>/gi);
        for (const m of metaMatches) {
            // Skip if the content contains template literal syntax
            if (m[1].includes('${') || m[1].includes('targetVersion')) continue;
            // Skip if inside a comment
            if (isInComment(m.index)) continue;
            versions.push({ source: 'meta tag', value: m[1], line: content.substring(0, m.index).split('\n').length });
        }
        // Also check reverse order: content before name
        const metaMatches2 = content.matchAll(/<meta\s+[^>]*content=["']([^"']+)["'][^>]*name=["']version["'][^>]*>/gi);
        for (const m of metaMatches2) {
            if (m[1].includes('${') || m[1].includes('targetVersion')) continue;
            // Skip if inside a comment
            if (isInComment(m.index)) continue;
            versions.push({ source: 'meta tag', value: m[1], line: content.substring(0, m.index).split('\n').length });
        }
        
        // JS variable versions - but NOT inside comments, template literals, or the integration module definition
        const jsMatches = content.matchAll(/^\s*const\s+(VERSION|APP_VERSION|GAME_VERSION)\s*=\s*['"]([^'"]+)['"]/gm);
        for (const m of jsMatches) {
            // Skip if it's inside the GameShelf integration module (those are module versions, not app versions)
            const before = content.substring(Math.max(0, m.index - 200), m.index);
            if (!before.includes('GAMESHELF_VERSION') && !before.includes('Integration Module')) {
                // Skip template literals and code examples
                if (m[2].includes('${') || m[2].includes('targetVersion')) continue;
                // Skip if inside a comment
                if (isInComment(m.index)) continue;
                versions.push({ source: `JS: ${m[1]}`, value: m[2], line: content.substring(0, m.index).split('\n').length });
            }
        }
        
        // Footer versions - look for patterns like "v1.0.0 ‚Ä¢" or ">v1.0.0<"
        // But skip anything in code comments or template literals
        const footerMatches = content.matchAll(/[>\s]v(\d+\.\d+\.\d+)\s*[‚Ä¢<¬∑]/g);
        for (const m of footerMatches) {
            // Check if this is inside a comment or code example
            const lineStart = content.lastIndexOf('\n', m.index) + 1;
            const lineContent = content.substring(lineStart, m.index);
            // Skip if line starts with // or * (comment) or contains Pattern or Example
            if (/^\s*(\/\/|\*|#)/.test(lineContent) || /Pattern|Example|e\.g\.|like/i.test(lineContent)) continue;
            versions.push({ source: 'footer/visible', value: m[1], line: content.substring(0, m.index).split('\n').length });
        }
        
        // Version in about/info sections
        const aboutMatches = content.matchAll(/Version:?\s*<\/?\w*>?\s*v?(\d+\.\d+\.\d+)/gi);
        for (const m of aboutMatches) {
            // Skip code comments
            const lineStart = content.lastIndexOf('\n', m.index) + 1;
            const lineContent = content.substring(lineStart, m.index);
            if (/^\s*(\/\/|\*|#)/.test(lineContent) || /Pattern|Example/i.test(lineContent)) continue;
            versions.push({ source: 'about/info text', value: m[1], line: content.substring(0, m.index).split('\n').length });
        }
        
        return versions;
    }
    
    // Validate version consistency in HTML content
    function validateVersions(content, filename) {
        const versions = findAllVersionStrings(content);
        const primary = extractVersionFromHTML(content);
        
        // Get unique version values
        const uniqueVersions = [...new Set(versions.map(v => v.value))];
        
        const result = {
            isValid: true,
            primary: primary,
            allVersions: versions,
            uniqueVersions: uniqueVersions,
            mismatches: [],
            missing: []
        };
        
        // Check for mismatches
        if (uniqueVersions.length > 1) {
            result.isValid = false;
            result.mismatches = versions.filter(v => v.value !== primary);
        }
        
        // Check for missing meta tag
        const hasMeta = versions.some(v => v.source === 'meta tag');
        if (!hasMeta) {
            result.isValid = false;
            result.missing.push('meta tag');
        }
        
        // Check for missing JS VERSION constant (for apps that should have one)
        const hasJsVersion = versions.some(v => v.source.startsWith('JS:'));
        if (!hasJsVersion && content.includes('const VERSION')) {
            // There's a VERSION constant but we didn't capture it - might be okay
        }
        
        return result;
    }
    
    // Auto-fix version strings in HTML content
    function fixVersionsInContent(content, targetVersion) {
        let fixed = content;
        
        // Fix or add meta tag
        const metaRegex = /<meta\s+name=["']version["']\s+content=["'][^"']*["']\s*\/?>/i;
        const metaRegex2 = /<meta\s+content=["'][^"']*["']\s+name=["']version["']\s*\/?>/i;
        
        if (metaRegex.test(fixed)) {
            fixed = fixed.replace(metaRegex, `<meta name="version" content="${targetVersion}">`);
        } else if (metaRegex2.test(fixed)) {
            fixed = fixed.replace(metaRegex2, `<meta name="version" content="${targetVersion}">`);
        } else {
            // Add meta tag after charset or viewport
            fixed = fixed.replace(
                /(<meta\s+[^>]*viewport[^>]*>)/i,
                `$1\n    <meta name="version" content="${targetVersion}">`
            );
        }
        
        // Fix const VERSION = 'x.x.x' (but not GAMESHELF_VERSION)
        fixed = fixed.replace(
            /(const\s+VERSION\s*=\s*['"])[^'"]*(['"])/g,
            `$1${targetVersion}$2`
        );
        
        // Fix footer versions like "v1.0.0 ‚Ä¢" or "v1.0.0 ¬∑"
        fixed = fixed.replace(
            /(>\s*)v\d+\.\d+\.\d+(\s*[‚Ä¢¬∑])/g,
            `$1v${targetVersion}$2`
        );
        
        // Fix about/version display
        fixed = fixed.replace(
            /(Version:?\s*<\/?\w*>?\s*)v?\d+\.\d+\.\d+/gi,
            `$1v${targetVersion}`
        );
        
        return fixed;
    }
    
    function parseVersion(version) {
        if (!version) return null;
        const parts = version.replace(/^v/i, '').split('.').map(p => parseInt(p, 10) || 0);
        while (parts.length < 4) parts.push(0);
        return parts;
    }
    
    function compareVersions(a, b) {
        const pa = parseVersion(a);
        const pb = parseVersion(b);
        if (!pa || !pb) return 0;
        for (let i = 0; i < 4; i++) {
            if (pa[i] > pb[i]) return 1;
            if (pa[i] < pb[i]) return -1;
        }
        return 0;
    }
    
    function isNewerVersion(newVersion, currentVersion) {
        if (!currentVersion) return true;
        return compareVersions(newVersion, currentVersion) > 0;
    }
    
    function formatVersion(v) {
        return v ? `v${v}` : '‚Äî';
    }

    // =========================================================================
    // DYNAMIC CONFIGURATION SYSTEM (v7.0.0)
    // =========================================================================
    
    // Environment definitions - extensible for dev, test, prod, beta
    const DEFAULT_ENVIRONMENTS = {
        available: ['dev', 'test', 'prod', 'beta'],
        active: ['test', 'prod'],  // Currently enabled
        colors: {
            dev: { bg: 'bg-purple-600', text: 'text-purple-300', border: 'border-purple-500', hex: '#9333ea' },
            test: { bg: 'bg-blue-600', text: 'text-blue-300', border: 'border-blue-500', hex: '#2563eb' },
            prod: { bg: 'bg-green-600', text: 'text-green-300', border: 'border-green-500', hex: '#16a34a' },
            beta: { bg: 'bg-orange-600', text: 'text-orange-300', border: 'border-orange-500', hex: '#ea580c' }
        },
        labels: { dev: 'DEV', test: 'TEST', prod: 'PROD', beta: 'BETA' },
        icons: { dev: 'üõ†Ô∏è', test: 'üß™', prod: 'üöÄ', beta: 'üî¨' }
    };
    
    // Default app definitions
    const DEFAULT_APP_DEFINITIONS = {
        gameshelf: {
            id: 'gameshelf', name: 'Game Shelf', icon: 'gs-logo',
            targetPath: 'index.html', swPath: 'sw.js', hasServiceWorker: true,
            subPath: '',  // Root of consolidated repo
            repos: { dev: '', test: '', prod: '', beta: '' },
            versions: { dev: '', test: '', prod: '', beta: '' },
            repoPatterns: {
                dev: ['gameshelfdev', 'gameshelf-dev'],
                test: ['gameshelftest', 'gameshelf-test'],
                prod: ['gameshelf'],
                beta: ['gameshelfbeta', 'gameshelf-beta']
            },
            detectionPatterns: ['<title>game\\s*shelf', 'gameshelfdata', 'game.shelf.pwa', '#setup-welcome']
        },
        slate: {
            id: 'slate', name: 'Slate', icon: 'ü™®',
            targetPath: 'index.html', swPath: 'sw.js', hasServiceWorker: true,
            subPath: 'slate',  // Subfolder in consolidated repo
            repos: { dev: '', test: '', prod: '', beta: '' },
            versions: { dev: '', test: '', prod: '', beta: '' },
            repoPatterns: {
                dev: ['slatedev', 'slate-dev'],
                test: ['slatetest', 'slate-test'],
                prod: ['slate'],
                beta: ['slatebeta', 'slate-beta']
            },
            detectionPatterns: ['<title>slate', 'slate.*daily.*word', 'chalkboard-bg', 'slate-board']
        },
        rungs: {
            id: 'rungs', name: 'Rungs', icon: 'ü™ú',
            targetPath: 'index.html', swPath: 'sw.js', hasServiceWorker: true,
            subPath: 'rungs',  // Subfolder in consolidated repo
            repos: { dev: '', test: '', prod: '', beta: '' },
            versions: { dev: '', test: '', prod: '', beta: '' },
            repoPatterns: {
                dev: ['rungsdev', 'rungs-dev'],
                test: ['rungstest', 'rungs-test'],
                prod: ['rungs'],
                beta: ['rungsbeta', 'rungs-beta']
            },
            detectionPatterns: ['<title>rungs', 'rungs.*daily', 'word-ladder', 'rung-container']
        },
        quotle: {
            id: 'quotle', name: 'Quotle', icon: 'üí¨',
            targetPath: 'index.html', swPath: 'sw.js', hasServiceWorker: true,
            subPath: 'quotle',  // Subfolder in consolidated repo
            repos: { dev: '', test: '', prod: '', beta: '' },
            versions: { dev: '', test: '', prod: '', beta: '' },
            repoPatterns: {
                dev: ['quotledev', 'quotle-dev'],
                test: ['quotletest', 'quotle-test'],
                prod: ['quotle'],
                beta: ['quotlebeta', 'quotle-beta']
            },
            detectionPatterns: ['<title>quotle', 'quotle.*daily.*quote', 'quotes-database']
        },
        wordboxing: {
            id: 'wordboxing', name: 'Word Boxing', icon: 'ü•ä',
            targetPath: 'index.html', swPath: 'sw.js', hasServiceWorker: true,
            subPath: 'wordboxing',  // Subfolder in consolidated repo
            repos: { dev: '', test: '', prod: '', beta: '' },
            versions: { dev: '', test: '', prod: '', beta: '' },
            repoPatterns: {
                dev: ['wordboxingdev', 'wordboxing-dev'],
                test: ['wordboxingtest', 'wordboxing-test'],
                prod: ['wordboxing', 'word-boxing'],
                beta: ['wordboxingbeta', 'wordboxing-beta']
            },
            detectionPatterns: ['<title>word\\s*boxing', 'word-boxing', 'boxing-ring']
        },
        testplan: {
            id: 'testplan', name: 'Test Plan', icon: 'üß™',
            targetPath: 'index.html', swPath: '', hasServiceWorker: false,
            subPath: '',  // Not in consolidated repo
            repos: { dev: '', test: '', prod: '', beta: '' },
            versions: { dev: '', test: '', prod: '', beta: '' },
            repoPatterns: {
                dev: ['testplandev', 'testplan-dev'],
                test: ['gameshelf-testplan'],
                prod: ['testplan'],
                beta: ['testplanbeta', 'testplan-beta']
            },
            detectionPatterns: ['<title>.*test\\s*plan', 'playwright.*runner', 'test-plan-app']
        },
        management: {
            id: 'management', name: 'Command Center', icon: 'üéõÔ∏è',
            targetPath: 'index.html', swPath: '', hasServiceWorker: false,
            subPath: '',  // Not in consolidated repo
            repos: { dev: '', test: '', prod: '', beta: '' },
            versions: { dev: '', test: '', prod: '', beta: '' },
            repoPatterns: {
                dev: ['managementdev', 'management-dev'],
                test: ['managementtest', 'management-test'],
                prod: ['management', 'managementprod'],
                beta: ['managementbeta', 'management-beta']
            },
            detectionPatterns: ['<title>.*command\\s*center', '<title>.*ship\\s*it', 'command-center', 'claude.*deploy.*queue']
        },
        edutrack: {
            id: 'edutrack', name: 'EduTrack', icon: 'üìö',
            targetPath: 'index.html', swPath: 'sw.js', hasServiceWorker: true,
            subPath: '',  // Standalone repo
            repos: { dev: '', test: '', prod: '', beta: '' },
            versions: { dev: '', test: '', prod: '', beta: '' },
            repoPatterns: {
                dev: ['edutrackdev', 'edutrack-dev'],
                test: ['edutracktest', 'edutrack-test'],
                prod: ['edutrack'],
                beta: ['edutrackbeta', 'edutrack-beta']
            },
            detectionPatterns: ['<title>edutrack', 'edutrack-data', 'ET-[A-Z]{2}-\\d{3}', 'student-codes']
        },
        landing: {
            id: 'landing', name: 'Landing Page', icon: 'üöÄ',
            targetPath: 'index.html', swPath: '', hasServiceWorker: false,
            subPath: '',  // Standalone repo
            repos: { dev: '', test: '', prod: '', beta: '' },
            versions: { dev: '', test: '', prod: '', beta: '' },
            repoPatterns: {
                dev: ['game-shelf-landing-dev'],
                test: ['game-shelf-landing-test'],
                prod: ['game-shelf-landing'],
                beta: ['game-shelf-landing-beta']
            },
            detectionPatterns: ['<title>game\\s*shelf.*track', 'game-shelf-landing', 'track.*every.*daily.*puzzle']
        },
        'firebase-functions': {
            id: 'firebase-functions', name: 'Firebase Functions', icon: '‚ö°',
            targetPath: 'functions/index.js', swPath: '', hasServiceWorker: false,
            subPath: '',  // Standalone repo
            deployType: 'github-actions',  // Special flag: deployment handled by GitHub Actions
            repos: { dev: '', test: '', prod: '', beta: '' },
            versions: { dev: '', test: '', prod: '', beta: '' },
            repoPatterns: {
                dev: ['gameshelf-functions-dev'],
                test: ['gameshelf-functions-test'],
                prod: ['gameshelf-functions'],
                beta: ['gameshelf-functions-beta']
            },
            detectionPatterns: ['firebase-functions', 'onRequest', 'onCall', 'getHint', 'ANTHROPIC_API_KEY']
        }
    };
    
    // Configuration manager
    const ConfigManager = {
        STORAGE_KEY: 'commandCenterConfig',
        REPO_STORAGE_KEY: 'githubRepoAssignments',
        
        // Load config from localStorage or use defaults
        load() {
            try {
                const stored = localStorage.getItem(this.STORAGE_KEY);
                if (stored) {
                    const config = JSON.parse(stored);
                    return this.mergeWithDefaults(config);
                }
            } catch (e) {
                console.warn('Failed to load config, using defaults:', e);
            }
            return this.getDefaultConfig();
        },
        
        // Save config to localStorage
        save(config) {
            try {
                localStorage.setItem(this.STORAGE_KEY, JSON.stringify(config));
                return true;
            } catch (e) {
                console.error('Failed to save config:', e);
                return false;
            }
        },
        
        // Get default configuration
        getDefaultConfig() {
            return {
                version: '7.0.0',
                environments: { ...DEFAULT_ENVIRONMENTS },
                apps: JSON.parse(JSON.stringify(DEFAULT_APP_DEFINITIONS))
            };
        },
        
        // Merge stored config with defaults (handles upgrades)
        mergeWithDefaults(stored) {
            const defaults = this.getDefaultConfig();
            
            // Ensure environments structure
            if (!stored.environments) {
                stored.environments = defaults.environments;
            } else {
                stored.environments = { ...defaults.environments, ...stored.environments };
            }
            
            // Ensure all default apps exist (but preserve user's repo mappings)
            for (const [id, defaultApp] of Object.entries(defaults.apps)) {
                if (!stored.apps[id]) {
                    stored.apps[id] = defaultApp;
                } else {
                    // Merge to ensure new fields are added
                    stored.apps[id] = { ...defaultApp, ...stored.apps[id] };
                    stored.apps[id].repos = { ...defaultApp.repos, ...(stored.apps[id].repos || {}) };
                    stored.apps[id].versions = { ...defaultApp.versions, ...(stored.apps[id].versions || {}) };
                }
            }
            
            return stored;
        },
        
        // Migrate from old format (testRepo/prodRepo to repos object)
        migrateFromOldFormat(oldApps, config) {
            const repoAssignments = JSON.parse(localStorage.getItem(this.REPO_STORAGE_KEY) || '{}');
            
            for (const [id, oldApp] of Object.entries(oldApps)) {
                if (config.apps[id]) {
                    // Check repo assignments first, then fall back to old format
                    const assignment = repoAssignments[id] || {};
                    config.apps[id].repos.test = assignment.testRepo || oldApp.testRepo || '';
                    config.apps[id].repos.prod = assignment.prodRepo || oldApp.prodRepo || '';
                    config.apps[id].versions.test = oldApp.currentTestVersion || '';
                    config.apps[id].versions.prod = oldApp.currentProdVersion || '';
                }
            }
            
            return config;
        },
        
        // Add a new app
        addApp(config, appData) {
            const id = appData.id || appData.name.toLowerCase().replace(/\s+/g, '');
            config.apps[id] = {
                id,
                name: appData.name,
                icon: appData.icon || 'üì¶',
                targetPath: appData.targetPath || 'index.html',
                swPath: appData.swPath || '',
                hasServiceWorker: appData.hasServiceWorker || false,
                repos: { dev: '', test: '', prod: '', beta: '' },
                versions: { dev: '', test: '', prod: '', beta: '' },
                repoPatterns: {
                    dev: [`${id}dev`, `${id}-dev`],
                    test: [`${id}test`, `${id}-test`],
                    prod: [id],
                    beta: [`${id}beta`, `${id}-beta`]
                },
                detectionPatterns: appData.detectionPatterns || [`<title>${appData.name.toLowerCase()}`]
            };
            return config;
        },
        
        // Remove an app
        removeApp(config, appId) {
            delete config.apps[appId];
            return config;
        },
        
        // Update app
        updateApp(config, appId, updates) {
            if (config.apps[appId]) {
                config.apps[appId] = { ...config.apps[appId], ...updates };
            }
            return config;
        },
        
        // Enable/disable an environment
        toggleEnvironment(config, envId) {
            const idx = config.environments.active.indexOf(envId);
            if (idx >= 0) {
                // Don't allow disabling all environments
                if (config.environments.active.length > 1) {
                    config.environments.active.splice(idx, 1);
                }
            } else {
                config.environments.active.push(envId);
                // Sort by the defined order
                config.environments.active.sort((a, b) => 
                    config.environments.available.indexOf(a) - config.environments.available.indexOf(b)
                );
            }
            return config;
        },
        
        // Convert config to legacy apps format for backward compatibility
        toLegacyAppsFormat(config) {
            const apps = {};
            const activeEnvs = config.environments.active;
            
            for (const [id, app] of Object.entries(config.apps)) {
                apps[id] = {
                    id: app.id,
                    name: app.name,
                    icon: app.icon,
                    targetPath: app.targetPath,
                    swPath: app.swPath,
                    hasServiceWorker: app.hasServiceWorker,
                    repoPatterns: app.repoPatterns,
                    // Legacy format fields
                    testRepo: app.repos.test || '',
                    prodRepo: app.repos.prod || '',
                    currentTestVersion: app.versions.test || '',
                    currentProdVersion: app.versions.prod || '',
                    // New format - include all env repos
                    repos: app.repos,
                    versions: app.versions
                };
            }
            
            return apps;
        },
        
        // Build detection signatures from config
        buildDetectionSignatures(config) {
            return Object.values(config.apps).map(app => ({
                id: app.id,
                patterns: app.detectionPatterns.map(p => {
                    try {
                        return new RegExp(p, 'i');
                    } catch (e) {
                        console.warn(`Invalid pattern for ${app.id}: ${p}`);
                        return null;
                    }
                }).filter(Boolean),
                confidence: 'high'
            }));
        },
        
        // Get active environments
        getActiveEnvironments(config) {
            return config.environments.active;
        },
        
        // Get environment display info
        getEnvDisplay(config, envId) {
            return {
                label: config.environments.labels[envId] || envId.toUpperCase(),
                icon: config.environments.icons[envId] || 'üì¶',
                colors: config.environments.colors[envId] || config.environments.colors.test
            };
        }
    };

    // =========================================================================
    // ICONS
    // =========================================================================
    
    const Icons = {
        // Game Shelf badge logo (puzzle pieces G and S)
        GameShelfLogo: ({ size = 20 }) => (
            <svg viewBox="0 0 100 100" width={size} height={size} xmlns="http://www.w3.org/2000/svg">
                <defs>
                    <linearGradient id="gsBadgeGrad" x1="0%" y1="0%" x2="100%" y2="100%">
                        <stop offset="0%" style={{stopColor:'#667eea'}}/>
                        <stop offset="100%" style={{stopColor:'#764ba2'}}/>
                    </linearGradient>
                </defs>
                <rect x="5" y="5" width="90" height="90" rx="20" fill="url(#gsBadgeGrad)"/>
                <g transform="rotate(-12, 35, 50)">
                    <rect x="15" y="28" width="28" height="36" rx="4" fill="white"/>
                    <circle cx="43" cy="46" r="6" fill="white"/>
                    <text x="29" y="54" fontFamily="Arial" fontSize="20" fontWeight="bold" fill="#667eea" textAnchor="middle">G</text>
                </g>
                <g transform="rotate(12, 65, 50)">
                    <rect x="57" y="28" width="28" height="36" rx="4" fill="rgba(255,255,255,0.9)"/>
                    <circle cx="57" cy="46" r="6" fill="url(#gsBadgeGrad)"/>
                    <text x="71" y="54" fontFamily="Arial" fontSize="20" fontWeight="bold" fill="#764ba2" textAnchor="middle">S</text>
                </g>
            </svg>
        ),
        Upload: () => <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12" /></svg>,
        Rocket: () => <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M15.59 14.37a6 6 0 01-5.84 7.38v-4.8m5.84-2.58a14.98 14.98 0 006.16-12.12A14.98 14.98 0 009.631 8.41m5.96 5.96a14.926 14.926 0 01-5.841 2.58m-.119-8.54a6 6 0 00-7.381 5.84h4.8m2.581-5.84a14.927 14.927 0 00-2.58 5.84m2.699 2.7c-.103.021-.207.041-.311.06a15.09 15.09 0 01-2.448-2.448 14.9 14.9 0 01.06-.312m-2.24 2.39a4.493 4.493 0 00-1.757 4.306 4.493 4.493 0 004.306-1.758M16.5 9a1.5 1.5 0 11-3 0 1.5 1.5 0 013 0z" /></svg>,
        X: () => <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M6 18L18 6M6 6l12 12" /></svg>,
        Settings: () => <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" /><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" /></svg>,
        History: () => <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>,
        ExternalLink: () => <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14" /></svg>,
        ArrowRight: () => <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M14 5l7 7m0 0l-7 7m7-7H3" /></svg>,
        Zap: () => <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M13 10V3L4 14h7v7l9-11h-7z" /></svg>,
        AlertTriangle: () => <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" /></svg>,
        Rewind: () => <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12.066 11.2a1 1 0 000 1.6l5.334 4A1 1 0 0019 16V8a1 1 0 00-1.6-.8l-5.333 4zM4.066 11.2a1 1 0 000 1.6l5.334 4A1 1 0 0011 16V8a1 1 0 00-1.6-.8l-5.334 4z" /></svg>,
        GitBranch: () => <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M8 9l3 3-3 3m5 0h3M5 20h14a2 2 0 002-2V6a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" /></svg>,
        Check: () => <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M5 13l4 4L19 7" /></svg>,
        Shield: () => <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z" /></svg>,
        Refresh: () => <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" /></svg>,
        Play: () => <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M14.752 11.168l-3.197-2.132A1 1 0 0010 9.87v4.263a1 1 0 001.555.832l3.197-2.132a1 1 0 000-1.664z" /><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>,
        Folder: () => <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M3 7v10a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-6l-2-2H5a2 2 0 00-2 2z" /></svg>,
        File: () => <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" /></svg>,
        Trash: () => <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg>,
        Archive: () => <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M5 8h14M5 8a2 2 0 110-4h14a2 2 0 110 4M5 8v10a2 2 0 002 2h10a2 2 0 002-2V8m-9 4h4" /></svg>,
        Eye: () => <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" /><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" /></svg>,
        Download: () => <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" /></svg>,
        Plus: () => <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 4v16m8-8H4" /></svg>,
        Database: () => <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4 7v10c0 2.21 3.582 4 8 4s8-1.79 8-4V7M4 7c0 2.21 3.582 4 8 4s8-1.79 8-4M4 7c0-2.21 3.582-4 8-4s8 1.79 8 4m0 5c0 2.21-3.582 4-8 4s-8-1.79-8-4" /></svg>,
        User: () => <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" /></svg>,
        AlertCircle: () => <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>,
        Edit: () => <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" /></svg>,
        Copy: () => <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z" /></svg>,
    };
    
    // Helper to render app icons (handles both emojis and special logo identifiers)
    const AppIcon = ({ icon, size = 20 }) => {
        if (icon === 'gs-logo') {
            return <Icons.GameShelfLogo size={size} />;
        }
        // Return emoji as-is
        return <span style={{ fontSize: size * 0.9 }}>{icon}</span>;
    };
    
    // Helper for native <option> elements that can't render components
    const getAppEmoji = (icon) => {
        if (icon === 'gs-logo') return 'üéÆ'; // Fallback emoji for Game Shelf
        return icon || 'üì¶';
    };

    // =========================================================================
    // UTILITIES
    // =========================================================================
    
    function parseFilename(filename) {
        const patterns = [
            /^(gameshelf|game[-_]?shelf)[-_]v?(\d+)[_.](\d+)[_.](\d+)[_.](\d+)\.html$/i,
            /^(\w+)[-_]v?(\d+)[_.](\d+)[_.](\d+)\.html$/i,
        ];
        for (const pattern of patterns) {
            const match = filename.match(pattern);
            if (match) {
                let app = match[1].toLowerCase().replace(/[-_]/g, '');
                const version = match.length === 6 
                    ? `${match[2]}.${match[3]}.${match[4]}.${match[5]}`
                    : `${match[2]}.${match[3]}.${match[4]}`;
                return { app, version };
            }
        }
        const appMatch = filename.match(/^(\w+)/);
        return { app: appMatch ? appMatch[1].toLowerCase() : null, version: null };
    }
    
    // Detect app from HTML content
    // Primary: Explicit gs-app-id meta tag (definitive, permanent)
    // Fallback: Pattern matching for legacy files
    function detectAppFromContent(content) {
        if (!content || typeof content !== 'string') return null;
        
        // =====================================================================
        // PRIMARY: Check for explicit app identifier (100% reliable)
        // Format: <meta name="gs-app-id" content="appname">
        // =====================================================================
        const appIdMatch = content.match(/<meta\s+name=["']gs-app-id["']\s+content=["']([^"']+)["']/i);
        if (appIdMatch) {
            const appId = appIdMatch[1].toLowerCase();
            return {
                id: appId,
                confidence: 'definite',
                method: 'gs-app-id',
                matchCount: 1,
                matchedPatterns: ['gs-app-id meta tag']
            };
        }
        
        // =====================================================================
        // FALLBACK: Pattern matching for legacy files without gs-app-id
        // This can be removed once all apps have the meta tag
        // =====================================================================
        const sample = content.substring(0, 5000).toLowerCase();
        
        // Legacy signatures - ordered by specificity
        const signatures = [
            {
                id: 'management',
                patterns: [
                    /<title>.*command\s*center/i,
                    /<title>.*ship\s*it/i,
                    /command-center/i,
                    /claude.*deploy.*queue/i
                ]
            },
            {
                id: 'gameshelf',
                patterns: [
                    /<title>game\s*shelf/i,
                    /gameshelfdata/i,
                    /game\.shelf\.pwa/i,
                    /#setup-welcome/i
                ]
            },
            {
                id: 'testplan',
                patterns: [
                    /<title>.*test\s*plan/i,
                    /playwright.*runner/i,
                    /lean-tests\.spec/i
                ]
            },
            {
                id: 'quotle',
                patterns: [
                    /<title>quotle/i,
                    /quotle.*daily.*quote/i,
                    /quotes-database/i
                ]
            },
            {
                id: 'slate',
                patterns: [
                    /<title>slate/i,
                    /slate.*daily.*word/i,
                    /chalkboard-bg/i
                ]
            },
            {
                id: 'rungs',
                patterns: [
                    /<title>rungs/i,
                    /rungs.*daily/i,
                    /word-ladder/i
                ]
            },
            {
                id: 'wordboxing',
                patterns: [
                    /<title>word\s*boxing/i,
                    /word-boxing/i,
                    /boxing-ring/i
                ]
            },
            {
                id: 'edutrack',
                patterns: [
                    /<title>edutrack/i,
                    /edutrack-data/i,
                    /ET-[A-Z]{2}-\d{3}/,
                    /student-codes/i
                ]
            },
            {
                id: 'firebase-functions',
                patterns: [
                    /firebase-functions/i,
                    /exports\.getHint/i,
                    /onRequest|onCall/i,
                    /ANTHROPIC_API_KEY/i
                ]
            }
        ];
        
        // Check each app's signatures
        for (const app of signatures) {
            let matchCount = 0;
            let matchedPatterns = [];
            
            for (const pattern of app.patterns) {
                if (pattern.test(content)) {
                    matchCount++;
                    matchedPatterns.push(pattern.toString());
                }
            }
            
            if (matchCount > 0) {
                return {
                    id: app.id,
                    confidence: matchCount >= 2 ? 'high' : 'medium',
                    method: 'pattern-match',
                    matchCount,
                    matchedPatterns
                };
            }
        }
        
        return null;
    }
    
    function formatBytes(bytes) {
        if (bytes < 1024) return bytes + ' B';
        if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + ' KB';
        return (bytes / (1024 * 1024)).toFixed(2) + ' MB';
    }
    
    function formatDate(date) {
        return new Date(date).toLocaleString();
    }
    
    // Get the URL for a GitHub Pages site
    // Supports custom domains and subPaths for consolidated repos
    function getGitHubPagesUrl(repo, subPath = '') {
        if (!repo) return null;
        const [owner, repoName] = repo.split('/');
        
        // Check for custom domain
        if (CUSTOM_DOMAINS[repo]) {
            const domain = CUSTOM_DOMAINS[repo];
            // Custom domain - subPath goes after domain
            if (subPath) {
                return `https://${domain}/${subPath}/`;
            }
            return `https://${domain}/`;
        }
        
        // Standard GitHub Pages URL
        if (subPath) {
            return `https://${owner}.github.io/${repoName}/${subPath}/`;
        }
        return `https://${owner}.github.io/${repoName}/`;
    }
    
    // Helper to get full file path in repo (prepends subPath if needed)
    function getRepoFilePath(app, filename) {
        if (app.subPath) {
            return `${app.subPath}/${filename}`;
        }
        return filename;
    }
    
    function autoMapRepos(apps, repos) {
        const updatedApps = { ...apps };
        console.log('Auto-mapping repos. Available:', repos.map(r => r.name));
        
        for (const [appId, app] of Object.entries(updatedApps)) {
            const patterns = app.repoPatterns;
            if (!patterns) continue;
            
            if (!app.testRepo) {
                for (const pattern of patterns.test) {
                    const found = repos.find(r => r.name.toLowerCase() === pattern.toLowerCase());
                    if (found) { 
                        console.log(`[${appId}] Mapped TEST: ${found.fullName}`);
                        updatedApps[appId] = { ...updatedApps[appId], testRepo: found.fullName }; 
                        break; 
                    }
                }
            }
            if (!app.prodRepo) {
                for (const pattern of patterns.prod) {
                    const found = repos.find(r => r.name.toLowerCase() === pattern.toLowerCase() && !r.name.toLowerCase().includes('test'));
                    if (found) { 
                        console.log(`[${appId}] Mapped PROD: ${found.fullName}`);
                        updatedApps[appId] = { ...updatedApps[appId], prodRepo: found.fullName }; 
                        break; 
                    }
                }
            }
        }
        return updatedApps;
    }
    
    function getFileIcon(filename) {
        const ext = filename.split('.').pop()?.toLowerCase();
        const icons = {
            html: 'üìÑ', js: 'üìú', css: 'üé®', json: 'üìã', md: 'üìù',
            png: 'üñºÔ∏è', jpg: 'üñºÔ∏è', jpeg: 'üñºÔ∏è', gif: 'üñºÔ∏è', svg: 'üé®',
            ico: 'üî∑', txt: 'üìÉ', xml: 'üì∞', yml: '‚öôÔ∏è', yaml: '‚öôÔ∏è'
        };
        return icons[ext] || 'üìÑ';
    }

    // =========================================================================
    // GITHUB API
    // =========================================================================
    
    class GitHubAPI {
        constructor(token) {
            this.token = token;
            this.baseUrl = 'https://api.github.com';
        }
        
        // Helper: Clean base64 content from GitHub (remove newlines)
        cleanBase64(content) {
            return content ? content.replace(/[\r\n\s]/g, '') : '';
        }
        
        // Helper: Decode base64 content from GitHub to UTF-8 string
        decodeContent(content) {
            const clean = this.cleanBase64(content);
            return decodeURIComponent(escape(atob(clean)));
        }
        
        async request(endpoint, options = {}) {
            const url = `${this.baseUrl}${endpoint}`;
            try {
                const response = await fetch(url, {
                    ...options,
                    headers: {
                        'Authorization': `token ${this.token}`,
                        'Accept': 'application/vnd.github.v3+json',
                        'Content-Type': 'application/json',
                        ...options.headers
                    }
                });
                if (!response.ok) {
                    const error = await response.json().catch(() => ({}));
                    console.error('GitHub API Error:', {
                        url,
                        status: response.status,
                        error,
                        body: options.body ? JSON.parse(options.body) : null
                    });
                    throw new Error(error.message || `GitHub API error: ${response.status}`);
                }
                return response.json();
            } catch (e) {
                console.error('Request failed:', url, e);
                throw e;
            }
        }
        
        async listRepos() {
            const repos = await this.request('/user/repos?per_page=100&sort=updated');
            return repos.map(r => ({ fullName: r.full_name, name: r.name, owner: r.owner.login }));
        }
        
        async getFile(repo, path) {
            try {
                const [owner, repoName] = repo.split('/');
                // Add timestamp to bust GitHub API cache
                return await this.request(`/repos/${owner}/${repoName}/contents/${path}?_=${Date.now()}`);
            } catch { return null; }
        }
        
        // Get file content - handles large files (>1MB) that GitHub API doesn't return content for
        async getFileContent(repo, path) {
            try {
                const file = await this.getFile(repo, path);
                if (!file) return null;
                
                // For large files (>1MB), GitHub API doesn't return content - use download_url
                if (!file.content && file.download_url) {
                    console.log(`Large file detected (${path}), using download_url`);
                    // Add cache-busting to download_url
                    const cacheBustUrl = file.download_url + (file.download_url.includes('?') ? '&' : '?') + '_=' + Date.now();
                    const response = await fetch(cacheBustUrl);
                    const content = await response.text();
                    return { ...file, content: null, textContent: content };
                }
                
                // Normal file - decode base64 content
                const textContent = this.decodeContent(file.content);
                return { ...file, textContent };
            } catch (e) {
                console.warn(`Failed to get file content for ${path}:`, e);
                return null;
            }
        }
        
        // Get file content at specific commit - handles large files
        async getFileContentAtCommit(repo, path, commitSha) {
            try {
                const file = await this.getFileAtCommit(repo, path, commitSha);
                if (!file) return null;
                
                // For large files, use raw URL with commit ref
                if (!file.content && file.download_url) {
                    console.log(`Large file detected at commit (${path}), using download_url`);
                    const response = await fetch(file.download_url);
                    const content = await response.text();
                    return { ...file, content: null, textContent: content };
                }
                
                // Normal file - decode base64 content
                const textContent = this.decodeContent(file.content);
                return { ...file, textContent };
            } catch (e) {
                console.warn(`Failed to get file content at commit for ${path}:`, e);
                return null;
            }
        }
        
        async getFileAtCommit(repo, path, commitSha) {
            try {
                const [owner, repoName] = repo.split('/');
                return await this.request(`/repos/${owner}/${repoName}/contents/${path}?ref=${commitSha}`);
            } catch { return null; }
        }
        
        // Get blob content directly via Git Blob API - bypasses CDN caching
        async getBlobContent(repo, sha) {
            try {
                const [owner, repoName] = repo.split('/');
                const blob = await this.request(`/repos/${owner}/${repoName}/git/blobs/${sha}?_=${Date.now()}`);
                if (blob && blob.content) {
                    return {
                        content: blob.content,
                        encoding: blob.encoding,
                        size: blob.size
                    };
                }
                return null;
            } catch (e) {
                console.warn(`Failed to get blob ${sha}:`, e);
                return null;
            }
        }
        
        async listRepoContents(repo, path = '') {
            try {
                const [owner, repoName] = repo.split('/');
                const endpoint = path 
                    ? `/repos/${owner}/${repoName}/contents/${path}`
                    : `/repos/${owner}/${repoName}/contents`;
                // Add timestamp to bust any caching
                const cacheBuster = `?_=${Date.now()}`;
                const contents = await this.request(endpoint + cacheBuster);
                return Array.isArray(contents) ? contents : [contents];
            } catch { return []; }
        }
        
        // Get all files in a repo recursively
        async getRepoFiles(repo, path = '') {
            const allFiles = [];
            try {
                const contents = await this.listRepoContents(repo, path);
                for (const item of contents) {
                    if (item.type === 'file') {
                        allFiles.push({
                            type: 'file',
                            path: item.path,
                            sha: item.sha,
                            size: item.size
                        });
                    } else if (item.type === 'dir') {
                        // Recursively get files from subdirectories
                        const subFiles = await this.getRepoFiles(repo, item.path);
                        allFiles.push(...subFiles);
                    }
                }
            } catch (e) {
                console.log(`Error getting files at ${path}:`, e);
            }
            return allFiles;
        }
        
        async createOrUpdateFile(repo, path, content, message, sha = null, branch = 'main') {
            const [owner, repoName] = repo.split('/');
            const body = {
                message,
                content: btoa(unescape(encodeURIComponent(content))),
                committer: { name: 'Command Center', email: 'deploy@gameshelf.app' },
                branch
            };
            if (sha) body.sha = sha;
            
            const url = `/repos/${owner}/${repoName}/contents/${path}`;
            console.log('createOrUpdateFile request:', { 
                url,
                repo, 
                path, 
                sha, 
                branch,
                messageLength: message.length, 
                contentLength: content.length,
                base64Length: body.content.length
            });
            
            try {
                return await this.request(url, { method: 'PUT', body: JSON.stringify(body) });
            } catch (error) {
                console.error('createOrUpdateFile failed:', {
                    url,
                    error: error.message,
                    sha,
                    bodyPreview: JSON.stringify(body).substring(0, 200)
                });
                throw error;
            }
        }
        
        async deleteFile(repo, path, message, sha) {
            const [owner, repoName] = repo.split('/');
            return this.request(`/repos/${owner}/${repoName}/contents/${path}`, {
                method: 'DELETE',
                body: JSON.stringify({
                    message,
                    sha,
                    committer: { name: 'Command Center', email: 'deploy@gameshelf.app' }
                })
            });
        }
        
        async createTag(repo, tagName, sha, message) {
            const [owner, repoName] = repo.split('/');
            
            // Check if tag already exists
            try {
                await this.request(`/repos/${owner}/${repoName}/git/ref/tags/${tagName}`);
                console.log(`Tag ${tagName} already exists, skipping`);
                return { existing: true, tag: tagName };
            } catch {
                // Tag doesn't exist, create it
            }
            
            const tagObj = await this.request(`/repos/${owner}/${repoName}/git/tags`, {
                method: 'POST',
                body: JSON.stringify({
                    tag: tagName, message, object: sha, type: 'commit',
                    tagger: { name: 'Command Center', email: 'deploy@gameshelf.app', date: new Date().toISOString() }
                })
            });
            await this.request(`/repos/${owner}/${repoName}/git/refs`, {
                method: 'POST',
                body: JSON.stringify({ ref: `refs/tags/${tagName}`, sha: tagObj.sha })
            });
            return tagObj;
        }
        
        async enablePages(repo) {
            const [owner, repoName] = repo.split('/');
            try {
                await this.request(`/repos/${owner}/${repoName}/pages`);
                return { alreadyEnabled: true };
            } catch {}
            const response = await fetch(`${this.baseUrl}/repos/${owner}/${repoName}/pages`, {
                method: 'POST',
                headers: { 'Authorization': `token ${this.token}`, 'Accept': 'application/vnd.github.v3+json', 'Content-Type': 'application/json' },
                body: JSON.stringify({ source: { branch: 'main', path: '/' } })
            });
            if (!response.ok) throw new Error(`Failed to enable Pages`);
            return { enabled: true };
        }
        
        // Create a new repository
        async createRepo(name, description = '', isPrivate = false) {
            const response = await fetch(`${this.baseUrl}/user/repos`, {
                method: 'POST',
                headers: { 
                    'Authorization': `token ${this.token}`, 
                    'Accept': 'application/vnd.github.v3+json', 
                    'Content-Type': 'application/json' 
                },
                body: JSON.stringify({
                    name,
                    description,
                    private: isPrivate,
                    auto_init: true, // Creates with README so we have a main branch
                    has_issues: false,
                    has_projects: false,
                    has_wiki: false
                })
            });
            
            if (!response.ok) {
                const error = await response.json();
                throw new Error(error.message || 'Failed to create repository');
            }
            
            const repo = await response.json();
            return {
                fullName: repo.full_name,
                name: repo.name,
                owner: repo.owner.login,
                url: repo.html_url,
                pagesUrl: `https://${repo.owner.login}.github.io/${repo.name}/`
            };
        }
        
        // Check if a repo exists
        async repoExists(owner, repoName) {
            try {
                await this.request(`/repos/${owner}/${repoName}`);
                return true;
            } catch {
                return false;
            }
        }
        
        // Delete a repository (requires delete_repo scope on token)
        async deleteRepo(fullName) {
            const [owner, repoName] = fullName.split('/');
            const response = await fetch(`${this.baseUrl}/repos/${owner}/${repoName}`, {
                method: 'DELETE',
                headers: { 
                    'Authorization': `token ${this.token}`, 
                    'Accept': 'application/vnd.github.v3+json' 
                }
            });
            
            if (!response.ok) {
                if (response.status === 403) {
                    throw new Error('Token lacks delete_repo permission. Generate a new token with delete_repo scope.');
                }
                throw new Error(`Failed to delete repository: ${response.status}`);
            }
            
            return { deleted: true, repo: fullName };
        }
        
        async getPagesDeploymentStatus(repo) {
            const [owner, repoName] = repo.split('/');
            try {
                // Get latest pages build
                const build = await this.request(`/repos/${owner}/${repoName}/pages/builds/latest`);
                return {
                    status: build.status, // 'queued', 'building', 'built', 'errored'
                    createdAt: build.created_at,
                    updatedAt: build.updated_at,
                    commitSha: build.commit,
                    duration: build.duration,
                    error: build.error?.message
                };
            } catch (e) {
                console.error('Failed to get pages status:', e);
                return null;
            }
        }
        
        async triggerPagesBuild(repo) {
            const [owner, repoName] = repo.split('/');
            try {
                await this.request(`/repos/${owner}/${repoName}/pages/builds`, {
                    method: 'POST'
                });
                return true;
            } catch (e) {
                console.error('Failed to trigger pages build:', e);
                return false;
            }
        }
        
        async waitForPagesDeployment(repo, commitSha, maxWaitMs = 120000, onStatus = null) {
            const startTime = Date.now();
            let lastStatus = null;
            
            while (Date.now() - startTime < maxWaitMs) {
                const status = await this.getPagesDeploymentStatus(repo);
                
                if (status && status.status !== lastStatus) {
                    lastStatus = status.status;
                    if (onStatus) onStatus(status);
                }
                
                if (status?.status === 'built') {
                    // Verify it's the right commit
                    if (!commitSha || status.commitSha === commitSha) {
                        return { success: true, status };
                    }
                }
                
                if (status?.status === 'errored') {
                    return { success: false, error: status.error, status };
                }
                
                // Wait 3 seconds before checking again
                await new Promise(r => setTimeout(r, 3000));
            }
            
            return { success: false, error: 'Timeout waiting for deployment', status: lastStatus };
        }
        
        // Batch commit multiple files in one commit
        async batchCommit(repo, files, message) {
            const [owner, repoName] = repo.split('/');
            
            console.log('=== BATCH COMMIT START ===');
            console.log('Repo:', repo);
            console.log('Message:', message);
            console.log('Files to commit:', files.map(f => ({ path: f.path, contentLength: f.content?.length, encoding: f.encoding })));
            
            // Get current commit SHA
            const ref = await this.request(`/repos/${owner}/${repoName}/git/ref/heads/main`);
            const commitSha = ref.object.sha;
            console.log('Current commit SHA:', commitSha);
            
            // Get current tree
            const commit = await this.request(`/repos/${owner}/${repoName}/git/commits/${commitSha}`);
            const treeSha = commit.tree.sha;
            console.log('Current tree SHA:', treeSha);
            
            // Create blobs for each file
            const treeItems = await Promise.all(files.map(async (file) => {
                console.log('Creating blob for:', file.path);
                const blob = await this.request(`/repos/${owner}/${repoName}/git/blobs`, {
                    method: 'POST',
                    body: JSON.stringify({
                        content: file.content,
                        encoding: file.encoding || 'utf-8'
                    })
                });
                console.log('Blob created:', file.path, '-> SHA:', blob.sha);
                return {
                    path: file.path,
                    mode: '100644',
                    type: 'blob',
                    sha: blob.sha
                };
            }));
            
            console.log('Tree items:', treeItems);
            
            // Create new tree
            const treePayload = {
                base_tree: treeSha,
                tree: treeItems
            };
            console.log('Creating tree with payload:', JSON.stringify(treePayload, null, 2));
            
            const newTree = await this.request(`/repos/${owner}/${repoName}/git/trees`, {
                method: 'POST',
                body: JSON.stringify(treePayload)
            });
            console.log('New tree SHA:', newTree.sha);
            
            // Create commit
            const newCommit = await this.request(`/repos/${owner}/${repoName}/git/commits`, {
                method: 'POST',
                body: JSON.stringify({
                    message,
                    tree: newTree.sha,
                    parents: [commitSha],
                    committer: { name: 'Command Center', email: 'deploy@gameshelf.app' }
                })
            });
            console.log('New commit SHA:', newCommit.sha);
            
            // Update ref (force: true handles non-fast-forward cases)
            const updatedRef = await this.request(`/repos/${owner}/${repoName}/git/refs/heads/main`, {
                method: 'PATCH',
                body: JSON.stringify({ sha: newCommit.sha, force: true })
            });
            console.log('Ref updated:', updatedRef);
            console.log('=== BATCH COMMIT COMPLETE ===');
            
            return newCommit;
        }
    }

    // =========================================================================
    // MAIN APP
    // =========================================================================
    
    function App() {
        const [view, setView] = React.useState('dashboard');
        const [githubToken, setGithubToken] = React.useState(() => {
            try { return localStorage.getItem('cc_token') || ''; } catch { return ''; }
        });
        
        // Dynamic configuration (v7.0.0)
        const [config, setConfig] = React.useState(() => {
            return ConfigManager.load();
        });
        
        // Apps derived from config (legacy compatibility + v7 format)
        const [apps, setApps] = React.useState(() => {
            try { 
                const s = localStorage.getItem('cc_apps_v6'); 
                const oldApps = s ? JSON.parse(s) : null;
                if (oldApps) {
                    // Migrate old format to config
                    const cfg = ConfigManager.load();
                    const migrated = ConfigManager.migrateFromOldFormat(oldApps, cfg);
                    ConfigManager.save(migrated);
                    return ConfigManager.toLegacyAppsFormat(migrated);
                }
                return ConfigManager.toLegacyAppsFormat(ConfigManager.load()); 
            } catch { 
                return ConfigManager.toLegacyAppsFormat(ConfigManager.load()); 
            }
        });
        const [stagedFiles, setStagedFiles] = React.useState([]);
        const [deployments, setDeployments] = React.useState(() => {
            try { const s = localStorage.getItem('cc_history_v2'); return s ? JSON.parse(s) : []; } catch { return []; }
        });
        const [activeDeployment, setActiveDeployment] = React.useState(null);
        const [availableRepos, setAvailableRepos] = React.useState([]);
        const [modal, setModal] = React.useState(null);
        const [dialog, setDialog] = React.useState(null); // { type: 'alert'|'confirm'|'prompt', title, message, defaultValue, onConfirm, onCancel }
        const [settings, setSettings] = React.useState({ createTag: true, updateServiceWorker: true });
        
        // Config change handler
        const handleConfigChange = (newConfig) => {
            setConfig(newConfig);
            setApps(ConfigManager.toLegacyAppsFormat(newConfig));
            ConfigManager.save(newConfig);
        };
        
        // Get active environments from config
        const activeEnvironments = config.environments.active;
        const getEnvColors = (env) => config.environments.colors[env] || config.environments.colors.test;
        const getEnvLabel = (env) => config.environments.labels[env] || env.toUpperCase();
        
        // Dialog helper functions (Promise-based for async usage)
        const showAlert = (message, title) => {
            return new Promise((resolve) => {
                setDialog({ type: 'alert', title, message, onConfirm: resolve });
            });
        };
        
        const showConfirm = (message, title) => {
            return new Promise((resolve) => {
                setDialog({ 
                    type: 'confirm', 
                    title, 
                    message, 
                    onConfirm: () => resolve(true),
                    onCancel: () => resolve(false)
                });
            });
        };
        
        const showPrompt = (message, defaultValue, title) => {
            return new Promise((resolve) => {
                setDialog({ 
                    type: 'prompt', 
                    title, 
                    message, 
                    defaultValue,
                    onConfirm: (value) => resolve(value),
                    onCancel: () => resolve(null)
                });
            });
        };
        const [refreshing, setRefreshing] = React.useState(false);
        
        // Rollback snapshots - stores last known good version for each app/repo/target
        // Format: { "appId:target": { content, version, savedAt, repo } }
        const [rollbackSnapshots, setRollbackSnapshots] = React.useState(() => {
            try { const s = localStorage.getItem('cc_rollback_snapshots'); return s ? JSON.parse(s) : {}; } catch { return {}; }
        });
        
        // Persist rollback snapshots
        React.useEffect(() => {
            try { localStorage.setItem('cc_rollback_snapshots', JSON.stringify(rollbackSnapshots)); } catch {}
        }, [rollbackSnapshots]);
        
        // Save snapshot before deploy (call this before pushing new content)
        const saveRollbackSnapshot = async (appId, target, repo, targetPath) => {
            if (!github) return null;
            
            try {
                const fileData = await github.getFileContent(repo, targetPath);
                if (!fileData) return null;
                
                // Use textContent which handles both normal and large files
                const content = fileData.textContent;
                const version = extractVersionFromHTML(content);
                
                const key = `${appId}:${target}`;
                const snapshot = {
                    content,
                    version,
                    savedAt: new Date().toISOString(),
                    repo,
                    targetPath,
                    sha: fileData.sha
                };
                
                setRollbackSnapshots(prev => ({ ...prev, [key]: snapshot }));
                console.log(`üì∏ Saved rollback snapshot for ${appId} ${target}: v${version}`);
                return snapshot;
            } catch (err) {
                console.error('Failed to save rollback snapshot:', err);
                return null;
            }
        };
        
        // Quick rollback using saved snapshot
        const quickRollback = async (appId, target) => {
            const key = `${appId}:${target}`;
            const snapshot = rollbackSnapshots[key];
            
            if (!snapshot) {
                await showAlert('No rollback snapshot available for this app/environment.', 'Rollback Not Available');
                return;
            }
            
            const app = apps[appId];
            const confirmed = await showConfirm(
                `Roll back ${app.name} ${target.toUpperCase()} to v${snapshot.version || 'unknown'}?\n\nSaved: ${new Date(snapshot.savedAt).toLocaleString()}`,
                '‚è™ Quick Rollback'
            );
            
            if (!confirmed) return;
            
            const deployment = {
                id: Date.now(), status: 'running', steps: [],
                appId, appName: app.name, repo: snapshot.repo, target,
                isRollback: true, isQuickRollback: true,
                version: snapshot.version,
                startedAt: new Date().toISOString()
            };
            
            setActiveDeployment(deployment);
            setDeployments(prev => [deployment, ...prev]);
            
            const addStep = (name, status, details = null) => {
                const idx = deployment.steps.findIndex(s => s.name === name);
                if (idx >= 0) deployment.steps[idx] = { name, status, details };
                else deployment.steps.push({ name, status, details });
                setActiveDeployment({ ...deployment });
            };
            
            try {
                addStep('Preparing rollback', 'running');
                const currentFileData = await github.getFileContent(snapshot.repo, snapshot.targetPath);
                // Use textContent which handles both normal and large files
                const currentVersion = currentFileData ? extractVersionFromHTML(currentFileData.textContent) : null;
                deployment.previousVersion = currentVersion;
                addStep('Preparing rollback', 'complete', `${formatVersion(currentVersion)} ‚Üí ${formatVersion(snapshot.version)}`);
                
                addStep('Restoring snapshot', 'running');
                const result = await github.createOrUpdateFile(
                    snapshot.repo, snapshot.targetPath, snapshot.content,
                    `Quick rollback ${app.name} to v${snapshot.version} (was v${currentVersion})`,
                    currentFileData?.sha
                );
                deployment.commitSha = result.commit.sha;
                addStep('Restoring snapshot', 'complete', result.commit.sha.substring(0, 7));
                
                deployment.status = 'success';
                deployment.url = getGitHubPagesUrl(snapshot.repo, app.subPath);
                
                const versionKey = target === 'prod' ? 'currentProdVersion' : 'currentTestVersion';
                updateApp(appId, { [versionKey]: snapshot.version });
                
                // Monitor deployment
                if (deployment.url && snapshot.version) {
                    addStep('GitHub Pages', 'running', 'Waiting for deploy...');
                    monitorLiveDeployment(deployment.url, snapshot.version, snapshot.repo, (status, detail) => {
                        addStep('GitHub Pages', status, detail);
                        setActiveDeployment({ ...deployment });
                        setDeployments(prev => prev.map(d => d.id === deployment.id ? { ...deployment } : d));
                    });
                }
                
            } catch (err) {
                console.error('Quick rollback failed:', err);
                addStep('Rollback Failed', 'error', err.message);
                deployment.status = 'error';
            }
            
            setActiveDeployment({ ...deployment });
            setDeployments(prev => prev.map(d => d.id === deployment.id ? { ...deployment } : d));
        };
        
        // Clear rollback snapshot (after successful deploy verification)
        const clearRollbackSnapshot = (appId, target) => {
            const key = `${appId}:${target}`;
            setRollbackSnapshots(prev => {
                const next = { ...prev };
                delete next[key];
                return next;
            });
        };
        const [repoFiles, setRepoFiles] = React.useState({}); // { repoFullName: { files: [], loading: bool } }
        const [selectedRepoForBrowse, setSelectedRepoForBrowse] = React.useState(null);
        const [markedForDeletion, setMarkedForDeletion] = React.useState([]); // [{ repo, path, sha }]
        const [deployingRepos, setDeployingRepos] = React.useState({}); // { repoFullName: { version, startTime } }
        
        // Session log state (persisted to localStorage)
        const [sessionLog, setSessionLog] = React.useState(() => {
            try { 
                const s = localStorage.getItem('cc_session_log'); 
                return s ? JSON.parse(s) : {
                    currentSession: null,
                    sessions: [],
                    issues: [],
                    notes: ''
                }; 
            } catch { 
                return { currentSession: null, sessions: [], issues: [], notes: '' }; 
            }
        });
        
        // Global issues state (synced with Firebase)
        const [globalIssues, setGlobalIssues] = React.useState([]);
        const [firebaseUid, setFirebaseUid] = React.useState(null);
        
        // Listen for Firebase auth and load issues
        React.useEffect(() => {
            if (!firebaseAuth) return;
            
            const unsubscribe = firebaseAuth.onAuthStateChanged((u) => {
                if (u) {
                    setFirebaseUid(u.uid);
                    // Listen for issues changes
                    const issuesRef = firebaseDb.ref(`command-center/${u.uid}/issues`);
                    issuesRef.on('value', (snapshot) => {
                        const data = snapshot.val();
                        if (data) {
                            const list = Object.entries(data).map(([id, issue]) => ({ id, ...issue }));
                            setGlobalIssues(list);
                        } else {
                            setGlobalIssues([]);
                        }
                    });
                    return () => issuesRef.off();
                } else {
                    setFirebaseUid(null);
                    setGlobalIssues([]);
                }
            });
            
            return () => unsubscribe();
        }, []);
        
        // Link issues to a deployed version
        const linkIssuesToVersion = async (issueIds, version, appId) => {
            if (!firebaseDb || !firebaseUid || !issueIds.length) return;
            
            for (const issueId of issueIds) {
                await firebaseDb.ref(`command-center/${firebaseUid}/issues/${issueId}`).update({
                    status: 'fixed',
                    fixedAt: new Date().toISOString(),
                    fixedInVersion: version,
                    fixedInApp: appId
                });
            }
        };
        
        // Use ref to always have latest apps state for async operations
        const appsRef = React.useRef(apps);
        React.useEffect(() => { appsRef.current = apps; }, [apps]);
        
        const github = React.useMemo(() => githubToken ? new GitHubAPI(githubToken) : null, [githubToken]);
        
        // Persist
        React.useEffect(() => { try { if (githubToken) localStorage.setItem('cc_token', githubToken); } catch {} }, [githubToken]);
        React.useEffect(() => { try { localStorage.setItem('cc_apps_v6', JSON.stringify(apps)); } catch {} }, [apps]);
        React.useEffect(() => { try { localStorage.setItem('cc_history_v2', JSON.stringify(deployments.slice(0, 100))); } catch {} }, [deployments]);
        React.useEffect(() => { try { localStorage.setItem('cc_session_log', JSON.stringify(sessionLog)); } catch {} }, [sessionLog]);
        
        // Monitor live site until new version appears
        const monitorLiveDeployment = async (url, expectedVersion, repo, onUpdate) => {
            const maxWaitMs = 180000; // 3 minutes max
            const pollInterval = 5000; // Check every 5 seconds
            const startTime = Date.now();
            let attempts = 0;
            let corsFailures = 0;
            const maxCorsFailures = 3; // Give up after 3 CORS errors
            
            console.log(`=== MONITORING LIVE DEPLOYMENT ===`);
            console.log(`URL: ${url}`);
            console.log(`Repo: ${repo}`);
            console.log(`Expected version: ${expectedVersion}`);
            
            // Mark repo as deploying
            setDeployingRepos(prev => ({ ...prev, [repo]: { version: expectedVersion, startTime } }));
            
            while (Date.now() - startTime < maxWaitMs) {
                attempts++;
                const elapsed = Math.round((Date.now() - startTime) / 1000);
                
                try {
                    // Fetch the live site with cache-busting
                    // Don't set custom headers - they trigger CORS preflight which GitHub Pages doesn't support
                    const response = await fetch(`${url}?_t=${Date.now()}`, {
                        cache: 'no-store'
                    });
                    
                    if (response.ok) {
                        const html = await response.text();
                        const liveVersion = extractVersionFromHTML(html);
                        
                        console.log(`[${elapsed}s] Live version: ${liveVersion || 'unknown'}, expecting: ${expectedVersion}`);
                        corsFailures = 0; // Reset on success
                        
                        if (liveVersion === expectedVersion) {
                            console.log(`=== DEPLOYMENT COMPLETE! Version ${liveVersion} is live ===`);
                            onUpdate('complete', `v${liveVersion} is LIVE! (${elapsed}s)`);
                            // Clear deploying state
                            setDeployingRepos(prev => {
                                const next = { ...prev };
                                delete next[repo];
                                return next;
                            });
                            return { success: true, duration: elapsed };
                        } else {
                            onUpdate('running', `Waiting... ${elapsed}s (live: ${liveVersion || '?'})`);
                        }
                    } else {
                        onUpdate('running', `Waiting... ${elapsed}s (site loading)`);
                    }
                } catch (e) {
                    corsFailures++;
                    console.log(`[${elapsed}s] Fetch error (${corsFailures}/${maxCorsFailures}):`, e.message);
                    
                    // If we keep getting CORS/network errors, stop monitoring
                    if (corsFailures >= maxCorsFailures) {
                        console.log(`=== CORS/NETWORK ERRORS - STOPPING MONITOR ===`);
                        onUpdate('complete', `Commit pushed ‚úì (verify at site)`);
                        setDeployingRepos(prev => {
                            const next = { ...prev };
                            delete next[repo];
                            return next;
                        });
                        return { success: true, corsBlocked: true };
                    }
                    
                    onUpdate('running', `Waiting... ${elapsed}s`);
                }
                
                await new Promise(r => setTimeout(r, pollInterval));
            }
            
            console.log(`=== DEPLOYMENT MONITORING TIMEOUT ===`);
            onUpdate('warning', `Timeout - check manually`);
            // Clear deploying state on timeout
            setDeployingRepos(prev => {
                const next = { ...prev };
                delete next[repo];
                return next;
            });
            return { success: false, timeout: true };
        };
        
        // Refresh repos list
        const refreshRepos = async () => {
            if (!github) return;
            try {
                const repos = await github.listRepos();
                setAvailableRepos(repos);
                // Re-run auto-mapping
                setApps(prev => autoMapRepos(prev, repos));
            } catch (e) {
                console.error('Failed to refresh repos:', e);
            }
        };
        
        // Fetch repos and auto-refresh versions on load
        React.useEffect(() => {
            if (github) {
                github.listRepos().then(async (repos) => {
                    setAvailableRepos(repos);
                    
                    // Get current apps state and map repos
                    setApps(prev => {
                        const mapped = autoMapRepos(prev, repos);
                        return mapped;
                    });
                    
                    // Small delay to let state settle, then refresh versions
                    await new Promise(r => setTimeout(r, 500));
                    refreshAllVersions();
                }).catch(console.error);
            }
        }, [github]);
        
        // Refresh all versions from repos
        const refreshAllVersions = async () => {
            if (!github) return;
            setRefreshing(true);
            
            // Always use latest apps state from ref
            const currentApps = appsRef.current;
            console.log('=== REFRESHING VERSIONS FROM REPOS ===');
            
            const updates = {};
            for (const [appId, app] of Object.entries(currentApps)) {
                // Get the full path including subPath if set
                const fullTargetPath = getRepoFilePath(app, app.targetPath);
                
                if (app.testRepo) {
                    try {
                        console.log(`[${appId}] Fetching TEST from ${app.testRepo}/${fullTargetPath}...`);
                        const testFileData = await github.getFileContent(app.testRepo, fullTargetPath);
                        if (testFileData) {
                            // Use textContent which handles both normal and large files
                            const content = testFileData.textContent;
                            const version = extractVersionFromHTML(content);
                            console.log(`[${appId}] TEST version from REPO: ${version || 'NO VERSION'}`);
                            console.log(`[${appId}] TEST file SHA: ${testFileData.sha}`);
                            if (version) updates[appId] = { ...updates[appId], currentTestVersion: version };
                        } else {
                            console.log(`[${appId}] TEST: FILE NOT FOUND`);
                        }
                    } catch (e) {
                        console.error(`[${appId}] TEST error:`, e.message);
                    }
                }
                if (app.prodRepo) {
                    try {
                        console.log(`[${appId}] Fetching PROD from ${app.prodRepo}/${fullTargetPath}...`);
                        const prodFileData = await github.getFileContent(app.prodRepo, fullTargetPath);
                        if (prodFileData) {
                            // Use textContent which handles both normal and large files
                            const content = prodFileData.textContent;
                            const version = extractVersionFromHTML(content);
                            console.log(`[${appId}] PROD version from REPO: ${version || 'NO VERSION'}`);
                            console.log(`[${appId}] PROD file SHA: ${prodFileData.sha}`);
                            if (version) updates[appId] = { ...updates[appId], currentProdVersion: version };
                        } else {
                            console.log(`[${appId}] PROD: FILE NOT FOUND`);
                        }
                    } catch (e) {
                        console.error(`[${appId}] PROD error:`, e.message);
                    }
                }
            }
            
            setApps(prev => {
                const newApps = { ...prev };
                for (const [appId, upd] of Object.entries(updates)) {
                    newApps[appId] = { ...newApps[appId], ...upd };
                }
                console.log('Updated apps state:', Object.entries(newApps).map(([id, a]) => `${id}: TEST=${a.currentTestVersion || '‚Äî'}, PROD=${a.currentProdVersion || '‚Äî'}`));
                return newApps;
            });
            
            setRefreshing(false);
            console.log('=== REFRESH COMPLETE ===');
        };
        
        // Load repo files
        const loadRepoFiles = async (repo) => {
            if (!github || !repo) return;
            setRepoFiles(prev => ({ ...prev, [repo]: { files: [], loading: true } }));
            
            const files = await github.listRepoContents(repo);
            setRepoFiles(prev => ({ ...prev, [repo]: { files, loading: false } }));
        };
        
        const updateApp = (appId, updates) => setApps(prev => ({ ...prev, [appId]: { ...prev[appId], ...updates } }));
        
        // File upload - now accepts multiple file types
        const handleFileDrop = (e) => {
            e.preventDefault();
            const files = e.dataTransfer?.files || e.target.files;
            
            // Capture files into array BEFORE resetting input
            // (FileList is live and gets cleared when input is reset)
            const fileArray = Array.from(files || []);
            
            // Reset file input so same file can be selected again
            // (without this, onChange won't fire for the same file twice)
            if (e.target && e.target.value) {
                e.target.value = '';
            }
            
            // Exit early if no files
            if (fileArray.length === 0) return;
            
            fileArray.forEach(async (file) => {
                // Handle ZIP files specially
                if (file.name.endsWith('.zip')) {
                    console.log('=== PROCESSING ZIP FILE ===');
                    console.log('Name:', file.name);
                    
                    if (typeof JSZip === 'undefined') {
                        await showAlert('ZIP support not available', 'Error');
                        return;
                    }
                    
                    try {
                        const zip = await JSZip.loadAsync(file);
                        let primaryApp = null;
                        let primaryVersion = null;
                        
                        // Detect if ZIP has a root folder (common in downloads)
                        const allPaths = [];
                        zip.forEach((path) => { if (!path.endsWith('/')) allPaths.push(path); });
                        const hasRootFolder = allPaths.length > 0 && allPaths.every(p => p.includes('/'));
                        const rootFolder = hasRootFolder ? allPaths[0].split('/')[0] + '/' : '';
                        
                        const extractPromises = [];
                        zip.forEach((relativePath, zipEntry) => {
                            if (zipEntry.dir || relativePath.startsWith('.') || relativePath.includes('__MACOSX')) return;
                            
                            // Strip root folder if present (e.g., 'quotle-deploy-v1_0_2/' prefix)
                            let cleanPath = relativePath;
                            if (rootFolder && relativePath.startsWith(rootFolder)) {
                                cleanPath = relativePath.substring(rootFolder.length);
                            }
                            
                            const fileName = cleanPath.split('/').pop();
                            const isText = /\.(html|js|css|json|md|txt|xml|svg|yml|yaml)$/i.test(fileName);
                            
                            // Determine target path - preserve directory structure for non-HTML files
                            let targetPath;
                            if (fileName.endsWith('.html') && !cleanPath.includes('/')) {
                                // Root HTML files ‚Üí index.html
                                targetPath = 'index.html';
                            } else if (cleanPath.includes('/')) {
                                // Files in subdirectories ‚Üí preserve path (e.g., icons/icon-72.png)
                                targetPath = cleanPath;
                            } else {
                                // Root non-HTML files ‚Üí keep filename
                                targetPath = fileName;
                            }
                            
                            extractPromises.push(
                                zipEntry.async(isText ? 'string' : 'binarystring').then(content => {
                                    const parsed = parseFilename(fileName);
                                    let version = null;
                                    let suggestedApp = null;
                                    let appDetection = null;
                                    let versionValidation = null;
                                    
                                    if (fileName.endsWith('.html')) {
                                        appDetection = detectAppFromContent(content);
                                        suggestedApp = appDetection?.id || parsed.app;
                                        version = extractVersionFromHTML(content) || parsed.version;
                                        versionValidation = validateVersions(content, fileName);
                                        if (appDetection) {
                                            primaryApp = suggestedApp;
                                            primaryVersion = version;
                                        }
                                    } else if (fileName === 'sw.js') {
                                        const swMatch = content.match(/CACHE_VERSION\s*=\s*['"]v?([^'"]+)['"]/);
                                        version = swMatch ? swMatch[1] : null;
                                        suggestedApp = parsed.app;
                                    } else {
                                        suggestedApp = parsed.app;
                                    }
                                    
                                    console.log('Extracted:', cleanPath, '‚Üí', targetPath, 'v' + version);
                                    
                                    setStagedFiles(prev => [...prev, {
                                        id: Date.now() + Math.random(),
                                        name: fileName,
                                        originalPath: cleanPath,
                                        size: content.length,
                                        content: isText ? content : btoa(content),
                                        encoding: isText ? 'utf-8' : 'base64',
                                        isText,
                                        suggestedApp,
                                        appDetection,
                                        version,
                                        versionSource: version ? 'extracted' : 'none',
                                        versionValidation,
                                        targetPath
                                    }]);
                                })
                            );
                        });
                        
                        await Promise.all(extractPromises);
                        console.log('=== ZIP EXTRACTED ===');
                        console.log('Primary app:', primaryApp, 'v' + primaryVersion);
                        
                    } catch (err) {
                        console.error('ZIP extraction failed:', err);
                        showAlert('Failed to extract ZIP: ' + err.message, 'ZIP Error');
                    }
                    return;
                }
                
                // Handle regular files
                const reader = new FileReader();
                reader.onload = (e) => {
                    const content = e.target.result;
                    const isText = file.type.startsWith('text/') || 
                        /\.(html|js|css|json|md|txt|xml|svg|yml|yaml)$/i.test(file.name);
                    
                    const parsed = parseFilename(file.name);
                    let version = null;
                    let versionSource = 'none';
                    let versionValidation = null;
                    
                    // App detection: try content first, fall back to filename
                    let suggestedApp = null;
                    let appDetection = null;
                    
                    if (file.name.endsWith('.html') && isText) {
                        // Try content-based detection
                        appDetection = detectAppFromContent(content);
                        
                        if (appDetection) {
                            suggestedApp = appDetection.id;
                            console.log('=== APP DETECTED FROM CONTENT ===');
                            console.log('Detected:', appDetection.id);
                            console.log('Confidence:', appDetection.confidence);
                            console.log('Matches:', appDetection.matchCount);
                        } else {
                            // Fall back to filename
                            suggestedApp = parsed.app;
                            console.log('=== APP FROM FILENAME ===');
                            console.log('Parsed:', parsed.app);
                        }
                        
                        const htmlVersion = extractVersionFromHTML(content);
                        version = htmlVersion || parsed.version;
                        versionSource = htmlVersion ? 'html' : (parsed.version ? 'filename' : 'none');
                        
                        // Full version validation
                        versionValidation = validateVersions(content, file.name);
                        
                        console.log('=== VERSION VALIDATION ===');
                        console.log('File:', file.name);
                        console.log('Primary version:', versionValidation.primary);
                        console.log('All versions found:', versionValidation.allVersions);
                        console.log('Unique versions:', versionValidation.uniqueVersions);
                        console.log('Is valid:', versionValidation.isValid);
                        if (!versionValidation.isValid) {
                            console.warn('‚ö†Ô∏è VERSION ISSUES:', {
                                mismatches: versionValidation.mismatches,
                                missing: versionValidation.missing
                            });
                        }
                    } else if (file.name.endsWith('.js') && isText) {
                        // Check if this is Firebase Functions code
                        appDetection = detectAppFromContent(content);
                        if (appDetection) {
                            suggestedApp = appDetection.id;
                            console.log('=== JS FILE APP DETECTED ===');
                            console.log('Detected:', appDetection.id);
                            console.log('Confidence:', appDetection.confidence);
                        } else {
                            suggestedApp = parsed.app;
                        }
                    } else if ((file.name.endsWith('.yml') || file.name.endsWith('.yaml')) && isText) {
                        // Check if this is a Firebase/GitHub Actions workflow
                        if (/firebase-action|FIREBASE_TOKEN|deploy.*functions/i.test(content)) {
                            suggestedApp = 'firebase-functions';
                            appDetection = {
                                id: 'firebase-functions',
                                confidence: 'high',
                                method: 'workflow-pattern',
                                matchCount: 1,
                                matchedPatterns: ['GitHub Actions Firebase workflow']
                            };
                            console.log('=== YML FILE DETECTED AS FIREBASE WORKFLOW ===');
                        } else {
                            suggestedApp = parsed.app;
                        }
                    } else {
                        suggestedApp = parsed.app;
                    }
                    
                    console.log('=== FILE UPLOADED ===');
                    console.log('Name:', file.name);
                    console.log('Size:', file.size);
                    console.log('Version:', version);
                    console.log('Suggested App:', suggestedApp, appDetection ? '(from content)' : '(from filename)');
                    
                    // Clean up Claude download filenames (e.g., index_4.js ‚Üí index.js)
                    let cleanedName = file.name;
                    const claudeDownloadPattern = /^(.+?)_\d+(\.[a-z]+)$/i;
                    const claudeMatch = file.name.match(claudeDownloadPattern);
                    if (claudeMatch) {
                        cleanedName = claudeMatch[1] + claudeMatch[2];
                        console.log('Cleaned filename:', file.name, '‚Üí', cleanedName);
                    }
                    
                    // Determine targetPath: use app-specific path if detected, else default logic
                    let targetPath;
                    if (suggestedApp === 'firebase-functions' && (cleanedName.endsWith('.yml') || cleanedName.endsWith('.yaml'))) {
                        // Workflow files go to .github/workflows/
                        targetPath = '.github/workflows/deploy.yml';
                    } else if (suggestedApp && DEFAULT_APP_DEFINITIONS[suggestedApp]) {
                        targetPath = DEFAULT_APP_DEFINITIONS[suggestedApp].targetPath;
                    } else if (file.name.endsWith('.html')) {
                        targetPath = 'index.html';
                    } else {
                        targetPath = cleanedName;
                    }
                    
                    setStagedFiles(prev => [...prev, {
                        id: Date.now() + Math.random(),
                        name: cleanedName,
                        originalName: file.name !== cleanedName ? file.name : undefined,
                        size: file.size,
                        content: isText ? content : btoa(content),
                        encoding: isText ? 'utf-8' : 'base64',
                        isText,
                        suggestedApp,
                        appDetection, // Store detection details
                        version,
                        versionSource,
                        versionValidation,
                        targetPath
                    }]);
                };
                
                if (file.type.startsWith('text/') || /\.(html|js|css|json|md|txt|xml|svg|yml|yaml)$/i.test(file.name)) {
                    reader.readAsText(file);
                } else {
                    reader.readAsBinaryString(file);
                }
            });
        };
        
        const removeStaged = (id) => setStagedFiles(prev => prev.filter(f => f.id !== id));
        const updateStagedFile = (id, updates) => setStagedFiles(prev => prev.map(f => f.id === id ? { ...f, ...updates } : f));
        
        // Get current deployed version from repo
        const fetchCurrentVersion = async (repo, targetPath) => {
            if (!github || !repo) return null;
            const fileData = await github.getFileContent(repo, targetPath);
            if (!fileData) return null;
            // Use textContent which handles both normal and large files
            return extractVersionFromHTML(fileData.textContent);
        };
        
        // Deploy single file (legacy support)
        const handleDeploy = async (file, appId, target, forceDeploy = false) => {
            if (!github) { await showAlert('Configure GitHub token', 'Configuration Required'); return; }
            
            const app = apps[appId];
            const repo = target === 'prod' ? app.prodRepo : app.testRepo;
            if (!repo) { await showAlert(`Configure ${target} repo`, 'Configuration Required'); return; }
            
            // Get full path including subPath
            const fullTargetPath = getRepoFilePath(app, file.targetPath || app.targetPath);
            
            const currentVersion = await fetchCurrentVersion(repo, fullTargetPath);
            const newVersion = file.version;
            
            if (!forceDeploy && currentVersion && newVersion) {
                if (!isNewerVersion(newVersion, currentVersion)) {
                    setModal({ type: 'versionWarning', data: { file, appId, target, currentVersion, newVersion } });
                    return;
                }
            }
            
            // üì∏ Save rollback snapshot BEFORE deploying
            await saveRollbackSnapshot(appId, target, repo, fullTargetPath);
            
            const deployment = {
                id: Date.now(), status: 'running', steps: [],
                appId, appName: app.name, repo, target,
                version: newVersion || 'unknown',
                previousVersion: currentVersion,
                startedAt: new Date().toISOString(),
                fileContent: file.content
            };
            
            setActiveDeployment(deployment);
            setDeployments(prev => [deployment, ...prev]);
            
            const addStep = (name, status, details = null) => {
                const existingIndex = deployment.steps.findIndex(s => s.name === name);
                if (existingIndex >= 0) {
                    deployment.steps[existingIndex] = { name, status, details };
                } else {
                    deployment.steps.push({ name, status, details });
                }
                setActiveDeployment({ ...deployment });
            };
            
            try {
                addStep('Validating', 'running');
                addStep('Validating', 'complete', `${formatVersion(newVersion)} (${formatBytes(file.size)})`);
                
                addStep('Safety Check', 'running');
                if (currentVersion) {
                    if (isNewerVersion(newVersion, currentVersion)) {
                        addStep('Safety Check', 'complete', `${formatVersion(currentVersion)} ‚Üí ${formatVersion(newVersion)} ‚úì`);
                    } else {
                        addStep('Safety Check', 'warning', `Force deploy: ${formatVersion(currentVersion)} ‚Üí ${formatVersion(newVersion)}`);
                    }
                } else {
                    addStep('Safety Check', 'complete', 'First deploy');
                }
                
                addStep('Committing', 'running');
                const currentFile = await github.getFile(repo, fullTargetPath);
                const result = await github.createOrUpdateFile(
                    repo, fullTargetPath, file.content,
                    `Deploy ${app.name} ${formatVersion(newVersion)}${currentVersion ? ` (was ${formatVersion(currentVersion)})` : ''}`,
                    currentFile?.sha
                );
                deployment.commitSha = result.commit.sha;
                addStep('Committing', 'complete', result.commit.sha.substring(0, 7));
                
                addStep('GitHub Pages', 'running');
                try {
                    const pagesResult = await github.enablePages(repo);
                    addStep('GitHub Pages', 'complete', pagesResult.alreadyEnabled ? 'Ready' : 'Enabled!');
                } catch (e) {
                    addStep('GitHub Pages', 'warning', e.message);
                }
                
                if (settings.createTag && newVersion) {
                    addStep('Tagging', 'running');
                    try {
                        const tag = target === 'prod' ? `v${newVersion}` : `v${newVersion}-test`;
                        await github.createTag(repo, tag, result.commit.sha, `Release ${newVersion}`);
                        addStep('Tagging', 'complete', tag);
                    } catch {
                        addStep('Tagging', 'warning', 'Tag may exist');
                    }
                }
                
                deployment.status = 'success';
                deployment.url = getGitHubPagesUrl(repo, app.subPath);
                updateApp(appId, { [target === 'prod' ? 'currentProdVersion' : 'currentTestVersion']: newVersion });
                removeStaged(file.id);
                
                // Check for open issues that can be linked to this deploy
                const openIssues = globalIssues.filter(i => 
                    i.app === appId && 
                    (i.status === 'open' || i.status === 'in-progress')
                );
                
                if (openIssues.length > 0 && target === 'test') {
                    // Show issue linking modal after a short delay
                    setTimeout(async () => {
                        const issueList = openIssues.map(i => `${i.id}: ${i.title}`).join('\n');
                        const result = await showPrompt(
                            `This deploy may fix these issues:\n\n${issueList}\n\nEnter issue IDs to link (comma-separated), or leave blank:`,
                            '',
                            'üîó Link Issues to v' + newVersion
                        );
                        
                        if (result && result.trim()) {
                            const issueIds = result.split(',').map(s => s.trim().toUpperCase());
                            const validIds = issueIds.filter(id => openIssues.some(i => i.id === id));
                            if (validIds.length > 0) {
                                await linkIssuesToVersion(validIds, newVersion, appId);
                            }
                        }
                    }, 500);
                }
                
                // Start monitoring live site for deployment completion
                if (deployment.url && newVersion) {
                    addStep('GitHub Pages', 'running', 'Waiting for deploy...');
                    monitorLiveDeployment(deployment.url, newVersion, repo, (status, detail) => {
                        addStep('GitHub Pages', status, detail);
                        setActiveDeployment({ ...deployment });
                        setDeployments(prev => prev.map(d => d.id === deployment.id ? { ...deployment } : d));
                    });
                }
                
            } catch (error) {
                deployment.status = 'failed';
                deployment.error = error.message;
                addStep('Error', 'error', error.message);
            }
            
            deployment.completedAt = new Date().toISOString();
            setActiveDeployment({ ...deployment });
            setDeployments(prev => prev.map(d => d.id === deployment.id ? deployment : d));
        };
        
        // Multi-file batch deploy
        const handleBatchDeploy = async (files, appId, target) => {
            if (!github) {
                await showAlert('Configure GitHub token first', 'Configuration Required');
                return;
            }
            if (files.length === 0) return;
            
            const app = apps[appId];
            const repo = target === 'prod' ? app.prodRepo : app.testRepo;
            if (!repo) {
                await showAlert(`Configure ${target} repo first`, 'Configuration Required');
                return;
            }
            
            // Find version from index.html if present
            const indexFile = files.find(f => f.targetPath === 'index.html' || f.name === 'index.html');
            const newVersion = indexFile?.version || 'batch';
            
            // Check for version validation issues in any file
            const filesWithIssues = files.filter(f => f.versionValidation && !f.versionValidation.isValid);
            if (filesWithIssues.length > 0) {
                const proceed = await showConfirm(
                    filesWithIssues.map(f => {
                        const v = f.versionValidation;
                        let msg = `${f.name}:\n`;
                        if (v.missing.length > 0) msg += `  ‚Ä¢ Missing: ${v.missing.join(', ')}\n`;
                        if (v.uniqueVersions.length > 1) msg += `  ‚Ä¢ Mismatched versions: ${v.uniqueVersions.join(', ')}\n`;
                        return msg;
                    }).join('\n') +
                    `\nYou can click "Fix to v${newVersion}" on each file to auto-correct.\n\n` +
                    `Deploy anyway with inconsistent versions?`,
                    '‚ö†Ô∏è Version Issues Detected'
                );
                if (!proceed) return;
            }
            
            // Check version increment against current repo version
            if (newVersion !== 'batch') {
                const currentVersion = target === 'prod' ? app.currentProdVersion : app.currentTestVersion;
                if (currentVersion && !isNewerVersion(newVersion, currentVersion)) {
                    const proceed = await showConfirm(
                        `Current in ${target.toUpperCase()}: v${currentVersion}\n` +
                        `New version: v${newVersion}\n\n` +
                        `This may be a downgrade or same version.\n` +
                        `Deploy anyway?`,
                        '‚ö†Ô∏è Version Not Incrementing'
                    );
                    if (!proceed) return;
                }
            }
            
            // Log file details for debugging
            console.log('handleBatchDeploy received:', files.map(f => ({
                name: f.name,
                id: f.id,
                targetPath: f.targetPath,
                version: f.version,
                validationOk: f.versionValidation?.isValid,
                contentLength: f.content?.length
            })));
            
            // üì∏ Save rollback snapshot BEFORE deploying
            const fullTargetPath = getRepoFilePath(app, app.targetPath);
            await saveRollbackSnapshot(appId, target, repo, fullTargetPath);
            
            const deployment = {
                id: Date.now(), status: 'running', steps: [],
                appId, appName: app.name, repo, target,
                version: newVersion,
                startedAt: new Date().toISOString(),
                fileCount: files.length
            };
            
            setActiveDeployment(deployment);
            setDeployments(prev => [deployment, ...prev]);
            
            const addStep = (name, status, details = null) => {
                const existingIndex = deployment.steps.findIndex(s => s.name === name);
                if (existingIndex >= 0) {
                    deployment.steps[existingIndex] = { name, status, details };
                } else {
                    deployment.steps.push({ name, status, details });
                }
                setActiveDeployment({ ...deployment });
            };
            
            try {
                addStep('Preparing batch', 'running');
                addStep('Preparing batch', 'complete', `${files.length} files`);
                
                addStep('Creating commit', 'running');
                // Prepend subPath to all file paths if needed
                const filesToCommit = files.map(f => ({
                    path: getRepoFilePath(app, f.targetPath || f.name),
                    content: f.content,
                    encoding: f.encoding
                }));
                
                let result;
                // Use simple Contents API for single files (more reliable than Git Data API)
                if (filesToCommit.length === 1) {
                    const file = filesToCommit[0];
                    console.log('Single file deploy, using Contents API for:', file.path);
                    
                    // Get current file SHA if it exists (needed for update)
                    let existingSha = null;
                    try {
                        const existingFile = await github.getFile(repo, file.path);
                        if (existingFile) {
                            existingSha = existingFile.sha;
                            console.log('Existing file SHA:', existingSha);
                        }
                    } catch (e) {
                        console.log('File does not exist yet, will create');
                    }
                    
                    // Decode content if it's base64 encoded, otherwise use as-is
                    let contentToSend = file.content;
                    if (file.encoding === 'base64') {
                        // Content is already base64, need to decode for createOrUpdateFile which re-encodes
                        try {
                            contentToSend = decodeURIComponent(escape(atob(file.content)));
                        } catch (e) {
                            console.log('Content is binary base64, using raw');
                            contentToSend = atob(file.content);
                        }
                    }
                    
                    result = await github.createOrUpdateFile(
                        repo,
                        file.path,
                        contentToSend,
                        `Deploy ${app.name} ${formatVersion(newVersion)} (${files.length} files)`,
                        existingSha
                    );
                    result.sha = result.commit.sha;
                } else {
                    // Multiple files - use batch commit (Git Data API)
                    result = await github.batchCommit(
                        repo,
                        filesToCommit,
                        `Deploy ${app.name} ${formatVersion(newVersion)} (${files.length} files)`
                    );
                }
                deployment.commitSha = result.sha;
                addStep('Creating commit', 'complete', result.sha.substring(0, 7));
                
                addStep('GitHub Pages', 'running');
                try {
                    await github.enablePages(repo);
                    addStep('GitHub Pages', 'complete', 'Ready');
                } catch (e) {
                    addStep('GitHub Pages', 'warning', e.message);
                }
                
                if (settings.createTag && newVersion !== 'batch') {
                    addStep('Tagging', 'running');
                    try {
                        const tag = target === 'prod' ? `v${newVersion}` : `v${newVersion}-test`;
                        await github.createTag(repo, tag, result.sha, `Release ${newVersion}`);
                        addStep('Tagging', 'complete', tag);
                    } catch {
                        addStep('Tagging', 'warning', 'Tag may exist');
                    }
                }
                
                deployment.status = 'success';
                deployment.url = getGitHubPagesUrl(repo, app.subPath);
                
                // Verify the deployment by fetching back from repo
                console.log('=== VERIFYING DEPLOYMENT ===');
                await new Promise(r => setTimeout(r, 1000)); // Wait a bit for GitHub to process
                
                // Always verify index.html (not binary files like PNGs)
                try {
                    const verifyFileData = await github.getFileContent(repo, fullTargetPath);
                    if (verifyFileData) {
                        // Use textContent which handles both normal and large files
                        const verifyContent = verifyFileData.textContent;
                        const verifyVersion = extractVersionFromHTML(verifyContent);
                        console.log('Verification - version in repo after deploy:', verifyVersion);
                        console.log('Verification - expected version:', newVersion);
                        if (verifyVersion !== newVersion && newVersion !== 'batch') {
                            console.warn('VERSION MISMATCH! Deploy may have failed.');
                            addStep('Verification', 'warning', `Expected ${newVersion}, found ${verifyVersion}`);
                        } else {
                            addStep('Verification', 'complete', `Confirmed ${verifyVersion || 'batch'} in repo`);
                        }
                    }
                } catch (verifyError) {
                    console.warn('Verification skipped:', verifyError.message);
                    addStep('Verification', 'warning', 'Could not verify (deploy likely succeeded)');
                }
                
                if (newVersion !== 'batch') {
                    updateApp(appId, { [target === 'prod' ? 'currentProdVersion' : 'currentTestVersion']: newVersion });
                }
                
                // Don't refresh immediately - GitHub's CDN needs time to propagate
                // The local state is already updated, and verification confirmed the deploy
                // Refresh will happen on next manual refresh or page load
                // setTimeout(() => refreshAllVersions(), 500); // DISABLED - causes version revert due to GitHub caching
                
                // Start monitoring live site for deployment completion
                if (deployment.url && newVersion !== 'batch') {
                    addStep('GitHub Pages', 'running', 'Waiting for deploy...');
                    monitorLiveDeployment(deployment.url, newVersion, repo, (status, detail) => {
                        addStep('GitHub Pages', status, detail);
                        setActiveDeployment({ ...deployment });
                        setDeployments(prev => prev.map(d => d.id === deployment.id ? { ...deployment } : d));
                    });
                }
                
                // Remove deployed files from staged
                files.forEach(f => removeStaged(f.id));
                
            } catch (error) {
                deployment.status = 'failed';
                deployment.error = error.message;
                addStep('Error', 'error', error.message);
                console.error('Batch deployment failed:', error);
                
                // Check for workflow file permission issue
                let errorMessage = error.message;
                if (error.message.includes('Not Found') && filesToCommit.some(f => f.path.includes('.github/workflows'))) {
                    errorMessage = 'Cannot update workflow files. Your GitHub token needs the "workflow" scope.\n\n' +
                        'To fix:\n' +
                        '1. Go to GitHub ‚Üí Settings ‚Üí Developer settings ‚Üí Personal access tokens\n' +
                        '2. Edit your token and add the "workflow" scope\n' +
                        '3. Update the token in Command Center settings';
                }
                
                await showAlert(errorMessage, 'Deployment Error');
            }
            
            deployment.completedAt = new Date().toISOString();
            setActiveDeployment({ ...deployment });
            setDeployments(prev => prev.map(d => d.id === deployment.id ? deployment : d));
        };
        
        // Delete marked files
        const handleDeleteMarkedFiles = async () => {
            if (!github || markedForDeletion.length === 0) return;
            
            setModal(null);
            
            // Show loading state on affected repos
            const affectedRepos = [...new Set(markedForDeletion.map(i => i.repo))];
            for (const repo of affectedRepos) {
                setRepoFiles(prev => ({ ...prev, [repo]: { ...prev[repo], loading: true } }));
            }
            
            let successCount = 0;
            let failCount = 0;
            
            for (const item of markedForDeletion) {
                try {
                    await github.deleteFile(item.repo, item.path, `Delete ${item.path}`, item.sha);
                    successCount++;
                } catch (e) {
                    console.error(`Failed to delete ${item.path}:`, e);
                    failCount++;
                }
            }
            
            // Clear marked files
            setMarkedForDeletion([]);
            
            // Wait a moment for GitHub to process, then refresh
            await new Promise(resolve => setTimeout(resolve, 1500));
            
            for (const repo of affectedRepos) {
                await loadRepoFiles(repo);
            }
            
            // Show result
            if (failCount > 0) {
                await showAlert(`Deleted ${successCount} file(s), ${failCount} failed`, 'Delete Results');
            }
        };
        
        // Promote TEST ‚Üí PROD
        const handlePromote = async (appId) => {
            const app = apps[appId];
            
            // Check for required repos - don't fail silently!
            if (!app) {
                await showAlert(`App "${appId}" not found`, 'Promote Error');
                return;
            }
            if (!app.testRepo) {
                await showAlert(`No TEST repo configured for ${app.name}. Assign a test repo first.`, 'Promote Error');
                return;
            }
            if (!app.prodRepo) {
                await showAlert(`No PROD repo configured for ${app.name}. Assign a production repo first.`, 'Promote Error');
                return;
            }
            
            console.log(`[Promote] Starting promotion for ${appId}`);
            console.log(`[Promote] TEST repo: ${app.testRepo}`);
            console.log(`[Promote] PROD repo: ${app.prodRepo}`);
            
            setModal(null);
            
            const deployment = {
                id: Date.now(), status: 'running', steps: [],
                appId, appName: app.name, repo: app.prodRepo, target: 'prod',
                isPromotion: true, version: app.currentTestVersion,
                startedAt: new Date().toISOString()
            };
            
            setActiveDeployment(deployment);
            setDeployments(prev => [deployment, ...prev]);
            
            const addStep = (name, status, details = null) => {
                const existingIndex = deployment.steps.findIndex(s => s.name === name);
                if (existingIndex >= 0) {
                    deployment.steps[existingIndex] = { name, status, details };
                } else {
                    deployment.steps.push({ name, status, details });
                }
                setActiveDeployment({ ...deployment });
            };
            
            try {
                // Determine which files to promote
                // For PWA apps: index.html, sw.js, manifest.json, icons/*
                // For regular apps: just the targetPath (index.html)
                const baseFilesToPromote = [app.targetPath];
                if (app.hasServiceWorker && app.swPath) {
                    baseFilesToPromote.push(app.swPath);
                }
                // Always check for manifest.json for PWA apps
                if (app.hasServiceWorker) {
                    baseFilesToPromote.push('manifest.json');
                }
                
                // Convert to full paths with subPath
                const filesToPromote = baseFilesToPromote.map(f => getRepoFilePath(app, f));
                
                // For PWA apps, also check for icons folder
                let iconFiles = [];
                if (app.hasServiceWorker) {
                    try {
                        const iconsPath = getRepoFilePath(app, 'icons');
                        const iconsContents = await github.listRepoContents(app.testRepo, iconsPath);
                        iconFiles = iconsContents
                            .filter(f => f.type === 'file' && /\.(png|ico|svg|webp)$/i.test(f.name))
                            .map(f => getRepoFilePath(app, `icons/${f.name}`));
                        console.log(`Found ${iconFiles.length} icon files in TEST at ${iconsPath}`);
                    } catch (e) {
                        console.log('No icons folder found in TEST');
                    }
                }
                
                addStep('Fetching from TEST', 'running', `${filesToPromote.length + iconFiles.length} files`);
                
                const filesToCommit = [];
                let testVersion = null;
                
                // Fetch main PWA files
                const fullTargetPath = getRepoFilePath(app, app.targetPath);
                for (const filePath of filesToPromote) {
                    try {
                        const testFile = await github.getFile(app.testRepo, filePath);
                        if (testFile) {
                            let base64Content;
                            let decodedContent = null;
                            
                            // Handle large files (>1MB) - GitHub doesn't return content in contents API
                            // Use Git Blob API instead of download_url to bypass CDN caching
                            if (!testFile.content && testFile.sha) {
                                console.log(`üì¶ Large file detected: ${filePath}, using Git Blob API (SHA: ${testFile.sha})`);
                                const blob = await github.getBlobContent(app.testRepo, testFile.sha);
                                if (blob && blob.content) {
                                    base64Content = github.cleanBase64(blob.content);
                                    decodedContent = github.decodeContent(blob.content);
                                    console.log(`‚úì Fetched ${filePath} via Blob API (${blob.size} bytes)`);
                                } else {
                                    // Fallback to download_url if blob API fails
                                    console.log(`‚ö† Blob API failed, falling back to download_url`);
                                    if (testFile.download_url) {
                                        const cacheBustUrl = testFile.download_url + (testFile.download_url.includes('?') ? '&' : '?') + '_=' + Date.now();
                                        const response = await fetch(cacheBustUrl);
                                        const textContent = await response.text();
                                        base64Content = btoa(unescape(encodeURIComponent(textContent)));
                                        decodedContent = textContent;
                                    } else {
                                        console.log(`‚ö† ${filePath} has no content, no blob, and no download_url, skipping`);
                                        continue;
                                    }
                                }
                            } else if (testFile.content) {
                                // Normal file - use base64 directly
                                base64Content = github.cleanBase64(testFile.content);
                                decodedContent = github.decodeContent(testFile.content);
                            } else {
                                console.log(`‚ö† ${filePath} has no content and no sha, skipping`);
                                continue;
                            }
                            
                            filesToCommit.push({
                                path: filePath,
                                content: base64Content,
                                encoding: 'base64'
                            });
                            
                            // Extract version from main HTML file
                            if (filePath === fullTargetPath && decodedContent) {
                                testVersion = extractVersionFromHTML(decodedContent);
                                deployment.fileContent = decodedContent;
                            }
                            
                            console.log(`‚úì Found ${filePath} in TEST (${base64Content.length} bytes base64)`);
                        }
                    } catch (e) {
                        // File doesn't exist in TEST, skip it (manifest.json might not exist)
                        console.log(`‚ö† ${filePath} not found in TEST, skipping: ${e.message}`);
                    }
                }
                
                // Fetch icon files (binary - use base64)
                for (const iconPath of iconFiles) {
                    try {
                        const iconFile = await github.getFile(app.testRepo, iconPath);
                        if (iconFile) {
                            // Icons should always have content (they're small)
                            // But check just in case
                            if (!iconFile.content) {
                                console.warn(`‚ö† Icon ${iconPath} has no content (too large?), skipping`);
                                continue;
                            }
                            filesToCommit.push({
                                path: iconPath,
                                content: github.cleanBase64(iconFile.content),
                                encoding: 'base64'
                            });
                            console.log(`‚úì Found ${iconPath} in TEST`);
                        }
                    } catch (e) {
                        console.log(`‚ö† ${iconPath} not found in TEST, skipping`);
                    }
                }
                
                if (filesToCommit.length === 0) {
                    throw new Error('No files found in TEST repo');
                }
                
                addStep('Fetching from TEST', 'complete', `${filesToCommit.length} files, ${formatVersion(testVersion)}`);
                
                addStep('Checking PROD', 'running');
                const prodFileData = await github.getFileContent(app.prodRepo, fullTargetPath);
                const prodVersion = prodFileData ? extractVersionFromHTML(prodFileData.textContent) : null;
                deployment.previousVersion = prodVersion;
                addStep('Checking PROD', 'complete', prodVersion ? formatVersion(prodVersion) : 'Empty');
                
                // üì∏ Save rollback snapshot BEFORE promoting
                await saveRollbackSnapshot(appId, 'prod', app.prodRepo, fullTargetPath);
                
                addStep('Deploying', 'running', `${filesToCommit.length} files`);
                
                // Use batch commit for multiple files
                const result = await github.batchCommit(
                    app.prodRepo,
                    filesToCommit,
                    `Promote ${app.name} ${formatVersion(testVersion)} from test (${filesToCommit.length} files)`
                );
                
                deployment.commitSha = result.sha;
                deployment.fileCount = filesToCommit.length;
                addStep('Deploying', 'complete', `${result.sha.substring(0, 7)} (${filesToCommit.length} files)`);
                
                addStep('GitHub Pages', 'running');
                try {
                    await github.enablePages(app.prodRepo);
                    addStep('GitHub Pages', 'complete', 'Ready');
                } catch {
                    addStep('GitHub Pages', 'warning', 'Check settings');
                }
                
                if (settings.createTag && testVersion) {
                    addStep('Tagging', 'running');
                    try {
                        await github.createTag(app.prodRepo, `v${testVersion}`, result.sha, 'Release');
                        addStep('Tagging', 'complete', `v${testVersion}`);
                    } catch {
                        addStep('Tagging', 'warning', 'May exist');
                    }
                }
                
                deployment.status = 'success';
                deployment.version = testVersion;
                deployment.url = getGitHubPagesUrl(app.prodRepo, app.subPath);
                updateApp(appId, { currentProdVersion: testVersion });
                
                // Don't refresh immediately - GitHub's CDN needs time to propagate
                // setTimeout(() => refreshAllVersions(), 1000); // DISABLED - causes version revert
                
                // Start monitoring live site for deployment completion
                if (deployment.url && testVersion) {
                    addStep('GitHub Pages', 'running', 'Waiting for deploy...');
                    monitorLiveDeployment(deployment.url, testVersion, app.prodRepo, (status, detail) => {
                        addStep('GitHub Pages', status, detail);
                        setActiveDeployment({ ...deployment });
                        setDeployments(prev => prev.map(d => d.id === deployment.id ? { ...deployment } : d));
                    });
                }
                
            } catch (error) {
                deployment.status = 'failed';
                deployment.error = error.message;
                addStep('Error', 'error', error.message);
            }
            
            deployment.completedAt = new Date().toISOString();
            setActiveDeployment({ ...deployment });
            setDeployments(prev => prev.map(d => d.id === deployment.id ? deployment : d));
        };
        
        // Rollback
        const handleRollback = async (deploymentToRollbackTo) => {
            const app = apps[deploymentToRollbackTo.appId];
            if (!app) return;
            
            setModal(null);
            
            const repo = deploymentToRollbackTo.repo;
            const targetVersion = deploymentToRollbackTo.version;
            
            const deployment = {
                id: Date.now(), status: 'running', steps: [],
                appId: deploymentToRollbackTo.appId, appName: app.name,
                repo, target: deploymentToRollbackTo.target,
                isRollback: true, version: targetVersion,
                rollbackFromCommit: null,
                rollbackToCommit: deploymentToRollbackTo.commitSha,
                startedAt: new Date().toISOString()
            };
            
            setActiveDeployment(deployment);
            setDeployments(prev => [deployment, ...prev]);
            
            const addStep = (name, status, details = null) => {
                const existingIndex = deployment.steps.findIndex(s => s.name === name);
                if (existingIndex >= 0) {
                    deployment.steps[existingIndex] = { name, status, details };
                } else {
                    deployment.steps.push({ name, status, details });
                }
                setActiveDeployment({ ...deployment });
            };
            
            try {
                // Get full path including subPath
                const fullTargetPath = getRepoFilePath(app, app.targetPath);
                
                addStep('Getting current state', 'running');
                const currentFileData = await github.getFileContent(repo, fullTargetPath);
                // Use textContent which handles both normal and large files
                const currentVersion = currentFileData ? extractVersionFromHTML(currentFileData.textContent) : null;
                deployment.previousVersion = currentVersion;
                addStep('Getting current state', 'complete', formatVersion(currentVersion));
                
                addStep('Fetching rollback version', 'running');
                const rollbackFileData = await github.getFileContentAtCommit(repo, fullTargetPath, deploymentToRollbackTo.commitSha);
                if (!rollbackFileData) throw new Error('Cannot find file at that commit');
                // Use textContent which handles both normal and large files
                const content = rollbackFileData.textContent;
                deployment.fileContent = content;
                addStep('Fetching rollback version', 'complete', formatVersion(targetVersion));
                
                addStep('Rolling back', 'running');
                const result = await github.createOrUpdateFile(
                    repo, fullTargetPath, content,
                    `Rollback ${app.name} to ${formatVersion(targetVersion)} (was ${formatVersion(currentVersion)})`,
                    currentFileData?.sha
                );
                deployment.commitSha = result.commit.sha;
                addStep('Rolling back', 'complete', result.commit.sha.substring(0, 7));
                
                deployment.status = 'success';
                deployment.url = getGitHubPagesUrl(repo, app.subPath);
                const versionKey = deploymentToRollbackTo.target === 'prod' ? 'currentProdVersion' : 'currentTestVersion';
                updateApp(deploymentToRollbackTo.appId, { [versionKey]: targetVersion });
                
                // Start monitoring live site for deployment completion
                if (deployment.url && targetVersion) {
                    addStep('GitHub Pages', 'running', 'Waiting for deploy...');
                    monitorLiveDeployment(deployment.url, targetVersion, repo, (status, detail) => {
                        addStep('GitHub Pages', status, detail);
                        setActiveDeployment({ ...deployment });
                        setDeployments(prev => prev.map(d => d.id === deployment.id ? { ...deployment } : d));
                    });
                }
                
            } catch (error) {
                deployment.status = 'failed';
                deployment.error = error.message;
                addStep('Error', 'error', error.message);
            }
            
            deployment.completedAt = new Date().toISOString();
            setActiveDeployment({ ...deployment });
            setDeployments(prev => prev.map(d => d.id === deployment.id ? deployment : d));
        };
        
        return (
            <div className="min-h-screen">
                <header className="bg-slate-800 border-b border-slate-700 sticky top-0 z-50">
                    <div className="max-w-6xl mx-auto px-4 py-3">
                        {/* Top row: Logo and main nav */}
                        <div className="flex items-center justify-between">
                            <div className="flex items-center gap-3">
                                <Icons.GameShelfLogo size={32} />
                                <div>
                                    <h1 className="text-lg font-bold">Command Center</h1>
                                    <div className="text-xs text-slate-400">v8.2.1 ‚Ä¢ Blob API for large files</div>
                                </div>
                            </div>
                            <div className="flex items-center gap-1">
                                <button onClick={() => refreshAllVersions()} disabled={refreshing}
                                    className={`p-2 rounded hover:bg-slate-700 ${refreshing ? 'animate-spin text-indigo-400' : 'text-slate-400'}`}
                                    title="Refresh versions">
                                    <Icons.Refresh />
                                </button>
                                {/* Consolidated Navigation - 4 main sections */}
                                {[
                                    { id: 'deploy', icon: 'üöÄ', label: 'Deploy', views: ['dashboard', 'history'] },
                                    { id: 'monitor', icon: 'üìä', label: 'Monitor', views: ['firebase', 'integrations', 'issues'] },
                                    { id: 'maintain', icon: 'üîß', label: 'Maintain', views: ['cleanup', 'files', 'archive', 'session'] },
                                    { id: 'configure', icon: '‚öôÔ∏è', label: 'Configure', views: ['config', 'apps', 'settings'] }
                                ].map(section => (
                                    <div key={section.id} className="relative group">
                                        <button
                                            className={`px-3 py-1.5 rounded text-sm flex items-center gap-1 ${
                                                section.views.includes(view) ? 'bg-indigo-600 text-white' : 'text-slate-400 hover:text-white hover:bg-slate-700'
                                            }`}
                                        >
                                            <span>{section.icon}</span> {section.label}
                                            <span className="text-xs opacity-60">‚ñº</span>
                                        </button>
                                        {/* Dropdown */}
                                        <div className="absolute top-full left-0 mt-1 bg-slate-800 border border-slate-700 rounded-lg shadow-xl opacity-0 invisible group-hover:opacity-100 group-hover:visible transition-all z-50 min-w-[160px]">
                                            {section.views.map(v => (
                                                <button
                                                    key={v}
                                                    onClick={() => setView(v)}
                                                    className={`w-full text-left px-4 py-2 text-sm capitalize hover:bg-slate-700 first:rounded-t-lg last:rounded-b-lg ${
                                                        view === v ? 'bg-indigo-600/30 text-indigo-300' : 'text-slate-300'
                                                    }`}
                                                >
                                                    {v === 'dashboard' && 'üìã Dashboard'}
                                                    {v === 'history' && 'üìú Deploy History'}
                                                    {v === 'firebase' && 'üî• Firebase'}
                                                    {v === 'integrations' && '‚ö° Integrations'}
                                                    {v === 'issues' && 'üêõ Issues'}
                                                    {v === 'cleanup' && 'üóëÔ∏è Cleanup'}
                                                    {v === 'files' && 'üìÅ Files'}
                                                    {v === 'archive' && 'üì¶ Archive'}
                                                    {v === 'session' && 'üìù Session Log'}
                                                    {v === 'config' && 'üåç Environments'}
                                                    {v === 'apps' && 'üì± Apps'}
                                                    {v === 'settings' && 'üîë Settings'}
                                                </button>
                                            ))}
                                        </div>
                                    </div>
                                ))}
                            </div>
                        </div>
                        
                        {/* Quick Actions Bar */}
                        <div className="mt-3 pt-3 border-t border-slate-700 flex items-center gap-2 flex-wrap">
                            <span className="text-xs text-slate-500 mr-2">‚ö° Quick:</span>
                            <button
                                onClick={() => setModal({ type: 'deployAll' })}
                                disabled={stagedFiles.length === 0}
                                className="px-3 py-1 text-xs bg-green-600 hover:bg-green-500 disabled:opacity-40 disabled:hover:bg-green-600 rounded-full font-medium transition-colors"
                            >
                                üöÄ Deploy All ({stagedFiles.length})
                            </button>
                            <button
                                onClick={() => setModal({ type: 'syncEnvs' })}
                                className="px-3 py-1 text-xs bg-blue-600 hover:bg-blue-500 rounded-full font-medium transition-colors"
                            >
                                üîÑ Sync TEST‚ÜíPROD
                            </button>
                            <button
                                onClick={() => setModal({ type: 'versionBump' })}
                                className="px-3 py-1 text-xs bg-purple-600 hover:bg-purple-500 rounded-full font-medium transition-colors"
                            >
                                üìà Bump Versions
                            </button>
                            <button
                                onClick={() => setView('integrations')}
                                className="px-3 py-1 text-xs bg-slate-700 hover:bg-slate-600 rounded-full font-medium transition-colors"
                            >
                                üíö Health Check
                            </button>
                            <button
                                onClick={() => { setView('cleanup'); }}
                                className="px-3 py-1 text-xs bg-slate-700 hover:bg-slate-600 rounded-full font-medium transition-colors"
                            >
                                üßπ Cleanup Scan
                            </button>
                            
                            {/* Status indicators */}
                            <div className="ml-auto flex items-center gap-3 text-xs">
                                <span className={`flex items-center gap-1 ${github ? 'text-green-400' : 'text-red-400'}`}>
                                    <span className={`w-2 h-2 rounded-full ${github ? 'bg-green-400' : 'bg-red-400'}`}></span>
                                    GitHub
                                </span>
                                <span className={`flex items-center gap-1 ${firebaseDb ? 'text-green-400' : 'text-amber-400'}`}>
                                    <span className={`w-2 h-2 rounded-full ${firebaseDb ? 'bg-green-400' : 'bg-amber-400'}`}></span>
                                    Firebase
                                </span>
                                <span className="text-slate-500">
                                    {availableRepos.length} repos
                                </span>
                            </div>
                        </div>
                    </div>
                </header>
                
                <main className="max-w-6xl mx-auto px-4 py-6">
                    {!githubToken && (
                        <div className="mb-6 p-4 bg-amber-900/50 border border-amber-700 rounded-lg">
                            ‚ö†Ô∏è <strong>GitHub Token Required</strong> - Go to Settings
                        </div>
                    )}
                    
                    {view === 'dashboard' && (
                        <DashboardView
                            apps={apps} stagedFiles={stagedFiles} github={github}
                            onFileDrop={handleFileDrop} onRemove={removeStaged}
                            onDeploy={handleDeploy} onBatchDeploy={handleBatchDeploy}
                            onPromote={(id) => {
                                console.log('[Promote Modal] Opening for:', id);
                                console.log('[Promote Modal] App state:', apps[id]);
                                console.log('[Promote Modal] testRepo:', apps[id]?.testRepo);
                                console.log('[Promote Modal] prodRepo:', apps[id]?.prodRepo);
                                setModal({ type: 'promote', data: { appId: id } });
                            }}
                            activeDeployment={activeDeployment}
                            setActiveDeployment={setActiveDeployment}
                            refreshing={refreshing}
                            onUpdateStagedFile={updateStagedFile}
                            deployingRepos={deployingRepos}
                            showConfirm={showConfirm}
                            showAlert={showAlert}
                            showPrompt={showPrompt}
                            globalIssues={globalIssues}
                            linkIssuesToVersion={linkIssuesToVersion}
                            setView={setView}
                            rollbackSnapshots={rollbackSnapshots}
                            onQuickRollback={quickRollback}
                        />
                    )}
                    
                    {view === 'archive' && (
                        <ArchiveView
                            apps={apps}
                            config={config}
                            github={github}
                            showAlert={showAlert}
                            showConfirm={showConfirm}
                            showPrompt={showPrompt}
                            globalIssues={globalIssues}
                            sessionLog={sessionLog}
                            deployments={deployments}
                        />
                    )}
                    
                    {view === 'files' && (
                        <RepoFilesView
                            apps={apps} github={github}
                            repoFiles={repoFiles} onLoadRepo={loadRepoFiles}
                            selectedRepo={selectedRepoForBrowse} onSelectRepo={setSelectedRepoForBrowse}
                            markedForDeletion={markedForDeletion} setMarkedForDeletion={setMarkedForDeletion}
                            onDeleteMarked={() => setModal({ type: 'confirmDelete' })}
                            showAlert={showAlert}
                        />
                    )}
                    
                    {view === 'firebase' && (
                        <FirebaseView showAlert={showAlert} showConfirm={showConfirm} showPrompt={showPrompt} />
                    )}
                    
                    {view === 'integrations' && (
                        <IntegrationsView showAlert={showAlert} showConfirm={showConfirm} showPrompt={showPrompt} />
                    )}
                    
                    {view === 'cleanup' && (
                        <CleanupView 
                            github={github} 
                            config={config}
                            apps={apps}
                            availableRepos={availableRepos}
                            showAlert={showAlert} 
                            showConfirm={showConfirm} 
                        />
                    )}
                    
                    {view === 'apps' && <AppsView apps={apps} repos={availableRepos} onUpdate={updateApp} />}
                    
                    {view === 'history' && (
                        <HistoryView 
                            deployments={deployments} apps={apps}
                            onRollback={(d) => setModal({ type: 'rollback', data: d })}
                        />
                    )}
                    
                    {view === 'session' && (
                        <SessionLogView 
                            apps={apps}
                            sessionLog={sessionLog}
                            setSessionLog={setSessionLog}
                            deployments={deployments}
                            github={github}
                            onFileDrop={handleFileDrop}
                            showAlert={showAlert}
                        />
                    )}
                    
                    {view === 'issues' && (
                        <IssuesView apps={apps} deployments={deployments} showAlert={showAlert} showConfirm={showConfirm} showPrompt={showPrompt} />
                    )}
                    
                    {view === 'config' && (
                        <ConfigView 
                            config={config} 
                            onConfigChange={handleConfigChange}
                            showAlert={showAlert}
                            showConfirm={showConfirm}
                            github={github}
                            availableRepos={availableRepos}
                            onRefreshRepos={refreshRepos}
                        />
                    )}
                    
                    {view === 'settings' && (
                        <SettingsView token={githubToken} setToken={setGithubToken} settings={settings} setSettings={setSettings} repoCount={availableRepos.length} />
                    )}
                    
                    {/* Modals */}
                    {modal?.type === 'promote' && (
                        <PromoteModal app={apps[modal.data.appId]} onConfirm={() => handlePromote(modal.data.appId)} onCancel={() => setModal(null)} />
                    )}
                    
                    {modal?.type === 'rollback' && (
                        <RollbackModal deployment={modal.data} apps={apps} onConfirm={() => handleRollback(modal.data)} onCancel={() => setModal(null)} />
                    )}
                    
                    {modal?.type === 'versionWarning' && (
                        <VersionWarningModal
                            data={modal.data}
                            onForce={() => { setModal(null); handleDeploy(modal.data.file, modal.data.appId, modal.data.target, true); }}
                            onCancel={() => setModal(null)}
                        />
                    )}
                    
                    {modal?.type === 'confirmDelete' && (
                        <ConfirmDeleteModal
                            files={markedForDeletion}
                            onConfirm={handleDeleteMarkedFiles}
                            onCancel={() => setModal(null)}
                        />
                    )}
                    
                    {/* Deploy All Modal */}
                    {modal?.type === 'deployAll' && (
                        <DeployAllModal
                            stagedFiles={stagedFiles}
                            apps={apps}
                            onConfirm={async (files) => {
                                setModal(null);
                                for (const file of files) {
                                    await handleDeploy(file, file.appId, file.target || 'test');
                                }
                            }}
                            onCancel={() => setModal(null)}
                        />
                    )}
                    
                    {/* Sync Environments Modal */}
                    {modal?.type === 'syncEnvs' && (
                        <SyncEnvsModal
                            apps={apps}
                            github={github}
                            onConfirm={async (selectedApps) => {
                                setModal(null);
                                for (const appId of selectedApps) {
                                    await handlePromote(appId);
                                }
                            }}
                            onCancel={() => setModal(null)}
                            showAlert={showAlert}
                        />
                    )}
                    
                    {/* Version Bump Modal */}
                    {modal?.type === 'versionBump' && (
                        <VersionBumpModal
                            apps={apps}
                            onConfirm={async (bumps) => {
                                setModal(null);
                                await showAlert(`Version bumps prepared!\n\nTo apply, you'll need to update the source files and redeploy.\n\n${bumps.map(b => `${b.app}: ${b.current} ‚Üí ${b.new}`).join('\n')}`, 'Version Bump Preview');
                            }}
                            onCancel={() => setModal(null)}
                        />
                    )}
                    
                    {/* Custom Dialog Modal (replaces native alert/confirm/prompt) */}
                    {dialog && (
                        <DialogModal
                            type={dialog.type}
                            title={dialog.title}
                            message={dialog.message}
                            defaultValue={dialog.defaultValue}
                            confirmText={dialog.confirmText}
                            cancelText={dialog.cancelText}
                            onConfirm={(value) => {
                                if (dialog.onConfirm) dialog.onConfirm(value);
                                setDialog(null);
                            }}
                            onCancel={() => {
                                if (dialog.onCancel) dialog.onCancel();
                                setDialog(null);
                            }}
                        />
                    )}
                </main>
            </div>
        );
    }

    // =========================================================================
    // VERSION WARNING MODAL
    // =========================================================================
    
    function VersionWarningModal({ data, onForce, onCancel }) {
        const { currentVersion, newVersion, target } = data;
        const isEqual = compareVersions(newVersion, currentVersion) === 0;
        
        return (
            <div className="fixed inset-0 bg-black/70 flex items-center justify-center z-50 p-4">
                <div className="bg-slate-800 rounded-xl border border-red-700 p-6 max-w-md w-full fade-in">
                    <h2 className="text-xl font-bold mb-4 flex items-center gap-2 text-red-400">
                        <Icons.AlertTriangle /> Version Conflict
                    </h2>
                    
                    <div className="mb-4 p-4 bg-red-900/30 rounded-lg">
                        <div className="text-center mb-3">
                            <div className="text-sm text-slate-400">Currently Deployed</div>
                            <div className="text-2xl font-mono text-green-400">{formatVersion(currentVersion)}</div>
                        </div>
                        <div className="text-center text-2xl">‚Üì</div>
                        <div className="text-center mt-3">
                            <div className="text-sm text-slate-400">Trying to Deploy</div>
                            <div className="text-2xl font-mono text-red-400">{formatVersion(newVersion)}</div>
                        </div>
                    </div>
                    
                    <p className="text-slate-300 mb-4">
                        {isEqual 
                            ? `You're deploying the same version that's already on ${target.toUpperCase()}.`
                            : `You're deploying an older version than what's currently on ${target.toUpperCase()}.`
                        }
                    </p>
                    
                    <div className="flex gap-3">
                        <button onClick={onCancel} className="flex-1 p-2 bg-slate-700 rounded">Cancel</button>
                        <button onClick={onForce} className="flex-1 p-2 bg-red-600 rounded flex items-center justify-center gap-2">
                            <Icons.AlertTriangle className="w-4 h-4" /> Force Deploy
                        </button>
                    </div>
                </div>
            </div>
        );
    }

    // =========================================================================
    // DEPLOY ALL MODAL (v8.0)
    // =========================================================================
    
    function DeployAllModal({ stagedFiles, apps, onConfirm, onCancel }) {
        const [selectedFiles, setSelectedFiles] = React.useState(new Set(stagedFiles.map((_, i) => i)));
        const [target, setTarget] = React.useState('test');
        
        const toggleFile = (idx) => {
            setSelectedFiles(prev => {
                const newSet = new Set(prev);
                if (newSet.has(idx)) newSet.delete(idx);
                else newSet.add(idx);
                return newSet;
            });
        };
        
        const handleConfirm = () => {
            const files = stagedFiles.filter((_, i) => selectedFiles.has(i)).map(f => ({ ...f, target }));
            onConfirm(files);
        };
        
        return (
            <div className="fixed inset-0 bg-black/70 flex items-center justify-center z-50 p-4">
                <div className="bg-slate-800 rounded-xl border border-green-700 p-6 max-w-lg w-full fade-in">
                    <h2 className="text-xl font-bold mb-4 flex items-center gap-2 text-green-400">
                        üöÄ Deploy All Staged Files
                    </h2>
                    
                    <div className="mb-4">
                        <label className="text-sm text-slate-400 block mb-2">Target Environment</label>
                        <div className="flex gap-2">
                            {['test', 'prod'].map(t => (
                                <button
                                    key={t}
                                    onClick={() => setTarget(t)}
                                    className={`flex-1 py-2 rounded font-medium ${
                                        target === t 
                                            ? t === 'prod' ? 'bg-green-600' : 'bg-blue-600'
                                            : 'bg-slate-700'
                                    }`}
                                >
                                    {t.toUpperCase()}
                                </button>
                            ))}
                        </div>
                    </div>
                    
                    <div className="mb-4 max-h-64 overflow-y-auto bg-slate-900 rounded-lg">
                        {stagedFiles.map((file, idx) => (
                            <div
                                key={idx}
                                onClick={() => toggleFile(idx)}
                                className={`flex items-center gap-3 p-3 border-b border-slate-800 cursor-pointer hover:bg-slate-800 ${
                                    selectedFiles.has(idx) ? 'bg-slate-800/50' : ''
                                }`}
                            >
                                <input type="checkbox" checked={selectedFiles.has(idx)} readOnly className="w-4 h-4" />
                                <span className="text-lg">{apps[file.appId]?.icon || 'üìÑ'}</span>
                                <div className="flex-1 min-w-0">
                                    <div className="font-medium truncate">{file.name}</div>
                                    <div className="text-xs text-slate-500">{apps[file.appId]?.name} ‚Ä¢ v{file.version}</div>
                                </div>
                            </div>
                        ))}
                    </div>
                    
                    <div className="flex gap-3">
                        <button onClick={onCancel} className="flex-1 p-2 bg-slate-700 rounded">Cancel</button>
                        <button
                            onClick={handleConfirm}
                            disabled={selectedFiles.size === 0}
                            className="flex-1 p-2 bg-green-600 hover:bg-green-500 disabled:opacity-50 rounded font-medium"
                        >
                            Deploy {selectedFiles.size} File(s) to {target.toUpperCase()}
                        </button>
                    </div>
                </div>
            </div>
        );
    }

    // =========================================================================
    // SYNC ENVIRONMENTS MODAL (v8.0)
    // =========================================================================
    
    function SyncEnvsModal({ apps, github, onConfirm, onCancel, showAlert }) {
        const [selectedApps, setSelectedApps] = React.useState(new Set());
        const [loading, setLoading] = React.useState(false);
        
        // Filter to apps that have both test and prod repos
        const syncableApps = Object.values(apps).filter(app => 
            app.repos?.test && app.repos?.prod && app.versions?.test
        );
        
        const toggleApp = (appId) => {
            setSelectedApps(prev => {
                const newSet = new Set(prev);
                if (newSet.has(appId)) newSet.delete(appId);
                else newSet.add(appId);
                return newSet;
            });
        };
        
        const selectAll = () => {
            setSelectedApps(new Set(syncableApps.map(a => a.id)));
        };
        
        return (
            <div className="fixed inset-0 bg-black/70 flex items-center justify-center z-50 p-4">
                <div className="bg-slate-800 rounded-xl border border-blue-700 p-6 max-w-lg w-full fade-in">
                    <h2 className="text-xl font-bold mb-4 flex items-center gap-2 text-blue-400">
                        üîÑ Sync TEST ‚Üí PROD
                    </h2>
                    
                    <p className="text-sm text-slate-400 mb-4">
                        Promote TEST versions to PROD for selected apps.
                    </p>
                    
                    <div className="flex justify-end mb-2">
                        <button onClick={selectAll} className="text-xs text-indigo-400 hover:text-indigo-300">
                            Select All
                        </button>
                    </div>
                    
                    <div className="mb-4 max-h-64 overflow-y-auto bg-slate-900 rounded-lg">
                        {syncableApps.length === 0 ? (
                            <div className="p-4 text-center text-slate-500">
                                No apps with TEST‚ÜíPROD repos configured
                            </div>
                        ) : (
                            syncableApps.map(app => {
                                const testV = app.versions?.test || '?';
                                const prodV = app.versions?.prod || '?';
                                const needsSync = testV !== prodV;
                                
                                return (
                                    <div
                                        key={app.id}
                                        onClick={() => toggleApp(app.id)}
                                        className={`flex items-center gap-3 p-3 border-b border-slate-800 cursor-pointer hover:bg-slate-800 ${
                                            selectedApps.has(app.id) ? 'bg-slate-800/50' : ''
                                        }`}
                                    >
                                        <input type="checkbox" checked={selectedApps.has(app.id)} readOnly className="w-4 h-4" />
                                        <span className="text-lg">{app.icon}</span>
                                        <div className="flex-1">
                                            <div className="font-medium">{app.name}</div>
                                            <div className="text-xs">
                                                <span className="text-blue-400">TEST: {testV}</span>
                                                <span className="mx-2">‚Üí</span>
                                                <span className="text-green-400">PROD: {prodV}</span>
                                                {needsSync && <span className="ml-2 text-amber-400">(out of sync)</span>}
                                            </div>
                                        </div>
                                    </div>
                                );
                            })
                        )}
                    </div>
                    
                    <div className="flex gap-3">
                        <button onClick={onCancel} className="flex-1 p-2 bg-slate-700 rounded">Cancel</button>
                        <button
                            onClick={() => onConfirm(Array.from(selectedApps))}
                            disabled={selectedApps.size === 0 || loading}
                            className="flex-1 p-2 bg-blue-600 hover:bg-blue-500 disabled:opacity-50 rounded font-medium"
                        >
                            Sync {selectedApps.size} App(s)
                        </button>
                    </div>
                </div>
            </div>
        );
    }

    // =========================================================================
    // VERSION BUMP MODAL (v8.0)
    // =========================================================================
    
    function VersionBumpModal({ apps, onConfirm, onCancel }) {
        const [bumpType, setBumpType] = React.useState('patch'); // patch, minor, major
        const [selectedApps, setSelectedApps] = React.useState(new Set());
        
        const bumpableApps = Object.values(apps).filter(app => app.versions?.prod || app.versions?.test);
        
        const toggleApp = (appId) => {
            setSelectedApps(prev => {
                const newSet = new Set(prev);
                if (newSet.has(appId)) newSet.delete(appId);
                else newSet.add(appId);
                return newSet;
            });
        };
        
        const selectAll = () => {
            setSelectedApps(new Set(bumpableApps.map(a => a.id)));
        };
        
        const bumpVersion = (version, type) => {
            if (!version) return '1.0.0';
            const parts = version.split('.').map(Number);
            while (parts.length < 3) parts.push(0);
            
            if (type === 'major') {
                parts[0]++;
                parts[1] = 0;
                parts[2] = 0;
            } else if (type === 'minor') {
                parts[1]++;
                parts[2] = 0;
            } else {
                parts[2]++;
            }
            
            return parts.join('.');
        };
        
        const handleConfirm = () => {
            const bumps = Array.from(selectedApps).map(appId => {
                const app = apps[appId];
                const current = app.versions?.prod || app.versions?.test || '1.0.0';
                return {
                    appId,
                    app: app.name,
                    current,
                    new: bumpVersion(current, bumpType)
                };
            });
            onConfirm(bumps);
        };
        
        return (
            <div className="fixed inset-0 bg-black/70 flex items-center justify-center z-50 p-4">
                <div className="bg-slate-800 rounded-xl border border-purple-700 p-6 max-w-lg w-full fade-in">
                    <h2 className="text-xl font-bold mb-4 flex items-center gap-2 text-purple-400">
                        üìà Version Bump
                    </h2>
                    
                    <div className="mb-4">
                        <label className="text-sm text-slate-400 block mb-2">Bump Type</label>
                        <div className="flex gap-2">
                            {[
                                { id: 'patch', label: 'Patch', desc: '1.0.0 ‚Üí 1.0.1' },
                                { id: 'minor', label: 'Minor', desc: '1.0.0 ‚Üí 1.1.0' },
                                { id: 'major', label: 'Major', desc: '1.0.0 ‚Üí 2.0.0' }
                            ].map(t => (
                                <button
                                    key={t.id}
                                    onClick={() => setBumpType(t.id)}
                                    className={`flex-1 py-2 px-3 rounded text-sm ${
                                        bumpType === t.id ? 'bg-purple-600' : 'bg-slate-700'
                                    }`}
                                >
                                    <div className="font-medium">{t.label}</div>
                                    <div className="text-xs opacity-60">{t.desc}</div>
                                </button>
                            ))}
                        </div>
                    </div>
                    
                    <div className="flex justify-end mb-2">
                        <button onClick={selectAll} className="text-xs text-indigo-400 hover:text-indigo-300">
                            Select All
                        </button>
                    </div>
                    
                    <div className="mb-4 max-h-64 overflow-y-auto bg-slate-900 rounded-lg">
                        {bumpableApps.map(app => {
                            const current = app.versions?.prod || app.versions?.test || '1.0.0';
                            const newV = bumpVersion(current, bumpType);
                            
                            return (
                                <div
                                    key={app.id}
                                    onClick={() => toggleApp(app.id)}
                                    className={`flex items-center gap-3 p-3 border-b border-slate-800 cursor-pointer hover:bg-slate-800 ${
                                        selectedApps.has(app.id) ? 'bg-slate-800/50' : ''
                                    }`}
                                >
                                    <input type="checkbox" checked={selectedApps.has(app.id)} readOnly className="w-4 h-4" />
                                    <span className="text-lg">{app.icon}</span>
                                    <div className="flex-1">
                                        <div className="font-medium">{app.name}</div>
                                    </div>
                                    <div className="text-sm font-mono">
                                        <span className="text-slate-400">{current}</span>
                                        <span className="mx-2 text-purple-400">‚Üí</span>
                                        <span className="text-purple-300">{newV}</span>
                                    </div>
                                </div>
                            );
                        })}
                    </div>
                    
                    <div className="p-3 bg-amber-900/30 border border-amber-700 rounded-lg mb-4 text-sm">
                        <strong>Note:</strong> This generates a preview. To apply version bumps, 
                        update the source files (index.html, sw.js) and redeploy.
                    </div>
                    
                    <div className="flex gap-3">
                        <button onClick={onCancel} className="flex-1 p-2 bg-slate-700 rounded">Cancel</button>
                        <button
                            onClick={handleConfirm}
                            disabled={selectedApps.size === 0}
                            className="flex-1 p-2 bg-purple-600 hover:bg-purple-500 disabled:opacity-50 rounded font-medium"
                        >
                            Preview Bumps ({selectedApps.size})
                        </button>
                    </div>
                </div>
            </div>
        );
    }

    // =========================================================================
    // ROLLBACK MODAL
    // =========================================================================
    
    function RollbackModal({ deployment, apps, onConfirm, onCancel }) {
        const app = apps[deployment.appId];
        
        return (
            <div className="fixed inset-0 bg-black/70 flex items-center justify-center z-50 p-4">
                <div className="bg-slate-800 rounded-xl border border-amber-700 p-6 max-w-md w-full fade-in">
                    <h2 className="text-xl font-bold mb-4 flex items-center gap-2 text-amber-400">
                        <Icons.Rewind /> Rollback
                    </h2>
                    
                    <div className="mb-4 p-4 bg-slate-900 rounded-lg">
                        <div className="flex items-center gap-2 mb-2">
                            <AppIcon icon={app?.icon} size={24} />
                            <span className="font-semibold">{app?.name}</span>
                            <span className={`text-xs px-1.5 rounded ${deployment.target === 'prod' ? 'bg-green-900 text-green-300' : 'bg-blue-900 text-blue-300'}`}>
                                {deployment.target?.toUpperCase()}
                            </span>
                        </div>
                        <div className="text-sm text-slate-400">
                            Rolling back to <span className="text-amber-400 font-mono">{formatVersion(deployment.version)}</span>
                        </div>
                        <div className="text-xs text-slate-500 mt-1">
                            Commit: {deployment.commitSha?.substring(0, 7)} ‚Ä¢ {formatDate(deployment.completedAt)}
                        </div>
                    </div>
                    
                    <p className="text-slate-300 text-sm mb-4">
                        This will restore the exact code from this deployment. A new commit will be created for audit purposes.
                    </p>
                    
                    <div className="flex gap-3">
                        <button onClick={onCancel} className="flex-1 p-2 bg-slate-700 rounded">Cancel</button>
                        <button onClick={onConfirm} className="flex-1 p-2 bg-amber-600 rounded flex items-center justify-center gap-2">
                            <Icons.Rewind className="w-4 h-4" /> Rollback
                        </button>
                    </div>
                </div>
            </div>
        );
    }

    // =========================================================================
    // PROMOTE MODAL
    // =========================================================================
    
    function PromoteModal({ app, onConfirm, onCancel }) {
        if (!app) return null;
        return (
            <div className="fixed inset-0 bg-black/70 flex items-center justify-center z-50 p-4">
                <div className="bg-slate-800 rounded-xl border border-slate-700 p-6 max-w-lg w-full fade-in">
                    <h2 className="text-xl font-bold mb-4">‚ö° Promote to Production</h2>
                    
                    <div className="flex items-center justify-center gap-4 mb-4">
                        <div className="p-3 bg-blue-900/30 border border-blue-700 rounded text-center">
                            <div className="text-xs text-blue-400">TEST</div>
                            <div className="font-mono">{app.testRepo?.split('/')[1]}</div>
                            <div className="text-sm text-slate-400">{formatVersion(app.currentTestVersion)}</div>
                        </div>
                        <div className="text-2xl">‚Üí</div>
                        <div className="p-3 bg-green-900/30 border border-green-700 rounded text-center">
                            <div className="text-xs text-green-400">PROD</div>
                            <div className="font-mono">{app.prodRepo?.split('/')[1]}</div>
                            <div className="text-sm text-slate-400">{formatVersion(app.currentProdVersion)}</div>
                        </div>
                    </div>
                    
                    <div className="bg-slate-900 rounded p-3 mb-4 text-sm">
                        <strong>This will:</strong>
                        <ol className="list-decimal list-inside mt-2 space-y-1 text-slate-300">
                            <li>Copy {app.targetPath} from TEST to PROD</li>
                            <li>Create release tag {formatVersion(app.currentTestVersion)}</li>
                            <li>GitHub Pages will deploy (~30s)</li>
                        </ol>
                    </div>
                    
                    <div className="flex gap-3">
                        <button onClick={onCancel} className="flex-1 p-2 bg-slate-700 rounded">Cancel</button>
                        <button onClick={onConfirm} className="flex-1 p-2 bg-green-600 rounded">
                            üöÄ Promote {formatVersion(app.currentTestVersion)}
                        </button>
                    </div>
                </div>
            </div>
        );
    }

    // =========================================================================
    // CONFIRM DELETE MODAL
    // =========================================================================
    
    function ConfirmDeleteModal({ files, onConfirm, onCancel }) {
        return (
            <div className="fixed inset-0 bg-black/70 flex items-center justify-center z-50 p-4">
                <div className="bg-slate-800 rounded-xl border border-red-700 p-6 max-w-md w-full fade-in">
                    <h2 className="text-xl font-bold mb-4 flex items-center gap-2 text-red-400">
                        <Icons.Trash /> Confirm Deletion
                    </h2>
                    
                    <p className="text-slate-300 mb-4">
                        Delete {files.length} file{files.length !== 1 ? 's' : ''}? This cannot be undone.
                    </p>
                    
                    <div className="max-h-40 overflow-y-auto mb-4 space-y-1">
                        {files.map((f, i) => (
                            <div key={i} className="text-sm text-slate-400 flex items-center gap-2">
                                <Icons.File /> {f.path}
                            </div>
                        ))}
                    </div>
                    
                    <div className="flex gap-3">
                        <button onClick={onCancel} className="flex-1 p-2 bg-slate-700 rounded">Cancel</button>
                        <button onClick={onConfirm} className="flex-1 p-2 bg-red-600 rounded flex items-center justify-center gap-2">
                            <Icons.Trash /> Delete Files
                        </button>
                    </div>
                </div>
            </div>
        );
    }

    // =========================================================================
    // DIALOG MODAL (replaces native alert/confirm/prompt)
    // =========================================================================
    
    function DialogModal({ type, title, message, defaultValue, confirmText, cancelText, onConfirm, onCancel }) {
        const [inputValue, setInputValue] = React.useState(defaultValue || '');
        const inputRef = React.useRef(null);
        
        React.useEffect(() => {
            if (type === 'prompt' && inputRef.current) {
                inputRef.current.focus();
                inputRef.current.select();
            }
        }, [type]);
        
        const handleKeyDown = (e) => {
            if (e.key === 'Enter') {
                e.preventDefault();
                onConfirm(type === 'prompt' ? inputValue : true);
            } else if (e.key === 'Escape') {
                onCancel();
            }
        };
        
        // Determine icon and colors based on message content
        const isError = message?.toLowerCase().includes('error') || message?.toLowerCase().includes('failed');
        const isWarning = message?.toLowerCase().includes('warning') || message?.toLowerCase().includes('‚ö†');
        const isSuccess = message?.toLowerCase().includes('‚úì') || message?.toLowerCase().includes('success');
        
        const borderColor = isError ? 'border-red-700' : isWarning ? 'border-amber-700' : isSuccess ? 'border-green-700' : 'border-slate-600';
        const iconColor = isError ? 'text-red-400' : isWarning ? 'text-amber-400' : isSuccess ? 'text-green-400' : 'text-indigo-400';
        
        return (
            <div className="fixed inset-0 bg-black/70 flex items-center justify-center z-[100] p-4" onKeyDown={handleKeyDown}>
                <div className={`bg-slate-800 rounded-xl border ${borderColor} p-6 max-w-md w-full fade-in shadow-2xl`}>
                    {title && (
                        <h2 className={`text-lg font-bold mb-3 flex items-center gap-2 ${iconColor}`}>
                            {isError ? <Icons.AlertTriangle /> : isWarning ? '‚ö†Ô∏è' : isSuccess ? '‚úì' : '‚ÑπÔ∏è'}
                            {title}
                        </h2>
                    )}
                    
                    <div className="text-slate-300 mb-4 whitespace-pre-wrap">{message}</div>
                    
                    {type === 'prompt' && (
                        <input
                            ref={inputRef}
                            type="text"
                            value={inputValue}
                            onChange={(e) => setInputValue(e.target.value)}
                            className="w-full p-3 bg-slate-900 border border-slate-600 rounded-lg mb-4 text-white focus:border-indigo-500 focus:outline-none"
                            placeholder="Enter value..."
                        />
                    )}
                    
                    <div className="flex gap-3">
                        {type !== 'alert' && (
                            <button 
                                onClick={onCancel} 
                                className="flex-1 p-2.5 bg-slate-700 hover:bg-slate-600 rounded-lg transition-colors">
                                {cancelText || 'Cancel'}
                            </button>
                        )}
                        <button 
                            onClick={() => onConfirm(type === 'prompt' ? inputValue : true)} 
                            className={`flex-1 p-2.5 rounded-lg transition-colors ${
                                isError ? 'bg-red-600 hover:bg-red-500' :
                                isWarning ? 'bg-amber-600 hover:bg-amber-500' :
                                'bg-indigo-600 hover:bg-indigo-500'
                            }`}>
                            {confirmText || 'OK'}
                        </button>
                    </div>
                </div>
            </div>
        );
    }

    // =========================================================================
    // DASHBOARD VIEW
    // =========================================================================
    
    function DashboardView({ apps, stagedFiles, github, onFileDrop, onRemove, onDeploy, onBatchDeploy, onPromote, activeDeployment, setActiveDeployment, refreshing, onUpdateStagedFile, deployingRepos, showConfirm, showAlert, showPrompt, globalIssues, linkIssuesToVersion, setView, rollbackSnapshots, onQuickRollback }) {
        const [selectedFileIds, setSelectedFileIds] = React.useState(new Set());
        const [deployTarget, setDeployTarget] = React.useState({ appId: 'management', target: 'test' });
        const [isDeploying, setIsDeploying] = React.useState(false);
        const [deployCompleted, setDeployCompleted] = React.useState(false);
        const configuredApps = Object.values(apps).filter(a => a.testRepo || a.prodRepo);
        
        // Auto-select detected app when staging new files
        React.useEffect(() => {
            if (stagedFiles.length === 0) return;
            
            // Find the most recently added file with high-confidence detection
            const filesWithDetection = stagedFiles.filter(f => f.appDetection?.confidence === 'high' || f.appDetection?.confidence === 'definite');
            if (filesWithDetection.length > 0) {
                const detected = filesWithDetection[filesWithDetection.length - 1].suggestedApp;
                if (detected && apps[detected]) {
                    // Firebase Functions only deploys to prod (GitHub Actions handles it)
                    const targetEnv = detected === 'firebase-functions' ? 'prod' : 'test';
                    setDeployTarget(prev => ({ ...prev, appId: detected, target: targetEnv }));
                    console.log('üéØ Auto-selected app:', detected, 'target:', targetEnv);
                    
                    // If app has no repo assigned, try to auto-assign from available repos
                    const app = apps[detected];
                    if (!app.prodRepo && github) {
                        console.log('üîç No prod repo for', detected, '- attempting auto-assignment...');
                        // Find repo matching this app's patterns
                        github.listRepos().then(repos => {
                            const patterns = app.repoPatterns?.prod || [];
                            for (const pattern of patterns) {
                                const found = repos.find(r => r.name.toLowerCase() === pattern.toLowerCase() && !r.name.toLowerCase().includes('test'));
                                if (found) {
                                    console.log('‚úÖ Auto-assigned prod repo:', found.fullName);
                                    updateApp(detected, { prodRepo: found.fullName });
                                    break;
                                }
                            }
                        }).catch(e => console.warn('Could not auto-assign repo:', e));
                    }
                }
            }
        }, [stagedFiles.length]); // Only when file count changes (new file added)
        
        // Keep deploying state while deployment is running, reset when complete
        React.useEffect(() => {
            if (activeDeployment) {
                if (activeDeployment.status === 'running') {
                    // Keep spinner going while deployment is in progress
                    setIsDeploying(true);
                } else if (activeDeployment.status === 'success' || activeDeployment.status === 'failed' || activeDeployment.status === 'error') {
                    // Only stop spinner when deployment finishes (success or failure)
                    setIsDeploying(false);
                    if (activeDeployment.status === 'success') {
                        setDeployCompleted(true);
                    }
                }
            }
        }, [activeDeployment, activeDeployment?.status]);
        
        // Reset deployCompleted when staging new files
        React.useEffect(() => {
            if (stagedFiles.length > 0) {
                setDeployCompleted(false);
            }
        }, [stagedFiles.length]);
        
        // Expanded app menus state
        const [expandedApps, setExpandedApps] = React.useState({});
        const [appInfo, setAppInfo] = React.useState({}); // { appId: { test: {...}, prod: {...} } }
        const [loadingAppInfo, setLoadingAppInfo] = React.useState({});
        
        // Toggle app menu expansion
        const toggleAppExpanded = async (appId) => {
            const newExpanded = !expandedApps[appId];
            setExpandedApps(prev => ({ ...prev, [appId]: newExpanded }));
            
            // Fetch app info if expanding and not already loaded
            if (newExpanded && !appInfo[appId] && github) {
                await fetchAppInfo(appId);
            }
        };
        
        // Fetch commit history and info for an app
        const fetchAppInfo = async (appId) => {
            const app = apps[appId];
            if (!app || !github) return;
            
            setLoadingAppInfo(prev => ({ ...prev, [appId]: true }));
            
            const info = { test: null, prod: null };
            
            try {
                if (app.testRepo) {
                    const [owner, repo] = app.testRepo.split('/');
                    const commits = await github.request(`/repos/${owner}/${repo}/commits?per_page=5`);
                    const repoData = await github.request(`/repos/${owner}/${repo}`);
                    info.test = {
                        lastCommit: commits[0],
                        recentCommits: commits,
                        pushedAt: repoData.pushed_at
                    };
                }
            } catch (e) {
                console.error('Error fetching test repo info:', e);
            }
            
            try {
                if (app.prodRepo) {
                    const [owner, repo] = app.prodRepo.split('/');
                    const commits = await github.request(`/repos/${owner}/${repo}/commits?per_page=5`);
                    const repoData = await github.request(`/repos/${owner}/${repo}`);
                    info.prod = {
                        lastCommit: commits[0],
                        recentCommits: commits,
                        pushedAt: repoData.pushed_at
                    };
                }
            } catch (e) {
                console.error('Error fetching prod repo info:', e);
            }
            
            setAppInfo(prev => ({ ...prev, [appId]: info }));
            setLoadingAppInfo(prev => ({ ...prev, [appId]: false }));
        };
        
        // Force GitHub Pages rebuild by creating an empty commit
        const forceRebuild = async (repo, target, silent = false) => {
            if (!github || !repo) return;
            
            if (!silent) {
                const confirmed = await showConfirm(
                    `This creates an empty commit to trigger GitHub Pages deployment.\n\nThe site should update in 30-90 seconds.`,
                    `Force Rebuild ${target.toUpperCase()}?`
                );
                if (!confirmed) return;
            }
            
            try {
                const [owner, repoName] = repo.split('/');
                
                // Get current commit
                const ref = await github.request(`/repos/${owner}/${repoName}/git/ref/heads/main`);
                const currentSha = ref.object.sha;
                
                // Get current commit details
                const commit = await github.request(`/repos/${owner}/${repoName}/git/commits/${currentSha}`);
                
                // Create new commit with same tree (empty commit)
                const newCommit = await github.request(`/repos/${owner}/${repoName}/git/commits`, {
                    method: 'POST',
                    body: JSON.stringify({
                        message: `Force rebuild - ${new Date().toISOString()}`,
                        tree: commit.tree.sha,
                        parents: [currentSha]
                    })
                });
                
                // Update ref (force: true handles non-fast-forward cases)
                await github.request(`/repos/${owner}/${repoName}/git/refs/heads/main`, {
                    method: 'PATCH',
                    body: JSON.stringify({ sha: newCommit.sha, force: true })
                });
                
                if (!silent) {
                    await showAlert(
                        `GitHub Pages should update in 30-90 seconds.`,
                        `‚úì Rebuild Triggered for ${target.toUpperCase()}`
                    );
                }
                
                // Refresh app info
                const appId = Object.entries(apps).find(([id, a]) => a.testRepo === repo || a.prodRepo === repo)?.[0];
                if (appId) {
                    setAppInfo(prev => ({ ...prev, [appId]: null }));
                    fetchAppInfo(appId);
                }
                
                return true;
                
            } catch (e) {
                if (!silent) {
                    await showAlert(`Error: ${e.message}`, 'Rebuild Failed');
                }
                return false;
            }
        };
        
        // Format relative time
        const formatRelativeTime = (dateStr) => {
            if (!dateStr) return '‚Äî';
            const date = new Date(dateStr);
            const now = new Date();
            const diffMs = now - date;
            const diffMins = Math.floor(diffMs / 60000);
            const diffHours = Math.floor(diffMs / 3600000);
            const diffDays = Math.floor(diffMs / 86400000);
            
            if (diffMins < 1) return 'just now';
            if (diffMins < 60) return `${diffMins}m ago`;
            if (diffHours < 24) return `${diffHours}h ago`;
            if (diffDays < 7) return `${diffDays}d ago`;
            return date.toLocaleDateString();
        };
        
        // Get actual selected files from staged (ensures fresh content)
        const selectedFiles = stagedFiles.filter(f => selectedFileIds.has(f.id));
        
        // Clean up selections when staged files change
        React.useEffect(() => {
            setSelectedFileIds(prev => {
                const validIds = new Set(stagedFiles.map(f => f.id));
                const newSet = new Set([...prev].filter(id => validIds.has(id)));
                return newSet.size !== prev.size ? newSet : prev;
            });
        }, [stagedFiles]);
        
        const toggleFileSelection = (file) => {
            setSelectedFileIds(prev => {
                const newSet = new Set(prev);
                if (newSet.has(file.id)) {
                    newSet.delete(file.id);
                } else {
                    newSet.add(file.id);
                }
                return newSet;
            });
        };
        
        const selectAll = () => setSelectedFileIds(new Set(stagedFiles.map(f => f.id)));
        const selectNone = () => setSelectedFileIds(new Set());
        
        return (
            <div className="grid grid-cols-1 lg:grid-cols-3 gap-6">
                <div className="lg:col-span-2 space-y-6">
                    {/* Upload */}
                    <div className="bg-slate-800 rounded-xl border border-slate-700 p-6">
                        <h2 className="text-lg font-semibold mb-4 flex items-center gap-2">
                            <Icons.Upload /> Upload Files
                        </h2>
                        <div onDrop={onFileDrop} onDragOver={e => e.preventDefault()}
                            className="border-2 border-dashed border-slate-600 rounded-lg p-8 text-center hover:border-indigo-500 cursor-pointer">
                            <input type="file" multiple accept=".html,.js,.css,.json,.zip,.yml,.yaml" onChange={onFileDrop} className="hidden" id="upload" />
                            <label htmlFor="upload" className="cursor-pointer">
                                <div className="text-4xl mb-3">üìÅ</div>
                                <div>Drop files here (HTML, JS, CSS, images...)</div>
                                <div className="text-xs text-slate-500 mt-2">
                                    Multi-file deploy supported ‚Ä¢ Version from <code>&lt;meta name="version"&gt;</code>
                                </div>
                            </label>
                        </div>
                    </div>
                    
                    {/* Staged Files */}
                    {stagedFiles.length > 0 && (
                        <div className="bg-slate-800 rounded-xl border border-slate-700 p-6">
                            <div className="flex items-center justify-between mb-4">
                                <h2 className="text-lg font-semibold">Staged ({stagedFiles.length})</h2>
                                <div className="flex gap-2 text-xs">
                                    <button onClick={selectAll} className="px-2 py-1 bg-slate-700 rounded hover:bg-slate-600">Select All</button>
                                    <button onClick={selectNone} className="px-2 py-1 bg-slate-700 rounded hover:bg-slate-600">Select None</button>
                                    <button onClick={() => {
                                        setSelectedFileIds(new Set());
                                        stagedFiles.forEach(f => onRemove(f.id));
                                    }} className="px-2 py-1 bg-red-700 hover:bg-red-600 rounded flex items-center gap-1">
                                        <Icons.Trash /> Clear All
                                    </button>
                                </div>
                            </div>
                            
                            {/* Batch Deploy Controls - At top for easy access */}
                            {selectedFiles.length > 0 && (() => {
                                // Check if selected files have detected apps
                                const detectedApps = selectedFiles
                                    .filter(f => f.appDetection)
                                    .map(f => ({ file: f.name, app: f.suggestedApp, confidence: f.appDetection.confidence }));
                                
                                const uniqueDetected = [...new Set(detectedApps.map(d => d.app))];
                                const primaryDetected = detectedApps.find(d => d.confidence === 'high')?.app || uniqueDetected[0];
                                
                                // Check for mismatch
                                const hasMismatch = primaryDetected && deployTarget.appId !== primaryDetected;
                                const hasConflict = uniqueDetected.length > 1;
                                
                                return (
                                <div className="mb-4 p-4 bg-slate-900 rounded-lg border border-indigo-500">
                                    <div className="text-sm font-medium mb-3 flex items-center gap-2">
                                        <Icons.Upload /> Deploy {selectedFiles.length} selected file{selectedFiles.length !== 1 ? 's' : ''}
                                    </div>
                                    
                                    {/* Auto-detected app suggestion */}
                                    {primaryDetected && !hasConflict && (
                                        <div className={`mb-3 p-2 rounded text-sm flex items-center justify-between ${
                                            hasMismatch ? 'bg-amber-900/50 border border-amber-600' : 'bg-green-900/50 border border-green-600'
                                        }`}>
                                            <span className="flex items-center gap-2">
                                                {hasMismatch ? '‚ö†Ô∏è' : 'üéØ'} Detected: <strong className="flex items-center gap-1"><AppIcon icon={apps[primaryDetected]?.icon} size={18} /> {apps[primaryDetected]?.name}</strong>
                                            </span>
                                            {hasMismatch && (
                                                <button 
                                                    onClick={() => setDeployTarget(p => ({ ...p, appId: primaryDetected }))}
                                                    className="px-2 py-1 bg-green-700 hover:bg-green-600 rounded text-xs">
                                                    Use Detected
                                                </button>
                                            )}
                                        </div>
                                    )}
                                    
                                    {/* Conflict warning */}
                                    {hasConflict && (
                                        <div className="mb-3 p-2 bg-red-900/50 border border-red-600 rounded text-sm">
                                            ‚ö†Ô∏è Multiple apps detected in selection: {uniqueDetected.map(a => apps[a]?.name).join(', ')}
                                        </div>
                                    )}
                                    
                                    <div className="grid grid-cols-2 gap-3 mb-3">
                                        <select value={deployTarget.appId} onChange={e => setDeployTarget(p => ({ ...p, appId: e.target.value }))}
                                            className={`p-2 border rounded text-sm ${
                                                hasMismatch 
                                                    ? 'bg-amber-900 border-amber-500' 
                                                    : 'bg-slate-700 border-slate-600'
                                            }`}>
                                            {Object.values(apps).map(a => <option key={a.id} value={a.id}>{getAppEmoji(a.icon)} {a.name}</option>)}
                                        </select>
                                        <select value={deployTarget.target} onChange={e => setDeployTarget(p => ({ ...p, target: e.target.value }))}
                                            className="p-2 bg-slate-700 border border-slate-600 rounded text-sm">
                                            <option value="test">üß™ TEST</option>
                                            <option value="prod">üöÄ PROD</option>
                                        </select>
                                    </div>
                                    
                                    {/* Mismatch warning on deploy button */}
                                    {hasMismatch && (
                                        <div className="mb-2 text-xs text-amber-400">
                                            ‚ö†Ô∏è You're deploying to {apps[deployTarget.appId]?.name} but file appears to be {apps[primaryDetected]?.name}
                                        </div>
                                    )}
                                    
                                    <button onClick={async () => {
                                        // Reset completed state when starting new deploy
                                        setDeployCompleted(false);
                                        
                                        // Show confirmation if mismatch detected
                                        if (hasMismatch) {
                                            const confirmed = await showConfirm(
                                                `File detected as ${apps[primaryDetected]?.name} but deploying to ${apps[deployTarget.appId]?.name}. Continue anyway?`,
                                                'Deploy Mismatch Warning'
                                            );
                                            if (confirmed) {
                                                setIsDeploying(true);
                                                console.log('Deploying files:', selectedFiles.map(f => ({ name: f.name, id: f.id, size: f.content?.length })));
                                                onBatchDeploy(selectedFiles, deployTarget.appId, deployTarget.target);
                                                // Always reset to TEST after initiating deploy (safety default)
                                                setDeployTarget(prev => ({ ...prev, target: 'test' }));
                                            }
                                        } else {
                                            setIsDeploying(true);
                                            console.log('Deploying files:', selectedFiles.map(f => ({ name: f.name, id: f.id, size: f.content?.length })));
                                            onBatchDeploy(selectedFiles, deployTarget.appId, deployTarget.target);
                                            // Always reset to TEST after initiating deploy (safety default)
                                            setDeployTarget(prev => ({ ...prev, target: 'test' }));
                                        }
                                    }}
                                        disabled={!github || isDeploying}
                                        className={`w-full p-3 rounded font-medium flex items-center justify-center gap-2 transition-all ${
                                            isDeploying
                                                ? 'bg-emerald-700 cursor-wait'
                                                : deployCompleted
                                                    ? 'bg-orange-500 hover:bg-orange-600'
                                                    : hasMismatch 
                                                        ? 'bg-amber-600 hover:bg-amber-700' 
                                                        : deployTarget.target === 'prod' 
                                                            ? 'bg-green-600 hover:bg-green-700' 
                                                            : 'bg-blue-600 hover:bg-blue-700'
                                        }`}>
                                        {isDeploying ? (
                                            <>
                                                <div className="w-4 h-4 border-2 border-white border-t-transparent rounded-full animate-spin" />
                                                Deploying...
                                            </>
                                        ) : deployCompleted ? (
                                            <>
                                                ‚úì Deployed! Click to deploy again
                                            </>
                                        ) : (
                                            <>
                                                {hasMismatch && '‚ö†Ô∏è '}{selectedFiles.length === 1 ? 'Deploy File' : `Batch Deploy ${selectedFiles.length} Files`}
                                            </>
                                        )}
                                    </button>
                                </div>
                                );
                            })()}
                            
                            {/* File List */}
                            <div className="space-y-2">
                                {stagedFiles.map(f => {
                                    const isHtml = f.name.endsWith('.html');
                                    const willRename = isHtml && f.targetPath === 'index.html' && f.name !== 'index.html';
                                    
                                    return (
                                    <div key={f.id} className={`p-3 rounded-lg border ${
                                        selectedFileIds.has(f.id) ? 'bg-indigo-900/50 border-indigo-500' : 'bg-slate-700/50 border-slate-600'
                                    }`}>
                                        <div className="flex items-center gap-3">
                                            <input type="checkbox" checked={selectedFileIds.has(f.id)}
                                                onChange={() => toggleFileSelection(f)} className="w-4 h-4" />
                                            <span className="text-xl">{getFileIcon(f.name)}</span>
                                            <div className="flex-1 min-w-0">
                                                {/* Source filename */}
                                                <div className="font-medium truncate text-slate-300">{f.name}</div>
                                                
                                                {/* File info */}
                                                <div className="text-xs text-slate-400 flex items-center gap-2 flex-wrap mt-0.5">
                                                    {formatBytes(f.size)}
                                                    {f.version && (
                                                        <span className="px-1.5 py-0.5 bg-slate-600 rounded">
                                                            {formatVersion(f.version)}
                                                            {f.versionSource === 'html' && <span className="text-green-400 ml-1">‚úì</span>}
                                                        </span>
                                                    )}
                                                    {/* App detection badge */}
                                                    {f.suggestedApp && apps[f.suggestedApp] && (
                                                        <span className={`px-1.5 py-0.5 rounded flex items-center gap-1 ${
                                                            f.appDetection 
                                                                ? f.appDetection.method === 'gs-app-id'
                                                                    ? 'bg-emerald-700 text-emerald-100'
                                                                    : f.appDetection.confidence === 'high' 
                                                                        ? 'bg-green-700 text-green-100' 
                                                                        : 'bg-yellow-700 text-yellow-100'
                                                                : 'bg-slate-600 text-slate-300'
                                                        }`} title={f.appDetection 
                                                            ? f.appDetection.method === 'gs-app-id'
                                                                ? 'Identified by gs-app-id meta tag (definite)'
                                                                : `Detected by pattern matching (${f.appDetection.matchCount} matches)`
                                                            : 'From filename'}>
                                                            <AppIcon icon={apps[f.suggestedApp].icon} size={16} />
                                                            <span>{apps[f.suggestedApp].name}</span>
                                                            {f.appDetection && (
                                                                <span className="text-xs opacity-75">
                                                                    {f.appDetection.method === 'gs-app-id' ? '‚úì' : f.appDetection.confidence === 'high' ? 'üéØ' : '‚ùì'}
                                                                </span>
                                                            )}
                                                        </span>
                                                    )}
                                                    {!f.isText && <span className="text-amber-400">binary</span>}
                                                </div>
                                                
                                                {/* Target path section */}
                                                <div className="mt-2 p-2 bg-slate-800 rounded border border-slate-600">
                                                    <div className="text-xs text-slate-500 mb-1">Deploy as:</div>
                                                    <div className="flex items-center gap-2">
                                                        <input type="text" value={f.targetPath} 
                                                            onChange={e => onUpdateStagedFile(f.id, { targetPath: e.target.value })}
                                                            onClick={e => e.stopPropagation()}
                                                            className="flex-1 text-sm bg-slate-900 border border-slate-500 rounded px-2 py-1 font-mono text-white"
                                                            placeholder="index.html" />
                                                        {isHtml && f.name !== 'index.html' && (
                                                            <button 
                                                                onClick={(e) => {
                                                                    e.stopPropagation();
                                                                    onUpdateStagedFile(f.id, { 
                                                                        targetPath: f.targetPath === 'index.html' ? f.name : 'index.html' 
                                                                    });
                                                                }}
                                                                className={`px-2 py-1 text-xs rounded whitespace-nowrap ${
                                                                    f.targetPath === 'index.html' 
                                                                        ? 'bg-green-700 text-green-100' 
                                                                        : 'bg-slate-600 text-slate-300 hover:bg-slate-500'
                                                                }`}>
                                                                {f.targetPath === 'index.html' ? '‚úì Replace index.html' : 'Use index.html'}
                                                            </button>
                                                        )}
                                                    </div>
                                                    {willRename && (
                                                        <div className="mt-1.5 text-xs text-green-400 flex items-center gap-1">
                                                            <span>üìù</span> Will replace existing index.html
                                                        </div>
                                                    )}
                                                    {isHtml && f.targetPath !== 'index.html' && f.name !== 'index.html' && (
                                                        <div className="mt-1.5 text-xs text-amber-400 flex items-center gap-1">
                                                            <span>‚ö†Ô∏è</span> Will create new file (won't replace index.html)
                                                        </div>
                                                    )}
                                                    
                                                    {/* Version warnings */}
                                                    {f.versionValidation && !f.versionValidation.isValid && (
                                                        <div className="mt-2 p-2 bg-red-900/30 border border-red-700 rounded">
                                                            <div className="flex items-center justify-between mb-2">
                                                                <div className="text-xs font-medium text-red-300 flex items-center gap-1">
                                                                    üî¥ Version Issues Detected
                                                                </div>
                                                                <button 
                                                                    onClick={async (e) => {
                                                                        e.stopPropagation();
                                                                        let targetVersion = f.version;
                                                                        if (!targetVersion) {
                                                                            targetVersion = await showPrompt(
                                                                                'What version should all version strings be set to?',
                                                                                '1.0.0',
                                                                                'Enter Target Version'
                                                                            );
                                                                        }
                                                                        if (targetVersion) {
                                                                            const fixedContent = fixVersionsInContent(f.content, targetVersion);
                                                                            const newValidation = validateVersions(fixedContent, f.name);
                                                                            onUpdateStagedFile(f.id, { 
                                                                                content: fixedContent,
                                                                                version: targetVersion,
                                                                                versionValidation: newValidation
                                                                            });
                                                                        }
                                                                    }}
                                                                    className="px-2 py-1 bg-green-700 hover:bg-green-600 text-xs rounded flex items-center gap-1">
                                                                    üîß Fix to v{f.version || '?'}
                                                                </button>
                                                            </div>
                                                            
                                                            {f.versionValidation.missing.length > 0 && (
                                                                <div className="text-xs text-amber-300 mb-1">
                                                                    Missing: {f.versionValidation.missing.join(', ')}
                                                                </div>
                                                            )}
                                                            
                                                            {f.versionValidation.uniqueVersions.length > 1 && (
                                                                <div className="text-xs text-red-300 mb-1">
                                                                    Found {f.versionValidation.uniqueVersions.length} different versions: {f.versionValidation.uniqueVersions.join(', ')}
                                                                </div>
                                                            )}
                                                            
                                                            <div className="text-xs text-slate-400 space-y-0.5 max-h-24 overflow-auto">
                                                                {f.versionValidation.allVersions.map((v, i) => (
                                                                    <div key={i} className={v.value === f.versionValidation.primary ? 'text-green-400' : 'text-red-300'}>
                                                                        {v.value} ‚Üê {v.source} (line {v.line})
                                                                    </div>
                                                                ))}
                                                            </div>
                                                        </div>
                                                    )}
                                                    
                                                    {f.versionValidation && f.versionValidation.isValid && (
                                                        <div className="mt-2 text-xs text-green-400 flex items-center gap-1">
                                                            ‚úì All {f.versionValidation.allVersions.length} version strings match (v{f.versionValidation.primary})
                                                        </div>
                                                    )}
                                                </div>
                                            </div>
                                            <button onClick={e => { 
                                                e.stopPropagation(); 
                                                setSelectedFileIds(prev => {
                                                    const newSet = new Set(prev);
                                                    newSet.delete(f.id);
                                                    return newSet;
                                                });
                                                onRemove(f.id); 
                                            }} className="px-2 py-1 text-slate-400 hover:text-white hover:bg-red-600 rounded self-start flex items-center gap-1 transition-colors" title="Remove file">
                                                <Icons.X /> <span className="text-xs">Remove</span>
                                            </button>
                                        </div>
                                    </div>
                                    );
                                })}
                            </div>
                        </div>
                    )}
                    
                    {/* Active Deployment */}
                    {activeDeployment && (
                        <div className={`bg-slate-800 rounded-xl border p-6 ${
                            activeDeployment.status === 'running' ? 'border-indigo-500' :
                            activeDeployment.status === 'success' ? 'border-green-500' : 'border-red-500'
                        }`}>
                            <h2 className="text-lg font-semibold mb-4 flex items-center gap-2">
                                {activeDeployment.status === 'running' ? (
                                    <div className="w-4 h-4 border-2 border-indigo-500 border-t-transparent rounded-full animate-spin" />
                                ) : activeDeployment.status === 'success' ? (
                                    <span className="text-green-400">‚úì</span>
                                ) : (
                                    <span className="text-red-400">‚úó</span>
                                )}
                                {activeDeployment.status === 'running' 
                                    ? (activeDeployment.isRollback ? 'Rolling back' : activeDeployment.isPromotion ? 'Promoting' : 'Deploying') + '...'
                                    : activeDeployment.status === 'success' ? 'Complete!' : 'Failed'
                                }
                                {activeDeployment.fileCount && <span className="text-sm text-slate-400">({activeDeployment.fileCount} files)</span>}
                                <span className="flex-1" />
                                {activeDeployment.status !== 'running' && (
                                    <button onClick={() => setActiveDeployment(null)} className="text-slate-400 hover:text-white">
                                        <Icons.X />
                                    </button>
                                )}
                            </h2>
                            <div className="space-y-2">
                                {activeDeployment.steps.map((s, i) => (
                                    <div key={i} className="flex items-center gap-2">
                                        <div className={`w-5 h-5 rounded-full flex items-center justify-center text-xs ${
                                            s.status === 'complete' ? 'bg-green-500' :
                                            s.status === 'running' ? 'bg-indigo-500' :
                                            s.status === 'error' ? 'bg-red-500' : 'bg-amber-500'
                                        }`}>
                                            {s.status === 'complete' ? '‚úì' : s.status === 'running' ? '‚Ä¢' : '!'}
                                        </div>
                                        <span className={s.status === 'error' ? 'text-red-400' : ''}>{s.name}</span>
                                        {s.details && <span className="text-slate-500 text-sm">({s.details})</span>}
                                    </div>
                                ))}
                            </div>
                            {activeDeployment.status === 'success' && activeDeployment.url && (
                                <a href={activeDeployment.url} target="_blank" className="mt-3 inline-flex items-center gap-1 text-indigo-400 hover:underline">
                                    <Icons.ExternalLink /> Open Site
                                </a>
                            )}
                        </div>
                    )}
                </div>
                
                {/* Right Column - Pipeline */}
                <div className="space-y-6">
                    <div className="bg-slate-800 rounded-xl border border-slate-700 p-4">
                        <h3 className="font-semibold mb-3 flex items-center gap-2">
                            <Icons.Shield className="text-green-400" /> Pipeline
                            {refreshing && <div className="w-3 h-3 border border-indigo-400 border-t-transparent rounded-full animate-spin" />}
                        </h3>
                        <div className="space-y-3">
                            {configuredApps.map(app => {
                                const canPromote = app.testRepo && app.prodRepo && app.currentTestVersion && app.currentTestVersion !== app.currentProdVersion;
                                const testUrl = getGitHubPagesUrl(app.testRepo, app.subPath);
                                const prodUrl = getGitHubPagesUrl(app.prodRepo, app.subPath);
                                const testDeploying = deployingRepos && deployingRepos[app.testRepo];
                                const prodDeploying = deployingRepos && deployingRepos[app.prodRepo];
                                const isExpanded = expandedApps[app.id];
                                const info = appInfo[app.id];
                                const isLoadingInfo = loadingAppInfo[app.id];
                                
                                return (
                                    <div key={app.id} className="bg-slate-700/50 rounded-lg overflow-hidden">
                                        {/* Header - clickable to expand */}
                                        <div 
                                            className="p-3 cursor-pointer hover:bg-slate-700/70"
                                            onClick={() => toggleAppExpanded(app.id)}
                                        >
                                            <div className="flex items-center gap-2 mb-2">
                                                <span className={`transform transition-transform ${isExpanded ? 'rotate-90' : ''}`}>‚ñ∂</span>
                                                <AppIcon icon={app.icon} size={20} />
                                                <span className="font-medium flex-1">{app.name}</span>
                                                {canPromote && (
                                                    <button onClick={(e) => { e.stopPropagation(); onPromote(app.id); }}
                                                        className="px-2 py-1 bg-amber-600 text-xs rounded flex items-center gap-1">
                                                        <Icons.Zap className="w-3 h-3" /> Promote
                                                    </button>
                                                )}
                                            </div>
                                            {/* Show mapped repos */}
                                            <div className="text-xs text-slate-500 mb-2 font-mono ml-6">
                                                {app.testRepo ? app.testRepo.split('/')[1] : '(no test repo)'} ‚Üí {app.prodRepo ? app.prodRepo.split('/')[1] : '(no prod repo)'}
                                            </div>
                                            <div className="flex items-center gap-2 text-xs ml-6">
                                                <div className="flex items-center gap-1">
                                                    <span className={`px-2 py-0.5 rounded ${app.currentTestVersion ? 'bg-blue-900/50 text-blue-300' : 'bg-slate-600 text-slate-400'}`}>
                                                        TEST: {formatVersion(app.currentTestVersion)}
                                                    </span>
                                                    {testUrl && (
                                                        <a href={testUrl} target="_blank" 
                                                            onClick={e => e.stopPropagation()}
                                                            className={`p-1 rounded flex items-center ${testDeploying ? 'bg-red-900/50 text-red-400 animate-pulse' : 'hover:bg-slate-600 text-slate-400'}`} 
                                                            title={testDeploying ? `Deploying v${testDeploying.version}...` : 'Open TEST'}>
                                                            <Icons.Play />
                                                        </a>
                                                    )}
                                                </div>
                                                <Icons.ArrowRight className="w-4 h-4 text-slate-500" />
                                                <div className="flex items-center gap-1">
                                                    <span className={`px-2 py-0.5 rounded ${app.currentProdVersion ? 'bg-green-900/50 text-green-300' : 'bg-slate-600 text-slate-400'}`}>
                                                        PROD: {formatVersion(app.currentProdVersion)}
                                                    </span>
                                                    {prodUrl && (
                                                        <a href={prodUrl} target="_blank" 
                                                            onClick={e => e.stopPropagation()}
                                                            className={`p-1 rounded flex items-center ${prodDeploying ? 'bg-red-900/50 text-red-400 animate-pulse' : 'hover:bg-slate-600 text-slate-400'}`} 
                                                            title={prodDeploying ? `Deploying v${prodDeploying.version}...` : 'Open PROD'}>
                                                            <Icons.Play />
                                                        </a>
                                                    )}
                                                </div>
                                            </div>
                                        </div>
                                        
                                        {/* Expanded Menu */}
                                        {isExpanded && (
                                            <div className="border-t border-slate-600 bg-slate-800/50 p-3 space-y-3">
                                                {isLoadingInfo ? (
                                                    <div className="flex items-center gap-2 text-slate-400 text-sm">
                                                        <div className="w-4 h-4 border-2 border-indigo-400 border-t-transparent rounded-full animate-spin" />
                                                        Loading...
                                                    </div>
                                                ) : (
                                                    <>
                                                        {/* TEST Environment */}
                                                        {app.testRepo && (
                                                            <div className="p-2 bg-blue-900/20 rounded border border-blue-800/50">
                                                                <div className="flex items-center justify-between mb-2">
                                                                    <span className="text-sm font-medium text-blue-300">üß™ TEST Environment</span>
                                                                    <button 
                                                                        onClick={() => forceRebuild(app.testRepo, 'test')}
                                                                        className="px-2 py-1 bg-blue-700 hover:bg-blue-600 text-xs rounded">
                                                                        üîÑ Force Rebuild
                                                                    </button>
                                                                </div>
                                                                {info?.test ? (
                                                                    <div className="text-xs space-y-1">
                                                                        <div className="flex justify-between">
                                                                            <span className="text-slate-400">Last push:</span>
                                                                            <span>{formatRelativeTime(info.test.pushedAt)}</span>
                                                                        </div>
                                                                        <div className="flex justify-between">
                                                                            <span className="text-slate-400">Last commit:</span>
                                                                            <span className="font-mono">{info.test.lastCommit?.sha?.substring(0, 7) || '‚Äî'}</span>
                                                                        </div>
                                                                        <div className="text-slate-500 truncate" title={info.test.lastCommit?.commit?.message}>
                                                                            "{info.test.lastCommit?.commit?.message?.substring(0, 40) || '‚Äî'}"
                                                                        </div>
                                                                        {info.test.recentCommits?.length > 1 && (
                                                                            <details className="mt-2">
                                                                                <summary className="cursor-pointer text-slate-400 hover:text-white">
                                                                                    Recent commits ({info.test.recentCommits.length})
                                                                                </summary>
                                                                                <div className="mt-1 space-y-1 pl-2 border-l border-slate-600">
                                                                                    {info.test.recentCommits.slice(0, 5).map((c, i) => (
                                                                                        <div key={i} className="text-slate-400">
                                                                                            <span className="font-mono text-slate-500">{c.sha.substring(0, 7)}</span>
                                                                                            {' '}{c.commit.message.substring(0, 30)}
                                                                                        </div>
                                                                                    ))}
                                                                                </div>
                                                                            </details>
                                                                        )}
                                                                    </div>
                                                                ) : (
                                                                    <div className="text-xs text-slate-500">No data loaded</div>
                                                                )}
                                                            </div>
                                                        )}
                                                        
                                                        {/* PROD Environment */}
                                                        {app.prodRepo && (
                                                            <div className="p-2 bg-green-900/20 rounded border border-green-800/50">
                                                                <div className="flex items-center justify-between mb-2">
                                                                    <span className="text-sm font-medium text-green-300">üöÄ PROD Environment</span>
                                                                    <button 
                                                                        onClick={() => forceRebuild(app.prodRepo, 'prod')}
                                                                        className="px-2 py-1 bg-green-700 hover:bg-green-600 text-xs rounded">
                                                                        üîÑ Force Rebuild
                                                                    </button>
                                                                </div>
                                                                {info?.prod ? (
                                                                    <div className="text-xs space-y-1">
                                                                        <div className="flex justify-between">
                                                                            <span className="text-slate-400">Last push:</span>
                                                                            <span>{formatRelativeTime(info.prod.pushedAt)}</span>
                                                                        </div>
                                                                        <div className="flex justify-between">
                                                                            <span className="text-slate-400">Last commit:</span>
                                                                            <span className="font-mono">{info.prod.lastCommit?.sha?.substring(0, 7) || '‚Äî'}</span>
                                                                        </div>
                                                                        <div className="text-slate-500 truncate" title={info.prod.lastCommit?.commit?.message}>
                                                                            "{info.prod.lastCommit?.commit?.message?.substring(0, 40) || '‚Äî'}"
                                                                        </div>
                                                                        {info.prod.recentCommits?.length > 1 && (
                                                                            <details className="mt-2">
                                                                                <summary className="cursor-pointer text-slate-400 hover:text-white">
                                                                                    Recent commits ({info.prod.recentCommits.length})
                                                                                </summary>
                                                                                <div className="mt-1 space-y-1 pl-2 border-l border-slate-600">
                                                                                    {info.prod.recentCommits.slice(0, 5).map((c, i) => (
                                                                                        <div key={i} className="text-slate-400">
                                                                                            <span className="font-mono text-slate-500">{c.sha.substring(0, 7)}</span>
                                                                                            {' '}{c.commit.message.substring(0, 30)}
                                                                                        </div>
                                                                                    ))}
                                                                                </div>
                                                                            </details>
                                                                        )}
                                                                    </div>
                                                                ) : (
                                                                    <div className="text-xs text-slate-500">No data loaded</div>
                                                                )}
                                                            </div>
                                                        )}
                                                        
                                                        {/* Quick Actions */}
                                                        <div className="flex flex-wrap gap-2 pt-2 border-t border-slate-600">
                                                            {/* Rollback Status Header */}
                                                            {(rollbackSnapshots?.[`${app.id}:test`] || rollbackSnapshots?.[`${app.id}:prod`]) && (
                                                                <div className="w-full text-xs text-slate-400 mb-1 flex items-center gap-2">
                                                                    üì∏ Snapshots available:
                                                                    {rollbackSnapshots?.[`${app.id}:test`] && <span className="text-blue-400">TEST v{rollbackSnapshots[`${app.id}:test`].version}</span>}
                                                                    {rollbackSnapshots?.[`${app.id}:test`] && rollbackSnapshots?.[`${app.id}:prod`] && <span>‚Ä¢</span>}
                                                                    {rollbackSnapshots?.[`${app.id}:prod`] && <span className="text-green-400">PROD v{rollbackSnapshots[`${app.id}:prod`].version}</span>}
                                                                </div>
                                                            )}
                                                            
                                                            {/* Quick Rollback TEST */}
                                                            {rollbackSnapshots?.[`${app.id}:test`] && (
                                                                <button 
                                                                    onClick={() => onQuickRollback(app.id, 'test')}
                                                                    className="px-2 py-1 bg-red-700 hover:bg-red-600 text-xs rounded flex items-center gap-1"
                                                                    title={`Rollback to v${rollbackSnapshots[`${app.id}:test`].version} (saved ${new Date(rollbackSnapshots[`${app.id}:test`].savedAt).toLocaleTimeString()})`}>
                                                                    ‚è™ Rollback TEST to v{rollbackSnapshots[`${app.id}:test`].version}
                                                                </button>
                                                            )}
                                                            
                                                            {/* Quick Rollback PROD */}
                                                            {rollbackSnapshots?.[`${app.id}:prod`] && (
                                                                <button 
                                                                    onClick={() => onQuickRollback(app.id, 'prod')}
                                                                    className="px-2 py-1 bg-red-700 hover:bg-red-600 text-xs rounded flex items-center gap-1"
                                                                    title={`Rollback to v${rollbackSnapshots[`${app.id}:prod`].version} (saved ${new Date(rollbackSnapshots[`${app.id}:prod`].savedAt).toLocaleTimeString()})`}>
                                                                    ‚è™ Rollback PROD to v{rollbackSnapshots[`${app.id}:prod`].version}
                                                                </button>
                                                            )}
                                                            
                                                            {/* Force Propagate TEST ‚Üí PROD */}
                                                            {app.testRepo && app.prodRepo && (
                                                                <button 
                                                                    onClick={() => onPromote(app.id)}
                                                                    className="px-2 py-1 bg-amber-600 hover:bg-amber-500 text-xs rounded flex items-center gap-1">
                                                                    <Icons.Zap className="w-3 h-3" /> Force Propagate TEST ‚Üí PROD
                                                                </button>
                                                            )}
                                                            
                                                            {/* Force Rebuild All */}
                                                            {(app.testRepo || app.prodRepo) && (
                                                                <button 
                                                                    onClick={async () => {
                                                                        const confirmed = await showConfirm(
                                                                            `This will trigger GitHub Pages rebuild for both TEST and PROD environments.`,
                                                                            `Rebuild All for ${app.name}?`
                                                                        );
                                                                        if (!confirmed) return;
                                                                        
                                                                        if (app.testRepo) await forceRebuild(app.testRepo, 'test', true);
                                                                        if (app.prodRepo) await forceRebuild(app.prodRepo, 'prod', true);
                                                                        
                                                                        await showAlert(
                                                                            `GitHub Pages should update in 30-90 seconds.`,
                                                                            `‚úì Rebuild Triggered for ${app.name}`
                                                                        );
                                                                    }}
                                                                    className="px-2 py-1 bg-indigo-600 hover:bg-indigo-500 text-xs rounded flex items-center gap-1">
                                                                    üîÑ Rebuild All
                                                                </button>
                                                            )}
                                                            
                                                            {app.testRepo && (
                                                                <a href={`https://github.com/${app.testRepo}`} target="_blank"
                                                                    className="px-2 py-1 bg-slate-700 hover:bg-slate-600 text-xs rounded flex items-center gap-1">
                                                                    <Icons.ExternalLink className="w-3 h-3" /> TEST Repo
                                                                </a>
                                                            )}
                                                            {app.prodRepo && (
                                                                <a href={`https://github.com/${app.prodRepo}`} target="_blank"
                                                                    className="px-2 py-1 bg-slate-700 hover:bg-slate-600 text-xs rounded flex items-center gap-1">
                                                                    <Icons.ExternalLink className="w-3 h-3" /> PROD Repo
                                                                </a>
                                                            )}
                                                            <button 
                                                                onClick={() => fetchAppInfo(app.id)}
                                                                className="px-2 py-1 bg-slate-700 hover:bg-slate-600 text-xs rounded flex items-center gap-1">
                                                                <Icons.Refresh className="w-3 h-3" /> Refresh Info
                                                            </button>
                                                        </div>
                                                    </>
                                                )}
                                            </div>
                                        )}
                                    </div>
                                );
                            })}
                            {configuredApps.length === 0 && <div className="text-slate-400 text-sm">Add token in Settings</div>}
                        </div>
                    </div>
                    
                    {/* Issues Summary Widget */}
                    {globalIssues.length > 0 && (
                        <div className="bg-slate-800 rounded-xl border border-slate-700 p-4">
                            <h3 className="font-semibold mb-3 flex items-center gap-2">
                                <Icons.AlertCircle className="text-red-400" /> Issues
                                <button 
                                    onClick={() => setView('issues')}
                                    className="ml-auto text-xs text-indigo-400 hover:text-indigo-300">
                                    View All ‚Üí
                                </button>
                            </h3>
                            <div className="grid grid-cols-4 gap-2 text-center mb-3">
                                <div className="bg-red-900/30 rounded p-2">
                                    <div className="text-lg font-bold text-red-400">
                                        {globalIssues.filter(i => i.status === 'open').length}
                                    </div>
                                    <div className="text-xs text-slate-400">Open</div>
                                </div>
                                <div className="bg-yellow-900/30 rounded p-2">
                                    <div className="text-lg font-bold text-yellow-400">
                                        {globalIssues.filter(i => i.status === 'in-progress').length}
                                    </div>
                                    <div className="text-xs text-slate-400">WIP</div>
                                </div>
                                <div className="bg-blue-900/30 rounded p-2">
                                    <div className="text-lg font-bold text-blue-400">
                                        {globalIssues.filter(i => i.status === 'fixed').length}
                                    </div>
                                    <div className="text-xs text-slate-400">Fixed</div>
                                </div>
                                <div className="bg-green-900/30 rounded p-2">
                                    <div className="text-lg font-bold text-green-400">
                                        {globalIssues.filter(i => i.status === 'verified').length}
                                    </div>
                                    <div className="text-xs text-slate-400">Verified</div>
                                </div>
                            </div>
                            {/* Recent open issues */}
                            <div className="space-y-1">
                                {globalIssues
                                    .filter(i => i.status === 'open' || i.status === 'in-progress')
                                    .slice(0, 3)
                                    .map(issue => (
                                        <div key={issue.id} className="flex items-center gap-2 text-sm p-2 bg-slate-700/50 rounded">
                                            <span className="font-mono text-xs text-indigo-400">{issue.id}</span>
                                            <span className="flex-1 truncate">{issue.title}</span>
                                            <span className={`w-2 h-2 rounded-full ${
                                                issue.status === 'open' ? 'bg-red-500' : 'bg-yellow-500'
                                            }`} />
                                        </div>
                                    ))
                                }
                            </div>
                        </div>
                    )}
                </div>
            </div>
        );
    }

    // =========================================================================
    // REPO FILES VIEW
    // =========================================================================
    
    function RepoFilesView({ apps, github, repoFiles, onLoadRepo, selectedRepo, onSelectRepo, markedForDeletion, setMarkedForDeletion, onDeleteMarked, showAlert }) {
        const configuredApps = Object.values(apps).filter(a => a.testRepo || a.prodRepo);
        const allRepos = [...new Set(configuredApps.flatMap(a => [a.testRepo, a.prodRepo].filter(Boolean)))];
        
        const currentFiles = repoFiles[selectedRepo]?.files || [];
        const isLoading = repoFiles[selectedRepo]?.loading;
        
        const [versionAudit, setVersionAudit] = React.useState(null);
        
        const toggleMarkForDeletion = (file) => {
            const existing = markedForDeletion.find(m => m.repo === selectedRepo && m.path === file.path);
            if (existing) {
                setMarkedForDeletion(prev => prev.filter(m => !(m.repo === selectedRepo && m.path === file.path)));
            } else {
                setMarkedForDeletion(prev => [...prev, { repo: selectedRepo, path: file.path, sha: file.sha, name: file.name }]);
            }
        };
        
        const isMarked = (file) => markedForDeletion.some(m => m.repo === selectedRepo && m.path === file.path);
        
        // Download file to user's Downloads folder
        const downloadFile = async (file) => {
            try {
                // Fetch the raw file content
                const response = await fetch(file.download_url);
                const blob = await response.blob();
                
                // Create download link
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = file.name; // Forces download with filename
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
            } catch (err) {
                console.error('Download failed:', err);
                showAlert('Download failed: ' + err.message, 'Download Error');
            }
        };
        
        // Download entire repo as deploy package zip
        const [downloadingPackage, setDownloadingPackage] = React.useState(false);
        
        const downloadDeployPackage = async () => {
            if (!selectedRepo || !github) return;
            
            setDownloadingPackage(true);
            try {
                // Get app info for naming
                const app = configuredApps.find(a => a.testRepo === selectedRepo || a.prodRepo === selectedRepo);
                const repoName = selectedRepo.split('/')[1];
                
                // WHITELIST: Only include files that belong in deploy packages
                // Based on gs-active skill deploy structure
                const deployFiles = [
                    'index.html',
                    'sw.js',
                    'manifest.json',
                    'manifest-test.json',  // Test environment manifest
                    'RELEASE_NOTES.txt'  // Optional but include if present
                ];
                
                // Valid icon files for deploy packages
                const validIcons = [
                    'icon-72.png', 'icon-96.png', 'icon-128.png', 'icon-144.png',
                    'icon-152.png', 'icon-192.png', 'icon-384.png', 'icon-512.png',
                    'icon-maskable-192.png', 'icon-maskable-512.png',
                    'icon-source.svg', 'apple-touch-icon.png'
                ];
                
                // Check if a file should be included in deploy package
                const shouldInclude = (path) => {
                    const filename = path.split('/').pop();
                    // Root level deploy files
                    if (deployFiles.includes(filename) && !path.includes('/')) return true;
                    // Icons folder files (both prod and test)
                    if ((path.startsWith('icons/') || path.startsWith('icons-test/')) && validIcons.includes(filename)) return true;
                    return false;
                };
                
                // Fetch repo contents
                const fetchAllFiles = async (path = '') => {
                    const contents = await github.listRepoContents(selectedRepo, path);
                    let files = [];
                    
                    for (const item of contents) {
                        if (item.type === 'file') {
                            // Only include whitelisted deploy files
                            if (shouldInclude(item.path)) {
                                files.push(item);
                            }
                        } else if (item.type === 'dir' && (item.name === 'icons' || item.name === 'icons-test')) {
                            // Recurse into icons and icons-test folders
                            const subFiles = await fetchAllFiles(item.path);
                            files = files.concat(subFiles);
                        }
                    }
                    return files;
                };
                
                const allFiles = await fetchAllFiles();
                
                // Get version from index.html if present
                let version = 'unknown';
                const indexFile = allFiles.find(f => f.name === 'index.html');
                if (indexFile) {
                    try {
                        // For large files (>1MB), GitHub API doesn't return content
                        // Use download_url instead which always works
                        const response = await fetch(indexFile.download_url);
                        const content = await response.text();
                        version = extractVersionFromHTML(content) || 'unknown';
                    } catch (e) {
                        console.warn('Could not extract version:', e);
                    }
                }
                
                // Determine folder name for zip structure: {app}-latest/
                // Strip 'test' suffix if present to get base app name
                let appName = repoName.replace(/test$/i, '');
                const folderName = `${appName}-latest`;
                
                // Create zip with proper structure: {app}-latest/{files}
                const zip = new JSZip();
                const folder = zip.folder(folderName);
                
                for (const file of allFiles) {
                    try {
                        const response = await fetch(file.download_url);
                        const blob = await response.blob();
                        // Add to folder with same relative path
                        folder.file(file.path, blob);
                    } catch (e) {
                        console.warn(`Failed to fetch ${file.path}:`, e);
                    }
                }
                
                // Generate zip and download
                const versionStr = version.replace(/\./g, '_');
                const filename = `${appName}-deploy-v${versionStr}.zip`;
                
                const content = await zip.generateAsync({ type: 'blob' });
                const url = URL.createObjectURL(content);
                const a = document.createElement('a');
                a.href = url;
                a.download = filename;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                
                setDownloadingPackage(false);
                
                // Show what was included
                const includedFiles = allFiles.map(f => f.path).join(', ');
                console.log(`Deploy package created: ${filename}`);
                console.log(`Included files: ${includedFiles}`);
                
            } catch (err) {
                console.error('Deploy package download failed:', err);
                showAlert('Deploy package download failed: ' + err.message, 'Download Error');
                setDownloadingPackage(false);
            }
        };
        
        const handleVersionAudit = async () => {
            if (!github || !selectedRepo) return;
            setVersionAudit({ loading: true });
            
            try {
                const fileData = await github.getFileContent(selectedRepo, 'index.html');
                if (fileData) {
                    // Use textContent which handles both normal and large files
                    const content = fileData.textContent;
                    const versions = findAllVersionStrings(content);
                    const primary = extractVersionFromHTML(content);
                    
                    // Check for mismatches
                    const uniqueVersions = [...new Set(versions.map(v => v.value))];
                    const hasMismatch = uniqueVersions.length > 1;
                    
                    setVersionAudit({ loading: false, versions, primary, hasMismatch, uniqueVersions });
                } else {
                    setVersionAudit({ loading: false, error: 'index.html not found' });
                }
            } catch (e) {
                setVersionAudit({ loading: false, error: e.message });
            }
        };
        
        return (
            <div className="space-y-6">
                <div className="bg-slate-800 rounded-xl border border-slate-700 p-6">
                    <h2 className="text-lg font-semibold mb-4 flex items-center gap-2">
                        <Icons.Folder /> Repository Files
                    </h2>
                    
                    <div className="flex gap-4 mb-4">
                        <select value={selectedRepo || ''} onChange={e => { onSelectRepo(e.target.value); if (e.target.value) onLoadRepo(e.target.value); }}
                            className="flex-1 p-2 bg-slate-700 border border-slate-600 rounded">
                            <option value="">Select repository...</option>
                            {allRepos.map(r => {
                                const app = configuredApps.find(a => a.testRepo === r || a.prodRepo === r);
                                const isTest = app?.testRepo === r;
                                return <option key={r} value={r}>{getAppEmoji(app?.icon)} {r.split('/')[1]} ({isTest ? 'TEST' : 'PROD'})</option>;
                            })}
                        </select>
                        
                        {selectedRepo && (
                            <button onClick={() => onLoadRepo(selectedRepo)} className="px-4 py-2 bg-slate-700 rounded flex items-center gap-2">
                                <Icons.Refresh className={isLoading ? 'animate-spin' : ''} /> Refresh
                            </button>
                        )}
                    </div>
                    
                    {selectedRepo && (
                        <div className="flex gap-2 mb-4 flex-wrap">
                            <a href={getGitHubPagesUrl(selectedRepo)} target="_blank" 
                                className="px-3 py-1.5 bg-indigo-600 rounded text-sm flex items-center gap-1">
                                <Icons.Play /> Open Site
                            </a>
                            <a href={`https://github.com/${selectedRepo}`} target="_blank"
                                className="px-3 py-1.5 bg-slate-700 rounded text-sm flex items-center gap-1">
                                <Icons.ExternalLink /> GitHub
                            </a>
                            <button onClick={handleVersionAudit}
                                className="px-3 py-1.5 bg-amber-700 rounded text-sm flex items-center gap-1">
                                üîç Version Audit
                            </button>
                            <button onClick={downloadDeployPackage} disabled={downloadingPackage}
                                className="px-3 py-1.5 bg-green-700 hover:bg-green-600 disabled:bg-green-900 disabled:cursor-wait rounded text-sm flex items-center gap-1">
                                {downloadingPackage ? (
                                    <><div className="w-3 h-3 border-2 border-white border-t-transparent rounded-full animate-spin" /> Creating...</>
                                ) : (
                                    <><Icons.Download /> Download Package</>
                                )}
                            </button>
                        </div>
                    )}
                    
                    {/* Version Audit Results */}
                    {versionAudit && (
                        <div className={`mb-4 p-4 rounded-lg border ${versionAudit.hasMismatch ? 'bg-red-900/30 border-red-700' : 'bg-slate-700/50 border-slate-600'}`}>
                            <div className="flex items-center justify-between mb-3">
                                <h3 className="font-semibold flex items-center gap-2">
                                    {versionAudit.loading ? (
                                        <>
                                            <div className="w-4 h-4 border-2 border-amber-400 border-t-transparent rounded-full animate-spin" />
                                            Scanning...
                                        </>
                                    ) : versionAudit.hasMismatch ? (
                                        <><span className="text-red-400">‚ö†Ô∏è Version Mismatch Found!</span></>
                                    ) : (
                                        <><span className="text-green-400">‚úì Versions Consistent</span></>
                                    )}
                                </h3>
                                <button onClick={() => setVersionAudit(null)} className="text-slate-400 hover:text-white">
                                    <Icons.X />
                                </button>
                            </div>
                            
                            {versionAudit.error && (
                                <div className="text-red-400 text-sm">{versionAudit.error}</div>
                            )}
                            
                            {versionAudit.versions && (
                                <>
                                    <div className="text-sm mb-2">
                                        <span className="text-slate-400">Primary version (meta tag): </span>
                                        <span className="font-mono text-green-400">{versionAudit.primary || 'Not found'}</span>
                                    </div>
                                    
                                    {versionAudit.hasMismatch && (
                                        <div className="text-sm mb-2 text-amber-400">
                                            Found {versionAudit.uniqueVersions.length} different versions: {versionAudit.uniqueVersions.join(', ')}
                                        </div>
                                    )}
                                    
                                    <div className="text-xs text-slate-400 mb-2">Found {versionAudit.versions.length} version string(s):</div>
                                    <div className="space-y-1 max-h-48 overflow-auto">
                                        {versionAudit.versions.map((v, i) => (
                                            <div key={i} className={`text-xs p-2 rounded ${v.value === versionAudit.primary ? 'bg-green-900/30' : 'bg-red-900/30'}`}>
                                                <div className="flex items-center gap-2">
                                                    <span className={`font-mono ${v.value === versionAudit.primary ? 'text-green-400' : 'text-red-400'}`}>
                                                        {v.value}
                                                    </span>
                                                    <span className="text-slate-500">‚Üê {v.source}</span>
                                                </div>
                                                <div className="text-slate-500 font-mono truncate mt-1">{v.context}</div>
                                            </div>
                                        ))}
                                    </div>
                                </>
                            )}
                        </div>
                    )}
                    
                    {isLoading && (
                        <div className="text-center py-8 text-slate-400">
                            <div className="w-6 h-6 border-2 border-indigo-500 border-t-transparent rounded-full animate-spin mx-auto mb-2" />
                            Loading files...
                        </div>
                    )}
                    
                    {!isLoading && currentFiles.length > 0 && (
                        <div className="space-y-1">
                            {currentFiles.filter(f => f.type === 'file').map(file => (
                                <div key={file.path} className={`p-2 rounded flex items-center gap-3 ${isMarked(file) ? 'bg-red-900/30 border border-red-700' : 'bg-slate-700/50 hover:bg-slate-700'}`}>
                                    <span>{getFileIcon(file.name)}</span>
                                    <span className="flex-1 font-mono text-sm">{file.name}</span>
                                    <span className="text-xs text-slate-500">{formatBytes(file.size)}</span>
                                    <div className="flex gap-1">
                                        <a href={file.download_url} target="_blank" className="p-1 hover:bg-slate-600 rounded" title="View">
                                            <Icons.Eye />
                                        </a>
                                        <button onClick={() => downloadFile(file)} className="p-1 hover:bg-slate-600 rounded" title="Download">
                                            <Icons.Download />
                                        </button>
                                        <button onClick={() => toggleMarkForDeletion(file)} 
                                            className={`p-1 rounded ${isMarked(file) ? 'bg-red-600 text-white' : 'hover:bg-red-900/50 text-slate-400 hover:text-red-400'}`}
                                            title={isMarked(file) ? 'Unmark' : 'Mark for deletion'}>
                                            <Icons.Trash />
                                        </button>
                                    </div>
                                </div>
                            ))}
                        </div>
                    )}
                    
                    {!isLoading && selectedRepo && currentFiles.length === 0 && (
                        <div className="text-center py-8 text-slate-400">No files found</div>
                    )}
                </div>
                
                {/* Marked for Deletion Panel */}
                {markedForDeletion.length > 0 && (
                    <div className="bg-red-900/20 border border-red-700 rounded-xl p-4">
                        <div className="flex items-center justify-between mb-3">
                            <h3 className="font-semibold text-red-400 flex items-center gap-2">
                                <Icons.Trash /> Marked for Deletion ({markedForDeletion.length})
                            </h3>
                            <div className="flex gap-2">
                                <button onClick={() => setMarkedForDeletion([])} className="px-3 py-1 bg-slate-700 rounded text-sm">
                                    Clear All
                                </button>
                                <button onClick={onDeleteMarked} className="px-3 py-1 bg-red-600 rounded text-sm flex items-center gap-1">
                                    <Icons.Trash /> Delete All
                                </button>
                            </div>
                        </div>
                        <div className="space-y-1">
                            {markedForDeletion.map((item, i) => (
                                <div key={i} className="text-sm flex items-center gap-2 text-slate-300">
                                    <Icons.File /> <span className="text-slate-500">{item.repo.split('/')[1]}/</span>{item.path}
                                </div>
                            ))}
                        </div>
                    </div>
                )}
            </div>
        );
    }

    // =========================================================================
    // INTEGRATIONS VIEW (v7.4.0) - Manage Firebase Functions, Claude API, Stripe, Goody
    // =========================================================================
    
    function IntegrationsView({ showAlert, showConfirm, showPrompt }) {
        const [activeTab, setActiveTab] = React.useState('overview');
        const [integrationStatus, setIntegrationStatus] = React.useState({
            firebase: { status: 'unknown', lastCheck: null },
            claude: { status: 'unknown', lastCheck: null },
            stripe: { status: 'unknown', lastCheck: null },
            goody: { status: 'unknown', lastCheck: null }
        });
        const [functionLogs, setFunctionLogs] = React.useState([]);
        const [hintAnalytics, setHintAnalytics] = React.useState(null);
        const [hintUsage, setHintUsage] = React.useState(null);
        const [purchases, setPurchases] = React.useState(null);
        const [loading, setLoading] = React.useState({});
        const [testResults, setTestResults] = React.useState({});
        
        // Firebase Functions endpoint
        const FUNCTIONS_BASE = 'https://us-central1-word-boxing.cloudfunctions.net';
        
        // Integration definitions
        const integrations = {
            firebase: {
                id: 'firebase',
                name: 'Firebase',
                icon: 'üî•',
                description: 'Realtime Database, Auth, Cloud Functions',
                functions: ['getHint', 'getHintUsage', 'createCoinCheckout', 'stripeWebhook', 'getGiftOptions', 'redeemGift', 'getGiftHistory'],
                configRequired: ['apiKey', 'projectId', 'databaseURL'],
                docsUrl: 'https://console.firebase.google.com/project/word-boxing'
            },
            claude: {
                id: 'claude',
                name: 'Claude API',
                icon: 'ü§ñ',
                description: 'Anthropic AI for hint generation',
                functions: ['getHint'],
                configRequired: ['ANTHROPIC_API_KEY'],
                docsUrl: 'https://console.anthropic.com/'
            },
            stripe: {
                id: 'stripe',
                name: 'Stripe',
                icon: 'üí≥',
                description: 'Payment processing for coins',
                functions: ['createCoinCheckout', 'stripeWebhook'],
                configRequired: ['STRIPE_SECRET_KEY', 'STRIPE_WEBHOOK_SECRET'],
                docsUrl: 'https://dashboard.stripe.com/'
            },
            goody: {
                id: 'goody',
                name: 'Goody',
                icon: 'üéÅ',
                description: 'Gift card redemption (coming soon)',
                functions: ['getGiftOptions', 'redeemGift', 'getGiftHistory'],
                configRequired: ['GOODY_API_KEY'],
                docsUrl: 'https://www.ongoody.com/',
                comingSoon: true
            }
        };
        
        // Check Firebase connection
        const checkFirebase = async () => {
            setLoading(prev => ({ ...prev, firebase: true }));
            try {
                if (!firebaseDb) throw new Error('Firebase not initialized');
                
                // Test read from a public path
                const testRef = firebaseDb.ref('gameshelf-public');
                await testRef.once('value');
                
                setIntegrationStatus(prev => ({
                    ...prev,
                    firebase: { status: 'connected', lastCheck: new Date().toISOString() }
                }));
                setTestResults(prev => ({ ...prev, firebase: { success: true, message: 'Connected to Firebase Realtime Database' } }));
            } catch (e) {
                setIntegrationStatus(prev => ({
                    ...prev,
                    firebase: { status: 'error', lastCheck: new Date().toISOString(), error: e.message }
                }));
                setTestResults(prev => ({ ...prev, firebase: { success: false, message: e.message } }));
            }
            setLoading(prev => ({ ...prev, firebase: false }));
        };
        
        // Check Claude API (via Firebase Function)
        const checkClaude = async () => {
            setLoading(prev => ({ ...prev, claude: true }));
            try {
                // We can't directly test Claude API, but we can check if the function exists
                // by calling getHintUsage which doesn't require auth
                const response = await fetch(`${FUNCTIONS_BASE}/getHintUsage`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ data: { userId: 'test-connection' } })
                });
                
                if (response.ok) {
                    setIntegrationStatus(prev => ({
                        ...prev,
                        claude: { status: 'connected', lastCheck: new Date().toISOString() }
                    }));
                    setTestResults(prev => ({ ...prev, claude: { success: true, message: 'Firebase Functions responding (Claude API configured)' } }));
                } else {
                    throw new Error(`Function returned ${response.status}`);
                }
            } catch (e) {
                setIntegrationStatus(prev => ({
                    ...prev,
                    claude: { status: 'error', lastCheck: new Date().toISOString(), error: e.message }
                }));
                setTestResults(prev => ({ ...prev, claude: { success: false, message: e.message } }));
            }
            setLoading(prev => ({ ...prev, claude: false }));
        };
        
        // Check Stripe (via createCoinCheckout health)
        const checkStripe = async () => {
            setLoading(prev => ({ ...prev, stripe: true }));
            try {
                // Check if we have any purchase records in Firebase
                if (firebaseDb) {
                    const purchasesRef = firebaseDb.ref('purchases');
                    const snapshot = await purchasesRef.limitToLast(5).once('value');
                    const data = snapshot.val();
                    if (data) {
                        setPurchases(data);
                        setIntegrationStatus(prev => ({
                            ...prev,
                            stripe: { status: 'connected', lastCheck: new Date().toISOString() }
                        }));
                        setTestResults(prev => ({ ...prev, stripe: { success: true, message: 'Stripe integration active (purchases found)' } }));
                    } else {
                        setIntegrationStatus(prev => ({
                            ...prev,
                            stripe: { status: 'connected', lastCheck: new Date().toISOString() }
                        }));
                        setTestResults(prev => ({ ...prev, stripe: { success: true, message: 'Stripe configured (no purchases yet)' } }));
                    }
                }
            } catch (e) {
                setIntegrationStatus(prev => ({
                    ...prev,
                    stripe: { status: 'error', lastCheck: new Date().toISOString(), error: e.message }
                }));
                setTestResults(prev => ({ ...prev, stripe: { success: false, message: e.message } }));
            }
            setLoading(prev => ({ ...prev, stripe: false }));
        };
        
        // Load hint analytics
        const loadHintAnalytics = async () => {
            if (!firebaseDb) return;
            setLoading(prev => ({ ...prev, analytics: true }));
            try {
                const analyticsRef = firebaseDb.ref('hint-analytics');
                const snapshot = await analyticsRef.limitToLast(50).once('value');
                setHintAnalytics(snapshot.val());
                
                const usageRef = firebaseDb.ref('hint-usage');
                const usageSnapshot = await usageRef.limitToLast(20).once('value');
                setHintUsage(usageSnapshot.val());
            } catch (e) {
                console.error('Failed to load hint analytics:', e);
            }
            setLoading(prev => ({ ...prev, analytics: false }));
        };
        
        // Test all integrations
        const testAllIntegrations = async () => {
            await checkFirebase();
            await checkClaude();
            await checkStripe();
            await loadHintAnalytics();
        };
        
        // Initial load
        React.useEffect(() => {
            testAllIntegrations();
        }, []);
        
        // Status indicator component
        const StatusIndicator = ({ status }) => {
            const colors = {
                connected: 'bg-green-500',
                error: 'bg-red-500',
                unknown: 'bg-slate-500',
                loading: 'bg-yellow-500 animate-pulse'
            };
            return (
                <div className={`w-3 h-3 rounded-full ${colors[status] || colors.unknown}`} />
            );
        };
        
        // Integration card component
        const IntegrationCard = ({ integration }) => {
            const status = integrationStatus[integration.id];
            const isLoading = loading[integration.id];
            const result = testResults[integration.id];
            
            return (
                <div className={`bg-slate-800 rounded-xl p-5 border ${
                    status?.status === 'connected' ? 'border-green-700' : 
                    status?.status === 'error' ? 'border-red-700' : 'border-slate-700'
                }`}>
                    <div className="flex items-start justify-between mb-3">
                        <div className="flex items-center gap-3">
                            <span className="text-2xl">{integration.icon}</span>
                            <div>
                                <h3 className="font-semibold">{integration.name}</h3>
                                <p className="text-xs text-slate-400">{integration.description}</p>
                            </div>
                        </div>
                        <StatusIndicator status={isLoading ? 'loading' : status?.status} />
                    </div>
                    
                    {integration.comingSoon ? (
                        <div className="text-sm text-amber-400 bg-amber-900/30 rounded px-3 py-2">
                            üöß Coming Soon
                        </div>
                    ) : (
                        <>
                            {result && (
                                <div className={`text-xs mb-3 p-2 rounded ${
                                    result.success ? 'bg-green-900/30 text-green-400' : 'bg-red-900/30 text-red-400'
                                }`}>
                                    {result.success ? '‚úì' : '‚úó'} {result.message}
                                </div>
                            )}
                            
                            <div className="text-xs text-slate-500 mb-3">
                                Functions: {integration.functions.join(', ')}
                            </div>
                            
                            <div className="flex gap-2">
                                <a 
                                    href={integration.docsUrl} 
                                    target="_blank" 
                                    rel="noopener noreferrer"
                                    className="text-xs px-3 py-1.5 bg-slate-700 hover:bg-slate-600 rounded transition-colors"
                                >
                                    üìÑ Console
                                </a>
                                <button
                                    onClick={() => {
                                        if (integration.id === 'firebase') checkFirebase();
                                        else if (integration.id === 'claude') checkClaude();
                                        else if (integration.id === 'stripe') checkStripe();
                                    }}
                                    disabled={isLoading}
                                    className="text-xs px-3 py-1.5 bg-indigo-600 hover:bg-indigo-500 rounded transition-colors disabled:opacity-50"
                                >
                                    {isLoading ? '...' : 'üîÑ Test'}
                                </button>
                            </div>
                        </>
                    )}
                    
                    {status?.lastCheck && (
                        <div className="text-xs text-slate-500 mt-3">
                            Last checked: {new Date(status.lastCheck).toLocaleTimeString()}
                        </div>
                    )}
                </div>
            );
        };
        
        // Logs panel
        const LogsPanel = () => {
            const allLogs = [];
            
            // Convert hint analytics to log entries
            if (hintAnalytics) {
                Object.entries(hintAnalytics).forEach(([key, value]) => {
                    if (typeof value === 'object' && value.timestamp) {
                        allLogs.push({
                            id: key,
                            type: 'hint',
                            timestamp: value.timestamp,
                            data: value
                        });
                    }
                });
            }
            
            // Sort by timestamp descending
            allLogs.sort((a, b) => (b.timestamp || 0) - (a.timestamp || 0));
            
            return (
                <div className="bg-slate-800 rounded-xl p-5 border border-slate-700">
                    <div className="flex items-center justify-between mb-4">
                        <h3 className="font-semibold">üìä Recent Activity</h3>
                        <button
                            onClick={loadHintAnalytics}
                            disabled={loading.analytics}
                            className="text-xs px-3 py-1.5 bg-slate-700 hover:bg-slate-600 rounded"
                        >
                            {loading.analytics ? '...' : 'üîÑ Refresh'}
                        </button>
                    </div>
                    
                    {allLogs.length === 0 ? (
                        <div className="text-sm text-slate-500 text-center py-8">
                            No recent activity logs
                        </div>
                    ) : (
                        <div className="space-y-2 max-h-96 overflow-y-auto">
                            {allLogs.slice(0, 20).map(log => (
                                <div key={log.id} className="text-xs p-2 bg-slate-900 rounded">
                                    <div className="flex items-center justify-between mb-1">
                                        <span className={`font-medium ${
                                            log.type === 'hint' ? 'text-purple-400' :
                                            log.type === 'purchase' ? 'text-green-400' : 'text-slate-400'
                                        }`}>
                                            {log.type === 'hint' ? 'ü§ñ Hint Request' : 
                                             log.type === 'purchase' ? 'üí≥ Purchase' : 'üìù Log'}
                                        </span>
                                        <span className="text-slate-500">
                                            {log.timestamp ? new Date(log.timestamp).toLocaleString() : 'N/A'}
                                        </span>
                                    </div>
                                    {log.data && (
                                        <div className="text-slate-400 truncate">
                                            {log.data.game && `Game: ${log.data.game}`}
                                            {log.data.level && ` | Level: ${log.data.level}`}
                                            {log.data.userId && ` | User: ${log.data.userId.substring(0, 8)}...`}
                                        </div>
                                    )}
                                </div>
                            ))}
                        </div>
                    )}
                </div>
            );
        };
        
        // Usage stats panel
        const UsageStatsPanel = () => {
            const userCount = hintUsage ? Object.keys(hintUsage).length : 0;
            let totalRequests = 0;
            let todayRequests = 0;
            const today = new Date().toDateString();
            
            if (hintUsage) {
                Object.values(hintUsage).forEach(user => {
                    if (user.requests && Array.isArray(user.requests)) {
                        totalRequests += user.requests.length;
                        user.requests.forEach(ts => {
                            if (new Date(ts).toDateString() === today) {
                                todayRequests++;
                            }
                        });
                    }
                });
            }
            
            return (
                <div className="bg-slate-800 rounded-xl p-5 border border-slate-700">
                    <h3 className="font-semibold mb-4">üìà Hint Usage Stats</h3>
                    
                    <div className="grid grid-cols-3 gap-4">
                        <div className="text-center p-3 bg-slate-900 rounded-lg">
                            <div className="text-2xl font-bold text-indigo-400">{userCount}</div>
                            <div className="text-xs text-slate-500">Total Users</div>
                        </div>
                        <div className="text-center p-3 bg-slate-900 rounded-lg">
                            <div className="text-2xl font-bold text-green-400">{totalRequests}</div>
                            <div className="text-xs text-slate-500">Total Hints</div>
                        </div>
                        <div className="text-center p-3 bg-slate-900 rounded-lg">
                            <div className="text-2xl font-bold text-amber-400">{todayRequests}</div>
                            <div className="text-xs text-slate-500">Today</div>
                        </div>
                    </div>
                </div>
            );
        };
        
        // Environment variables panel
        const EnvVarsPanel = () => {
            const envVars = [
                { name: 'ANTHROPIC_API_KEY', service: 'Claude', required: true, hint: 'sk-ant-...' },
                { name: 'STRIPE_SECRET_KEY', service: 'Stripe', required: true, hint: 'sk_live_... or sk_test_...' },
                { name: 'STRIPE_WEBHOOK_SECRET', service: 'Stripe', required: true, hint: 'whsec_...' },
                { name: 'GOODY_API_KEY', service: 'Goody', required: false, hint: 'Optional' }
            ];
            
            return (
                <div className="bg-slate-800 rounded-xl p-5 border border-slate-700">
                    <h3 className="font-semibold mb-4">üîê Environment Variables</h3>
                    <p className="text-xs text-slate-400 mb-4">
                        Set in Firebase Functions: <code className="bg-slate-900 px-1 rounded">~/Documents/.../Games/firebase-functions/functions/.env</code>
                    </p>
                    
                    <div className="space-y-2">
                        {envVars.map(v => (
                            <div key={v.name} className="flex items-center justify-between p-2 bg-slate-900 rounded text-sm">
                                <div>
                                    <code className="text-indigo-400">{v.name}</code>
                                    <span className="text-xs text-slate-500 ml-2">({v.service})</span>
                                </div>
                                <span className={`text-xs px-2 py-0.5 rounded ${
                                    v.required ? 'bg-red-900/50 text-red-400' : 'bg-slate-700 text-slate-400'
                                }`}>
                                    {v.required ? 'Required' : 'Optional'}
                                </span>
                            </div>
                        ))}
                    </div>
                    
                    <div className="mt-4 p-3 bg-slate-900 rounded">
                        <div className="text-xs text-slate-400 mb-2">Deploy functions after updating .env:</div>
                        <code className="text-xs text-green-400 break-all">
                            cd ~/Documents/.../Games/firebase-functions && firebase deploy --only functions
                        </code>
                    </div>
                </div>
            );
        };
        
        return (
            <div className="space-y-6">
                <div className="flex items-center justify-between">
                    <h2 className="text-xl font-bold flex items-center gap-2">
                        <Icons.Zap /> Integrations
                    </h2>
                    <button
                        onClick={testAllIntegrations}
                        className="px-4 py-2 bg-indigo-600 hover:bg-indigo-500 rounded-lg text-sm font-medium transition-colors"
                    >
                        üîÑ Test All
                    </button>
                </div>
                
                {/* Tab Navigation */}
                <div className="flex gap-2 border-b border-slate-700 pb-2">
                    {[
                        { id: 'overview', label: 'üìä Overview' },
                        { id: 'logs', label: 'üìù Logs' },
                        { id: 'config', label: '‚öôÔ∏è Configuration' }
                    ].map(tab => (
                        <button
                            key={tab.id}
                            onClick={() => setActiveTab(tab.id)}
                            className={`px-4 py-2 rounded-t-lg font-medium transition-colors ${
                                activeTab === tab.id 
                                    ? 'bg-slate-700 text-white' 
                                    : 'text-slate-400 hover:text-white hover:bg-slate-800'
                            }`}
                        >
                            {tab.label}
                        </button>
                    ))}
                </div>
                
                {/* Overview Tab */}
                {activeTab === 'overview' && (
                    <div className="space-y-6">
                        {/* Integration Cards */}
                        <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                            {Object.values(integrations).map(integration => (
                                <IntegrationCard key={integration.id} integration={integration} />
                            ))}
                        </div>
                        
                        {/* Usage Stats */}
                        <UsageStatsPanel />
                    </div>
                )}
                
                {/* Logs Tab */}
                {activeTab === 'logs' && (
                    <div className="space-y-6">
                        <LogsPanel />
                        
                        {/* Hint Usage by User */}
                        {hintUsage && (
                            <div className="bg-slate-800 rounded-xl p-5 border border-slate-700">
                                <h3 className="font-semibold mb-4">üë• Hint Usage by User</h3>
                                <div className="space-y-2 max-h-64 overflow-y-auto">
                                    {Object.entries(hintUsage).map(([userId, data]) => (
                                        <div key={userId} className="flex items-center justify-between p-2 bg-slate-900 rounded text-sm">
                                            <code className="text-xs text-slate-400">{userId.substring(0, 12)}...</code>
                                            <span className="text-indigo-400">
                                                {data.requests?.length || 0} hints
                                            </span>
                                        </div>
                                    ))}
                                </div>
                            </div>
                        )}
                        
                        {/* Recent Purchases */}
                        {purchases && (
                            <div className="bg-slate-800 rounded-xl p-5 border border-slate-700">
                                <h3 className="font-semibold mb-4">üí≥ Recent Purchases</h3>
                                <div className="space-y-2 max-h-64 overflow-y-auto">
                                    {Object.entries(purchases).slice(0, 10).map(([userId, userPurchases]) => (
                                        <div key={userId} className="p-2 bg-slate-900 rounded">
                                            <code className="text-xs text-slate-400">{userId.substring(0, 12)}...</code>
                                            {Object.entries(userPurchases).map(([purchaseId, purchase]) => (
                                                <div key={purchaseId} className="mt-1 text-xs text-green-400">
                                                    {purchase.coinAmount} coins - ${(purchase.priceCents / 100).toFixed(2)}
                                                </div>
                                            ))}
                                        </div>
                                    ))}
                                </div>
                            </div>
                        )}
                    </div>
                )}
                
                {/* Configuration Tab */}
                {activeTab === 'config' && (
                    <div className="space-y-6">
                        <EnvVarsPanel />
                        
                        {/* Firebase Functions List */}
                        <div className="bg-slate-800 rounded-xl p-5 border border-slate-700">
                            <h3 className="font-semibold mb-4">‚òÅÔ∏è Firebase Cloud Functions</h3>
                            <p className="text-xs text-slate-400 mb-4">
                                Project: <code className="bg-slate-900 px-1 rounded">word-boxing</code> | 
                                Region: <code className="bg-slate-900 px-1 rounded">us-central1</code>
                            </p>
                            
                            <div className="grid grid-cols-1 md:grid-cols-2 gap-3">
                                {[
                                    { name: 'getHint', desc: 'AI hint generation via Claude', type: 'callable' },
                                    { name: 'getHintUsage', desc: 'Check user hint limits', type: 'callable' },
                                    { name: 'createCoinCheckout', desc: 'Stripe checkout session', type: 'callable' },
                                    { name: 'stripeWebhook', desc: 'Handle Stripe events', type: 'http' },
                                    { name: 'getGiftOptions', desc: 'Goody gift tiers', type: 'callable' },
                                    { name: 'redeemGift', desc: 'Redeem coins for gift', type: 'callable' },
                                    { name: 'getGiftHistory', desc: 'Gift redemption history', type: 'callable' }
                                ].map(fn => (
                                    <div key={fn.name} className="p-3 bg-slate-900 rounded">
                                        <div className="flex items-center justify-between">
                                            <code className="text-sm text-indigo-400">{fn.name}</code>
                                            <span className={`text-xs px-2 py-0.5 rounded ${
                                                fn.type === 'http' ? 'bg-amber-900/50 text-amber-400' : 'bg-slate-700 text-slate-400'
                                            }`}>
                                                {fn.type}
                                            </span>
                                        </div>
                                        <div className="text-xs text-slate-500 mt-1">{fn.desc}</div>
                                    </div>
                                ))}
                            </div>
                        </div>
                        
                        {/* Quick Actions */}
                        <div className="bg-slate-800 rounded-xl p-5 border border-slate-700">
                            <h3 className="font-semibold mb-4">üöÄ Quick Actions</h3>
                            <div className="flex flex-wrap gap-3">
                                <a 
                                    href="https://console.firebase.google.com/project/word-boxing/functions"
                                    target="_blank"
                                    rel="noopener noreferrer"
                                    className="px-4 py-2 bg-amber-600 hover:bg-amber-500 rounded-lg text-sm font-medium transition-colors"
                                >
                                    üî• Firebase Console
                                </a>
                                <a 
                                    href="https://console.firebase.google.com/project/word-boxing/functions/logs"
                                    target="_blank"
                                    rel="noopener noreferrer"
                                    className="px-4 py-2 bg-slate-700 hover:bg-slate-600 rounded-lg text-sm font-medium transition-colors"
                                >
                                    üìã Function Logs
                                </a>
                                <a 
                                    href="https://dashboard.stripe.com/test/webhooks"
                                    target="_blank"
                                    rel="noopener noreferrer"
                                    className="px-4 py-2 bg-purple-600 hover:bg-purple-500 rounded-lg text-sm font-medium transition-colors"
                                >
                                    üí≥ Stripe Webhooks
                                </a>
                                <a 
                                    href="https://console.anthropic.com/"
                                    target="_blank"
                                    rel="noopener noreferrer"
                                    className="px-4 py-2 bg-indigo-600 hover:bg-indigo-500 rounded-lg text-sm font-medium transition-colors"
                                >
                                    ü§ñ Anthropic Console
                                </a>
                            </div>
                        </div>
                        
                        {/* Deployment Instructions */}
                        <div className="bg-slate-800 rounded-xl p-5 border border-slate-700">
                            <h3 className="font-semibold mb-4">üì¶ Deploy Functions</h3>
                            <div className="bg-slate-900 rounded p-4 font-mono text-sm">
                                <div className="text-slate-500"># Navigate to functions directory</div>
                                <div className="text-green-400">cd ~/Documents/Documents\ -\ David\'s\ MacBook\ Air/Games/firebase-functions</div>
                                <div className="text-slate-500 mt-2"># Set project</div>
                                <div className="text-green-400">firebase use word-boxing</div>
                                <div className="text-slate-500 mt-2"># Deploy all functions</div>
                                <div className="text-green-400">firebase deploy --only functions</div>
                                <div className="text-slate-500 mt-2"># Or deploy specific function</div>
                                <div className="text-green-400">firebase deploy --only functions:getHint</div>
                            </div>
                        </div>
                    </div>
                )}
            </div>
        );
    }

    // =========================================================================
    // CLEANUP VIEW (v7.4.3) - Repo and File Cleanup Management with Rollback
    // =========================================================================
    
    function CleanupView({ github, config, apps, availableRepos, showAlert, showConfirm }) {
        const [activeTab, setActiveTab] = React.useState('files');
        const [scanning, setScanning] = React.useState(false);
        const [scanResults, setScanResults] = React.useState(null);
        const [selectedFiles, setSelectedFiles] = React.useState(new Set());
        const [selectedRepos, setSelectedRepos] = React.useState(new Set());
        const [deleting, setDeleting] = React.useState(false);
        const [deleteProgress, setDeleteProgress] = React.useState({ current: 0, total: 0 });
        const [restoring, setRestoring] = React.useState(false);
        
        // Deletion history - persisted to localStorage
        const [deletionHistory, setDeletionHistory] = React.useState(() => {
            try {
                return JSON.parse(localStorage.getItem('cc_deletion_history') || '[]');
            } catch { return []; }
        });
        
        // Save deletion history to localStorage
        const saveDeletionHistory = (history) => {
            setDeletionHistory(history);
            try {
                localStorage.setItem('cc_deletion_history', JSON.stringify(history));
            } catch (e) {
                console.error('Failed to save deletion history:', e);
            }
        };
        
        // Add to deletion history
        const addToDeletionHistory = (items) => {
            const newHistory = [
                ...items.map(item => ({
                    ...item,
                    deletedAt: new Date().toISOString(),
                    id: `${item.repo}:${item.path}:${Date.now()}`
                })),
                ...deletionHistory
            ].slice(0, 100); // Keep last 100 deletions
            saveDeletionHistory(newHistory);
        };
        
        // Remove from deletion history
        const removeFromHistory = (id) => {
            const newHistory = deletionHistory.filter(h => h.id !== id);
            saveDeletionHistory(newHistory);
        };
        
        // Clear all history
        const clearHistory = async () => {
            const confirmed = await showConfirm('Clear all deletion history? This only removes the history log, not the actual files.', 'Clear History');
            if (confirmed) {
                saveDeletionHistory([]);
            }
        };
        
        // Define base package files for each app type
        const BASE_PACKAGES = {
            pwa: {
                required: ['index.html', 'sw.js', 'manifest.json'],
                optional: ['RELEASE_NOTES.txt', 'CNAME'],
                folders: ['icons']
            },
            gameshelf: {
                required: ['index.html', 'sw.js', 'manifest.json', 'manifest-test.json'],
                optional: ['RELEASE_NOTES.txt', 'CNAME'],
                folders: ['icons', 'icons-test', 'quotle', 'slate', 'rungs', 'wordboxing']
            },
            simple: {
                required: ['index.html'],
                optional: ['RELEASE_NOTES.txt', 'README.md', 'CNAME'],
                folders: []
            }
        };
        
        // Define which repos are consolidated (should contain subfolders)
        const CONSOLIDATED_REPOS = {
            'gameshelf': ['quotle', 'slate', 'rungs', 'wordboxing'],
            'gameshelftest': ['quotle', 'slate', 'rungs', 'wordboxing']
        };
        
        // Define legacy repos that may no longer be needed
        const LEGACY_REPO_PATTERNS = [
            // Individual game repos (now consolidated)
            /^quotle$/i, /^quotletest$/i,
            /^slate$/i, /^slatetest$/i,
            /^rungs$/i, /^rungstest$/i,
            /^wordboxing$/i, /^wordboxingtest$/i,
            /^word-boxing$/i,
            // Old naming patterns
            /^gameshelf-dev$/i, /^gameshelf-beta$/i,
            // Typos or experiments
            /test$/i
        ];
        
        // Get app type for a repo
        const getAppType = (repoName) => {
            const lower = repoName.toLowerCase();
            if (lower === 'gameshelf' || lower === 'gameshelftest') return 'gameshelf';
            if (lower.includes('management') || lower.includes('command') || lower.includes('testplan')) return 'simple';
            return 'pwa';
        };
        
        // Check if a file is part of the base package
        const isBaseFile = (filePath, appType) => {
            const pkg = BASE_PACKAGES[appType] || BASE_PACKAGES.pwa;
            const fileName = filePath.split('/').pop();
            const topLevel = filePath.split('/')[0];
            
            // Check required files
            if (pkg.required.includes(fileName) && !filePath.includes('/')) return true;
            
            // Check optional files
            if (pkg.optional.includes(fileName) && !filePath.includes('/')) return true;
            
            // Check folders
            if (pkg.folders.some(f => topLevel === f || filePath.startsWith(f + '/'))) return true;
            
            // For consolidated repos, check subfolder structure
            if (appType === 'gameshelf') {
                const parts = filePath.split('/');
                if (parts.length >= 2) {
                    const subApp = parts[0];
                    if (['quotle', 'slate', 'rungs', 'wordboxing'].includes(subApp)) {
                        // Check if it's a valid file within the sub-app
                        const subPath = parts.slice(1).join('/');
                        return isBaseFile(subPath, 'pwa');
                    }
                }
            }
            
            return false;
        };
        
        // Check if a repo might be legacy/unused
        const isLegacyRepo = (repoName) => {
            // Check against legacy patterns
            for (const pattern of LEGACY_REPO_PATTERNS) {
                if (pattern.test(repoName)) {
                    // But exclude if it's an active configured repo
                    const isConfigured = Object.values(config.apps || {}).some(app => 
                        Object.values(app.repos || {}).some(r => r && r.includes(repoName))
                    );
                    if (!isConfigured) return true;
                }
            }
            return false;
        };
        
        // Scan all repos for stale files
        const scanForStaleFiles = async () => {
            if (!github) {
                await showAlert('GitHub token required', 'Error');
                return;
            }
            
            setScanning(true);
            setScanResults(null);
            setSelectedFiles(new Set());
            setSelectedRepos(new Set());
            
            const results = {
                staleFiles: [],
                legacyRepos: [],
                scannedRepos: 0,
                totalFiles: 0
            };
            
            try {
                // Get all repos
                const repos = availableRepos || [];
                
                for (const repo of repos) {
                    const repoName = repo.name;
                    const repoFullName = repo.fullName || `${repo.owner}/${repoName}`;
                    
                    // Check if this is a legacy repo
                    if (isLegacyRepo(repoName)) {
                        results.legacyRepos.push({
                            name: repoName,
                            fullName: repoFullName,
                            reason: 'Matches legacy pattern - may be obsolete after consolidation',
                            url: `https://github.com/${repoFullName}`
                        });
                    }
                    
                    // Scan repo files
                    try {
                        const files = await github.getRepoFiles(repoFullName);
                        const appType = getAppType(repoName);
                        
                        results.scannedRepos++;
                        results.totalFiles += files.length;
                        
                        for (const file of files) {
                            if (file.type === 'file' && !isBaseFile(file.path, appType)) {
                                results.staleFiles.push({
                                    repo: repoFullName,
                                    repoName: repoName,
                                    path: file.path,
                                    sha: file.sha,
                                    size: file.size,
                                    reason: 'Not part of standard package'
                                });
                            }
                        }
                    } catch (e) {
                        console.log(`Could not scan ${repoName}:`, e.message);
                    }
                }
                
                setScanResults(results);
            } catch (e) {
                await showAlert(`Scan failed: ${e.message}`, 'Error');
            }
            
            setScanning(false);
        };
        
        // Toggle file selection
        const toggleFileSelection = (fileKey) => {
            setSelectedFiles(prev => {
                const newSet = new Set(prev);
                if (newSet.has(fileKey)) {
                    newSet.delete(fileKey);
                } else {
                    newSet.add(fileKey);
                }
                return newSet;
            });
        };
        
        // Toggle repo selection
        const toggleRepoSelection = (repoName) => {
            setSelectedRepos(prev => {
                const newSet = new Set(prev);
                if (newSet.has(repoName)) {
                    newSet.delete(repoName);
                } else {
                    newSet.add(repoName);
                }
                return newSet;
            });
        };
        
        // Select all files
        const selectAllFiles = () => {
            if (!scanResults) return;
            const allKeys = scanResults.staleFiles.map(f => `${f.repo}:${f.path}`);
            setSelectedFiles(new Set(allKeys));
        };
        
        // Clear file selection
        const clearFileSelection = () => {
            setSelectedFiles(new Set());
        };
        
        // Select all repos
        const selectAllRepos = () => {
            if (!scanResults) return;
            const allRepos = scanResults.legacyRepos.map(r => r.fullName);
            setSelectedRepos(new Set(allRepos));
        };
        
        // Clear repo selection
        const clearRepoSelection = () => {
            setSelectedRepos(new Set());
        };
        
        // Delete selected files
        const deleteSelectedFiles = async () => {
            if (selectedFiles.size === 0) return;
            
            const confirmed = await showConfirm(
                `Delete ${selectedFiles.size} file(s)?\n\nFiles can be restored from the History tab.`,
                'Confirm Deletion'
            );
            
            if (!confirmed) return;
            
            setDeleting(true);
            setDeleteProgress({ current: 0, total: selectedFiles.size });
            
            let deleted = 0;
            let failed = 0;
            const deletedItems = [];
            
            for (const fileKey of selectedFiles) {
                const [repo, ...pathParts] = fileKey.split(':');
                const path = pathParts.join(':');
                const file = scanResults.staleFiles.find(f => f.repo === repo && f.path === path);
                
                if (file) {
                    try {
                        // Get the commit SHA before deletion for restoration
                        const [owner, repoName] = repo.split('/');
                        let parentCommitSha = null;
                        try {
                            const commits = await github.request(`/repos/${owner}/${repoName}/commits?path=${encodeURIComponent(path)}&per_page=1`);
                            if (commits && commits.length > 0) {
                                parentCommitSha = commits[0].sha;
                            }
                        } catch (e) {
                            console.log('Could not get commit sha:', e);
                        }
                        
                        await github.deleteFile(repo, path, `Cleanup: Remove stale file ${path}`, file.sha);
                        
                        // Track successful deletion
                        deletedItems.push({
                            repo,
                            repoName: file.repoName,
                            path,
                            sha: file.sha,
                            size: file.size,
                            parentCommitSha,
                            reason: file.reason
                        });
                        
                        deleted++;
                    } catch (e) {
                        console.error(`Failed to delete ${path}:`, e);
                        failed++;
                    }
                }
                
                setDeleteProgress({ current: deleted + failed, total: selectedFiles.size });
            }
            
            // Save to deletion history
            if (deletedItems.length > 0) {
                addToDeletionHistory(deletedItems);
            }
            
            setDeleting(false);
            setSelectedFiles(new Set());
            
            await showAlert(
                `Deleted ${deleted} file(s)${failed > 0 ? `, ${failed} failed` : ''}\n\nFiles saved to History tab for potential restoration.`,
                'Deletion Complete'
            );
            
            // Re-scan to update results
            scanForStaleFiles();
        };
        
        // Restore a deleted file from git history
        const restoreFile = async (historyItem) => {
            if (!github) return;
            
            const confirmed = await showConfirm(
                `Restore "${historyItem.path}" to ${historyItem.repoName}?`,
                'Confirm Restore'
            );
            
            if (!confirmed) return;
            
            setRestoring(true);
            
            try {
                const [owner, repoName] = historyItem.repo.split('/');
                
                // Try to get the file content from the commit before deletion
                let content = null;
                
                if (historyItem.parentCommitSha) {
                    try {
                        // Get file content at the parent commit
                        const fileData = await github.request(
                            `/repos/${owner}/${repoName}/contents/${encodeURIComponent(historyItem.path)}?ref=${historyItem.parentCommitSha}`
                        );
                        if (fileData && fileData.content) {
                            content = fileData.content; // Already base64 encoded
                        }
                    } catch (e) {
                        console.log('Could not get file from parent commit:', e);
                    }
                }
                
                // Fallback: try to get from any commit in history
                if (!content) {
                    try {
                        const commits = await github.request(
                            `/repos/${owner}/${repoName}/commits?path=${encodeURIComponent(historyItem.path)}&per_page=5`
                        );
                        for (const commit of commits) {
                            try {
                                const fileData = await github.request(
                                    `/repos/${owner}/${repoName}/contents/${encodeURIComponent(historyItem.path)}?ref=${commit.sha}`
                                );
                                if (fileData && fileData.content) {
                                    content = fileData.content;
                                    break;
                                }
                            } catch (e) {
                                continue;
                            }
                        }
                    } catch (e) {
                        console.log('Could not search commit history:', e);
                    }
                }
                
                if (!content) {
                    throw new Error('Could not find file content in git history');
                }
                
                // Restore the file
                await github.request(`/repos/${owner}/${repoName}/contents/${historyItem.path}`, {
                    method: 'PUT',
                    body: JSON.stringify({
                        message: `Restore: ${historyItem.path}`,
                        content: content.replace(/\n/g, ''), // Remove any newlines in base64
                        committer: { name: 'Command Center', email: 'deploy@gameshelf.app' }
                    })
                });
                
                // Remove from history
                removeFromHistory(historyItem.id);
                
                await showAlert(`Successfully restored "${historyItem.path}"`, 'Restore Complete');
                
            } catch (e) {
                console.error('Restore failed:', e);
                await showAlert(`Failed to restore file: ${e.message}`, 'Restore Failed');
            }
            
            setRestoring(false);
        };
        
        // Delete selected repos
        const deleteSelectedRepos = async () => {
            if (selectedRepos.size === 0) return;
            
            const repoList = Array.from(selectedRepos).join('\n‚Ä¢ ');
            const confirmed = await showConfirm(
                `‚ö†Ô∏è DELETE ${selectedRepos.size} REPOSITORY(S)?\n\n‚Ä¢ ${repoList}\n\nThis will PERMANENTLY delete these repositories and all their contents!\n\nThis action CANNOT be undone.`,
                'üö® Confirm Repository Deletion'
            );
            
            if (!confirmed) return;
            
            // Double confirm for repos
            const doubleConfirmed = await showConfirm(
                `Are you ABSOLUTELY SURE?\n\nType the number of repos to delete: ${selectedRepos.size}`,
                'Final Confirmation'
            );
            
            if (!doubleConfirmed) return;
            
            setDeleting(true);
            setDeleteProgress({ current: 0, total: selectedRepos.size });
            
            let deleted = 0;
            let failed = 0;
            
            for (const repoFullName of selectedRepos) {
                try {
                    await github.deleteRepo(repoFullName);
                    deleted++;
                } catch (e) {
                    console.error(`Failed to delete repo ${repoFullName}:`, e);
                    failed++;
                }
                
                setDeleteProgress({ current: deleted + failed, total: selectedRepos.size });
            }
            
            setDeleting(false);
            setSelectedRepos(new Set());
            
            await showAlert(
                `Deleted ${deleted} repo(s)${failed > 0 ? `, ${failed} failed` : ''}`,
                'Deletion Complete'
            );
            
            // Re-scan
            scanForStaleFiles();
        };
        
        // Format file size
        const formatSize = (bytes) => {
            if (bytes < 1024) return `${bytes} B`;
            if (bytes < 1024 * 1024) return `${(bytes / 1024).toFixed(1)} KB`;
            return `${(bytes / 1024 / 1024).toFixed(1)} MB`;
        };
        
        return (
            <div className="space-y-6">
                <div className="flex items-center justify-between">
                    <h2 className="text-xl font-bold flex items-center gap-2">
                        <Icons.Trash /> Repository Cleanup
                    </h2>
                    <button
                        onClick={scanForStaleFiles}
                        disabled={scanning || !github}
                        className="px-4 py-2 bg-indigo-600 hover:bg-indigo-500 rounded-lg text-sm font-medium transition-colors disabled:opacity-50 flex items-center gap-2"
                    >
                        {scanning ? (
                            <><Icons.Refresh className="animate-spin" /> Scanning...</>
                        ) : (
                            <><Icons.Search /> Scan Repositories</>
                        )}
                    </button>
                </div>
                
                {!github && (
                    <div className="p-4 bg-amber-900/50 border border-amber-700 rounded-lg">
                        ‚ö†Ô∏è GitHub token required for cleanup operations
                    </div>
                )}
                
                {/* Tab Navigation */}
                <div className="flex gap-2 border-b border-slate-700 pb-2">
                    {[
                        { id: 'files', label: `üìÑ Stale Files ${scanResults ? `(${scanResults.staleFiles.length})` : ''}` },
                        { id: 'repos', label: `üì¶ Legacy Repos ${scanResults ? `(${scanResults.legacyRepos.length})` : ''}` },
                        { id: 'history', label: `‚è™ History ${deletionHistory.length > 0 ? `(${deletionHistory.length})` : ''}` }
                    ].map(tab => (
                        <button
                            key={tab.id}
                            onClick={() => setActiveTab(tab.id)}
                            className={`px-4 py-2 rounded-t-lg font-medium transition-colors ${
                                activeTab === tab.id 
                                    ? 'bg-slate-700 text-white' 
                                    : 'text-slate-400 hover:text-white hover:bg-slate-800'
                            }`}
                        >
                            {tab.label}
                        </button>
                    ))}
                </div>
                
                {/* Scan Results Summary */}
                {scanResults && (
                    <div className="grid grid-cols-4 gap-4">
                        <div className="bg-slate-800 rounded-lg p-4 text-center">
                            <div className="text-2xl font-bold text-indigo-400">{scanResults.scannedRepos}</div>
                            <div className="text-xs text-slate-500">Repos Scanned</div>
                        </div>
                        <div className="bg-slate-800 rounded-lg p-4 text-center">
                            <div className="text-2xl font-bold text-slate-400">{scanResults.totalFiles}</div>
                            <div className="text-xs text-slate-500">Total Files</div>
                        </div>
                        <div className="bg-slate-800 rounded-lg p-4 text-center">
                            <div className="text-2xl font-bold text-amber-400">{scanResults.staleFiles.length}</div>
                            <div className="text-xs text-slate-500">Stale Files</div>
                        </div>
                        <div className="bg-slate-800 rounded-lg p-4 text-center">
                            <div className="text-2xl font-bold text-red-400">{scanResults.legacyRepos.length}</div>
                            <div className="text-xs text-slate-500">Legacy Repos</div>
                        </div>
                    </div>
                )}
                
                {/* Stale Files Tab */}
                {activeTab === 'files' && (
                    <div className="space-y-4">
                        {scanResults && scanResults.staleFiles.length > 0 && (
                            <>
                                {/* Selection Controls */}
                                <div className="flex items-center justify-between bg-slate-800 rounded-lg p-3">
                                    <div className="flex items-center gap-4">
                                        <span className="text-sm text-slate-400">
                                            {selectedFiles.size} of {scanResults.staleFiles.length} selected
                                        </span>
                                        <button
                                            onClick={selectAllFiles}
                                            className="text-xs px-2 py-1 bg-slate-700 hover:bg-slate-600 rounded"
                                        >
                                            Select All
                                        </button>
                                        <button
                                            onClick={clearFileSelection}
                                            className="text-xs px-2 py-1 bg-slate-700 hover:bg-slate-600 rounded"
                                        >
                                            Clear
                                        </button>
                                    </div>
                                    <button
                                        onClick={deleteSelectedFiles}
                                        disabled={selectedFiles.size === 0 || deleting}
                                        className="px-4 py-2 bg-red-600 hover:bg-red-500 rounded-lg text-sm font-medium transition-colors disabled:opacity-50 flex items-center gap-2"
                                    >
                                        {deleting ? (
                                            <><Icons.Refresh className="animate-spin" /> Deleting {deleteProgress.current}/{deleteProgress.total}</>
                                        ) : (
                                            <><Icons.Trash /> Delete Selected</>
                                        )}
                                    </button>
                                </div>
                                
                                {/* File List */}
                                <div className="bg-slate-800 rounded-xl border border-slate-700 overflow-hidden">
                                    <div className="max-h-96 overflow-y-auto">
                                        {scanResults.staleFiles.map((file, idx) => {
                                            const fileKey = `${file.repo}:${file.path}`;
                                            const isSelected = selectedFiles.has(fileKey);
                                            return (
                                                <div
                                                    key={fileKey}
                                                    className={`flex items-center gap-3 p-3 border-b border-slate-700 last:border-0 hover:bg-slate-700/50 cursor-pointer ${
                                                        isSelected ? 'bg-indigo-900/30' : ''
                                                    }`}
                                                    onClick={() => toggleFileSelection(fileKey)}
                                                >
                                                    <input
                                                        type="checkbox"
                                                        checked={isSelected}
                                                        onChange={() => {}}
                                                        className="w-4 h-4 rounded"
                                                    />
                                                    <Icons.File />
                                                    <div className="flex-1 min-w-0">
                                                        <div className="text-sm font-medium truncate">{file.path}</div>
                                                        <div className="text-xs text-slate-500">
                                                            {file.repoName} ‚Ä¢ {formatSize(file.size || 0)}
                                                        </div>
                                                    </div>
                                                    <span className="text-xs text-amber-400 bg-amber-900/30 px-2 py-1 rounded">
                                                        {file.reason}
                                                    </span>
                                                </div>
                                            );
                                        })}
                                    </div>
                                </div>
                            </>
                        )}
                        
                        {scanResults && scanResults.staleFiles.length === 0 && (
                            <div className="text-center py-12 text-slate-500">
                                <div className="text-4xl mb-4">‚ú®</div>
                                <div>No stale files found - repositories are clean!</div>
                            </div>
                        )}
                        
                        {!scanResults && !scanning && (
                            <div className="text-center py-12 text-slate-500">
                                <div className="text-4xl mb-4">üîç</div>
                                <div>Click "Scan Repositories" to find stale files</div>
                            </div>
                        )}
                    </div>
                )}
                
                {/* Legacy Repos Tab */}
                {activeTab === 'repos' && (
                    <div className="space-y-4">
                        {scanResults && scanResults.legacyRepos.length > 0 && (
                            <>
                                {/* Selection Controls */}
                                <div className="flex items-center justify-between bg-slate-800 rounded-lg p-3">
                                    <div className="flex items-center gap-4">
                                        <span className="text-sm text-slate-400">
                                            {selectedRepos.size} of {scanResults.legacyRepos.length} selected
                                        </span>
                                        <button
                                            onClick={selectAllRepos}
                                            className="text-xs px-2 py-1 bg-slate-700 hover:bg-slate-600 rounded"
                                        >
                                            Select All
                                        </button>
                                        <button
                                            onClick={clearRepoSelection}
                                            className="text-xs px-2 py-1 bg-slate-700 hover:bg-slate-600 rounded"
                                        >
                                            Clear
                                        </button>
                                    </div>
                                    <button
                                        onClick={deleteSelectedRepos}
                                        disabled={selectedRepos.size === 0 || deleting}
                                        className="px-4 py-2 bg-red-600 hover:bg-red-500 rounded-lg text-sm font-medium transition-colors disabled:opacity-50 flex items-center gap-2"
                                    >
                                        {deleting ? (
                                            <><Icons.Refresh className="animate-spin" /> Deleting {deleteProgress.current}/{deleteProgress.total}</>
                                        ) : (
                                            <><Icons.Trash /> Delete Selected Repos</>
                                        )}
                                    </button>
                                </div>
                                
                                {/* Warning */}
                                <div className="p-4 bg-red-900/30 border border-red-700 rounded-lg text-sm">
                                    <strong>‚ö†Ô∏è Warning:</strong> Deleting repositories is permanent and cannot be undone. 
                                    Make sure you have backups of any important data before proceeding.
                                </div>
                                
                                {/* Repo List */}
                                <div className="bg-slate-800 rounded-xl border border-slate-700 overflow-hidden">
                                    <div className="max-h-96 overflow-y-auto">
                                        {scanResults.legacyRepos.map((repo) => {
                                            const isSelected = selectedRepos.has(repo.fullName);
                                            return (
                                                <div
                                                    key={repo.fullName}
                                                    className={`flex items-center gap-3 p-4 border-b border-slate-700 last:border-0 hover:bg-slate-700/50 cursor-pointer ${
                                                        isSelected ? 'bg-red-900/20' : ''
                                                    }`}
                                                    onClick={() => toggleRepoSelection(repo.fullName)}
                                                >
                                                    <input
                                                        type="checkbox"
                                                        checked={isSelected}
                                                        onChange={() => {}}
                                                        className="w-4 h-4 rounded"
                                                    />
                                                    <Icons.Folder />
                                                    <div className="flex-1 min-w-0">
                                                        <div className="text-sm font-medium">{repo.name}</div>
                                                        <div className="text-xs text-slate-500">{repo.fullName}</div>
                                                    </div>
                                                    <span className="text-xs text-red-400 bg-red-900/30 px-2 py-1 rounded max-w-xs truncate">
                                                        {repo.reason}
                                                    </span>
                                                    <a
                                                        href={repo.url}
                                                        target="_blank"
                                                        rel="noopener noreferrer"
                                                        onClick={(e) => e.stopPropagation()}
                                                        className="text-xs px-2 py-1 bg-slate-700 hover:bg-slate-600 rounded"
                                                    >
                                                        View
                                                    </a>
                                                </div>
                                            );
                                        })}
                                    </div>
                                </div>
                            </>
                        )}
                        
                        {scanResults && scanResults.legacyRepos.length === 0 && (
                            <div className="text-center py-12 text-slate-500">
                                <div className="text-4xl mb-4">‚ú®</div>
                                <div>No legacy repositories found</div>
                            </div>
                        )}
                        
                        {!scanResults && !scanning && (
                            <div className="text-center py-12 text-slate-500">
                                <div className="text-4xl mb-4">üîç</div>
                                <div>Click "Scan Repositories" to identify legacy repos</div>
                            </div>
                        )}
                    </div>
                )}
                
                {/* History Tab - Restore deleted files */}
                {activeTab === 'history' && (
                    <div className="space-y-4">
                        {deletionHistory.length > 0 && (
                            <>
                                {/* History Controls */}
                                <div className="flex items-center justify-between bg-slate-800 rounded-lg p-3">
                                    <span className="text-sm text-slate-400">
                                        {deletionHistory.length} deleted file(s) in history
                                    </span>
                                    <button
                                        onClick={clearHistory}
                                        className="text-xs px-3 py-1.5 bg-slate-700 hover:bg-slate-600 rounded"
                                    >
                                        Clear History
                                    </button>
                                </div>
                                
                                {/* Info banner */}
                                <div className="p-4 bg-blue-900/30 border border-blue-700 rounded-lg text-sm">
                                    <strong>üí° Restore Files:</strong> Files can be restored from Git history. 
                                    Click "Restore" to recover a deleted file to its original location.
                                </div>
                                
                                {/* Deletion History List */}
                                <div className="bg-slate-800 rounded-xl border border-slate-700 overflow-hidden">
                                    <div className="max-h-96 overflow-y-auto">
                                        {deletionHistory.map((item) => (
                                            <div
                                                key={item.id}
                                                className="flex items-center gap-3 p-3 border-b border-slate-700 last:border-0 hover:bg-slate-700/50"
                                            >
                                                <Icons.File />
                                                <div className="flex-1 min-w-0">
                                                    <div className="text-sm font-medium truncate">{item.path}</div>
                                                    <div className="text-xs text-slate-500">
                                                        {item.repoName} ‚Ä¢ Deleted {new Date(item.deletedAt).toLocaleString()}
                                                    </div>
                                                </div>
                                                <div className="flex gap-2">
                                                    <button
                                                        onClick={() => restoreFile(item)}
                                                        disabled={restoring}
                                                        className="text-xs px-3 py-1.5 bg-green-600 hover:bg-green-500 rounded transition-colors disabled:opacity-50"
                                                    >
                                                        {restoring ? '...' : '‚è™ Restore'}
                                                    </button>
                                                    <button
                                                        onClick={() => removeFromHistory(item.id)}
                                                        className="text-xs px-2 py-1.5 bg-slate-700 hover:bg-slate-600 rounded transition-colors"
                                                        title="Remove from history (does not restore)"
                                                    >
                                                        ‚úï
                                                    </button>
                                                </div>
                                            </div>
                                        ))}
                                    </div>
                                </div>
                            </>
                        )}
                        
                        {deletionHistory.length === 0 && (
                            <div className="text-center py-12 text-slate-500">
                                <div className="text-4xl mb-4">üì≠</div>
                                <div>No deletion history</div>
                                <div className="text-xs mt-2">Deleted files will appear here for restoration</div>
                            </div>
                        )}
                    </div>
                )}
                
                {/* Base Package Reference */}
                <div className="bg-slate-800 rounded-xl p-5 border border-slate-700">
                    <h3 className="font-semibold mb-4">üìã Base Package Reference</h3>
                    <p className="text-xs text-slate-400 mb-4">
                        Files outside these patterns are flagged as potentially stale:
                    </p>
                    <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div className="p-3 bg-slate-900 rounded">
                            <div className="font-medium text-sm mb-2">PWA Apps</div>
                            <div className="text-xs text-slate-400 space-y-1">
                                <div>‚Ä¢ index.html, sw.js, manifest.json</div>
                                <div>‚Ä¢ icons/ folder</div>
                                <div>‚Ä¢ RELEASE_NOTES.txt (optional)</div>
                            </div>
                        </div>
                        <div className="p-3 bg-slate-900 rounded">
                            <div className="font-medium text-sm mb-2">Game Shelf (Consolidated)</div>
                            <div className="text-xs text-slate-400 space-y-1">
                                <div>‚Ä¢ Root PWA files + manifest-test.json</div>
                                <div>‚Ä¢ icons/, icons-test/ folders</div>
                                <div>‚Ä¢ quotle/, slate/, rungs/, wordboxing/</div>
                            </div>
                        </div>
                        <div className="p-3 bg-slate-900 rounded">
                            <div className="font-medium text-sm mb-2">Simple Apps</div>
                            <div className="text-xs text-slate-400 space-y-1">
                                <div>‚Ä¢ index.html only</div>
                                <div>‚Ä¢ README.md (optional)</div>
                                <div>‚Ä¢ Command Center, Test Plan</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        );
    }

    // =========================================================================
    // FIREBASE VIEW
    // =========================================================================
    
    function FirebaseView({ showAlert, showConfirm, showPrompt }) {
        const [user, setUser] = React.useState(null);
        const [authLoading, setAuthLoading] = React.useState(true);
        const [dbPath, setDbPath] = React.useState('');
        const [dbData, setDbData] = React.useState(null);
        const [dbLoading, setDbLoading] = React.useState(false);
        const [dbError, setDbError] = React.useState(null);
        const [expandedPaths, setExpandedPaths] = React.useState(new Set());
        const [editingPath, setEditingPath] = React.useState(null);
        const [editValue, setEditValue] = React.useState('');
        const [realtimeEnabled, setRealtimeEnabled] = React.useState(false);
        const [realtimeUnsubscribe, setRealtimeUnsubscribe] = React.useState(null);
        const [manualUid, setManualUid] = React.useState(() => {
            try { return localStorage.getItem('cc_firebase_uid') || ''; } catch { return ''; }
        });
        const [showManualAuth, setShowManualAuth] = React.useState(false);
        
        // Detect if running from file:// protocol
        const isFileProtocol = window.location.protocol === 'file:';
        
        // Quick paths for common data
        const quickPaths = [
            { label: 'Users', path: 'users' },
            { label: 'Battles', path: 'battles' },
            { label: 'Friends', path: 'friends' },
            { label: 'Gameshelf Public', path: 'gameshelf-public' },
            { label: 'Reported Issues', path: 'reported-issues' },
            { label: 'Game Suggestions', path: 'game-suggestions' },
            { label: 'Test Results', path: 'test-results' },
            { label: 'Root', path: '' },
        ];
        
        // Listen for auth state changes
        React.useEffect(() => {
            if (!firebaseAuth) {
                setAuthLoading(false);
                return;
            }
            
            const unsubscribe = firebaseAuth.onAuthStateChanged((u) => {
                setUser(u);
                setAuthLoading(false);
                if (u) {
                    console.log('Firebase auth state:', u.email, 'UID:', u.uid);
                    // Save UID for manual auth fallback
                    try { localStorage.setItem('cc_firebase_uid', u.uid); } catch {}
                    setManualUid(u.uid);
                } else {
                    console.log('Firebase auth state: signed out');
                }
            });
            
            return () => unsubscribe();
        }, []);
        
        // Cleanup realtime listener on unmount
        React.useEffect(() => {
            return () => {
                if (realtimeUnsubscribe) {
                    realtimeUnsubscribe();
                }
            };
        }, [realtimeUnsubscribe]);
        
        const signInWithGoogle = async () => {
            if (isFileProtocol) {
                showAlert('Google Sign-in requires HTTPS. Please open this app from GitHub Pages or a web server.\n\nOr use the "Manual UID" option below for read-only access to public data.', 'HTTPS Required');
                return;
            }
            
            try {
                const provider = new firebase.auth.GoogleAuthProvider();
                await firebaseAuth.signInWithPopup(provider);
            } catch (e) {
                console.error('Sign in error:', e);
                if (e.code === 'auth/operation-not-supported-in-this-environment') {
                    showAlert('Google Sign-in not supported here. Please:\n\n1. Open from GitHub Pages URL, or\n2. Use "Manual UID" for limited access', 'Sign-in Not Supported');
                } else {
                    showAlert('Sign in failed: ' + e.message, 'Sign-in Error');
                }
            }
        };
        
        const signOut = async () => {
            try {
                await firebaseAuth.signOut();
                setDbData(null);
            } catch (e) {
                console.error('Sign out error:', e);
            }
        };
        
        const fetchData = async (path = dbPath) => {
            if (!firebaseDb) return;
            
            // Stop any existing realtime listener
            if (realtimeUnsubscribe) {
                realtimeUnsubscribe();
                setRealtimeUnsubscribe(null);
            }
            
            setDbLoading(true);
            setDbError(null);
            
            try {
                const ref = firebaseDb.ref(path || '/');
                const snapshot = await ref.once('value');
                setDbData(snapshot.val());
                setDbPath(path);
                console.log('Fetched data at', path || '/', snapshot.val());
            } catch (e) {
                console.error('Fetch error:', e);
                setDbError(e.message);
            }
            
            setDbLoading(false);
        };
        
        const enableRealtime = () => {
            if (!firebaseDb || !dbPath) return;
            
            // Stop existing listener
            if (realtimeUnsubscribe) {
                realtimeUnsubscribe();
            }
            
            const ref = firebaseDb.ref(dbPath || '/');
            const callback = ref.on('value', (snapshot) => {
                setDbData(snapshot.val());
                console.log('Realtime update at', dbPath || '/');
            }, (error) => {
                setDbError(error.message);
            });
            
            setRealtimeUnsubscribe(() => () => ref.off('value', callback));
            setRealtimeEnabled(true);
        };
        
        const disableRealtime = () => {
            if (realtimeUnsubscribe) {
                realtimeUnsubscribe();
                setRealtimeUnsubscribe(null);
            }
            setRealtimeEnabled(false);
        };
        
        const updateValue = async (path, value) => {
            if (!firebaseDb) return;
            
            try {
                // Try to parse as JSON, otherwise use as string
                let parsedValue;
                try {
                    parsedValue = JSON.parse(value);
                } catch {
                    parsedValue = value;
                }
                
                await firebaseDb.ref(path).set(parsedValue);
                setEditingPath(null);
                fetchData(dbPath);
            } catch (e) {
                showAlert('Update failed: ' + e.message, 'Update Error');
            }
        };
        
        const deleteValue = async (path) => {
            if (!firebaseDb) return;
            const confirmed = await showConfirm(`Delete data at "${path}"?`, 'Confirm Delete');
            if (!confirmed) return;
            
            try {
                await firebaseDb.ref(path).remove();
                fetchData(dbPath);
            } catch (e) {
                showAlert('Delete failed: ' + e.message, 'Delete Error');
            }
        };
        
        const copyToClipboard = (data) => {
            navigator.clipboard.writeText(JSON.stringify(data, null, 2));
        };
        
        const toggleExpand = (path) => {
            setExpandedPaths(prev => {
                const newSet = new Set(prev);
                if (newSet.has(path)) {
                    newSet.delete(path);
                } else {
                    newSet.add(path);
                }
                return newSet;
            });
        };
        
        // Render a data node recursively
        const renderData = (data, path = '') => {
            if (data === null || data === undefined) {
                return <span className="text-slate-500 italic">null</span>;
            }
            
            if (typeof data !== 'object') {
                // Primitive value
                const isEditing = editingPath === path;
                
                return (
                    <div className="flex items-center gap-2">
                        {isEditing ? (
                            <>
                                <input 
                                    type="text" 
                                    value={editValue}
                                    onChange={e => setEditValue(e.target.value)}
                                    className="flex-1 bg-slate-900 border border-indigo-500 rounded px-2 py-1 text-sm font-mono"
                                    autoFocus
                                />
                                <button onClick={() => updateValue(path, editValue)} className="px-2 py-1 bg-green-600 rounded text-xs">Save</button>
                                <button onClick={() => setEditingPath(null)} className="px-2 py-1 bg-slate-600 rounded text-xs">Cancel</button>
                            </>
                        ) : (
                            <>
                                <span className={`font-mono ${
                                    typeof data === 'string' ? 'text-green-400' :
                                    typeof data === 'number' ? 'text-blue-400' :
                                    typeof data === 'boolean' ? 'text-amber-400' : 'text-white'
                                }`}>
                                    {typeof data === 'string' ? `"${data}"` : String(data)}
                                </span>
                                <button onClick={() => { setEditingPath(path); setEditValue(typeof data === 'string' ? data : JSON.stringify(data)); }} 
                                    className="p-1 hover:bg-slate-600 rounded opacity-50 hover:opacity-100">
                                    <Icons.Edit />
                                </button>
                            </>
                        )}
                    </div>
                );
            }
            
            // Object or array
            const entries = Object.entries(data);
            const isArray = Array.isArray(data);
            const isExpanded = expandedPaths.has(path) || path === '';
            
            return (
                <div className="ml-4 border-l border-slate-700 pl-3">
                    {entries.length === 0 ? (
                        <span className="text-slate-500 italic">{isArray ? '[]' : '{}'}</span>
                    ) : (
                        entries.slice(0, isExpanded ? undefined : 5).map(([key, value]) => {
                            const childPath = path ? `${path}/${key}` : key;
                            const isObject = value && typeof value === 'object';
                            const childCount = isObject ? Object.keys(value).length : 0;
                            
                            return (
                                <div key={key} className="my-1">
                                    <div className="flex items-center gap-2">
                                        {isObject && (
                                            <button onClick={() => toggleExpand(childPath)} className="text-slate-400 hover:text-white">
                                                {expandedPaths.has(childPath) ? '‚ñº' : '‚ñ∂'}
                                            </button>
                                        )}
                                        <span className={`${isArray ? 'text-slate-500' : 'text-indigo-400'} font-mono text-sm`}>
                                            {isArray ? `[${key}]` : key}:
                                        </span>
                                        {isObject ? (
                                            <span className="text-slate-500 text-xs">
                                                {Array.isArray(value) ? `Array(${childCount})` : `Object(${childCount})`}
                                            </span>
                                        ) : null}
                                        <button onClick={() => copyToClipboard(value)} className="p-1 hover:bg-slate-600 rounded opacity-50 hover:opacity-100" title="Copy">
                                            <Icons.Copy />
                                        </button>
                                        <button onClick={() => deleteValue(childPath)} className="p-1 hover:bg-red-900/50 rounded opacity-50 hover:opacity-100 text-red-400" title="Delete">
                                            <Icons.Trash />
                                        </button>
                                    </div>
                                    {(!isObject || expandedPaths.has(childPath)) && (
                                        <div className="ml-4">
                                            {renderData(value, childPath)}
                                        </div>
                                    )}
                                </div>
                            );
                        })
                    )}
                    {!isExpanded && entries.length > 5 && (
                        <button onClick={() => toggleExpand(path)} className="text-indigo-400 text-sm hover:underline">
                            ... {entries.length - 5} more items
                        </button>
                    )}
                </div>
            );
        };
        
        return (
            <div className="space-y-6">
                {/* Protocol Warning */}
                {isFileProtocol && (
                    <div className="bg-amber-900/30 border border-amber-700 rounded-xl p-4">
                        <div className="flex items-start gap-3">
                            <span className="text-2xl">‚ö†Ô∏è</span>
                            <div>
                                <div className="font-semibold text-amber-400">Running from local file</div>
                                <p className="text-sm text-slate-300 mt-1">
                                    Google Sign-in requires HTTPS. For full functionality:
                                </p>
                                <ol className="text-sm text-slate-400 mt-2 list-decimal list-inside space-y-1">
                                    <li>Deploy this file to your <strong>managementtest</strong> repo</li>
                                    <li>Open from GitHub Pages URL</li>
                                    <li>Sign in with Google there</li>
                                </ol>
                                <p className="text-sm text-slate-400 mt-2">
                                    Or use <strong>Manual UID</strong> below for read-only access to public data.
                                </p>
                            </div>
                        </div>
                    </div>
                )}
                
                {/* Auth Section */}
                <div className="bg-slate-800 rounded-xl border border-slate-700 p-6">
                    <h2 className="text-lg font-semibold mb-4 flex items-center gap-2">
                        <Icons.Database /> Firebase Realtime Database
                    </h2>
                    
                    <div className="flex items-center gap-4 mb-4">
                        <div className="flex-1">
                            <div className="text-xs text-slate-400 mb-1">Project</div>
                            <div className="font-mono text-sm">{FIREBASE_CONFIG.projectId}</div>
                        </div>
                        
                        {authLoading ? (
                            <div className="text-slate-400">Loading auth...</div>
                        ) : user ? (
                            <div className="flex items-center gap-3">
                                <div className="text-right">
                                    <div className="text-sm font-medium">{user.displayName || user.email}</div>
                                    <div className="text-xs text-slate-400">{user.email}</div>
                                    <div className="text-xs text-slate-500 font-mono">UID: {user.uid}</div>
                                </div>
                                {user.photoURL && <img src={user.photoURL} className="w-8 h-8 rounded-full" />}
                                <button onClick={signOut} className="px-3 py-1.5 bg-slate-700 rounded text-sm">Sign Out</button>
                            </div>
                        ) : (
                            <div className="flex items-center gap-2">
                                <button onClick={signInWithGoogle} 
                                    className={`px-4 py-2 rounded flex items-center gap-2 ${isFileProtocol ? 'bg-slate-600 text-slate-400' : 'bg-indigo-600'}`}>
                                    <Icons.User /> Sign in with Google
                                </button>
                                <button onClick={() => setShowManualAuth(!showManualAuth)} 
                                    className="px-3 py-2 bg-slate-700 rounded text-sm">
                                    {showManualAuth ? 'Hide' : 'Manual UID'}
                                </button>
                            </div>
                        )}
                    </div>
                    
                    {/* Manual UID Input (for file:// or debugging) */}
                    {!user && showManualAuth && (
                        <div className="mt-4 p-4 bg-slate-900 rounded-lg border border-slate-600">
                            <div className="text-sm text-slate-400 mb-2">
                                <strong>Manual UID Access</strong> - Enter a UID to access public data (read-only without auth)
                            </div>
                            <div className="flex gap-2">
                                <input 
                                    type="text"
                                    value={manualUid}
                                    onChange={e => setManualUid(e.target.value)}
                                    placeholder="Firebase UID (e.g., abc123xyz...)"
                                    className="flex-1 bg-slate-800 border border-slate-600 rounded px-3 py-2 font-mono text-sm"
                                />
                                <button onClick={() => {
                                    try { localStorage.setItem('cc_firebase_uid', manualUid); } catch {}
                                    showAlert('UID saved. You can now query public data paths.', 'UID Saved');
                                }} className="px-4 py-2 bg-indigo-600 rounded">
                                    Save
                                </button>
                            </div>
                            <div className="text-xs text-slate-500 mt-2">
                                Tip: Sign in from GitHub Pages once to get your UID, then use it here.
                            </div>
                        </div>
                    )}
                    
                    {!user && !showManualAuth && (
                        <div className="text-slate-400 text-sm">
                            Sign in to access protected data, or click "Manual UID" for limited access.
                        </div>
                    )}
                </div>
                
                {/* Query Section */}
                <div className="bg-slate-800 rounded-xl border border-slate-700 p-6">
                    <h3 className="font-semibold mb-4">Query Data</h3>
                    
                    <div className="flex gap-2 mb-4 flex-wrap">
                        {quickPaths.map(qp => (
                            <button key={qp.path} onClick={() => { setDbPath(qp.path); fetchData(qp.path); }}
                                className={`px-3 py-1.5 rounded text-sm ${dbPath === qp.path ? 'bg-indigo-600' : 'bg-slate-700 hover:bg-slate-600'}`}>
                                {qp.label}
                            </button>
                        ))}
                    </div>
                    
                    <div className="flex gap-2 mb-4">
                        <input 
                            type="text" 
                            value={dbPath}
                            onChange={e => setDbPath(e.target.value)}
                            onKeyDown={e => e.key === 'Enter' && fetchData()}
                            placeholder="Path (e.g., users/abc123)"
                            className="flex-1 bg-slate-900 border border-slate-600 rounded px-3 py-2 font-mono text-sm"
                        />
                        <button onClick={() => fetchData()} disabled={dbLoading} className="px-4 py-2 bg-indigo-600 rounded">
                            {dbLoading ? '...' : 'Fetch'}
                        </button>
                        <button 
                            onClick={() => realtimeEnabled ? disableRealtime() : enableRealtime()} 
                            className={`px-4 py-2 rounded flex items-center gap-2 ${realtimeEnabled ? 'bg-green-600' : 'bg-slate-700'}`}
                            title={realtimeEnabled ? 'Disable realtime updates' : 'Enable realtime updates'}
                        >
                            {realtimeEnabled ? 'üî¥ Live' : '‚ö™ Live'}
                        </button>
                    </div>
                    
                    {dbError && (
                        <div className="mb-4 p-3 bg-red-900/30 border border-red-700 rounded text-red-400 text-sm">
                            Error: {dbError}
                        </div>
                    )}
                </div>
                
                {/* Data Display */}
                {dbData !== null && (
                    <div className="bg-slate-800 rounded-xl border border-slate-700 p-6">
                        <div className="flex items-center justify-between mb-4">
                            <h3 className="font-semibold">
                                Data at <span className="font-mono text-indigo-400">/{dbPath || ''}</span>
                                {realtimeEnabled && <span className="ml-2 text-green-400 text-sm">‚óè Live</span>}
                            </h3>
                            <div className="flex gap-2">
                                <button onClick={() => copyToClipboard(dbData)} className="px-3 py-1 bg-slate-700 rounded text-sm flex items-center gap-1">
                                    <Icons.Copy /> Copy All
                                </button>
                                <button onClick={() => setExpandedPaths(new Set())} className="px-3 py-1 bg-slate-700 rounded text-sm">
                                    Collapse All
                                </button>
                            </div>
                        </div>
                        
                        <div className="bg-slate-900 rounded p-4 max-h-[600px] overflow-auto">
                            {renderData(dbData, dbPath)}
                        </div>
                    </div>
                )}
            </div>
        );
    }

    // =========================================================================
    // APPS VIEW
    // =========================================================================
    
    function AppsView({ apps, repos, onUpdate }) {
        return (
            <div className="space-y-6">
                <h2 className="text-xl font-bold">App Configuration</h2>
                <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                    {Object.values(apps).map(app => (
                        <div key={app.id} className="bg-slate-800 rounded-xl border border-slate-700 p-4">
                            <div className="flex items-center gap-2 mb-3">
                                <AppIcon icon={app.icon} size={28} />
                                <span className="font-semibold">{app.name}</span>
                            </div>
                            <div className="space-y-2">
                                <div>
                                    <label className="text-xs text-blue-400">üß™ TEST</label>
                                    <select value={app.testRepo || ''} onChange={e => onUpdate(app.id, { testRepo: e.target.value })}
                                        className="w-full p-1.5 bg-slate-700 border border-slate-600 rounded text-sm">
                                        <option value="">Select...</option>
                                        {repos.map(r => <option key={r.fullName} value={r.fullName}>{r.name}</option>)}
                                    </select>
                                </div>
                                <div>
                                    <label className="text-xs text-green-400">üöÄ PROD</label>
                                    <select value={app.prodRepo || ''} onChange={e => onUpdate(app.id, { prodRepo: e.target.value })}
                                        className="w-full p-1.5 bg-slate-700 border border-slate-600 rounded text-sm">
                                        <option value="">Select...</option>
                                        {repos.map(r => <option key={r.fullName} value={r.fullName}>{r.name}</option>)}
                                    </select>
                                </div>
                                <div>
                                    <label className="text-xs text-slate-400">Target Path</label>
                                    <input type="text" value={app.targetPath} onChange={e => onUpdate(app.id, { targetPath: e.target.value })}
                                        className="w-full p-1.5 bg-slate-700 border border-slate-600 rounded text-sm font-mono" />
                                </div>
                            </div>
                        </div>
                    ))}
                </div>
            </div>
        );
    }

    // =========================================================================
    // HISTORY VIEW
    // =========================================================================
    
    function HistoryView({ deployments, apps, onRollback }) {
        return (
            <div className="bg-slate-800 rounded-xl border border-slate-700 p-6">
                <h2 className="text-lg font-semibold mb-4 flex items-center gap-2">
                    <Icons.History /> History ({deployments.length})
                </h2>
                {deployments.length === 0 ? (
                    <div className="text-slate-400 text-center py-8">No deployments yet</div>
                ) : (
                    <div className="space-y-2">
                        {deployments.map(d => (
                            <div key={d.id} className={`p-3 rounded-lg border ${
                                d.status === 'success' ? 'bg-green-900/20 border-green-800' :
                                d.status === 'failed' ? 'bg-red-900/20 border-red-800' : 'border-slate-600'
                            }`}>
                                <div className="flex items-center gap-2">
                                    <AppIcon icon={apps[d.appId]?.icon} size={18} />
                                    <span className="font-medium">{d.appName}</span>
                                    <span className="font-mono text-sm text-slate-400">{formatVersion(d.version)}</span>
                                    {d.fileCount && <span className="text-xs text-slate-500">({d.fileCount} files)</span>}
                                    <span className={`text-xs px-1.5 rounded ${d.target === 'prod' ? 'bg-green-900 text-green-300' : 'bg-blue-900 text-blue-300'}`}>
                                        {d.target?.toUpperCase()}
                                    </span>
                                    {d.isPromotion && <span className="text-xs text-amber-400">‚Üë promoted</span>}
                                    {d.isRollback && <span className="text-xs text-amber-400">‚Ü© rollback</span>}
                                    <span className="flex-1" />
                                    {d.status === 'success' && d.commitSha && !d.fileCount && (
                                        <button onClick={() => onRollback(d)}
                                            className="px-2 py-1 text-xs bg-slate-700 hover:bg-amber-900/50 rounded flex items-center gap-1">
                                            <Icons.Rewind className="w-3 h-3" /> Rollback
                                        </button>
                                    )}
                                </div>
                                <div className="text-xs text-slate-500 mt-1 flex items-center gap-2">
                                    {formatDate(d.completedAt || d.startedAt)}
                                    {d.commitSha && <span className="font-mono">‚Ä¢ {d.commitSha.substring(0, 7)}</span>}
                                    {d.previousVersion && <span>‚Ä¢ was {formatVersion(d.previousVersion)}</span>}
                                </div>
                                {d.url && d.status === 'success' && (
                                    <a href={d.url} target="_blank" className="text-xs text-indigo-400 hover:underline">View ‚Üó</a>
                                )}
                            </div>
                        ))}
                    </div>
                )}
            </div>
        );
    }

    // =========================================================================
    // SESSION LOG VIEW
    // =========================================================================
    
    function SessionLogView({ apps, sessionLog, setSessionLog, deployments, github, onFileDrop, showAlert }) {
        const [newEntry, setNewEntry] = React.useState('');
        const [firebaseUser, setFirebaseUser] = React.useState(null);
        const [syncStatus, setSyncStatus] = React.useState('local');
        const [quickDeployCode, setQuickDeployCode] = React.useState('');
        const [detectedFile, setDetectedFile] = React.useState(null);
        const [projectFile, setProjectFile] = React.useState(null);
        const [uploading, setUploading] = React.useState(false);
        const [downloading, setDownloading] = React.useState(false);
        const [pendingDeploys, setPendingDeploys] = React.useState([]);
        const [apiKey, setApiKey] = React.useState(() => {
            try { return localStorage.getItem('cc_api_key') || ''; } catch { return ''; }
        });
        
        const configuredApps = Object.values(apps).filter(a => a.testRepo || a.prodRepo);
        
        // Listen for Firebase auth
        React.useEffect(() => {
            if (!firebaseAuth) return;
            const unsubscribe = firebaseAuth.onAuthStateChanged((u) => {
                setFirebaseUser(u);
                if (u) {
                    loadProjectFileInfo(u.uid);
                    listenForPendingDeploys(u.uid);
                }
            });
            return () => unsubscribe();
        }, []);
        
        // Listen for pending deploys from Claude
        const listenForPendingDeploys = (uid) => {
            if (!firebaseDb) return;
            
            const ref = firebaseDb.ref(`command-center/${uid}/pending-deploys`);
            ref.orderByChild('status').equalTo('pending').on('value', (snapshot) => {
                const data = snapshot.val();
                if (data) {
                    const deploys = Object.entries(data).map(([id, d]) => ({ id, ...d }));
                    setPendingDeploys(deploys.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt)));
                } else {
                    setPendingDeploys([]);
                }
            });
            
            return () => ref.off();
        };
        
        // Accept pending deploy
        const acceptPendingDeploy = async (deploy) => {
            if (!github) {
                showAlert('Configure GitHub token first', 'Configuration Required');
                return;
            }
            
            // Create file object for existing deploy handler
            const file = {
                id: Date.now(),
                name: 'index.html',
                content: deploy.code,
                version: deploy.version,
                targetPath: 'index.html'
            };
            
            onFileDrop([file]);
            
            // Update status in Firebase
            await firebaseDb.ref(`command-center/${firebaseUser.uid}/pending-deploys/${deploy.id}/status`).set('deployed');
            await logEntry(`Deployed from queue: ${deploy.appName || deploy.appId} v${deploy.version}`, 'deploy');
        };
        
        // Reject pending deploy
        const rejectPendingDeploy = async (deployId) => {
            await firebaseDb.ref(`command-center/${firebaseUser.uid}/pending-deploys/${deployId}/status`).set('rejected');
        };
        
        // Generate API key for Claude
        const generateApiKey = () => {
            const key = 'cc_' + Math.random().toString(36).substring(2, 15) + Math.random().toString(36).substring(2, 15);
            setApiKey(key);
            localStorage.setItem('cc_api_key', key);
            
            // Store in Firebase for validation
            if (firebaseDb && firebaseUser) {
                firebaseDb.ref(`command-center/${firebaseUser.uid}/apiKey`).set(key);
            }
        };
        
        // Load project file info from Firebase
        const loadProjectFileInfo = async (uid) => {
            if (!firebaseDb || !uid) return;
            try {
                const snapshot = await firebaseDb.ref(`command-center/${uid}/projectFile`).once('value');
                const data = snapshot.val();
                if (data) {
                    setProjectFile(data);
                }
                setSyncStatus('synced');
            } catch (e) {
                console.error('Error loading project file info:', e);
                setSyncStatus('error');
            }
        };
        
        // Upload gs-active.zip to Firebase
        const uploadProjectFile = async (file) => {
            if (!firebaseDb || !firebaseUser) {
                showAlert('Please sign in via the Firebase tab first', 'Sign-in Required');
                return;
            }
            
            setUploading(true);
            try {
                const reader = new FileReader();
                reader.onload = async (e) => {
                    const base64 = e.target.result.split(',')[1];
                    
                    const fileInfo = {
                        name: file.name,
                        size: file.size,
                        lastModified: new Date().toISOString(),
                        data: base64
                    };
                    
                    await firebaseDb.ref(`command-center/${firebaseUser.uid}/projectFile`).set(fileInfo);
                    
                    setProjectFile({
                        name: file.name,
                        size: file.size,
                        lastModified: fileInfo.lastModified
                    });
                    
                    await logEntry(`Uploaded ${file.name} (${(file.size/1024).toFixed(1)}KB)`, 'upload');
                    setUploading(false);
                };
                reader.readAsDataURL(file);
            } catch (e) {
                console.error('Upload error:', e);
                showAlert('Upload failed: ' + e.message, 'Upload Error');
                setUploading(false);
            }
        };
        
        // Download gs-active.zip from Firebase
        const downloadProjectFile = async () => {
            if (!firebaseDb || !firebaseUser) {
                showAlert('Please sign in via the Firebase tab first', 'Sign-in Required');
                return;
            }
            
            setDownloading(true);
            try {
                const snapshot = await firebaseDb.ref(`command-center/${firebaseUser.uid}/projectFile`).once('value');
                const data = snapshot.val();
                
                if (!data || !data.data) {
                    showAlert('No project file found. Upload one first!', 'File Not Found');
                    setDownloading(false);
                    return;
                }
                
                const byteCharacters = atob(data.data);
                const byteNumbers = new Array(byteCharacters.length);
                for (let i = 0; i < byteCharacters.length; i++) {
                    byteNumbers[i] = byteCharacters.charCodeAt(i);
                }
                const byteArray = new Uint8Array(byteNumbers);
                const blob = new Blob([byteArray], { type: 'application/zip' });
                
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = data.name || 'gs-active.zip';
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                
                await logEntry(`Downloaded ${data.name}`, 'download');
                setDownloading(false);
            } catch (e) {
                console.error('Download error:', e);
                showAlert('Download failed: ' + e.message, 'Download Error');
                setDownloading(false);
            }
        };
        
        // Handle file drop for project upload
        const handleProjectFileDrop = (e) => {
            e.preventDefault();
            
            // Capture file BEFORE resetting input
            const file = e.dataTransfer?.files[0] || e.target.files?.[0];
            
            // Reset file input so same file can be selected again
            if (e.target && e.target.value) {
                e.target.value = '';
            }
            
            if (file && (file.name.endsWith('.zip') || file.name === 'gs-active.zip')) {
                uploadProjectFile(file);
            } else if (file) {
                showAlert('Please upload a .zip file (gs-active.zip)', 'Invalid File');
            }
        };
        
        // Log entry to Firebase
        const logEntry = async (text, type = 'note') => {
            if (!firebaseDb || !firebaseUser) return;
            
            const entry = {
                time: new Date().toISOString(),
                type,
                text
            };
            
            const today = new Date().toISOString().split('T')[0];
            await firebaseDb.ref(`command-center/${firebaseUser.uid}/logs/${today}`).push(entry);
        };
        
        // Add manual entry
        const addEntry = async () => {
            if (!newEntry.trim()) return;
            await logEntry(newEntry.trim());
            setNewEntry('');
            
            setSessionLog(prev => ({
                ...prev,
                recentEntries: [...(prev.recentEntries || []), {
                    time: new Date().toISOString(),
                    type: 'note',
                    text: newEntry.trim()
                }].slice(-20)
            }));
        };
        
        // Quick Deploy: Detect file from pasted code
        const handleCodePaste = (code) => {
            setQuickDeployCode(code);
            
            if (!code.trim()) {
                setDetectedFile(null);
                return;
            }
            
            const versionMatch = code.match(/<meta\s+name=["']version["']\s+content=["']([^"']+)["']/i);
            const titleMatch = code.match(/<title>([^<]+)<\/title>/i);
            
            const version = versionMatch?.[1] || 'unknown';
            const title = titleMatch?.[1]?.toLowerCase() || '';
            
            let matchedApp = null;
            for (const app of configuredApps) {
                const name = app.name.toLowerCase();
                if (title.includes(name) || code.toLowerCase().includes(`${name} v`)) {
                    matchedApp = app;
                    break;
                }
            }
            
            setDetectedFile({
                content: code,
                version,
                detectedApp: matchedApp,
                title: titleMatch?.[1] || 'Unknown',
                size: code.length
            });
        };
        
        // Quick Deploy
        const handleQuickDeploy = async (appId, target) => {
            if (!detectedFile || !github) return;
            
            const file = {
                id: Date.now(),
                name: 'index.html',
                content: detectedFile.content,
                version: detectedFile.version,
                targetPath: 'index.html'
            };
            
            onFileDrop([file]);
            await logEntry(`Quick deploy: ${apps[appId]?.name} v${detectedFile.version} ‚Üí ${target.toUpperCase()}`, 'deploy');
            
            setQuickDeployCode('');
            setDetectedFile(null);
        };
        
        // Generate context for Claude
        const generateContext = () => {
            const lines = [
                `# Session Context - ${new Date().toLocaleString()}`,
                ``,
                `## App Versions`,
                `| App | TEST | PROD |`,
                `|-----|------|------|`,
            ];
            configuredApps.forEach(app => {
                lines.push(`| ${app.name} | ${app.currentTestVersion || '‚Äî'} | ${app.currentProdVersion || '‚Äî'} |`);
            });
            return lines.join('\n');
        };
        
        const copyContext = async () => {
            await navigator.clipboard.writeText(generateContext());
        };
        
        // Copy Claude deploy instructions
        const copyClaudeInstructions = () => {
            const instructions = `## Deploy to Command Center

To deploy code directly to Command Center, use this Firebase write:

\`\`\`javascript
// Firebase config (already in your context)
const FIREBASE_CONFIG = {
    apiKey: "AIzaSyBUgW3EkJ3P8Zj6Gq2x7X0nR1YQ2LdW8_A",
    authDomain: "word-boxing.firebaseapp.com",
    databaseURL: "https://word-boxing-default-rtdb.firebaseio.com",
    projectId: "word-boxing"
};

// Write pending deploy
await firebase.database().ref('command-center/${firebaseUser?.uid || 'USER_UID'}/pending-deploys').push({
    code: YOUR_HTML_CODE,
    appId: 'gameshelf', // or 'quotle', 'slate', 'rungs', 'wordboxing'
    appName: 'Game Shelf',
    version: '1.0.1',
    target: 'test',
    status: 'pending',
    createdAt: new Date().toISOString()
});
\`\`\`

The deploy will appear in Command Center's Session tab for one-click deployment.`;
            
            navigator.clipboard.writeText(instructions);
        };
        
        return (
            <div className="space-y-6">
                {/* Pending Deploys from Claude */}
                {pendingDeploys.length > 0 && (
                    <div className="bg-green-900/30 border border-green-600 rounded-xl p-6 animate-pulse-slow">
                        <h2 className="text-lg font-semibold mb-4 flex items-center gap-2 text-green-300">
                            üöÄ Incoming from Claude ({pendingDeploys.length})
                        </h2>
                        <div className="space-y-3">
                            {pendingDeploys.map(deploy => (
                                <div key={deploy.id} className="p-4 bg-slate-800 rounded-lg flex items-center justify-between">
                                    <div>
                                        <div className="font-medium">{deploy.appName || deploy.appId}</div>
                                        <div className="text-sm text-slate-400">
                                            v{deploy.version} ‚Üí {deploy.target?.toUpperCase()} ‚Ä¢ 
                                            {(deploy.code?.length / 1024).toFixed(1)}KB ‚Ä¢
                                            {new Date(deploy.createdAt).toLocaleTimeString()}
                                        </div>
                                    </div>
                                    <div className="flex gap-2">
                                        <button
                                            onClick={() => rejectPendingDeploy(deploy.id)}
                                            className="px-3 py-1.5 bg-red-600 hover:bg-red-500 rounded text-sm">
                                            ‚úï Reject
                                        </button>
                                        <button
                                            onClick={() => acceptPendingDeploy(deploy)}
                                            className="px-3 py-1.5 bg-green-600 hover:bg-green-500 rounded text-sm">
                                            ‚úì Deploy
                                        </button>
                                    </div>
                                </div>
                            ))}
                        </div>
                    </div>
                )}
                
                {/* Project File (gs-active.zip) */}
                <div className="bg-indigo-900/30 border border-indigo-700 rounded-xl p-6">
                    <h2 className="text-lg font-semibold mb-4 flex items-center gap-2 text-indigo-300">
                        üì¶ Project File (gs-active.zip)
                    </h2>
                    
                    {!firebaseUser ? (
                        <div className="text-amber-400 text-sm p-3 bg-amber-900/30 rounded-lg">
                            ‚ö†Ô∏è Sign in via the Firebase tab to sync your project file
                        </div>
                    ) : (
                        <div className="space-y-4">
                            {projectFile ? (
                                <div className="p-4 bg-slate-800 rounded-lg flex items-center justify-between">
                                    <div>
                                        <div className="font-medium">{projectFile.name}</div>
                                        <div className="text-sm text-slate-400">
                                            {(projectFile.size / 1024).toFixed(1)} KB ‚Ä¢ 
                                            Updated: {new Date(projectFile.lastModified).toLocaleString()}
                                        </div>
                                    </div>
                                    <button
                                        onClick={downloadProjectFile}
                                        disabled={downloading}
                                        className="px-4 py-2 bg-green-600 hover:bg-green-500 rounded-lg flex items-center gap-2 disabled:opacity-50">
                                        {downloading ? '‚è≥' : '‚¨áÔ∏è'} Download
                                    </button>
                                </div>
                            ) : (
                                <div className="p-4 bg-slate-800 rounded-lg text-slate-400 text-center">
                                    No project file uploaded yet
                                </div>
                            )}
                            
                            <div
                                onDrop={handleProjectFileDrop}
                                onDragOver={e => e.preventDefault()}
                                className="border-2 border-dashed border-slate-600 rounded-lg p-4 text-center hover:border-indigo-500 transition-colors">
                                <input
                                    type="file"
                                    accept=".zip"
                                    onChange={handleProjectFileDrop}
                                    className="hidden"
                                    id="project-file-input"
                                />
                                <label htmlFor="project-file-input" className="cursor-pointer">
                                    {uploading ? (
                                        <span className="text-indigo-400">‚è≥ Uploading...</span>
                                    ) : (
                                        <span className="text-slate-400">
                                            üì§ Drop gs-active.zip or <span className="text-indigo-400 underline">browse</span>
                                        </span>
                                    )}
                                </label>
                            </div>
                        </div>
                    )}
                </div>
                
                {/* Claude API Integration */}
                {firebaseUser && (
                    <div className="bg-purple-900/30 border border-purple-700 rounded-xl p-6">
                        <h2 className="text-lg font-semibold mb-4 flex items-center gap-2 text-purple-300">
                            ü§ñ Claude Direct Deploy
                        </h2>
                        <p className="text-sm text-slate-400 mb-4">
                            If Claude has network access, it can push code directly here for one-click deployment.
                        </p>
                        
                        <div className="space-y-3">
                            <div className="p-3 bg-slate-800 rounded-lg">
                                <div className="text-xs text-slate-500 mb-1">Your Firebase UID (for Claude):</div>
                                <code className="text-sm text-purple-300 break-all">{firebaseUser.uid}</code>
                            </div>
                            
                            <button
                                onClick={copyClaudeInstructions}
                                className="w-full px-4 py-2 bg-purple-600 hover:bg-purple-500 rounded-lg text-sm">
                                üìã Copy Instructions for Claude
                            </button>
                        </div>
                    </div>
                )}
                
                {/* Quick Deploy */}
                <div className="bg-slate-800 rounded-xl border border-slate-700 p-6">
                    <h2 className="text-lg font-semibold mb-4 flex items-center gap-2">
                        ‚ö° Quick Deploy (Paste Code)
                    </h2>
                    <textarea
                        value={quickDeployCode}
                        onChange={e => handleCodePaste(e.target.value)}
                        placeholder="Paste HTML code from Claude here..."
                        className="w-full h-24 p-3 bg-slate-900 border border-slate-600 rounded-lg text-sm font-mono mb-3"
                    />
                    
                    {detectedFile && (
                        <div className="p-4 bg-slate-700/50 rounded-lg space-y-3">
                            <div className="flex items-center justify-between">
                                <div>
                                    <div className="font-medium">{detectedFile.title}</div>
                                    <div className="text-sm text-slate-400">
                                        v{detectedFile.version} ‚Ä¢ {(detectedFile.size / 1024).toFixed(1)}KB
                                    </div>
                                </div>
                                {detectedFile.detectedApp && (
                                    <span className="px-2 py-1 bg-green-900/50 text-green-400 rounded text-sm">
                                        ‚úì {detectedFile.detectedApp.name}
                                    </span>
                                )}
                            </div>
                            
                            <div className="flex flex-wrap gap-2">
                                {configuredApps.map(app => (
                                    <button
                                        key={app.id}
                                        onClick={() => handleQuickDeploy(app.id, 'test')}
                                        className={`px-3 py-1.5 rounded text-sm ${
                                            detectedFile.detectedApp?.id === app.id 
                                                ? 'bg-blue-600 hover:bg-blue-500' 
                                                : 'bg-slate-600 hover:bg-slate-500'
                                        }`}>
                                        <AppIcon icon={app.icon} size={16} /> {app.name} ‚Üí TEST
                                    </button>
                                ))}
                            </div>
                        </div>
                    )}
                </div>
                
                {/* Activity Log */}
                <div className="bg-slate-800 rounded-xl border border-slate-700 p-6">
                    <div className="flex items-center justify-between mb-4">
                        <h2 className="text-lg font-semibold">üìã Activity Log</h2>
                        <button onClick={copyContext} className="px-3 py-1 bg-indigo-600 hover:bg-indigo-500 rounded text-sm">
                            üìã Copy Context
                        </button>
                    </div>
                    
                    <div className="flex gap-2 mb-4">
                        <input
                            value={newEntry}
                            onChange={e => setNewEntry(e.target.value)}
                            onKeyDown={e => e.key === 'Enter' && addEntry()}
                            placeholder="Log a note..."
                            className="flex-1 p-2 bg-slate-900 border border-slate-600 rounded text-sm"
                        />
                        <button onClick={addEntry} className="px-4 bg-indigo-600 hover:bg-indigo-500 rounded">
                            + Log
                        </button>
                    </div>
                    
                    {sessionLog.recentEntries?.length > 0 && (
                        <div className="space-y-1 max-h-32 overflow-y-auto">
                            {[...sessionLog.recentEntries].reverse().map((e, i) => (
                                <div key={i} className="text-sm flex items-center gap-2">
                                    <span className="text-xs text-slate-500 w-16">
                                        {new Date(e.time).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}
                                    </span>
                                    <span className={
                                        e.type === 'deploy' ? 'text-green-400' : 
                                        e.type === 'upload' ? 'text-blue-400' : ''
                                    }>
                                        {e.text}
                                    </span>
                                </div>
                            ))}
                        </div>
                    )}
                </div>
                
                {/* Current Versions */}
                <div className="bg-slate-800 rounded-xl border border-slate-700 p-6">
                    <h2 className="text-lg font-semibold mb-4">üìä Current Versions</h2>
                    <table className="w-full text-sm">
                        <thead>
                            <tr className="border-b border-slate-700">
                                <th className="text-left p-2">App</th>
                                <th className="text-center p-2">TEST</th>
                                <th className="text-center p-2">PROD</th>
                                <th className="text-center p-2">Sync</th>
                            </tr>
                        </thead>
                        <tbody>
                            {configuredApps.map(app => (
                                <tr key={app.id} className="border-b border-slate-700/50">
                                    <td className="p-2"><span className="inline-flex items-center gap-1"><AppIcon icon={app.icon} size={16} /> {app.name}</span></td>
                                    <td className="p-2 text-center font-mono text-blue-400">{app.currentTestVersion || '‚Äî'}</td>
                                    <td className="p-2 text-center font-mono text-green-400">{app.currentProdVersion || '‚Äî'}</td>
                                    <td className="p-2 text-center">
                                        {app.currentTestVersion === app.currentProdVersion 
                                            ? <span className="text-green-400">‚úì</span>
                                            : <span className="text-amber-400">‚ö†Ô∏è</span>
                                        }
                                    </td>
                                </tr>
                            ))}
                        </tbody>
                    </table>
                </div>
                
                {/* Testing & Issues */}
                <div className="bg-slate-800 rounded-xl border border-slate-700 p-6">
                    <h2 className="text-lg font-semibold mb-4">üß™ Testing & Issues</h2>
                    
                    <div className="grid grid-cols-2 md:grid-cols-4 gap-3 mb-4">
                        <a href="https://stewartdavidp-ship-it.github.io/gameshelf-testplan/" 
                           target="_blank"
                           className="p-3 bg-indigo-900/30 border border-indigo-700 rounded-lg text-center hover:bg-indigo-900/50 transition-colors">
                            <div className="text-2xl mb-1">üìã</div>
                            <div className="text-sm">Test Plan</div>
                        </a>
                        <a href="https://stewartdavidp-ship-it.github.io/gameshelf-testplan/issue-tracker.html" 
                           target="_blank"
                           className="p-3 bg-red-900/30 border border-red-700 rounded-lg text-center hover:bg-red-900/50 transition-colors">
                            <div className="text-2xl mb-1">üêõ</div>
                            <div className="text-sm">Issue Tracker</div>
                        </a>
                        <a href="https://stewartdavidp-ship-it.github.io/gameshelftest/" 
                           target="_blank"
                           className="p-3 bg-blue-900/30 border border-blue-700 rounded-lg text-center hover:bg-blue-900/50 transition-colors">
                            <div className="text-2xl mb-1">üß™</div>
                            <div className="text-sm">TEST Site</div>
                        </a>
                        <a href="https://stewartdavidp-ship-it.github.io/gameshelf/" 
                           target="_blank"
                           className="p-3 bg-green-900/30 border border-green-700 rounded-lg text-center hover:bg-green-900/50 transition-colors">
                            <div className="text-2xl mb-1">üöÄ</div>
                            <div className="text-sm">PROD Site</div>
                        </a>
                    </div>
                    
                    <div className="text-xs text-slate-500 bg-slate-900/50 rounded-lg p-3">
                        <div className="font-medium text-slate-400 mb-2">Test ‚Üí Fix Workflow:</div>
                        <ol className="list-decimal list-inside space-y-1">
                            <li>Run tests in Test Plan ‚Üí Issues logged to tracker</li>
                            <li>Click issue ‚Üí Copy details for Claude</li>
                            <li>Claude fixes ‚Üí Quick Deploy to TEST</li>
                            <li>Re-test ‚Üí Promote to PROD when passing</li>
                        </ol>
                    </div>
                </div>
            </div>
        );
    }

    // =========================================================================
    // ISSUES VIEW - Full Issue Tracking & Release Management
    // =========================================================================
    
    function IssuesView({ apps, deployments, showAlert, showConfirm, showPrompt }) {
        const [issues, setIssues] = React.useState([]);
        const [releases, setReleases] = React.useState([]);
        const [userReports, setUserReports] = React.useState([]);
        const [userReportsExpanded, setUserReportsExpanded] = React.useState(true);
        const [firebaseUser, setFirebaseUser] = React.useState(null);
        const [loading, setLoading] = React.useState(true);
        const [showNewIssue, setShowNewIssue] = React.useState(false);
        const [selectedIssue, setSelectedIssue] = React.useState(null);
        const [selectedUserReport, setSelectedUserReport] = React.useState(null);
        const [filter, setFilter] = React.useState('open'); // 'all', 'open', 'fixed', 'verified', 'closed'
        const [appFilter, setAppFilter] = React.useState('all');
        
        const configuredApps = Object.values(apps).filter(a => a.testRepo || a.prodRepo);
        
        // Listen for Firebase auth
        React.useEffect(() => {
            if (!firebaseAuth) return;
            const unsubscribe = firebaseAuth.onAuthStateChanged((u) => {
                setFirebaseUser(u);
                if (u) {
                    loadIssues(u.uid);
                    loadReleases(u.uid);
                    loadUserReports(); // Load user-submitted reports
                }
            });
            return () => unsubscribe();
        }, []);
        
        // Load user-reported issues from Game Shelf
        const loadUserReports = () => {
            if (!firebaseDb) return;
            try {
                const ref = firebaseDb.ref('reported-issues');
                ref.on('value', (snapshot) => {
                    const data = snapshot.val();
                    if (data) {
                        const list = Object.entries(data).map(([id, report]) => ({ 
                            firebaseKey: id, 
                            ...report 
                        }));
                        // Sort by timestamp, newest first
                        setUserReports(list.sort((a, b) => 
                            new Date(b.timestamp || b.createdAt || 0) - new Date(a.timestamp || a.createdAt || 0)
                        ));
                    } else {
                        setUserReports([]);
                    }
                });
            } catch (e) {
                console.error('Error loading user reports:', e);
            }
        };
        
        // Load issues from Firebase
        const loadIssues = async (uid) => {
            if (!firebaseDb) return;
            setLoading(true);
            try {
                const ref = firebaseDb.ref(`command-center/${uid}/issues`);
                ref.on('value', (snapshot) => {
                    const data = snapshot.val();
                    if (data) {
                        const list = Object.entries(data).map(([id, issue]) => ({ id, ...issue }));
                        setIssues(list.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt)));
                    } else {
                        setIssues([]);
                    }
                    setLoading(false);
                });
            } catch (e) {
                console.error('Error loading issues:', e);
                setLoading(false);
            }
        };
        
        // Load releases from Firebase
        const loadReleases = async (uid) => {
            if (!firebaseDb) return;
            try {
                const ref = firebaseDb.ref(`command-center/${uid}/releases`);
                ref.on('value', (snapshot) => {
                    const data = snapshot.val();
                    if (data) {
                        const list = Object.entries(data).map(([id, rel]) => ({ id, ...rel }));
                        setReleases(list.sort((a, b) => new Date(b.deployedAt) - new Date(a.deployedAt)));
                    } else {
                        setReleases([]);
                    }
                });
            } catch (e) {
                console.error('Error loading releases:', e);
            }
        };
        
        // Generate next issue ID
        const getNextIssueId = () => {
            const existing = issues.map(i => parseInt(i.id?.replace('ISS-', '') || 0));
            const max = Math.max(0, ...existing);
            return `ISS-${String(max + 1).padStart(3, '0')}`;
        };
        
        // Create new issue
        const createIssue = async (issueData) => {
            if (!firebaseDb || !firebaseUser) return;
            
            const id = getNextIssueId();
            const issue = {
                ...issueData,
                id,
                status: 'open',
                createdAt: new Date().toISOString(),
                createdBy: 'manual',
                notes: []
            };
            
            await firebaseDb.ref(`command-center/${firebaseUser.uid}/issues/${id}`).set(issue);
            setShowNewIssue(false);
        };
        
        // Update issue status
        const updateIssueStatus = async (issueId, newStatus, extraData = {}) => {
            if (!firebaseDb || !firebaseUser) return;
            
            const updates = {
                status: newStatus,
                [`${newStatus}At`]: new Date().toISOString(),
                ...extraData
            };
            
            await firebaseDb.ref(`command-center/${firebaseUser.uid}/issues/${issueId}`).update(updates);
        };
        
        // Link issue to version (when deploying fix)
        const linkIssueToVersion = async (issueId, version, app) => {
            if (!firebaseDb || !firebaseUser) return;
            
            await firebaseDb.ref(`command-center/${firebaseUser.uid}/issues/${issueId}`).update({
                status: 'fixed',
                fixedAt: new Date().toISOString(),
                fixedInVersion: version,
                fixedInApp: app
            });
        };
        
        // Generate "Copy for Claude" text
        const copyForClaude = (issue) => {
            const text = `## Issue ${issue.id}: ${issue.title}

**App:** ${issue.app}
**Severity:** ${issue.severity}
**Status:** ${issue.status}

### Description
${issue.description}

### Steps to Reproduce
${issue.stepsToReproduce?.map((s, i) => `${i + 1}. ${s}`).join('\n') || 'N/A'}

### Expected Behavior
${issue.expected || 'N/A'}

### Actual Behavior
${issue.actual || 'N/A'}

---
When you fix this, please note: "Fixes ${issue.id}" in the code or deploy notes.`;
            
            navigator.clipboard.writeText(text);
        };
        
        // Get issues ready for release (fixed in TEST, not yet in PROD)
        const getIssuesForRelease = (app) => {
            return issues.filter(i => 
                i.app === app && 
                (i.status === 'fixed' || i.status === 'verified') &&
                !i.releasedToProd
            );
        };
        
        // Generate release notes
        const generateReleaseNotes = (app) => {
            const releaseIssues = getIssuesForRelease(app);
            const appInfo = configuredApps.find(a => a.id === app);
            const version = appInfo?.currentTestVersion || '?.?.?';
            
            const notes = `# ${appInfo?.name || app} v${version} Release Notes

## What's New

${releaseIssues.map(i => `- **${i.id}**: ${i.title}`).join('\n') || 'No tracked issues in this release.'}

## Details

${releaseIssues.map(i => `### ${i.id}: ${i.title}
${i.description}
`).join('\n')}

---
Released: ${new Date().toLocaleDateString()}
`;
            return notes;
        };
        
        // Mark issues as released to PROD
        const markReleasedToProd = async (app) => {
            if (!firebaseDb || !firebaseUser) return;
            
            const releaseIssues = getIssuesForRelease(app);
            const appInfo = configuredApps.find(a => a.id === app);
            const version = appInfo?.currentTestVersion;
            
            // Update each issue
            for (const issue of releaseIssues) {
                await firebaseDb.ref(`command-center/${firebaseUser.uid}/issues/${issue.id}`).update({
                    status: 'closed',
                    closedAt: new Date().toISOString(),
                    releasedToProd: true,
                    releasedInVersion: version
                });
            }
            
            // Create release record
            const releaseId = `${app}-${version}-${Date.now()}`;
            await firebaseDb.ref(`command-center/${firebaseUser.uid}/releases/${releaseId}`).set({
                app,
                version,
                deployedAt: new Date().toISOString(),
                issues: releaseIssues.map(i => i.id),
                environment: 'prod'
            });
            
            // Copy release notes
            navigator.clipboard.writeText(generateReleaseNotes(app));
            showAlert('Release notes copied to clipboard!', 'Copied');
        };
        
        // Convert user report to tracked issue
        const convertToTrackedIssue = async (report) => {
            if (!firebaseDb || !firebaseUser) return;
            
            const id = getNextIssueId();
            const issue = {
                id,
                title: report.title || report.description?.substring(0, 50) || 'User reported issue',
                description: report.description || '',
                app: report.section || 'gameshelf',
                severity: report.severity || 'medium',
                status: 'open',
                createdAt: new Date().toISOString(),
                createdBy: 'user-report',
                originalReport: {
                    firebaseKey: report.firebaseKey,
                    type: report.type,
                    section: report.section,
                    userAgent: report.userAgent,
                    appVersion: report.appVersion,
                    timestamp: report.timestamp,
                    screenshot: report.screenshot
                },
                stepsToReproduce: [],
                expected: '',
                actual: report.description || ''
            };
            
            await firebaseDb.ref(`command-center/${firebaseUser.uid}/issues/${id}`).set(issue);
            
            // Mark original report as converted
            await firebaseDb.ref(`reported-issues/${report.firebaseKey}`).update({
                convertedToIssue: id,
                convertedAt: new Date().toISOString()
            });
            
            setSelectedUserReport(null);
        };
        
        // Dismiss user report (archive without tracking)
        const dismissUserReport = async (report) => {
            if (!firebaseDb) return;
            
            await firebaseDb.ref(`reported-issues/${report.firebaseKey}`).update({
                dismissed: true,
                dismissedAt: new Date().toISOString()
            });
        };
        
        // Delete user report permanently
        const deleteUserReport = async (report) => {
            if (!firebaseDb) return;
            const confirmed = await showConfirm('Permanently delete this report?', 'Confirm Delete');
            if (!confirmed) return;
            
            await firebaseDb.ref(`reported-issues/${report.firebaseKey}`).remove();
        };
        
        // Get active (non-dismissed, non-converted) user reports
        const activeUserReports = userReports.filter(r => !r.dismissed && !r.convertedToIssue);
        
        // Filter issues
        const filteredIssues = issues.filter(i => {
            if (filter !== 'all' && i.status !== filter) return false;
            if (appFilter !== 'all' && i.app !== appFilter) return false;
            return true;
        });
        
        // Status badge
        const StatusBadge = ({ status }) => {
            const colors = {
                open: 'bg-red-900/50 text-red-300 border-red-700',
                'in-progress': 'bg-yellow-900/50 text-yellow-300 border-yellow-700',
                fixed: 'bg-blue-900/50 text-blue-300 border-blue-700',
                verified: 'bg-green-900/50 text-green-300 border-green-700',
                closed: 'bg-slate-700 text-slate-400 border-slate-600'
            };
            return (
                <span className={`px-2 py-0.5 rounded border text-xs ${colors[status] || colors.open}`}>
                    {status}
                </span>
            );
        };
        
        // Severity badge
        const SeverityBadge = ({ severity }) => {
            const colors = {
                critical: 'text-red-400',
                high: 'text-orange-400',
                medium: 'text-yellow-400',
                low: 'text-slate-400'
            };
            const icons = { critical: 'üî¥', high: 'üü†', medium: 'üü°', low: '‚ö™' };
            return <span className={colors[severity]}>{icons[severity]} {severity}</span>;
        };
        
        if (!firebaseUser) {
            return (
                <div className="bg-amber-900/30 border border-amber-700 rounded-xl p-6 text-center">
                    <div className="text-amber-400 mb-2">‚ö†Ô∏è Sign in Required</div>
                    <div className="text-sm text-slate-400">Go to the Firebase tab to sign in and enable issue tracking.</div>
                </div>
            );
        }
        
        return (
            <div className="space-y-6">
                {/* Header & Stats */}
                <div className="flex items-center justify-between">
                    <div>
                        <h2 className="text-xl font-bold">üêõ Issue Tracker</h2>
                        <div className="text-sm text-slate-400">
                            {issues.filter(i => i.status === 'open').length} open ‚Ä¢ 
                            {issues.filter(i => i.status === 'fixed').length} fixed ‚Ä¢ 
                            {issues.filter(i => i.status === 'verified').length} verified
                            {activeUserReports.length > 0 && (
                                <span className="text-orange-400"> ‚Ä¢ {activeUserReports.length} user reports</span>
                            )}
                        </div>
                    </div>
                    <button
                        onClick={() => setShowNewIssue(true)}
                        className="px-4 py-2 bg-red-600 hover:bg-red-500 rounded-lg flex items-center gap-2">
                        + New Issue
                    </button>
                </div>
                
                {/* Filters */}
                <div className="flex gap-2 flex-wrap">
                    {['all', 'open', 'in-progress', 'fixed', 'verified', 'closed'].map(f => (
                        <button
                            key={f}
                            onClick={() => setFilter(f)}
                            className={`px-3 py-1 rounded text-sm ${filter === f ? 'bg-indigo-600' : 'bg-slate-700 hover:bg-slate-600'}`}>
                            {f}
                        </button>
                    ))}
                    <select
                        value={appFilter}
                        onChange={e => setAppFilter(e.target.value)}
                        className="px-3 py-1 rounded text-sm bg-slate-700 border-none">
                        <option value="all">All Apps</option>
                        {configuredApps.map(app => (
                            <option key={app.id} value={app.id}>{app.name}</option>
                        ))}
                    </select>
                </div>
                
                {/* User-Reported Issues Section */}
                {activeUserReports.length > 0 && (
                    <div className="bg-orange-900/30 border border-orange-700 rounded-xl overflow-hidden">
                        <button 
                            onClick={() => setUserReportsExpanded(!userReportsExpanded)}
                            className="w-full p-4 flex items-center justify-between hover:bg-orange-900/20 transition-colors"
                        >
                            <div className="flex items-center gap-3">
                                <span className="text-2xl">üì¨</span>
                                <div className="text-left">
                                    <div className="font-semibold text-orange-300">
                                        {activeUserReports.length} User Report{activeUserReports.length !== 1 ? 's' : ''} Pending
                                    </div>
                                    <div className="text-sm text-slate-400">
                                        Submitted from Game Shelf app
                                    </div>
                                </div>
                            </div>
                            <span className="text-xl">{userReportsExpanded ? '‚ñº' : '‚ñ∂'}</span>
                        </button>
                        
                        {userReportsExpanded && (
                            <div className="border-t border-orange-800 p-4 space-y-3">
                                {activeUserReports.slice(0, 10).map(report => (
                                    <div key={report.firebaseKey} className="bg-slate-800 rounded-lg p-4 border border-slate-700">
                                        <div className="flex items-start justify-between gap-4">
                                            <div className="flex-1 min-w-0">
                                                <div className="flex items-center gap-2 mb-1 flex-wrap">
                                                    <span className={`px-2 py-0.5 rounded text-xs ${
                                                        report.type === 'bug' ? 'bg-red-900/50 text-red-300' :
                                                        report.type === 'feature' ? 'bg-blue-900/50 text-blue-300' :
                                                        report.type === 'ux' ? 'bg-purple-900/50 text-purple-300' :
                                                        'bg-slate-700 text-slate-300'
                                                    }`}>
                                                        {report.type === 'bug' && 'üêõ'}
                                                        {report.type === 'feature' && 'üí°'}
                                                        {report.type === 'ux' && 'üé®'}
                                                        {report.type === 'other' && 'üìù'}
                                                        {' '}{report.type || 'report'}
                                                    </span>
                                                    {report.section && (
                                                        <span className="px-2 py-0.5 rounded text-xs bg-slate-700 text-slate-300">
                                                            üìç {report.section}
                                                        </span>
                                                    )}
                                                    {report.severity && (
                                                        <span className={`px-2 py-0.5 rounded text-xs ${
                                                            report.severity === 'critical' ? 'bg-red-900 text-red-200' :
                                                            report.severity === 'major' ? 'bg-orange-900 text-orange-200' :
                                                            report.severity === 'minor' ? 'bg-yellow-900 text-yellow-200' :
                                                            'bg-slate-700 text-slate-300'
                                                        }`}>
                                                            {report.severity}
                                                        </span>
                                                    )}
                                                    {report.appVersion && (
                                                        <span className="text-xs text-slate-500">
                                                            v{report.appVersion}
                                                        </span>
                                                    )}
                                                </div>
                                                <div className="font-medium truncate">
                                                    {report.title || report.description?.substring(0, 60) || 'No description'}
                                                </div>
                                                {report.description && report.title && (
                                                    <div className="text-sm text-slate-400 mt-1 line-clamp-2">
                                                        {report.description}
                                                    </div>
                                                )}
                                                <div className="text-xs text-slate-500 mt-2">
                                                    üìÖ {new Date(report.timestamp || report.createdAt).toLocaleString()}
                                                </div>
                                            </div>
                                            <div className="flex flex-col gap-1">
                                                <button
                                                    onClick={() => setSelectedUserReport(report)}
                                                    className="px-3 py-1.5 bg-slate-700 hover:bg-slate-600 rounded text-xs whitespace-nowrap"
                                                >
                                                    üëÅÔ∏è View
                                                </button>
                                                <button
                                                    onClick={() => convertToTrackedIssue(report)}
                                                    className="px-3 py-1.5 bg-indigo-600 hover:bg-indigo-500 rounded text-xs whitespace-nowrap"
                                                >
                                                    ‚ûï Track
                                                </button>
                                                <button
                                                    onClick={() => dismissUserReport(report)}
                                                    className="px-3 py-1.5 bg-slate-800 hover:bg-slate-700 rounded text-xs text-slate-400 whitespace-nowrap"
                                                >
                                                    ‚úï Dismiss
                                                </button>
                                            </div>
                                        </div>
                                        {report.screenshot && (
                                            <div className="mt-3 pt-3 border-t border-slate-700">
                                                <img 
                                                    src={report.screenshot} 
                                                    alt="Screenshot" 
                                                    className="max-h-32 rounded cursor-pointer hover:opacity-80"
                                                    onClick={() => window.open(report.screenshot, '_blank')}
                                                />
                                            </div>
                                        )}
                                    </div>
                                ))}
                                {activeUserReports.length > 10 && (
                                    <div className="text-center text-sm text-slate-400">
                                        + {activeUserReports.length - 10} more reports
                                    </div>
                                )}
                            </div>
                        )}
                    </div>
                )}
                
                {/* User Report Detail Modal */}
                {selectedUserReport && (
                    <div className="fixed inset-0 bg-black/70 flex items-center justify-center z-50 p-4" onClick={() => setSelectedUserReport(null)}>
                        <div className="bg-slate-800 rounded-xl border border-slate-600 w-full max-w-2xl max-h-[90vh] overflow-y-auto" onClick={e => e.stopPropagation()}>
                            <div className="p-6 border-b border-slate-700 flex items-center justify-between">
                                <h3 className="text-lg font-semibold">üì¨ User Report</h3>
                                <button onClick={() => setSelectedUserReport(null)} className="text-slate-400 hover:text-white">‚úï</button>
                            </div>
                            <div className="p-6 space-y-4">
                                <div className="flex flex-wrap gap-2">
                                    <span className={`px-3 py-1 rounded ${
                                        selectedUserReport.type === 'bug' ? 'bg-red-900/50 text-red-300' :
                                        selectedUserReport.type === 'feature' ? 'bg-blue-900/50 text-blue-300' :
                                        'bg-slate-700'
                                    }`}>
                                        {selectedUserReport.type || 'report'}
                                    </span>
                                    {selectedUserReport.section && (
                                        <span className="px-3 py-1 rounded bg-slate-700">üìç {selectedUserReport.section}</span>
                                    )}
                                    {selectedUserReport.severity && (
                                        <span className="px-3 py-1 rounded bg-slate-700">{selectedUserReport.severity}</span>
                                    )}
                                </div>
                                
                                {selectedUserReport.title && (
                                    <div>
                                        <div className="text-sm text-slate-400 mb-1">Title</div>
                                        <div className="font-medium">{selectedUserReport.title}</div>
                                    </div>
                                )}
                                
                                <div>
                                    <div className="text-sm text-slate-400 mb-1">Description</div>
                                    <div className="bg-slate-900 rounded p-3 whitespace-pre-wrap">
                                        {selectedUserReport.description || 'No description provided'}
                                    </div>
                                </div>
                                
                                {selectedUserReport.screenshot && (
                                    <div>
                                        <div className="text-sm text-slate-400 mb-1">Screenshot</div>
                                        <img 
                                            src={selectedUserReport.screenshot} 
                                            alt="Screenshot" 
                                            className="max-w-full rounded cursor-pointer"
                                            onClick={() => window.open(selectedUserReport.screenshot, '_blank')}
                                        />
                                    </div>
                                )}
                                
                                <div className="grid grid-cols-2 gap-4 text-sm">
                                    <div>
                                        <div className="text-slate-400">Submitted</div>
                                        <div>{new Date(selectedUserReport.timestamp || selectedUserReport.createdAt).toLocaleString()}</div>
                                    </div>
                                    <div>
                                        <div className="text-slate-400">App Version</div>
                                        <div>{selectedUserReport.appVersion || 'Unknown'}</div>
                                    </div>
                                </div>
                                
                                {selectedUserReport.userAgent && (
                                    <div>
                                        <div className="text-sm text-slate-400 mb-1">Device/Browser</div>
                                        <div className="text-xs bg-slate-900 rounded p-2 font-mono break-all">
                                            {selectedUserReport.userAgent}
                                        </div>
                                    </div>
                                )}
                            </div>
                            <div className="p-6 border-t border-slate-700 flex gap-3">
                                <button
                                    onClick={() => convertToTrackedIssue(selectedUserReport)}
                                    className="flex-1 px-4 py-2 bg-indigo-600 hover:bg-indigo-500 rounded-lg"
                                >
                                    ‚ûï Convert to Tracked Issue
                                </button>
                                <button
                                    onClick={() => { dismissUserReport(selectedUserReport); setSelectedUserReport(null); }}
                                    className="px-4 py-2 bg-slate-700 hover:bg-slate-600 rounded-lg"
                                >
                                    Dismiss
                                </button>
                                <button
                                    onClick={() => { deleteUserReport(selectedUserReport); setSelectedUserReport(null); }}
                                    className="px-4 py-2 bg-red-900 hover:bg-red-800 rounded-lg"
                                >
                                    üóëÔ∏è
                                </button>
                            </div>
                        </div>
                    </div>
                )}
                
                {/* Release Ready Banner */}
                {configuredApps.map(app => {
                    const ready = getIssuesForRelease(app.id);
                    if (ready.length === 0) return null;
                    return (
                        <div key={app.id} className="bg-green-900/30 border border-green-700 rounded-xl p-4 flex items-center justify-between">
                            <div>
                                <div className="font-medium text-green-300 flex items-center gap-1">
                                    <AppIcon icon={app.icon} size={18} /> {app.name}: {ready.length} issue{ready.length !== 1 ? 's' : ''} ready for PROD
                                </div>
                                <div className="text-sm text-slate-400">
                                    {ready.map(i => i.id).join(', ')}
                                </div>
                            </div>
                            <div className="flex gap-2">
                                <button
                                    onClick={() => navigator.clipboard.writeText(generateReleaseNotes(app.id))}
                                    className="px-3 py-1.5 bg-slate-700 hover:bg-slate-600 rounded text-sm">
                                    üìã Copy Notes
                                </button>
                                <button
                                    onClick={() => markReleasedToProd(app.id)}
                                    className="px-3 py-1.5 bg-green-600 hover:bg-green-500 rounded text-sm">
                                    üöÄ Mark Released
                                </button>
                            </div>
                        </div>
                    );
                })}
                
                {/* Issues List */}
                <div className="space-y-3">
                    {loading ? (
                        <div className="text-center text-slate-400 py-8">Loading issues...</div>
                    ) : filteredIssues.length === 0 ? (
                        <div className="text-center text-slate-400 py-8">No issues found</div>
                    ) : (
                        filteredIssues.map(issue => (
                            <div
                                key={issue.id}
                                className="bg-slate-800 border border-slate-700 rounded-lg p-4 hover:border-slate-600 transition-colors">
                                <div className="flex items-start justify-between gap-4">
                                    <div className="flex-1">
                                        <div className="flex items-center gap-2 mb-1">
                                            <span className="font-mono text-sm text-indigo-400">{issue.id}</span>
                                            <StatusBadge status={issue.status} />
                                            <SeverityBadge severity={issue.severity} />
                                        </div>
                                        <div className="font-medium">{issue.title}</div>
                                        <div className="text-sm text-slate-400 mt-1">
                                            {issue.app && <span className="mr-3">üì± {configuredApps.find(a => a.id === issue.app)?.name || issue.app}</span>}
                                            <span>üìÖ {new Date(issue.createdAt).toLocaleDateString()}</span>
                                            {issue.fixedInVersion && <span className="ml-3 text-blue-400">üîß Fixed in v{issue.fixedInVersion}</span>}
                                        </div>
                                    </div>
                                    <div className="flex gap-1">
                                        <button
                                            onClick={() => copyForClaude(issue)}
                                            className="px-2 py-1 bg-purple-600 hover:bg-purple-500 rounded text-xs"
                                            title="Copy for Claude">
                                            ü§ñ
                                        </button>
                                        <button
                                            onClick={() => setSelectedIssue(issue)}
                                            className="px-2 py-1 bg-slate-700 hover:bg-slate-600 rounded text-xs">
                                            Edit
                                        </button>
                                    </div>
                                </div>
                                
                                {/* Quick status buttons */}
                                <div className="flex gap-2 mt-3 pt-3 border-t border-slate-700">
                                    {issue.status === 'open' && (
                                        <button
                                            onClick={() => updateIssueStatus(issue.id, 'in-progress')}
                                            className="px-2 py-1 bg-yellow-700 hover:bg-yellow-600 rounded text-xs">
                                            Start Working
                                        </button>
                                    )}
                                    {(issue.status === 'open' || issue.status === 'in-progress') && (
                                        <button
                                            onClick={async () => {
                                                const version = await showPrompt('Fixed in version:', '', 'Enter Version');
                                                if (version) linkIssueToVersion(issue.id, version, issue.app);
                                            }}
                                            className="px-2 py-1 bg-blue-700 hover:bg-blue-600 rounded text-xs">
                                            Mark Fixed
                                        </button>
                                    )}
                                    {issue.status === 'fixed' && (
                                        <button
                                            onClick={() => updateIssueStatus(issue.id, 'verified')}
                                            className="px-2 py-1 bg-green-700 hover:bg-green-600 rounded text-xs">
                                            ‚úì Verify Fixed
                                        </button>
                                    )}
                                </div>
                            </div>
                        ))
                    )}
                </div>
                
                {/* Recent Releases */}
                {releases.length > 0 && (
                    <div className="bg-slate-800 rounded-xl border border-slate-700 p-6">
                        <h3 className="text-lg font-semibold mb-4">üì¶ Recent Releases</h3>
                        <div className="space-y-2">
                            {releases.slice(0, 5).map(rel => (
                                <div key={rel.id} className="flex items-center justify-between p-3 bg-slate-700/50 rounded-lg">
                                    <div>
                                        <span className="font-medium">{configuredApps.find(a => a.id === rel.app)?.name || rel.app}</span>
                                        <span className="ml-2 font-mono text-green-400">v{rel.version}</span>
                                        <span className="ml-2 text-xs text-slate-400">‚Üí {rel.environment?.toUpperCase()}</span>
                                    </div>
                                    <div className="text-sm text-slate-400">
                                        {rel.issues?.length || 0} issues ‚Ä¢ {new Date(rel.deployedAt).toLocaleDateString()}
                                    </div>
                                </div>
                            ))}
                        </div>
                    </div>
                )}
                
                {/* Test Plan Integration */}
                {firebaseUser && (
                    <div className="bg-purple-900/30 border border-purple-700 rounded-xl p-6">
                        <h3 className="text-lg font-semibold mb-4 flex items-center gap-2 text-purple-300">
                            üß™ Test Plan Integration
                        </h3>
                        <p className="text-sm text-slate-400 mb-4">
                            The Test Plan app can automatically push issues here when tests fail.
                        </p>
                        
                        <div className="space-y-3">
                            <div className="p-3 bg-slate-800 rounded-lg">
                                <div className="text-xs text-slate-500 mb-1">Firebase Path:</div>
                                <code className="text-sm text-purple-300 break-all">
                                    command-center/{firebaseUser.uid}/issues/
                                </code>
                            </div>
                            
                            <details className="bg-slate-800 rounded-lg">
                                <summary className="p-3 cursor-pointer text-sm font-medium">
                                    üìã Test Plan Integration Code
                                </summary>
                                <pre className="p-3 text-xs overflow-auto border-t border-slate-700 bg-slate-900">
{`// Add to Test Plan - Push issue when test fails
const pushIssueToCommandCenter = async (testResult) => {
  const uid = '${firebaseUser.uid}';
  const issueId = 'ISS-' + String(Date.now()).slice(-6);
  
  await firebase.database()
    .ref(\`command-center/\${uid}/issues/\${issueId}\`)
    .set({
      id: issueId,
      title: testResult.testName + ' failed',
      description: testResult.error || 'Test failed',
      app: testResult.appId, // 'gameshelf', 'quotle', etc
      severity: testResult.critical ? 'high' : 'medium',
      status: 'open',
      createdAt: new Date().toISOString(),
      createdBy: 'test-plan',
      stepsToReproduce: testResult.steps || [],
      expected: testResult.expected,
      actual: testResult.actual,
      testId: testResult.testId
    });
};`}
                                </pre>
                            </details>
                            
                            <div className="flex gap-2">
                                <a href="https://stewartdavidp-ship-it.github.io/gameshelf-testplan/"
                                   target="_blank"
                                   className="flex-1 px-4 py-2 bg-indigo-600 hover:bg-indigo-500 rounded-lg text-center text-sm">
                                    üìã Open Test Plan
                                </a>
                                <a href="https://stewartdavidp-ship-it.github.io/gameshelf-testplan/issue-tracker.html"
                                   target="_blank"
                                   className="flex-1 px-4 py-2 bg-slate-700 hover:bg-slate-600 rounded-lg text-center text-sm">
                                    üêõ Legacy Tracker
                                </a>
                            </div>
                        </div>
                    </div>
                )}
                
                {/* New Issue Modal */}
                {showNewIssue && (
                    <NewIssueModal
                        apps={configuredApps}
                        onSave={createIssue}
                        onCancel={() => setShowNewIssue(false)}
                    />
                )}
                
                {/* Edit Issue Modal */}
                {selectedIssue && (
                    <EditIssueModal
                        issue={selectedIssue}
                        apps={configuredApps}
                        onSave={async (updated) => {
                            await firebaseDb.ref(`command-center/${firebaseUser.uid}/issues/${updated.id}`).update(updated);
                            setSelectedIssue(null);
                        }}
                        onCancel={() => setSelectedIssue(null)}
                    />
                )}
            </div>
        );
    }
    
    // New Issue Modal
    function NewIssueModal({ apps, onSave, onCancel }) {
        const [title, setTitle] = React.useState('');
        const [description, setDescription] = React.useState('');
        const [app, setApp] = React.useState(apps[0]?.id || '');
        const [severity, setSeverity] = React.useState('medium');
        const [stepsText, setStepsText] = React.useState('');
        const [expected, setExpected] = React.useState('');
        const [actual, setActual] = React.useState('');
        
        const handleSubmit = () => {
            if (!title.trim()) return;
            onSave({
                title: title.trim(),
                description: description.trim(),
                app,
                severity,
                stepsToReproduce: stepsText.split('\n').filter(s => s.trim()),
                expected: expected.trim(),
                actual: actual.trim()
            });
        };
        
        return (
            <div className="fixed inset-0 bg-black/70 flex items-center justify-center z-50 p-4">
                <div className="bg-slate-800 rounded-xl border border-slate-700 w-full max-w-2xl max-h-[90vh] overflow-y-auto">
                    <div className="p-6 border-b border-slate-700">
                        <h3 className="text-lg font-semibold">New Issue</h3>
                    </div>
                    <div className="p-6 space-y-4">
                        <div>
                            <label className="block text-sm text-slate-400 mb-1">Title *</label>
                            <input
                                value={title}
                                onChange={e => setTitle(e.target.value)}
                                className="w-full p-2 bg-slate-900 border border-slate-600 rounded"
                                placeholder="Brief description of the issue"
                            />
                        </div>
                        <div className="grid grid-cols-2 gap-4">
                            <div>
                                <label className="block text-sm text-slate-400 mb-1">App</label>
                                <select
                                    value={app}
                                    onChange={e => setApp(e.target.value)}
                                    className="w-full p-2 bg-slate-900 border border-slate-600 rounded">
                                    {apps.map(a => (
                                        <option key={a.id} value={a.id}>{a.name}</option>
                                    ))}
                                </select>
                            </div>
                            <div>
                                <label className="block text-sm text-slate-400 mb-1">Severity</label>
                                <select
                                    value={severity}
                                    onChange={e => setSeverity(e.target.value)}
                                    className="w-full p-2 bg-slate-900 border border-slate-600 rounded">
                                    <option value="critical">üî¥ Critical</option>
                                    <option value="high">üü† High</option>
                                    <option value="medium">üü° Medium</option>
                                    <option value="low">‚ö™ Low</option>
                                </select>
                            </div>
                        </div>
                        <div>
                            <label className="block text-sm text-slate-400 mb-1">Description</label>
                            <textarea
                                value={description}
                                onChange={e => setDescription(e.target.value)}
                                className="w-full p-2 bg-slate-900 border border-slate-600 rounded h-20"
                                placeholder="Detailed description"
                            />
                        </div>
                        <div>
                            <label className="block text-sm text-slate-400 mb-1">Steps to Reproduce (one per line)</label>
                            <textarea
                                value={stepsText}
                                onChange={e => setStepsText(e.target.value)}
                                className="w-full p-2 bg-slate-900 border border-slate-600 rounded h-20 font-mono text-sm"
                                placeholder="1. Go to...&#10;2. Click on...&#10;3. Observe..."
                            />
                        </div>
                        <div className="grid grid-cols-2 gap-4">
                            <div>
                                <label className="block text-sm text-slate-400 mb-1">Expected</label>
                                <textarea
                                    value={expected}
                                    onChange={e => setExpected(e.target.value)}
                                    className="w-full p-2 bg-slate-900 border border-slate-600 rounded h-16"
                                />
                            </div>
                            <div>
                                <label className="block text-sm text-slate-400 mb-1">Actual</label>
                                <textarea
                                    value={actual}
                                    onChange={e => setActual(e.target.value)}
                                    className="w-full p-2 bg-slate-900 border border-slate-600 rounded h-16"
                                />
                            </div>
                        </div>
                    </div>
                    <div className="p-6 border-t border-slate-700 flex justify-end gap-3">
                        <button onClick={onCancel} className="px-4 py-2 bg-slate-700 hover:bg-slate-600 rounded">
                            Cancel
                        </button>
                        <button onClick={handleSubmit} className="px-4 py-2 bg-red-600 hover:bg-red-500 rounded">
                            Create Issue
                        </button>
                    </div>
                </div>
            </div>
        );
    }
    
    // Edit Issue Modal
    function EditIssueModal({ issue, apps, onSave, onCancel }) {
        const [title, setTitle] = React.useState(issue.title || '');
        const [description, setDescription] = React.useState(issue.description || '');
        const [app, setApp] = React.useState(issue.app || apps[0]?.id || '');
        const [severity, setSeverity] = React.useState(issue.severity || 'medium');
        const [stepsText, setStepsText] = React.useState(issue.stepsToReproduce?.join('\n') || '');
        const [expected, setExpected] = React.useState(issue.expected || '');
        const [actual, setActual] = React.useState(issue.actual || '');
        
        const handleSubmit = () => {
            onSave({
                ...issue,
                title: title.trim(),
                description: description.trim(),
                app,
                severity,
                stepsToReproduce: stepsText.split('\n').filter(s => s.trim()),
                expected: expected.trim(),
                actual: actual.trim()
            });
        };
        
        return (
            <div className="fixed inset-0 bg-black/70 flex items-center justify-center z-50 p-4">
                <div className="bg-slate-800 rounded-xl border border-slate-700 w-full max-w-2xl max-h-[90vh] overflow-y-auto">
                    <div className="p-6 border-b border-slate-700">
                        <h3 className="text-lg font-semibold">Edit {issue.id}</h3>
                    </div>
                    <div className="p-6 space-y-4">
                        <div>
                            <label className="block text-sm text-slate-400 mb-1">Title</label>
                            <input
                                value={title}
                                onChange={e => setTitle(e.target.value)}
                                className="w-full p-2 bg-slate-900 border border-slate-600 rounded"
                            />
                        </div>
                        <div className="grid grid-cols-2 gap-4">
                            <div>
                                <label className="block text-sm text-slate-400 mb-1">App</label>
                                <select
                                    value={app}
                                    onChange={e => setApp(e.target.value)}
                                    className="w-full p-2 bg-slate-900 border border-slate-600 rounded">
                                    {apps.map(a => (
                                        <option key={a.id} value={a.id}>{a.name}</option>
                                    ))}
                                </select>
                            </div>
                            <div>
                                <label className="block text-sm text-slate-400 mb-1">Severity</label>
                                <select
                                    value={severity}
                                    onChange={e => setSeverity(e.target.value)}
                                    className="w-full p-2 bg-slate-900 border border-slate-600 rounded">
                                    <option value="critical">üî¥ Critical</option>
                                    <option value="high">üü† High</option>
                                    <option value="medium">üü° Medium</option>
                                    <option value="low">‚ö™ Low</option>
                                </select>
                            </div>
                        </div>
                        <div>
                            <label className="block text-sm text-slate-400 mb-1">Description</label>
                            <textarea
                                value={description}
                                onChange={e => setDescription(e.target.value)}
                                className="w-full p-2 bg-slate-900 border border-slate-600 rounded h-20"
                            />
                        </div>
                        <div>
                            <label className="block text-sm text-slate-400 mb-1">Steps to Reproduce</label>
                            <textarea
                                value={stepsText}
                                onChange={e => setStepsText(e.target.value)}
                                className="w-full p-2 bg-slate-900 border border-slate-600 rounded h-20 font-mono text-sm"
                            />
                        </div>
                        <div className="grid grid-cols-2 gap-4">
                            <div>
                                <label className="block text-sm text-slate-400 mb-1">Expected</label>
                                <textarea
                                    value={expected}
                                    onChange={e => setExpected(e.target.value)}
                                    className="w-full p-2 bg-slate-900 border border-slate-600 rounded h-16"
                                />
                            </div>
                            <div>
                                <label className="block text-sm text-slate-400 mb-1">Actual</label>
                                <textarea
                                    value={actual}
                                    onChange={e => setActual(e.target.value)}
                                    className="w-full p-2 bg-slate-900 border border-slate-600 rounded h-16"
                                />
                            </div>
                        </div>
                    </div>
                    <div className="p-6 border-t border-slate-700 flex justify-end gap-3">
                        <button onClick={onCancel} className="px-4 py-2 bg-slate-700 hover:bg-slate-600 rounded">
                            Cancel
                        </button>
                        <button onClick={handleSubmit} className="px-4 py-2 bg-indigo-600 hover:bg-indigo-500 rounded">
                            Save Changes
                        </button>
                    </div>
                </div>
            </div>
        );
    }

    // =========================================================================
    // CONFIG VIEW (v7.0.0) - Dynamic Environment & App Configuration
    // =========================================================================
    
    function ConfigView({ config, onConfigChange, showAlert, showConfirm, github, availableRepos, onRefreshRepos }) {
        const [activeTab, setActiveTab] = React.useState('environments');
        const [editingApp, setEditingApp] = React.useState(null);
        const [newAppForm, setNewAppForm] = React.useState(null);
        const [creatingRepo, setCreatingRepo] = React.useState(null); // { appId, env }
        const [repoCreationStatus, setRepoCreationStatus] = React.useState({});
        
        // Internal tools that don't need DEV/BETA repos
        const internalTools = ['testplan', 'management'];
        const gameApps = Object.values(config.apps).filter(app => !internalTools.includes(app.id));
        
        // Get GitHub username from available repos
        const githubOwner = availableRepos[0]?.owner || 'stewartdavidp-ship-it';
        
        const updateConfig = (newConfig) => {
            onConfigChange(newConfig);
        };
        
        // Environment Management
        const toggleEnv = (envId) => {
            const newConfig = ConfigManager.toggleEnvironment({ ...config }, envId);
            updateConfig(newConfig);
        };
        
        // App Management
        const saveApp = (appData) => {
            let newConfig = { ...config, apps: { ...config.apps } };
            if (editingApp) {
                newConfig = ConfigManager.updateApp(newConfig, editingApp.id, appData);
            } else {
                newConfig = ConfigManager.addApp(newConfig, appData);
            }
            updateConfig(newConfig);
            setEditingApp(null);
            setNewAppForm(null);
        };
        
        const deleteApp = async (appId) => {
            const confirmed = await showConfirm(`Delete "${config.apps[appId]?.name}"? This cannot be undone.`, 'Delete App');
            if (confirmed) {
                const newConfig = ConfigManager.removeApp({ ...config, apps: { ...config.apps } }, appId);
                updateConfig(newConfig);
            }
        };
        
        // Create a new repository for an app environment
        const createRepoForApp = async (appId, env) => {
            if (!github) {
                await showAlert('Configure GitHub token first', 'GitHub Required');
                return;
            }
            
            const app = config.apps[appId];
            if (!app) return;
            
            // Generate repo name based on patterns
            const repoPatterns = app.repoPatterns[env] || [];
            const suggestedName = repoPatterns[0] || `${appId}${env}`;
            
            // Check if repo already exists
            const exists = await github.repoExists(githubOwner, suggestedName);
            if (exists) {
                const useExisting = await showConfirm(
                    `Repository "${suggestedName}" already exists.\n\nAssign it to ${app.name} ${env.toUpperCase()}?`,
                    'Repository Exists'
                );
                if (useExisting) {
                    // Update config with existing repo
                    const newConfig = { ...config, apps: { ...config.apps } };
                    newConfig.apps[appId] = {
                        ...newConfig.apps[appId],
                        repos: { ...newConfig.apps[appId].repos, [env]: `${githubOwner}/${suggestedName}` }
                    };
                    updateConfig(newConfig);
                    setRepoCreationStatus(prev => ({ ...prev, [`${appId}-${env}`]: 'assigned' }));
                }
                return;
            }
            
            // Confirm creation
            const confirmed = await showConfirm(
                `Create new repository?\n\n` +
                `Name: ${suggestedName}\n` +
                `For: ${app.name} (${env.toUpperCase()})\n` +
                `URL: https://${githubOwner}.github.io/${suggestedName}/\n\n` +
                `This will create a public repo with GitHub Pages enabled.`,
                `Create ${env.toUpperCase()} Repository`
            );
            
            if (!confirmed) return;
            
            setCreatingRepo({ appId, env });
            setRepoCreationStatus(prev => ({ ...prev, [`${appId}-${env}`]: 'creating' }));
            
            try {
                // Create the repository
                const description = `${app.name} - ${env.toUpperCase()} environment`;
                const result = await github.createRepo(suggestedName, description, false);
                
                setRepoCreationStatus(prev => ({ ...prev, [`${appId}-${env}`]: 'enabling-pages' }));
                
                // Wait a moment for GitHub to initialize the repo
                await new Promise(r => setTimeout(r, 2000));
                
                // Enable GitHub Pages
                try {
                    await github.enablePages(result.fullName);
                } catch (e) {
                    console.log('Pages may need manual enabling:', e);
                }
                
                // Update config with new repo
                const newConfig = { ...config, apps: { ...config.apps } };
                newConfig.apps[appId] = {
                    ...newConfig.apps[appId],
                    repos: { ...newConfig.apps[appId].repos, [env]: result.fullName }
                };
                updateConfig(newConfig);
                
                // Refresh repo list
                if (onRefreshRepos) onRefreshRepos();
                
                setRepoCreationStatus(prev => ({ ...prev, [`${appId}-${env}`]: 'complete' }));
                await showAlert(
                    `Repository created successfully!\n\n` +
                    `${result.fullName}\n` +
                    `${result.pagesUrl}`,
                    '‚úÖ Repository Created'
                );
                
            } catch (error) {
                console.error('Failed to create repo:', error);
                setRepoCreationStatus(prev => ({ ...prev, [`${appId}-${env}`]: 'error' }));
                await showAlert(`Failed to create repository: ${error.message}`, 'Error');
            } finally {
                setCreatingRepo(null);
            }
        };
        
        // Get repo status for an app/env
        const getRepoStatus = (appId, env) => {
            const app = config.apps[appId];
            const repo = app?.repos?.[env];
            const statusKey = `${appId}-${env}`;
            
            if (repoCreationStatus[statusKey]) {
                return repoCreationStatus[statusKey];
            }
            if (repo) {
                return 'configured';
            }
            return 'not-created';
        };
        
        const envColors = config.environments.colors;
        const activeEnvs = config.environments.active;
        
        return (
            <div className="space-y-6">
                <div className="flex items-center justify-between">
                    <h2 className="text-xl font-bold flex items-center gap-2">
                        ‚öôÔ∏è Configuration
                    </h2>
                    <div className="text-xs text-slate-500">Config v{config.version}</div>
                </div>
                
                {/* Tab Navigation */}
                <div className="flex gap-2 border-b border-slate-700 pb-2">
                    {[
                        { id: 'environments', label: 'üåç Environments' },
                        { id: 'repos', label: 'üóÑÔ∏è Repositories' },
                        { id: 'apps', label: 'üì¶ Apps' },
                        { id: 'detection', label: 'üîç Detection' }
                    ].map(tab => (
                        <button
                            key={tab.id}
                            onClick={() => setActiveTab(tab.id)}
                            className={`px-4 py-2 rounded-t-lg font-medium transition-colors ${
                                activeTab === tab.id 
                                    ? 'bg-slate-700 text-white' 
                                    : 'text-slate-400 hover:text-white hover:bg-slate-800'
                            }`}
                        >
                            {tab.label}
                        </button>
                    ))}
                </div>
                
                {/* Environments Tab */}
                {activeTab === 'environments' && (
                    <div className="space-y-6">
                        <div className="bg-slate-800 rounded-xl p-6 border border-slate-700">
                            <h3 className="font-semibold mb-4">Deployment Tiers</h3>
                            <p className="text-sm text-slate-400 mb-4">
                                Enable the environments you use. Files deploy through active tiers in order.
                            </p>
                            
                            <div className="grid grid-cols-2 md:grid-cols-4 gap-4">
                                {config.environments.available.map(env => {
                                    const isActive = activeEnvs.includes(env);
                                    const colors = envColors[env];
                                    return (
                                        <button
                                            key={env}
                                            onClick={() => toggleEnv(env)}
                                            className={`p-4 rounded-xl border-2 transition-all ${
                                                isActive 
                                                    ? `${colors.bg} ${colors.border} text-white` 
                                                    : 'bg-slate-900 border-slate-600 text-slate-400 hover:border-slate-500'
                                            }`}
                                        >
                                            <div className="text-2xl mb-2">
                                                {config.environments.icons[env]}
                                            </div>
                                            <div className="font-bold uppercase">{config.environments.labels[env]}</div>
                                            <div className="text-xs mt-1 opacity-75">
                                                {isActive ? '‚úì Active' : 'Disabled'}
                                            </div>
                                        </button>
                                    );
                                })}
                            </div>
                            
                            <div className="mt-6 p-4 bg-slate-900 rounded-lg">
                                <div className="text-sm font-medium mb-2">Current Flow:</div>
                                <div className="flex items-center gap-2 flex-wrap">
                                    {activeEnvs.map((env, idx) => (
                                        <React.Fragment key={env}>
                                            <span className={`px-3 py-1 rounded-full text-sm font-medium ${envColors[env].bg}`}>
                                                {config.environments.labels[env]}
                                            </span>
                                            {idx < activeEnvs.length - 1 && (
                                                <span className="text-slate-500">‚Üí</span>
                                            )}
                                        </React.Fragment>
                                    ))}
                                </div>
                            </div>
                        </div>
                        
                        <div className="bg-amber-900/30 border border-amber-700 rounded-xl p-4">
                            <div className="flex items-start gap-3">
                                <Icons.AlertTriangle className="text-amber-400 mt-0.5" />
                                <div>
                                    <div className="font-medium text-amber-300">Environment Changes</div>
                                    <div className="text-sm text-slate-300 mt-1">
                                        Adding DEV creates a rapid-build tier before TEST. Adding BETA creates a feature-flag tier after PROD.
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                )}
                
                {/* Repositories Tab */}
                {activeTab === 'repos' && (
                    <div className="space-y-6">
                        <div className="bg-slate-800 rounded-xl p-6 border border-slate-700">
                            <h3 className="font-semibold mb-2">Repository Management</h3>
                            <p className="text-sm text-slate-400 mb-4">
                                Create and manage GitHub repositories for each app environment. 
                                DEV is for rapid iteration, BETA is for feature-flagged production testing.
                            </p>
                            
                            {!github && (
                                <div className="bg-amber-900/30 border border-amber-700 rounded-lg p-4 mb-4">
                                    <div className="text-amber-300 font-medium">‚ö†Ô∏è GitHub Token Required</div>
                                    <div className="text-sm text-slate-300 mt-1">
                                        Configure your GitHub token in Settings to create repositories.
                                    </div>
                                </div>
                            )}
                            
                            <div className="space-y-4">
                                {gameApps.map(app => (
                                    <div key={app.id} className="bg-slate-900 rounded-xl p-4 border border-slate-700">
                                        <div className="flex items-center gap-3 mb-4">
                                            <AppIcon icon={app.icon} size={28} />
                                            <div>
                                                <div className="font-semibold">{app.name}</div>
                                                <div className="text-xs text-slate-400">
                                                    {app.hasServiceWorker ? 'PWA' : 'Web App'}
                                                </div>
                                            </div>
                                        </div>
                                        
                                        <div className="grid grid-cols-2 md:grid-cols-4 gap-3">
                                            {['dev', 'test', 'prod', 'beta'].map(env => {
                                                const isActive = activeEnvs.includes(env);
                                                const repo = app.repos?.[env];
                                                const status = getRepoStatus(app.id, env);
                                                const colors = envColors[env];
                                                const isCreating = creatingRepo?.appId === app.id && creatingRepo?.env === env;
                                                
                                                return (
                                                    <div 
                                                        key={env} 
                                                        className={`p-3 rounded-lg border ${
                                                            isActive ? colors.border : 'border-slate-700 opacity-50'
                                                        } ${isActive ? 'bg-slate-800' : 'bg-slate-900'}`}
                                                    >
                                                        <div className={`text-xs font-medium mb-2 ${isActive ? colors.text : 'text-slate-500'}`}>
                                                            {config.environments.labels[env]}
                                                            {!isActive && ' (disabled)'}
                                                        </div>
                                                        
                                                        {repo ? (
                                                            <div>
                                                                <div className="text-xs font-mono text-green-400 truncate" title={repo}>
                                                                    ‚úì {repo.split('/')[1]}
                                                                </div>
                                                                <a 
                                                                    href={`https://github.com/${repo}`}
                                                                    target="_blank"
                                                                    className="text-xs text-slate-400 hover:text-white"
                                                                >
                                                                    View ‚Üí
                                                                </a>
                                                            </div>
                                                        ) : isActive ? (
                                                            <button
                                                                onClick={() => createRepoForApp(app.id, env)}
                                                                disabled={!github || isCreating}
                                                                className={`w-full px-2 py-1.5 rounded text-xs font-medium transition-colors ${
                                                                    isCreating 
                                                                        ? 'bg-slate-700 text-slate-400 cursor-wait'
                                                                        : github
                                                                            ? `${colors.bg} hover:opacity-90 text-white`
                                                                            : 'bg-slate-700 text-slate-500 cursor-not-allowed'
                                                                }`}
                                                            >
                                                                {isCreating ? (
                                                                    status === 'enabling-pages' ? '‚è≥ Enabling Pages...' : '‚è≥ Creating...'
                                                                ) : (
                                                                    <>+ Create Repo</>
                                                                )}
                                                            </button>
                                                        ) : (
                                                            <div className="text-xs text-slate-500 italic">
                                                                Enable {env.toUpperCase()} first
                                                            </div>
                                                        )}
                                                    </div>
                                                );
                                            })}
                                        </div>
                                    </div>
                                ))}
                            </div>
                        </div>
                        
                        <div className="bg-slate-800 rounded-xl p-6 border border-slate-700">
                            <h3 className="font-semibold mb-2">Internal Tools</h3>
                            <p className="text-sm text-slate-400 mb-4">
                                These tools only use TEST and PROD environments.
                            </p>
                            
                            <div className="space-y-3">
                                {Object.values(config.apps)
                                    .filter(app => internalTools.includes(app.id))
                                    .map(app => (
                                        <div key={app.id} className="flex items-center justify-between p-3 bg-slate-900 rounded-lg">
                                            <div className="flex items-center gap-3">
                                                <AppIcon icon={app.icon} size={24} />
                                                <span className="font-medium">{app.name}</span>
                                            </div>
                                            <div className="flex gap-2">
                                                {['test', 'prod'].map(env => {
                                                    const repo = app.repos?.[env];
                                                    return repo ? (
                                                        <span key={env} className="text-xs px-2 py-1 bg-slate-800 rounded text-slate-400">
                                                            {env.toUpperCase()}: {repo.split('/')[1]}
                                                        </span>
                                                    ) : (
                                                        <span key={env} className="text-xs px-2 py-1 bg-slate-800 rounded text-slate-500">
                                                            {env.toUpperCase()}: ‚Äî
                                                        </span>
                                                    );
                                                })}
                                            </div>
                                        </div>
                                    ))}
                            </div>
                        </div>
                    </div>
                )}
                
                {/* Apps Tab */}
                {activeTab === 'apps' && (
                    <div className="space-y-4">
                        <div className="flex justify-between items-center">
                            <div className="text-sm text-slate-400">
                                {Object.keys(config.apps).length} apps configured
                            </div>
                            <button 
                                onClick={() => setNewAppForm({ name: '', icon: 'üì¶', targetPath: 'index.html' })}
                                className="flex items-center gap-2 px-4 py-2 bg-indigo-600 hover:bg-indigo-500 rounded-lg"
                            >
                                <Icons.Plus /> Add App
                            </button>
                        </div>
                        
                        {/* App List */}
                        <div className="grid gap-4">
                            {Object.values(config.apps).map(app => (
                                <div key={app.id} className="bg-slate-800 rounded-xl border border-slate-700 p-4">
                                    <div className="flex items-start justify-between mb-4">
                                        <div className="flex items-center gap-3">
                                            <AppIcon icon={app.icon} size={32} />
                                            <div>
                                                <div className="font-semibold">{app.name}</div>
                                                <div className="text-xs text-slate-400">
                                                    {app.targetPath} {app.hasServiceWorker && '‚Ä¢ PWA'}
                                                </div>
                                            </div>
                                        </div>
                                        <div className="flex gap-2">
                                            <button 
                                                onClick={() => setEditingApp(app)}
                                                className="p-2 text-slate-400 hover:text-white hover:bg-slate-700 rounded"
                                            >
                                                <Icons.Edit />
                                            </button>
                                            <button 
                                                onClick={() => deleteApp(app.id)}
                                                className="p-2 text-slate-400 hover:text-red-400 hover:bg-slate-700 rounded"
                                            >
                                                <Icons.Trash />
                                            </button>
                                        </div>
                                    </div>
                                    
                                    {/* Environment Repos */}
                                    <div className="grid grid-cols-2 md:grid-cols-4 gap-3">
                                        {activeEnvs.map(env => (
                                            <div key={env} className={`p-3 rounded-lg bg-slate-900 border ${envColors[env].border}`}>
                                                <div className={`text-xs font-medium mb-1 ${envColors[env].text}`}>
                                                    {config.environments.labels[env]}
                                                </div>
                                                <div className="text-sm font-mono truncate">
                                                    {app.repos[env] || <span className="text-slate-500 italic">Not set</span>}
                                                </div>
                                                {app.versions[env] && (
                                                    <div className="text-xs text-slate-400 mt-1">
                                                        v{app.versions[env]}
                                                    </div>
                                                )}
                                            </div>
                                        ))}
                                    </div>
                                </div>
                            ))}
                        </div>
                        
                        {/* Add/Edit App Modal */}
                        {(newAppForm || editingApp) && (
                            <AppEditModal 
                                app={editingApp || newAppForm}
                                isNew={!editingApp}
                                environments={activeEnvs}
                                envLabels={config.environments.labels}
                                onSave={saveApp}
                                onCancel={() => { setEditingApp(null); setNewAppForm(null); }}
                            />
                        )}
                    </div>
                )}
                
                {/* Detection Tab */}
                {activeTab === 'detection' && (
                    <div className="space-y-4">
                        <div className="bg-slate-800 rounded-xl p-6 border border-slate-700">
                            <h3 className="font-semibold mb-2">Content Detection Patterns</h3>
                            <p className="text-sm text-slate-400 mb-4">
                                Regex patterns (case-insensitive) used to auto-detect which app a file belongs to.
                            </p>
                            
                            <div className="space-y-4">
                                {Object.values(config.apps).map(app => (
                                    <div key={app.id} className="p-4 bg-slate-900 rounded-lg">
                                        <div className="flex items-center gap-2 mb-2">
                                            <AppIcon icon={app.icon} size={20} />
                                            <span className="font-medium">{app.name}</span>
                                        </div>
                                        <div className="flex flex-wrap gap-2">
                                            {app.detectionPatterns.map((pattern, idx) => (
                                                <code key={idx} className="px-2 py-1 bg-slate-800 rounded text-xs text-green-400">
                                                    {pattern}
                                                </code>
                                            ))}
                                        </div>
                                    </div>
                                ))}
                            </div>
                        </div>
                        
                        <div className="bg-slate-800 rounded-xl p-6 border border-slate-700">
                            <h3 className="font-semibold mb-2">Repo Name Patterns</h3>
                            <p className="text-sm text-slate-400 mb-4">
                                Patterns for auto-suggesting apps based on GitHub repo names.
                            </p>
                            
                            <div className="overflow-x-auto">
                                <table className="w-full text-sm">
                                    <thead>
                                        <tr className="text-left text-slate-400 border-b border-slate-700">
                                            <th className="pb-2 pr-4">App</th>
                                            {activeEnvs.map(env => (
                                                <th key={env} className={`pb-2 pr-4 ${envColors[env].text}`}>
                                                    {config.environments.labels[env]}
                                                </th>
                                            ))}
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {Object.values(config.apps).map(app => (
                                            <tr key={app.id} className="border-b border-slate-800">
                                                <td className="py-2 pr-4 font-medium">
                                                    <span className="flex items-center gap-2">
                                                        <AppIcon icon={app.icon} size={16} />
                                                        {app.name}
                                                    </span>
                                                </td>
                                                {activeEnvs.map(env => (
                                                    <td key={env} className="py-2 pr-4">
                                                        <div className="flex flex-wrap gap-1">
                                                            {(app.repoPatterns[env] || []).map((p, i) => (
                                                                <code key={i} className="px-1 bg-slate-800 rounded text-xs">
                                                                    {p}
                                                                </code>
                                                            ))}
                                                        </div>
                                                    </td>
                                                ))}
                                            </tr>
                                        ))}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                )}
            </div>
        );
    }
    
    // App Edit Modal Component
    function AppEditModal({ app, isNew, environments, envLabels, onSave, onCancel }) {
        const [form, setForm] = React.useState({
            id: app.id || '',
            name: app.name || '',
            icon: app.icon || 'üì¶',
            targetPath: app.targetPath || 'index.html',
            swPath: app.swPath || '',
            hasServiceWorker: app.hasServiceWorker || false,
            repos: app.repos || {},
            detectionPatterns: (app.detectionPatterns || []).join('\n'),
            repoPatterns: Object.fromEntries(
                environments.map(env => [env, (app.repoPatterns?.[env] || []).join(', ')])
            )
        });
        
        const handleSave = () => {
            const data = {
                ...form,
                id: form.id || form.name.toLowerCase().replace(/\s+/g, ''),
                detectionPatterns: form.detectionPatterns.split('\n').filter(p => p.trim()),
                repoPatterns: Object.fromEntries(
                    environments.map(env => [
                        env, 
                        form.repoPatterns[env]?.split(',').map(s => s.trim()).filter(Boolean) || []
                    ])
                )
            };
            onSave(data);
        };
        
        return (
            <div className="fixed inset-0 bg-black/70 flex items-center justify-center z-50 p-4">
                <div className="bg-slate-800 rounded-xl border border-slate-600 w-full max-w-2xl max-h-[90vh] overflow-y-auto">
                    <div className="p-6 border-b border-slate-700">
                        <h3 className="text-lg font-bold">{isNew ? 'Add New App' : `Edit ${app.name}`}</h3>
                    </div>
                    
                    <div className="p-6 space-y-4">
                        <div className="grid grid-cols-2 gap-4">
                            <div>
                                <label className="block text-sm font-medium mb-1">App Name</label>
                                <input 
                                    type="text"
                                    value={form.name}
                                    onChange={e => setForm({ ...form, name: e.target.value })}
                                    className="w-full p-2 bg-slate-900 border border-slate-600 rounded"
                                    placeholder="My App"
                                />
                            </div>
                            <div>
                                <label className="block text-sm font-medium mb-1">Icon (emoji)</label>
                                <input 
                                    type="text"
                                    value={form.icon}
                                    onChange={e => setForm({ ...form, icon: e.target.value })}
                                    className="w-full p-2 bg-slate-900 border border-slate-600 rounded"
                                    placeholder="üì¶"
                                />
                            </div>
                        </div>
                        
                        <div className="grid grid-cols-2 gap-4">
                            <div>
                                <label className="block text-sm font-medium mb-1">Target Path</label>
                                <input 
                                    type="text"
                                    value={form.targetPath}
                                    onChange={e => setForm({ ...form, targetPath: e.target.value })}
                                    className="w-full p-2 bg-slate-900 border border-slate-600 rounded"
                                    placeholder="index.html"
                                />
                            </div>
                            <div>
                                <label className="block text-sm font-medium mb-1">Service Worker Path</label>
                                <input 
                                    type="text"
                                    value={form.swPath}
                                    onChange={e => setForm({ ...form, swPath: e.target.value })}
                                    className="w-full p-2 bg-slate-900 border border-slate-600 rounded"
                                    placeholder="sw.js (leave empty if none)"
                                />
                            </div>
                        </div>
                        
                        <div>
                            <label className="flex items-center gap-2">
                                <input 
                                    type="checkbox"
                                    checked={form.hasServiceWorker}
                                    onChange={e => setForm({ ...form, hasServiceWorker: e.target.checked })}
                                    className="rounded"
                                />
                                <span className="text-sm">Has Service Worker (PWA)</span>
                            </label>
                        </div>
                        
                        <div>
                            <label className="block text-sm font-medium mb-1">Detection Patterns (one per line, regex)</label>
                            <textarea 
                                value={form.detectionPatterns}
                                onChange={e => setForm({ ...form, detectionPatterns: e.target.value })}
                                className="w-full p-2 bg-slate-900 border border-slate-600 rounded font-mono text-sm"
                                rows={4}
                                placeholder="<title>my app&#10;myapp-container"
                            />
                        </div>
                        
                        <div>
                            <label className="block text-sm font-medium mb-2">Repo Name Patterns (comma-separated)</label>
                            <div className="grid grid-cols-2 gap-3">
                                {environments.map(env => (
                                    <div key={env}>
                                        <label className="block text-xs text-slate-400 mb-1">{envLabels[env]}</label>
                                        <input 
                                            type="text"
                                            value={form.repoPatterns[env] || ''}
                                            onChange={e => setForm({ 
                                                ...form, 
                                                repoPatterns: { ...form.repoPatterns, [env]: e.target.value }
                                            })}
                                            className="w-full p-2 bg-slate-900 border border-slate-600 rounded text-sm"
                                            placeholder={`myapp-${env}, myapp${env}`}
                                        />
                                    </div>
                                ))}
                            </div>
                        </div>
                    </div>
                    
                    <div className="p-6 border-t border-slate-700 flex justify-end gap-3">
                        <button 
                            onClick={onCancel}
                            className="px-4 py-2 bg-slate-700 hover:bg-slate-600 rounded"
                        >
                            Cancel
                        </button>
                        <button 
                            onClick={handleSave}
                            className="px-4 py-2 bg-indigo-600 hover:bg-indigo-500 rounded"
                        >
                            {isNew ? 'Add App' : 'Save Changes'}
                        </button>
                    </div>
                </div>
            </div>
        );
    }

    // =========================================================================
    // ARCHIVE VIEW - gs-active Management for Claude Sessions
    // =========================================================================
    
    // gs-active repo configuration
    const GS_ACTIVE_REPO = 'stewartdavidp-ship-it/gs-active';
    const GS_ACTIVE_APPS = ['gameshelf', 'quotle', 'rungs', 'slate', 'wordboxing', 'command-center', 'testplan', 'firebase-functions'];
    
    function ArchiveView({ apps, config, github, showAlert, showConfirm, showPrompt, globalIssues, sessionLog, deployments }) {
        const [activeTab, setActiveTab] = React.useState('upload'); // 'upload', 'download', 'briefing'
        const [archiveFiles, setArchiveFiles] = React.useState([]); // Parsed files from uploaded zip
        const [archiveContext, setArchiveContext] = React.useState(null); // CONTEXT.md content
        const [archiveStandards, setArchiveStandards] = React.useState(null); // STANDARDS.md content
        const [validationResults, setValidationResults] = React.useState(null); // Version comparison results
        const [loading, setLoading] = React.useState(false);
        const [uploadProgress, setUploadProgress] = React.useState('');
        const [repoFiles, setRepoFiles] = React.useState(null); // Files from gs-active repo
        const [repoLoading, setRepoLoading] = React.useState(false);
        const [briefingText, setBriefingText] = React.useState('');
        
        // Get deployed versions for all apps
        const getDeployedVersions = async () => {
            if (!github) return {};
            const versions = {};
            
            for (const [appId, app] of Object.entries(apps)) {
                versions[appId] = { test: null, prod: null };
                
                if (app.testRepo) {
                    try {
                        const fileData = await github.getFileContent(app.testRepo, 'index.html');
                        if (fileData) {
                            versions[appId].test = extractVersionFromHTML(fileData.textContent);
                        }
                    } catch (e) { console.log(`Could not fetch ${appId} test version`); }
                }
                
                if (app.prodRepo) {
                    try {
                        const fileData = await github.getFileContent(app.prodRepo, 'index.html');
                        if (fileData) {
                            versions[appId].prod = extractVersionFromHTML(fileData.textContent);
                        }
                    } catch (e) { console.log(`Could not fetch ${appId} prod version`); }
                }
            }
            
            return versions;
        };
        
        // Handle zip file upload
        const handleZipUpload = async (e) => {
            const file = e.target.files?.[0];
            if (!file) return;
            
            setLoading(true);
            setUploadProgress('Reading zip file...');
            setArchiveFiles([]);
            setValidationResults(null);
            
            try {
                const zip = await JSZip.loadAsync(file);
                const files = [];
                
                setUploadProgress('Extracting files...');
                
                // Extract all files
                for (const [path, zipEntry] of Object.entries(zip.files)) {
                    if (zipEntry.dir) continue;
                    
                    // Detect if file is binary
                    const isBinary = /\.(png|jpg|jpeg|gif|ico|woff|woff2|ttf|eot|svg)$/i.test(path);
                    
                    let content;
                    let base64Content = null;
                    
                    if (isBinary) {
                        // Read binary files as base64
                        base64Content = await zipEntry.async('base64');
                        content = `[Binary file: ${path}]`; // Placeholder for display
                    } else {
                        content = await zipEntry.async('string');
                    }
                    
                    const relativePath = path.replace(/^gs-active\//, '');
                    
                    // Extract version from HTML files
                    let version = null;
                    if (path.endsWith('.html')) {
                        version = extractVersionFromHTML(content);
                    }
                    
                    // Detect app from path
                    const pathParts = relativePath.split('/');
                    const appFolder = pathParts[0];
                    
                    files.push({
                        path: relativePath,
                        fullPath: path,
                        appFolder,
                        content,
                        base64Content,
                        isBinary,
                        version,
                        size: isBinary ? (base64Content?.length || 0) : content.length,
                        isHtml: path.endsWith('.html'),
                        isMarkdown: path.endsWith('.md'),
                        isJson: path.endsWith('.json'),
                        isJs: path.endsWith('.js')
                    });
                    
                    // Capture special files
                    if (relativePath === 'CONTEXT.md') {
                        setArchiveContext(content);
                    } else if (relativePath === 'STANDARDS.md') {
                        setArchiveStandards(content);
                    }
                }
                
                setArchiveFiles(files);
                setUploadProgress('Validating versions...');
                
                // Validate against deployed versions
                const deployedVersions = await getDeployedVersions();
                const validation = [];
                
                // Map app folders to app IDs
                const folderToAppId = {
                    'gameshelf': 'gameshelf',
                    'quotle': 'quotle', 
                    'rungs': 'rungs',
                    'slate': 'slate',
                    'wordboxing': 'wordboxing',
                    'command-center': 'management',
                    'testplan': 'testplan'
                };
                
                // Check each app folder
                const appFolders = [...new Set(files.map(f => f.appFolder))];
                
                for (const folder of appFolders) {
                    const appId = folderToAppId[folder];
                    const indexFile = files.find(f => f.appFolder === folder && f.path.endsWith('index.html'));
                    
                    if (!indexFile || !appId) continue;
                    
                    const archiveVersion = indexFile.version;
                    const deployed = deployedVersions[appId] || {};
                    
                    let status = 'unknown';
                    let message = '';
                    
                    if (!archiveVersion) {
                        status = 'warning';
                        message = 'No version found in archive';
                    } else if (deployed.prod && archiveVersion === deployed.prod) {
                        status = 'match';
                        message = `v${archiveVersion} matches PROD`;
                    } else if (deployed.test && archiveVersion === deployed.test) {
                        status = 'match-test';
                        message = `v${archiveVersion} matches TEST`;
                    } else if (deployed.prod && archiveVersion !== deployed.prod) {
                        status = 'mismatch';
                        message = `Archive v${archiveVersion} ‚â† PROD v${deployed.prod}`;
                    } else if (!deployed.prod && !deployed.test) {
                        status = 'no-deploy';
                        message = `v${archiveVersion} (no deployed version found)`;
                    } else {
                        status = 'newer';
                        message = `v${archiveVersion} (PROD: ${deployed.prod || 'none'}, TEST: ${deployed.test || 'none'})`;
                    }
                    
                    validation.push({
                        folder,
                        appId,
                        appName: apps[appId]?.name || folder,
                        archiveVersion,
                        deployedProd: deployed.prod,
                        deployedTest: deployed.test,
                        status,
                        message
                    });
                }
                
                // Check for apps deployed but not in archive
                for (const [appId, app] of Object.entries(apps)) {
                    const folder = Object.entries(folderToAppId).find(([f, id]) => id === appId)?.[0];
                    if (!folder) continue;
                    
                    const inArchive = validation.some(v => v.appId === appId);
                    if (!inArchive && (app.testRepo || app.prodRepo)) {
                        const deployed = deployedVersions[appId] || {};
                        if (deployed.prod || deployed.test) {
                            validation.push({
                                folder,
                                appId,
                                appName: app.name,
                                archiveVersion: null,
                                deployedProd: deployed.prod,
                                deployedTest: deployed.test,
                                status: 'missing',
                                message: `Not in archive (PROD: ${deployed.prod || 'none'})`
                            });
                        }
                    }
                }
                
                setValidationResults(validation);
                setUploadProgress('');
                
            } catch (err) {
                console.error('Error processing zip:', err);
                await showAlert(`Error processing zip: ${err.message}`, 'Upload Error');
            } finally {
                setLoading(false);
            }
        };
        
        // Push archive to gs-active repo
        const pushToRepo = async () => {
            if (!github || archiveFiles.length === 0) return;
            
            const confirmed = await showConfirm(
                `Push ${archiveFiles.length} files to gs-active repo?\n\n` +
                `This will update the archive in GitHub.`,
                'Push to gs-active'
            );
            
            if (!confirmed) return;
            
            setLoading(true);
            setUploadProgress('Checking repository...');
            
            try {
                // Check if repo exists
                const [owner, repoName] = GS_ACTIVE_REPO.split('/');
                const exists = await github.repoExists(owner, repoName);
                
                if (!exists) {
                    setUploadProgress('Creating gs-active repository...');
                    await github.createRepo('gs-active', 'Game Shelf development archive for Claude sessions', false);
                    await new Promise(r => setTimeout(r, 2000)); // Wait for repo creation
                }
                
                // Push each file
                let pushed = 0;
                for (const file of archiveFiles) {
                    setUploadProgress(`Pushing ${file.path} (${++pushed}/${archiveFiles.length})...`);
                    
                    // Get current file SHA if it exists
                    let sha = null;
                    try {
                        const existing = await github.getFile(GS_ACTIVE_REPO, file.path);
                        if (existing) sha = existing.sha;
                    } catch (e) { /* File doesn't exist yet */ }
                    
                    // Handle binary vs text files differently
                    if (file.isBinary && file.base64Content) {
                        // Binary file - use base64 content directly
                        const [owner, repoName] = GS_ACTIVE_REPO.split('/');
                        const body = {
                            message: `Update ${file.path} - ${new Date().toISOString().split('T')[0]}`,
                            content: file.base64Content,
                            committer: { name: 'Command Center', email: 'deploy@gameshelf.app' }
                        };
                        if (sha) body.sha = sha;
                        await github.request(`/repos/${owner}/${repoName}/contents/${file.path}`, { 
                            method: 'PUT', 
                            body: JSON.stringify(body) 
                        });
                    } else {
                        // Text file - use normal method
                        await github.createOrUpdateFile(
                            GS_ACTIVE_REPO,
                            file.path,
                            file.content,
                            `Update ${file.path} - ${new Date().toISOString().split('T')[0]}`,
                            sha
                        );
                    }
                }
                
                setUploadProgress('');
                await showAlert(`Successfully pushed ${archiveFiles.length} files to gs-active!`, '‚úÖ Archive Updated');
                
            } catch (err) {
                console.error('Error pushing to repo:', err);
                await showAlert(`Error: ${err.message}`, 'Push Failed');
            } finally {
                setLoading(false);
            }
        };
        
        // Load files from gs-active repo - returns the files array
        const loadFromRepo = async () => {
            if (!github) return [];
            
            setRepoLoading(true);
            
            try {
                const files = [];
                
                // Get root contents
                const root = await github.listRepoContents(GS_ACTIVE_REPO);
                
                for (const item of root) {
                    if (item.type === 'file') {
                        files.push({ path: item.path, type: 'file', sha: item.sha, size: item.size });
                    } else if (item.type === 'dir') {
                        // Get directory contents
                        const dirContents = await github.listRepoContents(GS_ACTIVE_REPO, item.path);
                        for (const subItem of dirContents) {
                            if (subItem.type === 'file') {
                                files.push({ path: subItem.path, type: 'file', sha: subItem.sha, size: subItem.size, folder: item.path });
                            } else if (subItem.type === 'dir') {
                                // Go one more level (for icons folders, etc)
                                const subDirContents = await github.listRepoContents(GS_ACTIVE_REPO, subItem.path);
                                for (const deepItem of subDirContents) {
                                    if (deepItem.type === 'file') {
                                        files.push({ path: deepItem.path, type: 'file', sha: deepItem.sha, size: deepItem.size, folder: item.path });
                                    }
                                }
                            }
                        }
                    }
                }
                
                setRepoFiles(files);
                return files;
                
            } catch (err) {
                console.error('Error loading repo:', err);
                if (err.message?.includes('Not Found')) {
                    await showAlert('gs-active repo not found. Upload an archive first to create it.', 'Repository Not Found');
                } else {
                    await showAlert(`Error: ${err.message}`, 'Load Failed');
                }
                return [];
            } finally {
                setRepoLoading(false);
            }
        };
        
        // Download gs-active as zip
        const downloadAsZip = async () => {
            if (!github) return;
            
            setLoading(true);
            setUploadProgress('Fetching file list from repository...');
            
            try {
                const zip = new JSZip();
                const gsActive = zip.folder('gs-active');
                
                // Always fetch fresh file list
                const filesToFetch = await loadFromRepo();
                
                if (filesToFetch.length === 0) {
                    await showAlert('No files found in gs-active repository.', 'Empty Repository');
                    setLoading(false);
                    return;
                }
                
                let fetched = 0;
                
                for (const file of filesToFetch) {
                    setUploadProgress(`Downloading ${file.path} (${++fetched}/${filesToFetch.length})...`);
                    
                    try {
                        const fileData = await github.getFile(GS_ACTIVE_REPO, file.path);
                        if (fileData) {
                            // Determine if binary or text
                            const isBinary = file.path.match(/\.(png|jpg|jpeg|gif|ico|woff|woff2|ttf|eot|svg)$/i);
                            
                            // Check if content is available (GitHub Contents API has 1MB limit)
                            // For files >1MB, content will be empty but download_url is provided
                            if (!fileData.content && fileData.download_url) {
                                console.log(`Large file detected (>1MB): ${file.path}, using download_url`);
                                const response = await fetch(fileData.download_url);
                                if (isBinary) {
                                    const blob = await response.blob();
                                    gsActive.file(file.path, blob);
                                } else {
                                    const text = await response.text();
                                    gsActive.file(file.path, text);
                                }
                            } else if (fileData.content) {
                                if (isBinary) {
                                    // Binary files - content is already base64
                                    gsActive.file(file.path, fileData.content.replace(/[\r\n\s]/g, ''), { base64: true });
                                } else {
                                    // Text files - decode from base64
                                    const content = decodeURIComponent(escape(atob(fileData.content.replace(/[\r\n\s]/g, ''))));
                                    gsActive.file(file.path, content);
                                }
                            } else {
                                console.warn(`No content or download_url for ${file.path}`);
                            }
                        }
                    } catch (e) {
                        console.error(`Error fetching ${file.path}:`, e);
                    }
                }
                
                setUploadProgress('Creating zip file...');
                
                const blob = await zip.generateAsync({ type: 'blob' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `gs-active-${new Date().toISOString().split('T')[0]}.zip`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                
                setUploadProgress('');
                await showAlert(`Downloaded ${filesToFetch.length} files!`, '‚úÖ Download Complete');
                
            } catch (err) {
                console.error('Error downloading:', err);
                await showAlert(`Error: ${err.message}`, 'Download Failed');
            } finally {
                setLoading(false);
            }
        };
        
        // Generate Claude briefing
        const generateBriefing = async () => {
            setLoading(true);
            setUploadProgress('Generating briefing...');
            
            try {
                const deployedVersions = await getDeployedVersions();
                const today = new Date().toISOString().split('T')[0];
                const dayOfWeek = new Date().toLocaleDateString('en-US', { weekday: 'long' });
                
                let briefing = `# Claude Session Briefing - ${dayOfWeek}, ${today}\n\n`;
                briefing += `Generated by Command Center v7.3.0\n\n`;
                briefing += `---\n\n`;
                
                // Deployed Versions
                briefing += `## üìä Deployed Versions\n\n`;
                briefing += `| App | TEST | PROD | Status |\n`;
                briefing += `|-----|------|------|--------|\n`;
                
                let hasVersions = false;
                for (const [appId, app] of Object.entries(apps)) {
                    if (!app.testRepo && !app.prodRepo) continue;
                    hasVersions = true;
                    const v = deployedVersions[appId] || {};
                    const status = v.test === v.prod ? '‚úì Synced' : (v.test && v.prod ? '‚ö†Ô∏è Differ' : '‚Äî');
                    briefing += `| ${app.name} | ${v.test || '‚Äî'} | ${v.prod || '‚Äî'} | ${status} |\n`;
                }
                
                if (!hasVersions) {
                    briefing += `| (No configured apps) | ‚Äî | ‚Äî | ‚Äî |\n`;
                }
                
                briefing += `\n`;
                
                // Open Issues
                const openIssues = globalIssues?.filter(i => i.status === 'open' || i.status === 'in-progress') || [];
                briefing += `## üêõ Open Issues (${openIssues.length})\n\n`;
                if (openIssues.length > 0) {
                    for (const issue of openIssues.slice(0, 10)) {
                        const priorityIcon = issue.priority === 'high' ? 'üî¥' : issue.priority === 'low' ? 'üü¢' : 'üü°';
                        briefing += `- ${priorityIcon} **${issue.id}**: ${issue.title} (${issue.app || 'General'})\n`;
                    }
                    if (openIssues.length > 10) {
                        briefing += `- _...and ${openIssues.length - 10} more_\n`;
                    }
                } else {
                    briefing += `_No open issues - great job!_\n`;
                }
                briefing += `\n`;
                
                // Recent Deployments
                const recentDeploys = deployments?.filter(d => d.status === 'success').slice(0, 5) || [];
                briefing += `## üöÄ Recent Deployments\n\n`;
                if (recentDeploys.length > 0) {
                    for (const d of recentDeploys) {
                        const time = d.startedAt ? new Date(d.startedAt).toLocaleString() : 'Unknown';
                        const targetIcon = d.target === 'prod' ? 'üü¢' : 'üîµ';
                        briefing += `- ${targetIcon} **${d.appName}** v${d.version || '?'} ‚Üí ${d.target?.toUpperCase() || '?'} (${time})\n`;
                    }
                } else {
                    briefing += `_No recent deployments_\n`;
                }
                briefing += `\n`;
                
                // Session Notes (if any)
                if (sessionLog?.notes && sessionLog.notes.trim()) {
                    briefing += `## üìù Session Notes\n\n`;
                    briefing += sessionLog.notes + `\n\n`;
                }
                
                // Current Session Log
                if (sessionLog?.currentSession) {
                    briefing += `## üéØ Current Session\n\n`;
                    briefing += `**Goal:** ${sessionLog.currentSession.goal || 'Not specified'}\n\n`;
                    if (sessionLog.currentSession.completed?.length > 0) {
                        briefing += `**Completed:**\n`;
                        for (const item of sessionLog.currentSession.completed) {
                            briefing += `- ‚úÖ ${item}\n`;
                        }
                        briefing += `\n`;
                    }
                    if (sessionLog.currentSession.pending?.length > 0) {
                        briefing += `**Pending:**\n`;
                        for (const item of sessionLog.currentSession.pending) {
                            briefing += `- ‚è≥ ${item}\n`;
                        }
                        briefing += `\n`;
                    }
                }
                
                // Include archive info if we have it
                if (archiveContext) {
                    briefing += `## üì¶ Archive CONTEXT.md (Summary)\n\n`;
                    // Extract just the first section or key info
                    const contextLines = archiveContext.split('\n').slice(0, 30);
                    briefing += contextLines.join('\n') + '\n\n';
                    if (archiveContext.split('\n').length > 30) {
                        briefing += `_[Truncated - see full CONTEXT.md in gs-active]_\n\n`;
                    }
                }
                
                // GitHub URLs
                briefing += `## üîó Quick Links\n\n`;
                briefing += `| App | TEST | PROD |\n`;
                briefing += `|-----|------|------|\n`;
                
                for (const [appId, app] of Object.entries(apps)) {
                    if (!app.testRepo && !app.prodRepo) continue;
                    const testUrl = app.testRepo ? `[Link](https://${app.testRepo.split('/')[0]}.github.io/${app.testRepo.split('/')[1]}/)` : '‚Äî';
                    const prodUrl = app.prodRepo ? `[Link](https://${app.prodRepo.split('/')[0]}.github.io/${app.prodRepo.split('/')[1]}/)` : '‚Äî';
                    briefing += `| ${app.name} | ${testUrl} | ${prodUrl} |\n`;
                }
                
                briefing += `\n---\n\n`;
                briefing += `## üöÄ Getting Started\n\n`;
                briefing += `1. Download **gs-active.zip** from the Archive ‚Üí Download tab\n`;
                briefing += `2. Upload the zip to Claude\n`;
                briefing += `3. Say: "Please review skills and the gs-active file"\n\n`;
                briefing += `_Or paste this briefing for a quick overview without the full archive._\n`;
                
                setBriefingText(briefing);
                setUploadProgress('');
                
            } catch (err) {
                console.error('Error generating briefing:', err);
                await showAlert(`Error: ${err.message}`, 'Briefing Failed');
            } finally {
                setLoading(false);
            }
        };
        
        // Copy briefing to clipboard
        const copyBriefing = async () => {
            try {
                await navigator.clipboard.writeText(briefingText);
                await showAlert('Briefing copied to clipboard!', '‚úÖ Copied');
            } catch (err) {
                await showAlert('Failed to copy to clipboard', 'Error');
            }
        };
        
        // Status badge component
        const StatusBadge = ({ status }) => {
            const styles = {
                'match': 'bg-green-600 text-green-100',
                'match-test': 'bg-blue-600 text-blue-100',
                'mismatch': 'bg-red-600 text-red-100',
                'newer': 'bg-amber-600 text-amber-100',
                'missing': 'bg-red-800 text-red-200',
                'warning': 'bg-amber-600 text-amber-100',
                'no-deploy': 'bg-slate-600 text-slate-300',
                'unknown': 'bg-slate-600 text-slate-300'
            };
            
            const labels = {
                'match': '‚úì PROD Match',
                'match-test': '‚úì TEST Match',
                'mismatch': '‚úó Mismatch',
                'newer': '‚Üë Newer',
                'missing': '‚úó Missing',
                'warning': '‚ö† Warning',
                'no-deploy': '‚Äî Not Deployed',
                'unknown': '? Unknown'
            };
            
            return (
                <span className={`px-2 py-0.5 rounded text-xs font-medium ${styles[status] || styles.unknown}`}>
                    {labels[status] || status}
                </span>
            );
        };
        
        return (
            <div className="space-y-6">
                <div className="flex items-center justify-between">
                    <h2 className="text-xl font-bold flex items-center gap-2">
                        üì¶ Archive Manager
                    </h2>
                    <div className="text-sm text-slate-400">
                        gs-active repo: <span className="text-indigo-400">{GS_ACTIVE_REPO}</span>
                    </div>
                </div>
                
                {/* Tab Navigation */}
                <div className="flex gap-2 border-b border-slate-700 pb-2">
                    {[
                        { id: 'upload', label: '‚¨ÜÔ∏è Upload Archive', icon: 'Upload' },
                        { id: 'download', label: '‚¨áÔ∏è Download Archive', icon: 'Download' },
                        { id: 'briefing', label: 'üìã Claude Briefing', icon: 'File' }
                    ].map(tab => (
                        <button
                            key={tab.id}
                            onClick={() => setActiveTab(tab.id)}
                            className={`px-4 py-2 rounded-t-lg font-medium transition-colors ${
                                activeTab === tab.id 
                                    ? 'bg-slate-700 text-white' 
                                    : 'text-slate-400 hover:text-white hover:bg-slate-800'
                            }`}
                        >
                            {tab.label}
                        </button>
                    ))}
                </div>
                
                {/* Loading indicator */}
                {loading && (
                    <div className="p-4 bg-indigo-900/30 border border-indigo-700 rounded-lg flex items-center gap-3">
                        <div className="animate-spin w-5 h-5 border-2 border-indigo-500 border-t-transparent rounded-full"></div>
                        <span>{uploadProgress || 'Processing...'}</span>
                    </div>
                )}
                
                {/* Upload Tab */}
                {activeTab === 'upload' && (
                    <div className="space-y-6">
                        {/* Upload Zone */}
                        <div className="border-2 border-dashed border-slate-600 rounded-lg p-8 text-center hover:border-indigo-500 transition-colors">
                            <input
                                type="file"
                                accept=".zip"
                                onChange={handleZipUpload}
                                className="hidden"
                                id="archive-upload"
                            />
                            <label htmlFor="archive-upload" className="cursor-pointer">
                                <Icons.Upload />
                                <div className="mt-2 text-lg">Drop gs-active.zip here or click to upload</div>
                                <div className="text-sm text-slate-400 mt-1">End of session: Upload to validate and push to GitHub</div>
                            </label>
                        </div>
                        
                        {/* Validation Results */}
                        {validationResults && (
                            <div className="bg-slate-800 rounded-lg p-4">
                                <h3 className="text-lg font-semibold mb-4 flex items-center gap-2">
                                    <Icons.Check /> Version Validation
                                </h3>
                                
                                <div className="space-y-2">
                                    {validationResults.map((v, i) => (
                                        <div key={i} className="flex items-center justify-between p-3 bg-slate-900 rounded">
                                            <div className="flex items-center gap-3">
                                                <AppIcon icon={apps[v.appId]?.icon} size={20} />
                                                <span className="font-medium">{v.appName}</span>
                                                {v.archiveVersion && (
                                                    <span className="text-sm text-slate-400">v{v.archiveVersion}</span>
                                                )}
                                            </div>
                                            <div className="flex items-center gap-3">
                                                <span className="text-sm text-slate-400">{v.message}</span>
                                                <StatusBadge status={v.status} />
                                            </div>
                                        </div>
                                    ))}
                                </div>
                                
                                {/* Summary */}
                                <div className="mt-4 pt-4 border-t border-slate-700 flex justify-between items-center">
                                    <div className="text-sm text-slate-400">
                                        {archiveFiles.length} files in archive ‚Ä¢ 
                                        {validationResults.filter(v => v.status === 'match' || v.status === 'match-test').length} matching ‚Ä¢ 
                                        {validationResults.filter(v => v.status === 'mismatch' || v.status === 'missing').length} issues
                                    </div>
                                    
                                    <button
                                        onClick={pushToRepo}
                                        disabled={loading || !github}
                                        className="px-4 py-2 bg-indigo-600 hover:bg-indigo-500 disabled:bg-slate-700 disabled:text-slate-500 rounded font-medium flex items-center gap-2"
                                    >
                                        <Icons.Rocket /> Push to gs-active
                                    </button>
                                </div>
                            </div>
                        )}
                        
                        {/* Archive Contents */}
                        {archiveFiles.length > 0 && (
                            <div className="bg-slate-800 rounded-lg p-4">
                                <h3 className="text-lg font-semibold mb-4">Archive Contents ({archiveFiles.length} files)</h3>
                                
                                <div className="max-h-64 overflow-y-auto space-y-1 text-sm font-mono">
                                    {archiveFiles.map((f, i) => (
                                        <div key={i} className="flex items-center gap-2 py-1 px-2 hover:bg-slate-700 rounded">
                                            {f.isBinary && <span className="text-purple-400">üñºÔ∏è</span>}
                                            {!f.isBinary && f.isHtml && <span className="text-orange-400">üìÑ</span>}
                                            {!f.isBinary && f.isJs && <span className="text-yellow-400">üìú</span>}
                                            {!f.isBinary && f.isJson && <span className="text-green-400">üìã</span>}
                                            {!f.isBinary && f.isMarkdown && <span className="text-blue-400">üìù</span>}
                                            {!f.isBinary && !f.isHtml && !f.isJs && !f.isJson && !f.isMarkdown && <span>üìÅ</span>}
                                            <span className="text-slate-300">{f.path}</span>
                                            {f.isBinary && <span className="text-purple-400 text-xs">(binary)</span>}
                                            {f.version && <span className="text-indigo-400 ml-auto">v{f.version}</span>}
                                            <span className="text-slate-500 text-xs">{(f.size / 1024).toFixed(1)}KB</span>
                                        </div>
                                    ))}
                                </div>
                            </div>
                        )}
                        
                        {/* CONTEXT.md Preview */}
                        {archiveContext && (
                            <div className="bg-slate-800 rounded-lg p-4">
                                <h3 className="text-lg font-semibold mb-2">üìÑ CONTEXT.md</h3>
                                <pre className="text-sm text-slate-300 whitespace-pre-wrap max-h-48 overflow-y-auto bg-slate-900 p-3 rounded">
                                    {archiveContext.substring(0, 2000)}
                                    {archiveContext.length > 2000 && '...\n(truncated)'}
                                </pre>
                            </div>
                        )}
                    </div>
                )}
                
                {/* Download Tab */}
                {activeTab === 'download' && (
                    <div className="space-y-6">
                        <div className="bg-slate-800 rounded-lg p-6">
                            <h3 className="text-lg font-semibold mb-4">Download gs-active from GitHub</h3>
                            <p className="text-slate-400 mb-4">
                                Start of session: Download the latest archive to provide to Claude.
                            </p>
                            
                            <div className="flex gap-3">
                                <button
                                    onClick={loadFromRepo}
                                    disabled={repoLoading || !github}
                                    className="px-4 py-2 bg-slate-700 hover:bg-slate-600 disabled:bg-slate-800 rounded flex items-center gap-2"
                                >
                                    <Icons.Refresh /> Refresh File List
                                </button>
                                
                                <button
                                    onClick={downloadAsZip}
                                    disabled={loading || !github}
                                    className="px-4 py-2 bg-indigo-600 hover:bg-indigo-500 disabled:bg-slate-700 rounded font-medium flex items-center gap-2"
                                >
                                    <Icons.Download /> Download gs-active.zip
                                </button>
                            </div>
                        </div>
                        
                        {/* Repo file list */}
                        {repoFiles && (
                            <div className="bg-slate-800 rounded-lg p-4">
                                <h3 className="text-lg font-semibold mb-4">Files in gs-active repo ({repoFiles.length})</h3>
                                
                                <div className="max-h-64 overflow-y-auto space-y-1 text-sm font-mono">
                                    {repoFiles.map((f, i) => (
                                        <div key={i} className="flex items-center gap-2 py-1 px-2 hover:bg-slate-700 rounded">
                                            <Icons.File />
                                            <span className="text-slate-300">{f.path}</span>
                                            <span className="text-slate-500 text-xs ml-auto">{(f.size / 1024).toFixed(1)}KB</span>
                                        </div>
                                    ))}
                                </div>
                            </div>
                        )}
                        
                        {repoFiles === null && !repoLoading && (
                            <div className="text-center text-slate-400 py-8">
                                Click "Refresh File List" to see available files
                            </div>
                        )}
                    </div>
                )}
                
                {/* Briefing Tab */}
                {activeTab === 'briefing' && (
                    <div className="space-y-6">
                        <div className="bg-slate-800 rounded-lg p-6">
                            <h3 className="text-lg font-semibold mb-4">Generate Claude Briefing</h3>
                            <p className="text-slate-400 mb-4">
                                Create a markdown summary of current project state for quick Claude onboarding.
                            </p>
                            
                            <button
                                onClick={generateBriefing}
                                disabled={loading || !github}
                                className="px-4 py-2 bg-indigo-600 hover:bg-indigo-500 disabled:bg-slate-700 rounded font-medium flex items-center gap-2"
                            >
                                <Icons.Zap /> Generate Briefing
                            </button>
                        </div>
                        
                        {briefingText && (
                            <div className="bg-slate-800 rounded-lg p-4">
                                <div className="flex justify-between items-center mb-4">
                                    <h3 className="text-lg font-semibold">üìã Session Briefing</h3>
                                    <button
                                        onClick={copyBriefing}
                                        className="px-3 py-1 bg-slate-700 hover:bg-slate-600 rounded text-sm flex items-center gap-1"
                                    >
                                        <Icons.Copy /> Copy
                                    </button>
                                </div>
                                
                                <pre className="text-sm text-slate-300 whitespace-pre-wrap max-h-96 overflow-y-auto bg-slate-900 p-4 rounded font-mono">
                                    {briefingText}
                                </pre>
                            </div>
                        )}
                    </div>
                )}
                
                {/* Help Text */}
                <div className="bg-slate-800/50 rounded-lg p-4 text-sm text-slate-400">
                    <h4 className="font-medium text-slate-300 mb-2">üìñ Workflow</h4>
                    <ul className="space-y-1 list-disc list-inside">
                        <li><strong>End of Session:</strong> Upload gs-active.zip ‚Üí Validate versions ‚Üí Push to GitHub</li>
                        <li><strong>Start of Session:</strong> Download gs-active.zip ‚Üí Upload to Claude ‚Üí Or copy briefing for quick start</li>
                        <li>The gs-active repo serves as the single source of truth between Claude sessions</li>
                    </ul>
                </div>
            </div>
        );
    }

    // =========================================================================
    // SETTINGS VIEW
    // =========================================================================
    
    function SettingsView({ token, setToken, settings, setSettings, repoCount }) {
        const [show, setShow] = React.useState(false);
        const [testing, setTesting] = React.useState(false);
        const [result, setResult] = React.useState(null);
        
        return (
            <div className="space-y-6">
                <div className="bg-slate-800 rounded-xl border border-slate-700 p-6">
                    <h2 className="text-lg font-semibold mb-4 flex items-center gap-2">
                        <Icons.GitBranch /> GitHub Token
                    </h2>
                    <div className="flex gap-2 mb-2">
                        <input type={show ? 'text' : 'password'} value={token} onChange={e => setToken(e.target.value)}
                            placeholder="ghp_xxxx" className="flex-1 p-2 bg-slate-700 border border-slate-600 rounded font-mono text-sm" />
                        <button onClick={() => setShow(!show)} className="px-3 bg-slate-700 border border-slate-600 rounded">{show ? 'üôà' : 'üëÅÔ∏è'}</button>
                        <button onClick={async () => {
                            setTesting(true);
                            try { const gh = new GitHubAPI(token); const r = await gh.listRepos(); setResult({ ok: true, count: r.length }); }
                            catch (e) { setResult({ ok: false, error: e.message }); }
                            setTesting(false);
                        }} disabled={testing} className="px-4 bg-indigo-600 rounded">{testing ? '...' : 'Test'}</button>
                    </div>
                    <a href="https://github.com/settings/tokens/new?scopes=repo" target="_blank" className="text-xs text-indigo-400">Create token ‚Üí</a>
                    {result && <div className={`mt-2 text-sm ${result.ok ? 'text-green-400' : 'text-red-400'}`}>
                        {result.ok ? `‚úì Found ${result.count} repos` : `‚úó ${result.error}`}
                    </div>}
                </div>
                
                <div className="bg-slate-800 rounded-xl border border-slate-700 p-6">
                    <h2 className="text-lg font-semibold mb-4">Options</h2>
                    <label className="flex items-center gap-3 p-3 bg-slate-700/50 rounded cursor-pointer">
                        <input type="checkbox" checked={settings.createTag} onChange={e => setSettings({ ...settings, createTag: e.target.checked })} />
                        <span>Create Git Tags</span>
                    </label>
                </div>
                
                <div className="bg-slate-800 rounded-xl border border-slate-700 p-6">
                    <h2 className="text-lg font-semibold mb-4">Reset</h2>
                    <div className="space-y-3">
                        <button onClick={() => { 
                            localStorage.removeItem('cc_apps_v6'); 
                            location.reload(); 
                        }}
                            className="px-4 py-2 bg-amber-900/50 text-amber-400 border border-amber-700 rounded mr-3">
                            Reset App Mappings
                        </button>
                        <button onClick={() => { localStorage.clear(); location.reload(); }}
                            className="px-4 py-2 bg-red-900/50 text-red-400 border border-red-700 rounded">
                            Clear All Data
                        </button>
                        <p className="text-xs text-slate-500 mt-2">
                            "Reset App Mappings" keeps your token but resets all app‚Üírepo mappings to defaults and re-runs auto-detection.
                        </p>
                    </div>
                </div>
            </div>
        );
    }

    // =========================================================================
    // RENDER
    // =========================================================================
    
    try {
        ReactDOM.createRoot(document.getElementById('root')).render(<App />);
    } catch (error) {
        document.getElementById('root').innerHTML = `<div style="padding:20px;background:#7f1d1d;margin:20px;border-radius:10px;">
            <h2>Error</h2><pre>${error.message}</pre>
            <button onclick="localStorage.clear();location.reload();" style="margin-top:10px;padding:10px;cursor:pointer;">Clear & Reload</button>
        </div>`;
    }
    </script>
</body>
</html>
