<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Game Shelf Command Center</title>
    <meta name="version" content="6.1.3">
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    <style>
        * { box-sizing: border-box; }
        body { margin: 0; font-family: system-ui, -apple-system, sans-serif; background: #0f172a; color: #e2e8f0; }
        .animate-spin { animation: spin 1s linear infinite; }
        @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
        .fade-in { animation: fadeIn 0.2s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body>
    <div id="root"><div style="display:flex;align-items:center;justify-content:center;min-height:100vh;"><div style="text-align:center;"><div style="font-size:48px;margin-bottom:20px;">ðŸŽ®</div>Loading...</div></div></div>

    <script type="text/babel">
    console.log('Command Center v6.1.3 starting...');
    
    // =========================================================================
    // FIREBASE CONFIG
    // =========================================================================
    
    const FIREBASE_CONFIG = {
        apiKey: "AIzaSyBQVwn8vOrFTzLlm2MYIPBwgZV2xR9AuhM",
        authDomain: "word-boxing.firebaseapp.com",
        databaseURL: "https://word-boxing-default-rtdb.firebaseio.com",
        projectId: "word-boxing"
    };
    
    // Initialize Firebase
    let firebaseApp = null;
    let firebaseAuth = null;
    let firebaseDb = null;
    
    try {
        if (!firebase.apps.length) {
            firebaseApp = firebase.initializeApp(FIREBASE_CONFIG);
        } else {
            firebaseApp = firebase.apps[0];
        }
        firebaseAuth = firebase.auth();
        firebaseDb = firebase.database();
        console.log('Firebase initialized successfully');
    } catch (e) {
        console.error('Firebase init error:', e);
    }
    
    // =========================================================================
    // VERSION UTILITIES
    // =========================================================================
    
    function extractVersionFromHTML(content) {
        // Pattern 1: <meta name="version" content="1.0.0">
        const metaMatch = content.match(/<meta\s+name=["']version["']\s+content=["']([^"']+)["']/i);
        if (metaMatch) return metaMatch[1];
        
        // Pattern 2: <meta content="1.0.0" name="version">
        const metaMatch2 = content.match(/<meta\s+content=["']([^"']+)["']\s+name=["']version["']/i);
        if (metaMatch2) return metaMatch2[1];
        
        // Pattern 3: <!-- VERSION: 1.0.0 -->
        const commentMatch = content.match(/<!--\s*VERSION:\s*([^\s]+)\s*-->/i);
        if (commentMatch) return commentMatch[1];
        
        // Pattern 4: const APP_VERSION = '1.0.0' or "1.0.0"
        const constMatch = content.match(/(?:const|let|var)\s+(?:APP_)?VERSION\s*=\s*['"]([^'"]+)['"]/i);
        if (constMatch) return constMatch[1];
        
        // Pattern 5: data-version="1.0.0" on html or body tag
        const dataMatch = content.match(/data-version=["']([^"']+)["']/i);
        if (dataMatch) return dataMatch[1];
        
        // Pattern 6: "version": "1.0.0" in package.json style or inline JSON
        const jsonMatch = content.match(/["']version["']\s*:\s*["']([^"']+)["']/i);
        if (jsonMatch) return jsonMatch[1];
        
        // Pattern 7: @version 1.0.0 in JSDoc style comments
        const jsdocMatch = content.match(/@version\s+(\d+\.\d+\.\d+)/i);
        if (jsdocMatch) return jsdocMatch[1];
        
        // Pattern 8: Version 1.0.0 or v1.0.0 in title or comments
        const titleMatch = content.match(/(?:Version|v)[\s:]*(\d+\.\d+\.\d+)/i);
        if (titleMatch) return titleMatch[1];
        
        return null;
    }
    
    function parseVersion(version) {
        if (!version) return null;
        const parts = version.replace(/^v/i, '').split('.').map(p => parseInt(p, 10) || 0);
        while (parts.length < 4) parts.push(0);
        return parts;
    }
    
    function compareVersions(a, b) {
        const pa = parseVersion(a);
        const pb = parseVersion(b);
        if (!pa || !pb) return 0;
        for (let i = 0; i < 4; i++) {
            if (pa[i] > pb[i]) return 1;
            if (pa[i] < pb[i]) return -1;
        }
        return 0;
    }
    
    function isNewerVersion(newVersion, currentVersion) {
        if (!currentVersion) return true;
        return compareVersions(newVersion, currentVersion) > 0;
    }
    
    function formatVersion(v) {
        return v ? `v${v}` : 'â€”';
    }

    // =========================================================================
    // DEFAULT APPS
    // =========================================================================
    
    const DEFAULT_APPS = {
        gameshelf: {
            id: 'gameshelf', name: 'Game Shelf', icon: 'ðŸ“š',
            testRepo: '', prodRepo: '',
            targetPath: 'index.html', swPath: 'sw.js', hasServiceWorker: true,
            currentTestVersion: '', currentProdVersion: '',
            repoPatterns: { test: ['gameshelftest', 'gameshelf-test'], prod: ['gameshelf'] }
        },
        slate: {
            id: 'slate', name: 'Slate', icon: 'ðŸª¨',
            testRepo: '', prodRepo: '',
            targetPath: 'index.html', swPath: '', hasServiceWorker: false,
            currentTestVersion: '', currentProdVersion: '',
            repoPatterns: { test: ['slatetest', 'slate-test'], prod: ['slate'] }
        },
        rungs: {
            id: 'rungs', name: 'Rungs', icon: 'ðŸªœ',
            testRepo: '', prodRepo: '',
            targetPath: 'index.html', swPath: '', hasServiceWorker: false,
            currentTestVersion: '', currentProdVersion: '',
            repoPatterns: { test: ['rungstest', 'rungs-test'], prod: ['rungs'] }
        },
        quotle: {
            id: 'quotle', name: 'Quotle', icon: 'ðŸ’¬',
            testRepo: '', prodRepo: '',
            targetPath: 'index.html', swPath: '', hasServiceWorker: false,
            currentTestVersion: '', currentProdVersion: '',
            repoPatterns: { test: ['quotletest', 'quotle-test'], prod: ['quotle'] }
        },
        wordboxing: {
            id: 'wordboxing', name: 'Word Boxing', icon: 'ðŸ¥Š',
            testRepo: '', prodRepo: '',
            targetPath: 'index.html', swPath: '', hasServiceWorker: false,
            currentTestVersion: '', currentProdVersion: '',
            repoPatterns: { test: ['wordboxingtest', 'wordboxing-test'], prod: ['wordboxing'] }
        },
        testplan: {
            id: 'testplan', name: 'Test Plan', icon: 'ðŸ§ª',
            testRepo: '', prodRepo: '',
            targetPath: 'index.html', swPath: '', hasServiceWorker: false,
            currentTestVersion: '', currentProdVersion: '',
            repoPatterns: { test: ['gameshelf-testplan'], prod: ['testplan'] }
        },
        management: {
            id: 'management', name: 'Management', icon: 'ðŸ”§',
            testRepo: '', prodRepo: '',
            targetPath: 'index.html', swPath: '', hasServiceWorker: false,
            currentTestVersion: '', currentProdVersion: '',
            repoPatterns: { test: ['managementtest', 'management-test'], prod: ['management', 'managementprod', 'management-prod'] }
        }
    };

    // =========================================================================
    // ICONS
    // =========================================================================
    
    const Icons = {
        Upload: () => <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12" /></svg>,
        Rocket: () => <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M15.59 14.37a6 6 0 01-5.84 7.38v-4.8m5.84-2.58a14.98 14.98 0 006.16-12.12A14.98 14.98 0 009.631 8.41m5.96 5.96a14.926 14.926 0 01-5.841 2.58m-.119-8.54a6 6 0 00-7.381 5.84h4.8m2.581-5.84a14.927 14.927 0 00-2.58 5.84m2.699 2.7c-.103.021-.207.041-.311.06a15.09 15.09 0 01-2.448-2.448 14.9 14.9 0 01.06-.312m-2.24 2.39a4.493 4.493 0 00-1.757 4.306 4.493 4.493 0 004.306-1.758M16.5 9a1.5 1.5 0 11-3 0 1.5 1.5 0 013 0z" /></svg>,
        X: () => <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M6 18L18 6M6 6l12 12" /></svg>,
        Settings: () => <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" /><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" /></svg>,
        History: () => <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>,
        ExternalLink: () => <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14" /></svg>,
        ArrowRight: () => <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M14 5l7 7m0 0l-7 7m7-7H3" /></svg>,
        Zap: () => <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M13 10V3L4 14h7v7l9-11h-7z" /></svg>,
        AlertTriangle: () => <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" /></svg>,
        Rewind: () => <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12.066 11.2a1 1 0 000 1.6l5.334 4A1 1 0 0019 16V8a1 1 0 00-1.6-.8l-5.333 4zM4.066 11.2a1 1 0 000 1.6l5.334 4A1 1 0 0011 16V8a1 1 0 00-1.6-.8l-5.334 4z" /></svg>,
        GitBranch: () => <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M8 9l3 3-3 3m5 0h3M5 20h14a2 2 0 002-2V6a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" /></svg>,
        Check: () => <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M5 13l4 4L19 7" /></svg>,
        Shield: () => <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z" /></svg>,
        Refresh: () => <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" /></svg>,
        Play: () => <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M14.752 11.168l-3.197-2.132A1 1 0 0010 9.87v4.263a1 1 0 001.555.832l3.197-2.132a1 1 0 000-1.664z" /><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>,
        Folder: () => <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M3 7v10a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-6l-2-2H5a2 2 0 00-2 2z" /></svg>,
        File: () => <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" /></svg>,
        Trash: () => <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg>,
        Archive: () => <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M5 8h14M5 8a2 2 0 110-4h14a2 2 0 110 4M5 8v10a2 2 0 002 2h10a2 2 0 002-2V8m-9 4h4" /></svg>,
        Eye: () => <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" /><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" /></svg>,
        Download: () => <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" /></svg>,
        Plus: () => <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 4v16m8-8H4" /></svg>,
        Database: () => <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4 7v10c0 2.21 3.582 4 8 4s8-1.79 8-4V7M4 7c0 2.21 3.582 4 8 4s8-1.79 8-4M4 7c0-2.21 3.582-4 8-4s8 1.79 8 4m0 5c0 2.21-3.582 4-8 4s-8-1.79-8-4" /></svg>,
        User: () => <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" /></svg>,
        Edit: () => <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" /></svg>,
        Copy: () => <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z" /></svg>,
    };

    // =========================================================================
    // UTILITIES
    // =========================================================================
    
    function parseFilename(filename) {
        const patterns = [
            /^(gameshelf|game[-_]?shelf)[-_]v?(\d+)[_.](\d+)[_.](\d+)[_.](\d+)\.html$/i,
            /^(\w+)[-_]v?(\d+)[_.](\d+)[_.](\d+)\.html$/i,
        ];
        for (const pattern of patterns) {
            const match = filename.match(pattern);
            if (match) {
                let app = match[1].toLowerCase().replace(/[-_]/g, '');
                const version = match.length === 6 
                    ? `${match[2]}.${match[3]}.${match[4]}.${match[5]}`
                    : `${match[2]}.${match[3]}.${match[4]}`;
                return { app, version };
            }
        }
        const appMatch = filename.match(/^(\w+)/);
        return { app: appMatch ? appMatch[1].toLowerCase() : null, version: null };
    }
    
    function formatBytes(bytes) {
        if (bytes < 1024) return bytes + ' B';
        if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + ' KB';
        return (bytes / (1024 * 1024)).toFixed(2) + ' MB';
    }
    
    function formatDate(date) {
        return new Date(date).toLocaleString();
    }
    
    function getGitHubPagesUrl(repo) {
        if (!repo) return null;
        const [owner, repoName] = repo.split('/');
        return `https://${owner}.github.io/${repoName}/`;
    }
    
    function autoMapRepos(apps, repos) {
        const updatedApps = { ...apps };
        console.log('Auto-mapping repos. Available:', repos.map(r => r.name));
        
        for (const [appId, app] of Object.entries(updatedApps)) {
            const patterns = app.repoPatterns;
            if (!patterns) continue;
            
            if (!app.testRepo) {
                for (const pattern of patterns.test) {
                    const found = repos.find(r => r.name.toLowerCase() === pattern.toLowerCase());
                    if (found) { 
                        console.log(`[${appId}] Mapped TEST: ${found.fullName}`);
                        updatedApps[appId] = { ...updatedApps[appId], testRepo: found.fullName }; 
                        break; 
                    }
                }
            }
            if (!app.prodRepo) {
                for (const pattern of patterns.prod) {
                    const found = repos.find(r => r.name.toLowerCase() === pattern.toLowerCase() && !r.name.toLowerCase().includes('test'));
                    if (found) { 
                        console.log(`[${appId}] Mapped PROD: ${found.fullName}`);
                        updatedApps[appId] = { ...updatedApps[appId], prodRepo: found.fullName }; 
                        break; 
                    }
                }
            }
        }
        return updatedApps;
    }
    
    function getFileIcon(filename) {
        const ext = filename.split('.').pop()?.toLowerCase();
        const icons = {
            html: 'ðŸ“„', js: 'ðŸ“œ', css: 'ðŸŽ¨', json: 'ðŸ“‹', md: 'ðŸ“',
            png: 'ðŸ–¼ï¸', jpg: 'ðŸ–¼ï¸', jpeg: 'ðŸ–¼ï¸', gif: 'ðŸ–¼ï¸', svg: 'ðŸŽ¨',
            ico: 'ðŸ”·', txt: 'ðŸ“ƒ', xml: 'ðŸ“°'
        };
        return icons[ext] || 'ðŸ“„';
    }

    // =========================================================================
    // GITHUB API
    // =========================================================================
    
    class GitHubAPI {
        constructor(token) {
            this.token = token;
            this.baseUrl = 'https://api.github.com';
        }
        
        async request(endpoint, options = {}) {
            const response = await fetch(`${this.baseUrl}${endpoint}`, {
                ...options,
                headers: {
                    'Authorization': `token ${this.token}`,
                    'Accept': 'application/vnd.github.v3+json',
                    'Content-Type': 'application/json',
                    ...options.headers
                }
            });
            if (!response.ok) {
                const error = await response.json().catch(() => ({}));
                throw new Error(error.message || `GitHub API error: ${response.status}`);
            }
            return response.json();
        }
        
        async listRepos() {
            const repos = await this.request('/user/repos?per_page=100&sort=updated');
            return repos.map(r => ({ fullName: r.full_name, name: r.name, owner: r.owner.login }));
        }
        
        async getFile(repo, path) {
            try {
                const [owner, repoName] = repo.split('/');
                // Add timestamp to bust GitHub API cache
                return await this.request(`/repos/${owner}/${repoName}/contents/${path}?_=${Date.now()}`);
            } catch { return null; }
        }
        
        async getFileAtCommit(repo, path, commitSha) {
            try {
                const [owner, repoName] = repo.split('/');
                return await this.request(`/repos/${owner}/${repoName}/contents/${path}?ref=${commitSha}`);
            } catch { return null; }
        }
        
        async listRepoContents(repo, path = '') {
            try {
                const [owner, repoName] = repo.split('/');
                const endpoint = path 
                    ? `/repos/${owner}/${repoName}/contents/${path}`
                    : `/repos/${owner}/${repoName}/contents`;
                // Add timestamp to bust any caching
                const cacheBuster = `?_=${Date.now()}`;
                const contents = await this.request(endpoint + cacheBuster);
                return Array.isArray(contents) ? contents : [contents];
            } catch { return []; }
        }
        
        async createOrUpdateFile(repo, path, content, message, sha = null) {
            const [owner, repoName] = repo.split('/');
            const body = {
                message,
                content: btoa(unescape(encodeURIComponent(content))),
                committer: { name: 'Command Center', email: 'deploy@gameshelf.app' }
            };
            if (sha) body.sha = sha;
            return this.request(`/repos/${owner}/${repoName}/contents/${path}`, { method: 'PUT', body: JSON.stringify(body) });
        }
        
        async deleteFile(repo, path, message, sha) {
            const [owner, repoName] = repo.split('/');
            return this.request(`/repos/${owner}/${repoName}/contents/${path}`, {
                method: 'DELETE',
                body: JSON.stringify({
                    message,
                    sha,
                    committer: { name: 'Command Center', email: 'deploy@gameshelf.app' }
                })
            });
        }
        
        async createTag(repo, tagName, sha, message) {
            const [owner, repoName] = repo.split('/');
            const tagObj = await this.request(`/repos/${owner}/${repoName}/git/tags`, {
                method: 'POST',
                body: JSON.stringify({
                    tag: tagName, message, object: sha, type: 'commit',
                    tagger: { name: 'Command Center', email: 'deploy@gameshelf.app', date: new Date().toISOString() }
                })
            });
            await this.request(`/repos/${owner}/${repoName}/git/refs`, {
                method: 'POST',
                body: JSON.stringify({ ref: `refs/tags/${tagName}`, sha: tagObj.sha })
            });
            return tagObj;
        }
        
        async enablePages(repo) {
            const [owner, repoName] = repo.split('/');
            try {
                await this.request(`/repos/${owner}/${repoName}/pages`);
                return { alreadyEnabled: true };
            } catch {}
            const response = await fetch(`${this.baseUrl}/repos/${owner}/${repoName}/pages`, {
                method: 'POST',
                headers: { 'Authorization': `token ${this.token}`, 'Accept': 'application/vnd.github.v3+json', 'Content-Type': 'application/json' },
                body: JSON.stringify({ source: { branch: 'main', path: '/' } })
            });
            if (!response.ok) throw new Error(`Failed to enable Pages`);
            return { enabled: true };
        }
        
        // Batch commit multiple files in one commit
        async batchCommit(repo, files, message) {
            const [owner, repoName] = repo.split('/');
            
            console.log('=== BATCH COMMIT START ===');
            console.log('Repo:', repo);
            console.log('Message:', message);
            console.log('Files to commit:', files.map(f => ({ path: f.path, contentLength: f.content?.length, encoding: f.encoding })));
            
            // Get current commit SHA
            const ref = await this.request(`/repos/${owner}/${repoName}/git/ref/heads/main`);
            const commitSha = ref.object.sha;
            console.log('Current commit SHA:', commitSha);
            
            // Get current tree
            const commit = await this.request(`/repos/${owner}/${repoName}/git/commits/${commitSha}`);
            const treeSha = commit.tree.sha;
            console.log('Current tree SHA:', treeSha);
            
            // Create blobs for each file
            const treeItems = await Promise.all(files.map(async (file) => {
                console.log('Creating blob for:', file.path);
                const blob = await this.request(`/repos/${owner}/${repoName}/git/blobs`, {
                    method: 'POST',
                    body: JSON.stringify({
                        content: file.content,
                        encoding: file.encoding || 'utf-8'
                    })
                });
                console.log('Blob created:', file.path, '-> SHA:', blob.sha);
                return {
                    path: file.path,
                    mode: '100644',
                    type: 'blob',
                    sha: blob.sha
                };
            }));
            
            console.log('Tree items:', treeItems);
            
            // Create new tree
            const newTree = await this.request(`/repos/${owner}/${repoName}/git/trees`, {
                method: 'POST',
                body: JSON.stringify({
                    base_tree: treeSha,
                    tree: treeItems
                })
            });
            console.log('New tree SHA:', newTree.sha);
            
            // Create commit
            const newCommit = await this.request(`/repos/${owner}/${repoName}/git/commits`, {
                method: 'POST',
                body: JSON.stringify({
                    message,
                    tree: newTree.sha,
                    parents: [commitSha],
                    committer: { name: 'Command Center', email: 'deploy@gameshelf.app' }
                })
            });
            console.log('New commit SHA:', newCommit.sha);
            
            // Update ref
            const updatedRef = await this.request(`/repos/${owner}/${repoName}/git/refs/heads/main`, {
                method: 'PATCH',
                body: JSON.stringify({ sha: newCommit.sha })
            });
            console.log('Ref updated:', updatedRef);
            console.log('=== BATCH COMMIT COMPLETE ===');
            
            return newCommit;
        }
    }

    // =========================================================================
    // MAIN APP
    // =========================================================================
    
    function App() {
        const [view, setView] = React.useState('dashboard');
        const [githubToken, setGithubToken] = React.useState(() => {
            try { return localStorage.getItem('cc_token') || ''; } catch { return ''; }
        });
        const [apps, setApps] = React.useState(() => {
            try { const s = localStorage.getItem('cc_apps_v6'); return s ? JSON.parse(s) : DEFAULT_APPS; } catch { return DEFAULT_APPS; }
        });
        const [stagedFiles, setStagedFiles] = React.useState([]);
        const [deployments, setDeployments] = React.useState(() => {
            try { const s = localStorage.getItem('cc_history_v2'); return s ? JSON.parse(s) : []; } catch { return []; }
        });
        const [activeDeployment, setActiveDeployment] = React.useState(null);
        const [availableRepos, setAvailableRepos] = React.useState([]);
        const [modal, setModal] = React.useState(null);
        const [settings, setSettings] = React.useState({ createTag: true, updateServiceWorker: true });
        const [refreshing, setRefreshing] = React.useState(false);
        const [repoFiles, setRepoFiles] = React.useState({}); // { repoFullName: { files: [], loading: bool } }
        const [selectedRepoForBrowse, setSelectedRepoForBrowse] = React.useState(null);
        const [markedForDeletion, setMarkedForDeletion] = React.useState([]); // [{ repo, path, sha }]
        
        // Use ref to always have latest apps state for async operations
        const appsRef = React.useRef(apps);
        React.useEffect(() => { appsRef.current = apps; }, [apps]);
        
        const github = React.useMemo(() => githubToken ? new GitHubAPI(githubToken) : null, [githubToken]);
        
        // Persist
        React.useEffect(() => { try { if (githubToken) localStorage.setItem('cc_token', githubToken); } catch {} }, [githubToken]);
        React.useEffect(() => { try { localStorage.setItem('cc_apps_v6', JSON.stringify(apps)); } catch {} }, [apps]);
        React.useEffect(() => { try { localStorage.setItem('cc_history_v2', JSON.stringify(deployments.slice(0, 100))); } catch {} }, [deployments]);
        
        // Fetch repos and auto-refresh versions on load
        React.useEffect(() => {
            if (github) {
                github.listRepos().then(async (repos) => {
                    setAvailableRepos(repos);
                    
                    // Get current apps state and map repos
                    setApps(prev => {
                        const mapped = autoMapRepos(prev, repos);
                        return mapped;
                    });
                    
                    // Small delay to let state settle, then refresh versions
                    await new Promise(r => setTimeout(r, 500));
                    refreshAllVersions();
                }).catch(console.error);
            }
        }, [github]);
        
        // Refresh all versions from repos
        const refreshAllVersions = async () => {
            if (!github) return;
            setRefreshing(true);
            
            // Always use latest apps state from ref
            const currentApps = appsRef.current;
            console.log('=== REFRESHING VERSIONS FROM REPOS ===');
            
            const updates = {};
            for (const [appId, app] of Object.entries(currentApps)) {
                if (app.testRepo) {
                    try {
                        console.log(`[${appId}] Fetching TEST from ${app.testRepo}/${app.targetPath}...`);
                        const testFile = await github.getFile(app.testRepo, app.targetPath);
                        if (testFile) {
                            const content = atob(testFile.content);
                            const version = extractVersionFromHTML(content);
                            console.log(`[${appId}] TEST version from REPO: ${version || 'NO VERSION'}`);
                            console.log(`[${appId}] TEST file SHA: ${testFile.sha}`);
                            if (version) updates[appId] = { ...updates[appId], currentTestVersion: version };
                        } else {
                            console.log(`[${appId}] TEST: FILE NOT FOUND`);
                        }
                    } catch (e) {
                        console.error(`[${appId}] TEST error:`, e.message);
                    }
                }
                if (app.prodRepo) {
                    try {
                        console.log(`[${appId}] Fetching PROD from ${app.prodRepo}/${app.targetPath}...`);
                        const prodFile = await github.getFile(app.prodRepo, app.targetPath);
                        if (prodFile) {
                            const content = atob(prodFile.content);
                            const version = extractVersionFromHTML(content);
                            console.log(`[${appId}] PROD version from REPO: ${version || 'NO VERSION'}`);
                            console.log(`[${appId}] PROD file SHA: ${prodFile.sha}`);
                            if (version) updates[appId] = { ...updates[appId], currentProdVersion: version };
                        } else {
                            console.log(`[${appId}] PROD: FILE NOT FOUND`);
                        }
                    } catch (e) {
                        console.error(`[${appId}] PROD error:`, e.message);
                    }
                }
            }
            
            setApps(prev => {
                const newApps = { ...prev };
                for (const [appId, upd] of Object.entries(updates)) {
                    newApps[appId] = { ...newApps[appId], ...upd };
                }
                console.log('Updated apps state:', Object.entries(newApps).map(([id, a]) => `${id}: TEST=${a.currentTestVersion || 'â€”'}, PROD=${a.currentProdVersion || 'â€”'}`));
                return newApps;
            });
            
            setRefreshing(false);
            console.log('=== REFRESH COMPLETE ===');
        };
        
        // Load repo files
        const loadRepoFiles = async (repo) => {
            if (!github || !repo) return;
            setRepoFiles(prev => ({ ...prev, [repo]: { files: [], loading: true } }));
            
            const files = await github.listRepoContents(repo);
            setRepoFiles(prev => ({ ...prev, [repo]: { files, loading: false } }));
        };
        
        const updateApp = (appId, updates) => setApps(prev => ({ ...prev, [appId]: { ...prev[appId], ...updates } }));
        
        // File upload - now accepts multiple file types
        const handleFileDrop = (e) => {
            e.preventDefault();
            const files = e.dataTransfer?.files || e.target.files;
            
            Array.from(files).forEach(file => {
                const reader = new FileReader();
                reader.onload = (e) => {
                    const content = e.target.result;
                    const isText = file.type.startsWith('text/') || 
                        /\.(html|js|css|json|md|txt|xml|svg)$/i.test(file.name);
                    
                    const parsed = parseFilename(file.name);
                    let version = null;
                    let versionSource = 'none';
                    
                    if (file.name.endsWith('.html') && isText) {
                        const htmlVersion = extractVersionFromHTML(content);
                        version = htmlVersion || parsed.version;
                        versionSource = htmlVersion ? 'html' : (parsed.version ? 'filename' : 'none');
                    }
                    
                    console.log('=== FILE UPLOADED ===');
                    console.log('Name:', file.name);
                    console.log('Size:', file.size);
                    console.log('Version extracted:', version);
                    console.log('Content length:', content.length);
                    console.log('Content preview (first 200 chars):', content.substring(0, 200));
                    
                    setStagedFiles(prev => [...prev, {
                        id: Date.now() + Math.random(),
                        name: file.name,
                        size: file.size,
                        content: isText ? content : btoa(content),
                        encoding: isText ? 'utf-8' : 'base64',
                        isText,
                        suggestedApp: parsed.app,
                        version,
                        versionSource,
                        // Default HTML files to index.html, others keep original name
                        targetPath: file.name.endsWith('.html') ? 'index.html' : file.name
                    }]);
                };
                
                if (file.type.startsWith('text/') || /\.(html|js|css|json|md|txt|xml|svg)$/i.test(file.name)) {
                    reader.readAsText(file);
                } else {
                    reader.readAsBinaryString(file);
                }
            });
        };
        
        const removeStaged = (id) => setStagedFiles(prev => prev.filter(f => f.id !== id));
        const updateStagedFile = (id, updates) => setStagedFiles(prev => prev.map(f => f.id === id ? { ...f, ...updates } : f));
        
        // Get current deployed version from repo
        const fetchCurrentVersion = async (repo, targetPath) => {
            if (!github || !repo) return null;
            const file = await github.getFile(repo, targetPath);
            if (!file) return null;
            const content = atob(file.content);
            return extractVersionFromHTML(content);
        };
        
        // Deploy single file (legacy support)
        const handleDeploy = async (file, appId, target, forceDeploy = false) => {
            if (!github) return alert('Configure GitHub token');
            
            const app = apps[appId];
            const repo = target === 'prod' ? app.prodRepo : app.testRepo;
            if (!repo) return alert(`Configure ${target} repo`);
            
            const currentVersion = await fetchCurrentVersion(repo, app.targetPath);
            const newVersion = file.version;
            
            if (!forceDeploy && currentVersion && newVersion) {
                if (!isNewerVersion(newVersion, currentVersion)) {
                    setModal({ type: 'versionWarning', data: { file, appId, target, currentVersion, newVersion } });
                    return;
                }
            }
            
            const deployment = {
                id: Date.now(), status: 'running', steps: [],
                appId, appName: app.name, repo, target,
                version: newVersion || 'unknown',
                previousVersion: currentVersion,
                startedAt: new Date().toISOString(),
                fileContent: file.content
            };
            
            setActiveDeployment(deployment);
            setDeployments(prev => [deployment, ...prev]);
            
            const addStep = (name, status, details = null) => {
                const existingIndex = deployment.steps.findIndex(s => s.name === name);
                if (existingIndex >= 0) {
                    deployment.steps[existingIndex] = { name, status, details };
                } else {
                    deployment.steps.push({ name, status, details });
                }
                setActiveDeployment({ ...deployment });
            };
            
            try {
                addStep('Validating', 'running');
                addStep('Validating', 'complete', `${formatVersion(newVersion)} (${formatBytes(file.size)})`);
                
                addStep('Safety Check', 'running');
                if (currentVersion) {
                    if (isNewerVersion(newVersion, currentVersion)) {
                        addStep('Safety Check', 'complete', `${formatVersion(currentVersion)} â†’ ${formatVersion(newVersion)} âœ“`);
                    } else {
                        addStep('Safety Check', 'warning', `Force deploy: ${formatVersion(currentVersion)} â†’ ${formatVersion(newVersion)}`);
                    }
                } else {
                    addStep('Safety Check', 'complete', 'First deploy');
                }
                
                addStep('Committing', 'running');
                const currentFile = await github.getFile(repo, file.targetPath || app.targetPath);
                const result = await github.createOrUpdateFile(
                    repo, file.targetPath || app.targetPath, file.content,
                    `Deploy ${app.name} ${formatVersion(newVersion)}${currentVersion ? ` (was ${formatVersion(currentVersion)})` : ''}`,
                    currentFile?.sha
                );
                deployment.commitSha = result.commit.sha;
                addStep('Committing', 'complete', result.commit.sha.substring(0, 7));
                
                addStep('GitHub Pages', 'running');
                try {
                    const pagesResult = await github.enablePages(repo);
                    addStep('GitHub Pages', 'complete', pagesResult.alreadyEnabled ? 'Ready' : 'Enabled!');
                } catch (e) {
                    addStep('GitHub Pages', 'warning', e.message);
                }
                
                if (settings.createTag && newVersion) {
                    addStep('Tagging', 'running');
                    try {
                        const tag = target === 'prod' ? `v${newVersion}` : `v${newVersion}-test`;
                        await github.createTag(repo, tag, result.commit.sha, `Release ${newVersion}`);
                        addStep('Tagging', 'complete', tag);
                    } catch {
                        addStep('Tagging', 'warning', 'Tag may exist');
                    }
                }
                
                deployment.status = 'success';
                deployment.url = getGitHubPagesUrl(repo);
                updateApp(appId, { [target === 'prod' ? 'currentProdVersion' : 'currentTestVersion']: newVersion });
                removeStaged(file.id);
                
            } catch (error) {
                deployment.status = 'failed';
                deployment.error = error.message;
                addStep('Error', 'error', error.message);
            }
            
            deployment.completedAt = new Date().toISOString();
            setActiveDeployment({ ...deployment });
            setDeployments(prev => prev.map(d => d.id === deployment.id ? deployment : d));
        };
        
        // Multi-file batch deploy
        const handleBatchDeploy = async (files, appId, target) => {
            if (!github) return alert('Configure GitHub token');
            if (files.length === 0) return;
            
            // Log file details for debugging
            console.log('handleBatchDeploy received:', files.map(f => ({
                name: f.name,
                id: f.id,
                targetPath: f.targetPath,
                contentLength: f.content?.length,
                contentPreview: f.content?.substring(0, 100)
            })));
            
            const app = apps[appId];
            const repo = target === 'prod' ? app.prodRepo : app.testRepo;
            if (!repo) return alert(`Configure ${target} repo`);
            
            // Find version from index.html if present
            const indexFile = files.find(f => f.targetPath === 'index.html' || f.name === 'index.html');
            const newVersion = indexFile?.version || 'batch';
            
            const deployment = {
                id: Date.now(), status: 'running', steps: [],
                appId, appName: app.name, repo, target,
                version: newVersion,
                startedAt: new Date().toISOString(),
                fileCount: files.length
            };
            
            setActiveDeployment(deployment);
            setDeployments(prev => [deployment, ...prev]);
            
            const addStep = (name, status, details = null) => {
                const existingIndex = deployment.steps.findIndex(s => s.name === name);
                if (existingIndex >= 0) {
                    deployment.steps[existingIndex] = { name, status, details };
                } else {
                    deployment.steps.push({ name, status, details });
                }
                setActiveDeployment({ ...deployment });
            };
            
            try {
                addStep('Preparing batch', 'running');
                addStep('Preparing batch', 'complete', `${files.length} files`);
                
                addStep('Creating commit', 'running');
                const filesToCommit = files.map(f => ({
                    path: f.targetPath || f.name,
                    content: f.content,
                    encoding: f.encoding
                }));
                
                const result = await github.batchCommit(
                    repo,
                    filesToCommit,
                    `Deploy ${app.name} ${formatVersion(newVersion)} (${files.length} files)`
                );
                deployment.commitSha = result.sha;
                addStep('Creating commit', 'complete', result.sha.substring(0, 7));
                
                addStep('GitHub Pages', 'running');
                try {
                    await github.enablePages(repo);
                    addStep('GitHub Pages', 'complete', 'Ready');
                } catch (e) {
                    addStep('GitHub Pages', 'warning', e.message);
                }
                
                if (settings.createTag && newVersion !== 'batch') {
                    addStep('Tagging', 'running');
                    try {
                        const tag = target === 'prod' ? `v${newVersion}` : `v${newVersion}-test`;
                        await github.createTag(repo, tag, result.sha, `Release ${newVersion}`);
                        addStep('Tagging', 'complete', tag);
                    } catch {
                        addStep('Tagging', 'warning', 'Tag may exist');
                    }
                }
                
                deployment.status = 'success';
                deployment.url = getGitHubPagesUrl(repo);
                
                // Verify the deployment by fetching back from repo
                console.log('=== VERIFYING DEPLOYMENT ===');
                await new Promise(r => setTimeout(r, 1000)); // Wait a bit for GitHub to process
                const verifyFile = await github.getFile(repo, files[0]?.targetPath || files[0]?.path || 'index.html');
                if (verifyFile) {
                    const verifyContent = atob(verifyFile.content);
                    const verifyVersion = extractVersionFromHTML(verifyContent);
                    console.log('Verification - version in repo after deploy:', verifyVersion);
                    console.log('Verification - expected version:', newVersion);
                    if (verifyVersion !== newVersion && newVersion !== 'batch') {
                        console.error('VERSION MISMATCH! Deploy may have failed.');
                        addStep('Verification', 'warning', `Expected ${newVersion}, found ${verifyVersion}`);
                    } else {
                        addStep('Verification', 'complete', `Confirmed ${verifyVersion}`);
                    }
                }
                
                if (newVersion !== 'batch') {
                    updateApp(appId, { [target === 'prod' ? 'currentProdVersion' : 'currentTestVersion']: newVersion });
                }
                
                // Refresh all versions to ensure UI is in sync with repos
                setTimeout(() => refreshAllVersions(), 500);
                
                // Remove deployed files from staged
                files.forEach(f => removeStaged(f.id));
                
            } catch (error) {
                deployment.status = 'failed';
                deployment.error = error.message;
                addStep('Error', 'error', error.message);
            }
            
            deployment.completedAt = new Date().toISOString();
            setActiveDeployment({ ...deployment });
            setDeployments(prev => prev.map(d => d.id === deployment.id ? deployment : d));
        };
        
        // Delete marked files
        const handleDeleteMarkedFiles = async () => {
            if (!github || markedForDeletion.length === 0) return;
            
            setModal(null);
            
            // Show loading state on affected repos
            const affectedRepos = [...new Set(markedForDeletion.map(i => i.repo))];
            for (const repo of affectedRepos) {
                setRepoFiles(prev => ({ ...prev, [repo]: { ...prev[repo], loading: true } }));
            }
            
            let successCount = 0;
            let failCount = 0;
            
            for (const item of markedForDeletion) {
                try {
                    await github.deleteFile(item.repo, item.path, `Delete ${item.path}`, item.sha);
                    successCount++;
                } catch (e) {
                    console.error(`Failed to delete ${item.path}:`, e);
                    failCount++;
                }
            }
            
            // Clear marked files
            setMarkedForDeletion([]);
            
            // Wait a moment for GitHub to process, then refresh
            await new Promise(resolve => setTimeout(resolve, 1500));
            
            for (const repo of affectedRepos) {
                await loadRepoFiles(repo);
            }
            
            // Show result
            if (failCount > 0) {
                alert(`Deleted ${successCount} file(s), ${failCount} failed`);
            }
        };
        
        // Promote TEST â†’ PROD
        const handlePromote = async (appId) => {
            const app = apps[appId];
            if (!app.testRepo || !app.prodRepo) return;
            
            setModal(null);
            
            const deployment = {
                id: Date.now(), status: 'running', steps: [],
                appId, appName: app.name, repo: app.prodRepo, target: 'prod',
                isPromotion: true, version: app.currentTestVersion,
                startedAt: new Date().toISOString()
            };
            
            setActiveDeployment(deployment);
            setDeployments(prev => [deployment, ...prev]);
            
            const addStep = (name, status, details = null) => {
                const existingIndex = deployment.steps.findIndex(s => s.name === name);
                if (existingIndex >= 0) {
                    deployment.steps[existingIndex] = { name, status, details };
                } else {
                    deployment.steps.push({ name, status, details });
                }
                setActiveDeployment({ ...deployment });
            };
            
            try {
                addStep('Fetching from TEST', 'running');
                const testFile = await github.getFile(app.testRepo, app.targetPath);
                if (!testFile) throw new Error('File not found');
                const content = atob(testFile.content);
                const testVersion = extractVersionFromHTML(content);
                deployment.fileContent = content;
                addStep('Fetching from TEST', 'complete', formatVersion(testVersion));
                
                addStep('Checking PROD', 'running');
                const prodFile = await github.getFile(app.prodRepo, app.targetPath);
                const prodVersion = prodFile ? extractVersionFromHTML(atob(prodFile.content)) : null;
                deployment.previousVersion = prodVersion;
                addStep('Checking PROD', 'complete', prodVersion ? formatVersion(prodVersion) : 'Empty');
                
                addStep('Deploying', 'running');
                const result = await github.createOrUpdateFile(
                    app.prodRepo, app.targetPath, content,
                    `Promote ${app.name} ${formatVersion(testVersion)} from test`,
                    prodFile?.sha
                );
                deployment.commitSha = result.commit.sha;
                addStep('Deploying', 'complete', result.commit.sha.substring(0, 7));
                
                addStep('GitHub Pages', 'running');
                try {
                    await github.enablePages(app.prodRepo);
                    addStep('GitHub Pages', 'complete', 'Ready');
                } catch {
                    addStep('GitHub Pages', 'warning', 'Check settings');
                }
                
                if (settings.createTag && testVersion) {
                    addStep('Tagging', 'running');
                    try {
                        await github.createTag(app.prodRepo, `v${testVersion}`, result.commit.sha, 'Release');
                        addStep('Tagging', 'complete', `v${testVersion}`);
                    } catch {
                        addStep('Tagging', 'warning', 'May exist');
                    }
                }
                
                deployment.status = 'success';
                deployment.version = testVersion;
                deployment.url = getGitHubPagesUrl(app.prodRepo);
                updateApp(appId, { currentProdVersion: testVersion });
                
                // Force refresh to ensure UI is in sync
                setTimeout(() => refreshAllVersions(), 1000);
                
            } catch (error) {
                deployment.status = 'failed';
                deployment.error = error.message;
                addStep('Error', 'error', error.message);
            }
            
            deployment.completedAt = new Date().toISOString();
            setActiveDeployment({ ...deployment });
            setDeployments(prev => prev.map(d => d.id === deployment.id ? deployment : d));
        };
        
        // Rollback
        const handleRollback = async (deploymentToRollbackTo) => {
            const app = apps[deploymentToRollbackTo.appId];
            if (!app) return;
            
            setModal(null);
            
            const repo = deploymentToRollbackTo.repo;
            const targetVersion = deploymentToRollbackTo.version;
            
            const deployment = {
                id: Date.now(), status: 'running', steps: [],
                appId: deploymentToRollbackTo.appId, appName: app.name,
                repo, target: deploymentToRollbackTo.target,
                isRollback: true, version: targetVersion,
                rollbackFromCommit: null,
                rollbackToCommit: deploymentToRollbackTo.commitSha,
                startedAt: new Date().toISOString()
            };
            
            setActiveDeployment(deployment);
            setDeployments(prev => [deployment, ...prev]);
            
            const addStep = (name, status, details = null) => {
                const existingIndex = deployment.steps.findIndex(s => s.name === name);
                if (existingIndex >= 0) {
                    deployment.steps[existingIndex] = { name, status, details };
                } else {
                    deployment.steps.push({ name, status, details });
                }
                setActiveDeployment({ ...deployment });
            };
            
            try {
                addStep('Getting current state', 'running');
                const currentFile = await github.getFile(repo, app.targetPath);
                const currentVersion = currentFile ? extractVersionFromHTML(atob(currentFile.content)) : null;
                deployment.previousVersion = currentVersion;
                addStep('Getting current state', 'complete', formatVersion(currentVersion));
                
                addStep('Fetching rollback version', 'running');
                const rollbackFile = await github.getFileAtCommit(repo, app.targetPath, deploymentToRollbackTo.commitSha);
                if (!rollbackFile) throw new Error('Cannot find file at that commit');
                const content = atob(rollbackFile.content);
                deployment.fileContent = content;
                addStep('Fetching rollback version', 'complete', formatVersion(targetVersion));
                
                addStep('Rolling back', 'running');
                const result = await github.createOrUpdateFile(
                    repo, app.targetPath, content,
                    `Rollback ${app.name} to ${formatVersion(targetVersion)} (was ${formatVersion(currentVersion)})`,
                    currentFile?.sha
                );
                deployment.commitSha = result.commit.sha;
                addStep('Rolling back', 'complete', result.commit.sha.substring(0, 7));
                
                addStep('GitHub Pages', 'complete', 'Deploying...');
                
                deployment.status = 'success';
                deployment.url = getGitHubPagesUrl(repo);
                const versionKey = deploymentToRollbackTo.target === 'prod' ? 'currentProdVersion' : 'currentTestVersion';
                updateApp(deploymentToRollbackTo.appId, { [versionKey]: targetVersion });
                
            } catch (error) {
                deployment.status = 'failed';
                deployment.error = error.message;
                addStep('Error', 'error', error.message);
            }
            
            deployment.completedAt = new Date().toISOString();
            setActiveDeployment({ ...deployment });
            setDeployments(prev => prev.map(d => d.id === deployment.id ? deployment : d));
        };
        
        return (
            <div className="min-h-screen">
                <header className="bg-slate-800 border-b border-slate-700 sticky top-0 z-50">
                    <div className="max-w-6xl mx-auto px-4 py-3 flex items-center justify-between">
                        <div className="flex items-center gap-3">
                            <span className="text-2xl">ðŸŽ®</span>
                            <div>
                                <h1 className="text-lg font-bold">Command Center</h1>
                                <div className="text-xs text-slate-400">v6.1.3 â€¢ Firebase + Multi-File</div>
                            </div>
                        </div>
                        <div className="flex items-center gap-2">
                            <button onClick={() => refreshAllVersions()} disabled={refreshing}
                                className={`p-2 rounded hover:bg-slate-700 ${refreshing ? 'animate-spin text-indigo-400' : 'text-slate-400'}`}
                                title="Refresh versions">
                                <Icons.Refresh />
                            </button>
                            {['dashboard', 'files', 'firebase', 'apps', 'history', 'settings'].map(v => (
                                <button key={v} onClick={() => setView(v)}
                                    className={`px-3 py-1.5 rounded text-sm capitalize flex items-center gap-1 ${view === v ? 'bg-indigo-600' : 'text-slate-400 hover:text-white'}`}>
                                    {v === 'settings' && <Icons.Settings />}
                                    {v === 'files' && <><Icons.Folder /> Files</>}
                                    {v === 'firebase' && <><Icons.Database /> Firebase</>}
                                    {v === 'dashboard' && 'Dashboard'}
                                    {v === 'apps' && 'Apps'}
                                    {v === 'history' && 'History'}
                                </button>
                            ))}
                        </div>
                    </div>
                </header>
                
                <main className="max-w-6xl mx-auto px-4 py-6">
                    {!githubToken && (
                        <div className="mb-6 p-4 bg-amber-900/50 border border-amber-700 rounded-lg">
                            âš ï¸ <strong>GitHub Token Required</strong> - Go to Settings
                        </div>
                    )}
                    
                    {view === 'dashboard' && (
                        <DashboardView
                            apps={apps} stagedFiles={stagedFiles} github={github}
                            onFileDrop={handleFileDrop} onRemove={removeStaged}
                            onDeploy={handleDeploy} onBatchDeploy={handleBatchDeploy}
                            onPromote={(id) => setModal({ type: 'promote', data: { appId: id } })}
                            activeDeployment={activeDeployment}
                            setActiveDeployment={setActiveDeployment}
                            refreshing={refreshing}
                            onUpdateStagedFile={updateStagedFile}
                        />
                    )}
                    
                    {view === 'files' && (
                        <RepoFilesView
                            apps={apps} github={github}
                            repoFiles={repoFiles} onLoadRepo={loadRepoFiles}
                            selectedRepo={selectedRepoForBrowse} onSelectRepo={setSelectedRepoForBrowse}
                            markedForDeletion={markedForDeletion} setMarkedForDeletion={setMarkedForDeletion}
                            onDeleteMarked={() => setModal({ type: 'confirmDelete' })}
                        />
                    )}
                    
                    {view === 'firebase' && (
                        <FirebaseView />
                    )}
                    
                    {view === 'apps' && <AppsView apps={apps} repos={availableRepos} onUpdate={updateApp} />}
                    
                    {view === 'history' && (
                        <HistoryView 
                            deployments={deployments} apps={apps}
                            onRollback={(d) => setModal({ type: 'rollback', data: d })}
                        />
                    )}
                    
                    {view === 'settings' && (
                        <SettingsView token={githubToken} setToken={setGithubToken} settings={settings} setSettings={setSettings} repoCount={availableRepos.length} />
                    )}
                    
                    {/* Modals */}
                    {modal?.type === 'promote' && (
                        <PromoteModal app={apps[modal.data.appId]} onConfirm={() => handlePromote(modal.data.appId)} onCancel={() => setModal(null)} />
                    )}
                    
                    {modal?.type === 'rollback' && (
                        <RollbackModal deployment={modal.data} apps={apps} onConfirm={() => handleRollback(modal.data)} onCancel={() => setModal(null)} />
                    )}
                    
                    {modal?.type === 'versionWarning' && (
                        <VersionWarningModal
                            data={modal.data}
                            onForce={() => { setModal(null); handleDeploy(modal.data.file, modal.data.appId, modal.data.target, true); }}
                            onCancel={() => setModal(null)}
                        />
                    )}
                    
                    {modal?.type === 'confirmDelete' && (
                        <ConfirmDeleteModal
                            files={markedForDeletion}
                            onConfirm={handleDeleteMarkedFiles}
                            onCancel={() => setModal(null)}
                        />
                    )}
                </main>
            </div>
        );
    }

    // =========================================================================
    // VERSION WARNING MODAL
    // =========================================================================
    
    function VersionWarningModal({ data, onForce, onCancel }) {
        const { currentVersion, newVersion, target } = data;
        const isEqual = compareVersions(newVersion, currentVersion) === 0;
        
        return (
            <div className="fixed inset-0 bg-black/70 flex items-center justify-center z-50 p-4">
                <div className="bg-slate-800 rounded-xl border border-red-700 p-6 max-w-md w-full fade-in">
                    <h2 className="text-xl font-bold mb-4 flex items-center gap-2 text-red-400">
                        <Icons.AlertTriangle /> Version Conflict
                    </h2>
                    
                    <div className="mb-4 p-4 bg-red-900/30 rounded-lg">
                        <div className="text-center mb-3">
                            <div className="text-sm text-slate-400">Currently Deployed</div>
                            <div className="text-2xl font-mono text-green-400">{formatVersion(currentVersion)}</div>
                        </div>
                        <div className="text-center text-2xl">â†“</div>
                        <div className="text-center mt-3">
                            <div className="text-sm text-slate-400">Trying to Deploy</div>
                            <div className="text-2xl font-mono text-red-400">{formatVersion(newVersion)}</div>
                        </div>
                    </div>
                    
                    <p className="text-slate-300 mb-4">
                        {isEqual 
                            ? `You're deploying the same version that's already on ${target.toUpperCase()}.`
                            : `You're deploying an older version than what's currently on ${target.toUpperCase()}.`
                        }
                    </p>
                    
                    <div className="flex gap-3">
                        <button onClick={onCancel} className="flex-1 p-2 bg-slate-700 rounded">Cancel</button>
                        <button onClick={onForce} className="flex-1 p-2 bg-red-600 rounded flex items-center justify-center gap-2">
                            <Icons.AlertTriangle className="w-4 h-4" /> Force Deploy
                        </button>
                    </div>
                </div>
            </div>
        );
    }

    // =========================================================================
    // ROLLBACK MODAL
    // =========================================================================
    
    function RollbackModal({ deployment, apps, onConfirm, onCancel }) {
        const app = apps[deployment.appId];
        
        return (
            <div className="fixed inset-0 bg-black/70 flex items-center justify-center z-50 p-4">
                <div className="bg-slate-800 rounded-xl border border-amber-700 p-6 max-w-md w-full fade-in">
                    <h2 className="text-xl font-bold mb-4 flex items-center gap-2 text-amber-400">
                        <Icons.Rewind /> Rollback
                    </h2>
                    
                    <div className="mb-4 p-4 bg-slate-900 rounded-lg">
                        <div className="flex items-center gap-2 mb-2">
                            <span className="text-xl">{app?.icon}</span>
                            <span className="font-semibold">{app?.name}</span>
                            <span className={`text-xs px-1.5 rounded ${deployment.target === 'prod' ? 'bg-green-900 text-green-300' : 'bg-blue-900 text-blue-300'}`}>
                                {deployment.target?.toUpperCase()}
                            </span>
                        </div>
                        <div className="text-sm text-slate-400">
                            Rolling back to <span className="text-amber-400 font-mono">{formatVersion(deployment.version)}</span>
                        </div>
                        <div className="text-xs text-slate-500 mt-1">
                            Commit: {deployment.commitSha?.substring(0, 7)} â€¢ {formatDate(deployment.completedAt)}
                        </div>
                    </div>
                    
                    <p className="text-slate-300 text-sm mb-4">
                        This will restore the exact code from this deployment. A new commit will be created for audit purposes.
                    </p>
                    
                    <div className="flex gap-3">
                        <button onClick={onCancel} className="flex-1 p-2 bg-slate-700 rounded">Cancel</button>
                        <button onClick={onConfirm} className="flex-1 p-2 bg-amber-600 rounded flex items-center justify-center gap-2">
                            <Icons.Rewind className="w-4 h-4" /> Rollback
                        </button>
                    </div>
                </div>
            </div>
        );
    }

    // =========================================================================
    // PROMOTE MODAL
    // =========================================================================
    
    function PromoteModal({ app, onConfirm, onCancel }) {
        if (!app) return null;
        return (
            <div className="fixed inset-0 bg-black/70 flex items-center justify-center z-50 p-4">
                <div className="bg-slate-800 rounded-xl border border-slate-700 p-6 max-w-lg w-full fade-in">
                    <h2 className="text-xl font-bold mb-4">âš¡ Promote to Production</h2>
                    
                    <div className="flex items-center justify-center gap-4 mb-4">
                        <div className="p-3 bg-blue-900/30 border border-blue-700 rounded text-center">
                            <div className="text-xs text-blue-400">TEST</div>
                            <div className="font-mono">{app.testRepo?.split('/')[1]}</div>
                            <div className="text-sm text-slate-400">{formatVersion(app.currentTestVersion)}</div>
                        </div>
                        <div className="text-2xl">â†’</div>
                        <div className="p-3 bg-green-900/30 border border-green-700 rounded text-center">
                            <div className="text-xs text-green-400">PROD</div>
                            <div className="font-mono">{app.prodRepo?.split('/')[1]}</div>
                            <div className="text-sm text-slate-400">{formatVersion(app.currentProdVersion)}</div>
                        </div>
                    </div>
                    
                    <div className="bg-slate-900 rounded p-3 mb-4 text-sm">
                        <strong>This will:</strong>
                        <ol className="list-decimal list-inside mt-2 space-y-1 text-slate-300">
                            <li>Copy {app.targetPath} from TEST to PROD</li>
                            <li>Create release tag {formatVersion(app.currentTestVersion)}</li>
                            <li>GitHub Pages will deploy (~30s)</li>
                        </ol>
                    </div>
                    
                    <div className="flex gap-3">
                        <button onClick={onCancel} className="flex-1 p-2 bg-slate-700 rounded">Cancel</button>
                        <button onClick={onConfirm} className="flex-1 p-2 bg-green-600 rounded">
                            ðŸš€ Promote {formatVersion(app.currentTestVersion)}
                        </button>
                    </div>
                </div>
            </div>
        );
    }

    // =========================================================================
    // CONFIRM DELETE MODAL
    // =========================================================================
    
    function ConfirmDeleteModal({ files, onConfirm, onCancel }) {
        return (
            <div className="fixed inset-0 bg-black/70 flex items-center justify-center z-50 p-4">
                <div className="bg-slate-800 rounded-xl border border-red-700 p-6 max-w-md w-full fade-in">
                    <h2 className="text-xl font-bold mb-4 flex items-center gap-2 text-red-400">
                        <Icons.Trash /> Confirm Deletion
                    </h2>
                    
                    <p className="text-slate-300 mb-4">
                        Delete {files.length} file{files.length !== 1 ? 's' : ''}? This cannot be undone.
                    </p>
                    
                    <div className="max-h-40 overflow-y-auto mb-4 space-y-1">
                        {files.map((f, i) => (
                            <div key={i} className="text-sm text-slate-400 flex items-center gap-2">
                                <Icons.File /> {f.path}
                            </div>
                        ))}
                    </div>
                    
                    <div className="flex gap-3">
                        <button onClick={onCancel} className="flex-1 p-2 bg-slate-700 rounded">Cancel</button>
                        <button onClick={onConfirm} className="flex-1 p-2 bg-red-600 rounded flex items-center justify-center gap-2">
                            <Icons.Trash /> Delete Files
                        </button>
                    </div>
                </div>
            </div>
        );
    }

    // =========================================================================
    // DASHBOARD VIEW
    // =========================================================================
    
    function DashboardView({ apps, stagedFiles, github, onFileDrop, onRemove, onDeploy, onBatchDeploy, onPromote, activeDeployment, setActiveDeployment, refreshing, onUpdateStagedFile }) {
        const [selectedFileIds, setSelectedFileIds] = React.useState(new Set());
        const [deployTarget, setDeployTarget] = React.useState({ appId: 'management', target: 'test' });
        const configuredApps = Object.values(apps).filter(a => a.testRepo || a.prodRepo);
        
        // Get actual selected files from staged (ensures fresh content)
        const selectedFiles = stagedFiles.filter(f => selectedFileIds.has(f.id));
        
        // Clean up selections when staged files change
        React.useEffect(() => {
            setSelectedFileIds(prev => {
                const validIds = new Set(stagedFiles.map(f => f.id));
                const newSet = new Set([...prev].filter(id => validIds.has(id)));
                return newSet.size !== prev.size ? newSet : prev;
            });
        }, [stagedFiles]);
        
        const toggleFileSelection = (file) => {
            setSelectedFileIds(prev => {
                const newSet = new Set(prev);
                if (newSet.has(file.id)) {
                    newSet.delete(file.id);
                } else {
                    newSet.add(file.id);
                }
                return newSet;
            });
        };
        
        const selectAll = () => setSelectedFileIds(new Set(stagedFiles.map(f => f.id)));
        const selectNone = () => setSelectedFileIds(new Set());
        
        return (
            <div className="grid grid-cols-1 lg:grid-cols-3 gap-6">
                <div className="lg:col-span-2 space-y-6">
                    {/* Upload */}
                    <div className="bg-slate-800 rounded-xl border border-slate-700 p-6">
                        <h2 className="text-lg font-semibold mb-4 flex items-center gap-2">
                            <Icons.Upload /> Upload Files
                        </h2>
                        <div onDrop={onFileDrop} onDragOver={e => e.preventDefault()}
                            className="border-2 border-dashed border-slate-600 rounded-lg p-8 text-center hover:border-indigo-500 cursor-pointer">
                            <input type="file" multiple onChange={onFileDrop} className="hidden" id="upload" />
                            <label htmlFor="upload" className="cursor-pointer">
                                <div className="text-4xl mb-3">ðŸ“</div>
                                <div>Drop files here (HTML, JS, CSS, images...)</div>
                                <div className="text-xs text-slate-500 mt-2">
                                    Multi-file deploy supported â€¢ Version from <code>&lt;meta name="version"&gt;</code>
                                </div>
                            </label>
                        </div>
                    </div>
                    
                    {/* Staged Files */}
                    {stagedFiles.length > 0 && (
                        <div className="bg-slate-800 rounded-xl border border-slate-700 p-6">
                            <div className="flex items-center justify-between mb-4">
                                <h2 className="text-lg font-semibold">Staged ({stagedFiles.length})</h2>
                                <div className="flex gap-2 text-xs">
                                    <button onClick={selectAll} className="px-2 py-1 bg-slate-700 rounded hover:bg-slate-600">Select All</button>
                                    <button onClick={selectNone} className="px-2 py-1 bg-slate-700 rounded hover:bg-slate-600">Select None</button>
                                </div>
                            </div>
                            <div className="space-y-2">
                                {stagedFiles.map(f => {
                                    const isHtml = f.name.endsWith('.html');
                                    const willRename = isHtml && f.targetPath === 'index.html' && f.name !== 'index.html';
                                    
                                    return (
                                    <div key={f.id} className={`p-3 rounded-lg border ${
                                        selectedFileIds.has(f.id) ? 'bg-indigo-900/50 border-indigo-500' : 'bg-slate-700/50 border-slate-600'
                                    }`}>
                                        <div className="flex items-center gap-3">
                                            <input type="checkbox" checked={selectedFileIds.has(f.id)}
                                                onChange={() => toggleFileSelection(f)} className="w-4 h-4" />
                                            <span className="text-xl">{getFileIcon(f.name)}</span>
                                            <div className="flex-1 min-w-0">
                                                {/* Source filename */}
                                                <div className="font-medium truncate text-slate-300">{f.name}</div>
                                                
                                                {/* File info */}
                                                <div className="text-xs text-slate-400 flex items-center gap-2 flex-wrap mt-0.5">
                                                    {formatBytes(f.size)}
                                                    {f.version && (
                                                        <span className="px-1.5 py-0.5 bg-slate-600 rounded">
                                                            {formatVersion(f.version)}
                                                            {f.versionSource === 'html' && <span className="text-green-400 ml-1">âœ“</span>}
                                                        </span>
                                                    )}
                                                    {!f.isText && <span className="text-amber-400">binary</span>}
                                                </div>
                                                
                                                {/* Target path section */}
                                                <div className="mt-2 p-2 bg-slate-800 rounded border border-slate-600">
                                                    <div className="text-xs text-slate-500 mb-1">Deploy as:</div>
                                                    <div className="flex items-center gap-2">
                                                        <input type="text" value={f.targetPath} 
                                                            onChange={e => onUpdateStagedFile(f.id, { targetPath: e.target.value })}
                                                            onClick={e => e.stopPropagation()}
                                                            className="flex-1 text-sm bg-slate-900 border border-slate-500 rounded px-2 py-1 font-mono text-white"
                                                            placeholder="index.html" />
                                                        {isHtml && f.name !== 'index.html' && (
                                                            <button 
                                                                onClick={(e) => {
                                                                    e.stopPropagation();
                                                                    onUpdateStagedFile(f.id, { 
                                                                        targetPath: f.targetPath === 'index.html' ? f.name : 'index.html' 
                                                                    });
                                                                }}
                                                                className={`px-2 py-1 text-xs rounded whitespace-nowrap ${
                                                                    f.targetPath === 'index.html' 
                                                                        ? 'bg-green-700 text-green-100' 
                                                                        : 'bg-slate-600 text-slate-300 hover:bg-slate-500'
                                                                }`}>
                                                                {f.targetPath === 'index.html' ? 'âœ“ Replace index.html' : 'Use index.html'}
                                                            </button>
                                                        )}
                                                    </div>
                                                    {willRename && (
                                                        <div className="mt-1.5 text-xs text-green-400 flex items-center gap-1">
                                                            <span>ðŸ“</span> Will replace existing index.html
                                                        </div>
                                                    )}
                                                    {isHtml && f.targetPath !== 'index.html' && f.name !== 'index.html' && (
                                                        <div className="mt-1.5 text-xs text-amber-400 flex items-center gap-1">
                                                            <span>âš ï¸</span> Will create new file (won't replace index.html)
                                                        </div>
                                                    )}
                                                </div>
                                            </div>
                                            <button onClick={e => { 
                                                e.stopPropagation(); 
                                                setSelectedFileIds(prev => {
                                                    const newSet = new Set(prev);
                                                    newSet.delete(f.id);
                                                    return newSet;
                                                });
                                                onRemove(f.id); 
                                            }} className="text-slate-400 hover:text-red-400 self-start">
                                                <Icons.X />
                                            </button>
                                        </div>
                                    </div>
                                    );
                                })}
                            </div>
                            
                            {/* Batch Deploy Controls */}
                            {selectedFiles.length > 0 && (
                                <div className="mt-4 p-4 bg-slate-900 rounded-lg border border-slate-600">
                                    <div className="text-sm font-medium mb-3">Deploy {selectedFiles.length} selected file{selectedFiles.length !== 1 ? 's' : ''}</div>
                                    <div className="grid grid-cols-2 gap-3 mb-3">
                                        <select value={deployTarget.appId} onChange={e => setDeployTarget(p => ({ ...p, appId: e.target.value }))}
                                            className="p-2 bg-slate-700 border border-slate-600 rounded text-sm">
                                            {Object.values(apps).map(a => <option key={a.id} value={a.id}>{a.icon} {a.name}</option>)}
                                        </select>
                                        <select value={deployTarget.target} onChange={e => setDeployTarget(p => ({ ...p, target: e.target.value }))}
                                            className="p-2 bg-slate-700 border border-slate-600 rounded text-sm">
                                            <option value="test">ðŸ§ª TEST</option>
                                            <option value="prod">ðŸš€ PROD</option>
                                        </select>
                                    </div>
                                    <button onClick={() => {
                                        console.log('Deploying files:', selectedFiles.map(f => ({ name: f.name, id: f.id, size: f.content?.length })));
                                        onBatchDeploy(selectedFiles, deployTarget.appId, deployTarget.target);
                                    }}
                                        disabled={!github}
                                        className={`w-full p-2 rounded font-medium ${deployTarget.target === 'prod' ? 'bg-green-600 hover:bg-green-700' : 'bg-blue-600 hover:bg-blue-700'}`}>
                                        {selectedFiles.length === 1 ? 'Deploy File' : `Batch Deploy ${selectedFiles.length} Files`}
                                    </button>
                                </div>
                            )}
                        </div>
                    )}
                    
                    {/* Active Deployment */}
                    {activeDeployment && (
                        <div className={`bg-slate-800 rounded-xl border p-6 ${
                            activeDeployment.status === 'running' ? 'border-indigo-500' :
                            activeDeployment.status === 'success' ? 'border-green-500' : 'border-red-500'
                        }`}>
                            <h2 className="text-lg font-semibold mb-4 flex items-center gap-2">
                                {activeDeployment.status === 'running' ? (
                                    <div className="w-4 h-4 border-2 border-indigo-500 border-t-transparent rounded-full animate-spin" />
                                ) : activeDeployment.status === 'success' ? (
                                    <span className="text-green-400">âœ“</span>
                                ) : (
                                    <span className="text-red-400">âœ—</span>
                                )}
                                {activeDeployment.status === 'running' 
                                    ? (activeDeployment.isRollback ? 'Rolling back' : activeDeployment.isPromotion ? 'Promoting' : 'Deploying') + '...'
                                    : activeDeployment.status === 'success' ? 'Complete!' : 'Failed'
                                }
                                {activeDeployment.fileCount && <span className="text-sm text-slate-400">({activeDeployment.fileCount} files)</span>}
                                <span className="flex-1" />
                                {activeDeployment.status !== 'running' && (
                                    <button onClick={() => setActiveDeployment(null)} className="text-slate-400 hover:text-white">
                                        <Icons.X />
                                    </button>
                                )}
                            </h2>
                            <div className="space-y-2">
                                {activeDeployment.steps.map((s, i) => (
                                    <div key={i} className="flex items-center gap-2">
                                        <div className={`w-5 h-5 rounded-full flex items-center justify-center text-xs ${
                                            s.status === 'complete' ? 'bg-green-500' :
                                            s.status === 'running' ? 'bg-indigo-500' :
                                            s.status === 'error' ? 'bg-red-500' : 'bg-amber-500'
                                        }`}>
                                            {s.status === 'complete' ? 'âœ“' : s.status === 'running' ? 'â€¢' : '!'}
                                        </div>
                                        <span className={s.status === 'error' ? 'text-red-400' : ''}>{s.name}</span>
                                        {s.details && <span className="text-slate-500 text-sm">({s.details})</span>}
                                    </div>
                                ))}
                            </div>
                            {activeDeployment.status === 'success' && activeDeployment.url && (
                                <a href={activeDeployment.url} target="_blank" className="mt-3 inline-flex items-center gap-1 text-indigo-400 hover:underline">
                                    <Icons.ExternalLink /> Open Site
                                </a>
                            )}
                        </div>
                    )}
                </div>
                
                {/* Right Column - Pipeline */}
                <div className="space-y-6">
                    <div className="bg-slate-800 rounded-xl border border-slate-700 p-4">
                        <h3 className="font-semibold mb-3 flex items-center gap-2">
                            <Icons.Shield className="text-green-400" /> Pipeline
                            {refreshing && <div className="w-3 h-3 border border-indigo-400 border-t-transparent rounded-full animate-spin" />}
                        </h3>
                        <div className="space-y-3">
                            {configuredApps.map(app => {
                                const canPromote = app.testRepo && app.prodRepo && app.currentTestVersion && app.currentTestVersion !== app.currentProdVersion;
                                const testUrl = getGitHubPagesUrl(app.testRepo);
                                const prodUrl = getGitHubPagesUrl(app.prodRepo);
                                
                                return (
                                    <div key={app.id} className="p-3 bg-slate-700/50 rounded-lg">
                                        <div className="flex items-center gap-2 mb-2">
                                            <span>{app.icon}</span>
                                            <span className="font-medium flex-1">{app.name}</span>
                                            {canPromote && (
                                                <button onClick={() => onPromote(app.id)}
                                                    className="px-2 py-1 bg-amber-600 text-xs rounded flex items-center gap-1">
                                                    <Icons.Zap className="w-3 h-3" /> Promote
                                                </button>
                                            )}
                                        </div>
                                        {/* Show mapped repos */}
                                        <div className="text-xs text-slate-500 mb-2 font-mono">
                                            {app.testRepo ? app.testRepo.split('/')[1] : '(no test repo)'} â†’ {app.prodRepo ? app.prodRepo.split('/')[1] : '(no prod repo)'}
                                        </div>
                                        <div className="flex items-center gap-2 text-xs">
                                            <div className="flex items-center gap-1">
                                                <span className={`px-2 py-0.5 rounded ${app.currentTestVersion ? 'bg-blue-900/50 text-blue-300' : 'bg-slate-600 text-slate-400'}`}>
                                                    TEST: {formatVersion(app.currentTestVersion)}
                                                </span>
                                                {testUrl && (
                                                    <a href={testUrl} target="_blank" className="p-1 hover:bg-slate-600 rounded" title="Open TEST">
                                                        <Icons.Play />
                                                    </a>
                                                )}
                                            </div>
                                            <Icons.ArrowRight className="w-4 h-4 text-slate-500" />
                                            <div className="flex items-center gap-1">
                                                <span className={`px-2 py-0.5 rounded ${app.currentProdVersion ? 'bg-green-900/50 text-green-300' : 'bg-slate-600 text-slate-400'}`}>
                                                    PROD: {formatVersion(app.currentProdVersion)}
                                                </span>
                                                {prodUrl && (
                                                    <a href={prodUrl} target="_blank" className="p-1 hover:bg-slate-600 rounded" title="Open PROD">
                                                        <Icons.Play />
                                                    </a>
                                                )}
                                            </div>
                                        </div>
                                    </div>
                                );
                            })}
                            {configuredApps.length === 0 && <div className="text-slate-400 text-sm">Add token in Settings</div>}
                        </div>
                    </div>
                </div>
            </div>
        );
    }

    // =========================================================================
    // REPO FILES VIEW
    // =========================================================================
    
    function RepoFilesView({ apps, github, repoFiles, onLoadRepo, selectedRepo, onSelectRepo, markedForDeletion, setMarkedForDeletion, onDeleteMarked }) {
        const configuredApps = Object.values(apps).filter(a => a.testRepo || a.prodRepo);
        const allRepos = [...new Set(configuredApps.flatMap(a => [a.testRepo, a.prodRepo].filter(Boolean)))];
        
        const currentFiles = repoFiles[selectedRepo]?.files || [];
        const isLoading = repoFiles[selectedRepo]?.loading;
        
        const toggleMarkForDeletion = (file) => {
            const existing = markedForDeletion.find(m => m.repo === selectedRepo && m.path === file.path);
            if (existing) {
                setMarkedForDeletion(prev => prev.filter(m => !(m.repo === selectedRepo && m.path === file.path)));
            } else {
                setMarkedForDeletion(prev => [...prev, { repo: selectedRepo, path: file.path, sha: file.sha, name: file.name }]);
            }
        };
        
        const isMarked = (file) => markedForDeletion.some(m => m.repo === selectedRepo && m.path === file.path);
        
        return (
            <div className="space-y-6">
                <div className="bg-slate-800 rounded-xl border border-slate-700 p-6">
                    <h2 className="text-lg font-semibold mb-4 flex items-center gap-2">
                        <Icons.Folder /> Repository Files
                    </h2>
                    
                    <div className="flex gap-4 mb-4">
                        <select value={selectedRepo || ''} onChange={e => { onSelectRepo(e.target.value); if (e.target.value) onLoadRepo(e.target.value); }}
                            className="flex-1 p-2 bg-slate-700 border border-slate-600 rounded">
                            <option value="">Select repository...</option>
                            {allRepos.map(r => {
                                const app = configuredApps.find(a => a.testRepo === r || a.prodRepo === r);
                                const isTest = app?.testRepo === r;
                                return <option key={r} value={r}>{app?.icon} {r.split('/')[1]} ({isTest ? 'TEST' : 'PROD'})</option>;
                            })}
                        </select>
                        
                        {selectedRepo && (
                            <button onClick={() => onLoadRepo(selectedRepo)} className="px-4 py-2 bg-slate-700 rounded flex items-center gap-2">
                                <Icons.Refresh className={isLoading ? 'animate-spin' : ''} /> Refresh
                            </button>
                        )}
                    </div>
                    
                    {selectedRepo && (
                        <div className="flex gap-2 mb-4">
                            <a href={getGitHubPagesUrl(selectedRepo)} target="_blank" 
                                className="px-3 py-1.5 bg-indigo-600 rounded text-sm flex items-center gap-1">
                                <Icons.Play /> Open Site
                            </a>
                            <a href={`https://github.com/${selectedRepo}`} target="_blank"
                                className="px-3 py-1.5 bg-slate-700 rounded text-sm flex items-center gap-1">
                                <Icons.ExternalLink /> GitHub
                            </a>
                        </div>
                    )}
                    
                    {isLoading && (
                        <div className="text-center py-8 text-slate-400">
                            <div className="w-6 h-6 border-2 border-indigo-500 border-t-transparent rounded-full animate-spin mx-auto mb-2" />
                            Loading files...
                        </div>
                    )}
                    
                    {!isLoading && currentFiles.length > 0 && (
                        <div className="space-y-1">
                            {currentFiles.filter(f => f.type === 'file').map(file => (
                                <div key={file.path} className={`p-2 rounded flex items-center gap-3 ${isMarked(file) ? 'bg-red-900/30 border border-red-700' : 'bg-slate-700/50 hover:bg-slate-700'}`}>
                                    <span>{getFileIcon(file.name)}</span>
                                    <span className="flex-1 font-mono text-sm">{file.name}</span>
                                    <span className="text-xs text-slate-500">{formatBytes(file.size)}</span>
                                    <div className="flex gap-1">
                                        <a href={file.download_url} target="_blank" className="p-1 hover:bg-slate-600 rounded" title="View">
                                            <Icons.Eye />
                                        </a>
                                        <a href={file.download_url} download className="p-1 hover:bg-slate-600 rounded" title="Download">
                                            <Icons.Download />
                                        </a>
                                        <button onClick={() => toggleMarkForDeletion(file)} 
                                            className={`p-1 rounded ${isMarked(file) ? 'bg-red-600 text-white' : 'hover:bg-red-900/50 text-slate-400 hover:text-red-400'}`}
                                            title={isMarked(file) ? 'Unmark' : 'Mark for deletion'}>
                                            <Icons.Trash />
                                        </button>
                                    </div>
                                </div>
                            ))}
                        </div>
                    )}
                    
                    {!isLoading && selectedRepo && currentFiles.length === 0 && (
                        <div className="text-center py-8 text-slate-400">No files found</div>
                    )}
                </div>
                
                {/* Marked for Deletion Panel */}
                {markedForDeletion.length > 0 && (
                    <div className="bg-red-900/20 border border-red-700 rounded-xl p-4">
                        <div className="flex items-center justify-between mb-3">
                            <h3 className="font-semibold text-red-400 flex items-center gap-2">
                                <Icons.Trash /> Marked for Deletion ({markedForDeletion.length})
                            </h3>
                            <div className="flex gap-2">
                                <button onClick={() => setMarkedForDeletion([])} className="px-3 py-1 bg-slate-700 rounded text-sm">
                                    Clear All
                                </button>
                                <button onClick={onDeleteMarked} className="px-3 py-1 bg-red-600 rounded text-sm flex items-center gap-1">
                                    <Icons.Trash /> Delete All
                                </button>
                            </div>
                        </div>
                        <div className="space-y-1">
                            {markedForDeletion.map((item, i) => (
                                <div key={i} className="text-sm flex items-center gap-2 text-slate-300">
                                    <Icons.File /> <span className="text-slate-500">{item.repo.split('/')[1]}/</span>{item.path}
                                </div>
                            ))}
                        </div>
                    </div>
                )}
            </div>
        );
    }

    // =========================================================================
    // FIREBASE VIEW
    // =========================================================================
    
    function FirebaseView() {
        const [user, setUser] = React.useState(null);
        const [authLoading, setAuthLoading] = React.useState(true);
        const [dbPath, setDbPath] = React.useState('');
        const [dbData, setDbData] = React.useState(null);
        const [dbLoading, setDbLoading] = React.useState(false);
        const [dbError, setDbError] = React.useState(null);
        const [expandedPaths, setExpandedPaths] = React.useState(new Set());
        const [editingPath, setEditingPath] = React.useState(null);
        const [editValue, setEditValue] = React.useState('');
        const [realtimeEnabled, setRealtimeEnabled] = React.useState(false);
        const [realtimeUnsubscribe, setRealtimeUnsubscribe] = React.useState(null);
        const [manualUid, setManualUid] = React.useState(() => {
            try { return localStorage.getItem('cc_firebase_uid') || ''; } catch { return ''; }
        });
        const [showManualAuth, setShowManualAuth] = React.useState(false);
        
        // Detect if running from file:// protocol
        const isFileProtocol = window.location.protocol === 'file:';
        
        // Quick paths for common data
        const quickPaths = [
            { label: 'Users', path: 'users' },
            { label: 'Battles', path: 'battles' },
            { label: 'Friends', path: 'friends' },
            { label: 'Gameshelf Public', path: 'gameshelf-public' },
            { label: 'Reported Issues', path: 'reported-issues' },
            { label: 'Game Suggestions', path: 'game-suggestions' },
            { label: 'Test Results', path: 'test-results' },
            { label: 'Root', path: '' },
        ];
        
        // Listen for auth state changes
        React.useEffect(() => {
            if (!firebaseAuth) {
                setAuthLoading(false);
                return;
            }
            
            const unsubscribe = firebaseAuth.onAuthStateChanged((u) => {
                setUser(u);
                setAuthLoading(false);
                if (u) {
                    console.log('Firebase auth state:', u.email, 'UID:', u.uid);
                    // Save UID for manual auth fallback
                    try { localStorage.setItem('cc_firebase_uid', u.uid); } catch {}
                    setManualUid(u.uid);
                } else {
                    console.log('Firebase auth state: signed out');
                }
            });
            
            return () => unsubscribe();
        }, []);
        
        // Cleanup realtime listener on unmount
        React.useEffect(() => {
            return () => {
                if (realtimeUnsubscribe) {
                    realtimeUnsubscribe();
                }
            };
        }, [realtimeUnsubscribe]);
        
        const signInWithGoogle = async () => {
            if (isFileProtocol) {
                alert('Google Sign-in requires HTTPS. Please open this app from GitHub Pages or a web server.\n\nOr use the "Manual UID" option below for read-only access to public data.');
                return;
            }
            
            try {
                const provider = new firebase.auth.GoogleAuthProvider();
                await firebaseAuth.signInWithPopup(provider);
            } catch (e) {
                console.error('Sign in error:', e);
                if (e.code === 'auth/operation-not-supported-in-this-environment') {
                    alert('Google Sign-in not supported here. Please:\n\n1. Open from GitHub Pages URL, or\n2. Use "Manual UID" for limited access');
                } else {
                    alert('Sign in failed: ' + e.message);
                }
            }
        };
        
        const signOut = async () => {
            try {
                await firebaseAuth.signOut();
                setDbData(null);
            } catch (e) {
                console.error('Sign out error:', e);
            }
        };
        
        const fetchData = async (path = dbPath) => {
            if (!firebaseDb) return;
            
            // Stop any existing realtime listener
            if (realtimeUnsubscribe) {
                realtimeUnsubscribe();
                setRealtimeUnsubscribe(null);
            }
            
            setDbLoading(true);
            setDbError(null);
            
            try {
                const ref = firebaseDb.ref(path || '/');
                const snapshot = await ref.once('value');
                setDbData(snapshot.val());
                setDbPath(path);
                console.log('Fetched data at', path || '/', snapshot.val());
            } catch (e) {
                console.error('Fetch error:', e);
                setDbError(e.message);
            }
            
            setDbLoading(false);
        };
        
        const enableRealtime = () => {
            if (!firebaseDb || !dbPath) return;
            
            // Stop existing listener
            if (realtimeUnsubscribe) {
                realtimeUnsubscribe();
            }
            
            const ref = firebaseDb.ref(dbPath || '/');
            const callback = ref.on('value', (snapshot) => {
                setDbData(snapshot.val());
                console.log('Realtime update at', dbPath || '/');
            }, (error) => {
                setDbError(error.message);
            });
            
            setRealtimeUnsubscribe(() => () => ref.off('value', callback));
            setRealtimeEnabled(true);
        };
        
        const disableRealtime = () => {
            if (realtimeUnsubscribe) {
                realtimeUnsubscribe();
                setRealtimeUnsubscribe(null);
            }
            setRealtimeEnabled(false);
        };
        
        const updateValue = async (path, value) => {
            if (!firebaseDb) return;
            
            try {
                // Try to parse as JSON, otherwise use as string
                let parsedValue;
                try {
                    parsedValue = JSON.parse(value);
                } catch {
                    parsedValue = value;
                }
                
                await firebaseDb.ref(path).set(parsedValue);
                setEditingPath(null);
                fetchData(dbPath);
            } catch (e) {
                alert('Update failed: ' + e.message);
            }
        };
        
        const deleteValue = async (path) => {
            if (!firebaseDb) return;
            if (!confirm(`Delete data at "${path}"?`)) return;
            
            try {
                await firebaseDb.ref(path).remove();
                fetchData(dbPath);
            } catch (e) {
                alert('Delete failed: ' + e.message);
            }
        };
        
        const copyToClipboard = (data) => {
            navigator.clipboard.writeText(JSON.stringify(data, null, 2));
        };
        
        const toggleExpand = (path) => {
            setExpandedPaths(prev => {
                const newSet = new Set(prev);
                if (newSet.has(path)) {
                    newSet.delete(path);
                } else {
                    newSet.add(path);
                }
                return newSet;
            });
        };
        
        // Render a data node recursively
        const renderData = (data, path = '') => {
            if (data === null || data === undefined) {
                return <span className="text-slate-500 italic">null</span>;
            }
            
            if (typeof data !== 'object') {
                // Primitive value
                const isEditing = editingPath === path;
                
                return (
                    <div className="flex items-center gap-2">
                        {isEditing ? (
                            <>
                                <input 
                                    type="text" 
                                    value={editValue}
                                    onChange={e => setEditValue(e.target.value)}
                                    className="flex-1 bg-slate-900 border border-indigo-500 rounded px-2 py-1 text-sm font-mono"
                                    autoFocus
                                />
                                <button onClick={() => updateValue(path, editValue)} className="px-2 py-1 bg-green-600 rounded text-xs">Save</button>
                                <button onClick={() => setEditingPath(null)} className="px-2 py-1 bg-slate-600 rounded text-xs">Cancel</button>
                            </>
                        ) : (
                            <>
                                <span className={`font-mono ${
                                    typeof data === 'string' ? 'text-green-400' :
                                    typeof data === 'number' ? 'text-blue-400' :
                                    typeof data === 'boolean' ? 'text-amber-400' : 'text-white'
                                }`}>
                                    {typeof data === 'string' ? `"${data}"` : String(data)}
                                </span>
                                <button onClick={() => { setEditingPath(path); setEditValue(typeof data === 'string' ? data : JSON.stringify(data)); }} 
                                    className="p-1 hover:bg-slate-600 rounded opacity-50 hover:opacity-100">
                                    <Icons.Edit />
                                </button>
                            </>
                        )}
                    </div>
                );
            }
            
            // Object or array
            const entries = Object.entries(data);
            const isArray = Array.isArray(data);
            const isExpanded = expandedPaths.has(path) || path === '';
            
            return (
                <div className="ml-4 border-l border-slate-700 pl-3">
                    {entries.length === 0 ? (
                        <span className="text-slate-500 italic">{isArray ? '[]' : '{}'}</span>
                    ) : (
                        entries.slice(0, isExpanded ? undefined : 5).map(([key, value]) => {
                            const childPath = path ? `${path}/${key}` : key;
                            const isObject = value && typeof value === 'object';
                            const childCount = isObject ? Object.keys(value).length : 0;
                            
                            return (
                                <div key={key} className="my-1">
                                    <div className="flex items-center gap-2">
                                        {isObject && (
                                            <button onClick={() => toggleExpand(childPath)} className="text-slate-400 hover:text-white">
                                                {expandedPaths.has(childPath) ? 'â–¼' : 'â–¶'}
                                            </button>
                                        )}
                                        <span className={`${isArray ? 'text-slate-500' : 'text-indigo-400'} font-mono text-sm`}>
                                            {isArray ? `[${key}]` : key}:
                                        </span>
                                        {isObject ? (
                                            <span className="text-slate-500 text-xs">
                                                {Array.isArray(value) ? `Array(${childCount})` : `Object(${childCount})`}
                                            </span>
                                        ) : null}
                                        <button onClick={() => copyToClipboard(value)} className="p-1 hover:bg-slate-600 rounded opacity-50 hover:opacity-100" title="Copy">
                                            <Icons.Copy />
                                        </button>
                                        <button onClick={() => deleteValue(childPath)} className="p-1 hover:bg-red-900/50 rounded opacity-50 hover:opacity-100 text-red-400" title="Delete">
                                            <Icons.Trash />
                                        </button>
                                    </div>
                                    {(!isObject || expandedPaths.has(childPath)) && (
                                        <div className="ml-4">
                                            {renderData(value, childPath)}
                                        </div>
                                    )}
                                </div>
                            );
                        })
                    )}
                    {!isExpanded && entries.length > 5 && (
                        <button onClick={() => toggleExpand(path)} className="text-indigo-400 text-sm hover:underline">
                            ... {entries.length - 5} more items
                        </button>
                    )}
                </div>
            );
        };
        
        return (
            <div className="space-y-6">
                {/* Protocol Warning */}
                {isFileProtocol && (
                    <div className="bg-amber-900/30 border border-amber-700 rounded-xl p-4">
                        <div className="flex items-start gap-3">
                            <span className="text-2xl">âš ï¸</span>
                            <div>
                                <div className="font-semibold text-amber-400">Running from local file</div>
                                <p className="text-sm text-slate-300 mt-1">
                                    Google Sign-in requires HTTPS. For full functionality:
                                </p>
                                <ol className="text-sm text-slate-400 mt-2 list-decimal list-inside space-y-1">
                                    <li>Deploy this file to your <strong>managementtest</strong> repo</li>
                                    <li>Open from GitHub Pages URL</li>
                                    <li>Sign in with Google there</li>
                                </ol>
                                <p className="text-sm text-slate-400 mt-2">
                                    Or use <strong>Manual UID</strong> below for read-only access to public data.
                                </p>
                            </div>
                        </div>
                    </div>
                )}
                
                {/* Auth Section */}
                <div className="bg-slate-800 rounded-xl border border-slate-700 p-6">
                    <h2 className="text-lg font-semibold mb-4 flex items-center gap-2">
                        <Icons.Database /> Firebase Realtime Database
                    </h2>
                    
                    <div className="flex items-center gap-4 mb-4">
                        <div className="flex-1">
                            <div className="text-xs text-slate-400 mb-1">Project</div>
                            <div className="font-mono text-sm">{FIREBASE_CONFIG.projectId}</div>
                        </div>
                        
                        {authLoading ? (
                            <div className="text-slate-400">Loading auth...</div>
                        ) : user ? (
                            <div className="flex items-center gap-3">
                                <div className="text-right">
                                    <div className="text-sm font-medium">{user.displayName || user.email}</div>
                                    <div className="text-xs text-slate-400">{user.email}</div>
                                    <div className="text-xs text-slate-500 font-mono">UID: {user.uid}</div>
                                </div>
                                {user.photoURL && <img src={user.photoURL} className="w-8 h-8 rounded-full" />}
                                <button onClick={signOut} className="px-3 py-1.5 bg-slate-700 rounded text-sm">Sign Out</button>
                            </div>
                        ) : (
                            <div className="flex items-center gap-2">
                                <button onClick={signInWithGoogle} 
                                    className={`px-4 py-2 rounded flex items-center gap-2 ${isFileProtocol ? 'bg-slate-600 text-slate-400' : 'bg-indigo-600'}`}>
                                    <Icons.User /> Sign in with Google
                                </button>
                                <button onClick={() => setShowManualAuth(!showManualAuth)} 
                                    className="px-3 py-2 bg-slate-700 rounded text-sm">
                                    {showManualAuth ? 'Hide' : 'Manual UID'}
                                </button>
                            </div>
                        )}
                    </div>
                    
                    {/* Manual UID Input (for file:// or debugging) */}
                    {!user && showManualAuth && (
                        <div className="mt-4 p-4 bg-slate-900 rounded-lg border border-slate-600">
                            <div className="text-sm text-slate-400 mb-2">
                                <strong>Manual UID Access</strong> - Enter a UID to access public data (read-only without auth)
                            </div>
                            <div className="flex gap-2">
                                <input 
                                    type="text"
                                    value={manualUid}
                                    onChange={e => setManualUid(e.target.value)}
                                    placeholder="Firebase UID (e.g., abc123xyz...)"
                                    className="flex-1 bg-slate-800 border border-slate-600 rounded px-3 py-2 font-mono text-sm"
                                />
                                <button onClick={() => {
                                    try { localStorage.setItem('cc_firebase_uid', manualUid); } catch {}
                                    alert('UID saved. You can now query public data paths.');
                                }} className="px-4 py-2 bg-indigo-600 rounded">
                                    Save
                                </button>
                            </div>
                            <div className="text-xs text-slate-500 mt-2">
                                Tip: Sign in from GitHub Pages once to get your UID, then use it here.
                            </div>
                        </div>
                    )}
                    
                    {!user && !showManualAuth && (
                        <div className="text-slate-400 text-sm">
                            Sign in to access protected data, or click "Manual UID" for limited access.
                        </div>
                    )}
                </div>
                
                {/* Query Section */}
                <div className="bg-slate-800 rounded-xl border border-slate-700 p-6">
                    <h3 className="font-semibold mb-4">Query Data</h3>
                    
                    <div className="flex gap-2 mb-4 flex-wrap">
                        {quickPaths.map(qp => (
                            <button key={qp.path} onClick={() => { setDbPath(qp.path); fetchData(qp.path); }}
                                className={`px-3 py-1.5 rounded text-sm ${dbPath === qp.path ? 'bg-indigo-600' : 'bg-slate-700 hover:bg-slate-600'}`}>
                                {qp.label}
                            </button>
                        ))}
                    </div>
                    
                    <div className="flex gap-2 mb-4">
                        <input 
                            type="text" 
                            value={dbPath}
                            onChange={e => setDbPath(e.target.value)}
                            onKeyDown={e => e.key === 'Enter' && fetchData()}
                            placeholder="Path (e.g., users/abc123)"
                            className="flex-1 bg-slate-900 border border-slate-600 rounded px-3 py-2 font-mono text-sm"
                        />
                        <button onClick={() => fetchData()} disabled={dbLoading} className="px-4 py-2 bg-indigo-600 rounded">
                            {dbLoading ? '...' : 'Fetch'}
                        </button>
                        <button 
                            onClick={() => realtimeEnabled ? disableRealtime() : enableRealtime()} 
                            className={`px-4 py-2 rounded flex items-center gap-2 ${realtimeEnabled ? 'bg-green-600' : 'bg-slate-700'}`}
                            title={realtimeEnabled ? 'Disable realtime updates' : 'Enable realtime updates'}
                        >
                            {realtimeEnabled ? 'ðŸ”´ Live' : 'âšª Live'}
                        </button>
                    </div>
                    
                    {dbError && (
                        <div className="mb-4 p-3 bg-red-900/30 border border-red-700 rounded text-red-400 text-sm">
                            Error: {dbError}
                        </div>
                    )}
                </div>
                
                {/* Data Display */}
                {dbData !== null && (
                    <div className="bg-slate-800 rounded-xl border border-slate-700 p-6">
                        <div className="flex items-center justify-between mb-4">
                            <h3 className="font-semibold">
                                Data at <span className="font-mono text-indigo-400">/{dbPath || ''}</span>
                                {realtimeEnabled && <span className="ml-2 text-green-400 text-sm">â— Live</span>}
                            </h3>
                            <div className="flex gap-2">
                                <button onClick={() => copyToClipboard(dbData)} className="px-3 py-1 bg-slate-700 rounded text-sm flex items-center gap-1">
                                    <Icons.Copy /> Copy All
                                </button>
                                <button onClick={() => setExpandedPaths(new Set())} className="px-3 py-1 bg-slate-700 rounded text-sm">
                                    Collapse All
                                </button>
                            </div>
                        </div>
                        
                        <div className="bg-slate-900 rounded p-4 max-h-[600px] overflow-auto">
                            {renderData(dbData, dbPath)}
                        </div>
                    </div>
                )}
            </div>
        );
    }

    // =========================================================================
    // APPS VIEW
    // =========================================================================
    
    function AppsView({ apps, repos, onUpdate }) {
        return (
            <div className="space-y-6">
                <h2 className="text-xl font-bold">App Configuration</h2>
                <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                    {Object.values(apps).map(app => (
                        <div key={app.id} className="bg-slate-800 rounded-xl border border-slate-700 p-4">
                            <div className="flex items-center gap-2 mb-3">
                                <span className="text-2xl">{app.icon}</span>
                                <span className="font-semibold">{app.name}</span>
                            </div>
                            <div className="space-y-2">
                                <div>
                                    <label className="text-xs text-blue-400">ðŸ§ª TEST</label>
                                    <select value={app.testRepo || ''} onChange={e => onUpdate(app.id, { testRepo: e.target.value })}
                                        className="w-full p-1.5 bg-slate-700 border border-slate-600 rounded text-sm">
                                        <option value="">Select...</option>
                                        {repos.map(r => <option key={r.fullName} value={r.fullName}>{r.name}</option>)}
                                    </select>
                                </div>
                                <div>
                                    <label className="text-xs text-green-400">ðŸš€ PROD</label>
                                    <select value={app.prodRepo || ''} onChange={e => onUpdate(app.id, { prodRepo: e.target.value })}
                                        className="w-full p-1.5 bg-slate-700 border border-slate-600 rounded text-sm">
                                        <option value="">Select...</option>
                                        {repos.map(r => <option key={r.fullName} value={r.fullName}>{r.name}</option>)}
                                    </select>
                                </div>
                                <div>
                                    <label className="text-xs text-slate-400">Target Path</label>
                                    <input type="text" value={app.targetPath} onChange={e => onUpdate(app.id, { targetPath: e.target.value })}
                                        className="w-full p-1.5 bg-slate-700 border border-slate-600 rounded text-sm font-mono" />
                                </div>
                            </div>
                        </div>
                    ))}
                </div>
            </div>
        );
    }

    // =========================================================================
    // HISTORY VIEW
    // =========================================================================
    
    function HistoryView({ deployments, apps, onRollback }) {
        return (
            <div className="bg-slate-800 rounded-xl border border-slate-700 p-6">
                <h2 className="text-lg font-semibold mb-4 flex items-center gap-2">
                    <Icons.History /> History ({deployments.length})
                </h2>
                {deployments.length === 0 ? (
                    <div className="text-slate-400 text-center py-8">No deployments yet</div>
                ) : (
                    <div className="space-y-2">
                        {deployments.map(d => (
                            <div key={d.id} className={`p-3 rounded-lg border ${
                                d.status === 'success' ? 'bg-green-900/20 border-green-800' :
                                d.status === 'failed' ? 'bg-red-900/20 border-red-800' : 'border-slate-600'
                            }`}>
                                <div className="flex items-center gap-2">
                                    <span>{apps[d.appId]?.icon}</span>
                                    <span className="font-medium">{d.appName}</span>
                                    <span className="font-mono text-sm text-slate-400">{formatVersion(d.version)}</span>
                                    {d.fileCount && <span className="text-xs text-slate-500">({d.fileCount} files)</span>}
                                    <span className={`text-xs px-1.5 rounded ${d.target === 'prod' ? 'bg-green-900 text-green-300' : 'bg-blue-900 text-blue-300'}`}>
                                        {d.target?.toUpperCase()}
                                    </span>
                                    {d.isPromotion && <span className="text-xs text-amber-400">â†‘ promoted</span>}
                                    {d.isRollback && <span className="text-xs text-amber-400">â†© rollback</span>}
                                    <span className="flex-1" />
                                    {d.status === 'success' && d.commitSha && !d.fileCount && (
                                        <button onClick={() => onRollback(d)}
                                            className="px-2 py-1 text-xs bg-slate-700 hover:bg-amber-900/50 rounded flex items-center gap-1">
                                            <Icons.Rewind className="w-3 h-3" /> Rollback
                                        </button>
                                    )}
                                </div>
                                <div className="text-xs text-slate-500 mt-1 flex items-center gap-2">
                                    {formatDate(d.completedAt || d.startedAt)}
                                    {d.commitSha && <span className="font-mono">â€¢ {d.commitSha.substring(0, 7)}</span>}
                                    {d.previousVersion && <span>â€¢ was {formatVersion(d.previousVersion)}</span>}
                                </div>
                                {d.url && d.status === 'success' && (
                                    <a href={d.url} target="_blank" className="text-xs text-indigo-400 hover:underline">View â†—</a>
                                )}
                            </div>
                        ))}
                    </div>
                )}
            </div>
        );
    }

    // =========================================================================
    // SETTINGS VIEW
    // =========================================================================
    
    function SettingsView({ token, setToken, settings, setSettings, repoCount }) {
        const [show, setShow] = React.useState(false);
        const [testing, setTesting] = React.useState(false);
        const [result, setResult] = React.useState(null);
        
        return (
            <div className="space-y-6">
                <div className="bg-slate-800 rounded-xl border border-slate-700 p-6">
                    <h2 className="text-lg font-semibold mb-4 flex items-center gap-2">
                        <Icons.GitBranch /> GitHub Token
                    </h2>
                    <div className="flex gap-2 mb-2">
                        <input type={show ? 'text' : 'password'} value={token} onChange={e => setToken(e.target.value)}
                            placeholder="ghp_xxxx" className="flex-1 p-2 bg-slate-700 border border-slate-600 rounded font-mono text-sm" />
                        <button onClick={() => setShow(!show)} className="px-3 bg-slate-700 border border-slate-600 rounded">{show ? 'ðŸ™ˆ' : 'ðŸ‘ï¸'}</button>
                        <button onClick={async () => {
                            setTesting(true);
                            try { const gh = new GitHubAPI(token); const r = await gh.listRepos(); setResult({ ok: true, count: r.length }); }
                            catch (e) { setResult({ ok: false, error: e.message }); }
                            setTesting(false);
                        }} disabled={testing} className="px-4 bg-indigo-600 rounded">{testing ? '...' : 'Test'}</button>
                    </div>
                    <a href="https://github.com/settings/tokens/new?scopes=repo" target="_blank" className="text-xs text-indigo-400">Create token â†’</a>
                    {result && <div className={`mt-2 text-sm ${result.ok ? 'text-green-400' : 'text-red-400'}`}>
                        {result.ok ? `âœ“ Found ${result.count} repos` : `âœ— ${result.error}`}
                    </div>}
                </div>
                
                <div className="bg-slate-800 rounded-xl border border-slate-700 p-6">
                    <h2 className="text-lg font-semibold mb-4">Options</h2>
                    <label className="flex items-center gap-3 p-3 bg-slate-700/50 rounded cursor-pointer">
                        <input type="checkbox" checked={settings.createTag} onChange={e => setSettings({ ...settings, createTag: e.target.checked })} />
                        <span>Create Git Tags</span>
                    </label>
                </div>
                
                <div className="bg-slate-800 rounded-xl border border-slate-700 p-6">
                    <h2 className="text-lg font-semibold mb-4">Reset</h2>
                    <div className="space-y-3">
                        <button onClick={() => { 
                            localStorage.removeItem('cc_apps_v6'); 
                            location.reload(); 
                        }}
                            className="px-4 py-2 bg-amber-900/50 text-amber-400 border border-amber-700 rounded mr-3">
                            Reset App Mappings
                        </button>
                        <button onClick={() => { localStorage.clear(); location.reload(); }}
                            className="px-4 py-2 bg-red-900/50 text-red-400 border border-red-700 rounded">
                            Clear All Data
                        </button>
                        <p className="text-xs text-slate-500 mt-2">
                            "Reset App Mappings" keeps your token but resets all appâ†’repo mappings to defaults and re-runs auto-detection.
                        </p>
                    </div>
                </div>
            </div>
        );
    }

    // =========================================================================
    // RENDER
    // =========================================================================
    
    try {
        ReactDOM.createRoot(document.getElementById('root')).render(<App />);
    } catch (error) {
        document.getElementById('root').innerHTML = `<div style="padding:20px;background:#7f1d1d;margin:20px;border-radius:10px;">
            <h2>Error</h2><pre>${error.message}</pre>
            <button onclick="localStorage.clear();location.reload();" style="margin-top:10px;padding:10px;cursor:pointer;">Clear & Reload</button>
        </div>`;
    }
    </script>
</body>
</html>
