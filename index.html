<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Command Center</title>
    <meta name="version" content="8.73.0">
    <meta name="gs-app-id" content="command-center">
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-functions-compat.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/js-yaml/4.1.0/js-yaml.min.js"></script>
    <style>
        * { box-sizing: border-box; }
        body { margin: 0; font-family: system-ui, -apple-system, sans-serif; background: #0f172a; color: #e2e8f0; }
        .animate-spin { animation: spin 1s linear infinite; }
        @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
        .fade-in { animation: fadeIn 0.2s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes slideIn { from { transform: translateX(100%); } to { transform: translateX(0); } }
    </style>
</head>
<body>
    <div id="root"><div style="display:flex;align-items:center;justify-content:center;min-height:100vh;"><div style="text-align:center;"><div style="margin-bottom:20px;"><svg viewBox="0 0 52 52" width="64" height="64" fill="none" xmlns="http://www.w3.org/2000/svg"><defs><filter id="dsLoad" x="-20%" y="-20%" width="140%" height="140%"><feDropShadow dx="0.8" dy="0.8" stdDeviation="1.0" flood-color="#000" flood-opacity=".35"/></filter><linearGradient id="shLoad" x1="28" y1="11" x2="33" y2="19" gradientUnits="userSpaceOnUse"><stop offset="0%" stop-color="#000" stop-opacity="0"/><stop offset="60%" stop-color="#000" stop-opacity=".3"/><stop offset="100%" stop-color="#000" stop-opacity=".4"/></linearGradient></defs><polygon points="35,7 42,11 42,19 35,23 28,19 28,11" fill="#e8a838" fill-opacity=".45"/><polygon points="35,7 42,11 42,19 35,23 28,19 28,11" fill="none" stroke="#e8a838" stroke-opacity=".65" stroke-width="1.2"/><polygon points="26,31 33,35 33,43 26,47 19,43 19,35" fill="#e8a838" fill-opacity=".3"/><polygon points="26,31 33,35 33,43 26,47 19,43 19,35" fill="none" stroke="#e8a838" stroke-opacity=".4" stroke-width="1.2"/><polygon points="12,19 19,23 19,31 12,35 5,31 5,23" fill="#e8a838" fill-opacity=".2"/><polygon points="12,19 19,23 19,31 12,35 5,31 5,23" fill="none" stroke="#e8a838" stroke-opacity=".25" stroke-width="1.2"/><polygon points="28,11 33,14 33,19 28,19" fill="url(#shLoad)"/><polygon points="26,15 33,19 33,27 26,31 19,27 19,19" fill="#e8a838" filter="url(#dsLoad)"/><polygon points="26,18.5 30.5,21 30.5,26 26,28.5 21.5,26 21.5,21" fill="#fff" fill-opacity=".15"/></svg></div>Loading...</div></div></div>

    <script type="text/babel">
    console.log(`Command Center v${document.querySelector('meta[name="version"]')?.content || '?'} starting...`);

    // Test mode: swap real services with mocks when running under Playwright
    const IS_TEST_MODE = window.__CC_TEST_MODE === true;
    if (IS_TEST_MODE) console.log('[CC] Running in TEST MODE â€” using mock services');

    // =========================================================================
    // v8.71.0: bootstrapSatelliteKeys IIFE removed (satellites eliminated â€” Phase 4)

    // =========================================================================
    // FIREBASE CONFIG
    // =========================================================================
    
    const FIREBASE_CONFIG = {
        apiKey: "AIzaSyBQVwn8vOrFTzLlm2MYIPBwgZV2xR9AuhM",
        authDomain: "word-boxing.firebaseapp.com",
        databaseURL: "https://word-boxing-default-rtdb.firebaseio.com",
        projectId: "word-boxing"
    };
    
    // Custom domain mapping for repos
    // Maps repo full names to their custom domains
    const CUSTOM_DOMAINS = {
        'stewartdavidp-ship-it/gameshelf': 'gameshelf.co',
        'stewartdavidp-ship-it/quote-info': 'quotle.info'
    };
    
    // Initialize Firebase (or use mocks in test mode)
    let firebaseApp = null;
    let firebaseAuth = null;
    let firebaseDb = null;

    if (IS_TEST_MODE && window.MockFirebaseDb) {
        firebaseDb = window.MockFirebaseDb;
        firebaseAuth = window.MockFirebaseAuth;
        console.log('[CC] Using mock Firebase services');
    } else {
        try {
            if (!firebase.apps.length) {
                firebaseApp = firebase.initializeApp(FIREBASE_CONFIG);
            } else {
                firebaseApp = firebase.apps[0];
            }
            firebaseAuth = firebase.auth();
            firebaseDb = firebase.database();
            console.log('Firebase initialized successfully');
        } catch (e) {
            console.error('Firebase init error:', e);
        }
    }
    
    // =========================================================================
    // FIREBASE ADMIN (v8.9.0 â€” Service Account Token Management)
    // =========================================================================
    
    class FirebaseAdmin {
        constructor() {
            this.serviceAccount = null;
            this.cachedToken = null;
            this.tokenExpiry = null;
            this.loadServiceAccount();
        }
        
        // Load service account JSON from localStorage
        loadServiceAccount() {
            try {
                const stored = SecretManager.get('firebase_sa') || localStorage.getItem('cc_firebase_sa');
                if (stored) {
                    this.serviceAccount = JSON.parse(stored);
                    console.log('Firebase SA loaded: [configured]');
                }
            } catch (e) {
                console.error('Failed to load service account:', e);
                this.serviceAccount = null;
            }
        }
        
        // Save service account JSON to localStorage
        saveServiceAccount(saJson) {
            try {
                const sa = typeof saJson === 'string' ? JSON.parse(saJson) : saJson;
                // Validate required fields
                const required = ['type', 'project_id', 'private_key', 'client_email'];
                const missing = required.filter(f => !sa[f]);
                if (missing.length > 0) {
                    throw new Error(`Missing required fields: ${missing.join(', ')}`);
                }
                if (sa.type !== 'service_account') {
                    throw new Error(`Invalid type "${sa.type}" â€” expected "service_account"`);
                }
                // Validate private key format
                if (!sa.private_key.includes('BEGIN') || !sa.private_key.includes('PRIVATE KEY')) {
                    throw new Error('Invalid private key format');
                }
                this.serviceAccount = sa;
                SecretManager.set('firebase_sa', JSON.stringify(sa));
                this.cachedToken = null;
                this.tokenExpiry = null;
                console.log('Firebase SA saved: [configured]');
                return { success: true, email: sa.client_email, project: sa.project_id };
            } catch (e) {
                console.error('Failed to save service account:', e);
                return { success: false, error: e.message };
            }
        }
        
        // Remove service account from localStorage
        clearServiceAccount() {
            this.serviceAccount = null;
            this.cachedToken = null;
            this.tokenExpiry = null;
            SecretManager.remove('firebase_sa');
            console.log('Firebase SA cleared');
        }
        
        // Check if configured
        isConfigured() {
            return this.serviceAccount !== null && !!this.serviceAccount.private_key;
        }
        
        // Get summary info (safe to display)
        getInfo() {
            if (!this.serviceAccount) return null;
            return {
                email: this.serviceAccount.client_email,
                projectId: this.serviceAccount.project_id,
                keyId: this.serviceAccount.private_key_id?.slice(0, 8) + '...',
                tokenCached: !!this.cachedToken,
                tokenExpiry: this.tokenExpiry ? new Date(this.tokenExpiry).toLocaleTimeString() : null,
                tokenValid: this.cachedToken && this.tokenExpiry && Date.now() < this.tokenExpiry
            };
        }
        
        // Parse PEM private key to CryptoKey for RS256 signing
        async importPrivateKey(pemKey) {
            // Strip PEM header/footer and whitespace
            const pemContents = pemKey
                .replace(/-----BEGIN (RSA )?PRIVATE KEY-----/, '')
                .replace(/-----END (RSA )?PRIVATE KEY-----/, '')
                .replace(/\s/g, '');
            
            // Decode base64 to ArrayBuffer
            const binaryStr = atob(pemContents);
            const bytes = new Uint8Array(binaryStr.length);
            for (let i = 0; i < binaryStr.length; i++) {
                bytes[i] = binaryStr.charCodeAt(i);
            }
            
            // Import as PKCS8 key
            return await crypto.subtle.importKey(
                'pkcs8',
                bytes.buffer,
                { name: 'RSASSA-PKCS1-v1_5', hash: 'SHA-256' },
                false,
                ['sign']
            );
        }
        
        // Base64url encode (no padding, URL-safe)
        base64url(data) {
            if (typeof data === 'string') {
                data = new TextEncoder().encode(data);
            }
            const bytes = new Uint8Array(data);
            let binary = '';
            for (let i = 0; i < bytes.length; i++) {
                binary += String.fromCharCode(bytes[i]);
            }
            const base64 = btoa(binary);
            return base64.replace(/\+/g, '-').replace(/\//g, '_').replace(/=+$/, '');
        }
        
        // Create and sign a JWT for Google OAuth2
        async createSignedJWT(scopes) {
            const sa = this.serviceAccount;
            if (!sa) throw new Error('No service account configured');
            
            const now = Math.floor(Date.now() / 1000);
            
            const header = { alg: 'RS256', typ: 'JWT' };
            if (sa.private_key_id) header.kid = sa.private_key_id;
            
            const payload = {
                iss: sa.client_email,
                scope: Array.isArray(scopes) ? scopes.join(' ') : scopes,
                aud: 'https://oauth2.googleapis.com/token',
                iat: now,
                exp: now + 3600 // 1 hour
            };
            
            const headerB64 = this.base64url(JSON.stringify(header));
            const payloadB64 = this.base64url(JSON.stringify(payload));
            const signingInput = `${headerB64}.${payloadB64}`;
            
            // Import key and sign
            const cryptoKey = await this.importPrivateKey(sa.private_key);
            const signature = await crypto.subtle.sign(
                'RSASSA-PKCS1-v1_5',
                cryptoKey,
                new TextEncoder().encode(signingInput)
            );
            
            const signatureB64 = this.base64url(signature);
            return `${signingInput}.${signatureB64}`;
        }
        
        // Exchange signed JWT for a Google OAuth2 access token
        async getAccessToken(scopes = [
            'https://www.googleapis.com/auth/userinfo.email',
            'https://www.googleapis.com/auth/firebase.database',
            'https://www.googleapis.com/auth/cloud-platform'
        ]) {
            // Return cached token if still valid (with 5 min buffer)
            if (this.cachedToken && this.tokenExpiry && Date.now() < (this.tokenExpiry - 300000)) {
                return this.cachedToken;
            }
            
            const jwt = await this.createSignedJWT(scopes);
            
            const response = await fetch('https://oauth2.googleapis.com/token', {
                method: 'POST',
                headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                body: new URLSearchParams({
                    grant_type: 'urn:ietf:params:oauth:grant-type:jwt-bearer',
                    assertion: jwt
                })
            });
            
            if (!response.ok) {
                const err = await response.json().catch(() => ({}));
                throw new Error(`Token exchange failed: ${err.error_description || err.error || response.status}`);
            }
            
            const data = await response.json();
            this.cachedToken = data.access_token;
            this.tokenExpiry = Date.now() + ((data.expires_in || 3600) * 1000);
            console.log('Firebase admin token obtained, expires:', new Date(this.tokenExpiry).toLocaleTimeString());
            return this.cachedToken;
        }
        
        // Invalidate cached token
        clearToken() {
            this.cachedToken = null;
            this.tokenExpiry = null;
        }
        
        // ---- RTDB Rules API (v8.70.4) ----

        // Quick test â€” tries to read RTDB rules and auth config to verify admin access
        async testConnection() {
            const results = { token: false, rules: false, authConfig: false, errors: [] };

            try {
                await this.getAccessToken();
                results.token = true;
            } catch (e) {
                results.errors.push(`Token: ${e.message}`);
                return results;
            }

            try {
                const rules = await this.getRules();
                results.rules = rules && typeof rules === 'object';
            } catch (e) {
                results.errors.push(`Rules: ${e.message}`);
            }

            try {
                const domains = await this.getAuthorizedDomains();
                results.authConfig = Array.isArray(domains);
                results.authorizedDomains = domains;
            } catch (e) {
                results.errors.push(`Auth Config: ${e.message}`);
            }

            return results;
        }

        // Get current RTDB security rules
        async getRules() {
            const token = await this.getAccessToken();
            const dbUrl = 'https://word-boxing-default-rtdb.firebaseio.com';
            const res = await fetch(`${dbUrl}/.settings/rules.json?access_token=${token}`);
            if (!res.ok) {
                const err = await res.text();
                throw new Error(`Failed to read rules: ${res.status} ${err}`);
            }
            return await res.json();
        }

        // Deploy RTDB security rules
        async deployRules(rulesJson) {
            const token = await this.getAccessToken();
            const dbUrl = 'https://word-boxing-default-rtdb.firebaseio.com';
            const body = typeof rulesJson === 'string' ? rulesJson : JSON.stringify(rulesJson);
            const res = await fetch(`${dbUrl}/.settings/rules.json?access_token=${token}`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body
            });
            if (!res.ok) {
                const err = await res.text();
                throw new Error(`Failed to deploy rules: ${res.status} ${err}`);
            }
            console.log('[FirebaseAdmin] âœ… RTDB rules deployed successfully');
            return true;
        }

        // Deploy rules and return parsed JSON (used by FirebaseRulesManager)
        async putRules(rules) {
            const token = await this.getAccessToken();
            const dbUrl = 'https://word-boxing-default-rtdb.firebaseio.com';
            const body = typeof rules === 'string' ? rules : JSON.stringify(rules);
            const response = await fetch(`${dbUrl}/.settings/rules.json?access_token=${encodeURIComponent(token)}`, {
                method: 'PUT',
                body: body
            });
            if (!response.ok) {
                const err = await response.text();
                throw new Error(`Failed to deploy rules: ${response.status} â€” ${err}`);
            }
            return await response.json();
        }

        // ---- Firebase Auth Config API (Identity Toolkit v2) ----

        // Get Firebase Auth project config (includes authorizedDomains)
        async getAuthConfig() {
            const token = await this.getAccessToken();
            const projectId = this.serviceAccount.project_id;
            const response = await fetch(
                `https://identitytoolkit.googleapis.com/v2/projects/${projectId}/config`,
                { headers: { 'Authorization': `Bearer ${token}` } }
            );
            if (!response.ok) {
                const err = await response.text();
                throw new Error(`Failed to fetch auth config: ${response.status} â€” ${err}`);
            }
            return await response.json();
        }

        // Get current authorized domains list
        async getAuthorizedDomains() {
            const config = await this.getAuthConfig();
            return config.authorizedDomains || [];
        }

        // Update authorized domains (replaces entire list â€” always include existing domains)
        async updateAuthorizedDomains(domains) {
            const token = await this.getAccessToken();
            const projectId = this.serviceAccount.project_id;
            const response = await fetch(
                `https://identitytoolkit.googleapis.com/v2/projects/${projectId}/config?updateMask=authorizedDomains`,
                {
                    method: 'PATCH',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ authorizedDomains: domains })
                }
            );
            if (!response.ok) {
                const err = await response.text();
                throw new Error(`Failed to update authorized domains: ${response.status} â€” ${err}`);
            }
            return await response.json();
        }

        // Add a domain to authorized domains (safe â€” reads current list first)
        async addAuthorizedDomain(domain) {
            const current = await this.getAuthorizedDomains();
            if (current.includes(domain)) {
                console.log(`[FirebaseAdmin] Domain ${domain} already authorized`);
                return { authorizedDomains: current, alreadyExists: true };
            }
            const updated = [...current, domain];
            const result = await this.updateAuthorizedDomains(updated);
            console.log(`[FirebaseAdmin] Added ${domain} to authorized domains`);
            return { authorizedDomains: result.authorizedDomains || updated, alreadyExists: false };
        }

        // Remove a domain from authorized domains
        async removeAuthorizedDomain(domain) {
            const current = await this.getAuthorizedDomains();
            const updated = current.filter(d => d !== domain);
            if (updated.length === current.length) {
                console.log(`[FirebaseAdmin] Domain ${domain} not found in authorized domains`);
                return { authorizedDomains: current, notFound: true };
            }
            const result = await this.updateAuthorizedDomains(updated);
            console.log(`[FirebaseAdmin] Removed ${domain} from authorized domains`);
            return { authorizedDomains: result.authorizedDomains || updated, notFound: false };
        }
    }
    
    // Global instance
    const firebaseAdmin = new FirebaseAdmin();

    // =========================================================================
    // DOMAIN SERVICES (Porkbun, GoDaddy, Registry) â€” ported from Infrastructure satellite
    // =========================================================================

    // DOMAIN SERVICES (Porkbun, GoDaddy, Registry)
    // =========================================================================

    const PorkbunService = {
        CONFIG_KEY: 'cc_domain_config',
        PRICE_CACHE_KEY: 'cc_tld_prices',
        HEALTH_CACHE_KEY: 'cc_domain_health',
        BASE_URL: 'https://api.porkbun.com/api/json/v3',
        PROXY_URL: 'https://us-central1-word-boxing.cloudfunctions.net/domainProxy',
        
        // GitHub Pages IP addresses (current as of 2025)
        GITHUB_PAGES_IPS: [
            '185.199.108.153',
            '185.199.109.153',
            '185.199.110.153',
            '185.199.111.153'
        ],
        
        // Preferred TLDs for domain search (ordered by relevance for dev tools)
        PREFERRED_TLDS: ['com', 'dev', 'app', 'io', 'co', 'ai', 'sh', 'tools', 'site', 'net'],
        
        // â”€â”€â”€ Configuration â”€â”€â”€
        
        getConfig() {
            try { return JSON.parse(localStorage.getItem(this.CONFIG_KEY) || '{}'); }
            catch { return {}; }
        },
        
        saveConfig(config) {
            localStorage.setItem(this.CONFIG_KEY, JSON.stringify(config));
        },
        
        isConfigured() {
            const cfg = this.getConfig();
            return !!(cfg.apiKey && cfg.secretApiKey);
        },
        
        // â”€â”€â”€ Core API Call (via Firebase proxy to avoid CORS) â”€â”€â”€
        
        async _call(endpoint, extraBody = {}) {
            const cfg = this.getConfig();
            if (!cfg.apiKey || !cfg.secretApiKey) {
                throw new Error('Porkbun API keys not configured. Go to Settings â†’ Domain Registrar.');
            }

            // v8.71.5: Pass Firebase ID token for domainProxy auth
            const idToken = firebaseAuth?.currentUser ? await firebaseAuth.currentUser.getIdToken() : null;
            const headers = { 'Content-Type': 'application/json' };
            if (idToken) headers['Authorization'] = `Bearer ${idToken}`;

            const response = await fetch(this.PROXY_URL, {
                method: 'POST',
                headers,
                body: JSON.stringify({
                    provider: 'porkbun',
                    endpoint: endpoint,
                    method: 'POST',
                    body: {
                        apikey: cfg.apiKey,
                        secretapikey: cfg.secretApiKey,
                        ...extraBody
                    }
                })
            });
            
            if (!response.ok) {
                const text = await response.text();
                throw new Error(`Porkbun API error (${response.status}): ${text}`);
            }
            
            const data = await response.json();
            if (data.status === 'ERROR') {
                throw new Error(data.message || 'Porkbun API returned an error');
            }
            return data;
        },
        
        // â”€â”€â”€ Connection Test â”€â”€â”€
        
        async ping() {
            return await this._call('/ping');
            // Returns: { status: "SUCCESS", yourIp: "x.x.x.x" }
        },
        
        // â”€â”€â”€ Domain Operations â”€â”€â”€
        
        async listDomains() {
            const data = await this._call('/domain/listAll');
            return data.domains || [];
            // Returns: [{ domain, status, tld, createDate, expireDate, autoRenew, ... }]
        },
        
        async checkAvailability(domain) {
            const data = await this._call(`/domain/checkDomain/${domain}`);
            return {
                domain,
                available: data.response?.avail === 'yes',
                price: parseFloat(data.response?.price || 0),
                regularPrice: parseFloat(data.response?.regularPrice || 0),
                renewalPrice: parseFloat(data.response?.additional?.renewal?.price || 0),
                premium: data.response?.premium === 'yes',
                firstYearPromo: data.response?.firstYearPromo === 'yes',
                limits: data.limits
            };
        },
        
        async checkMultipleTLDs(keyword) {
            // Check availability across preferred TLDs
            // Rate limited: 1 check per 10 seconds at Porkbun
            const results = [];
            for (const tld of this.PREFERRED_TLDS) {
                const domain = keyword.includes('.') ? keyword : `${keyword}.${tld}`;
                try {
                    const result = await this.checkAvailability(domain);
                    results.push(result);
                } catch (e) {
                    results.push({ domain, available: false, error: e.message });
                }
                // Respect rate limits
                if (results.length < this.PREFERRED_TLDS.length) {
                    await this._rateLimit(10500); // 10.5s between checks
                }
            }
            return results;
        },
        
        async registerDomain(domain, costInPennies) {
            return await this._call(`/domain/create/${domain}`, {
                cost: costInPennies,
                agreeToTerms: 'yes'
            });
            // Returns: { status, domain, cost, orderId, balance }
        },
        
        async updateAutoRenew(domain, on = true) {
            return await this._call(`/domain/updateAutoRenew/${domain}`, {
                status: on ? 'on' : 'off'
            });
        },
        
        // â”€â”€â”€ DNS Record Management â”€â”€â”€
        
        async listDNSRecords(domain) {
            const data = await this._call(`/dns/retrieve/${domain}`);
            return data.records || [];
            // Returns: [{ id, name, type, content, ttl, prio, notes }]
        },
        
        async createDNSRecord(domain, type, name, content, ttl = 600, prio = null) {
            const body = { type, content, ttl: String(ttl) };
            if (name) body.name = name;
            if (prio !== null) body.prio = String(prio);
            const data = await this._call(`/dns/create/${domain}`, body);
            return { id: data.id, type, name: name || '@', content };
        },
        
        async editDNSRecord(domain, recordId, type, name, content, ttl = 600) {
            return await this._call(`/dns/edit/${domain}/${recordId}`, {
                type, content, ttl: String(ttl),
                ...(name ? { name } : {})
            });
        },
        
        async deleteDNSRecord(domain, recordId, allRecords) {
            // allRecords param unused â€” Porkbun supports individual record delete by ID
            return await this._call(`/dns/delete/${domain}/${recordId}`);
        },
        
        async deleteDNSByType(domain, type, subdomain) {
            const endpoint = subdomain 
                ? `/dns/deleteByNameType/${domain}/${type}/${subdomain}`
                : `/dns/deleteByNameType/${domain}/${type}`;
            return await this._call(endpoint);
        },
        
        // â”€â”€â”€ TLD Pricing (cached) â”€â”€â”€
        
        async getTLDPrices(forceRefresh = false) {
            // Check cache first
            if (!forceRefresh) {
                try {
                    const cached = JSON.parse(localStorage.getItem(this.PRICE_CACHE_KEY) || '{}');
                    if (cached.timestamp && Date.now() - cached.timestamp < 24 * 60 * 60 * 1000) {
                        return cached.prices;
                    }
                } catch {}
            }
            
            // Pricing endpoint via proxy (auth required since v8.71.5)
            const idToken = firebaseAuth?.currentUser ? await firebaseAuth.currentUser.getIdToken() : null;
            const pricingHeaders = { 'Content-Type': 'application/json' };
            if (idToken) pricingHeaders['Authorization'] = `Bearer ${idToken}`;

            const response = await fetch(this.PROXY_URL, {
                method: 'POST',
                headers: pricingHeaders,
                body: JSON.stringify({
                    provider: 'porkbun',
                    endpoint: '/pricing/get',
                    method: 'POST',
                    body: {}
                })
            });
            const data = await response.json();
            
            if (data.status === 'SUCCESS' && data.pricing) {
                localStorage.setItem(this.PRICE_CACHE_KEY, JSON.stringify({
                    timestamp: Date.now(),
                    prices: data.pricing
                }));
                return data.pricing;
            }
            throw new Error('Failed to fetch TLD pricing');
        },
        
        // â”€â”€â”€ GitHub Pages DNS Configuration â”€â”€â”€
        
        async configureForGitHubPages(domain, githubUsername) {
            const results = [];
            const log = [];
            
            // Step 1: Get existing records and remove conflicting ones
            log.push('Fetching existing DNS records...');
            const existing = await this.listDNSRecords(domain);
            
            // Delete existing A, AAAA, and root CNAME records that would conflict
            for (const record of existing) {
                const isRoot = record.name === domain || record.name === '';
                const isWww = record.name === `www.${domain}` || record.name === 'www';
                if ((isRoot && (record.type === 'A' || record.type === 'AAAA' || record.type === 'CNAME' || record.type === 'ALIAS')) ||
                    (isWww && record.type === 'CNAME')) {
                    log.push(`Deleting conflicting ${record.type} record: ${record.content}`);
                    await this.deleteDNSRecord(domain, record.id);
                    await this._rateLimit(1100);
                }
            }
            
            // Step 2: Create 4 A records for apex domain
            for (const ip of this.GITHUB_PAGES_IPS) {
                log.push(`Creating A record â†’ ${ip}`);
                const result = await this.createDNSRecord(domain, 'A', '', ip, 600);
                results.push(result);
                await this._rateLimit(1100);
            }
            
            // Step 3: Create CNAME for www â†’ username.github.io
            log.push(`Creating CNAME www â†’ ${githubUsername}.github.io`);
            const cnameResult = await this.createDNSRecord(
                domain, 'CNAME', 'www', `${githubUsername}.github.io`, 600
            );
            results.push(cnameResult);
            
            return { 
                success: true, 
                recordsCreated: results.length, 
                records: results,
                log
            };
        },
        
        // â”€â”€â”€ Domain Health Caching â”€â”€â”€
        
        getHealthCache() {
            try { return JSON.parse(localStorage.getItem(this.HEALTH_CACHE_KEY) || '{}'); }
            catch { return {}; }
        },
        
        setHealthCache(domain, result) {
            const cache = this.getHealthCache();
            cache[domain] = { lastCheck: new Date().toISOString(), result };
            localStorage.setItem(this.HEALTH_CACHE_KEY, JSON.stringify(cache));
        },
        
        // â”€â”€â”€ Utility â”€â”€â”€
        
        _rateLimit(ms = 1100) {
            return new Promise(resolve => setTimeout(resolve, ms));
        },
        
        // Format price from string to display
        formatPrice(price) {
            const num = typeof price === 'string' ? parseFloat(price) : price;
            return isNaN(num) ? 'â€”' : `$${num.toFixed(2)}`;
        }
    };

    const GoDaddyService = {
        CONFIG_KEY: 'cc_godaddy_config',
        BASE_URL: 'https://api.godaddy.com/v1',
        PROXY_URL: 'https://us-central1-word-boxing.cloudfunctions.net/domainProxy',
        
        GITHUB_PAGES_IPS: [
            '185.199.108.153',
            '185.199.109.153',
            '185.199.110.153',
            '185.199.111.153'
        ],
        
        // â”€â”€â”€ Configuration â”€â”€â”€
        
        getConfig() {
            try { return JSON.parse(localStorage.getItem(this.CONFIG_KEY) || '{}'); }
            catch { return {}; }
        },
        
        saveConfig(config) {
            localStorage.setItem(this.CONFIG_KEY, JSON.stringify(config));
        },
        
        isConfigured() {
            const cfg = this.getConfig();
            return !!(cfg.apiKey && cfg.apiSecret);
        },
        
        // â”€â”€â”€ Core API Call (via Firebase proxy to avoid CORS) â”€â”€â”€
        
        async _call(endpoint, method = 'GET', body = null) {
            const cfg = this.getConfig();
            if (!cfg.apiKey || !cfg.apiSecret) {
                throw new Error('GoDaddy API keys not configured. Go to Settings â†’ Domain Registrar.');
            }

            const isOTE = cfg.environment === 'ote';
            const proxyBody = {
                provider: isOTE ? 'godaddy-ote' : 'godaddy',
                endpoint: endpoint,
                method: method,
                headers: {
                    'Authorization': `sso-key ${cfg.apiKey}:${cfg.apiSecret}`
                }
            };
            if (body && ['POST', 'PUT', 'PATCH'].includes(method)) {
                proxyBody.body = body;
            }

            // v8.71.5: Pass Firebase ID token for domainProxy auth
            const idToken = firebaseAuth?.currentUser ? await firebaseAuth.currentUser.getIdToken() : null;
            const proxyHeaders = { 'Content-Type': 'application/json' };
            if (idToken) proxyHeaders['Authorization'] = `Bearer ${idToken}`;

            const response = await fetch(this.PROXY_URL, {
                method: 'POST',
                headers: proxyHeaders,
                body: JSON.stringify(proxyBody)
            });

            if (!response.ok) {
                const data = await response.json().catch(() => ({}));
                if (response.status === 403) {
                    const envHint = cfg.environment === 'ote'
                        ? 'Your OTE keys may be invalid or expired. Generate new keys at developer.godaddy.com.'
                        : 'Production API requires 10+ domains or Domain Pro Plan. If using OTE/test keys, switch to OTE environment in Settings.';
                    throw new Error(`GoDaddy 403 (Forbidden). ${envHint}`);
                }
                throw new Error(data.message || `GoDaddy API error (${response.status})`);
            }

            const text = await response.text();
            return text ? JSON.parse(text) : { status: 'SUCCESS' };
        },
        
        // â”€â”€â”€ Connection Test â”€â”€â”€
        
        async ping() {
            // GoDaddy has no explicit ping â€” we list domains as a test
            const domains = await this._call('/domains?limit=1');
            return { status: 'SUCCESS', yourIp: 'N/A', domainCount: domains.length };
        },
        
        // â”€â”€â”€ Domain Operations â”€â”€â”€
        
        async listDomains() {
            const data = await this._call('/domains');
            // Normalize to match PorkbunService format
            return data.map(d => ({
                domain: d.domain,
                status: d.status,
                tld: d.domain.split('.').pop(),
                createDate: d.createdAt,
                expireDate: d.expires,
                autoRenew: d.renewAuto,
                provider: 'godaddy'
            }));
        },
        
        // â”€â”€â”€ DNS Record Management â”€â”€â”€
        // GoDaddy uses type+name to identify records, NOT unique IDs
        // Records have: type, name, data (not content), ttl, priority
        
        async listDNSRecords(domain) {
            const data = await this._call(`/domains/${domain}/records`);
            // Normalize to match Porkbun format
            return data.map((r, i) => ({
                id: `${r.type}-${r.name}-${i}`,  // Synthetic ID (GoDaddy has none)
                name: r.name === '@' ? domain : `${r.name}.${domain}`,
                type: r.type,
                content: r.data,
                ttl: String(r.ttl),
                prio: r.priority ? String(r.priority) : '0',
                notes: '',
                _gdName: r.name,  // Keep original GoDaddy name for API calls
                _gdData: r.data
            }));
        },
        
        async createDNSRecord(domain, type, name, content, ttl = 600, prio = null) {
            // GoDaddy uses PATCH to add records (append)
            const record = {
                type,
                name: name || '@',
                data: content,
                ttl: parseInt(ttl) || 600
            };
            if (prio !== null) record.priority = parseInt(prio);
            
            await this._call(`/domains/${domain}/records`, 'PATCH', [record]);
            return { id: `${type}-${name || '@'}-new`, type, name: name || '@', content };
        },
        
        async deleteDNSRecord(domain, recordId, allRecords) {
            // GoDaddy has no individual delete â€” we must replace all records of that type/name
            // OR replace ALL records minus the one we want to remove
            // We need the full record list to do this
            if (!allRecords) {
                allRecords = await this.listDNSRecords(domain);
            }
            
            const toKeep = allRecords.filter(r => r.id !== recordId);
            
            // Rebuild in GoDaddy's format
            const gdRecords = toKeep
                .filter(r => !['NS', 'SOA'].includes(r.type)) // Can't replace NS/SOA
                .map(r => ({
                    type: r.type,
                    name: r._gdName || (r.name === domain ? '@' : r.name.replace(`.${domain}`, '')),
                    data: r._gdData || r.content,
                    ttl: parseInt(r.ttl) || 600,
                    ...(r.prio && r.prio !== '0' ? { priority: parseInt(r.prio) } : {})
                }));
            
            if (gdRecords.length === 0) {
                throw new Error('Cannot delete all records. At least one record must remain.');
            }
            
            await this._call(`/domains/${domain}/records`, 'PUT', gdRecords);
            return { status: 'SUCCESS' };
        },
        
        // â”€â”€â”€ GitHub Pages DNS Configuration â”€â”€â”€
        
        async configureForGitHubPages(domain, githubUsername) {
            const log = [];
            
            // Step 1: Get existing records
            log.push('Fetching existing DNS records...');
            const existing = await this.listDNSRecords(domain);
            
            // Step 2: Build new record set â€” keep non-conflicting, replace A/CNAME
            const keepRecords = existing
                .filter(r => !['NS', 'SOA'].includes(r.type))
                .filter(r => {
                    const isRoot = r._gdName === '@' || r.name === domain;
                    const isWww = r._gdName === 'www';
                    if (isRoot && (r.type === 'A' || r.type === 'AAAA' || r.type === 'CNAME' || r.type === 'ALIAS')) {
                        log.push(`Removing conflicting ${r.type} record: ${r.content}`);
                        return false;
                    }
                    if (isWww && r.type === 'CNAME') {
                        log.push(`Removing conflicting CNAME www record: ${r.content}`);
                        return false;
                    }
                    return true;
                })
                .map(r => ({
                    type: r.type,
                    name: r._gdName || '@',
                    data: r._gdData || r.content,
                    ttl: parseInt(r.ttl) || 600,
                    ...(r.prio && r.prio !== '0' ? { priority: parseInt(r.prio) } : {})
                }));
            
            // Step 3: Add GitHub Pages records
            const ghRecords = this.GITHUB_PAGES_IPS.map(ip => {
                log.push(`Adding A record â†’ ${ip}`);
                return { type: 'A', name: '@', data: ip, ttl: 600 };
            });
            
            log.push(`Adding CNAME www â†’ ${githubUsername}.github.io`);
            ghRecords.push({ type: 'CNAME', name: 'www', data: `${githubUsername}.github.io`, ttl: 600 });
            
            // Step 4: Replace all records at once (GoDaddy's approach)
            const allRecords = [...keepRecords, ...ghRecords];
            await this._call(`/domains/${domain}/records`, 'PUT', allRecords);
            
            return {
                success: true,
                recordsCreated: ghRecords.length,
                records: ghRecords.map(r => ({ type: r.type, name: r.name, content: r.data })),
                log
            };
        },
        
        // â”€â”€â”€ Utility â”€â”€â”€
        formatPrice(price) {
            const num = typeof price === 'string' ? parseFloat(price) : price;
            return isNaN(num) ? 'â€”' : `$${num.toFixed(2)}`;
        }
    };

    const DomainProviderRegistry = {
        PROVIDERS: {
            porkbun: {
                id: 'porkbun',
                name: 'Porkbun',
                icon: 'ðŸ·',
                service: PorkbunService,
                configKey: PorkbunService.CONFIG_KEY,
                keyFields: [
                    { key: 'apiKey', label: 'API Key', placeholder: 'pk1_xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx' },
                    { key: 'secretApiKey', label: 'Secret API Key', placeholder: 'sk1_xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx' }
                ],
                setupUrl: 'https://porkbun.com/account/api',
                setupNote: 'Generate API keys, then enable API access per domain in Domain Management â†’ Details.',
                hasRegistration: true
            },
            godaddy: {
                id: 'godaddy',
                name: 'GoDaddy',
                icon: 'ðŸŸ¢',
                service: GoDaddyService,
                configKey: GoDaddyService.CONFIG_KEY,
                keyFields: [
                    { key: 'apiKey', label: 'API Key', placeholder: 'Your GoDaddy API Key' },
                    { key: 'apiSecret', label: 'API Secret', placeholder: 'Your GoDaddy API Secret' },
                    { key: 'environment', label: 'Environment', type: 'select', options: [
                        { value: 'production', label: 'Production (requires 10+ domains)' },
                        { value: 'ote', label: 'OTE (Test Environment)' }
                    ], default: 'production' }
                ],
                setupUrl: 'https://developer.godaddy.com/keys',
                setupNote: 'Production requires 10+ domains or Domain Pro Plan. OTE keys work with the test environment.',
                hasRegistration: false
            }
        },
        
        getAll() {
            return Object.values(this.PROVIDERS);
        },
        
        get(providerId) {
            return this.PROVIDERS[providerId] || null;
        },
        
        getService(providerId) {
            const provider = this.get(providerId);
            return provider ? provider.service : null;
        },
        
        // Get all configured providers
        getConfigured() {
            return this.getAll().filter(p => p.service.isConfigured());
        },
        
        // Get all domains across all configured providers
        async getAllDomains() {
            const results = [];
            const errors = [];
            for (const provider of this.getConfigured()) {
                try {
                    const domains = await provider.service.listDomains();
                    domains.forEach(d => {
                        d.provider = provider.id;
                        d.providerName = provider.name;
                        d.providerIcon = provider.icon;
                    });
                    results.push(...domains);
                } catch (e) {
                    console.warn(`Failed to fetch domains from ${provider.name}:`, e);
                    errors.push({ provider: provider.name, icon: provider.icon, error: e.message });
                }
            }
            return { domains: results, errors };
        },
        
        // Get the service for a specific domain (by checking which provider owns it)
        getServiceForDomain(domain, allDomains) {
            const match = allDomains.find(d => d.domain === domain);
            if (match) return this.getService(match.provider);
            // Default to first configured
            const configured = this.getConfigured();
            return configured.length > 0 ? configured[0].service : null;
        }
    };
    
    // =========================================================================
    // FIREBASE CONFIG SYNC (v8.17.0 â€” Server-Side Config Storage)
    // =========================================================================
    // Syncs CC configuration data to Firebase RTDB as source of truth.
    // localStorage remains the instant-load cache; Firebase is the primary store.
    // Sensitive data (tokens, SA keys, API keys) stays in localStorage only.
    //
    // Firebase path: command-center/{dataKey}
    // Data sets synced: config
    //                   deletion-history, rollback-snapshots
    // =========================================================================
    
    const FirebaseConfigSync = {
        BASE_PATH: 'command-center',
        db: null,
        uid: null, // v8.70.0: Firebase UID for per-user data isolation
        initialized: false,
        syncStatus: 'offline', // 'offline' | 'syncing' | 'synced' | 'error'
        statusListeners: new Set(),
        _recoveryTimer: null, // v8.61.1: Self-healing timer for error recovery

        // v8.70.0: Set active user UID â€” all refs scoped to command-center/{uid}/{dataKey}
        setUid(uid) {
            this.uid = uid;
            if (uid) console.log(`[ConfigSync] UID set: ${uid.slice(0, 8)}...`);
            else console.log('[ConfigSync] UID cleared');
        },

        // v8.70.0: Build a scoped ref â€” returns null if no UID (guards all operations)
        _ref(dataKey) {
            if (!this.db || !this.uid) {
                if (this.db && !this.uid) console.warn('[ConfigSync] No UID set, skipping ref for', dataKey);
                return null;
            }
            return this.db.ref(`${this.BASE_PATH}/${this.uid}/${dataKey}`);
        },

        // v8.70.0â†’v8.70.9: Migration from global paths to UID-scoped paths.
        // DISABLED in v8.70.9 â€” the shared path `command-center/config` contains
        // the original user's data. New users who log in for the first time would
        // have that data copied into their own UID path, leaking another user's
        // projects, deploy history, etc. The migration already ran for the original
        // user; new users must start fresh.
        async migrateFromGlobal() {
            // No-op. New users get an empty config and can set up their own apps.
            return false;
        },

        // Data key â†’ localStorage key mapping
        DATA_KEYS: {
            'config': 'commandCenterConfig',
            // v8.70.14: Removed dead sync slots â€” rules-history, session-log, deletion-history
            // (no React state, no writers, no UI consumers)
        },
        
        // Initialize with Firebase database reference
        init(database) {
            if (!database) {
                console.warn('[ConfigSync] No database provided, running in offline mode');
                return;
            }
            this.db = database;
            this.initialized = true;
            console.log('[ConfigSync] Initialized with Firebase RTDB');
        },
        
        // --- Status management ---
        
        _setStatus(status) {
            this.syncStatus = status;
            this.statusListeners.forEach(fn => fn(status));

            // v8.61.1: Self-healing â€” if status goes to 'error', schedule a recovery check.
            // A single failed push shouldn't keep the UI stuck on 'error' forever.
            if (status === 'error' && !this._recoveryTimer) {
                this._recoveryTimer = setTimeout(async () => {
                    this._recoveryTimer = null;
                    if (this.syncStatus !== 'error') return; // Already recovered
                    try {
                        // Lightweight connectivity check â€” just read a single key
                        const checkRef = this._ref('config');
                        if (!checkRef) return;
                        await checkRef.child('_updatedAt').once('value');
                        // Connection works â€” clear the error
                        console.log('[ConfigSync] Recovery check passed, clearing error status');
                        this.syncStatus = 'synced';
                        this.statusListeners.forEach(fn => fn('synced'));
                    } catch {
                        // Still broken â€” leave as error
                        console.log('[ConfigSync] Recovery check failed, status remains error');
                    }
                }, 5000);
            }
        },
        
        onStatusChange(callback) {
            this.statusListeners.add(callback);
            return () => this.statusListeners.delete(callback);
        },
        
        // --- Write methods (fire-and-forget after localStorage save) ---
        
        // Debounce timers per data key (prevents rapid-fire writes during batch operations)
        _debounceTimers: {},
        DEBOUNCE_KEYS: new Set([]), // v8.70.15: All debounced keys removed
        DEBOUNCE_MS: 2000, // 2-second debounce window
        
        async push(dataKey, data) {
            if (!this.initialized || !this.db) return;
            const ref = this._ref(dataKey);
            if (!ref) return;
            try {
                const payload = JSON.parse(JSON.stringify(data)); // Deep clone to strip undefined
                payload._updatedAt = Date.now();
                payload._updatedBy = 'local';
                await ref.set(payload);
                this._setStatus('synced');
                console.log(`[ConfigSync] Pushed ${dataKey} to Firebase`);
            } catch (err) {
                console.warn(`[ConfigSync] Failed to push ${dataKey}:`, err.message);
                this._setStatus('error');
            }
        },
        
        // Debounced push â€” delays the write, resets timer on each call
        pushDebounced(dataKey, data) {
            if (!this.initialized || !this.db) return Promise.resolve();
            
            // Clear any existing timer for this key
            if (this._debounceTimers[dataKey]) {
                clearTimeout(this._debounceTimers[dataKey]);
            }
            
            this._setStatus('syncing');
            
            return new Promise((resolve) => {
                this._debounceTimers[dataKey] = setTimeout(() => {
                    delete this._debounceTimers[dataKey];
                    this.push(dataKey, data).then(resolve).catch(resolve);
                }, this.DEBOUNCE_MS);
            });
        },
        
        // Smart push â€” uses debounce for rapid-fire keys, immediate for others
        pushSmart(dataKey, data) {
            if (this.DEBOUNCE_KEYS.has(dataKey)) {
                return this.pushDebounced(dataKey, data);
            }
            return this.push(dataKey, data);
        },
        
        async pushConfig(config) {
            return this.push('config', config);
        },
        
        // v8.70.15: pushDeployHistory removed
        
        // v8.70.14: Removed pushRulesHistory, pushSessionLog, pushDeletionHistory (dead sync slots)

        // v8.70.15: pushRollbackSnapshots removed (deploy pipeline eliminated)
        
        // --- Read methods (one-time fetch for startup overlay) ---
        
        async pull(dataKey) {
            if (!this.initialized || !this.db) return null;
            const ref = this._ref(dataKey);
            if (!ref) return null;
            try {
                const snap = await ref.once('value');
                return snap.val();
            } catch (err) {
                console.warn(`[ConfigSync] Failed to pull ${dataKey}:`, err.message);
                return null;
            }
        },
        
        async pullConfig() {
            return this.pull('config');
        },
        
        // v8.70.15: pullDeployHistory removed
        
        // v8.70.14: Removed pullRulesHistory, pullSessionLog, pullDeletionHistory (dead sync slots)

        // v8.70.15: pullRollbackSnapshots removed
        
        // --- Startup sync: pull all data from Firebase ---
        // Returns an object with all synced data sets, or null for sets not found.
        // The caller decides whether to overlay onto local state.
        
        async pullAll() {
            if (!this.initialized || !this.db) {
                this._setStatus('offline');
                return null;
            }
            
            this._setStatus('syncing');
            
            try {
                const [config] = await Promise.all([
                    this.pullConfig()
                ]);

                this._setStatus('synced');

                return {
                    config,
                    _pulledAt: Date.now()
                };
            } catch (err) {
                console.warn('[ConfigSync] pullAll failed:', err.message);
                this._setStatus('error');
                return null;
            }
        },
        
        // --- Push all non-sensitive data to Firebase (initial seed or manual sync) ---
        
        async pushAll({ config }) {
            if (!this.initialized || !this.db) return false;

            this._setStatus('syncing');

            try {
                const promises = [];
                if (config) promises.push(this.pushConfig(config));
                
                await Promise.all(promises);
                this._setStatus('synced');
                console.log('[ConfigSync] Pushed all data to Firebase');
                return true;
            } catch (err) {
                console.warn('[ConfigSync] pushAll failed:', err.message);
                this._setStatus('error');
                return false;
            }
        },
        
        // --- Determine if Firebase data is newer than local ---
        
        isNewer(firebaseData, localTimestamp) {
            if (!firebaseData || !firebaseData._updatedAt) return false;
            return firebaseData._updatedAt > (localTimestamp || 0);
        },
        
        // --- Clear all Command Center data from Firebase ---
        
        async clearAll() {
            if (!this.initialized || !this.db || !this.uid) return false;
            this._setStatus('syncing');
            try {
                await this.db.ref(`${this.BASE_PATH}/${this.uid}`).remove();
                this._setStatus('synced');
                console.log('[ConfigSync] Cleared all Firebase data');
                return true;
            } catch (err) {
                console.warn('[ConfigSync] Failed to clear Firebase data:', err.message);
                this._setStatus('error');
                return false;
            }
        },
        
        // --- Get approximate data size in Firebase ---
        
        async getDataSize() {
            if (!this.initialized || !this.db || !this.uid) return null;
            try {
                const snap = await this.db.ref(`${this.BASE_PATH}/${this.uid}`).once('value');
                const data = snap.val();
                if (!data) return { totalBytes: 0, keys: {} };
                const totalStr = JSON.stringify(data);
                const keys = {};
                for (const key of Object.keys(data)) {
                    keys[key] = JSON.stringify(data[key]).length;
                }
                return { totalBytes: totalStr.length, keys };
            } catch (err) {
                console.warn('[ConfigSync] Failed to get data size:', err.message);
                return null;
            }
        }
    };
    
    // Initialize ConfigSync with the database reference
    FirebaseConfigSync.init(firebaseDb);
    
    // =========================================================================
    // DATA SERVICE LAYER (v8.19.0)
    // Namespaced service objects that encapsulate CRUD for each entity type.
    // Pattern: localStorage (immediate) + Firebase (async, fire-and-forget).
    // These services wrap existing data access patterns into clean APIs.
    // Views continue to use React state for rendering; services handle persistence.
    // =========================================================================
    
    /**
        // v8.70.15: Removed DeployService
    
    // v8.70.14: SessionLogService REMOVED â€” orphaned since v8.63.0 (view removed).
    // App-level sessionLog state had no UI consumer. idea.sessionLog is a separate, active feature.


    /**
     * IssueService â€” Minimal issues interface (full UI in Quality satellite)
     * Retained methods: update, linkToVersion (for deploy flow)
     */
    const IssueService = {
        _ref(uid) {
            if (!firebaseDb || !uid) return null;
            return firebaseDb.ref(`command-center/${uid}/issues`);
        },
        
        listen(uid, callback) {
            const ref = this._ref(uid);
            if (!ref) return () => {};
            const handler = ref.on('value', (snap) => {
                const data = snap.val();
                callback(data ? Object.values(data) : []);
            });
            return () => ref.off('value', handler);
        },
        
        async update(uid, issueId, updates) {
            const ref = this._ref(uid);
            if (!ref) return;
            const snap = await ref.orderByChild('id').equalTo(issueId).once('value');
            const entries = snap.val();
            if (entries) {
                const key = Object.keys(entries)[0];
                await ref.child(key).update(updates);
            }
        },
        
        async linkToVersion(uid, issueIds, version, appId) {
            if (!issueIds || !issueIds.length) return;
            for (const issueId of issueIds) {
                await this.update(uid, issueId, {
                    status: 'fixed',
                    fixedAt: new Date().toISOString(),
                    fixedInVersion: version,
                    fixedInApp: appId
                });
            }
        }
    };
        // v8.70.15: Removed RollbackService
    
    // =========================================================================
    // STORAGE MANAGER â€” Intelligent localStorage cleanup
    // Monitors usage, auto-prunes when approaching quota, provides diagnostics
    // =========================================================================
    
    const StorageManager = {
        // Approximate localStorage limit (5MB for most browsers)
        QUOTA_LIMIT: 5 * 1024 * 1024,
        // Trigger cleanup when usage exceeds this percentage
        CLEANUP_THRESHOLD: 0.80,
        // After cleanup, try to get down to this percentage
        TARGET_AFTER_CLEANUP: 0.60,
        
        // Keys ordered by cleanup priority (first = safe to prune aggressively)
        PRUNABLE_KEYS: [
            // v8.70.14: Removed cc_session_log, cc_deletion_history, cc_rulesHistory (dead slots)
            { key: 'cc_tld_prices', type: 'object', strategy: 'clear', label: 'TLD Price Cache' },
            { key: 'cc_domain_health', type: 'object', strategy: 'clear', label: 'Domain Health Cache' },
        ],
        
        // Keys that should never be pruned
        PROTECTED_KEYS: ['cc_token', 'cc_token_expires', 'cc_apps_v6', 'commandCenterConfig', 'cc_firebase_sa', 'cc_firebase_uid', 'cc_collapsedProjects', 'cc_default_engine', 'cc_projectStates', 'cc_domain_config', 'cc_godaddy_config', 'cc_token_registry', 'cc_api_key', 'cc_anthropic_api_key', 'cc_repo_health_last', 'githubRepoAssignments', 'gs_github_token', 'gs_firebase_sa', 'gs_firebase_uid', 'gs_config', 'gs_api_key', 'gs_token_expires'],

        // v8.70.0: Check if key is protected (exact match OR UID-namespaced secret pattern)
        isProtected(key) {
            if (this.PROTECTED_KEYS.includes(key)) return true;
            // Recognize UID-namespaced secret keys: cc_{base}_{uid}
            const secretPrefixes = ['cc_token_', 'cc_token_expires_', 'cc_anthropic_api_key_', 'cc_firebase_sa_'];
            return secretPrefixes.some(prefix => key.startsWith(prefix));
        },

        // Get current storage usage in bytes
        getUsage() {
            let total = 0;
            const breakdown = {};
            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                const value = localStorage.getItem(key);
                const size = (key.length + value.length) * 2; // UTF-16
                total += size;
                breakdown[key] = size;
            }
            return { total, breakdown, percent: (total / this.QUOTA_LIMIT * 100).toFixed(1) };
        },
        
        // Get human-readable diagnostics
        getDiagnostics() {
            const { total, breakdown, percent } = this.getUsage();
            const sorted = Object.entries(breakdown).sort((a, b) => b[1] - a[1]);
            return {
                totalBytes: total,
                totalFormatted: this._formatBytes(total),
                percent: parseFloat(percent),
                quotaFormatted: this._formatBytes(this.QUOTA_LIMIT),
                entries: sorted.map(([key, size]) => ({
                    key,
                    size,
                    sizeFormatted: this._formatBytes(size),
                    percent: (size / total * 100).toFixed(1),
                    protected: this.isProtected(key)
                }))
            };
        },
        
        // Intelligent cleanup â€” called automatically on QuotaExceededError or manually
        cleanup(aggressive = false) {
            const before = this.getUsage();
            const target = this.QUOTA_LIMIT * (aggressive ? 0.40 : this.TARGET_AFTER_CLEANUP);
            let freed = 0;
            const actions = [];
            
            console.log(`[StorageManager] Cleanup started. Usage: ${this._formatBytes(before.total)} (${before.percent}%)`);
            
            for (const rule of this.PRUNABLE_KEYS) {
                if (before.total - freed <= target) break;
                
                try {
                    const raw = localStorage.getItem(rule.key);
                    if (!raw) continue;
                    const sizeBefore = (rule.key.length + raw.length) * 2;
                    
                    if (rule.strategy === 'clear') {
                        localStorage.removeItem(rule.key);
                        freed += sizeBefore;
                        actions.push({ key: rule.key, action: 'cleared', freed: sizeBefore });
                        continue;
                    }
                    
                    const data = JSON.parse(raw);
                    
                    if (rule.strategy === 'keep-latest' && typeof data === 'object' && !Array.isArray(data)) {
                        // Rollback snapshots: remove entries older than maxAge, keep only most recent per app
                        const now = Date.now();
                        const maxAge = aggressive ? 24 * 60 * 60 * 1000 : rule.maxAge;
                        const pruned = {};
                        for (const [k, v] of Object.entries(data)) {
                            const savedAt = v.savedAt ? new Date(v.savedAt).getTime() : 0;
                            if (now - savedAt < maxAge) {
                                pruned[k] = v;
                            }
                        }
                        // If still too big, strip content from oldest snapshots (keep metadata)
                        if (aggressive) {
                            const entries = Object.entries(pruned).sort((a, b) => 
                                new Date(b[1].savedAt || 0) - new Date(a[1].savedAt || 0));
                            // Keep only the 3 most recent with content
                            entries.slice(3).forEach(([k, v]) => {
                                pruned[k] = { ...v, content: '[pruned]', prunedAt: new Date().toISOString() };
                            });
                        }
                        const newRaw = JSON.stringify(pruned);
                        localStorage.setItem(rule.key, newRaw);
                        const sizeAfter = (rule.key.length + newRaw.length) * 2;
                        freed += sizeBefore - sizeAfter;
                        actions.push({ key: rule.key, action: `pruned ${Object.keys(data).length - Object.keys(pruned).length} snapshots`, freed: sizeBefore - sizeAfter });
                    }
                    
                    if (rule.strategy === 'trim' && Array.isArray(data)) {
                        const keepCount = aggressive ? Math.floor(rule.keepCount / 2) : rule.keepCount;
                        if (data.length > keepCount) {
                            const trimmed = data.slice(0, keepCount);
                            const newRaw = JSON.stringify(trimmed);
                            localStorage.setItem(rule.key, newRaw);
                            const sizeAfter = (rule.key.length + newRaw.length) * 2;
                            freed += sizeBefore - sizeAfter;
                            actions.push({ key: rule.key, action: `trimmed ${data.length} â†’ ${keepCount}`, freed: sizeBefore - sizeAfter });
                        }
                    }
                    
                    if (rule.strategy === 'trim-entries' && typeof data === 'object') {
                        // Session log: trim sessions and recentEntries arrays
                        const keepCount = aggressive ? 5 : rule.keepCount;
                        const pruned = { ...data };
                        if (Array.isArray(pruned.sessions)) pruned.sessions = pruned.sessions.slice(-keepCount);
                        if (Array.isArray(pruned.recentEntries)) pruned.recentEntries = pruned.recentEntries.slice(-keepCount);
                        const newRaw = JSON.stringify(pruned);
                        localStorage.setItem(rule.key, newRaw);
                        const sizeAfter = (rule.key.length + newRaw.length) * 2;
                        freed += sizeBefore - sizeAfter;
                        actions.push({ key: rule.key, action: 'trimmed entries', freed: sizeBefore - sizeAfter });
                    }
                } catch (e) {
                    console.warn(`[StorageManager] Error pruning ${rule.key}:`, e);
                }
            }
            
            // Remove any orphan cc_ keys not in protected or prunable lists
            if (aggressive) {
                const knownKeys = new Set([
                    ...this.PROTECTED_KEYS,
                    ...this.PRUNABLE_KEYS.map(r => r.key)
                ]);
                for (let i = localStorage.length - 1; i >= 0; i--) {
                    const key = localStorage.key(i);
                    if (key?.startsWith('cc_') && !knownKeys.has(key) && !this.isProtected(key)) {
                        const size = (key.length + localStorage.getItem(key).length) * 2;
                        localStorage.removeItem(key);
                        freed += size;
                        actions.push({ key, action: 'removed orphan', freed: size });
                    }
                }
            }
            
            const after = this.getUsage();
            console.log(`[StorageManager] Cleanup complete. Freed: ${this._formatBytes(freed)}. Usage: ${this._formatBytes(after.total)} (${after.percent}%)`);
            
            return { before: before.total, after: after.total, freed, actions };
        },
        
        // Wrap a localStorage.setItem call with auto-cleanup on quota error
        safeSet(key, value) {
            try {
                localStorage.setItem(key, value);
                return true;
            } catch (e) {
                if (e.name === 'QuotaExceededError') {
                    console.warn(`[StorageManager] Quota exceeded on ${key}, running cleanup...`);
                    this.cleanup(false);
                    try {
                        localStorage.setItem(key, value);
                        return true;
                    } catch {
                        console.warn(`[StorageManager] Still full after cleanup, running aggressive cleanup...`);
                        this.cleanup(true);
                        try {
                            localStorage.setItem(key, value);
                            return true;
                        } catch {
                            console.error(`[StorageManager] Cannot save ${key} even after aggressive cleanup`);
                            return false;
                        }
                    }
                }
                throw e;
            }
        },
        
        _formatBytes(bytes) {
            if (bytes < 1024) return bytes + ' B';
            if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + ' KB';
            return (bytes / (1024 * 1024)).toFixed(2) + ' MB';
        },

        // Auto-cleanup on app load â€” runs once per session if usage exceeds threshold
        autoCleanup() {
            try {
                const { total, percent } = this.getUsage();
                const pct = parseFloat(percent);
                if (pct >= this.CLEANUP_THRESHOLD * 100) {
                    console.log(`[StorageManager] Auto-cleanup: usage at ${percent}% (threshold: ${this.CLEANUP_THRESHOLD * 100}%), running cleanup...`);
                    const result = this.cleanup(false);
                    // If still above target after normal cleanup, go aggressive
                    const after = this.getUsage();
                    if (parseFloat(after.percent) >= this.CLEANUP_THRESHOLD * 100) {
                        console.log(`[StorageManager] Still at ${after.percent}% after normal cleanup, running aggressive...`);
                        this.cleanup(true);
                    }
                    return result;
                } else {
                    console.log(`[StorageManager] Storage healthy: ${this._formatBytes(total)} (${percent}%)`);
                }
            } catch (e) {
                console.warn('[StorageManager] Auto-cleanup error:', e.message);
            }
            return null;
        }
    };

    // Run storage auto-cleanup on app load
    StorageManager.autoCleanup();

    // =========================================================================
    // SECRET MANAGER â€” UID-namespaced secret storage (v8.70.0 Multi-User)
    // Wraps localStorage with per-user key namespacing: cc_{base}_{uid}
    // All secrets stay in localStorage (never in Firebase), isolated per user.
    // =========================================================================
    const SecretManager = {
        uid: null,
        BASE_KEYS: ['token', 'token_expires', 'anthropic_api_key', 'firebase_sa'],
        // Mirror map: base key â†’ satellite localStorage key (for cross-app communication)
        MIRROR_MAP: { token: 'gs_github_token', firebase_sa: 'gs_firebase_sa' },

        setUid(uid) {
            this.uid = uid;
            if (uid) console.log(`[SecretManager] UID set: ${uid.slice(0, 8)}...`);
            else console.log('[SecretManager] UID cleared');
        },

        // Build namespaced key: cc_{base}_{uid}
        _key(base) { return this.uid ? `cc_${base}_${this.uid}` : null; },

        get(base) {
            const k = this._key(base);
            if (!k) return null;
            try { return localStorage.getItem(k); } catch { return null; }
        },

        set(base, value) {
            const k = this._key(base);
            if (!k) return;
            try {
                localStorage.setItem(k, value);
                // Mirror to gs_ satellite keys for cross-app communication
                if (this.MIRROR_MAP[base]) localStorage.setItem(this.MIRROR_MAP[base], value);
            } catch {}
        },

        has(base) { return !!this.get(base); },

        remove(base) {
            const k = this._key(base);
            if (!k) return;
            try {
                localStorage.removeItem(k);
                if (this.MIRROR_MAP[base]) localStorage.removeItem(this.MIRROR_MAP[base]);
            } catch {}
        },

        // One-time migration: copy un-namespaced legacy keys to UID-namespaced keys
        // Deletes legacy keys after migration to prevent second-user leak
        migrateFromGlobal() {
            if (!this.uid) return;
            const LEGACY_MAP = {
                token: 'cc_token', token_expires: 'cc_token_expires',
                anthropic_api_key: 'cc_anthropic_api_key', firebase_sa: 'cc_firebase_sa'
            };
            let migrated = 0;
            for (const [base, legacyKey] of Object.entries(LEGACY_MAP)) {
                const namespaced = this._key(base);
                if (!localStorage.getItem(namespaced)) {
                    const val = localStorage.getItem(legacyKey);
                    if (val) {
                        localStorage.setItem(namespaced, val);
                        localStorage.removeItem(legacyKey);
                        migrated++;
                    }
                }
            }
            if (migrated > 0) console.log(`[SecretManager] Migrated ${migrated} legacy secret(s) to UID-namespaced keys`);
        }
    };

    // =========================================================================
    // PHASE 0.2 DATA SERVICES â€” Orchestrator entity services
    // =========================================================================
    
    /**
     * WorkItemService â€” Work item (backlog) CRUD via Firebase
     * Wraps: Firebase RTDB `command-center/{uid}/backlog` path
     * Used by: Future BacklogView, Claude Prep targeting, deploy close-the-loop
     * 
     * Work items are the building blocks of project planning:
     *   id: 'WI-NNN' (auto-generated)
     *   appId: which app this belongs to
     *   title, description: what to build
     *   type: feature | bugfix | enhancement | chore | research
     *   priority: core | nice-to-have | out-of-scope
     *   milestone: prototype | alpha | beta | production
     *   status: idea â†’ ready â†’ in-progress â†’ review â†’ done â†’ deferred
     *   effort: quick | session | multi-session | epic
     *   criteria: acceptance criteria array
     *   context: { filesAffected, sections, dependencies, notes, relatedItems }
     *   tags: string array for filtering
     *   Timestamps: createdAt, startedAt, completedAt, completedInVersion, sessionId
     */
    const WorkItemService = {
        BASE_PATH: 'command-center',
        
        _ref(uid) {
            if (!firebaseDb || !uid) return null;
            return firebaseDb.ref(`${this.BASE_PATH}/${uid}/backlog`);
        },
        
        // Listen for all work items (returns unsubscribe function)
        // v8.71.4: reduced from 200â†’20 to cut Firebase bandwidth costs
        listen(uid, callback, limit = 20) {
            const ref = this._ref(uid);
            if (!ref) return () => {};
            const query = ref.orderByChild('createdAt').limitToLast(limit);

            query.on('value', (snapshot) => {
                const data = snapshot.val();
                if (data) {
                    const list = Object.entries(data).map(([id, item]) => ({ id, ...item }));
                    callback(list.sort((a, b) => new Date(b.createdAt || 0) - new Date(a.createdAt || 0)));
                } else {
                    callback([]);
                }
            });

            return () => query.off();
        },

        // Get a single work item
        async get(uid, itemId) {
            const ref = this._ref(uid);
            if (!ref) return null;
            const snapshot = await ref.child(itemId).once('value');
            const data = snapshot.val();
            return data ? { id: itemId, ...data } : null;
        },
        
        // Create a new work item
        async create(uid, itemData) {
            const ref = this._ref(uid);
            if (!ref) return null;
            
            const item = {
                appId: itemData.appId,
                streamId: itemData.streamId || null,  // Phase 5.3: optional stream assignment
                title: itemData.title,
                description: itemData.description || '',
                type: itemData.type || 'feature',
                priority: itemData.priority || 'core',
                milestone: itemData.milestone || 'beta',
                status: itemData.status || 'idea',
                effort: itemData.effort || 'session',
                criteria: itemData.criteria || [],
                context: {
                    filesAffected: itemData.context?.filesAffected || [],
                    sections: itemData.context?.sections || [],
                    dependencies: itemData.context?.dependencies || [],
                    notes: itemData.context?.notes || '',
                    relatedItems: itemData.context?.relatedItems || []
                },
                tags: itemData.tags || [],
                createdAt: new Date().toISOString(),
                createdBy: itemData.createdBy || 'manual',
                source: itemData.source || 'manual',
                startedAt: null,
                completedAt: null,
                completedInVersion: null,
                sessionId: null
            };
            
            await ref.child(itemData.id).set(item);
            console.log(`[WorkItemService] Created ${itemData.id}: ${item.title}`);
            return { id: itemData.id, ...item };
        },
        
        // Update a work item (partial)
        async update(uid, itemId, updates) {
            const ref = this._ref(uid);
            if (!ref) return;
            await ref.child(itemId).update(updates);
        },
        
        // Transition status with timestamps
        async updateStatus(uid, itemId, newStatus, extraData = {}) {
            const now = new Date().toISOString();
            const updates = { status: newStatus, ...extraData };
            
            // Auto-set timestamps on status transitions
            switch (newStatus) {
                case 'in-progress':
                    updates.startedAt = now;
                    break;
                case 'review':
                    updates.reviewStartedAt = now;
                    break;
                case 'done':
                    updates.completedAt = now;
                    break;
                case 'deferred':
                    updates.deferredAt = now;
                    break;
            }
            
            await this.update(uid, itemId, updates);
            console.log(`[WorkItemService] ${itemId} â†’ ${newStatus}`);
        },
        
        // Complete a work item (from deploy close-the-loop)
        async complete(uid, itemId, version) {
            await this.updateStatus(uid, itemId, 'done', {
                completedInVersion: version
            });
        },
        
        // Check if item has criteria (used for auto-transition suggestions)
        hasCriteria(item) {
            return item?.criteria && item.criteria.length > 0 && item.criteria.some(c => c.trim());
        },
        
        // Check if item is stale (in-progress or review for 7+ days)
        isStale(item) {
            if (item.status !== 'in-progress' && item.status !== 'review') return false;
            const startDate = item.status === 'review' ? item.reviewStartedAt : item.startedAt;
            if (!startDate) return false;
            return (Date.now() - new Date(startDate).getTime()) > 7 * 24 * 60 * 60 * 1000;
        },
        
        // Get stale days count
        getStaleDays(item) {
            const startDate = item.status === 'review' ? item.reviewStartedAt : item.startedAt;
            if (!startDate) return 0;
            return Math.floor((Date.now() - new Date(startDate).getTime()) / (24 * 60 * 60 * 1000));
        },
        
        // Get work items filtered by app
        filterByApp(items, appId) {
            return items.filter(i => i.appId === appId);
        },
        
        // Get work items filtered by stream (Phase 5.3)
        filterByStream(items, streamId) {
            return items.filter(i => i.streamId === streamId);
        },
        
        // Get unassigned work items (no stream) for an app
        getUnassigned(items, appId) {
            return items.filter(i => (!i.streamId) && (!appId || i.appId === appId));
        },
        
        // Get work items filtered by milestone
        filterByMilestone(items, milestone) {
            return items.filter(i => i.milestone === milestone);
        },
        
        // Get work items filtered by status
        filterByStatus(items, status) {
            return items.filter(i => i.status === status);
        },
        
        // Get in-progress items (for deploy close-the-loop)
        getInProgress(items, appId) {
            return items.filter(i => i.status === 'in-progress' && (!appId || i.appId === appId));
        },
        
        // Get items in review (for post-deploy completion)
        getInReview(items, appId) {
            return items.filter(i => i.status === 'review' && (!appId || i.appId === appId));
        },
        
        // Batch create work items (for scoping flow)
        async createBatch(uid, itemsData) {
            const ref = this._ref(uid);
            if (!ref) return [];
            
            const results = [];
            const updates = {};
            for (const itemData of itemsData) {
                const item = {
                    appId: itemData.appId,
                    streamId: itemData.streamId || null,  // Phase 5.3
                    title: itemData.title,
                    description: itemData.description || '',
                    type: itemData.type || 'feature',
                    priority: itemData.priority || 'core',
                    milestone: itemData.milestone || 'beta',
                    status: itemData.status || 'idea',
                    effort: itemData.effort || 'session',
                    criteria: itemData.criteria || [],
                    context: {
                        filesAffected: itemData.context?.filesAffected || [],
                        sections: itemData.context?.sections || [],
                        dependencies: itemData.context?.dependencies || [],
                        notes: itemData.context?.notes || '',
                        relatedItems: itemData.context?.relatedItems || []
                    },
                    tags: itemData.tags || [],
                    createdAt: new Date().toISOString(),
                    createdBy: itemData.createdBy || 'manual',
                    source: itemData.source || 'manual',
                    startedAt: null,
                    completedAt: null,
                    completedInVersion: null,
                    sessionId: null
                };
                updates[itemData.id] = item;
                results.push({ id: itemData.id, ...item });
            }
            await ref.update(updates);
            console.log(`[WorkItemService] Batch created ${results.length} items`);
            return results;
        },
        
        // Delete a work item
        async delete(uid, itemId) {
            const ref = this._ref(uid);
            if (!ref) return;
            await ref.child(itemId).remove();
            console.log(`[WorkItemService] Deleted ${itemId}`);
        },
        
        // Generate next work item ID from existing list
        getNextId(currentItems) {
            const existing = currentItems.map(i => parseInt(i.id?.replace('WI-', '') || '0'));
            const max = Math.max(0, ...existing);
            return `WI-${String(max + 1).padStart(3, '0')}`;
        }
    };
    
    /**
     * SessionService â€” Claude session tracking via Firebase
     * Wraps: Firebase RTDB `command-center/{uid}/sessions` path
     * Used by: Claude Prep (create on package generation), deploy (link session to deploy)
     * 
     * A session represents one AI interaction cycle: prep â†’ build â†’ handoff â†’ deploy
     *   id: auto-generated timestamp-based
     *   appId: which app the session is for
     *   type: build | design | fix | test | research | review | polish | document
     *   workItemId: optional linked work item
     *   engineId: which AI engine was targeted
     *   status: prep | active | completed | abandoned
     *   packageTokens: estimated token count of the generated package
     *   deployId: linked deploy record (set after deploy)
     *   Timestamps: createdAt, completedAt
     */
    const SessionService = {
        BASE_PATH: 'command-center',
        
        _ref(uid) {
            if (!firebaseDb || !uid) return null;
            return firebaseDb.ref(`${this.BASE_PATH}/${uid}/sessions`);
        },
        
        // v8.71.4: reduced from 100â†’15 to cut Firebase bandwidth (was ~300KB per trigger, now ~45KB)
        listen(uid, callback, limit = 15) {
            const ref = this._ref(uid);
            if (!ref) return () => {};
            const query = ref.orderByChild('createdAt').limitToLast(limit);

            query.on('value', (snapshot) => {
                const data = snapshot.val();
                if (data) {
                    const list = Object.entries(data).map(([id, s]) => ({ id, ...s }));
                    callback(list.sort((a, b) => new Date(b.createdAt || 0) - new Date(a.createdAt || 0)));
                } else {
                    callback([]);
                }
            });

            return () => query.off();
        },

        // Create a session record (called when Claude Prep generates a package)
        async create(uid, sessionData) {
            const ref = this._ref(uid);
            if (!ref) return null;
            
            const sessionId = `sess-${Date.now()}`;
            const session = {
                appId: sessionData.appId,
                type: sessionData.type || 'build',
                workItemId: sessionData.workItemId || null,
                engineId: sessionData.engineId || 'claude-sonnet-4.5',
                status: 'prep',
                packageTokens: sessionData.packageTokens || 0,
                packageFiles: sessionData.packageFiles || [],
                deployId: null,
                notes: sessionData.notes || '',
                // Phase 3: Review tracking
                review: null,       // { criteriaResults: [{id, text, met: bool}], reviewedBy, reviewedAt, notes }
                deliverables: null,  // { files: [string], importedAt, summary }
                createdAt: new Date().toISOString(),
                completedAt: null
            };
            
            await ref.child(sessionId).set(session);
            console.log(`[SessionService] Created ${sessionId} for ${session.appId} (${session.type})`);
            return { id: sessionId, ...session };
        },
        
        // Update a session
        async update(uid, sessionId, updates) {
            const ref = this._ref(uid);
            if (!ref) return;
            await ref.child(sessionId).update(updates);
        },
        
        // Link a deploy to a session
        async linkDeploy(uid, sessionId, deployId) {
            await this.update(uid, sessionId, {
                deployId,
                status: 'completed',
                completedAt: new Date().toISOString()
            });
            console.log(`[SessionService] Linked deploy ${deployId} to session ${sessionId}`);
        },
        
        // Phase 3: Start review â€” session moves from prep to review
        async startReview(uid, sessionId, deliverables) {
            await this.update(uid, sessionId, {
                status: 'review',
                deliverables: {
                    files: deliverables.files || [],
                    importedAt: new Date().toISOString(),
                    summary: deliverables.summary || ''
                }
            });
            console.log(`[SessionService] ${sessionId} â†’ review (${deliverables.files?.length || 0} files)`);
        },
        
        // Phase 3: Complete review with criteria results
        async completeReview(uid, sessionId, reviewData) {
            await this.update(uid, sessionId, {
                review: {
                    criteriaResults: reviewData.criteriaResults || [],
                    reviewedBy: reviewData.reviewedBy || 'Owner',
                    reviewedAt: new Date().toISOString(),
                    notes: reviewData.notes || '',
                    allMet: (reviewData.criteriaResults || []).every(c => c.met)
                }
            });
            console.log(`[SessionService] ${sessionId} review complete`);
        },
        
        // Get recent sessions for an app
        getForApp(sessions, appId, limit = 5) {
            return sessions
                .filter(s => s.appId === appId)
                .slice(0, limit);
        },
        
        // Get active (non-completed) sessions
        getActive(sessions, appId) {
            return sessions.filter(s => 
                s.status !== 'completed' && s.status !== 'abandoned' &&
                (!appId || s.appId === appId)
            );
        }
    };

    /**
     * JobService â€” Read-only listener for MCP-managed jobs (Phase 2, v8.70.18)
     * Wraps: Firebase RTDB `command-center/{uid}/jobs` path
     * Jobs are created/updated exclusively via MCP. CC only visualizes them.
     */
    const JobService = {
        BASE_PATH: 'command-center',

        _ref(uid) {
            if (!firebaseDb || !uid) return null;
            return firebaseDb.ref(`${this.BASE_PATH}/${uid}/jobs`);
        },

        // v8.71.4: reduced from 200â†’10 â€” jobs carry heavy payloads (instructions, attachments, events)
        // Each trigger at 200 was re-downloading ~20MB. At 10, it's ~1MB.
        listen(uid, callback, limit = 10) {
            const ref = this._ref(uid);
            if (!ref) return () => {};
            const query = ref.orderByChild('createdAt').limitToLast(limit);

            query.on('value', (snapshot) => {
                const data = snapshot.val();
                if (data) {
                    const list = Object.entries(data).map(([id, j]) => ({ id, ...j }));
                    callback(list.sort((a, b) => new Date(b.createdAt || 0) - new Date(a.createdAt || 0)));
                } else {
                    callback([]);
                }
            });

            return () => query.off();
        },

        // v8.71.4: On-demand fetch of older jobs (for "Load More" in JobsView)
        async loadBefore(uid, oldestCreatedAt, limit = 10) {
            const ref = this._ref(uid);
            if (!ref) return [];
            const snapshot = await ref
                .orderByChild('createdAt')
                .endAt(oldestCreatedAt)
                .limitToLast(limit + 1)
                .once('value');
            const data = snapshot.val();
            if (!data) return [];
            return Object.entries(data)
                .map(([id, j]) => ({ id, ...j }))
                .filter(j => j.createdAt < oldestCreatedAt)
                .sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
        }
    };

    /**
     * ActivityLogService â€” Audit trail for all meaningful actions (Phase 3.4)
     * Wraps: Firebase RTDB `command-center/{uid}/activity` path
     * 
     * Every meaningful action (deploy, session create/complete, work item transitions,
     * scoping, reviews) writes an event. For solo use: audit trail.
     * For Phase 5 multi-person: the activity feed everyone sees.
     */
    const ActivityLogService = {
        BASE_PATH: 'command-center',
        MAX_EVENTS: 500,
        
        _ref(uid) {
            if (!firebaseDb || !uid) return null;
            return firebaseDb.ref(`${this.BASE_PATH}/${uid}/activity`);
        },
        
        // Listen for activity events (returns unsubscribe function)
        listen(uid, callback, limit = 100) {
            const ref = this._ref(uid);
            if (!ref) return () => {};
            
            ref.orderByChild('timestamp').limitToLast(limit).on('value', (snapshot) => {
                const data = snapshot.val();
                if (data) {
                    const list = Object.entries(data).map(([id, evt]) => ({ id, ...evt }));
                    callback(list.sort((a, b) => new Date(b.timestamp || 0) - new Date(a.timestamp || 0)));
                } else {
                    callback([]);
                }
            });
            
            return () => ref.off();
        },
        
        // Log an activity event
        async log(uid, event) {
            const ref = this._ref(uid);
            if (!ref) return null;
            
            const eventId = `evt-${Date.now()}-${Math.random().toString(36).slice(2, 6)}`;
            const entry = {
                appId: event.appId || null,
                streamId: event.streamId || null,
                actor: event.actor || 'Owner',
                action: event.action,          // deploy, session_create, session_complete, item_transition, scope, review
                summary: event.summary,        // Human-readable: "Dave deployed Core Gameplay v0.9"
                metadata: event.metadata || {},
                timestamp: new Date().toISOString()
            };
            
            await ref.child(eventId).set(entry);
            return { id: eventId, ...entry };
        },
        
        // Convenience loggers for common actions
        async logDeploy(uid, actor, appName, version, env, sessionId) {
            return this.log(uid, {
                appId: appName,
                actor,
                action: 'deploy',
                summary: `${actor} deployed ${appName} v${version} to ${env}`,
                metadata: { version, environment: env, sessionId }
            });
        },
        
        async logSessionCreate(uid, actor, appName, sessionType, sessionId) {
            return this.log(uid, {
                appId: appName,
                actor,
                action: 'session_create',
                summary: `${actor} started ${sessionType} session for ${appName}`,
                metadata: { sessionType, sessionId }
            });
        },
        
        async logSessionComplete(uid, actor, appName, sessionId, itemsCompleted) {
            return this.log(uid, {
                appId: appName,
                actor,
                action: 'session_complete',
                summary: `${actor} completed session for ${appName} â€” ${itemsCompleted} item${itemsCompleted !== 1 ? 's' : ''} done`,
                metadata: { sessionId, itemsCompleted }
            });
        },
        
        async logItemTransition(uid, actor, appName, itemId, itemTitle, fromStatus, toStatus) {
            return this.log(uid, {
                appId: appName,
                actor,
                action: 'item_transition',
                summary: `${actor} moved "${itemTitle}" from ${fromStatus} to ${toStatus}`,
                metadata: { itemId, fromStatus, toStatus }
            });
        },
        
        async logReview(uid, actor, appName, sessionId, criteriaMetCount, criteriaTotalCount) {
            return this.log(uid, {
                appId: appName,
                actor,
                action: 'review',
                summary: `${actor} reviewed ${appName} â€” ${criteriaMetCount}/${criteriaTotalCount} criteria met`,
                metadata: { sessionId, criteriaMetCount, criteriaTotalCount }
            });
        }
    };
    
    /**
     * WorkStreamService â€” Minimal stub (full implementation in Analytics satellite)
     */
    const WorkStreamService = {
        BASE_PATH: 'command-center',
        _ref(uid) { if (!firebaseDb || !uid) return null; return firebaseDb.ref(`${this.BASE_PATH}/${uid}/streams`); },
        listen(uid, callback) {
            const ref = this._ref(uid);
            if (!ref) return () => {};
            ref.on('value', (snapshot) => {
                const data = snapshot.val();
                if (data) {
                    const list = Object.entries(data).map(([id, s]) => ({
                        id, ...s,
                        // Migrate: ensure extended fields exist
                        appIds: s.appIds || (s.appId ? [s.appId] : []),
                        concepts: s.concepts || [],
                        openItems: s.openItems || [],
                        next: s.next || ''
                    }));
                    callback(list.sort((a, b) => (a.order || 0) - (b.order || 0)));
                } else { callback([]); }
            });
            return () => ref.off();
        },
        async update(uid, streamId, updates) {
            const ref = this._ref(uid);
            if (!ref) return;
            await ref.child(streamId).update(updates);
            console.log(`[WorkStreamService] Updated ${streamId} (${Object.keys(updates).join(', ')})`);
        },
        filterByApp(streams, appId) { return (streams || []).filter(s => s.appId === appId || (s.appIds && s.appIds.includes(appId))); }
    };
    
    // v8.71.0: StreamInterfaceService, DependencyService, DependencyAlertService removed (satellites eliminated â€” Phase 4)
    // Retained: IssueService (linkToVersion), WorkStreamService (update), ActivityLogService (logDeploy), WorkItemService (create)

    /**
     * TeamService â€” Multi-person access management (Phase 5.7)
     * Wraps: Firebase RTDB `command-center/{uid}/team` path
     * 
     * Enables shared workspace access. The owner's UID remains the canonical
     * data path â€” team members read/write to the owner's path with role-based
     * permissions enforced in UI (Firebase rules lock down in production).
     * 
     * Roles:
     *   owner â€” full access, can manage team members
     *   editor â€” can create/edit work items, sessions, deploys, streams
     *   viewer â€” read-only access to all data
     * 
     * Data model:
     *   command-center/{ownerUid}/team/{memberUid} = { email, name, photoURL, role, invitedAt, joinedAt }
     *   command-center/{memberUid}/teamMembership = { ownerUid, role, workspaceName }
     */
    const TeamService = {
        BASE_PATH: 'command-center',
        
        _teamRef(uid) {
            if (!firebaseDb || !uid) return null;
            return firebaseDb.ref(`${this.BASE_PATH}/${uid}/team`);
        },
        
        _membershipRef(uid) {
            if (!firebaseDb || !uid) return null;
            return firebaseDb.ref(`${this.BASE_PATH}/${uid}/teamMembership`);
        },
        
        // Listen for team members (owner's perspective)
        listen(uid, callback) {
            const ref = this._teamRef(uid);
            if (!ref) return () => {};
            
            ref.on('value', (snapshot) => {
                const data = snapshot.val();
                if (data) {
                    const list = Object.entries(data).map(([memberId, member]) => ({ uid: memberId, ...member }));
                    callback(list.sort((a, b) => (a.name || a.email || '').localeCompare(b.name || b.email || '')));
                } else {
                    callback([]);
                }
            });
            
            return () => ref.off();
        },
        
        // Listen for workspaces this user belongs to (member's perspective)
        listenMemberships(uid, callback) {
            const ref = this._membershipRef(uid);
            if (!ref) return () => {};
            
            ref.on('value', (snapshot) => {
                const data = snapshot.val();
                callback(data || null);
            });
            
            return () => ref.off();
        },
        
        // Invite a team member (by email)
        async invite(ownerUid, email, role = 'editor', invitedBy = 'Owner') {
            const ref = this._teamRef(ownerUid);
            if (!ref) return null;
            
            const tempKey = `pending-${btoa(email).replace(/[^a-zA-Z0-9]/g, '').slice(0, 20)}`;
            
            const member = {
                email: email.toLowerCase().trim(),
                name: null,
                photoURL: null,
                role: role,
                status: 'invited',
                invitedAt: new Date().toISOString(),
                invitedBy: invitedBy,
                joinedAt: null
            };
            
            await ref.child(tempKey).set(member);
            console.log(`[TeamService] Invited ${email} as ${role}`);
            return { uid: tempKey, ...member };
        },
        
        // Accept invite â€” called when invited user signs in
        async acceptInvite(ownerUid, memberUid, memberProfile) {
            const ref = this._teamRef(ownerUid);
            if (!ref) return;
            
            const snap = await ref.once('value');
            const team = snap.val() || {};
            const pendingKey = Object.keys(team).find(k => 
                k.startsWith('pending-') && team[k].email === memberProfile.email?.toLowerCase()
            );
            
            if (!pendingKey) {
                console.warn(`[TeamService] No pending invite for ${memberProfile.email}`);
                return null;
            }
            
            const invite = team[pendingKey];
            
            await ref.child(pendingKey).remove();
            await ref.child(memberUid).set({
                email: memberProfile.email,
                name: memberProfile.displayName || memberProfile.email.split('@')[0],
                photoURL: memberProfile.photoURL || null,
                role: invite.role,
                status: 'active',
                invitedAt: invite.invitedAt,
                invitedBy: invite.invitedBy,
                joinedAt: new Date().toISOString()
            });
            
            // Write membership pointer on the member's node
            await this._membershipRef(memberUid)?.set({
                ownerUid: ownerUid,
                role: invite.role,
                workspaceName: 'Command Center'
            });
            
            console.log(`[TeamService] ${memberProfile.email} joined as ${invite.role}`);
            return { uid: memberUid, role: invite.role };
        },
        
        // Update member role
        async updateRole(ownerUid, memberUid, newRole) {
            const ref = this._teamRef(ownerUid);
            if (!ref) return;
            await ref.child(memberUid).update({ role: newRole });
            await this._membershipRef(memberUid)?.update({ role: newRole });
        },
        
        // Remove team member
        async remove(ownerUid, memberUid) {
            const ref = this._teamRef(ownerUid);
            if (!ref) return;
            await ref.child(memberUid).remove();
            await this._membershipRef(memberUid)?.remove();
        },
        
        // Get the effective workspace UID (owner's UID if member, own UID if owner)
        getWorkspaceUid(currentUid, membership) {
            if (membership?.ownerUid) return membership.ownerUid;
            return currentUid;
        },
        
        canEdit(membership) {
            if (!membership) return true; // Owner
            return membership.role === 'owner' || membership.role === 'editor';
        },
        
        canManageTeam(membership) {
            if (!membership) return true; // Owner
            return membership.role === 'owner';
        },
        
        // Generate Firebase security rules template
        generateRulesTemplate(ownerUid) {
            return JSON.stringify({
                rules: {
                    "command-center": {
                        [ownerUid]: {
                            ".read": `auth.uid === '${ownerUid}' || root.child('command-center/${ownerUid}/team/' + auth.uid).exists()`,
                            ".write": `auth.uid === '${ownerUid}' || (root.child('command-center/${ownerUid}/team/' + auth.uid).exists() && root.child('command-center/${ownerUid}/team/' + auth.uid + '/role').val() !== 'viewer')`,
                            "team": { ".write": `auth.uid === '${ownerUid}'` }
                        },
                        "$uid": {
                            "teamMembership": {
                                ".read": "auth.uid === $uid",
                                ".write": "auth != null"
                            }
                        }
                    }
                }
            }, null, 2);
        }
    };
    
    /**
     * TokenRegistryService â€” Token estimation and caching
     * Provides heuristic token counting for context budget management.
     * Cache stored in localStorage for instant access during Claude Prep.
     * 
     * Three estimation tiers:
     *   Tier 1: Heuristic (instant, browser-only) â€” used by default
     *   Tier 2: js-tiktoken (accurate for GPT) â€” future
     *   Tier 3: Anthropic API countTokens (exact for Claude) â€” future
     */
    const TokenRegistryService = {
        STORAGE_KEY: 'cc_token_registry',
        
        // Content type ratios (tokens per character) based on empirical data
        RATIOS: {
            code:     0.37,   // ~18 tokens per line, ~49 chars/line (JS/HTML/CSS)
            markdown: 0.35,   // ~1.35 tokens per word, ~3.8 chars/word
            prose:    0.33,   // ~1.3 tokens per word, ~4 chars/word
            json:     0.40,   // Higher due to structural characters
        },
        
        // Detect content type from filename or content
        detectContentType(filename) {
            if (!filename) return 'prose';
            const ext = filename.split('.').pop()?.toLowerCase();
            switch (ext) {
                case 'html': case 'htm': case 'js': case 'jsx': case 'ts':
                case 'tsx': case 'css': case 'scss': case 'py': case 'rb':
                case 'java': case 'c': case 'cpp': case 'go': case 'rs':
                case 'php': case 'sh': case 'bash': case 'yaml': case 'yml':
                case 'xml': case 'svg':
                    return 'code';
                case 'md': case 'mdx': case 'txt':
                    return 'markdown';
                case 'json': case 'jsonl':
                    return 'json';
                default:
                    return 'prose';
            }
        },
        
        // Tier 1: Heuristic token estimation (instant, no dependencies)
        estimateTokens(text, filenameOrType) {
            if (!text) return 0;
            const contentType = this.RATIOS[filenameOrType] 
                ? filenameOrType 
                : this.detectContentType(filenameOrType);
            const ratio = this.RATIOS[contentType] || 0.35;
            return Math.ceil(text.length * ratio);
        },
        
        // Estimate tokens from byte count (when text isn't available)
        estimateFromBytes(bytes, filenameOrType) {
            if (!bytes) return 0;
            const contentType = this.RATIOS[filenameOrType]
                ? filenameOrType
                : this.detectContentType(filenameOrType);
            const ratio = this.RATIOS[contentType] || 0.35;
            return Math.ceil(bytes * ratio);
        },
        
        // Load cached registry from localStorage
        load() {
            try {
                return JSON.parse(localStorage.getItem(this.STORAGE_KEY) || '{}');
            } catch { return {}; }
        },
        
        // Save registry to localStorage
        save(registry) {
            try {
                localStorage.setItem(this.STORAGE_KEY, JSON.stringify(registry));
            } catch (e) {
                console.error('[TokenRegistryService] Save failed:', e);
            }
        },
        
        // Cache a token count for a specific app artifact
        cacheArtifact(appId, path, tokenData) {
            const registry = this.load();
            if (!registry[appId]) registry[appId] = { artifacts: {}, lastScanned: null };
            registry[appId].artifacts[path] = {
                path,
                tokens: tokenData.tokens,
                bytes: tokenData.bytes,
                type: tokenData.type || 'source',
                version: tokenData.version || null,
                lastUpdated: new Date().toISOString()
            };
            registry[appId].lastScanned = new Date().toISOString();
            this.save(registry);
        },
        
        // Get cached data for an app
        getForApp(appId) {
            const registry = this.load();
            return registry[appId] || null;
        },
        
        // Calculate totals from a list of token counts
        calculateTotals(artifacts) {
            const totals = { source: 0, documentation: 0, instructions: 0, total: 0 };
            for (const art of Object.values(artifacts)) {
                const tokens = art.tokens?.estimated || art.tokens || 0;
                const type = art.type || 'source';
                if (totals[type] !== undefined) {
                    totals[type] += tokens;
                }
                totals.total += tokens;
            }
            return totals;
        },
        
        // Format token count for display
        formatTokens(count) {
            if (count >= 1000000) return `${(count / 1000000).toFixed(1)}M`;
            if (count >= 1000) return `${(count / 1000).toFixed(1)}K`;
            return String(count);
        }
    };
    
    /**
     * EngineRegistryService â€” AI engine profiles and recommendations
     * Static reference data for AI model capabilities, costs, and constraints.
     * User preferences (default engine) stored in localStorage.
     * 
     * Engine profiles inform:
     *   - Context budget calculation in Claude Prep
     *   - Engine recommendation per session type
     *   - Cost estimation per session
     *   - Platform feature awareness (Projects, Skills, Artifacts, etc.)
     */
    const EngineRegistryService = {
        PREF_KEY: 'cc_default_engine',
        
        // Static engine definitions
        ENGINES: {
            'claude-sonnet-4.5': {
                id: 'claude-sonnet-4.5',
                provider: 'anthropic',
                name: 'Claude Sonnet 4.5',
                tier: 'balanced',
                contextWindow: 200000,
                contextWindowExtended: 1000000,
                maxOutput: 64000,
                cost: {
                    input: 3.00,
                    output: 15.00,
                    cacheWrite: 3.75,
                    cacheRead: 0.30,
                    longContextInput: 6.00,
                    longContextOutput: 22.50
                },
                strengths: ['Coding and refactoring', 'Agentic workflows', 'Multi-step reasoning', 'Extended thinking'],
                bestFor: ['coding', 'architecture', 'testing', 'complex-features'],
                notes: 'Default recommendation for most sessions. Best coding model per benchmarks.',
                features: { projects: true, skills: true, artifacts: true, extendedThinking: true, computerUse: true, webSearch: true, memory: true }
            },
            'claude-haiku-4.5': {
                id: 'claude-haiku-4.5',
                provider: 'anthropic',
                name: 'Claude Haiku 4.5',
                tier: 'fast',
                contextWindow: 200000,
                maxOutput: 64000,
                cost: { input: 1.00, output: 5.00, cacheWrite: 1.25, cacheRead: 0.10 },
                strengths: ['Speed', 'Cost efficiency', 'Classification'],
                bestFor: ['quick-fixes', 'text-changes', 'chores', 'research'],
                notes: 'Use for simple bug fixes, text updates, research tasks. 3x cheaper than Sonnet.',
                features: { projects: true, skills: true, artifacts: true, extendedThinking: true, computerUse: true, webSearch: true, memory: true }
            },
            'claude-opus-4.5': {
                id: 'claude-opus-4.5',
                provider: 'anthropic',
                name: 'Claude Opus 4.5',
                tier: 'flagship',
                contextWindow: 200000,
                contextWindowExtended: 1000000,
                maxOutput: 64000,
                cost: { input: 5.00, output: 25.00, cacheWrite: 6.25, cacheRead: 0.50 },
                strengths: ['Most intelligent', 'Complex architecture', 'Novel problem solving'],
                bestFor: ['design', 'architecture', 'complex-debugging', 'research'],
                notes: 'Reserve for high-complexity work: architecture design, novel patterns, difficult debugging.',
                features: { projects: true, skills: true, artifacts: true, extendedThinking: true, computerUse: true, webSearch: true, memory: true }
            },
            'gpt-4.1': {
                id: 'gpt-4.1',
                provider: 'openai',
                name: 'GPT-4.1',
                tier: 'balanced',
                contextWindow: 1000000,
                maxOutput: 32768,
                cost: { input: 2.00, output: 8.00 },
                strengths: ['Large context native', 'Good at instruction following'],
                bestFor: ['large-codebase-review', 'migration'],
                notes: 'Useful when full source must be in context. Cheaper per token but lower coding quality than Sonnet.',
                features: { projects: false, skills: false, artifacts: false }
            },
            'gemini-2.5-pro': {
                id: 'gemini-2.5-pro',
                provider: 'google',
                name: 'Gemini 2.5 Pro',
                tier: 'balanced',
                contextWindow: 2000000,
                maxOutput: 65536,
                cost: { input: 1.25, output: 10.00 },
                strengths: ['Largest context window', 'Multimodal', 'Competitive coding'],
                bestFor: ['full-codebase-analysis', 'design-review', 'documentation'],
                notes: '2M tokens means entire CC codebase fits in one session. Good for architectural review.',
                features: { projects: false, skills: false, artifacts: false }
            }
        },
        
        // Session type â†’ recommended engine mapping
        SESSION_TYPE_ENGINES: {
            'build':    'claude-sonnet-4.5',
            'design':   'claude-opus-4.5',
            'fix':      'claude-sonnet-4.5',
            'test':     'claude-sonnet-4.5',
            'research': 'claude-haiku-4.5',
            'review':   'claude-sonnet-4.5',
            'polish':   'claude-haiku-4.5',
            'document': 'claude-haiku-4.5'
        },
        
        // Work item type â†’ suggested session type
        WORK_ITEM_SESSION_MAP: {
            'feature':     'build',
            'bugfix':      'fix',
            'enhancement': 'build',
            'chore':       'build',
            'research':    'research'
        },
        
        // Get all engines
        getAll() {
            return Object.values(this.ENGINES);
        },
        
        // Get a specific engine
        get(engineId) {
            return this.ENGINES[engineId] || null;
        },
        
        // Get user's default engine
        getDefault() {
            const pref = localStorage.getItem(this.PREF_KEY);
            return pref && this.ENGINES[pref] ? pref : 'claude-sonnet-4.5';
        },
        
        // Set user's default engine
        setDefault(engineId) {
            if (this.ENGINES[engineId]) {
                localStorage.setItem(this.PREF_KEY, engineId);
            }
        },
        
        // Recommend engine for a session type
        recommendForSessionType(sessionType) {
            const engineId = this.SESSION_TYPE_ENGINES[sessionType] || 'claude-sonnet-4.5';
            return this.ENGINES[engineId];
        },
        
        // Recommend engine based on work item
        recommendForWorkItem(workItem) {
            const sessionType = this.WORK_ITEM_SESSION_MAP[workItem.type] || 'build';
            return {
                sessionType,
                engine: this.recommendForSessionType(sessionType)
            };
        },
        
        // Check if a package fits within an engine's context window
        checkBudget(tokenCount, engineId, useExtended = false) {
            const engine = this.get(engineId || this.getDefault());
            if (!engine) return { fits: false, engine: null };
            
            const limit = useExtended && engine.contextWindowExtended 
                ? engine.contextWindowExtended 
                : engine.contextWindow;
            
            // Reserve ~20% for conversation/reasoning room
            const usableLimit = Math.floor(limit * 0.80);
            
            return {
                fits: tokenCount <= usableLimit,
                engine,
                limit,
                usableLimit,
                tokenCount,
                remaining: usableLimit - tokenCount,
                percentUsed: Math.round((tokenCount / usableLimit) * 100),
                overBy: tokenCount > usableLimit ? tokenCount - usableLimit : 0,
                recommendations: this._getBudgetRecommendations(tokenCount, engine, useExtended)
            };
        },
        
        // Generate context budget recommendations
        _getBudgetRecommendations(tokenCount, engine, useExtended) {
            const recs = [];
            const limit = useExtended && engine.contextWindowExtended
                ? engine.contextWindowExtended
                : engine.contextWindow;
            const usableLimit = Math.floor(limit * 0.80);
            
            if (tokenCount <= usableLimit) return recs;
            
            // Over budget â€” generate recommendations
            if (!useExtended && engine.contextWindowExtended) {
                recs.push({
                    action: 'extended-context',
                    label: `Switch to ${TokenRegistryService.formatTokens(engine.contextWindowExtended)} extended context`,
                    savings: null,
                    cost: engine.cost.longContextInput ? `$${engine.cost.longContextInput}/$${engine.cost.longContextOutput} per MTok` : null
                });
            }
            
            recs.push({
                action: 'architecture-summary',
                label: 'Use architecture summary instead of full source',
                savings: `~${TokenRegistryService.formatTokens(Math.floor(tokenCount * 0.85))} saved`,
                cost: null
            });
            
            recs.push({
                action: 'section-extraction',
                label: 'Include only relevant code sections for this work item',
                savings: `~${TokenRegistryService.formatTokens(Math.floor(tokenCount * 0.90))} saved`,
                cost: null
            });
            
            recs.push({
                action: 'skip-changelog',
                label: 'Skip CHANGELOG.md (low value for build sessions)',
                savings: null,
                cost: null
            });
            
            // Suggest a different engine if this one can't handle it
            const biggerEngines = Object.values(this.ENGINES).filter(e => 
                e.id !== engine.id && 
                (e.contextWindow > limit || (e.contextWindowExtended && e.contextWindowExtended > limit))
            );
            if (biggerEngines.length > 0) {
                const best = biggerEngines.sort((a, b) => 
                    (b.contextWindowExtended || b.contextWindow) - (a.contextWindowExtended || a.contextWindow)
                )[0];
                recs.push({
                    action: 'switch-engine',
                    label: `Switch to ${best.name} (${TokenRegistryService.formatTokens(best.contextWindowExtended || best.contextWindow)} context)`,
                    savings: null,
                    cost: `$${best.cost.input}/$${best.cost.output} per MTok`
                });
            }
            
            return recs;
        },
        
        // Estimate session cost
        estimateSessionCost(packageTokens, outputTokens, engineId) {
            const engine = this.get(engineId || this.getDefault());
            if (!engine) return null;
            
            const inputCost = (packageTokens / 1000000) * engine.cost.input;
            const outputCost = (outputTokens / 1000000) * engine.cost.output;
            
            return {
                inputCost: Math.round(inputCost * 100) / 100,
                outputCost: Math.round(outputCost * 100) / 100,
                totalCost: Math.round((inputCost + outputCost) * 100) / 100,
                engine: engine.name
            };
        }
    };

    // =========================================================================
    // CLAUDE API SERVICE (v8.59.0 â€” Ingestion Pipeline Phase 2)
    // =========================================================================

        // v8.70.15: Removed ClaudeAPIService

    // =========================================================================
    // ODRC SUMMARY GENERATOR (v8.59.0)
    // =========================================================================

    const ODRCSummaryGenerator = {
        _renderGroup(type, concepts, ideas) {
            const items = concepts.filter(c => c.type === type && c.status === 'active');
            if (items.length === 0) return '';
            const lines = [`## ${type}s`];
            items.forEach(c => {
                const ideaName = ideas.find(i => i.id === c.ideaOrigin)?.name || 'unknown';
                lines.push(`- ${c.content} *(from: ${ideaName})*`);
            });
            return lines.join('\n');
        },

        generateScoped(concepts, ideas, specId) {
            // Filter concepts with matching specId in scopeTags
            let scoped = concepts.filter(c => c.status === 'active' && (c.scopeTags || []).includes(specId));
            if (scoped.length === 0) scoped = concepts.filter(c => c.status === 'active'); // fallback to full
            const scope = scoped.length === concepts.filter(c => c.status === 'active').length ? 'full active landscape' : `scoped to spec ${specId}`;
            const sections = ODRC_TYPES.map(t => this._renderGroup(t, scoped, ideas)).filter(Boolean);
            return `# ODRC State Summary\nScope: ${scope}\n\n${sections.join('\n\n')}`;
        },

        generateFull(concepts, ideas) {
            const active = concepts.filter(c => c.status === 'active');
            const sections = ODRC_TYPES.map(t => this._renderGroup(t, active, ideas)).filter(Boolean);
            return `# ODRC State Summary\nScope: full active landscape\n\n${sections.join('\n\n')}`;
        }
    };

    // =========================================================================
    // REVIEW PROMPT GENERATOR (v8.59.0)
    // =========================================================================

        // v8.70.15: Removed ReviewPromptGenerator

    // =========================================================================
    // VALIDATION BUNDLE ASSEMBLER (v8.59.0)
    // =========================================================================

        // v8.70.15: Removed ValidationBundleAssembler

    // =========================================================================
    // ORPHAN DETECTION SERVICE (v8.60.0 â€” Phase 3)
    // =========================================================================

        // v8.70.15: Removed OrphanDetectionService

    // =========================================================================
    // ODRC UPDATE INGESTION SERVICE (v8.60.0 â€” Phase 3)
    // =========================================================================

    const ODRCUpdateIngestionService = {
        // Parse structured ODRC update text into actionable items
        // Tolerant of minor format variations (quotes, arrow styles, whitespace)
        parse(text) {
            const updates = [];
            const lines = text.split('\n').map(l => l.trim()).filter(l => l.startsWith('- '));

            for (const line of lines) {
                // Normalize arrow formats: â†’, ->, ==>
                const normalized = line.replace(/\s*(?:â†’|->|==>)\s*/g, ' â†’ ');

                // Priority 1: RESOLVE OPEN: "desc" â†’ matched to concept_id xyz (strict)
                const resolveMatch = normalized.match(/^- RESOLVE OPEN:\s*"?(.+?)"?\s*â†’\s*matched to concept_id\s+(.+)$/i);
                if (resolveMatch) {
                    updates.push({ action: 'resolve', type: 'OPEN', description: resolveMatch[1].trim(), conceptId: resolveMatch[2].trim() });
                    continue;
                }

                // Priority 2: RESOLVE OPEN {N}: "desc" â†’ resolution text (numbered format)
                // v8.61.1: Flex RESOLVE patterns â€” conceptId null, store resolution text
                const resolveNumberedMatch = normalized.match(/^- RESOLVE OPEN\s+\d+:\s*"?(.+?)"?\s*â†’\s*(.+)$/i);
                if (resolveNumberedMatch) {
                    updates.push({ action: 'resolve', type: 'OPEN', description: resolveNumberedMatch[1].trim(), conceptId: null, resolution: resolveNumberedMatch[2].trim() });
                    continue;
                }

                // Priority 3: RESOLVE OPEN: "desc" â†’ freeform resolution text
                const resolveFlexMatch = normalized.match(/^- RESOLVE OPEN:\s*"?(.+?)"?\s*â†’\s*(.+)$/i);
                if (resolveFlexMatch) {
                    updates.push({ action: 'resolve', type: 'OPEN', description: resolveFlexMatch[1].trim(), conceptId: null, resolution: resolveFlexMatch[2].trim() });
                    continue;
                }

                // Priority 4: RESOLVE OPEN: "desc" (no arrow â€” bare resolve, from completion file odrc)
                const resolveBareMatch = normalized.match(/^- RESOLVE OPEN:\s*"?(.+?)"?\s*$/i);
                if (resolveBareMatch) {
                    updates.push({ action: 'resolve', type: 'OPEN', description: resolveBareMatch[1].trim(), conceptId: null });
                    continue;
                }

                // NEW {TYPE}: "desc" â†’ tag to Idea {name}
                const newTaggedMatch = normalized.match(/^- NEW (OPEN|DECISION|RULE|CONSTRAINT):\s*"?(.+?)"?\s*â†’\s*tag to Idea\s+(.+)$/i);
                if (newTaggedMatch) {
                    updates.push({ action: 'create', type: newTaggedMatch[1].toUpperCase(), description: newTaggedMatch[2].trim(), targetIdea: newTaggedMatch[3].trim() });
                    continue;
                }

                // NEW {TYPE}: "desc" â†’ untagged
                const newUntaggedMatch = normalized.match(/^- NEW (OPEN|DECISION|RULE|CONSTRAINT):\s*"?(.+?)"?\s*â†’\s*untagged$/i);
                if (newUntaggedMatch) {
                    updates.push({ action: 'create', type: newUntaggedMatch[1].toUpperCase(), description: newUntaggedMatch[2].trim(), targetIdea: null });
                    continue;
                }

                // NEW {TYPE}: "desc" (no routing specified)
                const newSimpleMatch = normalized.match(/^- NEW (OPEN|DECISION|RULE|CONSTRAINT):\s*"?(.+?)"?\s*$/i);
                if (newSimpleMatch) {
                    updates.push({ action: 'create', type: newSimpleMatch[1].toUpperCase(), description: newSimpleMatch[2].trim(), targetIdea: null });
                    continue;
                }

                // Log unparseable lines
                if (line.includes('OPEN') || line.includes('DECISION') || line.includes('RULE') || line.includes('CONSTRAINT')) {
                    console.log('[CC] ODRCUpdateIngestionService: unparseable line:', line);
                }
            }

            return updates;
        },

        // v8.70.5: Convert structured job.odrc object â†’ ingestion-compatible text lines
        // Bridges the gap between completion file YAML format and the parse() text format
        // Handles both naming conventions: applied_decisions/new_decisions, new_rules, new_constraints
        odrcToIngestionText(odrc) {
            if (!odrc) return '';
            const lines = ['## ODRC Updates'];
            if (odrc.resolved_opens?.length > 0) {
                odrc.resolved_opens.forEach(text => {
                    // Split on em dash " â€” " to separate description from resolution note
                    const parts = text.split(/\s*â€”\s*/);
                    const desc = parts[0].trim();
                    const resolution = parts.length > 1 ? parts.slice(1).join(' â€” ').trim() : null;
                    if (resolution) {
                        lines.push(`- RESOLVE OPEN: "${desc}" â†’ ${resolution}`);
                    } else {
                        lines.push(`- RESOLVE OPEN: "${desc}"`);
                    }
                });
            }
            // Handle both applied_decisions and new_decisions (completion files use both)
            const decisions = [...(odrc.applied_decisions || []), ...(odrc.new_decisions || [])];
            if (decisions.length > 0) {
                decisions.forEach(text => {
                    lines.push(`- NEW DECISION: "${text}"`);
                });
            }
            if (odrc.new_rules?.length > 0) {
                odrc.new_rules.forEach(text => {
                    lines.push(`- NEW RULE: "${text}"`);
                });
            }
            if (odrc.new_constraints?.length > 0) {
                odrc.new_constraints.forEach(text => {
                    lines.push(`- NEW CONSTRAINT: "${text}"`);
                });
            }
            if (odrc.new_opens?.length > 0) {
                odrc.new_opens.forEach(text => {
                    lines.push(`- NEW OPEN: "${text}"`);
                });
            }
            return lines.join('\n');
        },

        // Execute confirmed updates against Firebase
        async execute(uid, updates, globalIdeas) {
            const results = [];
            for (const update of updates) {
                try {
                    if (update.action === 'resolve' && update.conceptId) {
                        await ConceptManager.resolve(uid, update.conceptId);
                        results.push({ ...update, status: 'success' });
                    } else if (update.action === 'resolve' && !update.conceptId && update.overrideConceptId) {
                        // v8.61.1: Flex RESOLVE â€” user selected the OPEN to resolve via checklist dropdown
                        await ConceptManager.resolve(uid, update.overrideConceptId);
                        results.push({ ...update, status: 'success', resolvedConceptId: update.overrideConceptId });
                    } else if (update.action === 'resolve' && !update.conceptId && !update.overrideConceptId) {
                        // v8.61.1: Flex RESOLVE â€” no concept selected, skip
                        results.push({ ...update, status: 'skipped', reason: 'No OPEN selected for resolution' });
                    } else if (update.action === 'create') {
                        let ideaId = null;
                        if (update.targetIdea) {
                            const idea = globalIdeas.find(i => i.name.toLowerCase().includes(update.targetIdea.toLowerCase()));
                            ideaId = idea?.id || null;
                        }
                        // Use overrideIdeaId if user selected a different idea in the UI
                        const finalIdeaId = update.overrideIdeaId !== undefined ? update.overrideIdeaId : ideaId;
                        await ConceptManager.create(uid, { type: update.type, content: update.description, ideaOrigin: finalIdeaId, scopeTags: [] });
                        results.push({ ...update, status: 'success', resolvedIdeaId: finalIdeaId });
                    }
                } catch (e) {
                    results.push({ ...update, status: 'error', error: e.message });
                }
            }
            return results;
        }
    };

    // =========================================================================
    // SESSION PACKAGE PROCESSOR (v8.66.0 â€” Session JSON Ingestion)
    // =========================================================================

    const SESSION_JSON_SCHEMA_VERSION = '1.0.0';

        // v8.70.15: Removed SessionPackageProcessor + isSessionPackageZip

    // =========================================================================
    // ODRC CONTENT DETECTION (v8.61.0 â€” Idea-to-Chat Pipeline Phase 3)
    // =========================================================================

    // Detect ODRC content in file text (content-based detection)
    // v8.61.1: Tightened â€” skip matches inside code blocks, require 3+ matches without header
        // v8.70.15: Removed detectODRCContent

    // Extract metadata from ODRC content header block
    function extractODRCMetadata(fileContent) {
        if (!fileContent || typeof fileContent !== 'string') return { ideaSlug: null, ideaId: null, sessionNumber: null, appId: null };
        const ideaMatch = fileContent.match(/^#\s*Idea:\s*(.+)$/m);
        const ideaIdMatch = fileContent.match(/^#\s*IdeaId:\s*(.+)$/m); // v8.64.0 A3
        const sessionMatch = fileContent.match(/^#\s*Session:\s*(.+)$/m);
        const appMatch = fileContent.match(/^#\s*App:\s*(.+)$/m);

        // v8.64.2: Validate ideaSlug â€” reject placeholder markers like "(new â€” needs creation)"
        let ideaSlug = ideaMatch ? ideaMatch[1].trim() : null;
        if (ideaSlug && (
            ideaSlug.startsWith('(') ||       // parenthesized markers
            ideaSlug.includes('â€”') ||          // em-dash (non-slug char)
            ideaSlug.includes('â€¦') ||          // ellipsis
            /^(new|none|tbd|todo|create)/i.test(ideaSlug) || // common placeholder words
            !/[a-z0-9]/.test(ideaSlug)         // no alphanumeric chars at all
        )) {
            console.log('[CC] extractODRCMetadata: rejected invalid slug:', ideaSlug);
            ideaSlug = null;
        }

        return {
            ideaSlug,
            ideaId: ideaIdMatch ? ideaIdMatch[1].trim() : null, // v8.64.0 A3: Firebase key for unambiguous routing
            sessionNumber: sessionMatch ? sessionMatch[1].trim() : null,
            appId: appMatch ? appMatch[1].trim() : null
        };
    }

    // Extract the ODRC Updates section from a larger document
    function extractODRCSection(fileContent) {
        if (!fileContent || typeof fileContent !== 'string') return null;
        const odrcStart = fileContent.indexOf('## ODRC Updates');
        if (odrcStart === -1) return null;
        return fileContent.substring(odrcStart);
    }

    // v8.62.0 B2: Detect session type from inbound file content
        // v8.70.15: Removed detectSessionType + detectInboundArtifactType + findDuplicateConcepts + executeODRCImport

    // =========================================================================
    // SESSION TYPES + SESSION BRIEF GENERATOR (v8.25.0 â€” Phase 2.1)
    // =========================================================================

    // v8.71.0: Domain services (PorkbunService, GoDaddyService, DomainProviderRegistry) moved to line ~435
    

    // [v8.63.0] SESSION_TYPES and SessionBriefGenerator removed â€” replaced by IdeationBriefGenerator
    // Minimal stubs retained for ClaudePrepModal backward compatibility
    const SESSION_TYPES = {
        build: { id: 'build', label: 'Build', icon: 'ðŸ”¨', description: 'Implement features', suggestedEngine: 'claude-sonnet-4.5', roleFrame: 'Build new functionality.', scopeRules: [], deliveryRequirements: [], contextStrategy: { alwaysInclude: [], preferInclude: [], skipWhenTight: [], includeSource: true }, workItemFocus: '', autoSuggestFrom: ['feature', 'enhancement', 'chore'] },
        fix: { id: 'fix', label: 'Fix', icon: 'ðŸ”§', description: 'Fix bugs', suggestedEngine: 'claude-sonnet-4.5', roleFrame: 'Fix reported issues.', scopeRules: [], deliveryRequirements: [], contextStrategy: { alwaysInclude: [], preferInclude: [], skipWhenTight: [], includeSource: true }, workItemFocus: '', autoSuggestFrom: ['bugfix'] },
        design: { id: 'design', label: 'Design', icon: 'ðŸŽ¨', description: 'Design features', suggestedEngine: 'claude-opus-4.5', roleFrame: 'Design systems.', scopeRules: [], deliveryRequirements: [], contextStrategy: { alwaysInclude: [], preferInclude: [], skipWhenTight: [], includeSource: true }, workItemFocus: '', autoSuggestFrom: ['research'] },
        review: { id: 'review', label: 'Review', icon: 'ðŸ‘ï¸', description: 'Review code', suggestedEngine: 'claude-sonnet-4.5', roleFrame: 'Review quality.', scopeRules: [], deliveryRequirements: [], contextStrategy: { alwaysInclude: [], preferInclude: [], skipWhenTight: [], includeSource: true }, workItemFocus: '', autoSuggestFrom: [] }
    };
    const SessionBriefGenerator = {
        generate() { return ''; },
        getAll() { return Object.values(SESSION_TYPES); },
        get(id) { return SESSION_TYPES[id] || null; },
        suggestFromWorkItem(wi) { return 'build'; },
        getFileStrategy(t) { return SESSION_TYPES[t]?.contextStrategy || { alwaysInclude: [], preferInclude: [], skipWhenTight: [], includeSource: true }; }
    };
    
        // v8.70.15: Removed LENS/MODE constants + IdeationBriefGenerator

    // =========================================================================
    // END DATA SERVICE LAYER
    // =========================================================================
    
        // v8.70.15: Removed extractVersionFromHTML
    
    // Find ALL version-like strings in HTML for debugging
    function findAllVersionStrings(content) {
        const versions = [];
        
        // Helper to check if a match is inside a comment or code example
        function shouldSkip(matchIndex, matchText) {
            // Get surrounding context (200 chars before, line content)
            const before = content.substring(Math.max(0, matchIndex - 200), matchIndex);
            const lineStart = content.lastIndexOf('\n', matchIndex) + 1;
            const lineEnd = content.indexOf('\n', matchIndex);
            const lineContent = content.substring(lineStart, lineEnd === -1 ? matchIndex + 100 : lineEnd);
            
            // Skip if inside a comment block or pattern documentation
            if (/^\s*(\/\/|\*|#)/.test(lineContent)) return true;
            if (/Pattern|Example|e\.g\.|like|â†’|-->/i.test(lineContent)) return true;
            
            // Skip if the match looks like documentation (Pattern 1:, Pattern 2:, etc.)
            if (/Pattern\s*\d+|\/\/\s*Pattern/i.test(before.slice(-80))) return true;
            
            // Skip if this appears to be inside function code that manipulates versions
            // (i.e., the fixVersionsInContent function, version bump examples, etc.)
            if (/fixVersions|incrementVersion|bumpVersion|parseVersion/i.test(before.slice(-150))) return true;
            
            // Skip template literal patterns - these are code, not actual versions
            if (matchText && matchText.includes('${')) return true;
            if (matchText && matchText.includes('targetVersion')) return true;
            
            // Skip if inside a generate* function (skeleton docs, HTML templates, Claude prompts)
            // These contain meta version tags as template output, not the app's own version
            const fnContext = before.slice(-1000);
            if (/function\s+generate\w*\s*\(/.test(fnContext) && !/function\s+(extractVersion|findAllVersion|validateVersion)/.test(fnContext)) return true;
            
            // Skip placeholder version patterns (X.X.X, X.Y.Z, etc.)
            if (matchText && /^[A-Z]\.[A-Z]\.[A-Z]$/.test(matchText)) return true;
            
            // Skip if it's a version format example like "1.0.0 â†’ 1.0.1"
            if (/\d+\.\d+\.\d+\s*â†’/.test(lineContent)) return true;
            
            return false;
        }
        
        // Meta tag versions
        const metaMatches = content.matchAll(/<meta\s+[^>]*name=["']version["'][^>]*content=["']([^"']+)["'][^>]*>/gi);
        for (const m of metaMatches) {
            if (shouldSkip(m.index, m[1])) continue;
            versions.push({ source: 'meta tag', value: m[1], line: content.substring(0, m.index).split('\n').length });
        }
        // Also check reverse order: content before name
        const metaMatches2 = content.matchAll(/<meta\s+[^>]*content=["']([^"']+)["'][^>]*name=["']version["'][^>]*>/gi);
        for (const m of metaMatches2) {
            if (shouldSkip(m.index, m[1])) continue;
            versions.push({ source: 'meta tag', value: m[1], line: content.substring(0, m.index).split('\n').length });
        }
        
        // JS variable versions - but NOT inside comments, template literals, or the integration module definition
        const jsMatches = content.matchAll(/^\s*const\s+(VERSION|APP_VERSION|GAME_VERSION)\s*=\s*['"]([^'"]+)['"]/gm);
        for (const m of jsMatches) {
            // Skip if it's inside the GameShelf integration module (those are module versions, not app versions)
            const before = content.substring(Math.max(0, m.index - 200), m.index);
            if (before.includes('GAMESHELF_VERSION') || before.includes('Integration Module')) continue;
            if (shouldSkip(m.index, m[2])) continue;
            versions.push({ source: `JS: ${m[1]}`, value: m[2], line: content.substring(0, m.index).split('\n').length });
        }
        
        // Footer versions - look for patterns like "v1.0.0 â€¢" or ">v1.0.0<" or "v1.0.0 &bull;"
        const footerMatches = content.matchAll(/[>\s]v(\d+\.\d+\.\d+)\s*[â€¢<Â·&]/g);
        for (const m of footerMatches) {
            if (shouldSkip(m.index, m[1])) continue;
            versions.push({ source: 'footer/visible', value: m[1], line: content.substring(0, m.index).split('\n').length });
        }
        
        // Version in about/info sections
        const aboutMatches = content.matchAll(/Version:?\s*<\/?\w*>?\s*v?(\d+\.\d+\.\d+)/gi);
        for (const m of aboutMatches) {
            if (shouldSkip(m.index, m[1])) continue;
            versions.push({ source: 'about/info text', value: m[1], line: content.substring(0, m.index).split('\n').length });
        }
        
        return versions;
    }
    
    // Validate version consistency in HTML content
        // v8.70.15: Removed validateVersions
    
    // Auto-fix version strings in HTML content
    function fixVersionsInContent(content, targetVersion) {
        let fixed = content;
        
        // Fix or add meta tag
        const metaRegex = /<meta\s+name=["']version["']\s+content=["'][^"']*["']\s*\/?>/i;
        const metaRegex2 = /<meta\s+content=["'][^"']*["']\s+name=["']version["']\s*\/?>/i;
        
        if (metaRegex.test(fixed)) {
            fixed = fixed.replace(metaRegex, `<meta name="version" content="${targetVersion}">`);
        } else if (metaRegex2.test(fixed)) {
            fixed = fixed.replace(metaRegex2, `<meta name="version" content="${targetVersion}">`);
        } else {
            // Add meta tag after charset or viewport
            fixed = fixed.replace(
                /(<meta\s+[^>]*viewport[^>]*>)/i,
                `$1\n    <meta name="version" content="${targetVersion}">`
            );
        }
        
        // Fix const VERSION = '8.36.0' (but not GAMESHELF_VERSION)
        fixed = fixed.replace(
            /(const\s+VERSION\s*=\s*['"])[^'"]*(['"])/g,
            `$1${targetVersion}$2`
        );
        
        // Fix CACHE_VERSION = 'v8.7.6' in service workers (with or without 'v' prefix)
        fixed = fixed.replace(
            /(CACHE_VERSION\s*=\s*['"])v?[^'"]*(['"])/g,
            `$1v${targetVersion}$2`
        );
        
        // Fix console.log version strings like "App v1.0.0 starting" or "Command Center v8.7.5"
        fixed = fixed.replace(
            /(console\.log\(['"][^'"]*\s+v)\d+\.\d+\.\d+(\s+[^'"]*['"])/g,
            `$1${targetVersion}$2`
        );
        
        // Fix footer versions like "v1.0.0 â€¢" or "v1.0.0 Â·" or "v1.0.0 &bull;"
        fixed = fixed.replace(
            /(>\s*)v\d+\.\d+\.\d+(\s*[â€¢Â·])/g,
            `$1v${targetVersion}$2`
        );
        fixed = fixed.replace(
            /(>\s*)v\d+\.\d+\.\d+(\s*&bull;)/g,
            `$1v${targetVersion}$2`
        );
        
        // Fix about/version display
        fixed = fixed.replace(
            /(Version:?\s*<\/?\w*>?\s*)v?\d+\.\d+\.\d+/gi,
            `$1v${targetVersion}`
        );
        
        return fixed;
    }
    
        // v8.70.15: Removed parseVersion + compareVersions + isNewerVersion + bumpVersion + formatVersion

    // =========================================================================
    // DYNAMIC CONFIGURATION SYSTEM (v7.0.0)
    // =========================================================================
    
    // Environment definitions - extensible for dev, test, prod, beta
    const DEFAULT_ENVIRONMENTS = {
        available: ['dev', 'test', 'prod', 'beta'],
        active: ['test', 'prod'],  // Currently enabled
        colors: {
            dev: { bg: 'bg-purple-600', text: 'text-purple-300', border: 'border-purple-500', hex: '#9333ea' },
            test: { bg: 'bg-blue-600', text: 'text-blue-300', border: 'border-blue-500', hex: '#2563eb' },
            prod: { bg: 'bg-green-600', text: 'text-green-300', border: 'border-green-500', hex: '#16a34a' },
            beta: { bg: 'bg-orange-600', text: 'text-orange-300', border: 'border-orange-500', hex: '#ea580c' }
        },
        labels: { dev: 'DEV', test: 'TEST', prod: 'PROD', beta: 'BETA' },
        icons: { dev: 'ðŸ› ï¸', test: 'ðŸ§ª', prod: 'ðŸš€', beta: 'ðŸ”¬' }
    };
    
    // App type categories (v8.3.3)
    const APP_TYPES = {
        public: { label: 'Public Apps', description: 'User-facing apps with Test â†’ Prod workflow', collapsed: false },
        internal: { label: 'Internal Tools', description: 'Prod only - no test environment', collapsed: false },
        other: { label: 'Other Projects', description: 'Side projects and prototypes', collapsed: true }
    };
    
    // Project definitions (v8.8.0) - Umbrella grouping for apps
    // Seed data â€” used only for initial migration into config.projects
    // Seed project definitions â€” ONLY used for first-time initialization.
    // After first load, config.projects is the source of truth.
    // v8.70.10: Seed projects/apps emptied â€” each user configures their own via UI or MCP.
    // David's project/app definitions live in Firebase under his UID, not in code.
    // Previously these contained David's specific apps (Game Shelf, Slate, etc.) which
    // would leak to every new user via getDefaultConfig().
    const SEED_PROJECTS = {};
    
    const DEFAULT_APP_DEFINITIONS = {};
    
    // Machine-readable seed manifest for config â†” code drift detection.
    // When CC deploys itself, this is parsed from the staged HTML and compared
    // against the running config to detect mismatches.
    // Format: /* CC_SEED_MANIFEST_START */ JSON /* CC_SEED_MANIFEST_END */
    /* CC_SEED_MANIFEST_START */
    const CC_SEED_MANIFEST = {
        "appId": "command-center",
        "title": "Command Center",
        "projects": {
            "gameshelf": { "name": "Game Shelf", "icon": "cc-logo", "color": "indigo" },
            "command-center": { "name": "Command Center", "icon": "ðŸ—ï¸", "color": "cyan" },
            "firebase": { "name": "Firebase Code", "icon": "âš¡", "color": "orange" },
            "quotle-info": { "name": "Quotle-info", "icon": "ðŸ“–", "color": "rose" },
            "labelkeeper": { "name": "LabelKeeper", "icon": "ðŸ·ï¸", "color": "emerald" },
            "superbowl": { "name": "Super Bowl", "icon": "ðŸˆ", "color": "amber" },
            "other": { "name": "Other", "icon": "ðŸ“¦", "color": "slate" }
        },
        "apps": {
            "gameshelf": { "name": "Game Shelf", "project": "gameshelf", "icon": "cc-logo", "subPath": "app", "appType": "public", "hasServiceWorker": true },
            "beta": { "name": "Beta Hub", "project": "gameshelf", "icon": "ðŸš€", "subPath": "beta", "appType": "public", "hasServiceWorker": false },
            "slate": { "name": "Slate", "project": "gameshelf", "icon": "ðŸª¨", "subPath": "slate", "appType": "public", "hasServiceWorker": true },
            "rungs": { "name": "Rungs", "project": "gameshelf", "icon": "ðŸªœ", "subPath": "rungs", "appType": "public", "hasServiceWorker": true },
            "quotle": { "name": "Quotle", "project": "gameshelf", "icon": "ðŸ’¬", "subPath": "quotle", "appType": "public", "hasServiceWorker": true },
            "wordboxing": { "name": "Word Boxing", "project": "gameshelf", "icon": "ðŸ¥Š", "subPath": "wordboxing", "appType": "public", "hasServiceWorker": true },
            "command-center": { "name": "Command Center", "project": "command-center", "icon": "ðŸ—ï¸", "subPath": "", "appType": "internal", "hasServiceWorker": false },
            "testplan": { "name": "Test Plan", "project": "gameshelf", "icon": "ðŸ§ª", "subPath": "", "appType": "internal", "hasServiceWorker": false },
            "firebase-functions": { "name": "Firebase Functions", "project": "firebase", "icon": "âš¡", "subPath": "", "appType": "internal", "hasServiceWorker": false },
            "labelkeeper": { "name": "LabelKeeper", "project": "labelkeeper", "icon": "ðŸ·ï¸", "subPath": "", "appType": "public", "hasServiceWorker": false }
        }
    };
    /* CC_SEED_MANIFEST_END */
    
    // Configuration manager
    const ConfigManager = {
        STORAGE_KEY: 'commandCenterConfig',
        REPO_STORAGE_KEY: 'githubRepoAssignments',
        
        // Load config from localStorage or use defaults
        load() {
            try {
                const stored = localStorage.getItem(this.STORAGE_KEY);
                if (stored) {
                    const config = JSON.parse(stored);
                    return this.mergeWithDefaults(config);
                }
            } catch (e) {
                console.warn('Failed to load config, using defaults:', e);
            }
            return this.getDefaultConfig();
        },
        
        // Save config to localStorage + Firebase
        save(config) {
            try {
                // Add sync timestamp
                config._updatedAt = Date.now();
                config._updatedBy = 'local';
                
                // 1. localStorage (immediate, synchronous)
                localStorage.setItem(this.STORAGE_KEY, JSON.stringify(config));
                // 1b. Satellite-readable copy (gs_config)
                try { localStorage.setItem('gs_config', JSON.stringify(config)); } catch {}
                
                // 2. Firebase (async, fire-and-forget)
                if (FirebaseConfigSync.initialized) {
                    FirebaseConfigSync.pushConfig(config).catch(err =>
                        console.warn('[ConfigManager] Firebase sync failed:', err.message)
                    );
                }
                
                return true;
            } catch (e) {
                console.error('Failed to save config:', e);
                return false;
            }
        },
        
        // Get default configuration
        getDefaultConfig() {
            return {
                version: '7.0.0',
                ownerName: '',
                environments: { ...DEFAULT_ENVIRONMENTS },
                apps: JSON.parse(JSON.stringify(DEFAULT_APP_DEFINITIONS)),
                projects: JSON.parse(JSON.stringify(SEED_PROJECTS))
            };
        },
        
        // Merge stored config with defaults (handles upgrades)
        mergeWithDefaults(stored) {
            const defaults = this.getDefaultConfig();
            
            // v8.15.0: Migrate app id 'management' â†’ 'command-center'
            if (stored.apps && stored.apps['management'] && !stored.apps['command-center']) {
                stored.apps['command-center'] = { ...stored.apps['management'], id: 'command-center' };
                delete stored.apps['management'];
                console.log('ðŸ”„ Migrated app: management â†’ command-center');
            }
            
            // Ensure environments structure
            if (!stored.environments) {
                stored.environments = defaults.environments;
            } else {
                stored.environments = { ...defaults.environments, ...stored.environments };
            }
            
            // v8.37.0: Ensure ownerName field exists
            if (stored.ownerName === undefined) {
                stored.ownerName = '';
            }
            
            // v8.12.0: Ensure projects structure exists â€” one-time migration
            if (!stored.projects) {
                stored.projects = JSON.parse(JSON.stringify(SEED_PROJECTS));
                // Migrate _standalone â†’ other for any existing apps
                for (const app of Object.values(stored.apps || {})) {
                    if (app.project === '_standalone') app.project = 'other';
                }
                // Migrate cc_projectStates into project objects
                try {
                    const oldStates = JSON.parse(localStorage.getItem('cc_projectStates') || '{}');
                    for (const [id, state] of Object.entries(oldStates)) {
                        const projId = id === '_standalone' ? 'other' : id;
                        if (stored.projects[projId]) {
                            stored.projects[projId].state = state;
                        }
                    }
                } catch (e) { /* ignore */ }
            }
            // Note: We do NOT force-merge SEED_PROJECTS into existing stored.projects.
            // Once projects exist in config, the user's stored data is the source of truth.
            // New projects are created through the UI, not by adding seeds here.
            // HOWEVER: ensure any project referenced by an app actually has a definition.
            // v8.56.1: Fix "two Other groups" â€” if an app references project 'firebase'
            // but stored.projects has no 'firebase' entry, add it from seeds.
            if (stored.projects && stored.apps) {
                const referencedProjects = new Set(Object.values(stored.apps).map(a => a.project).filter(Boolean));
                for (const projId of referencedProjects) {
                    if (projId !== 'other' && !stored.projects[projId] && SEED_PROJECTS[projId]) {
                        stored.projects[projId] = JSON.parse(JSON.stringify(SEED_PROJECTS[projId]));
                        console.log(`[ConfigMigration] Added missing project definition: ${projId} ("${SEED_PROJECTS[projId].name}")`);
                    }
                }
            }
            
            // v8.13.1.7: Stored apps are the source of truth.
            // Only seed default apps if the apps object is completely empty (first-time setup).
            // After that, apps are created/edited/deleted through the UI.
            if (!stored.apps || Object.keys(stored.apps).length === 0) {
                stored.apps = JSON.parse(JSON.stringify(defaults.apps));
            } else {
                // v8.55.1: Add new seed apps that don't exist in stored config yet
                // This handles apps added in code updates (like CC satellites)
                for (const [id, seedApp] of Object.entries(defaults.apps)) {
                    if (!stored.apps[id]) {
                        stored.apps[id] = JSON.parse(JSON.stringify(seedApp));
                        console.log(`[ConfigMigration] Added new app: ${id} (project: ${seedApp.project || 'other'})`);
                    }
                }
                
                // Ensure structural fields exist on each stored app (schema migration only)
                // This adds NEW fields from the schema without overwriting user values
                for (const [id, app] of Object.entries(stored.apps)) {
                    if (!app.repos) app.repos = { test: '', prod: '' };
                    if (!app.versions) app.versions = { test: '', prod: '' };
                    if (!app.createdAt) app.createdAt = Date.now();
                    if (!app.detectionPatterns) app.detectionPatterns = [];
                    if (app.appType === undefined) app.appType = 'public';
                    if (app.hasServiceWorker === undefined) app.hasServiceWorker = false;
                    // v8.18.0: Ensure project field exists â€” fall back to seed definition or 'other'
                    if (!app.project) app.project = DEFAULT_APP_DEFINITIONS[id]?.project || 'other';
                    // v8.55.1: Sync project field from seed if it changed (e.g., firebase-functions moved to 'firebase')
                    const seedProject = DEFAULT_APP_DEFINITIONS[id]?.project;
                    if (seedProject && app.project !== seedProject) {
                        console.log(`[ConfigMigration] ${id}: project ${app.project} â†’ ${seedProject}`);
                        app.project = seedProject;
                    }
                    // v8.20.0: Ensure lifecycle object exists (Phase 0.2 orchestrator)
                    if (!app.lifecycle) app.lifecycle = {};
                    if (!app.lifecycle.category) app.lifecycle.category = app.appType === 'internal' ? 'admin' : null;
                    if (!app.lifecycle.currentMaturity) app.lifecycle.currentMaturity = null;
                    if (!app.lifecycle.maturityTarget) app.lifecycle.maturityTarget = null;
                    if (!app.lifecycle.problemStatement) app.lifecycle.problemStatement = '';
                    if (!app.lifecycle.targetAudience) app.lifecycle.targetAudience = '';
                    if (!app.lifecycle.userGoal) app.lifecycle.userGoal = '';
                    if (!app.lifecycle.successMetric) app.lifecycle.successMetric = '';
                    if (!app.lifecycle.stack) app.lifecycle.stack = {};
                    if (!app.lifecycle.maturityCriteria) app.lifecycle.maturityCriteria = {};
                }
            }
            
            return stored;
        },
        
        // Migrate from old format (testRepo/prodRepo to repos object)
        migrateFromOldFormat(oldApps, config) {
            const repoAssignments = JSON.parse(localStorage.getItem(this.REPO_STORAGE_KEY) || '{}');
            let synced = 0;
            
            for (const [id, oldApp] of Object.entries(oldApps)) {
                if (config.apps[id]) {
                    // Check repo assignments first, then fall back to old format
                    const assignment = repoAssignments[id] || {};
                    const newTest = assignment.testRepo || oldApp.testRepo || '';
                    const newProd = assignment.prodRepo || oldApp.prodRepo || '';
                    if (newTest || newProd) {
                        config.apps[id].repos.test = newTest;
                        config.apps[id].repos.prod = newProd;
                        synced++;
                    }
                    config.apps[id].versions.test = oldApp.currentTestVersion || '';
                    config.apps[id].versions.prod = oldApp.currentProdVersion || '';
                }
            }
            console.log(`[ConfigManager] migrateFromOldFormat: synced repos for ${synced}/${Object.keys(oldApps).length} apps`);
            
            return config;
        },
        
        // Add a new app
        addApp(config, appData) {
            const id = appData.id || appData.name.toLowerCase().replace(/\s+/g, '');
            config.apps[id] = {
                id,
                name: appData.name,
                icon: appData.icon || 'ðŸ“¦',
                targetPath: appData.targetPath || 'index.html',
                swPath: appData.swPath || '',
                hasServiceWorker: appData.hasServiceWorker || false,
                repos: { dev: '', test: '', prod: '', beta: '' },
                versions: { dev: '', test: '', prod: '', beta: '' },
                repoPatterns: {
                    dev: [`${id}dev`, `${id}-dev`],
                    test: [`${id}test`, `${id}-test`],
                    prod: [id],
                    beta: [`${id}beta`, `${id}-beta`]
                },
                detectionPatterns: appData.detectionPatterns || [`<title>${appData.name.toLowerCase()}`],
                // v8.20.0: Include lifecycle metadata
                lifecycle: appData.lifecycle || {
                    category: null,
                    currentMaturity: null,
                    maturityTarget: null,
                    problemStatement: '',
                    targetAudience: '',
                    userGoal: '',
                    successMetric: '',
                    stack: {},
                    maturityCriteria: {}
                }
            };
            return config;
        },
        
        // Remove an app
        removeApp(config, appId) {
            delete config.apps[appId];
            return config;
        },
        
        // Update app
        updateApp(config, appId, updates) {
            if (config.apps[appId]) {
                config.apps[appId] = { ...config.apps[appId], ...updates };
            }
            return config;
        },
        
        // Add a new project
        addProject(config, projectData) {
            const id = projectData.id || projectData.name.toLowerCase().replace(/\s+/g, '-');
            config.projects[id] = {
                id,
                name: projectData.name,
                icon: projectData.icon || 'ðŸ“¦',
                color: projectData.color || 'slate',
                description: projectData.description || '',
                order: projectData.order ?? (Math.max(...Object.values(config.projects).map(p => p.order || 0)) + 1),
                state: projectData.state || 'active'
            };
            return config;
        },
        
        // Update a project
        updateProject(config, projectId, updates) {
            if (config.projects[projectId]) {
                config.projects[projectId] = { ...config.projects[projectId], ...updates };
            }
            return config;
        },
        
        // Remove a project (reassigns orphaned apps to 'other')
        removeProject(config, projectId) {
            if (projectId === 'other') return config; // Can't delete catch-all
            // Reassign any apps in this project to 'other'
            for (const app of Object.values(config.apps)) {
                if (app.project === projectId) {
                    app.project = 'other';
                }
            }
            delete config.projects[projectId];
            return config;
        },
        
        // Get number of apps in a project
        getProjectAppCount(config, projectId) {
            return Object.values(config.apps).filter(a => (a.project || 'other') === projectId).length;
        },
        
        // Enable/disable an environment
        toggleEnvironment(config, envId) {
            const idx = config.environments.active.indexOf(envId);
            if (idx >= 0) {
                // Don't allow disabling all environments
                if (config.environments.active.length > 1) {
                    config.environments.active.splice(idx, 1);
                }
            } else {
                config.environments.active.push(envId);
                // Sort by the defined order
                config.environments.active.sort((a, b) => 
                    config.environments.available.indexOf(a) - config.environments.available.indexOf(b)
                );
            }
            return config;
        },
        
        // Convert config to legacy apps format for backward compatibility
        toLegacyAppsFormat(config) {
            const apps = {};
            const activeEnvs = config.environments.active;
            
            for (const [id, app] of Object.entries(config.apps)) {
                apps[id] = {
                    id: app.id,
                    name: app.name,
                    icon: app.icon,
                    appType: app.appType || 'public',  // v8.3.3: App category
                    project: app.project || 'other',  // v8.8.0: Project grouping
                    targetPath: app.targetPath,
                    subPath: app.subPath || '',
                    swPath: app.swPath,
                    hasServiceWorker: app.hasServiceWorker,
                    repoPatterns: app.repoPatterns,
                    detectionPatterns: app.detectionPatterns,
                    deployType: app.deployType || null,  // v8.3.3: For GitHub Actions deploys
                    createdAt: app.createdAt || null,  // v8.8.0: Timestamp tracking
                    updatedAt: app.updatedAt || null,  // v8.8.0: Timestamp tracking
                    // Legacy format fields
                    testRepo: app.repos?.test || '',
                    prodRepo: app.repos?.prod || '',
                    currentTestVersion: app.versions?.test || '',
                    currentProdVersion: app.versions?.prod || '',
                    // New format - include all env repos
                    repos: app.repos || {},
                    versions: app.versions || {}
                };
            }
            
            return apps;
        },
        
        // Build detection signatures from config
        buildDetectionSignatures(config) {
            return Object.values(config.apps).map(app => ({
                id: app.id,
                patterns: app.detectionPatterns.map(p => {
                    try {
                        return new RegExp(p, 'i');
                    } catch (e) {
                        console.warn(`Invalid pattern for ${app.id}: ${p}`);
                        return null;
                    }
                }).filter(Boolean),
                confidence: 'high'
            }));
        },
        
        // Get active environments
        getActiveEnvironments(config) {
            return config.environments.active;
        },
        
        // Get environment display info
        getEnvDisplay(config, envId) {
            return {
                label: config.environments.labels[envId] || envId.toUpperCase(),
                icon: config.environments.icons[envId] || 'ðŸ“¦',
                colors: config.environments.colors[envId] || config.environments.colors.test
            };
        }
    };

    // v8.68.0: Session package detection signatures
        // v8.70.15: Removed File System Access TODO + buildSessionPackageSignatures

    // =========================================================================
    // ICONS
    // =========================================================================
    
    const Icons = {
        // CC "Structured Cells" hexagonal cluster logo
        // Full variant (32px+): center hex + 3 satellites with depth/shadow
        // Small variant (â‰¤24px): center hex + 1-2 satellites, thicker strokes
        CCLogo: ({ size = 20 }) => {
            // Use a unique suffix per instance to avoid SVG filter/gradient ID collisions
            const uid = React.useMemo(() => Math.random().toString(36).slice(2, 8), []);
            if (size <= 16) {
                // Favicon variant: center + 1 satellite, thick strokes
                return (
                    <svg viewBox="0 0 52 52" width={size} height={size} fill="none" xmlns="http://www.w3.org/2000/svg">
                        <defs>
                            <filter id={`ds${uid}`} x="-30%" y="-30%" width="160%" height="160%">
                                <feDropShadow dx="1.2" dy="1.2" stdDeviation="1.0" floodColor="#000" floodOpacity=".35"/>
                            </filter>
                        </defs>
                        <polygon points="37,3 46,9 46,20 37,26 28,20 28,9" fill="#e8a838" fillOpacity=".35"/>
                        <polygon points="37,3 46,9 46,20 37,26 28,20 28,9" fill="none" stroke="#e8a838" strokeOpacity=".65" strokeWidth="2.8"/>
                        <polygon points="26,11 37,17 37,29 26,35 15,29 15,17" fill="#e8a838" filter={`url(#ds${uid})`}/>
                    </svg>
                );
            }
            if (size <= 24) {
                // Small variant: center + 2 satellites
                return (
                    <svg viewBox="0 0 52 52" width={size} height={size} fill="none" xmlns="http://www.w3.org/2000/svg">
                        <defs>
                            <filter id={`ds${uid}`} x="-20%" y="-20%" width="140%" height="140%">
                                <feDropShadow dx="0.8" dy="0.8" stdDeviation="1.0" floodColor="#000" floodOpacity=".35"/>
                            </filter>
                        </defs>
                        <polygon points="35,7 42,11 42,19 35,23 28,19 28,11" fill="#e8a838" fillOpacity=".45"/>
                        <polygon points="35,7 42,11 42,19 35,23 28,19 28,11" fill="none" stroke="#e8a838" strokeOpacity=".65" strokeWidth="2.2"/>
                        <polygon points="26,31 33,35 33,43 26,47 19,43 19,35" fill="#e8a838" fillOpacity=".3"/>
                        <polygon points="26,31 33,35 33,43 26,47 19,43 19,35" fill="none" stroke="#e8a838" strokeOpacity=".4" strokeWidth="2.2"/>
                        <polygon points="26,15 33,19 33,27 26,31 19,27 19,19" fill="#e8a838" filter={`url(#ds${uid})`}/>
                        <polygon points="26,18.5 30.5,21 30.5,26 26,28.5 21.5,26 21.5,21" fill="#fff" fillOpacity=".15"/>
                    </svg>
                );
            }
            // Full variant: all 4 hexes with depth
            return (
                <svg viewBox="0 0 52 52" width={size} height={size} fill="none" xmlns="http://www.w3.org/2000/svg">
                    <defs>
                        <filter id={`ds${uid}`} x="-20%" y="-20%" width="140%" height="140%">
                            <feDropShadow dx="0.8" dy="0.8" stdDeviation="1.0" floodColor="#000" floodOpacity=".35"/>
                        </filter>
                        <linearGradient id={`sh${uid}`} x1="28" y1="11" x2="33" y2="19" gradientUnits="userSpaceOnUse">
                            <stop offset="0%" stopColor="#000" stopOpacity="0"/>
                            <stop offset="60%" stopColor="#000" stopOpacity=".3"/>
                            <stop offset="100%" stopColor="#000" stopOpacity=".4"/>
                        </linearGradient>
                    </defs>
                    {/* Satellites (rendered behind center) */}
                    <polygon points="35,7 42,11 42,19 35,23 28,19 28,11" fill="#e8a838" fillOpacity=".45"/>
                    <polygon points="35,7 42,11 42,19 35,23 28,19 28,11" fill="none" stroke="#e8a838" strokeOpacity=".65" strokeWidth="1.2"/>
                    <polygon points="26,31 33,35 33,43 26,47 19,43 19,35" fill="#e8a838" fillOpacity=".3"/>
                    <polygon points="26,31 33,35 33,43 26,47 19,43 19,35" fill="none" stroke="#e8a838" strokeOpacity=".4" strokeWidth="1.2"/>
                    <polygon points="12,19 19,23 19,31 12,35 5,31 5,23" fill="#e8a838" fillOpacity=".2"/>
                    <polygon points="12,19 19,23 19,31 12,35 5,31 5,23" fill="none" stroke="#e8a838" strokeOpacity=".25" strokeWidth="1.2"/>
                    {/* Shadow in overlap zone */}
                    <polygon points="28,11 33,14 33,19 28,19" fill={`url(#sh${uid})`}/>
                    {/* Center hex (on top, with drop shadow) */}
                    <polygon points="26,15 33,19 33,27 26,31 19,27 19,19" fill="#e8a838" filter={`url(#ds${uid})`}/>
                    {/* Inner highlight */}
                    <polygon points="26,18.5 30.5,21 30.5,26 26,28.5 21.5,26 21.5,21" fill="#fff" fillOpacity=".15"/>
                </svg>
            );
        },
        Upload: () => <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12" /></svg>,
        Rocket: () => <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M15.59 14.37a6 6 0 01-5.84 7.38v-4.8m5.84-2.58a14.98 14.98 0 006.16-12.12A14.98 14.98 0 009.631 8.41m5.96 5.96a14.926 14.926 0 01-5.841 2.58m-.119-8.54a6 6 0 00-7.381 5.84h4.8m2.581-5.84a14.927 14.927 0 00-2.58 5.84m2.699 2.7c-.103.021-.207.041-.311.06a15.09 15.09 0 01-2.448-2.448 14.9 14.9 0 01.06-.312m-2.24 2.39a4.493 4.493 0 00-1.757 4.306 4.493 4.493 0 004.306-1.758M16.5 9a1.5 1.5 0 11-3 0 1.5 1.5 0 013 0z" /></svg>,
        X: () => <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M6 18L18 6M6 6l12 12" /></svg>,
        Settings: () => <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" /><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" /></svg>,
        History: () => <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>,
        ExternalLink: () => <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14" /></svg>,
        ArrowRight: () => <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M14 5l7 7m0 0l-7 7m7-7H3" /></svg>,
        Zap: () => <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M13 10V3L4 14h7v7l9-11h-7z" /></svg>,
        AlertTriangle: () => <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" /></svg>,
        Rewind: () => <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12.066 11.2a1 1 0 000 1.6l5.334 4A1 1 0 0019 16V8a1 1 0 00-1.6-.8l-5.333 4zM4.066 11.2a1 1 0 000 1.6l5.334 4A1 1 0 0011 16V8a1 1 0 00-1.6-.8l-5.334 4z" /></svg>,
        GitBranch: () => <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M8 9l3 3-3 3m5 0h3M5 20h14a2 2 0 002-2V6a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" /></svg>,
        Check: () => <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M5 13l4 4L19 7" /></svg>,
        Shield: () => <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z" /></svg>,
        Refresh: () => <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" /></svg>,
        Play: () => <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M14.752 11.168l-3.197-2.132A1 1 0 0010 9.87v4.263a1 1 0 001.555.832l3.197-2.132a1 1 0 000-1.664z" /><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>,
        Folder: () => <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M3 7v10a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-6l-2-2H5a2 2 0 00-2 2z" /></svg>,
        File: () => <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" /></svg>,
        Trash: () => <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg>,
        Archive: () => <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M5 8h14M5 8a2 2 0 110-4h14a2 2 0 110 4M5 8v10a2 2 0 002 2h10a2 2 0 002-2V8m-9 4h4" /></svg>,
        Eye: () => <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" /><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" /></svg>,
        Download: () => <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" /></svg>,
        Plus: () => <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 4v16m8-8H4" /></svg>,
        Database: () => <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4 7v10c0 2.21 3.582 4 8 4s8-1.79 8-4V7M4 7c0 2.21 3.582 4 8 4s8-1.79 8-4M4 7c0-2.21 3.582-4 8-4s8 1.79 8 4m0 5c0 2.21-3.582 4-8 4s-8-1.79-8-4" /></svg>,
        User: () => <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" /></svg>,
        AlertCircle: () => <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>,
        Edit: () => <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" /></svg>,
        Copy: () => <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z" /></svg>,
        Search: () => <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" /></svg>,
    };
    
    // Helper to render app icons (handles both emojis and special logo identifiers)
    const AppIcon = ({ icon, size = 20 }) => {
        if (icon === 'cc-logo') {
            return <Icons.CCLogo size={size} key="cc-logo" />;
        }
        // Return emoji as-is
        return <span style={{ fontSize: size * 0.9 }}>{icon}</span>;
    };
    
    // Helper for native <option> elements that can't render components
    const getAppEmoji = (icon) => {
        if (icon === 'cc-logo') return 'â¬¡'; // Fallback for CC hexagonal logo
        return icon || 'ðŸ“¦';
    };

    // =========================================================================
    // UTILITIES
    // =========================================================================
    
    function parseFilename(filename) {
        const patterns = [
            /^(gameshelf|game[-_]?shelf)[-_]v?(\d+)[_.](\d+)[_.](\d+)[_.](\d+)\.html$/i,
            /^(\w+)[-_]v?(\d+)[_.](\d+)[_.](\d+)\.html$/i,
        ];
        for (const pattern of patterns) {
            const match = filename.match(pattern);
            if (match) {
                let app = match[1].toLowerCase().replace(/[-_]/g, '');
                const version = match.length === 6 
                    ? `${match[2]}.${match[3]}.${match[4]}.${match[5]}`
                    : `${match[2]}.${match[3]}.${match[4]}`;
                return { app, version };
            }
        }
        const appMatch = filename.match(/^(\w+)/);
        return { app: appMatch ? appMatch[1].toLowerCase() : null, version: null };
    }
    
    // Detect app from HTML content
    // Primary: Explicit gs-app-id meta tag (definitive, permanent)
    // Fallback: Pattern matching for legacy files
    function detectAppFromContent(content) {
        if (!content || typeof content !== 'string') return null;
        
        // =====================================================================
        // PRIMARY: Check for explicit app identifier (100% reliable)
        // Format: <meta name="gs-app-id" content="appname">
        // =====================================================================
        const appIdMatch = content.match(/<meta\s+name=["']gs-app-id["']\s+content=["']([^"']+)["']/i);
        if (appIdMatch) {
            const appId = appIdMatch[1].toLowerCase();
            return {
                id: appId,
                confidence: 'definite',
                method: 'gs-app-id',
                matchCount: 1,
                matchedPatterns: ['gs-app-id meta tag']
            };
        }
        
        // =====================================================================
        // SECONDARY: Dynamic patterns from app config (user-configurable)
        // Scores all apps and picks the best (most matches) to avoid
        // broad patterns shadowing specific ones (e.g. "rungs" vs "rungs builder")
        // =====================================================================
        const allApps = window.__CC_APPS || {};
        const dynamicCandidates = [];
        
        for (const [appId, app] of Object.entries(allApps)) {
            const patterns = app.detectionPatterns || [];
            if (!patterns.length) continue;
            
            let matchCount = 0;
            let matchedPatterns = [];
            let totalPatternLength = 0;
            
            for (const pat of patterns) {
                try {
                    const regex = new RegExp(pat, 'i');
                    if (regex.test(content)) {
                        matchCount++;
                        matchedPatterns.push(pat);
                        totalPatternLength += pat.length;
                    }
                } catch (e) { /* skip invalid regex */ }
            }
            
            if (matchCount > 0) {
                dynamicCandidates.push({
                    id: appId,
                    confidence: matchCount >= 2 ? 'high' : 'medium',
                    method: 'dynamic-pattern',
                    matchCount,
                    matchedPatterns,
                    // Specificity score: prefer more matches, then longer patterns
                    specificity: matchCount * 1000 + totalPatternLength
                });
            }
        }
        
        if (dynamicCandidates.length > 0) {
            // Pick the most specific match
            dynamicCandidates.sort((a, b) => b.specificity - a.specificity);
            const best = dynamicCandidates[0];
            return {
                id: best.id,
                confidence: best.confidence,
                method: best.method,
                matchCount: best.matchCount,
                matchedPatterns: best.matchedPatterns
            };
        }
        
        // =====================================================================
        // FALLBACK: Hardcoded pattern matching for legacy files without gs-app-id
        // This can be removed once all apps have the meta tag
        // =====================================================================
        const sample = content.substring(0, 5000).toLowerCase();
        
        // Legacy signatures - ordered by specificity
        const signatures = [
            {
                id: 'command-center',
                patterns: [
                    /<title>.*command\s*center/i,
                    /<title>.*ship\s*it/i,
                    /command-center/i,
                    /claude.*deploy.*queue/i
                ]
            },
            {
                id: 'beta',
                patterns: [
                    /<title>game\s*shelf\s*beta\s*hub/i,
                    /beta\s*hub\s*v\d/i,
                    /gs-app-id.*beta/i,
                    /earlyAccess.*surveyResponses/i
                ]
            },
            {
                id: 'landing',
                patterns: [
                    /track\s*every\s*daily\s*puzzle/i,
                    /join\s*the\s*beta/i,
                    /cta-button/i,
                    /<h1[^>]*>GAME\s*SHELF<\/h1>/i
                ]
            },
            {
                id: 'gameshelf',
                patterns: [
                    /gameshelfdata/i,
                    /game\.shelf\.pwa/i,
                    /#setup-welcome/i,
                    /APP_VERSION\s*=/i
                ]
            },
            {
                id: 'testplan',
                patterns: [
                    /<title>.*test\s*plan/i,
                    /playwright.*runner/i,
                    /lean-tests\.spec/i
                ]
            },
            {
                id: 'quotle',
                patterns: [
                    /<title>quotle/i,
                    /quotle.*daily.*quote/i,
                    /quotes-database/i
                ]
            },
            {
                id: 'slate',
                patterns: [
                    /<title>slate/i,
                    /slate.*daily.*word/i,
                    /chalkboard-bg/i
                ]
            },
            {
                id: 'rungs',
                patterns: [
                    /<title>rungs/i,
                    /rungs.*daily/i,
                    /word-ladder/i
                ]
            },
            {
                id: 'wordboxing',
                patterns: [
                    /<title>word\s*boxing/i,
                    /word-boxing/i,
                    /boxing-ring/i
                ]
            },
            {
                id: 'edutrack',
                patterns: [
                    /<title>edutrack/i,
                    /edutrack-data/i,
                    /ET-[A-Z]{2}-\d{3}/,
                    /student-codes/i
                ]
            },
            {
                id: 'firebase-functions',
                patterns: [
                    /firebase-functions/i,
                    /exports\.getHint/i,
                    /onRequest|onCall/i,
                    /ANTHROPIC_API_KEY/i
                ]
            }
        ];
        
        // Check each app's signatures
        for (const app of signatures) {
            let matchCount = 0;
            let matchedPatterns = [];
            
            for (const pattern of app.patterns) {
                if (pattern.test(content)) {
                    matchCount++;
                    matchedPatterns.push(pattern.toString());
                }
            }
            
            if (matchCount > 0) {
                return {
                    id: app.id,
                    confidence: matchCount >= 2 ? 'high' : 'medium',
                    method: 'pattern-match',
                    matchCount,
                    matchedPatterns
                };
            }
        }
        
        return null;
    }
    
    function formatBytes(bytes) {
        if (bytes < 1024) return bytes + ' B';
        if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + ' KB';
        return (bytes / (1024 * 1024)).toFixed(2) + ' MB';
    }
    
    function formatDate(date) {
        return new Date(date).toLocaleString();
    }
    
    // Get the URL for a GitHub Pages site
    // Supports custom domains and subPaths for consolidated repos
    function getGitHubPagesUrl(repo, subPath = '') {
        if (!repo) return null;
        const [owner, repoName] = repo.split('/');
        
        // Check for custom domain
        if (CUSTOM_DOMAINS[repo]) {
            const domain = CUSTOM_DOMAINS[repo];
            // Custom domain - subPath goes after domain
            if (subPath) {
                return `https://${domain}/${subPath}/`;
            }
            return `https://${domain}/`;
        }
        
        // Standard GitHub Pages URL
        if (subPath) {
            return `https://${owner}.github.io/${repoName}/${subPath}/`;
        }
        return `https://${owner}.github.io/${repoName}/`;
    }
    
    // v8.71.0: getSatelliteUrl removed (satellites eliminated â€” Phase 4)

    // Helper to get effective subPath (falls back to defaults if stored value is empty)
    function getEffectiveSubPath(app, appId) {
        return app.subPath || '';
    }
    
    // Helper to get full file path in repo (prepends subPath if needed)
        // v8.70.15: Removed getRepoFilePath
    
    function autoMapRepos(apps, repos) {
        const updatedApps = { ...apps };
        console.log('Auto-mapping repos. Available:', repos.map(r => r.name));
        
        for (const [appId, app] of Object.entries(updatedApps)) {
            const patterns = app.repoPatterns;
            if (!patterns) continue;
            
            if (!app.testRepo && patterns.test) {
                for (const pattern of patterns.test) {
                    const found = repos.find(r => r.name.toLowerCase() === pattern.toLowerCase());
                    if (found) { 
                        console.log(`[${appId}] Mapped TEST: ${found.fullName}`);
                        updatedApps[appId] = { ...updatedApps[appId], testRepo: found.fullName }; 
                        break; 
                    }
                }
            }
            if (!app.prodRepo && patterns.prod) {
                for (const pattern of patterns.prod) {
                    const found = repos.find(r => r.name.toLowerCase() === pattern.toLowerCase() && !r.name.toLowerCase().includes('test'));
                    if (found) { 
                        console.log(`[${appId}] Mapped PROD: ${found.fullName}`);
                        updatedApps[appId] = { ...updatedApps[appId], prodRepo: found.fullName }; 
                        break; 
                    }
                }
            }
        }
        return updatedApps;
    }
    
    // v8.8.0: Group apps by project
    function getProjectsWithApps(apps, projects, filterFn = null) {
        const projectMap = {};
        const projectDefs = projects || SEED_PROJECTS;
        const appList = Object.values(apps).filter(a => (a.testRepo || a.prodRepo) && (!filterFn || filterFn(a)));
        
        for (const app of appList) {
            const projId = app.project || 'other';
            if (!projectMap[projId]) {
                const projDef = projectDefs[projId] || projectDefs['other'] || { id: projId, name: projId, icon: 'ðŸ“¦', color: 'slate', order: 98 };
                projectMap[projId] = { ...projDef, id: projId, apps: [] };
            }
            projectMap[projId].apps.push(app);
        }
        
        // Sort projects by order, then apps within each project by name
        return Object.values(projectMap)
            .sort((a, b) => (a.order || 99) - (b.order || 99))
            .map(p => ({ ...p, apps: p.apps.sort((a, b) => a.name.localeCompare(b.name)) }));
    }
    
    // Project color classes
    const PROJECT_COLORS = {
        indigo: { bg: 'bg-indigo-600/15', border: 'border-indigo-500/30', text: 'text-indigo-400', accent: 'bg-indigo-600' },
        rose: { bg: 'bg-rose-600/15', border: 'border-rose-500/30', text: 'text-rose-400', accent: 'bg-rose-600' },
        emerald: { bg: 'bg-emerald-600/15', border: 'border-emerald-500/30', text: 'text-emerald-400', accent: 'bg-emerald-600' },
        amber: { bg: 'bg-amber-600/15', border: 'border-amber-500/30', text: 'text-amber-400', accent: 'bg-amber-600' },
        slate: { bg: 'bg-slate-600/15', border: 'border-slate-500/30', text: 'text-slate-400', accent: 'bg-slate-600' },
        cyan: { bg: 'bg-cyan-600/15', border: 'border-cyan-500/30', text: 'text-cyan-400', accent: 'bg-cyan-600' },
        purple: { bg: 'bg-purple-600/15', border: 'border-purple-500/30', text: 'text-purple-400', accent: 'bg-purple-600' }
    };
    
    function getProjectColor(color) {
        return PROJECT_COLORS[color] || PROJECT_COLORS.slate;
    }

    function getFileIcon(filename) {
        const ext = filename.split('.').pop()?.toLowerCase();
        const icons = {
            html: 'ðŸ“„', js: 'ðŸ“œ', css: 'ðŸŽ¨', json: 'ðŸ“‹', md: 'ðŸ“',
            png: 'ðŸ–¼ï¸', jpg: 'ðŸ–¼ï¸', jpeg: 'ðŸ–¼ï¸', gif: 'ðŸ–¼ï¸', svg: 'ðŸŽ¨',
            ico: 'ðŸ”·', txt: 'ðŸ“ƒ', xml: 'ðŸ“°', yml: 'âš™ï¸', yaml: 'âš™ï¸'
        };
        return icons[ext] || 'ðŸ“„';
    }

    // =========================================================================
    // GITHUB API
    // =========================================================================
    
    class GitHubAPI {
        constructor(token) {
            this.token = token;
            this.baseUrl = 'https://api.github.com';
        }
        
        // Helper: Clean base64 content from GitHub (remove newlines)
        cleanBase64(content) {
            return content ? content.replace(/[\r\n\s]/g, '') : '';
        }
        
        // Helper: Decode base64 content from GitHub to UTF-8 string
        decodeContent(content) {
            const clean = this.cleanBase64(content);
            return decodeURIComponent(escape(atob(clean)));
        }
        
        async request(endpoint, options = {}, retries = 0) {
            const url = `${this.baseUrl}${endpoint}`;
            const maxRetries = options._maxRetries ?? 3;
            try {
                const response = await fetch(url, {
                    ...options,
                    headers: {
                        'Authorization': `token ${this.token}`,
                        'Accept': 'application/vnd.github.v3+json',
                        'Content-Type': 'application/json',
                        ...options.headers
                    }
                });
                
                // Track rate limit from response headers
                const remaining = response.headers.get('X-RateLimit-Remaining');
                const limit = response.headers.get('X-RateLimit-Limit');
                const resetTime = response.headers.get('X-RateLimit-Reset');
                
                if (remaining !== null) {
                    this.rateLimit = { remaining: parseInt(remaining), limit: parseInt(limit), resetTime: parseInt(resetTime) * 1000 };
                    if (parseInt(remaining) < 100) {
                        console.warn(`âš ï¸ GitHub API rate limit low: ${remaining}/${limit} remaining. Resets at ${new Date(this.rateLimit.resetTime).toLocaleTimeString()}`);
                    }
                }
                
                // Handle rate limit exceeded
                if (response.status === 403 && remaining === '0') {
                    const resetDate = new Date(parseInt(resetTime) * 1000);
                    throw new Error(`GitHub API rate limit exceeded. Resets at ${resetDate.toLocaleTimeString()}. Please wait and try again.`);
                }
                
                // Retry on 400/502/503 (transient GitHub errors)
                if ((response.status === 400 || response.status === 502 || response.status === 503) && retries < maxRetries) {
                    const delay = Math.min(1000 * Math.pow(2, retries), 8000); // 1s, 2s, 4s, 8s
                    console.warn(`âš ï¸ GitHub API ${response.status} on ${endpoint} â€” retry ${retries + 1}/${maxRetries} in ${delay}ms`);
                    await new Promise(r => setTimeout(r, delay));
                    return this.request(endpoint, options, retries + 1);
                }
                
                if (!response.ok) {
                    const error = await response.json().catch(() => ({}));
                    // Suppress 404 logging for expected "not found" responses (e.g., repos without cc/completions/)
                    if (!(response.status === 404 && options._suppress404)) {
                        console.error('GitHub API Error:', {
                            url,
                            status: response.status,
                            error,
                            body: options.body ? JSON.parse(options.body) : null
                        });
                    }
                    throw new Error(error.message || `GitHub API error: ${response.status}`);
                }
                return response.json();
            } catch (e) {
                // Retry on network errors (TypeError: Load failed, CORS issues)
                if (e instanceof TypeError && retries < maxRetries) {
                    const delay = Math.min(1000 * Math.pow(2, retries), 8000);
                    console.warn(`âš ï¸ Network error on ${endpoint} â€” retry ${retries + 1}/${maxRetries} in ${delay}ms: ${e.message}`);
                    await new Promise(r => setTimeout(r, delay));
                    return this.request(endpoint, options, retries + 1);
                }
                console.error('Request failed:', url, e);
                throw e;
            }
        }
        
        // Get current rate limit status
        getRateLimit() {
            return this.rateLimit || { remaining: null, limit: null, resetTime: null };
        }
        
        // Check if user has push (write) access to a repo
        async checkPushAccess(repo) {
            try {
                const [owner, repoName] = repo.split('/');
                const data = await this.request(`/repos/${owner}/${repoName}`);
                return data?.permissions?.push === true;
            } catch (e) {
                // 404 = repo doesn't exist or no access at all
                return false;
            }
        }

        // Check if a file exists in a repo (returns true/false)
        async fileExists(repo, path) {
            try {
                const [owner, repoName] = repo.split('/');
                await this.request(`/repos/${owner}/${repoName}/contents/${path}?_=${Date.now()}`);
                return true;
            } catch {
                return false;
            }
        }

        async listRepos() {
            const repos = await this.request('/user/repos?per_page=100&sort=updated');
            return repos.map(r => ({ fullName: r.full_name, name: r.name, owner: r.owner.login }));
        }
        
        async getFile(repo, path) {
            try {
                const [owner, repoName] = repo.split('/');
                // Add timestamp to bust GitHub API cache
                return await this.request(`/repos/${owner}/${repoName}/contents/${path}?_=${Date.now()}`, { _suppress404: true });
            } catch { return null; }
        }
        
        // Get file content - handles large files (>1MB) that GitHub API doesn't return content for
        async getFileContent(repo, path) {
            try {
                const file = await this.getFile(repo, path);
                if (!file) return null;
                
                // For large files (>1MB), GitHub API doesn't return content - use download_url
                if (!file.content && file.download_url) {
                    console.log(`Large file detected (${path}), using download_url`);
                    // Add cache-busting to download_url
                    const cacheBustUrl = file.download_url + (file.download_url.includes('?') ? '&' : '?') + '_=' + Date.now();
                    const response = await fetch(cacheBustUrl);
                    const content = await response.text();
                    return { ...file, content: null, textContent: content };
                }
                
                // Normal file - decode base64 content
                const textContent = this.decodeContent(file.content);
                return { ...file, textContent };
            } catch (e) {
                console.warn(`Failed to get file content for ${path}:`, e);
                return null;
            }
        }
        
        // Get file content at specific commit - handles large files
        // v8.70.15: Removed getFileContentAtCommit
        
        // Get blob content directly via Git Blob API - bypasses CDN caching
        async getBlobContent(repo, sha) {
            try {
                const [owner, repoName] = repo.split('/');
                const blob = await this.request(`/repos/${owner}/${repoName}/git/blobs/${sha}?_=${Date.now()}`);
                if (blob && blob.content) {
                    return {
                        content: blob.content,
                        encoding: blob.encoding,
                        size: blob.size
                    };
                }
                return null;
            } catch (e) {
                console.warn(`Failed to get blob ${sha}:`, e);
                return null;
            }
        }
        
        async listRepoContents(repo, path = '') {
            try {
                const [owner, repoName] = repo.split('/');
                const endpoint = path
                    ? `/repos/${owner}/${repoName}/contents/${path}`
                    : `/repos/${owner}/${repoName}/contents`;
                // Add timestamp to bust any caching
                const cacheBuster = `?_=${Date.now()}`;
                const contents = await this.request(endpoint + cacheBuster, { _suppress404: true });
                return Array.isArray(contents) ? contents : [contents];
            } catch { return []; }
        }
        
        
        async createOrUpdateFile(repo, path, content, message, sha = null, branch = 'main') {
            const [owner, repoName] = repo.split('/');
            const body = {
                message,
                content: btoa(unescape(encodeURIComponent(content))),
                committer: { name: 'Command Center', email: 'deploy@gameshelf.app' },
                branch
            };
            if (sha) body.sha = sha;
            
            const url = `/repos/${owner}/${repoName}/contents/${path}`;
            console.log('createOrUpdateFile request:', { 
                url,
                repo, 
                path, 
                sha, 
                branch,
                messageLength: message.length, 
                contentLength: content.length,
                base64Length: body.content.length
            });
            
            try {
                return await this.request(url, { method: 'PUT', body: JSON.stringify(body) });
            } catch (error) {
                console.error('createOrUpdateFile failed:', {
                    url,
                    error: error.message,
                    sha,
                    bodyPreview: JSON.stringify(body).substring(0, 200)
                });
                throw error;
            }
        }
        
        async deleteFile(repo, path, message, sha) {
            const [owner, repoName] = repo.split('/');
            return this.request(`/repos/${owner}/${repoName}/contents/${path}`, {
                method: 'DELETE',
                body: JSON.stringify({
                    message,
                    sha,
                    committer: { name: 'Command Center', email: 'deploy@gameshelf.app' }
                })
            });
        }
        
        // v8.70.15: Removed createTag
        
        async enablePages(repo) {
            const [owner, repoName] = repo.split('/');
            try {
                await this.request(`/repos/${owner}/${repoName}/pages`);
                return { alreadyEnabled: true };
            } catch {}
            const response = await fetch(`${this.baseUrl}/repos/${owner}/${repoName}/pages`, {
                method: 'POST',
                headers: { 'Authorization': `token ${this.token}`, 'Accept': 'application/vnd.github.v3+json', 'Content-Type': 'application/json' },
                body: JSON.stringify({ source: { branch: 'main', path: '/' } })
            });
            if (!response.ok) throw new Error(`Failed to enable Pages`);
            return { enabled: true };
        }

        // v8.71.0: Custom domain configuration for GitHub Pages (ported from Infrastructure satellite)
        async updatePagesConfig(repo, cname, enforceHttps = false) {
            const [owner, repoName] = repo.split('/');
            const response = await fetch(`${this.baseUrl}/repos/${owner}/${repoName}/pages`, {
                method: 'PUT',
                headers: { 'Authorization': `token ${this.token}`, 'Accept': 'application/vnd.github.v3+json', 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    cname: cname,
                    https_enforced: enforceHttps,
                    source: { branch: 'main', path: '/' }
                })
            });
            if (!response.ok) {
                const err = await response.json().catch(() => ({}));
                throw new Error(err.message || `Failed to update Pages config (${response.status})`);
            }
            return await response.json();
        }

        // v8.71.0: Check GitHub Pages health/DNS status (ported from Infrastructure satellite)
        async checkPagesHealth(repo) {
            const [owner, repoName] = repo.split('/');
            const response = await fetch(`${this.baseUrl}/repos/${owner}/${repoName}/pages/health`, {
                headers: { 'Authorization': `token ${this.token}`, 'Accept': 'application/vnd.github.v3+json' }
            });
            if (response.status === 202) return { pending: true };
            if (!response.ok) {
                const err = await response.json().catch(() => ({}));
                throw new Error(err.message || `Pages health check failed (${response.status})`);
            }
            return await response.json();
        }

        // Get recent workflow runs for a repo
        // v8.70.15: Removed getWorkflowRuns + getWorkflowRun + getWorkflowRunLogsUrl + waitForWorkflowRun + findRecentWorkflowRun + batchCommit

        // v8.69.7: Check if a repository exists
        async repoExists(owner, repoName) {
            try {
                await this.request(`/repos/${owner}/${repoName}`);
                return true;
            } catch (e) {
                // request() throws "Not Found" for 404, or "GitHub API error: 404"
                if (e.message && (e.message.includes('Not Found') || e.message.includes('404'))) return false;
                // For non-404 errors (rate limit, auth), re-throw
                throw e;
            }
        }

        // v8.69.7: Create a new repository
        async createRepo(repoName, description = '', isPrivate = false) {
            const result = await this.request('/user/repos', {
                method: 'POST',
                body: JSON.stringify({
                    name: repoName,
                    description,
                    private: isPrivate,
                    auto_init: true
                })
            });
            return { fullName: result.full_name, htmlUrl: result.html_url, ...result };
        }

        // Phase 3: List recent commits for orphan detection
        async listRecentCommits(repo, perPage = 30) {
            const [owner, repoName] = repo.split('/');
            return await this.request(`/repos/${owner}/${repoName}/commits?per_page=${perPage}&_=${Date.now()}`);
        }

        // Phase 3: Get single commit details (includes files changed)
        async getCommitDetail(repo, sha) {
            const [owner, repoName] = repo.split('/');
            return await this.request(`/repos/${owner}/${repoName}/commits/${sha}`);
        }
    }

    // =========================================================================
    // ODRC CONCEPT SYSTEM (Ideation Platform v1)
    // =========================================================================

    // Valid ODRC types
    const ODRC_TYPES = ['OPEN', 'DECISION', 'RULE', 'CONSTRAINT'];

    // Valid concept statuses
    const CONCEPT_STATUSES = ['active', 'superseded', 'resolved', 'transitioned'];

    // State machine: maps current type to array of valid target types
    const ODRC_TRANSITIONS = {
        'OPEN':       ['DECISION', 'RULE', 'CONSTRAINT'],
        'DECISION':   ['RULE'],
        'CONSTRAINT': ['DECISION', 'RULE'],
        'RULE':       ['OPEN']
    };

    // Validate a type transition is allowed
    function isValidODRCTransition(fromType, toType) {
        if (!ODRC_TRANSITIONS[fromType]) return false;
        return ODRC_TRANSITIONS[fromType].includes(toType);
    }

    // Concept (ODRC) display styles â€” used by ProjectsDrillDown
    const CONCEPT_TYPE_STYLES = {
        'RULE':       { color: 'bg-red-900/50 text-red-300 border-red-800/50', icon: 'ðŸ“' },
        'CONSTRAINT': { color: 'bg-amber-900/50 text-amber-300 border-amber-800/50', icon: 'ðŸ”’' },
        'DECISION':   { color: 'bg-blue-900/50 text-blue-300 border-blue-800/50', icon: 'ðŸŽ¯' },
        'OPEN':       { color: 'bg-purple-900/50 text-purple-300 border-purple-800/50', icon: 'â“' }
    };
    const CONCEPT_STATUS_STYLES = {
        'active': 'bg-green-900/50 text-green-300',
        'built': 'bg-emerald-900/50 text-emerald-300',
        'superseded': 'bg-slate-700 text-slate-400 line-through',
        'resolved': 'bg-emerald-900/50 text-emerald-300',
        'transitioned': 'bg-indigo-900/50 text-indigo-300'
    };

    // ODRC Concept Manager â€” Firebase CRUD + state machine
    const ConceptManager = {
        // Get Firebase ref for concepts under a user
        _ref(uid) {
            return firebaseDb.ref(`command-center/${uid}/concepts`);
        },

        // Create a new concept
        async create(uid, { type, content, ideaOrigin, scopeTags = [] }) {
            if (!ODRC_TYPES.includes(type)) {
                throw new Error(`Invalid concept type: ${type}. Must be one of: ${ODRC_TYPES.join(', ')}`);
            }
            const ref = this._ref(uid).push();
            const now = new Date().toISOString();
            const concept = {
                id: ref.key,
                type,
                content,
                ideaOrigin,
                status: 'active',
                resolvedBy: null,
                transitionedFrom: null,
                scopeTags,
                createdAt: now,
                updatedAt: now
            };
            await ref.set(concept);
            return concept;
        },

        // Read all concepts for a user
        async getAll(uid) {
            const snapshot = await this._ref(uid).once('value');
            const data = snapshot.val();
            if (!data) return [];
            return Object.values(data);
        },

        // Read concepts filtered by ideaOrigin
        async getByIdea(uid, ideaId) {
            const all = await this.getAll(uid);
            return all.filter(c => c.ideaOrigin === ideaId);
        },

        // Read all active concepts for an app (across all its ideas)
        async getActiveForApp(uid, ideaIds) {
            const all = await this.getAll(uid);
            return all.filter(c => ideaIds.includes(c.ideaOrigin) && c.status === 'active');
        },

        // Update a concept's content, scopeTags, or other editable fields
        async update(uid, conceptId, updates) {
            const allowed = ['content', 'scopeTags'];
            const filtered = {};
            for (const key of allowed) {
                if (updates[key] !== undefined) filtered[key] = updates[key];
            }
            filtered.updatedAt = new Date().toISOString();
            await this._ref(uid).child(conceptId).update(filtered);
            return filtered;
        },

        // Transition a concept to a new type (follows state machine)
        // Creates a new concept of the target type and marks the original as transitioned
        async transition(uid, conceptId, newType) {
            if (!ODRC_TYPES.includes(newType)) {
                throw new Error(`Invalid target type: ${newType}`);
            }

            // Fetch current concept
            const snapshot = await this._ref(uid).child(conceptId).once('value');
            const concept = snapshot.val();
            if (!concept) throw new Error(`Concept not found: ${conceptId}`);
            if (concept.status !== 'active') throw new Error(`Cannot transition non-active concept (status: ${concept.status})`);

            if (!isValidODRCTransition(concept.type, newType)) {
                throw new Error(`Invalid transition: ${concept.type} â†’ ${newType}. Allowed: ${ODRC_TRANSITIONS[concept.type].join(', ')}`);
            }

            const now = new Date().toISOString();

            // Create the new concept (inherits content, scopeTags, ideaOrigin)
            const newRef = this._ref(uid).push();
            const newConcept = {
                id: newRef.key,
                type: newType,
                content: concept.content,
                ideaOrigin: concept.ideaOrigin,
                status: 'active',
                resolvedBy: null,
                transitionedFrom: conceptId,
                scopeTags: concept.scopeTags || [],
                createdAt: now,
                updatedAt: now
            };

            // Mark old concept as transitioned
            const oldUpdate = {
                status: 'transitioned',
                resolvedBy: newRef.key,
                updatedAt: now
            };

            // If a CONSTRAINT transitions, flag related concepts for review
            let flaggedConcepts = [];
            if (concept.type === 'CONSTRAINT' && concept.scopeTags && concept.scopeTags.length > 0) {
                flaggedConcepts = await this._flagRelatedConcepts(uid, concept.scopeTags, conceptId);
            }

            // Write both atomically via multi-path update
            const updates = {};
            updates[`${conceptId}/status`] = oldUpdate.status;
            updates[`${conceptId}/resolvedBy`] = oldUpdate.resolvedBy;
            updates[`${conceptId}/updatedAt`] = oldUpdate.updatedAt;
            updates[newRef.key] = newConcept;
            await this._ref(uid).update(updates);

            return { newConcept, flaggedConcepts };
        },

        // Flag active DECISIONs and RULEs that share scope tags with a transitioning CONSTRAINT
        async _flagRelatedConcepts(uid, scopeTags, excludeConceptId) {
            const all = await this.getAll(uid);
            const flagged = [];
            for (const c of all) {
                if (c.id === excludeConceptId) continue;
                if (c.status !== 'active') continue;
                if (c.type !== 'DECISION' && c.type !== 'RULE') continue;
                const hasOverlap = (c.scopeTags || []).some(tag => scopeTags.includes(tag));
                if (hasOverlap) {
                    flagged.push(c);
                }
            }
            return flagged;
        },

        // Supersede a concept (replace it with a new one, same type)
        async supersede(uid, conceptId, newContent) {
            const snapshot = await this._ref(uid).child(conceptId).once('value');
            const concept = snapshot.val();
            if (!concept) throw new Error(`Concept not found: ${conceptId}`);

            const now = new Date().toISOString();
            const newRef = this._ref(uid).push();
            const newConcept = {
                id: newRef.key,
                type: concept.type,
                content: newContent,
                ideaOrigin: concept.ideaOrigin,
                status: 'active',
                resolvedBy: null,
                transitionedFrom: conceptId,
                scopeTags: concept.scopeTags || [],
                createdAt: now,
                updatedAt: now
            };

            const updates = {};
            updates[`${conceptId}/status`] = 'superseded';
            updates[`${conceptId}/resolvedBy`] = newRef.key;
            updates[`${conceptId}/updatedAt`] = now;
            updates[newRef.key] = newConcept;
            await this._ref(uid).update(updates);

            return newConcept;
        },

        // Resolve a concept (typically an OPEN â€” mark as resolved without transitioning)
        async resolve(uid, conceptId) {
            const now = new Date().toISOString();
            await this._ref(uid).child(conceptId).update({
                status: 'resolved',
                updatedAt: now
            });
        },

        // Delete a concept
        async remove(uid, conceptId) {
            await this._ref(uid).child(conceptId).remove();
        },

        // v8.71.4: added limitToLast(50) â€” was unbounded, downloading ALL concepts on every change
        // CLAUDE.md generation and aggregate views should use dedicated .once() reads
        listen(uid, callback) {
            const ref = this._ref(uid);
            const query = ref.orderByChild('updatedAt').limitToLast(50);
            const handler = (snapshot) => {
                const data = snapshot.val();
                callback(data ? Object.values(data) : []);
            };
            query.on('value', handler);
            return () => query.off('value', handler);
        }
    };

    // =========================================================================
    // IDEA MANAGEMENT SYSTEM (Ideation Platform v1)
    // =========================================================================

    // Valid idea statuses
    const IDEA_STATUSES = ['active', 'graduated', 'archived'];

    // Valid idea types
    const IDEA_TYPES = ['base', 'addon'];

    // Idea Manager â€” Firebase CRUD + App relationship
    const IdeaManager = {
        // Get Firebase ref for ideas under a user
        _ref(uid) {
            return firebaseDb.ref(`command-center/${uid}/ideas`);
        },

        // Generate kebab-case slug from idea name
        generateSlug(name) {
            return name
                .toLowerCase()
                .replace(/[^a-z0-9\s-]/g, '')
                .replace(/\s+/g, '-')
                .replace(/-+/g, '-')
                .substring(0, 60);
        },

        // Generate unique slug within an app scope
        async _uniqueSlug(uid, name, appId) {
            const base = this.generateSlug(name);
            if (!appId) return base;
            const appIdeas = await this.getByApp(uid, appId);
            const existing = appIdeas.map(i => i.slug).filter(Boolean);
            if (!existing.includes(base)) return base;
            let counter = 2;
            while (existing.includes(`${base}-${counter}`)) counter++;
            return `${base}-${counter}`;
        },

        // Add session log entry â€” call after ODRC import
        // v8.66.0: Accepts enriched fields from session.json (chain, debriefSummary, nextSession)
        async addSessionLogEntry(uid, ideaId, entry) {
            const snapshot = await this._ref(uid).child(ideaId).once('value');
            const idea = snapshot.val();
            if (!idea) throw new Error(`Idea not found: ${ideaId}`);
            const sessionLog = idea.sessionLog || [];
            sessionLog.push({
                sessionId: entry.sessionId,
                date: entry.date,
                docPath: entry.docPath || null,
                summary: entry.summary,
                conceptsCreated: entry.conceptsCreated,
                conceptsResolved: entry.conceptsResolved,
                type: entry.type || 'exploration',
                chain: entry.chain || null,
                debriefSummary: entry.debriefSummary || null,
                nextSession: entry.nextSession || null,
                schemaVersion: entry.schemaVersion || null,
                // v8.67.0: Session lifecycle fields
                status: entry.status || null,
                completedAt: entry.completedAt || null,
                ideaPhaseAtStart: entry.ideaPhaseAtStart || null,
                ideaPhaseAtEnd: entry.ideaPhaseAtEnd || null
            });
            await this._ref(uid).child(ideaId).update({
                sessionLog,
                lastSessionDate: entry.date,
                updatedAt: new Date().toISOString()
            });
            console.log('[CC] Added session log entry:', entry.sessionId, 'to idea:', ideaId);
        },

        // v8.67.0: Phase advancement
        async advancePhase(uid, ideaId, newPhase) {
            const validPhases = ['inception', 'exploring', 'converging', 'spec-ready', 'complete'];
            if (!validPhases.includes(newPhase)) throw new Error(`Invalid phase: ${newPhase}`);
            await this._ref(uid).child(ideaId).update({
                phase: newPhase,
                phaseUpdatedAt: new Date().toISOString()
            });
            console.log(`[CC] Idea ${ideaId} phase â†’ ${newPhase}`);
        },

        // v8.67.0: Session lifecycle â€” activate
        async activateSession(uid, ideaId, sessionData) {
            const ideaRef = this._ref(uid).child(ideaId);
            const snap = await ideaRef.child('activeSession').once('value');
            if (snap.val()) throw new Error('Idea already has an active session');
            const now = new Date().toISOString();
            await ideaRef.update({
                activeSession: {
                    sessionId: sessionData.sessionId,
                    status: 'active',
                    createdAt: now,
                    lastActivityAt: now,
                    briefDownloaded: false,
                    artifactsReceived: 0,
                    ideaPhaseAtStart: sessionData.ideaPhaseAtStart
                },
                updatedAt: now // v8.69.3: Bump updatedAt so idea sorts as recent
            });
            console.log(`[CC] Session ${sessionData.sessionId} activated on idea ${ideaId}`);
        },

        // v8.67.0: Session lifecycle â€” complete
        async completeSession(uid, ideaId) {
            await this._ref(uid).child(ideaId).update({
                activeSession: null,
                updatedAt: new Date().toISOString() // v8.69.3: Bump updatedAt on completion
            });
        },

        // v8.67.0: Session lifecycle â€” abandon
        async abandonSession(uid, ideaId, sessionId) {
            const abandonedEntry = {
                sessionId,
                date: Date.now(),
                summary: 'Session abandoned',
                conceptsCreated: 0,
                conceptsResolved: 0,
                type: 'abandoned',
                status: 'abandoned',
                completedAt: new Date().toISOString()
            };
            await this.addSessionLogEntry(uid, ideaId, abandonedEntry);
            await this._ref(uid).child(ideaId).child('activeSession').set(null);
            console.log(`[CC] Session ${sessionId} abandoned on idea ${ideaId}`);
        },

        // v8.67.0: Session lifecycle â€” update activity
        async updateSessionActivity(uid, ideaId, updates) {
            await this._ref(uid).child(ideaId).child('activeSession').update({
                ...updates,
                lastActivityAt: new Date().toISOString()
            });
        },

        // v8.69.0: Store debrief for a session
        async storeDebrief(uid, ideaId, sessionId, debrief) {
            await this._ref(uid).child(ideaId)
                .child('debriefs').child(sessionId).set({
                    summary: debrief.summary,
                    content: debrief.content,
                    nextSession: debrief.nextSession,
                    storedAt: new Date().toISOString()
                });
            console.log(`[CC] Stored debrief for ${sessionId} on idea ${ideaId}`);
        },

        // Create a new idea
        async create(uid, { name, description, type = 'base', appId = null, parentIdeaId = null, projectId = null }) {
            if (!IDEA_TYPES.includes(type)) {
                throw new Error(`Invalid idea type: ${type}. Must be one of: ${IDEA_TYPES.join(', ')}`);
            }

            // Calculate sequence number
            let sequence = 1;
            if (appId) {
                const appIdeas = await this.getByApp(uid, appId);
                sequence = appIdeas.length > 0 ? Math.max(...appIdeas.map(i => i.sequence || 0)) + 1 : 1;
            }

            // Auto-generate unique slug
            const slug = await this._uniqueSlug(uid, name, appId);

            const ref = this._ref(uid).push();
            const now = new Date().toISOString();
            const idea = {
                id: ref.key,
                name,
                description,
                slug,
                type,
                appId,
                parentIdeaId,
                projectId,
                sequence,
                status: 'active',
                sessionLog: [],
                lastSessionDate: null,
                phase: 'inception',
                phaseUpdatedAt: now,
                activeSession: null,
                createdAt: now,
                updatedAt: now
            };
            await ref.set(idea);

            // If linked to an app, update the app's ideas reference
            if (appId) {
                await this._addIdeaToApp(uid, appId, ref.key);
            }

            return idea;
        },

        // Read all ideas for a user
        async getAll(uid) {
            const snapshot = await this._ref(uid).once('value');
            const data = snapshot.val();
            if (!data) return [];
            return Object.values(data);
        },

        // Read ideas for a specific app, ordered by sequence
        async getByApp(uid, appId) {
            const all = await this.getAll(uid);
            return all
                .filter(i => i.appId === appId)
                .sort((a, b) => (a.sequence || 0) - (b.sequence || 0));
        },

        // Get the latest active idea for an app
        async getActiveForApp(uid, appId) {
            const appIdeas = await this.getByApp(uid, appId);
            return appIdeas.filter(i => i.status === 'active').pop() || null;
        },

        // Update editable fields of an idea
        async update(uid, ideaId, updates) {
            const allowed = ['name', 'description', 'status', 'phase', 'projectId', 'appId']; // v8.64.0 A2: slug removed â€” immutable after creation; v8.69.2: appId added for linking unlinked ideas
            const filtered = {};
            for (const key of allowed) {
                if (updates[key] !== undefined) filtered[key] = updates[key];
            }
            filtered.updatedAt = new Date().toISOString();
            await this._ref(uid).child(ideaId).update(filtered);
            // v8.69.2: If appId changed, update the appIdeas index
            if (updates.appId) {
                await this._addIdeaToApp(uid, updates.appId, ideaId);
            }
            return filtered;
        },

        // Graduate an idea â€” link it to an app and mark as graduated
        async graduate(uid, ideaId, appId) {
            const snapshot = await this._ref(uid).child(ideaId).once('value');
            const idea = snapshot.val();
            if (!idea) throw new Error(`Idea not found: ${ideaId}`);

            // Calculate sequence for the app
            const appIdeas = await this.getByApp(uid, appId);
            const sequence = appIdeas.length > 0 ? Math.max(...appIdeas.map(i => i.sequence || 0)) + 1 : 1;

            // Determine type: first idea for an app is base, rest are addons
            const type = appIdeas.length === 0 ? 'base' : 'addon';
            const parentIdeaId = appIdeas.length > 0 ? appIdeas[appIdeas.length - 1].id : null;

            const now = new Date().toISOString();
            await this._ref(uid).child(ideaId).update({
                appId,
                sequence,
                type,
                parentIdeaId,
                status: 'graduated',
                updatedAt: now
            });

            // Update app's ideas reference
            await this._addIdeaToApp(uid, appId, ideaId);

            return { appId, sequence, type, parentIdeaId };
        },

        // Archive an idea
        async archive(uid, ideaId) {
            const now = new Date().toISOString();
            await this._ref(uid).child(ideaId).update({
                status: 'archived',
                updatedAt: now
            });
        },

        // Delete an idea (and clean up app reference)
        async remove(uid, ideaId) {
            const snapshot = await this._ref(uid).child(ideaId).once('value');
            const idea = snapshot.val();
            if (idea && idea.appId) {
                await this._removeIdeaFromApp(uid, idea.appId, ideaId);
            }
            await this._ref(uid).child(ideaId).remove();
        },

        // Add idea reference to app config in Firebase
        async _addIdeaToApp(uid, appId, ideaId) {
            const appIdeasRef = firebaseDb.ref(`command-center/${uid}/appIdeas/${appId}`);
            const snapshot = await appIdeasRef.once('value');
            const existing = snapshot.val() || [];
            if (!existing.includes(ideaId)) {
                existing.push(ideaId);
                await appIdeasRef.set(existing);
            }
        },

        // Remove idea reference from app config in Firebase
        async _removeIdeaFromApp(uid, appId, ideaId) {
            const appIdeasRef = firebaseDb.ref(`command-center/${uid}/appIdeas/${appId}`);
            const snapshot = await appIdeasRef.once('value');
            const existing = snapshot.val() || [];
            const filtered = existing.filter(id => id !== ideaId);
            await appIdeasRef.set(filtered);
        },

        // Get idea IDs linked to an app (from the appIdeas index)
        async getIdeaIdsForApp(uid, appId) {
            const snapshot = await firebaseDb.ref(`command-center/${uid}/appIdeas/${appId}`).once('value');
            return snapshot.val() || [];
        },

        // v8.71.4: added limitToLast(20) â€” was unbounded, downloading ALL ideas on every change
        listen(uid, callback) {
            const ref = this._ref(uid);
            const query = ref.orderByChild('updatedAt').limitToLast(20);
            const handler = (snapshot) => {
                const data = snapshot.val();
                callback(data ? Object.values(data) : []);
            };
            query.on('value', handler);
            return () => query.off('value', handler);
        },

        // Listen for real-time changes to app-idea index
        listenAppIdeas(uid, appId, callback) {
            const ref = firebaseDb.ref(`command-center/${uid}/appIdeas/${appId}`);
            const handler = (snapshot) => {
                callback(snapshot.val() || []);
            };
            ref.on('value', handler);
            return () => ref.off('value', handler);
        },

        // v8.64.0 A1: One-time backfill for Ideas created before data model extension
        // Idempotent â€” skips Ideas that already have all fields, safe to run on every load
        async backfillMissingFields(uid) {
            const snapshot = await this._ref(uid).once('value');
            const data = snapshot.val();
            if (!data) return;

            let backfillCount = 0;
            const updates = {};

            for (const [key, idea] of Object.entries(data)) {
                const patch = {};
                let needsUpdate = false;

                // Backfill slug â€” generate from name, ensure unique within app scope
                if (!idea.slug) {
                    const base = this.generateSlug(idea.name || 'untitled');
                    const siblings = Object.values(data).filter(i =>
                        i.appId === idea.appId && i.slug && i.id !== idea.id
                    );
                    const existingSlugs = siblings.map(i => i.slug);
                    // Also include slugs we're generating in this batch to avoid collisions
                    for (const [otherKey, otherPatch] of Object.entries(updates)) {
                        if (otherPatch.slug) existingSlugs.push(otherPatch.slug);
                    }
                    let slug = base;
                    if (existingSlugs.includes(slug)) {
                        let counter = 2;
                        while (existingSlugs.includes(`${slug}-${counter}`)) counter++;
                        slug = `${base}-${counter}`;
                    }
                    patch.slug = slug;
                    needsUpdate = true;
                }

                if (!idea.sessionLog) { patch.sessionLog = []; needsUpdate = true; }
                if (idea.lastSessionDate === undefined) { patch.lastSessionDate = null; needsUpdate = true; }
                if (idea.phase === undefined) { patch.phase = null; needsUpdate = true; }
                if (idea.activeSession === undefined) { patch.activeSession = null; needsUpdate = true; }
                if (idea.phaseUpdatedAt === undefined) { patch.phaseUpdatedAt = null; needsUpdate = true; }
                if (idea.parentIdeaId === undefined) { patch.parentIdeaId = null; needsUpdate = true; }

                // Backfill projectId â€” infer from appId's project if possible
                // For CC, appId IS the projectId. Smarter inference (app config lookup) can come later.
                if (idea.projectId === undefined) {
                    patch.projectId = idea.appId || null;
                    needsUpdate = true;
                }

                if (needsUpdate) {
                    updates[key] = patch;
                    backfillCount++;
                }
            }

            // Write all patches in a single multi-path update
            if (backfillCount > 0) {
                const multiUpdate = {};
                for (const [key, patch] of Object.entries(updates)) {
                    for (const [field, value] of Object.entries(patch)) {
                        multiUpdate[`${key}/${field}`] = value;
                    }
                }
                await this._ref(uid).update(multiUpdate);
                console.log(`[CC] Idea backfill: updated ${backfillCount} idea(s) with missing fields`);
            } else {
                console.log('[CC] Idea backfill: all ideas up to date');
            }
        }
    };

    // Compute idea phase from ODRC concept state (standalone utility)
    // Returns 'exploring', 'converging', or 'spec-ready'
    // If idea has a manual phase override (non-null), use that instead
    function computeIdeaPhase(concepts) {
        const active = concepts.filter(c => c.status === 'active');
        const opens = active.filter(c => c.type === 'OPEN').length;
        const decisions = active.filter(c => c.type === 'DECISION').length;
        const rules = active.filter(c => c.type === 'RULE').length;
        const constraints = active.filter(c => c.type === 'CONSTRAINT').length;

        // Check spec-ready first (highest priority)
        if (opens === 0 || (opens <= 2 && decisions >= 10)) return 'spec-ready';
        // Then converging
        if (decisions >= opens && (rules > 0 || constraints > 0)) return 'converging';
        // Default
        return 'exploring';
    }

    // v8.68.0: Format relative time ago
    function formatTimeAgo(dateStr) {
        if (!dateStr) return '';
        const ms = Date.now() - new Date(dateStr).getTime();
        const minutes = Math.floor(ms / 60000);
        if (minutes < 60) return `${minutes}m ago`;
        const hours = Math.floor(minutes / 60);
        if (hours < 24) return `${hours}h ago`;
        const days = Math.floor(hours / 24);
        return `${days}d ago`;
    }

    // Generate session ID in S-YYYY-MM-DD-NNN format
    function generateSessionId(sessionNumber) {
        const now = new Date();
        const y = now.getFullYear();
        const m = String(now.getMonth() + 1).padStart(2, '0');
        const d = String(now.getDate()).padStart(2, '0');
        const n = String(sessionNumber).padStart(3, '0');
        return `S-${y}-${m}-${d}-${n}`;
    }

    // v8.68.0: Helper to get recent active ideas enriched with metadata + session state
        // v8.70.15: Removed getRecentIdeas

    // =========================================================================
    // COMPLETION FILE SERVICE (v8.58.0 â€” Ingestion Pipeline Phase 1)
    // =========================================================================

        // v8.70.15: Removed CompletionFileService block (service + settings + parse + validate + poll)

    // Phase 3: Generate reconstruction markdown for orphaned commits
    function generateOrphanReconstructionPackage(orphans) {
        const lines = [
            '# Reconstruction Task â€” Orphaned Commits',
            '',
            'The following commits were made without completion files. Please reconstruct',
            'completion files for each commit (or group related commits into single completion files).',
            '',
            '## Instructions',
            '- Use `git show {sha}` to inspect each commit',
            '- Read the current CLAUDE.md for rules and decisions context',
            '- Produce completion files to cc/completions/ following the standard format',
            '- One completion file per logical task (group related commits if they\'re part of the same task)',
            '- Required fields: task, status, files, commits',
            '- Include what you can infer for contextual fields',
            '- Note in the body that this is a reconstruction and narrative context may be incomplete',
            '',
            '## Orphaned Commits',
            ''
        ];

        orphans.forEach((orphan, i) => {
            lines.push(`### Commit ${i + 1}`);
            lines.push(`- SHA: ${orphan.commitSha}`);
            lines.push(`- Date: ${orphan.commitDate}`);
            lines.push(`- Message: ${orphan.commitMessage?.split('\n')[0] || 'No message'}`);
            if (orphan.filesChanged?.length > 0) {
                lines.push('- Files changed:');
                orphan.filesChanged.forEach(f => {
                    lines.push(`  - ${f.path} (${f.status})`);
                });
            }
            lines.push('');
        });

        return lines.join('\n');
    }

    // =========================================================================
    // SIGN-IN SCREEN (v8.70.0 Multi-User)
    // Full-screen sign-in gate â€” shown when no Firebase user is authenticated.
    // =========================================================================
    function SignInScreen() {
        const [error, setError] = React.useState('');
        const [loading, setLoading] = React.useState(false);
        const isFileProtocol = window.location.protocol === 'file:';

        const handleSignIn = async () => {
            if (isFileProtocol) return;
            setLoading(true);
            setError('');
            try {
                const provider = new firebase.auth.GoogleAuthProvider();
                await firebaseAuth.signInWithPopup(provider);
            } catch (e) {
                console.error('Sign in error:', e);
                setError(e.message || 'Sign-in failed. Please try again.');
            } finally {
                setLoading(false);
            }
        };

        return (
            <div className="min-h-screen bg-slate-900 flex items-center justify-center p-4">
                <div className="bg-slate-800 rounded-xl border border-slate-700 p-8 max-w-md w-full text-center">
                    <div className="mb-6">
                        <Icons.CCLogo size={48} />
                    </div>
                    <h1 className="text-2xl font-bold text-white mb-2">Command Center</h1>
                    <p className="text-slate-400 mb-8">Sign in with your Google account to access your workspace.</p>
                    {isFileProtocol && (
                        <div className="bg-yellow-900/30 border border-yellow-700 rounded-lg p-3 mb-4 text-sm text-yellow-300">
                            âš ï¸ Google Sign-in requires HTTPS. Please deploy via GitHub Pages or use a local server.
                        </div>
                    )}
                    {error && (
                        <div className="bg-red-900/30 border border-red-700 rounded-lg p-3 mb-4 text-sm text-red-300">
                            {error}
                        </div>
                    )}
                    <button
                        onClick={handleSignIn}
                        disabled={isFileProtocol || loading}
                        className="w-full flex items-center justify-center gap-3 px-6 py-3 rounded-lg bg-indigo-600 hover:bg-indigo-500 disabled:opacity-50 disabled:cursor-not-allowed text-white font-medium transition-colors"
                    >
                        {loading ? (
                            <span className="animate-spin">â³</span>
                        ) : (
                            <span>ðŸ”</span>
                        )}
                        {loading ? 'Signing in...' : 'Sign in with Google'}
                    </button>
                    <p className="text-xs text-slate-500 mt-4">
                        Your workspace data is stored securely in Firebase. Secrets stay in your browser.
                    </p>
                </div>
            </div>
        );
    }

    // =========================================================================
    // SETUP WIZARD (v8.70.0 Multi-User)
    // Guided onboarding for new users. Gates main UI until GitHub token is set.
    // v8.70.8: Redesigned as a full-screen modal wizard with welcome page, one step at a time.
    // v8.73.0: Step 3 "Integrations" â†’ "Connectors", updated tool permissions mock.
    //          Step 4 replaced API key flow with OAuth (persistent server-side tokens).
    // Steps: Welcome â†’ GitHub Token â†’ Create Claude.ai Project + Instructions â†’ Connect MCP â†’ Connect Claude Code
    // =========================================================================
    function SetupWizard({ firebaseUser, onComplete }) {
        const [step, setStep] = React.useState(0); // 0 = welcome, 1-5 = wizard steps
        // Pre-fill token from storage if it exists (e.g. existing user in test mode)
        const [token, setToken] = React.useState(() => {
            try { return SecretManager.get('token') || ''; } catch { return ''; }
        });
        const [tokenExpires, setTokenExpires] = React.useState(() => {
            try { return SecretManager.get('token_expires') || localStorage.getItem('cc_token_expires') || ''; } catch { return ''; }
        });
        const [validating, setValidating] = React.useState(false);
        const [validated, setValidated] = React.useState(null);
        const [error, setError] = React.useState('');
        // v8.72.0: GitHub OAuth flow state
        const [showManualToken, setShowManualToken] = React.useState(false);
        const [oauthConnecting, setOauthConnecting] = React.useState(false);

        // v8.72.0: Connect GitHub via OAuth popup (Firebase Auth linkWithPopup)
        const connectGitHubOAuth = async () => {
            setOauthConnecting(true);
            setError('');
            try {
                const provider = new firebase.auth.GithubAuthProvider();
                provider.addScope('repo');
                provider.addScope('read:user');
                const result = await firebaseAuth.currentUser.linkWithPopup(provider);
                const credential = firebase.auth.GithubAuthProvider.credentialFromResult(result);
                const githubToken = credential.accessToken;
                // Validate the token and get user info
                const userRes = await fetch('https://api.github.com/user', {
                    headers: { Authorization: `token ${githubToken}` }
                });
                const user = await userRes.json();
                if (user.login) {
                    const api = new GitHubAPI(githubToken);
                    const repos = await api.listRepos();
                    setToken(githubToken);
                    setValidated({ login: user.login, avatar: user.avatar_url, repos: repos.length, oauth: true });
                }
            } catch (e) {
                console.error('[CC] GitHub OAuth error:', e);
                if (e.code === 'auth/provider-already-linked') {
                    // Already linked â€” try to get token via signInWithPopup re-auth
                    try {
                        const provider = new firebase.auth.GithubAuthProvider();
                        provider.addScope('repo');
                        provider.addScope('read:user');
                        const result = await firebaseAuth.signInWithPopup(provider);
                        const credential = firebase.auth.GithubAuthProvider.credentialFromResult(result);
                        if (credential && credential.accessToken) {
                            const githubToken = credential.accessToken;
                            const userRes = await fetch('https://api.github.com/user', {
                                headers: { Authorization: `token ${githubToken}` }
                            });
                            const user = await userRes.json();
                            if (user.login) {
                                const api = new GitHubAPI(githubToken);
                                const repos = await api.listRepos();
                                setToken(githubToken);
                                setValidated({ login: user.login, avatar: user.avatar_url, repos: repos.length, oauth: true });
                            }
                        }
                    } catch (reErr) {
                        setError('GitHub is already linked but we couldn\'t retrieve the token. Try the manual token option below.');
                    }
                } else if (e.code === 'auth/credential-already-in-use') {
                    setError('This GitHub account is already linked to a different CC account. Use a different GitHub account or try the manual token option.');
                } else if (e.code === 'auth/popup-closed-by-user') {
                    // User cancelled â€” no error needed
                } else {
                    setError(e.message || 'GitHub connection failed. Try the manual token option below.');
                }
            } finally {
                setOauthConnecting(false);
            }
        };

        // Auto-validate existing token on mount
        React.useEffect(() => {
            if (token && !validated && !validating) {
                (async () => {
                    setValidating(true);
                    try {
                        const userRes = await fetch('https://api.github.com/user', {
                            headers: { Authorization: `token ${token}` }
                        });
                        const user = await userRes.json();
                        if (user.login) {
                            const api = new GitHubAPI(token);
                            const repos = await api.listRepos();
                            setValidated({ login: user.login, avatar: user.avatar_url, repos: repos.length });
                        }
                    } catch (e) { /* token invalid or expired â€” user will need to re-enter */ }
                    setValidating(false);
                })();
            }
        }, []);
        const [instructionsCopied, setInstructionsCopied] = React.useState(false);
        const [instructionsText, setInstructionsText] = React.useState('');
        const [instructionsLoading, setInstructionsLoading] = React.useState(false);
        const [mcpConfigCopied, setMcpConfigCopied] = React.useState(false);

        // Tutorial state
        const [showTutorial, setShowTutorial] = React.useState(false);
        const [tutorialStep, setTutorialStep] = React.useState(0);
        const [demoMode, setDemoMode] = React.useState('exploration');
        const totalTutorialSteps = 6;

        const totalSteps = 5;
        const stepLabels = ['GitHub Token', 'Claude.ai Project', 'Connect MCP', 'Connect Claude Code', 'All Done'];

        const validateToken = async () => {
            if (!token.trim()) return;
            setValidating(true);
            setError('');
            setValidated(null);
            try {
                const api = new GitHubAPI(token.trim());
                const repos = await api.listRepos();
                const userRes = await fetch('https://api.github.com/user', {
                    headers: { Authorization: `token ${token.trim()}` }
                });
                const user = await userRes.json();
                setValidated({ login: user.login, avatar: user.avatar_url, repos: repos.length });
            } catch (e) {
                setError('Invalid token â€” could not authenticate with GitHub. Please check and try again.');
            } finally {
                setValidating(false);
            }
        };

        const fetchInstructions = async () => {
            if (instructionsText) return instructionsText;
            setInstructionsLoading(true);
            try {
                if (firebaseDb && firebaseUser) {
                    const snap = await firebaseDb.ref(`command-center/${firebaseUser.uid}/documents`)
                        .orderByChild('type').equalTo('project-instructions').limitToLast(1).once('value');
                    const data = snap.val();
                    if (data) {
                        const doc = Object.values(data)[0];
                        if (doc && doc.content) {
                            setInstructionsText(doc.content);
                            setInstructionsLoading(false);
                            return doc.content;
                        }
                    }
                }
            } catch (e) { /* fall through to default */ }
            // Default CC project instructions â€” canonical version
            const defaultInstructions = `# Command Center â€” Project Instructions

You are operating in Command Center (CC) mode. CC is an AI-powered ideation and development platform that tracks ideas, concepts, sessions, jobs, and deployments across a portfolio of web apps.

## Setup & Onboarding

These instructions are the canonical project configuration for Command Center. They are stored as a permanent document in Firebase and downloaded once during initial setup:

1. User configures MCP connection to CC
2. User downloads this instructions file from Firebase
3. User loads these instructions into their Claude project settings
4. All conversations in the project inherit these instructions automatically

To check for updated instructions: \\\`document(action="list", type="project-instructions")\\\`

## On Every Conversation Start

1. **Load the router** â€” the only skill read at startup:
   - \\\`skill(action="get", skillName="cc-skill-router")\\\` â€” the routing table that tells you which skills to load for any action

2. **Check for active work:**
   - \\\`session(action="list", status="active")\\\` â€” any active ideation sessions?
   - \\\`job(action="list", status="review")\\\` â€” any jobs needing review/approval?
   - \\\`job(action="list", status="draft")\\\` â€” any draft jobs queued?

3. **Route based on what you find:**
   - Active session found â†’ read \\\`cc-session-resume\\\`, present status, ask to resume or start fresh
   - Jobs in review â†’ surface them â€” Code may be waiting for a decision
   - Nothing active â†’ present the \\\`prompt\\\` widgets â€” ready for whatever the user needs

**Do NOT preload skills speculatively.** The router tells you exactly which skills to read for any trigger. Load them at the moment they're needed, not before.

## ODRC Vocabulary

All ideation work is organized through four concept types:

| Type | What It Is | Example |
|------|-----------|---------|
| **OPEN** | A question or uncertainty needing resolution | "How does the system handle concurrent edits?" |
| **DECISION** | A resolved position â€” WHAT was decided AND WHY | "Use WebSocket for real-time sync because polling creates unacceptable latency at scale" |
| **RULE** | A repeatable behavioral principle governing future work | "All API responses must include pagination metadata even if the result set is small" |
| **CONSTRAINT** | A hard boundary that exists whether you like it or not | "Firebase free tier limits to 1GB storage" |

### Concept State Machine
\\\`\\\`\\\`
OPEN â†’ DECISION, RULE, or CONSTRAINT
DECISION â†’ RULE (pattern hardening)
CONSTRAINT â†’ DECISION or RULE (external reality changed)
RULE â†’ OPEN (destabilized, needs rethinking)
\\\`\\\`\\\`

### Conversational Markers
When surfacing concepts in conversation, announce them clearly before writing to Firebase:
\\\`\\\`\\\`
NEW OPEN: "specific actionable question"
NEW DECISION: "what was decided AND why"
NEW RULE: "behavioral principle governing future work"
NEW CONSTRAINT: "hard boundary"
RESOLVE OPEN: "original open" â†’ resolution with rationale
\\\`\\\`\\\`

### Phase Signals
Concept distribution signals idea maturity:
- Many OPENs, few Decisions â†’ early exploration
- Decisions outnumber OPENs, Rules emerging â†’ converging
- OPENs near zero, strong Rules and Constraints â†’ spec-ready

## Lifecycle
\\\`\\\`\\\`
IDEATE â”€â”€â†’ SPECIFY â”€â”€â†’ DELIVER â”€â”€â†’ BUILD â”€â”€â†’ COMPLETE â”€â”€â†’ NEXT PHASE
 Chat       Chat       Queue       Code       Code         Chat
\\\`\\\`\\\`

- **Ideate** â€” Chat runs ODRC sessions, surfacing and resolving concepts
- **Specify** â€” Chat generates CLAUDE.md from active concepts, pushes to queue
- **Deliver** â€” Code picks up pending documents, writes to local filesystem
- **Build** â€” Code claims job, reviews spec, implements, logs events
- **Complete** â€” Code resolves OPENs from build, Chat reviews outcomes
- **Next Phase** â€” Graduated idea's Rules/Constraints carry forward, new addon idea begins

## State Machines
**Session:** \\\`active\\\` â†’ \\\`completed\\\` | \\\`abandoned\\\`
**Session Modes:** \\\`base\\\` â†” \\\`ideation\\\` â†” \\\`build-review\\\` â†” \\\`debrief\\\` (any-to-any)
**Job:** \\\`draft\\\` â†’ \\\`active\\\` â†’ \\\`review\\\` â†’ \\\`approved\\\` â†’ \\\`completed\\\`/\\\`failed\\\`/\\\`abandoned\\\`
**Idea:** \\\`active\\\` â†’ \\\`graduated\\\` | \\\`archived\\\`
**Concept:** \\\`active\\\` â†’ \\\`resolved\\\` | \\\`superseded\\\` | \\\`transitioned\\\`
**Document:** \\\`pending\\\` â†’ \\\`delivered\\\` | \\\`failed\\\`

## Command Reference
When the user says "prompt", present commands as interactive \\\`ask_user_input\\\` widgets.

## Skill Loading Philosophy
The router (\\\`cc-skill-router\\\`) is the single source of truth for skill loading:
1. **Startup:** Load only the router.
2. **On trigger:** Consult the router and load the indicated skill(s).
3. **On compaction:** Re-read the router + \\\`cc-session-resume\\\`.

## Tool Quick Reference
| Tool | Purpose |
|------|---------|
| \\\`app\\\` | List/get/update apps |
| \\\`idea\\\` | Create, update, graduate, archive ideas |
| \\\`concept\\\` | Create, transition, supersede, resolve ODRC concepts |
| \\\`session\\\` | Start, update, complete ideation sessions |
| \\\`job\\\` | Create draft jobs for Code, track build lifecycle |
| \\\`document\\\` | Queue documents for delivery, inter-agent messaging |
| \\\`generate_claude_md\\\` | Generate CLAUDE.md from active concepts |
| \\\`get_active_concepts\\\` | Current truth view â€” all active concepts for an app |
| \\\`list_concepts\\\` | Filter concepts by idea, app, type, status |
| \\\`skill\\\` | Read skill content for behavioral guidance |

## Rules
- Never hold state in the conversation â€” write to Firebase immediately via MCP tools
- OPENs are captured at moment of discovery, not deferred
- Jobs are the universal handoff to Code â€” not messages, not documents
- Concepts must be self-contained â€” readable without session context
- Read relevant skills BEFORE starting any structured activity
- The router is the only skill that gets loaded unconditionally
- Firebase is truth. Conversations are ephemeral.
- When presenting options or choices, use \\\`ask_user_input\\\` widgets`;
            setInstructionsText(defaultInstructions);
            setInstructionsLoading(false);
            return defaultInstructions;
        };

        const copyInstructions = async () => {
            const text = await fetchInstructions();
            if (text) {
                navigator.clipboard.writeText(text);
                setInstructionsCopied(true);
            }
        };

        const MCP_SERVER_URL = 'https://cc-mcp-server-300155036194.us-central1.run.app/mcp';

        const handleComplete = () => {
            onComplete(token.trim(), {
                tokenExpires: (validated?.oauth) ? null : (tokenExpires || null),
                anthropicKey: null
            });
        };

        // Tutorial keyboard navigation
        React.useEffect(() => {
            if (!showTutorial) return;
            const handler = (e) => {
                if (e.key === 'ArrowRight' && tutorialStep < totalTutorialSteps - 1) {
                    setTutorialStep(s => s + 1);
                } else if (e.key === 'ArrowLeft' && tutorialStep > 0) {
                    setTutorialStep(s => s - 1);
                } else if (e.key === 'Escape') {
                    setShowTutorial(false);
                    setTutorialStep(0);
                }
            };
            window.addEventListener('keydown', handler);
            return () => window.removeEventListener('keydown', handler);
        }, [showTutorial, tutorialStep]);

        // Scroll wizard container to top on tutorial step change
        React.useEffect(() => {
            if (!showTutorial) return;
            const container = document.querySelector('.setup-wizard-scroll');
            if (container) container.scrollTop = 0;
        }, [tutorialStep, showTutorial]);

        // Progress dots
        const progressDots = step > 0 ? (
            <div className="flex items-center gap-2 mb-6">
                {Array.from({ length: totalSteps }, (_, i) => (
                    <button key={i} onClick={() => {
                        // Only allow navigation to token step or later if token is validated
                        if (i === 0 || validated) setStep(i + 1);
                    }}
                        className={`w-3 h-3 rounded-full transition-colors ${
                            i + 1 === step ? 'bg-indigo-400 ring-2 ring-indigo-400/30' :
                            i + 1 < step ? 'bg-green-500' : 'bg-slate-600'
                        }`}
                        title={stepLabels[i]} />
                ))}
                <span className="text-xs text-slate-500 ml-2">Step {step} of {totalSteps}</span>
            </div>
        ) : null;

        // Navigation buttons
        const navButtons = (backStep, nextStep, nextLabel, nextDisabled, nextAction) => (
            <div className="flex items-center justify-between mt-6 pt-4 border-t border-slate-700/50">
                <button onClick={() => setStep(backStep)}
                    className="px-4 py-2 text-sm text-slate-400 hover:text-white transition-colors">
                    â† {backStep === 0 ? 'Overview' : 'Back'}
                </button>
                {nextStep !== null && (
                    <button onClick={nextAction || (() => setStep(nextStep))}
                        disabled={nextDisabled}
                        className={`px-5 py-2 rounded-lg text-sm font-medium transition-colors ${
                            nextDisabled ? 'bg-slate-700 text-slate-500 cursor-not-allowed' :
                            'bg-indigo-600 hover:bg-indigo-500 text-white'
                        }`}>
                        {nextLabel || 'Next â†’'}
                    </button>
                )}
            </div>
        );

        // Tutorial progress dots
        const tutorialLabels = ['Welcome', 'How It Works', 'ODRC Framework', 'Sessions', 'Chat â†’ Code', 'Ready'];
        const tutorialDots = (
            <div className="flex items-center gap-2 mb-6">
                {Array.from({ length: totalTutorialSteps }, (_, i) => (
                    <button key={i} onClick={() => setTutorialStep(i)}
                        className={`w-3 h-3 rounded-full transition-colors ${
                            i === tutorialStep ? 'bg-indigo-400 ring-2 ring-indigo-400/30' :
                            i < tutorialStep ? 'bg-green-500' : 'bg-slate-600'
                        }`}
                        title={tutorialLabels[i]} />
                ))}
                <span className="text-xs text-slate-500 ml-2">{tutorialLabels[tutorialStep]}</span>
            </div>
        );

        // Tutorial navigation buttons
        const tutorialNav = (showNext, nextLabel, onNext) => (
            <div className="flex items-center justify-between mt-6 pt-4 border-t border-slate-700/50">
                <button onClick={() => tutorialStep > 0 ? setTutorialStep(s => s - 1) : (setShowTutorial(false), setTutorialStep(0))}
                    className="px-4 py-2 text-sm text-slate-400 hover:text-white transition-colors">
                    â† {tutorialStep === 0 ? 'Back' : 'Back'}
                </button>
                <button onClick={() => { setShowTutorial(false); setTutorialStep(0); }}
                    className="px-3 py-1 text-xs text-slate-500 hover:text-slate-300 transition-colors">
                    Skip Tutorial
                </button>
                {showNext && (
                    <button onClick={onNext || (() => setTutorialStep(s => s + 1))}
                        className="px-5 py-2 rounded-lg text-sm font-medium transition-colors bg-indigo-600 hover:bg-indigo-500 text-white">
                        {nextLabel || 'Next â†’'}
                    </button>
                )}
            </div>
        );

        return (
            <div className="min-h-screen bg-slate-900 flex items-center justify-center p-4">
                <div className="setup-wizard-scroll w-full max-w-xl mx-4 bg-slate-800 border border-slate-700 rounded-2xl shadow-2xl overflow-hidden" style={{maxHeight: '90vh', overflowY: 'auto'}}>
                    <div className="p-8">

                    {/* â”€â”€ Step 0: Welcome â”€â”€ */}
                    {step === 0 && !showTutorial && (
                        <div className="text-center">
                            {firebaseUser?.photoURL && (
                                <img src={firebaseUser.photoURL} alt="" className="w-16 h-16 rounded-full mx-auto mb-4 border-2 border-indigo-500" />
                            )}
                            <h2 className="text-2xl font-bold text-white mb-2">
                                Welcome{firebaseUser?.displayName ? `, ${firebaseUser.displayName.split(' ')[0]}` : ''}!
                            </h2>
                            <p className="text-slate-400 mb-6">
                                Let's wire up your Command Center. We'll connect a few things so Claude Chat and Claude Code can both talk to your CC data store.
                            </p>

                            <div className="text-left space-y-3 mb-6">
                                {[
                                    { icon: 'ðŸ”—', label: 'Connect GitHub', desc: 'One-click authorization â€” no tokens to create' },
                                    { icon: 'ðŸ“‚', label: 'Create a Claude.ai Project', desc: 'A dedicated workspace with project instructions loaded' },
                                    { icon: 'ðŸ§©', label: 'Add an MCP connector', desc: 'Bridges Claude Chat to Command Center' },
                                    { icon: 'ðŸ’»', label: 'Connect Claude Code (optional)', desc: 'Same CC tools via OAuth â€” no API keys needed' },
                                ].map((item, i) => (
                                    <div key={i} className="flex items-center gap-3 p-3 bg-slate-700/30 rounded-lg">
                                        <span className="text-xl flex-shrink-0">{item.icon}</span>
                                        <div className="min-w-0">
                                            <div className="text-sm text-white font-medium">{item.label}</div>
                                            <div className="text-xs text-slate-400">{item.desc}</div>
                                        </div>
                                    </div>
                                ))}
                            </div>

                            {/* Prerequisites callout */}
                            <div className="text-left mb-6 p-3 bg-amber-900/20 border border-amber-700/30 rounded-lg">
                                <div className="flex gap-2 items-start">
                                    <span className="text-amber-400 text-sm mt-0.5">â„¹ï¸</span>
                                    <div className="text-xs text-slate-400 space-y-1">
                                        <span><strong className="text-amber-300">Claude Pro plan required.</strong> MCP connectors require a Claude Pro, Team, or Enterprise plan.</span>
                                        <br />
                                        <span><strong className="text-slate-300">Claude Code (CLI) strongly recommended.</strong> CC is designed for both Chat and Code working together. You can use ideation features with Chat alone, but the full build lifecycle requires Claude Code installed locally.</span>
                                    </div>
                                </div>
                            </div>

                            <div className="flex flex-col sm:flex-row gap-3 justify-center">
                                <button
                                    onClick={() => setShowTutorial(true)}
                                    className="px-5 py-3 rounded-lg bg-slate-700 hover:bg-slate-600 text-white font-medium transition-colors border border-slate-600 flex items-center justify-center gap-2"
                                >
                                    <span>ðŸ“–</span> Learn about CC
                                </button>
                                <button
                                    onClick={() => setStep(1)}
                                    className="px-5 py-3 rounded-lg bg-indigo-600 hover:bg-indigo-500 text-white font-medium transition-colors flex items-center justify-center gap-2"
                                >
                                    <span>âš¡</span> Skip to Setup â†’
                                </button>
                            </div>
                        </div>
                    )}

                    {/* â”€â”€ Tutorial Screens â”€â”€ */}
                    {showTutorial && (
                        <div>
                            {tutorialDots}

                            {/* Screen 1: Welcome to Command Center */}
                            {tutorialStep === 0 && (
                                <div>
                                    <h3 className="text-lg font-semibold text-white mb-1">Welcome to Command Center</h3>
                                    <p className="text-sm text-slate-400 mb-5">CC is the hub that connects your Claude conversations to real deployable output.</p>

                                    <div className="flex items-center justify-center gap-2 mb-6 p-4 bg-slate-900/50 rounded-xl">
                                        <div className="text-center p-3 bg-slate-700/50 rounded-lg border border-slate-600/50 flex-1">
                                            <div className="text-2xl mb-1">ðŸ’¬</div>
                                            <div className="text-xs font-medium text-white">Claude Chat</div>
                                            <div className="text-[10px] text-slate-400 mt-0.5">Think & decide</div>
                                        </div>
                                        <div className="text-slate-500 text-lg font-mono">â‡„</div>
                                        <div className="text-center p-3 bg-indigo-900/40 rounded-lg border border-indigo-500/40 flex-1">
                                            <div className="text-2xl mb-1">â¬¡</div>
                                            <div className="text-xs font-bold text-indigo-300">Command Center</div>
                                            <div className="text-[10px] text-slate-400 mt-0.5">Capture & organize</div>
                                        </div>
                                        <div className="text-slate-500 text-lg font-mono">â‡„</div>
                                        <div className="text-center p-3 bg-slate-700/50 rounded-lg border border-slate-600/50 flex-1">
                                            <div className="text-2xl mb-1">ðŸ’»</div>
                                            <div className="text-xs font-medium text-white">Claude Code</div>
                                            <div className="text-[10px] text-slate-400 mt-0.5">Build & deploy</div>
                                        </div>
                                    </div>

                                    <div className="space-y-2 text-sm text-slate-300 mb-4">
                                        <p><strong className="text-white">Chat</strong> is where you think out loud â€” explore ideas, make decisions, and shape what gets built.</p>
                                        <p><strong className="text-white">CC</strong> captures everything that matters â€” decisions, rules, constraints, open questions â€” so nothing is lost between conversations.</p>
                                        <p><strong className="text-white">Code</strong> picks up build jobs from CC and turns specs into deployed code.</p>
                                    </div>

                                    <div className="p-3 bg-amber-900/20 border border-amber-700/30 rounded-lg">
                                        <div className="flex gap-2 items-start">
                                            <span className="text-amber-400 text-sm mt-0.5">ðŸ’¡</span>
                                            <span className="text-xs text-slate-400">CC lives in its own <strong className="text-amber-300">Claude Project</strong> â€” a dedicated workspace where Chat always has your project context loaded.</span>
                                        </div>
                                    </div>

                                    {tutorialNav(true, 'Next â†’')}
                                </div>
                            )}

                            {/* Screen 2: How It Works */}
                            {tutorialStep === 1 && (
                                <div>
                                    <h3 className="text-lg font-semibold text-white mb-1">How It Works</h3>
                                    <p className="text-sm text-slate-400 mb-5">CC follows a four-phase flow. You control the pace.</p>

                                    <div className="grid grid-cols-4 gap-2 mb-6">
                                        {[
                                            { num: '1', label: 'Ideate', desc: 'Explore the problem space with Chat', icon: 'ðŸ’¡', color: 'purple' },
                                            { num: '2', label: 'Specify', desc: 'Shape ideas into buildable specs', icon: 'ðŸ“', color: 'blue' },
                                            { num: '3', label: 'Build', desc: 'Code picks up jobs and implements', icon: 'ðŸ”¨', color: 'indigo' },
                                            { num: '4', label: 'Review', desc: 'Validate output, refine, iterate', icon: 'ðŸ”', color: 'green' },
                                        ].map((phase, i) => (
                                            <div key={i} className="text-center p-3 bg-slate-700/30 rounded-lg relative">
                                                <div className="text-xl mb-1">{phase.icon}</div>
                                                <div className="text-xs font-bold text-white">{phase.label}</div>
                                                <div className="text-[10px] text-slate-400 mt-1 leading-tight">{phase.desc}</div>
                                                {i < 3 && <div className="absolute right-[-8px] top-1/2 -translate-y-1/2 text-slate-600 text-xs">â†’</div>}
                                            </div>
                                        ))}
                                    </div>

                                    <div className="space-y-3 text-sm text-slate-300 mb-4">
                                        <div className="flex gap-3 items-start">
                                            <span className="text-indigo-400 mt-0.5">â–¸</span>
                                            <span>Chat sessions produce <strong className="text-white">structured output</strong> â€” not just conversation, but decisions and specs that CC stores.</span>
                                        </div>
                                        <div className="flex gap-3 items-start">
                                            <span className="text-indigo-400 mt-0.5">â–¸</span>
                                            <span>When a spec is ready, Chat queues a <strong className="text-white">build job</strong>. Code claims and builds it.</span>
                                        </div>
                                        <div className="flex gap-3 items-start">
                                            <span className="text-indigo-400 mt-0.5">â–¸</span>
                                            <span>If Code has concerns about a spec, it <strong className="text-white">flags and waits</strong> â€” it never guesses.</span>
                                        </div>
                                    </div>

                                    <div className="p-3 bg-indigo-900/20 border border-indigo-700/30 rounded-lg">
                                        <div className="flex gap-2 items-start">
                                            <span className="text-indigo-400 text-sm mt-0.5">ðŸŽ¯</span>
                                            <span className="text-xs text-slate-400"><strong className="text-indigo-300">You're the driver.</strong> Code doesn't auto-run. Every build starts because you (via Chat) said it should.</span>
                                        </div>
                                    </div>

                                    {tutorialNav(true, 'Next â†’')}
                                </div>
                            )}

                            {/* Screen 3: Your Thinking Framework (ODRC) */}
                            {tutorialStep === 2 && (
                                <div>
                                    <h3 className="text-lg font-semibold text-white mb-1">Your Thinking Framework</h3>
                                    <p className="text-sm text-slate-400 mb-5">CC organizes everything you capture into four concept types.</p>

                                    <div className="space-y-3 mb-5">
                                        {[
                                            { type: 'OPEN', icon: 'â“', color: 'border-purple-500 bg-purple-900/20', textColor: 'text-purple-300', example: '"How should we handle offline mode?"', desc: 'Unresolved questions. Things you need to figure out.' },
                                            { type: 'DECISION', icon: 'ðŸŽ¯', color: 'border-blue-500 bg-blue-900/20', textColor: 'text-blue-300', example: '"Use WebSocket because polling creates latency"', desc: 'Choices you\'ve made. Directions you\'re taking.' },
                                            { type: 'RULE', icon: 'ðŸ“', color: 'border-red-500 bg-red-900/20', textColor: 'text-red-300', example: '"All API responses must include pagination metadata"', desc: 'Hard constraints you define. Code must follow these.' },
                                            { type: 'CONSTRAINT', icon: 'ðŸ”’', color: 'border-amber-500 bg-amber-900/20', textColor: 'text-amber-300', example: '"Firebase free tier limits to 1GB storage"', desc: 'External realities. Things you can\'t change.' },
                                        ].map((item, i) => (
                                            <div key={i} className={`p-3 rounded-lg border-l-4 ${item.color}`}>
                                                <div className="flex items-center gap-2 mb-1">
                                                    <span>{item.icon}</span>
                                                    <span className={`text-sm font-bold ${item.textColor}`}>{item.type}</span>
                                                </div>
                                                <div className="text-xs text-slate-300 mb-1">{item.desc}</div>
                                                <div className="text-xs text-slate-500 italic">{item.example}</div>
                                            </div>
                                        ))}
                                    </div>

                                    <div className="p-3 bg-slate-700/30 rounded-lg">
                                        <div className="flex gap-2 items-start">
                                            <span className="text-slate-400 text-sm mt-0.5">ðŸ”„</span>
                                            <span className="text-xs text-slate-400">Concepts evolve: <strong className="text-purple-300">OPENs</strong> become <strong className="text-blue-300">DECISIONs</strong> when you choose a direction. <strong className="text-blue-300">DECISIONs</strong> harden into <strong className="text-red-300">RULEs</strong> when you're certain.</span>
                                        </div>
                                    </div>

                                    {tutorialNav(true, 'Next â†’')}
                                </div>
                            )}

                            {/* Screen 4: Working in Sessions */}
                            {tutorialStep === 3 && (
                                <div>
                                    <h3 className="text-lg font-semibold text-white mb-1">Working in Sessions</h3>
                                    <p className="text-sm text-slate-400 mb-5">Each Chat conversation is a session with a purpose. Pick a mode to set the tone.</p>

                                    <div className="grid grid-cols-2 gap-2 mb-5">
                                        {[
                                            { key: 'exploration', icon: 'ðŸ”­', label: 'Exploration', desc: 'Open discovery. Surface questions, make early decisions.' },
                                            { key: 'stress-test', icon: 'ðŸ”¨', label: 'Stress Test', desc: 'Challenge mode. Find gaps, validate decisions.' },
                                            { key: 'spec', icon: 'ðŸ“', label: 'Spec', desc: 'Convergence. Resolve OPENs, establish Rules.' },
                                            { key: 'review', icon: 'ðŸ”', label: 'Review', desc: 'Evaluate completeness and readiness.' },
                                        ].map((mode) => (
                                            <button key={mode.key}
                                                onClick={() => setDemoMode(mode.key)}
                                                className={`text-left p-3 rounded-lg border transition-colors ${
                                                    demoMode === mode.key
                                                        ? 'border-indigo-500 bg-indigo-900/30'
                                                        : 'border-slate-600/50 bg-slate-700/30 hover:border-slate-500'
                                                }`}>
                                                <div className="text-lg mb-1">{mode.icon}</div>
                                                <div className="text-xs font-bold text-white">{mode.label}</div>
                                                <div className="text-[10px] text-slate-400 mt-0.5 leading-tight">{mode.desc}</div>
                                            </button>
                                        ))}
                                    </div>

                                    <div className="mb-4">
                                        <div className="text-xs font-medium text-slate-300 mb-2">Sessions can also use lenses to focus the conversation:</div>
                                        <div className="flex flex-wrap gap-1.5">
                                            {[
                                                { label: 'Technical', color: 'bg-blue-900/40 text-blue-300 border-blue-700/40' },
                                                { label: 'Economics', color: 'bg-green-900/40 text-green-300 border-green-700/40' },
                                                { label: 'Competitive', color: 'bg-orange-900/40 text-orange-300 border-orange-700/40' },
                                                { label: 'Customer', color: 'bg-pink-900/40 text-pink-300 border-pink-700/40' },
                                                { label: 'Operational', color: 'bg-slate-700/60 text-slate-300 border-slate-600/40' },
                                            ].map((lens) => (
                                                <span key={lens.label} className={`px-2 py-0.5 text-[10px] rounded-full border ${lens.color}`}>{lens.label}</span>
                                            ))}
                                        </div>
                                    </div>

                                    <div className="p-3 bg-slate-700/30 rounded-lg">
                                        <div className="flex gap-2 items-start">
                                            <span className="text-slate-400 text-sm mt-0.5">ðŸ’¡</span>
                                            <span className="text-xs text-slate-400">Modes set the <strong className="text-white">tone</strong>. Lenses set the <strong className="text-white">angle</strong>. Together, they give Chat the context to push your thinking in the right direction.</span>
                                        </div>
                                    </div>

                                    {tutorialNav(true, 'Next â†’')}
                                </div>
                            )}

                            {/* Screen 5: From Thinking to Code */}
                            {tutorialStep === 4 && (
                                <div>
                                    <h3 className="text-lg font-semibold text-white mb-1">From Thinking to Code</h3>
                                    <p className="text-sm text-slate-400 mb-5">When your spec is ready, Chat queues a build job. Code picks it up.</p>

                                    <div className="grid grid-cols-2 gap-3 mb-5">
                                        <div className="rounded-lg overflow-hidden border border-slate-600/50">
                                            <div className="bg-slate-700/50 px-3 py-1.5 flex items-center gap-2 border-b border-slate-600/30">
                                                <span className="text-xs">ðŸ’¬</span>
                                                <span className="text-[10px] font-mono text-slate-300">Claude Chat</span>
                                            </div>
                                            <div className="bg-slate-900/80 p-3 font-mono text-[10px] leading-relaxed space-y-2">
                                                <div className="text-slate-400">You: "The spec is ready, queue the build"</div>
                                                <div className="text-green-400">Chat: "Job queued â€” Code will pick it up"</div>
                                                <div className="text-slate-600">...</div>
                                                <div className="text-blue-400">Chat: "Code deployed v1.2.3 âœ“"</div>
                                            </div>
                                        </div>
                                        <div className="rounded-lg overflow-hidden border border-slate-600/50">
                                            <div className="bg-slate-700/50 px-3 py-1.5 flex items-center gap-2 border-b border-slate-600/30">
                                                <span className="text-xs">ðŸ’»</span>
                                                <span className="text-[10px] font-mono text-slate-300">Claude Code</span>
                                            </div>
                                            <div className="bg-slate-900/80 p-3 font-mono text-[10px] leading-relaxed space-y-2">
                                                <div className="text-slate-400">$ "Found pending job. Claiming..."</div>
                                                <div className="text-amber-400">$ "Reading spec from CC..."</div>
                                                <div className="text-green-400">$ "Building from spec..."</div>
                                                <div className="text-green-400">$ "Deployed to test âœ“"</div>
                                            </div>
                                        </div>
                                    </div>

                                    <div className="space-y-3 mb-4">
                                        <div className="flex gap-3 items-start text-sm text-slate-300">
                                            <span className="text-indigo-400 mt-0.5">â–¸</span>
                                            <span>Chat creates the job with a full spec. Code reads it and builds.</span>
                                        </div>
                                        <div className="flex gap-3 items-start text-sm text-slate-300">
                                            <span className="text-indigo-400 mt-0.5">â–¸</span>
                                            <span>Code deploys to a <strong className="text-white">test repo first</strong>, then promotes to production.</span>
                                        </div>
                                    </div>

                                    <div className="p-3 bg-amber-900/20 border border-amber-700/30 rounded-lg">
                                        <div className="flex gap-2 items-start">
                                            <span className="text-amber-400 text-sm mt-0.5">âš ï¸</span>
                                            <span className="text-xs text-slate-400">If Code has concerns about the spec, it <strong className="text-amber-300">flags the issue and waits</strong>. It never guesses or builds with ambiguity.</span>
                                        </div>
                                    </div>

                                    {tutorialNav(true, 'Next â†’')}
                                </div>
                            )}

                            {/* Screen 6: You're Ready */}
                            {tutorialStep === 5 && (
                                <div>
                                    <h3 className="text-lg font-semibold text-white mb-1">You're Ready!</h3>
                                    <p className="text-sm text-slate-400 mb-5">Here's how to get the most out of CC once setup is complete.</p>

                                    <div className="space-y-3 mb-6">
                                        {[
                                            { num: 1, text: 'Start a Chat session with your CC project to explore an idea' },
                                            { num: 2, text: 'Let Chat capture OPENs, DECISIONs, RULEs, and CONSTRAINTs as you go' },
                                            { num: 3, text: 'Review and curate captured concepts in the Ideas tab' },
                                            { num: 4, text: 'When ready, ask Chat to generate a build spec and queue a job' },
                                            { num: 5, text: 'Start Claude Code â€” it will find and claim the pending job' },
                                            { num: 6, text: 'Review the build, then iterate â€” refine ideas and build again' },
                                        ].map((item) => (
                                            <div key={item.num} className="flex gap-3 items-start">
                                                <span className="flex-shrink-0 w-6 h-6 rounded-full bg-indigo-600 text-white text-xs font-bold flex items-center justify-center mt-0.5">{item.num}</span>
                                                <span className="text-sm text-slate-300">{item.text}</span>
                                            </div>
                                        ))}
                                    </div>

                                    <div className="text-center mb-5">
                                        <p className="text-sm text-slate-400">Next, we'll connect the tools that make all of this work.</p>
                                    </div>

                                    <div className="flex items-center justify-between pt-4 border-t border-slate-700/50">
                                        <button onClick={() => setTutorialStep(s => s - 1)}
                                            className="px-4 py-2 text-sm text-slate-400 hover:text-white transition-colors">
                                            â† Back
                                        </button>
                                        <button onClick={() => { setShowTutorial(false); setTutorialStep(0); setStep(1); }}
                                            className="px-6 py-3 rounded-lg bg-indigo-600 hover:bg-indigo-500 text-white font-medium transition-colors">
                                            Start Setup â†’
                                        </button>
                                    </div>
                                </div>
                            )}
                        </div>
                    )}

                    {/* â”€â”€ Step 1: GitHub Connection (v8.72.0: OAuth-first with manual fallback) â”€â”€ */}
                    {step === 1 && (
                        <div>
                            {progressDots}
                            <h3 className="text-lg font-semibold mb-2">Connect GitHub</h3>
                            <p className="text-sm text-slate-400 mb-4 leading-relaxed">
                                CC uses GitHub to deploy your apps. Click below to connect your GitHub account â€” it only takes a moment.
                            </p>

                            {/* OAuth success / validation result */}
                            {validated && (
                                <div className="bg-green-900/30 border border-green-700 rounded-lg p-3 flex items-center gap-3 mb-4">
                                    {validated.avatar && <img src={validated.avatar} alt="" className="w-8 h-8 rounded-full" />}
                                    <div>
                                        <div className="text-green-300 font-medium text-sm">âœ“ Connected as {validated.login}</div>
                                        <div className="text-green-400/70 text-xs">{validated.repos} repositories accessible{validated.oauth ? ' â€¢ via GitHub OAuth' : ''}</div>
                                    </div>
                                </div>
                            )}

                            {error && (
                                <div className="bg-red-900/30 border border-red-700 rounded-lg p-2 text-sm text-red-300 mb-4">{error}</div>
                            )}

                            {/* OAuth connect button â€” primary action */}
                            {!validated && !showManualToken && (
                                <div className="space-y-3">
                                    <button onClick={connectGitHubOAuth} disabled={oauthConnecting}
                                        className="w-full flex items-center justify-center gap-3 px-5 py-3 rounded-lg bg-slate-700 hover:bg-slate-600 border border-slate-600/50 text-white font-medium transition-colors disabled:opacity-60">
                                        {oauthConnecting ? (
                                            <React.Fragment>
                                                <span className="animate-spin">â³</span>
                                                <span>Connecting to GitHub...</span>
                                            </React.Fragment>
                                        ) : (
                                            <React.Fragment>
                                                <svg className="w-5 h-5" viewBox="0 0 24 24" fill="currentColor"><path d="M12 0C5.37 0 0 5.37 0 12c0 5.31 3.435 9.795 8.205 11.385.6.105.825-.255.825-.57 0-.285-.015-1.23-.015-2.235-3.015.555-3.795-.735-4.035-1.41-.135-.345-.72-1.41-1.23-1.695-.42-.225-1.02-.78-.015-.795.945-.015 1.62.87 1.845 1.23 1.08 1.815 2.805 1.305 3.495.99.105-.78.42-1.305.765-1.605-2.67-.3-5.46-1.335-5.46-5.925 0-1.305.465-2.385 1.23-3.225-.12-.3-.54-1.53.12-3.18 0 0 1.005-.315 3.3 1.23.96-.27 1.98-.405 3-.405s2.04.135 3 .405c2.295-1.56 3.3-1.23 3.3-1.23.66 1.65.24 2.88.12 3.18.765.84 1.23 1.905 1.23 3.225 0 4.605-2.805 5.625-5.475 5.925.435.375.81 1.095.81 2.22 0 1.605-.015 2.895-.015 3.3 0 .315.225.69.825.57A12.02 12.02 0 0024 12c0-6.63-5.37-12-12-12z"/></svg>
                                                <span>Connect GitHub Account</span>
                                            </React.Fragment>
                                        )}
                                    </button>

                                    <p className="text-xs text-slate-500 text-center leading-relaxed">
                                        Opens a GitHub authorization popup. Your token stays in this browser only.
                                    </p>

                                    <div className="pt-2 text-center">
                                        <button onClick={() => setShowManualToken(true)}
                                            className="text-xs text-slate-500 hover:text-slate-300 transition-colors underline underline-offset-2">
                                            Use a personal access token instead
                                        </button>
                                    </div>
                                </div>
                            )}

                            {/* Manual token fallback */}
                            {!validated && showManualToken && (
                                <div className="space-y-3">
                                    <p className="text-xs text-slate-500 leading-relaxed">
                                        Create a <strong className="text-slate-400">fine-grained personal access token</strong> with <code className="bg-slate-700 px-1 rounded text-xs">repo</code> and <code className="bg-slate-700 px-1 rounded text-xs">pages</code> scope.
                                    </p>
                                    <a href="https://github.com/settings/tokens?type=beta" target="_blank" rel="noopener noreferrer"
                                        className="inline-flex items-center gap-2 px-4 py-2 bg-slate-700 hover:bg-slate-600 border border-slate-600/50 rounded-lg text-sm font-medium text-slate-300 transition-colors">
                                        Open GitHub Token Settings
                                        <svg className="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14" /></svg>
                                    </a>
                                    <input
                                        type="password"
                                        value={token}
                                        onChange={e => { setToken(e.target.value); setValidated(null); setError(''); }}
                                        placeholder="github_pat_..."
                                        className="w-full px-3 py-2 rounded-lg bg-slate-700 border border-slate-600 text-white placeholder-slate-500 focus:border-indigo-500 focus:outline-none text-sm"
                                    />
                                    <div className="flex items-center gap-2">
                                        <label className="text-xs text-slate-400">Expiration date (optional):</label>
                                        <input
                                            type="date"
                                            value={tokenExpires}
                                            onChange={e => setTokenExpires(e.target.value)}
                                            className="px-2 py-1 rounded bg-slate-700 border border-slate-600 text-white text-xs focus:border-indigo-500 focus:outline-none"
                                        />
                                    </div>
                                    <button onClick={validateToken} disabled={!token.trim() || validating}
                                        className="px-4 py-2 rounded-lg bg-indigo-600 hover:bg-indigo-500 text-white text-sm font-medium disabled:opacity-50 transition-colors">
                                        {validating ? 'â³ Validating...' : 'Validate Token'}
                                    </button>

                                    <div className="pt-1 text-center">
                                        <button onClick={() => { setShowManualToken(false); setError(''); }}
                                            className="text-xs text-slate-500 hover:text-slate-300 transition-colors underline underline-offset-2">
                                            â† Back to one-click connect
                                        </button>
                                    </div>
                                </div>
                            )}

                            {navButtons(0, 2, validated ? 'Next â†’' : null, !validated)}
                        </div>
                    )}

                    {/* â”€â”€ Step 2: Create Claude.ai Project + Paste Instructions â”€â”€ */}
                    {step === 2 && (
                        <div>
                            {progressDots}
                            <h3 className="text-lg font-semibold mb-2">Create a Claude.ai Project</h3>
                            <p className="text-sm text-slate-400 mb-4 leading-relaxed">
                                Create a dedicated project in Claude.ai and load it with project instructions. This gives Claude context about CC's tools and workflow.
                            </p>

                            {/* Sub-step A: Copy Instructions */}
                            <div className="mb-4">
                                <div className="flex items-center gap-2 mb-2">
                                    <span className={`text-sm font-semibold ${instructionsCopied ? 'text-green-400' : 'text-indigo-300'}`}>
                                        {instructionsCopied ? 'âœ“' : 'A.'}
                                    </span>
                                    <span className="text-sm text-slate-300 font-medium">Copy project instructions to your clipboard</span>
                                </div>
                                <button onClick={copyInstructions} disabled={instructionsLoading}
                                    className={`w-full px-4 py-2.5 border rounded-lg text-sm font-medium transition-colors ${
                                        instructionsCopied
                                            ? 'bg-green-900/20 border-green-800/30 text-green-300'
                                            : 'bg-indigo-600 hover:bg-indigo-500 border-indigo-500 text-white'
                                    }`}>
                                    {instructionsLoading ? 'â³ Loading...' : instructionsCopied ? 'âœ“ Instructions Copied' : 'Copy Instructions to Clipboard'}
                                </button>
                            </div>

                            {/* Sub-step B: Create project and paste */}
                            <div className="mb-3">
                                <div className="flex items-center gap-2 mb-2">
                                    <span className="text-sm font-semibold text-indigo-300">B.</span>
                                    <span className="text-sm text-slate-300 font-medium">Create the project and paste instructions</span>
                                </div>
                                <ol className="text-xs text-slate-400 space-y-1.5 ml-6 mb-3 list-decimal">
                                    <li>Click <strong className="text-slate-300">Projects</strong> in the left sidebar, then <strong className="text-slate-300">Create Project</strong></li>
                                    <li>Name it <strong className="text-slate-300">"Command Center"</strong> (or whatever you like)</li>
                                    <li>Look for the <strong className="text-slate-300">Instructions</strong> section â€” click the <strong className="text-slate-300">+</strong> button next to it</li>
                                    <li>Paste the instructions you just copied</li>
                                </ol>

                                {/* Visual hint â€” text only, no interactive-looking elements */}
                                <div className="mb-3 p-2.5 bg-amber-900/15 border border-amber-700/20 rounded-lg">
                                    <p className="text-xs text-amber-300/80">
                                        <strong>Tip:</strong> On the project page, look for the word <strong>"Instructions"</strong> with a small <strong>+</strong> button next to it â€” that's where you paste.
                                    </p>
                                </div>

                                <a href="https://claude.ai/projects" target="_blank" rel="noopener noreferrer"
                                    className="inline-flex items-center gap-2 px-4 py-2 bg-slate-700 hover:bg-slate-600 border border-slate-600/50 rounded-lg text-sm font-medium text-slate-300 transition-colors">
                                    Open Claude.ai Projects
                                    <svg className="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14" /></svg>
                                </a>
                            </div>

                            {navButtons(1, 3, 'Next â†’')}
                        </div>
                    )}

                    {/* â”€â”€ Step 3: Connect MCP Server â”€â”€ */}
                    {step === 3 && (
                        <div>
                            {progressDots}
                            <h3 className="text-lg font-semibold mb-2">Connect the MCP Server</h3>
                            <p className="text-sm text-slate-400 mb-4 leading-relaxed">
                                The MCP (Model Context Protocol) server is the bridge that connects Claude to the Command Center data store.
                                By adding it as a connector, Claude gains access to CC's tools â€” ideas, concepts, sessions, and more.
                            </p>

                            <div className="space-y-4">
                                {/* Step 1: Copy URL */}
                                <div>
                                    <p className="text-xs font-medium text-slate-300 mb-2">1. Copy the MCP server URL</p>
                                    <div className="flex items-center gap-2 p-3 bg-slate-700/80 border border-slate-600/50 rounded-lg">
                                        <code className="flex-1 text-xs text-indigo-300 font-mono select-all break-all">https://cc-mcp-server-300155036194.us-central1.run.app/mcp</code>
                                        <button onClick={() => navigator.clipboard.writeText('https://cc-mcp-server-300155036194.us-central1.run.app/mcp')}
                                            className="px-3 py-1.5 bg-indigo-600 hover:bg-indigo-500 rounded text-xs font-medium whitespace-nowrap transition-colors">
                                            Copy URL
                                        </button>
                                    </div>
                                </div>

                                {/* Step 2: Open connectors page */}
                                <div>
                                    <p className="text-xs font-medium text-slate-300 mb-2">2. Add the connector in Claude.ai</p>
                                    <p className="text-xs text-slate-500 mb-2 leading-relaxed">
                                        Open the Connectors page, scroll to the bottom, and click <strong className="text-slate-400">Add custom connector</strong>. Paste the URL and sign in with the same Google account from Step 1.
                                    </p>
                                    <a href="https://claude.ai/settings/connectors" target="_blank" rel="noopener noreferrer"
                                        className="inline-flex items-center gap-2 px-4 py-2 bg-slate-700 hover:bg-slate-600 border border-slate-600/50 rounded-lg text-sm font-medium text-slate-300 transition-colors">
                                        Open Claude.ai Connectors
                                        <svg className="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14" /></svg>
                                    </a>
                                </div>

                                {/* Step 3: Configure tool permissions */}
                                <div>
                                    <p className="text-xs font-medium text-slate-300 mb-2">3. Set tool permissions to "Always allow"</p>
                                    <p className="text-xs text-slate-500 mb-2 leading-relaxed">
                                        Click <strong className="text-slate-400">Configure</strong> on the MCP Server connector. You'll see a <strong className="text-slate-400">Tool permissions</strong> section with an <strong className="text-slate-400">Other tools</strong> group. Change the dropdown from "Custom" to <strong className="text-slate-400">Always allow</strong>.
                                    </p>
                                    {/* Visual mock of tool permissions UI */}
                                    <div className="p-3 bg-slate-900/60 border border-slate-700/30 rounded-lg">
                                        <p className="text-xs text-slate-500 mb-2">Look for this on the connector page:</p>
                                        <div className="bg-slate-800/80 rounded border border-slate-600/30 p-3 space-y-2">
                                            <div className="text-xs text-slate-300 font-medium">Tool permissions</div>
                                            <p className="text-[10px] text-slate-500">Choose when Claude is allowed to use these tools</p>
                                            <div className="flex items-center justify-between">
                                                <div className="flex items-center gap-2">
                                                    <span className="text-xs text-slate-400">â–¾</span>
                                                    <span className="text-xs text-slate-300">Other tools</span>
                                                    <span className="text-[10px] text-slate-500 bg-slate-700 px-1.5 py-0.5 rounded">13</span>
                                                </div>
                                                <div className="flex items-center gap-2">
                                                    <div className="flex items-center gap-1.5 px-3 py-1.5 bg-slate-700 border border-green-500/50 rounded text-xs text-green-400 font-medium">
                                                        <span>âœ“</span>
                                                        <span>Always allow</span>
                                                        <span className="text-slate-500 ml-1">â–¾</span>
                                                    </div>
                                                    <span className="text-xs text-slate-600">â† select this</span>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                {/* Step 4: Optional â€” notifications */}
                                <div>
                                    <p className="text-xs font-medium text-slate-300 mb-1">4. Notification settings (optional)</p>
                                    <p className="text-xs text-slate-500 leading-relaxed">
                                        You can also choose when you're notified about tool usage. The default "Smart" setting works well, or set to "None" if you prefer fewer interruptions.
                                    </p>
                                </div>
                            </div>

                            {navButtons(2, 4, 'Next â†’')}
                        </div>
                    )}

                    {/* â”€â”€ Step 4: Connect Claude Code (optional) â”€â”€ */}
                    {step === 4 && (
                        <div>
                            {progressDots}
                            <h3 className="text-lg font-semibold mb-2">Connect Claude Code (optional)</h3>
                            <p className="text-sm text-slate-400 mb-4 leading-relaxed">
                                Claude Code can connect to the same CC data store as Chat.
                                It authenticates via OAuth â€” the same Google Sign-In you used in Step 1.
                            </p>

                            <div className="space-y-4">
                                {/* Sub-step 1: Install Claude Code */}
                                <div>
                                    <p className="text-xs font-medium text-slate-300 mb-2">1. Install Claude Code (if you haven't already)</p>
                                    <p className="text-xs text-slate-500 mb-2 leading-relaxed">
                                        Claude Code builds from specs, deploys code, and logs progress back to CC. It's available as a terminal CLI or a desktop app.
                                    </p>
                                    <a href="https://docs.anthropic.com/en/docs/claude-code/overview" target="_blank" rel="noopener noreferrer"
                                        className="inline-flex items-center gap-2 px-4 py-2 bg-slate-700 hover:bg-slate-600 border border-slate-600/50 rounded-lg text-sm font-medium text-slate-300 transition-colors">
                                        Claude Code Getting Started
                                        <svg className="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14" /></svg>
                                    </a>
                                </div>

                                {/* Sub-step 2: Copy URL and add MCP server */}
                                <div>
                                    <p className="text-xs font-medium text-slate-300 mb-2">2. Add the CC MCP server</p>
                                    <p className="text-xs text-slate-500 mb-2 leading-relaxed">
                                        Copy the server URL below, then add it from within Claude Code:
                                    </p>
                                    <div className="flex items-center gap-2 p-3 bg-slate-700/80 border border-slate-600/50 rounded-lg mb-3">
                                        <code className="flex-1 text-xs text-indigo-300 font-mono select-all break-all">{MCP_SERVER_URL}</code>
                                        <button onClick={() => { navigator.clipboard.writeText(MCP_SERVER_URL); setMcpConfigCopied(true); }}
                                            className={`px-3 py-1.5 rounded text-xs font-medium whitespace-nowrap transition-colors ${
                                                mcpConfigCopied ? 'bg-green-700 text-green-200' : 'bg-indigo-600 hover:bg-indigo-500'
                                            }`}>
                                            {mcpConfigCopied ? 'âœ“ Copied' : 'Copy URL'}
                                        </button>
                                    </div>
                                    <div className="space-y-2">
                                        <div className="p-2.5 bg-slate-700/30 rounded-lg">
                                            <div className="flex items-center gap-2 mb-1">
                                                <span className="text-sm">ðŸ–¥ï¸</span>
                                                <span className="text-xs font-medium text-slate-300">Desktop App</span>
                                            </div>
                                            <p className="text-[11px] text-slate-500 leading-relaxed">
                                                Open <strong className="text-slate-400">Settings â†’ MCP Servers â†’ Add MCP Server</strong>. Choose "Streamable HTTP", paste the URL, and name it <strong className="text-slate-400">cc-mcp</strong>.
                                            </p>
                                        </div>
                                        <div className="p-2.5 bg-slate-700/30 rounded-lg">
                                            <div className="flex items-center gap-2 mb-1">
                                                <span className="text-sm">ðŸ’»</span>
                                                <span className="text-xs font-medium text-slate-300">Terminal CLI</span>
                                            </div>
                                            <p className="text-[11px] text-slate-500 leading-relaxed">
                                                Run: <code className="text-[10px] text-indigo-300 bg-slate-800 px-1.5 py-0.5 rounded">claude mcp add cc-mcp --transport http https://cc-mcp-server-300155036194.us-central1.run.app/mcp</code>
                                            </p>
                                        </div>
                                    </div>
                                </div>

                                {/* Sub-step 3: Authenticate */}
                                <div>
                                    <p className="text-xs font-medium text-slate-300 mb-1">3. Sign in when prompted</p>
                                    <p className="text-xs text-slate-500 leading-relaxed">
                                        Claude Code will open your browser for Google Sign-In.
                                        Use the <strong className="text-slate-400">same Google account</strong> from Step 1.
                                        The connection persists across sessions â€” you only sign in once.
                                    </p>
                                </div>
                            </div>

                            <div className="mt-4 p-3 bg-amber-900/15 border border-amber-700/20 rounded-lg">
                                <p className="text-xs text-amber-300/80">
                                    <strong>Tip:</strong> Both Chat and Code share the same data store. Ideas, concepts, jobs â€” everything stays in sync regardless of which surface you're working from.
                                </p>
                            </div>

                            {navButtons(3, 5, 'Next â†’')}
                        </div>
                    )}

                    {/* â”€â”€ Step 5: All Done â”€â”€ */}
                    {step === 5 && (
                        <div>
                            {progressDots}
                            <h3 className="text-lg font-semibold mb-2">You're All Set!</h3>
                            <p className="text-sm text-slate-400 mb-5 leading-relaxed">
                                Here's a summary of your setup. You can always revisit these in Settings later.
                            </p>
                            <div className="space-y-2 mb-6">
                                <div className="flex items-center gap-2 p-2.5 bg-slate-700/30 rounded-lg">
                                    <span className="text-green-400 text-sm">âœ“</span>
                                    <span className="text-sm text-slate-300">Signed in as {firebaseUser?.displayName || firebaseUser?.email}</span>
                                </div>
                                <div className="flex items-center gap-2 p-2.5 bg-slate-700/30 rounded-lg">
                                    <span className="text-green-400 text-sm">âœ“</span>
                                    <span className="text-sm text-slate-300">GitHub: {validated?.login || 'connected'} ({validated?.repos || '?'} repos){validated?.oauth ? ' â€¢ OAuth â€” no expiration' : ''}</span>
                                </div>
                                <div className="flex items-center gap-2 p-2.5 bg-slate-700/30 rounded-lg">
                                    <span className={`text-sm ${instructionsCopied ? 'text-green-400' : 'text-slate-500'}`}>{instructionsCopied ? 'âœ“' : 'â—‹'}</span>
                                    <span className="text-sm text-slate-300">Claude.ai project {instructionsCopied ? 'with instructions' : 'â€” do this from Settings later'}</span>
                                </div>
                                <div className="flex items-center gap-2 p-2.5 bg-slate-700/30 rounded-lg">
                                    <span className="text-slate-500 text-sm">â—‹</span>
                                    <span className="text-sm text-slate-300">MCP server â€” verify connection in your first chat</span>
                                </div>
                                <div className="flex items-center gap-2 p-2.5 bg-slate-700/30 rounded-lg">
                                    <span className={`text-sm ${mcpConfigCopied ? 'text-green-400' : 'text-slate-500'}`}>{mcpConfigCopied ? 'âœ“' : 'â—‹'}</span>
                                    <span className="text-sm text-slate-300">Claude Code {mcpConfigCopied ? 'â€” MCP server URL copied, add in Claude Code settings' : 'â€” set up anytime from Settings'}</span>
                                </div>
                            </div>

                            <div className="bg-slate-700/30 rounded-lg p-3 text-xs text-slate-400 mb-6">
                                <strong className="text-slate-300">What's next?</strong> Head to the <strong className="text-slate-300">Ideas</strong> tab to create your first Idea, or upload a session package on the Home tab.
                            </div>

                            <div className="flex items-center justify-between">
                                <button onClick={() => setStep(4)} className="px-4 py-2 text-sm text-slate-400 hover:text-white transition-colors">
                                    â† Back
                                </button>
                                <button onClick={handleComplete}
                                    className="px-6 py-3 rounded-lg bg-green-600 hover:bg-green-500 text-white font-bold transition-colors">
                                    ðŸš€ Launch Command Center
                                </button>
                            </div>
                        </div>
                    )}

                    </div>
                </div>
            </div>
        );
    }

    // =========================================================================
    // MAIN APP
    // =========================================================================

    function App() {
        const [view, setView] = React.useState('projects');  // v8.70.19: default to Projects (was 'dashboard')
        const [viewPayload, setViewPayload] = React.useState(null); // v8.65.0: cross-view deep-link payload
        // (multi-app zip state managed in DashboardView)
        // v8.70.15: Removed pendingSessionReturn + pendingOdrcImport state
        // v8.62.0 A6: Non-blocking notification banners (replaces modal dialogs for background detection)
        const [notifications, setNotifications] = React.useState([]);
        const addNotification = React.useCallback((notification) => {
            const id = Date.now();
            setNotifications(prev => [...prev, { id, ...notification }]);
            // Auto-dismiss after 30 seconds
            setTimeout(() => {
                setNotifications(prev => prev.filter(n => n.id !== id));
            }, 30000);
        }, []);
        const dismissNotification = React.useCallback((id) => {
            setNotifications(prev => prev.filter(n => n.id !== id));
        }, []);
        // v8.70.0: Token initialized empty, hydrated from SecretManager in onAuthStateChanged
        const [githubToken, setGithubToken] = React.useState('');
        // v8.70.0: Setup wizard gating â€” true when minimum credentials (GitHub token) are configured
        const [setupComplete, setSetupComplete] = React.useState(false);
        // v8.70.8: Test mode â€” lets existing users preview the setup wizard
        const [wizardTestMode, setWizardTestMode] = React.useState(false);

        // Token expiration tracking (v8.3.3)
        const tokenExpires = React.useMemo(() => {
            try { return SecretManager.get('token_expires') || localStorage.getItem('cc_token_expires') || ''; } catch { return ''; }
        }, [githubToken]);
        const daysUntilExpiry = tokenExpires ? Math.ceil((new Date(tokenExpires) - new Date()) / (1000 * 60 * 60 * 24)) : null;
        const tokenExpiryWarning = githubToken && daysUntilExpiry !== null && daysUntilExpiry <= 14;
        
        // v8.3.3: File protocol detection for local file warning
        const isFileProtocol = window.location.protocol === 'file:';
        const [fileProtocolBannerDismissed, setFileProtocolBannerDismissed] = React.useState(() => {
            try { return sessionStorage.getItem('cc_file_banner_dismissed') === 'true'; } catch { return false; }
        });
        const dismissFileProtocolBanner = () => {
            setFileProtocolBannerDismissed(true);
            try { sessionStorage.setItem('cc_file_banner_dismissed', 'true'); } catch {}
        };
        
        // Dynamic configuration (v7.0.0)
        const [config, setConfig] = React.useState(() => {
            return ConfigManager.load();
        });
        
        // v8.17.0: Firebase config sync status
        const [syncStatus, setSyncStatus] = React.useState(() => 
            FirebaseConfigSync.initialized ? 'syncing' : 'offline'
        );
        const [syncInitialized, setSyncInitialized] = React.useState(false);
        
        // Apps derived from config (legacy compatibility + v7 format)
        const [apps, setApps] = React.useState(() => {
            try { 
                const s = localStorage.getItem('cc_apps_v6'); 
                const oldApps = s ? JSON.parse(s) : null;
                if (oldApps) {
                    // Migrate old format to config
                    const cfg = ConfigManager.load();
                    const migrated = ConfigManager.migrateFromOldFormat(oldApps, cfg);
                    ConfigManager.save(migrated);
                    return ConfigManager.toLegacyAppsFormat(migrated);
                }
                return ConfigManager.toLegacyAppsFormat(ConfigManager.load()); 
            } catch { 
                return ConfigManager.toLegacyAppsFormat(ConfigManager.load()); 
            }
        });
        // v8.70.15: Removed stagedFiles, deployments, activeDeployments, repoHealthAlert (deploy pipeline eliminated)
        const [availableRepos, setAvailableRepos] = React.useState([]);
        
        // Helper functions for managing multiple deployments
        // v8.70.15: Removed addActiveDeployment + updateActiveDeployment + removeActiveDeployment + pendingAutoClose + auto-close effect + setActiveDeployment
        
        // v8.70.15: Removed activeDeployment derived const
        const [modal, setModal] = React.useState(null);
        const [dialog, setDialog] = React.useState(null);
        // v8.70.15: Removed showHistoryPanel + settings state
        
        // Config change handler
        const handleConfigChange = (newConfig) => {
            setConfig(newConfig);
            setApps(ConfigManager.toLegacyAppsFormat(newConfig));
            ConfigManager.save(newConfig);
        };
        
        // Expose apps to detection function (detectAppFromContent runs outside React)
        React.useEffect(() => { window.__CC_APPS = apps; }, [apps]);
        
        // Get active environments from config
        const activeEnvironments = config.environments.active;
        const getEnvColors = (env) => config.environments.colors[env] || config.environments.colors.test;
        const getEnvLabel = (env) => config.environments.labels[env] || env.toUpperCase();
        
        // Dialog helper functions (Promise-based for async usage)
        const showAlert = (message, title) => {
            return new Promise((resolve) => {
                setDialog({ type: 'alert', title, message, onConfirm: resolve });
            });
        };
        
        const showConfirm = (message, title) => {
            return new Promise((resolve) => {
                setDialog({ 
                    type: 'confirm', 
                    title, 
                    message, 
                    onConfirm: () => resolve(true),
                    onCancel: () => resolve(false)
                });
            });
        };
        
        const showPrompt = (message, defaultValue, title) => {
            return new Promise((resolve) => {
                setDialog({ 
                    type: 'prompt', 
                    title, 
                    message, 
                    defaultValue,
                    onConfirm: (value) => resolve(value),
                    onCancel: () => resolve(null)
                });
            });
        };
        // v8.70.15: Removed refreshing + rollbackSnapshots state + save effect
        
        // Save snapshot before deploy (call this before pushing new content)
        // v8.70.15: Removed saveRollbackSnapshot + quickRollback + clearRollbackSnapshot + deployingRepos
        
        // Session log state (persisted to localStorage)
        // v8.70.14: Removed orphaned App-level sessionLog state (SessionLogService removed)
        
        // Global state (synced with Firebase)
        // v8.71.0: Removed globalIssues + globalActivity (no live callers after satellite elimination)
        const [globalWorkItems, setGlobalWorkItems] = React.useState([]);
        const [globalSessions, setGlobalSessions] = React.useState([]);
        const [globalStreams, setGlobalStreams] = React.useState([]); // Phase 5.2: Work streams
        const [teamMembers, setTeamMembers] = React.useState([]); // Phase 5.7: Team members
        const [teamMembership, setTeamMembership] = React.useState(null); // Phase 5.7: Current user's membership (null = owner)
        const [globalConcepts, setGlobalConcepts] = React.useState([]); // Ideation: ODRC concepts
        const [globalIdeas, setGlobalIdeas] = React.useState([]); // Ideation: Ideas
        const [globalJobs, setGlobalJobs] = React.useState([]); // v8.70.18: MCP-managed jobs
        // v8.70.15: Removed globalCompletionJobs + completionJobsLoadedRef + globalOrphanCommits
        // v8.70.15: Removed completionFileSettings state
        const [firebaseUid, setFirebaseUid] = React.useState(null);
        const [firebaseUser, setFirebaseUser] = React.useState(null);
        
        // Listen for Firebase auth and load data
        React.useEffect(() => {
            if (!firebaseAuth) return;

            let unsubscribeSessions = () => {};
            let unsubscribeConcepts = () => {};
            let unsubscribeIdeas = () => {};
            let unsubscribeJobs = () => {};
            // v8.71.0: Removed dead unsubscribe vars (issues, workItems, activity, streams, completionJobs, orphans)
            // Suspended: team, teamMembership, workItems, streams â€” re-enable when features become active

            const unsubscribe = firebaseAuth.onAuthStateChanged((u) => {
                setFirebaseUser(u);
                if (u) {
                    setFirebaseUid(u.uid);
                    SecretManager.setUid(u.uid);
                    FirebaseConfigSync.setUid(u.uid);
                    SecretManager.migrateFromGlobal();
                    firebaseAdmin.loadServiceAccount(); // v8.71.8: Reload SA now that UID-namespaced key is available
                    FirebaseConfigSync.migrateFromGlobal().catch(e =>
                        console.error('[CC] ConfigSync migration failed:', e)
                    );
                    const storedToken = SecretManager.get('token');
                    if (storedToken) setGithubToken(storedToken);
                    setSetupComplete(SecretManager.has('token'));

                    // --- ESSENTIAL LISTENERS ---
                    unsubscribeSessions = SessionService.listen(u.uid, setGlobalSessions);
                    unsubscribeConcepts = ConceptManager.listen(u.uid, setGlobalConcepts);
                    unsubscribeIdeas = IdeaManager.listen(u.uid, setGlobalIdeas);
                    unsubscribeJobs = JobService.listen(u.uid, setGlobalJobs);
                    IdeaManager.backfillMissingFields(u.uid).catch(e =>
                        console.error('[CC] Idea backfill failed:', e)
                    );
                } else {
                    setFirebaseUid(null);
                    SecretManager.setUid(null);
                    FirebaseConfigSync.setUid(null);
                    setSetupComplete(false);
                    setGithubToken('');
                    setGlobalWorkItems([]);
                    setGlobalSessions([]);
                    setGlobalStreams([]);
                    setTeamMembers([]);
                    setTeamMembership(null);
                    setGlobalConcepts([]);
                    setGlobalIdeas([]);
                    setGlobalJobs([]);
                }
            });

            return () => {
                unsubscribe();
                unsubscribeSessions();
                unsubscribeConcepts();
                unsubscribeIdeas();
                unsubscribeJobs();
            };
        }, []);

        // Link issues to a deployed version
        // Phase 5.7: Effective workspace UID â€” if user is a team member, use owner's UID for data access
        const workspaceUid = React.useMemo(() => {
            return TeamService.getWorkspaceUid(firebaseUid, teamMembership);
        }, [firebaseUid, teamMembership]);
        
        // Phase 5.7: Permission check â€” editors and owners can write, viewers are read-only
        const canEdit = React.useMemo(() => TeamService.canEdit(teamMembership), [teamMembership]);
        
        const linkIssuesToVersion = async (issueIds, version, appId) => {
            if (!firebaseUid || !issueIds.length) return;
            await IssueService.linkToVersion(firebaseUid, issueIds, version, appId);
        };
        
        // Use ref to always have latest apps state for async operations
        const appsRef = React.useRef(apps);
        React.useEffect(() => { appsRef.current = apps; }, [apps]);
        
        const github = React.useMemo(() => IS_TEST_MODE && window.MockGitHubAPI ? window.MockGitHubAPI : (githubToken ? new GitHubAPI(githubToken) : null), [githubToken]);
        
        // Persist
        React.useEffect(() => { try { if (githubToken) { SecretManager.set('token', githubToken); } } catch {} }, [githubToken]);
        React.useEffect(() => { try { StorageManager.safeSet('cc_apps_v6', JSON.stringify(apps)); } catch {} }, [apps]);

        // v8.70.14: Removed SessionLogService.save effect (service removed)
        
        // v8.17.0: Firebase Config Sync â€” startup overlay
        // Load localStorage first (instant), then pull from Firebase and overlay if newer.
        // On first run (Firebase empty), push local data up to seed Firebase.
        React.useEffect(() => {
            // v8.70.0: Wait for auth to set UID before syncing (data is now per-user)
            if (!FirebaseConfigSync.initialized || syncInitialized || !firebaseUid) return;
            
            const unsubscribe = FirebaseConfigSync.onStatusChange(setSyncStatus);
            
            const doSync = async () => {
                console.log('[ConfigSync] Starting startup overlay...');
                const remote = await FirebaseConfigSync.pullAll();
                
                if (!remote) {
                    // Firebase unreachable â€” stay with localStorage
                    console.log('[ConfigSync] Firebase unreachable, running offline');
                    setSyncInitialized(true);
                    return;
                }
                
                if (remote.config && remote.config._updatedAt) {
                    // Firebase has data â€” overlay onto local
                    // v8.18.3: Always overlay in Phase 1 (single user). Timestamp comparison
                    // was causing issues where migration bumped local timestamp, blocking overlay.
                    console.log('[ConfigSync] Firebase has config, overlaying...');
                    // Strip sync metadata before merging
                    const { _updatedAt, _updatedBy, ...cleanConfig } = remote.config;
                    const merged = ConfigManager.mergeWithDefaults(cleanConfig);
                        merged._updatedAt = _updatedAt;
                        merged._updatedBy = _updatedBy;
                        
                        // v8.18.5: Merge local apps INTO Firebase overlay â€” local is authoritative
                        // Preserve: local-only apps, local repos, local projects, local versions
                        const localCfg = ConfigManager.load();
                        let reposPreserved = 0;
                        let appsPreserved = 0;
                        if (localCfg.apps) {
                            if (!merged.apps) merged.apps = {};
                            for (const [id, localApp] of Object.entries(localCfg.apps)) {
                                if (!merged.apps[id]) {
                                    // App exists locally but not in Firebase â€” preserve it
                                    merged.apps[id] = { ...localApp };
                                    appsPreserved++;
                                } else {
                                    // App exists in both â€” preserve local repos (authoritative)
                                    if (localApp.repos) {
                                        if (!merged.apps[id].repos) merged.apps[id].repos = {};
                                        if (localApp.repos.test && localApp.repos.test !== merged.apps[id].repos.test) {
                                            merged.apps[id].repos.test = localApp.repos.test;
                                            reposPreserved++;
                                        }
                                        if (localApp.repos.prod && localApp.repos.prod !== merged.apps[id].repos.prod) {
                                            merged.apps[id].repos.prod = localApp.repos.prod;
                                            reposPreserved++;
                                        }
                                    }
                                    // Preserve local versions if Firebase has empty ones
                                    if (localApp.versions) {
                                        if (!merged.apps[id].versions) merged.apps[id].versions = {};
                                        for (const [env, ver] of Object.entries(localApp.versions)) {
                                            if (ver && !merged.apps[id].versions[env]) {
                                                merged.apps[id].versions[env] = ver;
                                            }
                                        }
                                    }
                                }
                            }
                            if (appsPreserved > 0) console.log(`[ConfigSync] Preserved ${appsPreserved} local-only apps during overlay`);
                            if (reposPreserved > 0) console.log(`[ConfigSync] Preserved ${reposPreserved} local repo assignments during overlay`);
                        }
                        
                        // Also preserve local-only projects
                        if (localCfg.projects && merged.projects) {
                            for (const [id, proj] of Object.entries(localCfg.projects)) {
                                if (!merged.projects[id]) {
                                    merged.projects[id] = { ...proj };
                                }
                            }
                        }
                        
                        // Save to localStorage (without re-pushing to Firebase)
                        try { localStorage.setItem(ConfigManager.STORAGE_KEY, JSON.stringify(merged)); localStorage.setItem('gs_config', JSON.stringify(merged)); } catch {}
                        
                        setConfig(merged);
                        setApps(ConfigManager.toLegacyAppsFormat(merged));
                        
                        // Push merged config back if we preserved local data
                        // v8.61.1: Use silent push â€” don't let this optional re-push
                        // set status to 'error' (pullAll already confirmed connection works)
                        if (reposPreserved > 0 || appsPreserved > 0) {
                            FirebaseConfigSync.pushConfig(merged).catch(() => {
                                // Restore synced status â€” pull succeeded, this push is optional
                                if (FirebaseConfigSync.syncStatus === 'error') {
                                    FirebaseConfigSync._setStatus('synced');
                                }
                            });
                        }
                    
        // v8.70.15: Removed deployHistory overlay in startup sync
                    
                    // v8.70.14: Removed sessionLog overlay (SessionLogService removed)
                    
                    console.log('[ConfigSync] Startup overlay complete');
                } else {
                    // v8.70.10: Firebase is empty â€” new user. Seed with clean defaults, NOT localStorage.
                    // localStorage may contain another user's cached data from a previous session on
                    // this browser/device. Using it would leak that user's projects/deploy-history/etc.
                    console.log('[ConfigSync] Firebase empty for this user, seeding with defaults...');
                    const freshConfig = ConfigManager.getDefaultConfig();
                    freshConfig._updatedAt = Date.now();
                    freshConfig._updatedBy = 'seed';

                    // Clear potentially stale localStorage from a different user's session
                    try {
                        localStorage.removeItem(ConfigManager.STORAGE_KEY);
                        localStorage.removeItem('gs_config');
                        localStorage.removeItem('cc_rulesHistory');
                        localStorage.removeItem('cc_session_log');
                        localStorage.removeItem('cc_deletion_history');
                    } catch {}

                    await FirebaseConfigSync.pushAll({
                        config: freshConfig
                    });

                    // Update React state with fresh config
                    try { localStorage.setItem(ConfigManager.STORAGE_KEY, JSON.stringify(freshConfig)); } catch {}
                    setConfig(freshConfig);
                    setApps(ConfigManager.toLegacyAppsFormat(freshConfig));

                    console.log('[ConfigSync] New user seed complete');
                }
                
                setSyncInitialized(true);
            };
            
            doSync();
            
            return () => unsubscribe();
        }, [syncInitialized, firebaseUid]);
        
        // v8.18.0: Force sync handler for Settings UI
        const handleForceSync = async (direction) => {
            if (!FirebaseConfigSync.initialized) return;
            
            if (direction === 'pull') {
                const remote = await FirebaseConfigSync.pullAll();
                if (!remote) throw new Error('Firebase unreachable');
                
                if (remote.config && remote.config._updatedAt) {
                    const { _updatedAt, _updatedBy, ...cleanConfig } = remote.config;
                    const merged = ConfigManager.mergeWithDefaults(cleanConfig);
                    merged._updatedAt = _updatedAt;
                    merged._updatedBy = _updatedBy;
                    try { localStorage.setItem(ConfigManager.STORAGE_KEY, JSON.stringify(merged)); localStorage.setItem('gs_config', JSON.stringify(merged)); } catch {}
                    setConfig(merged);
                    setApps(ConfigManager.toLegacyAppsFormat(merged));
                }
                
        // v8.70.15: Removed deployHistory overlay in force-sync
                
                // v8.70.14: Removed sessionLog overlay (SessionLogService removed)
            }
        };
        
        // Monitor live site until new version appears
        // v8.70.15: Removed monitorLiveDeployment
        
        // Refresh repos list
        const refreshRepos = async () => {
            if (!github) return;
            try {
                const repos = await github.listRepos();
                setAvailableRepos(repos);
                // Re-run auto-mapping
                setApps(prev => autoMapRepos(prev, repos));
            } catch (e) {
                console.error('Failed to refresh repos:', e);
            }
        };
        
        // Fetch repos and auto-refresh versions on load
        React.useEffect(() => {
            if (github) {
                github.listRepos().then(async (repos) => {
                    setAvailableRepos(repos);
                    
                    // Get current apps state and map repos
                    setApps(prev => {
                        const mapped = autoMapRepos(prev, repos);
                        
                        // v8.18.1: Sync auto-detected repos back to config so Firebase gets them
                        setConfig(prevConfig => {
                            let changed = false;
                            const updatedConfig = { ...prevConfig, apps: { ...prevConfig.apps } };
                            for (const [id, app] of Object.entries(mapped)) {
                                if (updatedConfig.apps[id]) {
                                    const configApp = updatedConfig.apps[id];
                                    if (app.testRepo && configApp.repos?.test !== app.testRepo) {
                                        updatedConfig.apps[id] = { ...configApp, repos: { ...configApp.repos, test: app.testRepo } };
                                        changed = true;
                                    }
                                    if (app.prodRepo && configApp.repos?.prod !== app.prodRepo) {
                                        updatedConfig.apps[id] = { ...updatedConfig.apps[id], repos: { ...(updatedConfig.apps[id].repos || {}), prod: app.prodRepo } };
                                        changed = true;
                                    }
                                }
                            }
                            if (changed) {
                                ConfigManager.save(updatedConfig);
                            }
                            return changed ? updatedConfig : prevConfig;
                        });
                        
                        return mapped;
                    });
                    
                    // v8.70.15: Removed refreshAllVersions call (deploy pipeline eliminated)
                }).catch(console.error);
            }
        }, [github]);
        
        // Refresh all versions from repos
        // v8.70.15: Removed refreshAllVersions
        
        // Lightweight repo health check â€” runs once per day
        // v8.70.15: Removed runRepoHealthCheck
        
        // Load repo files
        const updateApp = (appId, updates) => setApps(prev => ({ ...prev, [appId]: { ...prev[appId], ...updates } }));
        
        // v8.69.0: Process session package zip â€” extract, validate, route to import checklist
        // v8.70.15: Removed processSessionPackage

        // File upload - now accepts multiple file types
        // v8.70.15: Removed handleFileDrop (entire ingestion)
        
        // v8.70.15: Removed removeStaged + updateStagedFile (stagedFiles state eliminated)
        
        // Get current deployed version from repo
        // v8.70.15: Removed fetchCurrentVersion
        
        // Deploy single file (legacy support)
        // v8.70.15: Removed handleDeploy
        
        // Multi-file batch deploy
        // v8.70.15: Removed handleBatchDeploy
        
        // v8.70.15: Removed handlePromote
        
        // Rollback
        // v8.70.15: Removed handleRollback
        
        // v8.70.0: Three-state render gate for multi-user mode
        // State 1: Not signed in â†’ show sign-in screen
        if (!firebaseUid) {
            return React.createElement(SignInScreen, null);
        }
        // State 2: Signed in but no GitHub token â†’ show setup wizard
        if (!setupComplete) {
            return React.createElement(SetupWizard, {
                firebaseUser: firebaseUser,
                onComplete: (token, extras) => {
                    SecretManager.set('token', token);
                    if (extras.tokenExpires) SecretManager.set('token_expires', extras.tokenExpires);
                    if (extras.anthropicKey) SecretManager.set('anthropic_api_key', extras.anthropicKey);
                    setGithubToken(token);
                    setSetupComplete(true);
                }
            });
        }
        // State 3: Fully authenticated + configured â†’ main UI
        return (
            <div className="min-h-screen" data-testid="app-loaded">
                {/* v8.70.8: Wizard test mode overlay for existing users */}
                {wizardTestMode && (
                    <div className="fixed inset-0 z-50" style={{zIndex: 9999}}>
                        <div className="absolute top-3 right-3 z-10">
                            <button onClick={() => setWizardTestMode(false)}
                                className="px-3 py-1.5 bg-amber-600 hover:bg-amber-500 rounded-lg text-xs font-medium text-white shadow-lg">
                                Exit Test Mode âœ•
                            </button>
                        </div>
                        {React.createElement(SetupWizard, {
                            firebaseUser: firebaseUser,
                            onComplete: () => setWizardTestMode(false)
                        })}
                    </div>
                )}
                <header className="bg-slate-800 border-b border-slate-700 sticky top-0 z-50">
                    <div className="max-w-6xl mx-auto px-4 py-3">
                        {/* Top row: Logo and main nav */}
                        <div className="flex items-center justify-between">
                            <div className="flex items-center gap-3">
                                <Icons.CCLogo size={32} />
                                <div>
                                    <h1 className="text-lg font-bold">Command Center</h1>
                                    <div className="text-xs text-slate-400 flex items-center gap-1.5">
                                        v{document.querySelector('meta[name="version"]')?.content || '8.52.0'} â€¢ Deploy & manage apps
                                        <span title={`Firebase sync: ${syncStatus}`} className="inline-flex items-center">
                                            {syncStatus === 'synced' && <span className="text-green-400" title="Synced with Firebase">â˜ï¸</span>}
                                            {syncStatus === 'syncing' && <span className="text-yellow-400 animate-pulse" title="Syncing...">ðŸ”„</span>}
                                            {syncStatus === 'offline' && <span className="text-slate-500" title="Offline â€” using local data">âš¡</span>}
                                            {syncStatus === 'error' && <span className="text-red-400" title="Sync error">âš ï¸</span>}
                                        </span>
                                    </div>
                                </div>
                            </div>
                            {/* v8.70.15: Removed Refresh versions button */}
                            <div className="flex items-center gap-1">
                                {/* v8.63.0: Flat tab navigation (N1-N4 nav restructure) */}
                                {/* v8.70.19: Projects absorbs Ideas tab (Phase 3 drill-down) */}
                                {[
                                    { id: 'projects', icon: 'ðŸ“', label: 'Projects', view: 'projects' },
                                    { id: 'jobs', icon: 'ðŸ”¨', label: 'Jobs', view: 'jobs' },
                                    { id: 'sessions', icon: 'ðŸ’¬', label: 'Sessions', view: 'sessions' }
                                ].map(tab => (
                                    <button
                                        key={tab.id}
                                        onClick={() => setView(tab.view)}
                                        className={`px-3 py-1.5 rounded text-sm flex items-center gap-1 ${
                                            view === tab.view ? 'bg-indigo-600 text-white' : 'text-slate-400 hover:text-white hover:bg-slate-700'
                                        }`}
                                    >
                                        <span>{tab.icon}</span> {tab.label}
                                        {tab.badge > 0 && (
                                            <span className="px-1.5 py-0.5 bg-blue-600 text-white rounded-full text-xs font-bold ml-1">{tab.badge}</span>
                                        )}
                                    </button>
                                ))}
                                {/* Settings */}
                                <button
                                    onClick={() => setView('settings')}
                                    className={`px-3 py-1.5 rounded text-sm flex items-center gap-1 ${
                                        view === 'settings' ? 'bg-indigo-600 text-white' : 'text-slate-400 hover:text-white hover:bg-slate-700'
                                    }`}
                                >
                                    <span>âš™ï¸</span> Settings
                                </button>
                            </div>
                        </div>
                        
                        {/* Quick Actions Bar (v8.53.0 simplified) */}
                        <div className="mt-3 pt-3 border-t border-slate-700 flex items-center gap-2 flex-wrap">
                            <span className="text-xs text-slate-500 mr-2">âš¡ Quick:</span>
                            {/* v8.70.19: Ideas now inside Projects drill-down */}
                            <button
                                onClick={() => setView('projects')}
                                className="px-3 py-1 text-xs bg-indigo-600 hover:bg-indigo-500 rounded-full font-medium transition-colors"
                            >
                                ðŸ“‚ Projects
                            </button>
                            {/* v8.70.15: Removed Deploy History + Deploy Staged quick action buttons */}
                            
                            {/* Status indicators */}
                            <div className="ml-auto flex items-center gap-3 text-xs">
                                {isFileProtocol && (
                                    <span className="flex items-center gap-1 text-blue-400" title="Running from local file - some features limited">
                                        <span className="w-2 h-2 rounded-full bg-blue-400"></span>
                                        Local
                                    </span>
                                )}
                                <span className={`flex items-center gap-1 ${github ? 'text-green-400' : 'text-red-400'}`}>
                                    <span className={`w-2 h-2 rounded-full ${github ? 'bg-green-400' : 'bg-red-400'}`}></span>
                                    GitHub
                                </span>
                                <span className={`flex items-center gap-1 ${firebaseDb ? 'text-green-400' : 'text-amber-400'}`}>
                                    <span className={`w-2 h-2 rounded-full ${firebaseDb ? 'bg-green-400' : 'bg-amber-400'}`}></span>
                                    Firebase
                                </span>
                                <span className="text-slate-500">
                                    {availableRepos.length} repos
                                </span>
                                
                                {/* Google Auth */}
                                {firebaseAuth && (
                                    firebaseUser ? (
                                        <React.Fragment>
                                            {teamMembership && (
                                                <span className="text-xs text-cyan-400 bg-cyan-900/30 border border-cyan-700/30 px-2 py-0.5 rounded-full"
                                                    title={`Viewing ${teamMembership.workspaceName || 'shared workspace'} as ${teamMembership.role}`}>
                                                    ðŸ‘¥ {teamMembership.role}
                                                </span>
                                            )}
                                            {!teamMembership && (teamMembers || []).filter(m => m.status === 'active').length > 0 && (
                                                <span className="text-xs text-slate-400" title="Active team members">
                                                    ðŸ‘¥ {(teamMembers || []).filter(m => m.status === 'active').length + 1}
                                                </span>
                                            )}
                                            <button onClick={() => setWizardTestMode(true)}
                                                className="text-xs text-slate-500 hover:text-indigo-400 transition-colors"
                                                title="Preview the new-user setup wizard">
                                                ðŸ§™ Wizard
                                            </button>
                                            <button onClick={async () => { try { await firebaseAuth.signOut(); } catch {} }}
                                                className="flex items-center gap-1.5 text-green-400 hover:text-green-300 transition-colors"
                                                title={`Signed in as ${firebaseUser.email}\nClick to sign out`}>
                                                <img src={firebaseUser.photoURL || ''} className="w-5 h-5 rounded-full" 
                                                    onError={(e) => { e.target.style.display = 'none'; }}
                                                />
                                                <span className="max-w-[100px] truncate">{firebaseUser.displayName?.split(' ')[0] || firebaseUser.email?.split('@')[0]}</span>
                                            </button>
                                        </React.Fragment>
                                    ) : (
                                        <button onClick={async () => {
                                                if (isFileProtocol) return;
                                                try {
                                                    const provider = new firebase.auth.GoogleAuthProvider();
                                                    await firebaseAuth.signInWithPopup(provider);
                                                } catch (e) {
                                                    console.error('Sign in error:', e);
                                                }
                                            }}
                                            disabled={isFileProtocol}
                                            className={`flex items-center gap-1 ${isFileProtocol ? 'text-slate-600 cursor-not-allowed' : 'text-slate-400 hover:text-white'} transition-colors`}
                                            title={isFileProtocol ? 'Google Sign-in requires HTTPS' : 'Sign in with Google'}>
                                            <span className="w-2 h-2 rounded-full bg-slate-500"></span>
                                            Sign In
                                        </button>
                                    )
                                )}
                            </div>
                        </div>
                    </div>
                </header>

                {/* v8.62.0 A6: Non-blocking notification stack (v8.70.5: moved to bottom-right for visibility) */}
                {notifications.length > 0 && (
                    <div className="fixed bottom-4 right-4 z-40 flex flex-col-reverse gap-2" style={{ maxWidth: '360px' }}>
                        {notifications.map((n, idx) => (
                            <div key={n.id} className="bg-slate-800 border border-slate-600 rounded-lg p-3 shadow-lg animate-pulse-once"
                                style={{ animation: 'fadeIn 0.3s ease-out' }}>
                                <div className="flex items-start justify-between gap-2">
                                    <div className="flex-1 min-w-0">
                                        <div className="text-sm font-medium text-slate-200">{n.icon} {n.title}</div>
                                        <p className="text-xs text-slate-400 mt-1">{n.message}</p>
                                    </div>
                                    <button onClick={() => dismissNotification(n.id)}
                                        className="text-slate-500 hover:text-slate-300 text-sm flex-shrink-0">âœ•</button>
                                </div>
                                {n.action && (
                                    <button onClick={() => { n.action.handler(); dismissNotification(n.id); }}
                                        className="mt-2 px-3 py-1 text-xs bg-indigo-600 hover:bg-indigo-500 rounded font-medium">
                                        {n.action.label}
                                    </button>
                                )}
                            </div>
                        ))}
                    </div>
                )}

                {/* v8.70.15: Removed Deploy History slide-out panel */}

                <main className="max-w-6xl mx-auto px-4 py-6">
                    {!githubToken && (
                        <div className="mb-6 p-4 bg-amber-900/50 border border-amber-700 rounded-lg">
                            âš ï¸ <strong>GitHub Token Required</strong> - Go to Settings
                        </div>
                    )}
                    
                    {tokenExpiryWarning && (
                        <div className={`mb-6 p-4 rounded-lg border flex items-center justify-between ${
                            daysUntilExpiry <= 3 
                                ? 'bg-red-900/50 border-red-700 text-red-200'
                                : 'bg-amber-900/50 border-amber-700 text-amber-200'
                        }`}>
                            <div>
                                {daysUntilExpiry <= 0 
                                    ? <><span className="text-lg mr-2">ðŸš¨</span><strong>GitHub token may have expired!</strong></>
                                    : <><span className="text-lg mr-2">{daysUntilExpiry <= 3 ? 'ðŸš¨' : 'âš ï¸'}</span><strong>GitHub token expires in {daysUntilExpiry} days</strong> ({new Date(tokenExpires).toLocaleDateString()})</>
                                }
                            </div>
                            <button onClick={() => setView('settings')} className="px-3 py-1 bg-slate-700 rounded text-sm hover:bg-slate-600">
                                Go to Settings â†’
                            </button>
                        </div>
                    )}
                    
                    {/* v8.3.3: Local file protocol warning */}
                    {isFileProtocol && !fileProtocolBannerDismissed && (
                        <div className="mb-6 p-4 rounded-lg border bg-blue-900/30 border-blue-700 text-blue-200">
                            <div className="flex items-start justify-between gap-4">
                                <div className="flex-1">
                                    <div className="flex items-center gap-2 mb-1">
                                        <span className="text-lg">ðŸŒ</span>
                                        <strong>Running Locally</strong>
                                    </div>
                                    <p className="text-sm text-blue-300">
                                        Some features require HTTPS (Google Auth, Firebase sync). 
                                        For full functionality, use the deployed version at{' '}
                                        <a href={(() => {
                                                const ccApp = apps['command-center'];
                                                const prodRepo = ccApp?.prodRepo || ccApp?.repos?.prod || '';
                                                if (prodRepo) {
                                                    const [owner, repo] = prodRepo.split('/');
                                                    return `https://${owner}.github.io/${repo}/`;
                                                }
                                                return '#';
                                            })()}
                                            target="_blank" 
                                            className="underline text-blue-200 hover:text-white">
                                            Command Center on GitHub Pages
                                        </a>
                                    </p>
                                </div>
                                <button 
                                    onClick={dismissFileProtocolBanner}
                                    className="px-2 py-1 bg-slate-700 rounded text-xs hover:bg-slate-600 text-slate-300">
                                    Dismiss
                                </button>
                            </div>
                        </div>
                    )}
                    
                    {/* v8.70.15: Removed dashboard view routing */}

                    {/* v8.70.19: Projects drill-down replaces ProjectsTab + IdeasView */}
                    {view === 'projects' && (
                        <div className="max-w-6xl mx-auto">
                            <ProjectsDrillDown
                                config={config}
                                updateConfig={handleConfigChange}
                                apps={apps}
                                globalIdeas={globalIdeas}
                                globalConcepts={globalConcepts}
                                globalSessions={globalSessions}
                                globalJobs={globalJobs}
                                firebaseUid={firebaseUid}
                                showAlert={showAlert}
                                showConfirm={showConfirm}
                                showPrompt={showPrompt}
                                github={github}
                                availableRepos={availableRepos}
                                setView={setView}
                            />
                        </div>
                    )}

                    {/* v8.70.18: Jobs + Sessions read-only views */}
                    {view === 'jobs' && (
                        <JobsView globalJobs={globalJobs} apps={apps} globalIdeas={globalIdeas}
                            firebaseUid={firebaseUid} setView={setView} />
                    )}
                    {view === 'sessions' && (
                        <SessionsView globalSessions={globalSessions} apps={apps} globalIdeas={globalIdeas}
                            firebaseUid={firebaseUid} setView={setView} />
                    )}

                    {/* [v8.63.2] Environments moved to Infrastructure satellite (N5) */}
                    
                    {view === 'settings' && (
                        <SettingsView token={githubToken} setToken={setGithubToken} repoCount={availableRepos.length} syncStatus={syncStatus} onForceSync={handleForceSync} config={config} onConfigChange={handleConfigChange} firebaseUid={firebaseUid} firebaseUser={firebaseUser} teamMembers={teamMembers} teamMembership={teamMembership} showAlert={showAlert} showConfirm={showConfirm} apps={apps} />
                    )}
                    
                    {view === 'setup' && (
                        <SetupNewAppView
                            apps={apps}
                            github={github}
                            config={config}
                            updateConfig={handleConfigChange}
                            showAlert={showAlert}
                            showConfirm={showConfirm}
                            onRefreshRepos={refreshRepos}
                            githubOwner={availableRepos[0]?.owner || availableRepos[0]?.fullName?.split('/')[0] || 'stewartdavidp-ship-it'}
                            firebaseUid={firebaseUid}
                        />
                    )}
                    
                    {/* Modals */}
                    {/* v8.70.15: Removed promote, rollback, versionWarning, DeployAll, SyncEnvs modal routing */}
                    
                    {/* v8.70.15: Removed VersionBumpModal (deploy pipeline eliminated) */}
                    
                    {/* v8.69.7: Quick Create App Modal â€” from unassigned idea badge */}
                    {modal?.type === 'quick-create-app' && (
                        <QuickCreateAppModal
                            idea={modal.data.idea}
                            github={github}
                            githubOwner={availableRepos[0]?.owner || 'stewartdavidp-ship-it'}
                            config={config}
                            updateConfig={handleConfigChange}
                            firebaseUid={firebaseUid}
                            onClose={() => setModal(null)}
                            showAlert={showAlert}
                        />
                    )}

                    {/* v8.70.15: Removed AutoReviewModal JSX block */}
                    
                    {/* Custom Dialog Modal (replaces native alert/confirm/prompt) */}
                    {dialog && (
                        <DialogModal
                            type={dialog.type}
                            title={dialog.title}
                            message={dialog.message}
                            defaultValue={dialog.defaultValue}
                            confirmText={dialog.confirmText}
                            cancelText={dialog.cancelText}
                            onConfirm={(value) => {
                                if (dialog.onConfirm) dialog.onConfirm(value);
                                setDialog(null);
                            }}
                            onCancel={() => {
                                if (dialog.onCancel) dialog.onCancel();
                                setDialog(null);
                            }}
                        />
                    )}
                </main>

                {/* v8.70.17: Footer with policy page links */}
                <footer className="border-t border-slate-700/50 mt-12">
                    <div className="max-w-6xl mx-auto px-4 py-4 flex items-center justify-between text-xs text-slate-500">
                        <span>Â© 2026 Dave Stewart</span>
                        <div className="flex items-center gap-3">
                            <a href="/privacy/" className="hover:text-slate-300 transition-colors">Privacy Policy</a>
                            <span>Â·</span>
                            <a href="/terms/" className="hover:text-slate-300 transition-colors">Terms of Service</a>
                            <span>Â·</span>
                            <a href="/acceptable-use/" className="hover:text-slate-300 transition-colors">Acceptable Use</a>
                        </div>
                    </div>
                </footer>
            </div>
        );
    }

    // v8.70.15: Removed VersionWarningModal, DeployAllModal, SyncEnvsModal, RollbackModal, PromoteModal (deploy pipeline eliminated)

    // =========================================================================
    // CONFIRM DELETE MODAL
    // =========================================================================
    
    
    function DialogModal({ type, title, message, defaultValue, confirmText, cancelText, onConfirm, onCancel }) {
        const [inputValue, setInputValue] = React.useState(defaultValue || '');
        const inputRef = React.useRef(null);
        
        React.useEffect(() => {
            if (type === 'prompt' && inputRef.current) {
                inputRef.current.focus();
                inputRef.current.select();
            }
        }, [type]);
        
        const handleKeyDown = (e) => {
            if (e.key === 'Enter') {
                e.preventDefault();
                onConfirm(type === 'prompt' ? inputValue : true);
            } else if (e.key === 'Escape') {
                onCancel();
            }
        };
        
        // Determine icon and colors based on message content
        const isError = message?.toLowerCase().includes('error') || message?.toLowerCase().includes('failed');
        const isWarning = message?.toLowerCase().includes('warning') || message?.toLowerCase().includes('âš ');
        const isSuccess = message?.toLowerCase().includes('âœ“') || message?.toLowerCase().includes('success');
        
        const borderColor = isError ? 'border-red-700' : isWarning ? 'border-amber-700' : isSuccess ? 'border-green-700' : 'border-slate-600';
        const iconColor = isError ? 'text-red-400' : isWarning ? 'text-amber-400' : isSuccess ? 'text-green-400' : 'text-indigo-400';
        
        return (
            <div className="fixed inset-0 bg-black/70 flex items-center justify-center z-[100] p-4" onKeyDown={handleKeyDown}>
                <div className={`bg-slate-800 rounded-xl border ${borderColor} p-6 max-w-md w-full fade-in shadow-2xl`}>
                    {title && (
                        <h2 className={`text-lg font-bold mb-3 flex items-center gap-2 ${iconColor}`}>
                            {isError ? <Icons.AlertTriangle /> : isWarning ? 'âš ï¸' : isSuccess ? 'âœ“' : 'â„¹ï¸'}
                            {title}
                        </h2>
                    )}
                    
                    <div className="text-slate-300 mb-4 whitespace-pre-wrap">{message}</div>
                    
                    {type === 'prompt' && (
                        <input
                            ref={inputRef}
                            type="text"
                            value={inputValue}
                            onChange={(e) => setInputValue(e.target.value)}
                            className="w-full p-3 bg-slate-900 border border-slate-600 rounded-lg mb-4 text-white focus:border-indigo-500 focus:outline-none"
                            placeholder="Enter value..."
                        />
                    )}
                    
                    <div className="flex gap-3">
                        {type !== 'alert' && (
                            <button 
                                onClick={onCancel} 
                                className="flex-1 p-2.5 bg-slate-700 hover:bg-slate-600 rounded-lg transition-colors">
                                {cancelText || 'Cancel'}
                            </button>
                        )}
                        <button 
                            onClick={() => onConfirm(type === 'prompt' ? inputValue : true)} 
                            className={`flex-1 p-2.5 rounded-lg transition-colors ${
                                isError ? 'bg-red-600 hover:bg-red-500' :
                                isWarning ? 'bg-amber-600 hover:bg-amber-500' :
                                'bg-indigo-600 hover:bg-indigo-500'
                            }`}>
                            {confirmText || 'OK'}
                        </button>
                    </div>
                </div>
            </div>
        );
    }

    // =========================================================================
    // v8.69.7: QUICK CREATE APP MODAL â€” from unassigned idea badge
    // =========================================================================

    function QuickCreateAppModal({ idea, github, githubOwner, config, updateConfig, firebaseUid, onClose, showAlert }) {
        const [appName, setAppName] = React.useState(idea?.name || '');
        const [description, setDescription] = React.useState(idea?.description || '');
        const [structure, setStructure] = React.useState('prod-only');
        const [creating, setCreating] = React.useState(false);
        const [status, setStatus] = React.useState('');

        const slug = appName.toLowerCase().replace(/[^a-z0-9]+/g, '-').replace(/^-|-$/g, '');
        const prodRepoName = slug;
        const testRepoName = `${slug}-test`;

        const canCreate = appName.trim().length > 0 && slug.length > 0 && github && githubOwner;

        const handleCreate = async () => {
            if (!canCreate || creating) return;
            setCreating(true);
            try {
                // 1. Check if prod repo exists
                setStatus('Checking repositories...');
                const prodExists = await github.repoExists(githubOwner, prodRepoName);
                if (prodExists) {
                    await showAlert(`Repository "${githubOwner}/${prodRepoName}" already exists. Choose a different name.`, 'Repository Exists');
                    setCreating(false);
                    setStatus('');
                    return;
                }
                if (structure === 'test-prod') {
                    const testExists = await github.repoExists(githubOwner, testRepoName);
                    if (testExists) {
                        await showAlert(`Repository "${githubOwner}/${testRepoName}" already exists. Choose a different name.`, 'Repository Exists');
                        setCreating(false);
                        setStatus('');
                        return;
                    }
                }

                // 2. Create prod repo
                setStatus('Creating production repository...');
                const prodResult = await github.createRepo(prodRepoName, `${appName} - production`, false);
                const prodFullName = prodResult.fullName;

                // 3. Wait for GitHub to initialize, then enable Pages
                setStatus('Enabling GitHub Pages...');
                await new Promise(r => setTimeout(r, 2000));
                try { await github.enablePages(prodFullName); } catch (e) { console.log('Pages may need manual enabling:', e); }

                // 4. Create test repo if test-prod structure
                let testFullName = '';
                if (structure === 'test-prod') {
                    setStatus('Creating test repository...');
                    const testResult = await github.createRepo(testRepoName, `${appName} - test environment`, false);
                    testFullName = testResult.fullName;
                    await new Promise(r => setTimeout(r, 2000));
                    try { await github.enablePages(testFullName); } catch (e) { console.log('Test Pages may need manual enabling:', e); }
                }

                // 5. Create app config
                setStatus('Creating app configuration...');
                const newConfig = ConfigManager.addApp({ ...config, apps: { ...config.apps } }, {
                    name: appName,
                    id: slug,
                    icon: 'ðŸš€',
                    targetPath: 'index.html'
                });
                // Assign repos
                newConfig.apps[slug].repos = {
                    ...newConfig.apps[slug].repos,
                    prod: prodFullName,
                    ...(structure === 'test-prod' ? { test: testFullName } : {})
                };
                newConfig.apps[slug].description = description;
                updateConfig(newConfig);

                // 6. Link idea to new app
                if (idea && firebaseUid) {
                    setStatus('Linking idea to app...');
                    await IdeaManager.update(firebaseUid, idea.id, { appId: slug });
                }

                setStatus('Done!');
                await showAlert(
                    `App "${appName}" created!\n\n` +
                    `Prod: ${prodFullName}\n` +
                    (testFullName ? `Test: ${testFullName}\n` : '') +
                    `\nIdea "${idea?.name}" has been linked.`,
                    'âœ… App Created'
                );
                onClose();
            } catch (e) {
                console.error('QuickCreateApp error:', e);
                await showAlert(`Error: ${e.message}`, 'âŒ Creation Failed');
                setCreating(false);
                setStatus('');
            }
        };

        return (
            <div className="fixed inset-0 bg-black/70 flex items-center justify-center z-50" onClick={onClose}>
                <div className="bg-slate-800 rounded-xl border border-slate-700 p-6 w-full max-w-lg shadow-2xl" onClick={e => e.stopPropagation()}>
                    <div className="flex items-center gap-3 mb-5">
                        <div className="w-10 h-10 rounded-lg bg-gradient-to-br from-indigo-500 to-purple-600 flex items-center justify-center text-lg">ðŸš€</div>
                        <div>
                            <h2 className="text-lg font-bold text-white">Quick Create App</h2>
                            <p className="text-xs text-slate-400">Create app & repo for "{idea?.name}"</p>
                        </div>
                    </div>

                    <div className="space-y-4">
                        {/* App Name */}
                        <div>
                            <label className="block text-sm font-medium text-slate-300 mb-1">App Name</label>
                            <input
                                type="text" value={appName} onChange={e => setAppName(e.target.value)}
                                className="w-full px-3 py-2 bg-slate-900 border border-slate-600 rounded-lg text-white text-sm focus:outline-none focus:border-indigo-500"
                                placeholder="My New App"
                                disabled={creating}
                            />
                            {slug && <p className="text-xs text-slate-500 mt-1">ID: <code className="text-indigo-400">{slug}</code></p>}
                        </div>

                        {/* Description */}
                        <div>
                            <label className="block text-sm font-medium text-slate-300 mb-1">Description (optional)</label>
                            <input
                                type="text" value={description} onChange={e => setDescription(e.target.value)}
                                className="w-full px-3 py-2 bg-slate-900 border border-slate-600 rounded-lg text-white text-sm focus:outline-none focus:border-indigo-500"
                                placeholder="Brief app description"
                                disabled={creating}
                            />
                        </div>

                        {/* Deploy Structure */}
                        <div>
                            <label className="block text-sm font-medium text-slate-300 mb-2">Deploy Structure</label>
                            <div className="space-y-2">
                                <label className={`flex items-start gap-3 p-3 rounded-lg border cursor-pointer transition-all ${structure === 'prod-only' ? 'border-indigo-500 bg-indigo-500/10' : 'border-slate-600 hover:border-slate-500'}`}>
                                    <input type="radio" name="structure" value="prod-only" checked={structure === 'prod-only'} onChange={() => setStructure('prod-only')} className="mt-1" disabled={creating} />
                                    <div>
                                        <div className="text-sm font-medium text-white">Production Only</div>
                                        <div className="text-xs text-slate-400">Single repo â€” deploy directly to production</div>
                                    </div>
                                </label>
                                <label className={`flex items-start gap-3 p-3 rounded-lg border cursor-pointer transition-all ${structure === 'test-prod' ? 'border-indigo-500 bg-indigo-500/10' : 'border-slate-600 hover:border-slate-500'}`}>
                                    <input type="radio" name="structure" value="test-prod" checked={structure === 'test-prod'} onChange={() => setStructure('test-prod')} className="mt-1" disabled={creating} />
                                    <div>
                                        <div className="text-sm font-medium text-white">Test + Production</div>
                                        <div className="text-xs text-slate-400">Two repos â€” test first, then promote to prod</div>
                                    </div>
                                </label>
                            </div>
                        </div>

                        {/* Repo Preview */}
                        <div className="p-3 rounded-lg bg-slate-900/50 border border-slate-700">
                            <div className="text-xs font-medium text-slate-400 mb-2">Repositories to create:</div>
                            <div className="space-y-1">
                                <div className="flex items-center gap-2 text-sm">
                                    <span className="text-green-400">â—</span>
                                    <code className="text-indigo-400">{githubOwner}/{prodRepoName || '...'}</code>
                                    <span className="text-xs text-slate-500">(prod)</span>
                                </div>
                                {structure === 'test-prod' && (
                                    <div className="flex items-center gap-2 text-sm">
                                        <span className="text-yellow-400">â—</span>
                                        <code className="text-yellow-400">{githubOwner}/{testRepoName}</code>
                                        <span className="text-xs text-slate-500">(test)</span>
                                    </div>
                                )}
                            </div>
                        </div>

                        {/* Status */}
                        {status && (
                            <div className="flex items-center gap-2 text-sm text-indigo-400">
                                <svg className="w-4 h-4 animate-spin" viewBox="0 0 24 24" fill="none"><circle cx="12" cy="12" r="10" stroke="currentColor" strokeWidth="3" strokeDasharray="31.4 31.4" strokeLinecap="round" /></svg>
                                {status}
                            </div>
                        )}
                    </div>

                    {/* Actions */}
                    <div className="flex justify-end gap-3 mt-6">
                        <button onClick={onClose} disabled={creating}
                            className="px-4 py-2 text-sm text-slate-400 hover:text-white transition-colors">Cancel</button>
                        <button onClick={handleCreate} disabled={!canCreate || creating}
                            className="px-5 py-2 rounded-lg text-sm font-semibold text-white transition-all disabled:opacity-40 disabled:cursor-not-allowed"
                            style={{ background: canCreate && !creating ? 'linear-gradient(135deg, #667eea, #764ba2)' : '#334155' }}>
                            {creating ? 'Creating...' : 'Create App & Link Idea'}
                        </button>
                    </div>
                </div>
            </div>
        );
    }

    // =========================================================================
    // DASHBOARD VIEW
    // =========================================================================
    
        // v8.70.15: Removed DashboardView component

    // ODRCImportChecklistModal â€” extracted from DashboardView IIFE (v8.64.3 fix: prevent remount on parent re-render)
    // Must be top-level so React keeps a stable component reference across parent re-renders.
    // The IIFE anti-pattern caused remounts that re-ran auto-link cascade and broke Apply button handlers.
    // =========================================================================
        // v8.70.15: Removed ODRCImportChecklistModal

    // (Views extracted to satellites: Repo Files â†’ Infrastructure, Environment Optimization â†’ Analytics,
    //  Users â†’ Analytics, Beta Analytics â†’ Analytics)

    function AppsView({ apps, repos, onUpdate, github }) {
        const [repoDirectories, setRepoDirectories] = React.useState({});
        const [loadingDirs, setLoadingDirs] = React.useState({});
        
        // Fetch directories for a repo
        const fetchDirectories = async (repoFullName) => {
            if (!github || !repoFullName || repoDirectories[repoFullName]) return;
            
            setLoadingDirs(prev => ({ ...prev, [repoFullName]: true }));
            try {
                const contents = await github.listRepoContents(repoFullName, '');
                const dirs = contents
                    .filter(item => item.type === 'dir')
                    .map(item => item.name)
                    .sort();
                setRepoDirectories(prev => ({ ...prev, [repoFullName]: dirs }));
            } catch (e) {
                console.error('Failed to fetch directories for', repoFullName, e);
                setRepoDirectories(prev => ({ ...prev, [repoFullName]: [] }));
            }
            setLoadingDirs(prev => ({ ...prev, [repoFullName]: false }));
        };
        
        // Fetch directories when prod repo changes
        React.useEffect(() => {
            Object.values(apps).forEach(app => {
                if (app.prodRepo && !repoDirectories[app.prodRepo]) {
                    fetchDirectories(app.prodRepo);
                }
            });
        }, [apps, github]);
        
        // Get directories for a given app's prod repo
        const getDirsForApp = (app) => {
            return repoDirectories[app.prodRepo] || [];
        };
        
        return (
            <div className="space-y-6">
                <h2 className="text-xl font-bold">App Configuration</h2>
                <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                    {Object.values(apps).map(app => (
                        <div key={app.id} className="bg-slate-800 rounded-xl border border-slate-700 p-4">
                            <div className="flex items-center gap-2 mb-3">
                                <AppIcon icon={app.icon} size={28} />
                                <span className="font-semibold">{app.name}</span>
                            </div>
                            <div className="space-y-2">
                                <div>
                                    <label className="text-xs text-blue-400">ðŸ§ª TEST</label>
                                    <select value={app.testRepo || ''} onChange={e => onUpdate(app.id, { testRepo: e.target.value })}
                                        className="w-full p-1.5 bg-slate-700 border border-slate-600 rounded text-sm">
                                        <option value="">Select...</option>
                                        {repos.map(r => <option key={r.fullName} value={r.fullName}>{r.name}</option>)}
                                    </select>
                                </div>
                                <div>
                                    <label className="text-xs text-green-400">ðŸš€ PROD</label>
                                    <select value={app.prodRepo || ''} onChange={e => {
                                        onUpdate(app.id, { prodRepo: e.target.value });
                                        if (e.target.value) fetchDirectories(e.target.value);
                                    }}
                                        className="w-full p-1.5 bg-slate-700 border border-slate-600 rounded text-sm">
                                        <option value="">Select...</option>
                                        {repos.map(r => <option key={r.fullName} value={r.fullName}>{r.name}</option>)}
                                    </select>
                                </div>
                                <div>
                                    <label className="text-xs text-slate-400">Sub Path</label>
                                    <select value={app.subPath || ''} onChange={e => onUpdate(app.id, { subPath: e.target.value })}
                                        className="w-full p-1.5 bg-slate-700 border border-slate-600 rounded text-sm font-mono">
                                        <option value="">(root)</option>
                                        {loadingDirs[app.prodRepo] && <option disabled>Loading...</option>}
                                        {getDirsForApp(app).map(dir => (
                                            <option key={dir} value={dir}>{dir}/</option>
                                        ))}
                                    </select>
                                </div>
                                <div>
                                    <label className="text-xs text-slate-400">Target Path</label>
                                    <input type="text" value={app.targetPath} onChange={e => onUpdate(app.id, { targetPath: e.target.value })}
                                        className="w-full p-1.5 bg-slate-700 border border-slate-600 rounded text-sm font-mono" />
                                </div>
                            </div>
                        </div>
                    ))}
                </div>
            </div>
        );
    }

    // =========================================================================
    // HISTORY VIEW
    // =========================================================================
    
        // v8.70.15: Removed HistoryView component

    // =========================================================================
    // SMART DEPLOY â€” Dynamic Zip Resolution Engine (v8.55.0)
    // Replaces hardcoded GS_ACTIVE_FOLDER_MAP with config-driven resolution.
    // Any zip â†’ resolve files â†’ group by repo â†’ validate per-app â†’ deploy.
    // =========================================================================

    /**
     * resolveZipContents(zip, apps)
     * 
     * The core resolution engine. Takes a JSZip instance and the apps config,
     * maps every file in the zip to its target app and repo.
     * 
     * Returns: {
     *   repos: { [repoKey]: { repo, target, apps: { [appId]: { config, files, version, indexContent } }, sharedFiles: [] } },
     *   unmatched: [{ path, reason }],
     *   rootStripped: string|null   // root folder that was stripped, if any
     * }
     */
        // v8.70.15: Removed resolveZipContents + validateMultiAppPackage + isMultiAppZip


    // =========================================================================
    // [v8.63.0] SessionLogView, PostSessionReviewModal, SessionHistoryPanel removed
    // Replaced by Ideation Pipeline (ExploreInChatModal, IdeationBriefGenerator)
    // =========================================================================


    // =========================================================================
    // PROJECT SCOPING â€” Category-Driven Scoping Flow (v8.23.0 / Phase 1.2)
    // =========================================================================
    
    // Category question definitions â€” static data, no AI dependency
    // Built-in scope categories (Phase 5.1: extensible â€” custom categories can override or extend)
    const SCOPE_CATEGORIES = {
        game: { label: 'Game', icon: 'ðŸŽ®', description: 'Puzzle, word game, or interactive game' },
        tool: { label: 'Tool', icon: 'ðŸ”§', description: 'Utility or productivity tool' },
        dashboard: { label: 'Dashboard', icon: 'ðŸ“Š', description: 'Data display or monitoring' },
        content: { label: 'Content', icon: 'ðŸ“„', description: 'Content site or documentation' },
        admin: { label: 'Admin', icon: 'ðŸ”', description: 'Administration or management panel' }
    };
    
    // Helper: get all categories (built-in + custom from config)
    function getAllCategories(config) {
        const custom = config?.customCategories || {};
        return { ...SCOPE_CATEGORIES, ...custom };
    }
    
    // v8.38.0: PM-first intent questions (Phase 2.1 + 2.4)
    // Questions capture INTENT. The package engine translates intent into technology.
    // Removed: tool.settingsPersistence (redundant with dataPersistence)
    // Merged: dashboard.autoRefresh + dashboard.realtime â†’ dashboard.dataUpdates
    const CATEGORY_QUESTIONS = {
        game: [
            { id: 'dailyReset', label: 'Does the game reset daily with a new puzzle?', type: 'toggle', default: true, drives: 'Daily reset logic, streak tracking, puzzle number' },
            { id: 'difficultyModes', label: 'How many difficulty levels?', type: 'select', options: ['none', 'easy-hard', 'multiple'], optionLabels: ['None', 'Two modes (e.g. Easy/Hard)', 'Multiple levels'], default: 'easy-hard', drives: 'Mode selector, separate stats per mode' },
            { id: 'scoringSystem', label: 'How are players scored?', type: 'select', options: ['none', 'points', 'tries', 'time'], optionLabels: ['No scoring', 'Points earned', 'Number of attempts', 'Time to complete'], default: 'points', drives: 'Score display, personal best tracking' },
            { id: 'shareResults', label: 'Can players share their results?', type: 'toggle', default: true, drives: 'Share button with clipboard fallback' },
            { id: 'multiplayer', label: 'Will players interact with each other?', type: 'toggle', default: false, drives: 'User accounts, friend system, battles or leaderboard' },
            { id: 'streaks', label: 'Track daily play streaks?', type: 'toggle', default: true, drives: 'Streak counter, daily play detection' },
            { id: 'achievements', label: 'Reward milestones with achievements?', type: 'toggle', default: false, drives: 'Achievement system, unlock notifications' },
            { id: 'soundEffects', label: 'Include sound effects?', type: 'toggle', default: false, drives: 'Audio on key events, mute toggle' },
            { id: 'tutorial', label: 'Guide new players through the game?', type: 'toggle', default: true, drives: 'Welcome walkthrough, replayable from menu' }
        ],
        tool: [
            { id: 'dataPersistence', label: 'Should data save between sessions?', type: 'select', options: ['none', 'localStorage', 'Firebase'], optionLabels: ['No â€” starts fresh each time', 'Yes â€” on this device', 'Yes â€” synced across devices'], default: 'localStorage', drives: 'Storage strategy and data migration' },
            { id: 'primaryDataType', label: 'What does the user work with?', type: 'text', placeholder: 'e.g. label sheets, expense records, recipes', default: '', drives: 'Data model and CRUD scaffolding' },
            { id: 'multiItem', label: 'Work with a list of items or a single item?', type: 'select', options: [true, false], optionLabels: ['A list of items (browse, select, manage)', 'A single item at a time'], default: true, drives: 'List view, item cards, bulk actions' },
            { id: 'searchFilter', label: 'Will users need to search or filter?', type: 'toggle', default: true, drives: 'Search input, filter controls' },
            { id: 'importExport', label: 'Import or export data?', type: 'toggle', default: true, drives: 'File input, download as JSON/CSV' },
            { id: 'printSupport', label: 'Does anything need to be printed?', type: 'toggle', default: false, drives: 'Print-friendly layout, page breaks' },
            { id: 'undoRedo', label: 'Should users be able to undo mistakes?', type: 'toggle', default: false, drives: 'Undo/redo with Ctrl+Z support' },
            { id: 'keyboardShortcuts', label: 'Power-user keyboard shortcuts?', type: 'toggle', default: false, drives: 'Key bindings, shortcut reference' }
        ],
        dashboard: [
            { id: 'dataSources', label: 'Where does the data come from?', type: 'multi-select', options: ['Firebase', 'API', 'localStorage', 'manual'], optionLabels: ['Database', 'External service', 'Browser storage', 'User input'], default: ['Firebase'], drives: 'Data fetching and refresh strategy' },
            { id: 'layout', label: 'How should data be displayed?', type: 'select', options: ['cards', 'table', 'mixed'], optionLabels: ['Visual cards', 'Data table', 'Mix of both'], default: 'cards', drives: 'Layout pattern and component structure' },
            { id: 'dataUpdates', label: 'How should data stay current?', type: 'select', options: ['manual', 'periodic', 'realtime'], optionLabels: ['Manual refresh only', 'Auto-refresh periodically', 'Live â€” updates instantly'], default: 'periodic', drives: 'Refresh interval or live listeners' },
            { id: 'filtering', label: 'Can users filter what they see?', type: 'toggle', default: true, drives: 'Filter controls, active filter display' },
            { id: 'dateRange', label: 'Filter by date range?', type: 'toggle', default: true, drives: 'Date picker, preset ranges' },
            { id: 'exportData', label: 'Download data as a file?', type: 'toggle', default: false, drives: 'Export to CSV or JSON' }
        ],
        content: [
            { id: 'contentType', label: 'Does the content change?', type: 'select', options: ['static', 'dynamic'], optionLabels: ['Same every time', 'Updates regularly'], default: 'static', drives: 'Static vs runtime content strategy' },
            { id: 'contentSource', label: 'Where does content come from?', type: 'select', options: ['hardcoded', 'Firebase', 'API', 'CMS'], optionLabels: ['Built into the app', 'Database', 'External service', 'Content management system'], default: 'hardcoded', drives: 'Data loading pattern' },
            { id: 'seo', label: 'Should search engines find this?', type: 'toggle', default: false, drives: 'SEO meta tags, Open Graph, semantic HTML' },
            { id: 'mediaTypes', label: 'What types of content?', type: 'multi-select', options: ['text', 'images', 'video', 'audio'], default: ['text'], drives: 'Media handling and optimization' },
            { id: 'navPattern', label: 'How much content?', type: 'select', options: ['single-page', 'multi-section', 'paginated'], optionLabels: ['One page', 'Multiple sections', 'Many pages'], default: 'single-page', drives: 'Navigation structure, scroll behavior' }
        ],
        admin: [
            { id: 'authRequired', label: 'Must users sign in?', type: 'toggle', default: true, drives: 'Login flow, session management' },
            { id: 'roleAccess', label: 'Different permission levels?', type: 'toggle', default: false, drives: 'Role definitions, permission checks' },
            { id: 'crudOps', label: 'Can users create, edit, and delete records?', type: 'toggle', default: true, drives: 'Data tables, edit forms, delete confirmation' },
            { id: 'auditLog', label: 'Track who changed what?', type: 'toggle', default: false, drives: 'Action log with timestamps and attribution' },
            { id: 'bulkOps', label: 'Act on multiple items at once?', type: 'toggle', default: true, drives: 'Multi-select, batch operations' },
            { id: 'dataViz', label: 'Charts or visual summaries?', type: 'toggle', default: false, drives: 'Charts, summary cards, trend indicators' }
        ]
    };
    
    // Universal starting standards (always on by default)
    const UNIVERSAL_STANDARDS = [
        { id: 'css-variables', label: 'CSS variables for all colors â€” :root and [data-theme="dark"]', group: 'theme' },
        { id: 'dark-light-toggle', label: 'Dark mode default with light mode toggle', group: 'theme' },
        { id: 'theme-persistence', label: 'Theme persistence in localStorage', group: 'theme' },
        { id: 'mobile-first', label: 'Mobile-first responsive design', group: 'layout' },
        { id: 'safe-areas', label: 'Safe area support for notched devices', group: 'layout' },
        { id: 'toast-system', label: 'Toast notification system (replaces native alert/confirm/prompt)', group: 'feedback' },
        { id: 'confirm-dialog', label: 'Custom confirm dialog', group: 'feedback' },
        { id: 'hamburger-menu', label: 'Hamburger menu (â˜°) with settings panel', group: 'nav' },
        { id: 'meta-tags', label: 'Meta tags: version and gs-app-id', group: 'infra' },
        { id: 'version-display', label: 'Version display in settings/footer', group: 'infra' },
        { id: 'loading-spinner', label: 'Loading spinner for async operations', group: 'feedback' },
        { id: 'empty-states', label: 'Empty state pattern (icon + message + action)', group: 'feedback' }
    ];
    
    // Category-driven standards (selected based on answers)
    const CATEGORY_STANDARDS = {
        'daily-reset': { label: 'Daily reset at midnight UTC', group: 'game', condition: (cat, ans) => cat === 'game' && ans.dailyReset },
        'streak-tracking': { label: 'Streak tracking with localStorage persistence', group: 'game', condition: (cat, ans) => cat === 'game' && ans.streaks },
        'share-results': { label: 'Share results (navigator.share â†’ clipboard fallback)', group: 'game', condition: (cat, ans) => cat === 'game' && ans.shareResults },
        'difficulty-modes': { label: 'Difficulty mode selector in settings', group: 'game', condition: (cat, ans) => cat === 'game' && ans.difficultyModes !== 'none' },
        'stats-tracking': { label: 'Stats tracking object in localStorage', group: 'game', condition: (cat, ans) => cat === 'game' && ans.scoringSystem !== 'none' },
        'celebration-effects': { label: 'Celebration effects on special achievements', group: 'game', condition: (cat, ans) => cat === 'game' && ans.achievements },
        'tutorial-onboarding': { label: 'Tutorial: welcome modal â†’ guided steps â†’ replay from menu', group: 'game', condition: (cat, ans) => cat === 'game' && ans.tutorial },
        'sound-manager': { label: 'Audio manager with mute toggle', group: 'game', condition: (cat, ans) => cat === 'game' && ans.soundEffects },
        'tab-nav': { label: 'Tab navigation pattern', group: 'tool', condition: (cat, ans) => cat === 'tool' && (ans.multiItem === true || ans.multiItem === 'true') },
        'settings-storage': { label: 'Settings persistence (single localStorage key with JSON)', group: 'tool', condition: (cat, ans) => cat === 'tool' && ans.dataPersistence !== 'none' },
        'import-export': { label: 'Import/export functions', group: 'tool', condition: (cat, ans) => cat === 'tool' && ans.importExport },
        'print-css': { label: 'Print-friendly CSS', group: 'tool', condition: (cat, ans) => cat === 'tool' && ans.printSupport },
        'keyboard-shortcuts': { label: 'Keyboard shortcuts with reference panel', group: 'tool', condition: (cat, ans) => cat === 'tool' && ans.keyboardShortcuts },
        'undo-redo': { label: 'Undo/redo with state history', group: 'tool', condition: (cat, ans) => cat === 'tool' && ans.undoRedo },
        'firebase-auth': { label: 'Firebase Auth: Google sign-in flow with auth state listener', group: 'firebase', condition: (cat, ans) => (cat === 'game' && ans.multiplayer) || (cat === 'admin' && ans.authRequired) || (cat === 'dashboard' && ans.dataSources?.includes('Firebase')) },
        'firebase-rtdb': { label: 'Firebase RTDB: read/write helpers at specified paths', group: 'firebase', condition: (cat, ans) => (cat === 'game' && ans.multiplayer) || (cat === 'admin') || (cat === 'dashboard' && ans.dataSources?.includes('Firebase')) || (cat === 'tool' && ans.dataPersistence === 'Firebase') },
        'firebase-connection': { label: 'Connection status indicator', group: 'firebase', condition: (cat, ans) => (cat === 'game' && ans.multiplayer) || (cat === 'dashboard' && ans.dataUpdates === 'realtime') },
        'auto-refresh': { label: 'Auto-refresh with last-updated display', group: 'dashboard', condition: (cat, ans) => cat === 'dashboard' && ans.dataUpdates === 'periodic' },
        'date-range': { label: 'Date range selector for time-scoped queries', group: 'dashboard', condition: (cat, ans) => cat === 'dashboard' && ans.dateRange },
        'data-export': { label: 'CSV/JSON data export', group: 'dashboard', condition: (cat, ans) => cat === 'dashboard' && ans.exportData },
        'realtime-updates': { label: 'Real-time Firebase listeners with live indicators', group: 'dashboard', condition: (cat, ans) => cat === 'dashboard' && ans.dataUpdates === 'realtime' },
        'seo-tags': { label: 'SEO meta tags, semantic HTML, OG tags', group: 'content', condition: (cat, ans) => cat === 'content' && ans.seo },
        'role-access': { label: 'Role-based access control with UI permission gating', group: 'admin', condition: (cat, ans) => cat === 'admin' && ans.roleAccess },
        'audit-logging': { label: 'Audit logging with timestamps', group: 'admin', condition: (cat, ans) => cat === 'admin' && ans.auditLog },
        'bulk-actions': { label: 'Multi-select with batch operations', group: 'admin', condition: (cat, ans) => cat === 'admin' && ans.bulkOps },
        'data-charts': { label: 'Charts and summary cards', group: 'admin', condition: (cat, ans) => cat === 'admin' && ans.dataViz }
    };
    
    // Feature generation from category answers
    function generateFeaturesFromScope(category, answers) {
        const features = [];
        
        if (category === 'game') {
            if (answers.dailyReset) features.push({ title: 'Daily puzzle generation with midnight UTC reset', description: 'New puzzle each day, puzzle number tracking, automatic reset at midnight UTC', priority: 'core', effort: 'session' });
            if (answers.scoringSystem !== 'none') features.push({ title: `${answers.scoringSystem === 'points' ? 'Points-based' : answers.scoringSystem === 'tries' ? 'Attempts-based' : 'Time-based'} scoring with personal best tracking`, description: `Track ${answers.scoringSystem} per game with historical best`, priority: 'core', effort: 'quick' });
            if (answers.shareResults) features.push({ title: 'Share results with emoji grid', description: 'Navigator.share with clipboard fallback, generates share text with emoji representation', priority: 'core', effort: 'session' });
            if (answers.difficultyModes !== 'none') features.push({ title: `${answers.difficultyModes === 'easy-hard' ? 'Easy/Hard' : 'Multiple'} difficulty modes with separate stats`, description: 'Mode selector in menu/settings with independent statistics tracking', priority: 'core', effort: 'session' });
            if (answers.streaks) features.push({ title: 'Streak tracking with daily play detection', description: 'Current streak, max streak, daily check against localStorage', priority: 'core', effort: 'quick' });
            if (answers.tutorial) features.push({ title: 'Tutorial / onboarding flow', description: 'Welcome modal for first visit, guided walkthrough, replayable from menu', priority: 'nice-to-have', effort: 'session' });
            if (answers.achievements) features.push({ title: 'Achievement system', description: 'Achievement definitions, unlock tracking, celebration notification', priority: 'nice-to-have', effort: 'multi-session' });
            if (answers.soundEffects) features.push({ title: 'Sound effects with mute toggle', description: 'Audio manager, sound triggers on key events, mute in settings', priority: 'nice-to-have', effort: 'session' });
            if (answers.multiplayer) features.push({ title: 'Multiplayer / social features', description: 'Firebase auth, friend connections, battles or shared leaderboard', priority: 'nice-to-have', effort: 'multi-session' });
        }
        
        if (category === 'tool') {
            if (answers.multiItem === true || answers.multiItem === 'true') features.push({ title: 'Multi-item list with CRUD', description: 'List view, item cards, create/edit/delete with confirmation', priority: 'core', effort: 'session' });
            if (answers.searchFilter) features.push({ title: 'Search and filter controls', description: 'Text search, filter dropdowns, clear filters action', priority: 'core', effort: 'quick' });
            if (answers.importExport) features.push({ title: 'Import/export functionality', description: 'File input for import, export to JSON/CSV, format validation', priority: 'core', effort: 'session' });
            if (answers.printSupport) features.push({ title: 'Print support with preview', description: 'Print-friendly CSS, print preview, page break handling', priority: 'core', effort: 'session' });
            if (answers.dataPersistence !== 'none') features.push({ title: 'Persistent settings', description: 'Settings object in localStorage, settings UI in menu', priority: 'core', effort: 'quick' });
            if (answers.undoRedo) features.push({ title: 'Undo/redo system', description: 'State history stack, keyboard shortcuts Ctrl+Z/Y', priority: 'nice-to-have', effort: 'session' });
            if (answers.keyboardShortcuts) features.push({ title: 'Keyboard shortcuts', description: 'Key bindings for common actions, shortcut reference panel', priority: 'nice-to-have', effort: 'quick' });
            if (answers.dataPersistence === 'Firebase') features.push({ title: 'Firebase data persistence', description: 'Firebase RTDB storage with auth, sync status indicator', priority: 'core', effort: 'session' });
        }
        
        if (category === 'dashboard') {
            features.push({ title: `${answers.layout === 'cards' ? 'Card grid' : answers.layout === 'table' ? 'Data table' : 'Mixed'} layout`, description: `Primary data display using ${answers.layout} pattern`, priority: 'core', effort: 'session' });
            if (answers.filtering) features.push({ title: 'Filter controls', description: 'Filter dropdowns, active filter display, clear all action', priority: 'core', effort: 'quick' });
            if (answers.dataUpdates === 'periodic') features.push({ title: 'Auto-refresh with interval', description: 'Configurable refresh interval, last-updated timestamp display', priority: 'core', effort: 'quick' });
            if (answers.dataUpdates === 'realtime') features.push({ title: 'Real-time live updates', description: 'Firebase listeners, live update indicators, connection status', priority: 'core', effort: 'session' });
            if (answers.dateRange) features.push({ title: 'Date range selector', description: 'Date picker for time-scoped data queries, preset ranges', priority: 'core', effort: 'session' });
            if (answers.exportData) features.push({ title: 'Data export (CSV/JSON)', description: 'Export current view to CSV or JSON format', priority: 'nice-to-have', effort: 'quick' });
        }
        
        if (category === 'content') {
            features.push({ title: `${answers.contentType === 'static' ? 'Static' : 'Dynamic'} content display`, description: `Content loaded from ${answers.contentSource}`, priority: 'core', effort: 'session' });
            if (answers.navPattern !== 'single-page') features.push({ title: `${answers.navPattern === 'multi-section' ? 'Section-based' : 'Paginated'} navigation`, description: `${answers.navPattern} navigation with smooth transitions`, priority: 'core', effort: 'session' });
            if (answers.seo) features.push({ title: 'SEO optimization', description: 'Meta tags, OG tags, semantic HTML, structured data', priority: 'core', effort: 'quick' });
            if (answers.mediaTypes?.includes('images')) features.push({ title: 'Image handling', description: 'Responsive images, lazy loading, lightbox', priority: 'core', effort: 'session' });
            if (answers.mediaTypes?.includes('video')) features.push({ title: 'Video embedding', description: 'Video player, responsive embeds', priority: 'core', effort: 'quick' });
        }
        
        if (category === 'admin') {
            if (answers.authRequired) features.push({ title: 'Authentication gate', description: 'Firebase auth, login/logout flow, session management', priority: 'core', effort: 'session' });
            if (answers.crudOps) features.push({ title: 'CRUD data management', description: 'Data tables, edit modals, create/update/delete with confirmation', priority: 'core', effort: 'session' });
            if (answers.bulkOps) features.push({ title: 'Bulk operations', description: 'Multi-select, batch status changes, bulk delete with confirmation', priority: 'core', effort: 'session' });
            if (answers.roleAccess) features.push({ title: 'Role-based access control', description: 'Role definitions, permission checks, UI gating by role', priority: 'core', effort: 'multi-session' });
            if (answers.auditLog) features.push({ title: 'Audit logging', description: 'Action log with timestamps, user attribution, log viewer', priority: 'nice-to-have', effort: 'session' });
            if (answers.dataViz) features.push({ title: 'Data visualization', description: 'Charts, summary cards, trend indicators', priority: 'nice-to-have', effort: 'session' });
        }
        
        return features;
    }
    
    // Assemble starting standards from category + answers
    function assembleStartingStandards(category, answers) {
        const standards = UNIVERSAL_STANDARDS.map(s => s.id);
        Object.entries(CATEGORY_STANDARDS).forEach(([id, spec]) => {
            if (spec.condition(category, answers)) {
                standards.push(id);
            }
        });
        return standards;
    }
    
    // =========================================================================
    // [v8.63.0] CLAUDE_INSTRUCTIONS.md GENERATOR removed â€” replaced by pipeline CLAUDE.md generation
    // Stub retained for ClaudePrepModal backward compatibility
    // =========================================================================
    
    function generateClaudeInstructions(app, scopeData, config) { return ""; }
    
    
    // =========================================================================
    // PRODUCT BRIEF GENERATOR (Phase 5.5)
    // Auto-generated living document in PM language describing the product.
    // Included in Claude Prep packages so any stream owner gets product context
    // without needing another stream's source code.
    // =========================================================================
    
    const ProductBriefGenerator = {
        
        /**
         * Generate PRODUCT_BRIEF.md from existing CC data sources.
         * @param {Object} app - App definition from CC config
         * @param {Object} scopeData - Scope data from Firebase appScopes/{appId} (nullable)
         * @param {Object} config - CC config (for project info)
         * @param {Array} workItems - All work items (will be filtered to this app)
         * @param {Array} deployments - Deploy history
         * @param {Array} streams - Work streams (nullable)
         * @returns {string} Markdown content for PRODUCT_BRIEF.md
         */
        generate(app, scopeData, config, workItems, deployments, streams) {
            const now = new Date();
            const projectDef = config?.projects?.[app.project] || {};
            const appItems = (workItems || []).filter(wi => wi.appId === app.id);
            const appStreams = (streams || []).filter(s => s.appId === app.id);
            const appDeploys = (deployments || []).filter(d => d.appId === app.id && d.status === 'success');
            const cat = scopeData?.category ? (SCOPE_CATEGORIES[scopeData.category] || {}) : {};
            
            let md = '';
            
            // === Header ===
            md += `# ${app.name} â€” Product Brief\n\n`;
            md += `> Living document auto-generated from Command Center project data.\n`;
            md += `> Describes what the product does in PM language â€” not how it's built.\n`;
            md += `> Updated: ${now.toLocaleDateString()}\n\n`;
            
            // === Product Identity ===
            md += `## Product Identity\n\n`;
            const description = scopeData?.description || app.lifecycle?.problemStatement || '';
            if (description) {
                md += `${description}\n\n`;
            }
            md += `- **Category:** ${cat.icon || app.icon || 'ðŸ“¦'} ${cat.label || scopeData?.category || app.lifecycle?.category || 'Application'}\n`;
            if (projectDef.name) md += `- **Project:** ${projectDef.name}\n`;
            md += `- **Maturity:** ${app.lifecycle?.currentMaturity || 'unknown'}`;
            if (app.lifecycle?.maturityTarget && app.lifecycle.maturityTarget !== app.lifecycle.currentMaturity) {
                md += ` â†’ ${app.lifecycle.maturityTarget}`;
            }
            md += `\n`;
            if (app.lifecycle?.targetAudience) md += `- **Audience:** ${app.lifecycle.targetAudience}\n`;
            if (app.lifecycle?.userGoal) md += `- **User Goal:** ${app.lifecycle.userGoal}\n`;
            if (app.lifecycle?.successMetric) md += `- **Success Metric:** ${app.lifecycle.successMetric}\n`;
            
            const prodVer = app.versions?.prod || app.versions?.test || 'â€”';
            const lastDeploy = appDeploys[0];
            md += `- **Current Version:** ${prodVer}`;
            if (lastDeploy) {
                md += ` (deployed ${new Date(lastDeploy.completedAt || lastDeploy.startedAt).toLocaleDateString()})`;
            }
            md += `\n\n`;
            
            // === Key Product Decisions ===
            if (scopeData?.categoryAnswers && Object.keys(scopeData.categoryAnswers).length > 0) {
                md += `## Key Product Decisions\n\n`;
                md += this._formatProductDecisions(scopeData, cat);
                md += '\n';
            }
            
            // === Feature Inventory ===
            md += this._generateFeatureInventory(appItems, scopeData);
            
            // === Work Streams (if any) ===
            if (appStreams.length > 0) {
                md += this._generateStreamOverview(appStreams, appItems);
            }
            
            // === Recent Activity ===
            if (appDeploys.length > 0) {
                md += `## Recent Releases\n\n`;
                const recent = appDeploys.slice(0, 5);
                recent.forEach(d => {
                    const date = new Date(d.completedAt || d.startedAt).toLocaleDateString();
                    const env = (d.target || 'prod').toUpperCase();
                    md += `- **v${d.version || '?'}** (${date}, ${env})`;
                    if (d.workItemsCompleted) md += ` â€” ${d.workItemsCompleted} item${d.workItemsCompleted !== 1 ? 's' : ''} shipped`;
                    md += `\n`;
                });
                md += '\n';
            }
            
            // === Decisions from Scoping ===
            if (scopeData?.decisions && scopeData.decisions.length > 0) {
                md += `## Open Decisions\n\n`;
                scopeData.decisions.forEach(d => {
                    md += `- ${d.title || d}`;
                    if (d.status === 'resolved') md += ` âœ…`;
                    md += `\n`;
                });
                md += '\n';
            }
            
            md += `---\n`;
            md += `*Generated ${now.toLocaleDateString()} by Command Center v${document.querySelector('meta[name="version"]')?.content || '?'}*\n`;
            
            return md;
        },
        
        /**
         * Format scoping category answers as human-readable product decisions.
         */
        _formatProductDecisions(scopeData, cat) {
            const answers = scopeData.categoryAnswers || {};
            let md = '';
            
            // Map technical scope answers to PM-language decisions
            const decisionMap = {
                // Game
                difficulty: { label: 'Difficulty', format: v => v === 'easy-hard' ? 'Two modes (Easy & Hard)' : v === 'multiple' ? 'Multiple levels' : 'No difficulty modes' },
                scoring: { label: 'Scoring', format: v => v === 'points' ? 'Point-based scoring' : v === 'stars' ? 'Star rating' : v === 'streaks' ? 'Streak-based' : v || 'None' },
                dailyPuzzle: { label: 'Daily Content', format: v => v ? 'Yes â€” daily puzzle/challenge' : 'No â€” play anytime' },
                multiplayer: { label: 'Multiplayer', format: v => v ? 'Yes' : 'No â€” single player' },
                sharing: { label: 'Share Results', format: v => v ? 'Yes â€” shareable results' : 'No sharing' },
                
                // Tool
                multiItem: { label: 'Item Model', format: v => v === 'list' ? 'Works with a list of items' : v === 'single' ? 'Single item at a time' : v || 'Unknown' },
                dataPersistence: { label: 'Data Persistence', format: v => v === 'firebase' ? 'Saves to cloud (syncs across devices)' : v === 'localStorage' ? 'Saves locally (this device only)' : v === 'none' ? 'No save â€” session only' : v || 'Unknown' },
                exportImport: { label: 'Import/Export', format: v => v ? 'Yes' : 'No' },
                
                // Dashboard
                dataSource: { label: 'Data Source', format: v => v === 'firebase' ? 'Database' : v === 'api' ? 'External service' : v === 'manual' ? 'User input' : v || 'Unknown' },
                dataUpdates: { label: 'Data Updates', format: v => v === 'realtime' ? 'Instant (real-time)' : v === 'periodic' ? 'Periodic auto-refresh' : 'Manual refresh' },
                
                // Content
                contentType: { label: 'Content Updates', format: v => v === 'dynamic' ? 'Updates regularly' : 'Same every time' },
                navigation: { label: 'Content Size', format: v => v === 'paginated' ? 'Many pages' : v === 'multi-section' ? 'Multiple sections' : 'Single page' },
                
                // Admin
                crudOperations: { label: 'CRUD', format: v => v ? 'Create, edit, and delete records' : 'Read-only' },
                authRequired: { label: 'Authentication', format: v => v ? 'Login required' : 'No auth' }
            };
            
            for (const [key, value] of Object.entries(answers)) {
                const mapper = decisionMap[key];
                if (mapper && value !== undefined && value !== null && value !== '') {
                    md += `- **${mapper.label}:** ${mapper.format(value)}\n`;
                }
            }
            
            return md;
        },
        
        /**
         * Generate the feature inventory section from work items and scope data.
         */
        _generateFeatureInventory(appItems, scopeData) {
            let md = `## Feature Inventory\n\n`;
            
            // Shipped features (done work items)
            const shipped = appItems.filter(wi => wi.status === 'done' && (wi.type === 'feature' || wi.type === 'enhancement'));
            // In-progress
            const inProgress = appItems.filter(wi => (wi.status === 'in-progress' || wi.status === 'review') && (wi.type === 'feature' || wi.type === 'enhancement'));
            // Planned (ready)
            const planned = appItems.filter(wi => wi.status === 'ready' && (wi.type === 'feature' || wi.type === 'enhancement'));
            // Ideas
            const ideas = appItems.filter(wi => wi.status === 'idea' && (wi.type === 'feature' || wi.type === 'enhancement'));
            
            if (shipped.length > 0) {
                md += `### Shipped (${shipped.length})\n`;
                shipped.forEach(wi => {
                    md += `- âœ… ${wi.title}`;
                    if (wi.milestone) md += ` (${wi.milestone})`;
                    md += `\n`;
                });
                md += '\n';
            }
            
            if (inProgress.length > 0) {
                md += `### In Progress (${inProgress.length})\n`;
                inProgress.forEach(wi => {
                    md += `- ðŸ”„ ${wi.title}`;
                    if (wi.status === 'review') md += ` â€” in review`;
                    md += `\n`;
                });
                md += '\n';
            }
            
            if (planned.length > 0) {
                md += `### Planned (${planned.length})\n`;
                planned.forEach(wi => {
                    md += `- ðŸ“‹ ${wi.title}`;
                    if (wi.priority === 'must-have' || wi.priority === 'core') md += ` â­`;
                    md += `\n`;
                });
                md += '\n';
            }
            
            if (ideas.length > 0) {
                md += `### Ideas (${ideas.length})\n`;
                ideas.slice(0, 10).forEach(wi => {
                    md += `- ðŸ’¡ ${wi.title}\n`;
                });
                if (ideas.length > 10) md += `- *...and ${ideas.length - 10} more ideas*\n`;
                md += '\n';
            }
            
            // Also pull from scope's future features if no work items exist yet
            if (shipped.length === 0 && inProgress.length === 0 && planned.length === 0 && scopeData?.v1Features) {
                md += `### Launch Features (from scope)\n`;
                (scopeData.v1Features || []).filter(f => f.priority !== 'out-of-scope').forEach(f => {
                    md += `- ${f.title}`;
                    if (f.priority === 'core' || f.priority === 'must-have') md += ` â­`;
                    md += `\n`;
                });
                md += '\n';
            }
            
            if (shipped.length === 0 && inProgress.length === 0 && planned.length === 0 && !scopeData?.v1Features) {
                md += `*No features tracked yet. Use the Scoping flow or Backlog to define features.*\n\n`;
            }
            
            // Known bugs count
            const bugs = appItems.filter(wi => wi.type === 'bugfix' && wi.status !== 'done' && wi.status !== 'deferred');
            if (bugs.length > 0) {
                md += `### Known Issues (${bugs.length})\n`;
                bugs.forEach(wi => {
                    md += `- ðŸ› ${wi.title}`;
                    if (wi.priority === 'must-have' || wi.priority === 'critical') md += ` â—`;
                    md += `\n`;
                });
                md += '\n';
            }
            
            return md;
        },
        
        /**
         * Generate stream overview section.
         */
        _generateStreamOverview(appStreams, appItems) {
            let md = `## Work Streams\n\n`;
            
            appStreams.forEach(stream => {
                const streamItems = appItems.filter(wi => wi.streamId === stream.id);
                const done = streamItems.filter(wi => wi.status === 'done').length;
                const total = streamItems.length;
                const pct = total > 0 ? Math.round(done / total * 100) : 0;
                
                md += `### ${stream.name}`;
                if (stream.status === 'complete') md += ` âœ…`;
                else if (stream.status === 'blocked') md += ` ðŸš«`;
                md += `\n`;
                if (stream.owner) md += `- **Owner:** ${stream.owner}\n`;
                if (stream.goal) md += `- **Goal:** ${stream.goal}\n`;
                md += `- **Progress:** ${done}/${total} items (${pct}%)\n`;
                if (stream.status !== 'active' && stream.status !== 'complete') md += `- **Status:** ${stream.status}\n`;
                md += '\n';
            });
            
            return md;
        },
        
        /**
         * Check if enough data exists to generate a useful brief.
         */
        hasData(app, scopeData, workItems) {
            const appItems = (workItems || []).filter(wi => wi.appId === app.id);
            return !!(scopeData || appItems.length > 0 || app.lifecycle?.problemStatement || app.lifecycle?.category);
        }
    };
    
    // =========================================================================
    // WORKSTREAM BRIEF GENERATOR (Streams Evolution â€” Session 2)
    // =========================================================================
    
    const WorkstreamBriefGenerator = {
        
        /**
         * Generate a focused workstream brief â€” a ~30-line context block
         * designed to be pasted into a Claude session for continuity.
         * 
         * @param {Object} stream - Stream object from WorkStreamService
         * @param {Object} apps - Apps map {id: appDef} from config
         * @param {Object} versions - Map of appId â†’ {test, prod} version strings
         * @returns {string} Markdown brief
         */
        generate(stream, apps, versions) {
            if (!stream) return '# Error\n\nNo stream data provided.';
            
            const now = new Date();
            let md = '';
            
            // === Header: Identity ===
            md += `# Stream: ${stream.name}\n`;
            md += `Status: ${stream.status || 'active'}`;
            if (stream.project) md += ` | Project: ${stream.project}`;
            
            // App names with versions
            const appIds = stream.appIds?.length > 0 ? stream.appIds : (stream.appId ? [stream.appId] : []);
            if (appIds.length > 0) {
                const appLabels = appIds.map(id => {
                    const appDef = apps?.[id];
                    const name = appDef?.name || id;
                    const ver = versions?.[id];
                    const verStr = ver?.prod || ver?.test;
                    return verStr ? `${name} v${verStr}` : name;
                });
                md += ` | Apps: ${appLabels.join(', ')}`;
            }
            md += '\n';
            
            if (stream.owner) md += `Owner: ${stream.owner}`;
            if (stream.goal) md += ` | Goal: ${stream.goal}`;
            if (stream.owner || stream.goal) md += '\n';
            if (stream.targetRelease) md += `Target: ${stream.targetRelease}\n`;
            md += '\n';
            
            // === Active Concepts ===
            const activeConcepts = (stream.concepts || []).filter(c => c.status === 'active');
            if (activeConcepts.length > 0) {
                md += `## Active Concepts\n`;
                activeConcepts.forEach(c => {
                    md += `- ${c.type.toUpperCase()}: ${c.text}`;
                    if (c.scope?.length > 0) md += ` [${c.scope.join(', ')}]`;
                    md += '\n';
                });
                md += '\n';
            }
            
            // === Open Items ===
            if (stream.openItems?.length > 0) {
                md += `## Open Items\n`;
                stream.openItems.forEach(item => {
                    md += `- ${item}\n`;
                });
                md += '\n';
            }
            
            // === Test Status ===
            if (stream.tests?.coverage) {
                const cov = stream.tests.coverage;
                const parts = [];
                if (cov.pass > 0) parts.push(`${cov.pass} pass`);
                if (cov.fail > 0) parts.push(`${cov.fail} FAIL`);
                if (cov.untested > 0) parts.push(`${cov.untested} untested`);
                md += `## Test Status: ${parts.join(', ')} (${cov.total || 0} total)\n`;
                
                // List failing scenarios if any
                if (stream.tests.scenarios?.length > 0) {
                    const failing = stream.tests.scenarios.filter(s => s.status === 'fail');
                    if (failing.length > 0) {
                        failing.forEach(s => {
                            md += `- âŒ ${s.name}\n`;
                        });
                    }
                }
                md += '\n';
            }
            
            // === Code Review ===
            if (stream.codeReview) {
                md += `## Code Review: ${stream.codeReview.status || 'pending'}\n`;
                if (stream.codeReview.lastReview) md += `Last: ${stream.codeReview.lastReview}\n`;
                if (stream.codeReview.techniques) md += `Techniques: ${stream.codeReview.techniques}\n`;
                if (stream.codeReview.issuesFound != null) {
                    md += `Issues: ${stream.codeReview.issuesFound} found, ${stream.codeReview.issuesFixed || 0} fixed\n`;
                }
                md += '\n';
            }
            
            // === Last Session ===
            if (stream.sessions?.length > 0) {
                const last = stream.sessions[stream.sessions.length - 1];
                md += `## Last Session (${last.date || 'unknown'})\n`;
                if (last.summary) md += `${last.summary}\n`;
                if (last.conceptsAdded > 0) md += `Concepts added: ${last.conceptsAdded}\n`;
                if (last.testsRun > 0) md += `Tests run: ${last.testsRun}\n`;
                md += '\n';
            }
            
            // === Next ===
            if (stream.next) {
                md += `## Next\n`;
                md += `${stream.next}\n\n`;
            }
            
            // === Footer ===
            md += `---\n`;
            md += `*Generated ${now.toLocaleDateString()} by Command Center v${document.querySelector('meta[name="version"]')?.content || '?'}*\n`;
            
            console.log(`[StreamBrief] Generated brief for "${stream.name}" (${activeConcepts.length} concepts, ${stream.openItems?.length || 0} open items)`);
            return md;
        },
        
        /**
         * Check if a stream has enough data for a useful brief.
         */
        hasData(stream) {
            if (!stream) return false;
            return !!(
                stream.name &&
                (stream.concepts?.length > 0 ||
                 stream.openItems?.length > 0 ||
                 stream.sessions?.length > 0 ||
                 stream.tests?.coverage ||
                 stream.codeReview ||
                 stream.next ||
                 stream.goal)
            );
        }
    };
    
    // =========================================================================
    // CONTEXT.md GENERATOR (Phase 3.2)
    // =========================================================================
    
    function generateContextMd(app, scopeData, config) {
        const cat = SCOPE_CATEGORIES[scopeData?.category];
        const answers = scopeData?.categoryAnswers || {};
        const standards = scopeData?.startingStandards || [];
        const prodRepo = app.repos?.prod || '';
        const testRepo = app.repos?.test || '';
        const ccVersion = document.querySelector('meta[name="version"]')?.content || '?';
        
        let md = `# ${app.name} â€” CONTEXT.md\n\n`;
        md += `> **Read this first** at the start of every session.\n\n`;
        
        // Current Version
        md += `## Current Version\n\n`;
        md += `**v0.1.0** â€” Released ${new Date().toLocaleDateString()}\n\n`;
        
        // What It Is
        md += `## What ${app.name} Is\n\n`;
        md += `${scopeData?.description || app.description || app.name + ' is a web application.'}\n\n`;
        
        // Architecture
        md += `## Architecture\n\n`;
        md += `- **Single-file HTML app**: All CSS/JS inline in ${app.targetPath || 'index.html'}\n`;
        
        // Framework from category
        if (scopeData?.category === 'game' || scopeData?.category === 'dashboard') {
            md += `- **Framework**: React via CDN (development recommended, switch to production for deploy)\n`;
        } else {
            md += `- **Framework**: Vanilla JS (or React via CDN if complexity warrants)\n`;
        }
        
        // Data layer from answers
        const hasFirebase = standards.some(s => s.startsWith('firebase-'));
        const usesLocalStorage = (answers.dataPersistence === 'localStorage') || 
            (scopeData?.category === 'game' && !answers.multiplayer);
        if (hasFirebase && usesLocalStorage) {
            md += `- **Data**: Firebase RTDB + localStorage (Firebase for shared/social data, localStorage for local settings/stats)\n`;
        } else if (hasFirebase) {
            md += `- **Data**: Firebase RTDB\n`;
        } else if (usesLocalStorage || scopeData?.category === 'game') {
            md += `- **Data**: localStorage\n`;
        } else {
            md += `- **Data**: localStorage (or Firebase if persistence scope expands)\n`;
        }
        
        // PWA
        md += `- **PWA**: ${app.hasServiceWorker ? 'Yes â€” sw.js + manifest.json' : 'No'}\n`;
        
        // Deploy target
        if (testRepo) {
            md += `- **Deploy target**: Test: https://${(testRepo).split('/')[0]}.github.io/${(testRepo).split('/')[1]}/ â†’ Prod: https://${(prodRepo).split('/')[0]}.github.io/${(prodRepo).split('/')[1]}/\n`;
        } else if (prodRepo) {
            md += `- **Deploy target**: https://${(prodRepo).split('/')[0]}.github.io/${(prodRepo).split('/')[1]}/\n`;
        }
        md += `\n`;
        
        // Key Technical Details
        md += `## Key Technical Details\n\n`;
        
        // Meta Tags
        md += `### Meta Tags (Required)\n`;
        md += `\`\`\`html\n`;
        md += `<meta name="version" content="X.Y.Z">\n`;
        md += `<meta name="gs-app-id" content="${app.id}">\n`;
        md += `\`\`\`\n\n`;
        
        // Data Schema stubs
        md += `### Data Schema\n\n`;
        if (hasFirebase) {
            md += `Firebase paths (under \`word-boxing-default-rtdb\`):\n`;
            md += `\`\`\`\n`;
            if (standards.includes('firebase-auth')) {
                md += `users/{uid}/\n`;
                md += `  â””â”€â”€ profile: { displayName, photoURL, lastLogin }\n`;
            }
            if (scopeData?.category === 'game') {
                md += `${app.id}/\n`;
                md += `  â”œâ”€â”€ puzzles/ (if server-driven puzzles)\n`;
                if (answers.multiplayer) {
                    md += `  â”œâ”€â”€ battles/ (matchmaking, results)\n`;
                    md += `  â”œâ”€â”€ leaderboard/ (rankings)\n`;
                }
                md += `  â””â”€â”€ stats/{uid}/ (per-user stats)\n`;
            } else {
                md += `${app.id}/\n`;
                md += `  â””â”€â”€ data/{uid}/ (per-user data)\n`;
            }
            md += `\`\`\`\n\n`;
        }
        
        if (usesLocalStorage || scopeData?.category === 'game') {
            md += `localStorage keys:\n`;
            md += `\`\`\`\n`;
            md += `${app.id}-settings    â†’ { theme, ... }\n`;
            if (scopeData?.category === 'game') {
                md += `${app.id}-stats       â†’ { gamesPlayed, gamesWon, streak, maxStreak, ... }\n`;
                md += `${app.id}-gameState   â†’ { puzzleNumber, guesses, status, ... }\n`;
            } else {
                md += `${app.id}-data        â†’ { ... }\n`;
            }
            md += `\`\`\`\n\n`;
        }
        
        // Key Components placeholder
        md += `### Key Components / Functions\n\n`;
        md += `*Update this section as the codebase develops. Map major components and what they do so Claude can navigate the code.*\n\n`;
        
        // Deployment
        md += `## Deployment\n\n`;
        md += `- **Prod Repo:** ${prodRepo || 'TBD'}\n`;
        if (testRepo) md += `- **Test Repo:** ${testRepo}\n`;
        if (app.subPath) md += `- **SubPath:** ${app.subPath}\n`;
        md += `- **Structure:** ${testRepo ? 'Dual (test â†’ prod)' : 'Single repo'}\n`;
        md += `- **Deploy type:** ${app.hasServiceWorker ? 'PWA package (index.html + sw.js + manifest.json + icons/)' : 'Single HTML file'}\n`;
        md += `- **Deploy tool:** Command Center â€” deploy to test, verify, promote to prod\n\n`;
        
        // Conventions from standards
        md += `## Conventions\n\n`;
        
        // Pull key conventions from the starting standards
        const themeStds = standards.filter(s => ['css-variables', 'dark-light-toggle', 'theme-persistence'].includes(s));
        if (themeStds.length > 0) {
            md += `- **Theming:** CSS variables on \`:root\` and \`[data-theme="dark"]\`. Dark mode default, light mode toggle. Theme persisted in localStorage.\n`;
        }
        
        if (standards.includes('hamburger-menu')) {
            md += `- **Navigation:** Hamburger menu (â˜°) with settings panel\n`;
        }
        
        if (standards.includes('toast-system')) {
            md += `- **Notifications:** Custom toast system â€” no native alert/confirm/prompt\n`;
        }
        
        if (standards.includes('mobile-first')) {
            md += `- **Layout:** Mobile-first responsive design\n`;
        }
        
        // Category-specific conventions
        if (scopeData?.category === 'game') {
            md += `- **Game data:** Stats and game state in localStorage with daily reset at midnight UTC\n`;
            if (answers.shareResults) md += `- **Sharing:** navigator.share with clipboard fallback, emoji grid format\n`;
        }
        
        if (scopeData?.category === 'tool') {
            if (answers.primaryDataType) md += `- **Primary data:** ${answers.primaryDataType}\n`;
        }
        
        md += `\n`;
        
        // Recent Changes
        md += `## Recent Changes\n\n`;
        md += `**v0.1.0** â€” Initial seed generated by Command Center. App shell with placeholder content.\n`;
        
        md += `\n---\n`;
        md += `*Generated ${new Date().toLocaleDateString()} by Command Center v${ccVersion}*\n`;
        
        return md;
    }
    
    // =========================================================================
    // PROJECT_PLAN.md GENERATOR (Phase 3.2)
    // =========================================================================
    
    function generateProjectPlanMd(app, scopeData) {
        const ccVersion = document.querySelector('meta[name="version"]')?.content || '?';
        const coreFeatures = (scopeData?.v1Features || []).filter(f => f.priority === 'core');
        const niceFeatures = (scopeData?.v1Features || []).filter(f => f.priority === 'nice-to-have');
        const futureFeatures = scopeData?.futureFeatures || [];
        const unresolvedDecisions = (scopeData?.keyDecisions || []).filter(d => !d.resolved);
        const resolvedDecisions = (scopeData?.keyDecisions || []).filter(d => d.resolved);
        const answers = scopeData?.categoryAnswers || {};
        const cat = SCOPE_CATEGORIES[scopeData?.category];
        
        let md = `# ${app.name} â€” Project Plan\n\n`;
        
        // Mission
        md += `## Mission\n\n`;
        md += `${scopeData?.description || app.description || app.name + ' â€” purpose to be defined.'}\n\n`;
        
        // Completed Features
        md += `## Completed Features\n\n`;
        md += `*Nothing yet â€” this is a new project.*\n\n`;
        
        // In Progress
        md += `## In Progress\n\n`;
        md += `- [ ] Initial build from seed â€” implement core features from V1 scope below\n\n`;
        
        // Planned Features
        md += `## Planned Features\n\n`;
        
        if (coreFeatures.length > 0) {
            md += `### Phase 1: Core (Must Build)\n\n`;
            coreFeatures.forEach(f => {
                md += `- [ ] **${f.title}**`;
                if (f.description) md += ` â€” ${f.description}`;
                if (f.effort) md += ` _(${f.effort})_`;
                md += `\n`;
            });
            md += `\n`;
        }
        
        if (niceFeatures.length > 0) {
            md += `### Phase 2: Nice to Have\n\n`;
            niceFeatures.forEach(f => {
                md += `- [ ] **${f.title}**`;
                if (f.description) md += ` â€” ${f.description}`;
                md += `\n`;
            });
            md += `\n`;
        }
        
        if (futureFeatures.length > 0) {
            md += `### Future / Ideas\n\n`;
            futureFeatures.forEach(f => {
                md += `- [ ] **${f.title}**`;
                if (f.description) md += ` â€” ${f.description}`;
                md += `\n`;
            });
            md += `\n`;
        }
        
        // Architecture Decisions
        md += `## Architecture Decisions\n\n`;
        
        // Always-present decisions from the ecosystem
        md += `- **Single-file HTML**: All CSS/JS inline â€” no build step, no bundler. This is a Game Shelf ecosystem convention.\n`;
        md += `- **Deploy via Command Center**: GitHub Pages repos managed through CC. Test â†’ prod promotion workflow.\n`;
        
        // Category-driven decisions
        if (scopeData?.category === 'game') {
            md += `- **Category: Game**: ${cat?.description || 'Game application'}\n`;
            if (answers.dailyReset) md += `- **Daily reset**: Midnight UTC, puzzle number derived from epoch date\n`;
            if (answers.scoringSystem && answers.scoringSystem !== 'none') md += `- **Scoring**: ${answers.scoringSystem}-based scoring with personal best tracking\n`;
            if (answers.difficultyModes && answers.difficultyModes !== 'none') md += `- **Difficulty**: ${answers.difficultyModes === 'easy-hard' ? 'Easy/Hard' : 'Multiple'} modes with separate statistics\n`;
        } else if (scopeData?.category === 'tool') {
            md += `- **Category: Tool**: ${cat?.description || 'Utility application'}\n`;
            if (answers.dataPersistence) md += `- **Data persistence**: ${answers.dataPersistence}\n`;
        } else if (scopeData?.category === 'dashboard') {
            md += `- **Category: Dashboard**: ${cat?.description || 'Data display application'}\n`;
            if (answers.layout) md += `- **Layout**: ${answers.layout} pattern\n`;
        } else if (scopeData?.category) {
            md += `- **Category: ${cat?.label || scopeData.category}**: ${cat?.description || ''}\n`;
        }
        
        // Resolved decisions from scoping
        if (resolvedDecisions.length > 0) {
            resolvedDecisions.forEach(d => {
                md += `- **${d.title}**`;
                if (d.description) md += ` â€” ${d.description}`;
                md += ` âœ…\n`;
            });
        }
        
        md += `\n`;
        
        // Open Questions
        md += `## Open Questions\n\n`;
        if (unresolvedDecisions.length > 0) {
            unresolvedDecisions.forEach(d => {
                md += `- **${d.title}**`;
                if (d.description) md += ` â€” ${d.description}`;
                md += `\n`;
            });
        } else {
            md += `*No open questions from scoping. Add questions here as they arise during development.*\n`;
        }
        
        md += `\n---\n`;
        md += `*Generated ${new Date().toLocaleDateString()} by Command Center v${ccVersion}*\n`;
        
        return md;
    }
    
    // ProjectScopeModal â€” 3-step scoping flow (v8.37.0: removed Step 4 Standards)
    function ProjectScopeModal({ app, apps, onSave, onCancel, showAlert, config }) {
        const [step, setStep] = React.useState(1);
        
        // Step 1: Describe
        const [description, setDescription] = React.useState(app?.lifecycle?.scope?.description || '');
        const [category, setCategory] = React.useState(app?.lifecycle?.scope?.category || '');
        
        // Step 2: Category answers
        const [categoryAnswers, setCategoryAnswers] = React.useState(() => {
            if (app?.lifecycle?.scope?.categoryAnswers) return { ...app.lifecycle.scope.categoryAnswers };
            // Initialize defaults from category questions
            const defaults = {};
            if (category && CATEGORY_QUESTIONS[category]) {
                CATEGORY_QUESTIONS[category].forEach(q => {
                    defaults[q.id] = q.default;
                });
            }
            return defaults;
        });
        
        // Step 3: Features
        const [v1Features, setV1Features] = React.useState(app?.lifecycle?.scope?.v1Features || []);
        const [futureFeatures, setFutureFeatures] = React.useState(app?.lifecycle?.scope?.futureFeatures || []);
        const [keyDecisions, setKeyDecisions] = React.useState(app?.lifecycle?.scope?.keyDecisions || []);
        const [featuresGenerated, setFeaturesGenerated] = React.useState(false);
        
        // Standards (auto-assembled silently â€” no user step)
        const [startingStandards, setStartingStandards] = React.useState(app?.lifecycle?.scope?.startingStandards || []);
        
        // New feature/decision forms
        const [newFeatureTitle, setNewFeatureTitle] = React.useState('');
        const [newFutureTitle, setNewFutureTitle] = React.useState('');
        const [newDecisionTitle, setNewDecisionTitle] = React.useState('');
        
        // Re-initialize defaults when category changes
        React.useEffect(() => {
            if (category && CATEGORY_QUESTIONS[category]) {
                const existingAnswers = app?.lifecycle?.scope?.categoryAnswers || {};
                const defaults = {};
                CATEGORY_QUESTIONS[category].forEach(q => {
                    defaults[q.id] = existingAnswers[q.id] !== undefined ? existingAnswers[q.id] : q.default;
                });
                // Migrate old dashboard questions: autoRefresh + realtime â†’ dataUpdates
                if (category === 'dashboard' && !existingAnswers.dataUpdates) {
                    if (existingAnswers.realtime) defaults.dataUpdates = 'realtime';
                    else if (existingAnswers.autoRefresh) defaults.dataUpdates = 'periodic';
                    else defaults.dataUpdates = 'manual';
                }
                // Migrate old tool.settingsPersistence â†’ derived from dataPersistence
                setCategoryAnswers(defaults);
            }
        }, [category]);
        
        // Auto-generate features when moving from step 2 â†’ 3
        // Auto-assemble standards when moving from step 2 â†’ 3
        const handleStep2Next = () => {
            if (!featuresGenerated) {
                const generated = generateFeaturesFromScope(category, categoryAnswers);
                if (v1Features.length === 0) {
                    setV1Features(generated);
                }
                setFeaturesGenerated(true);
            }
            setStep(3);
        };
        
        // Add feature
        const addV1Feature = () => {
            if (!newFeatureTitle.trim()) return;
            setV1Features(prev => [...prev, { title: newFeatureTitle.trim(), description: '', priority: 'core', effort: 'session' }]);
            setNewFeatureTitle('');
        };
        
        const addFutureFeature = () => {
            if (!newFutureTitle.trim()) return;
            setFutureFeatures(prev => [...prev, { title: newFutureTitle.trim(), description: '' }]);
            setNewFutureTitle('');
        };
        
        const addKeyDecision = () => {
            if (!newDecisionTitle.trim()) return;
            setKeyDecisions(prev => [...prev, { title: newDecisionTitle.trim(), description: '', resolved: false }]);
            setNewDecisionTitle('');
        };
        
        const removeV1Feature = (idx) => setV1Features(prev => prev.filter((_, i) => i !== idx));
        const removeFutureFeature = (idx) => setFutureFeatures(prev => prev.filter((_, i) => i !== idx));
        const removeKeyDecision = (idx) => setKeyDecisions(prev => prev.filter((_, i) => i !== idx));
        
        const updateV1Feature = (idx, field, value) => {
            setV1Features(prev => prev.map((f, i) => i === idx ? { ...f, [field]: value } : f));
        };
        
        // Final save â€” standards auto-assembled silently
        const handleSave = () => {
            const autoStandards = assembleStartingStandards(category, categoryAnswers);
            const scope = {
                description,
                category,
                categoryAnswers,
                v1Features,
                futureFeatures,
                keyDecisions,
                startingStandards: autoStandards,
                scopedAt: new Date().toISOString(),
                scopedBy: config?.ownerName || 'Owner',
                source: 'manual'
            };
            onSave(scope);
        };
        
        // Render question input based on type
        const renderQuestion = (q) => {
            const value = categoryAnswers[q.id];
            
            if (q.type === 'toggle') {
                return (
                    <label key={q.id} className="flex items-center justify-between p-3 bg-slate-700/50 rounded-lg hover:bg-slate-700 cursor-pointer">
                        <div className="flex-1 pr-4">
                            <div className="text-sm font-medium flex items-center gap-1.5">
                                {q.label}
                                {q.drives && (
                                    <span className="relative group inline-flex">
                                        <span className="text-slate-500 hover:text-slate-300 cursor-help text-xs">â“˜</span>
                                        <span className="absolute bottom-full left-1/2 -translate-x-1/2 mb-1.5 px-2.5 py-1.5 bg-slate-900 border border-slate-600 rounded text-[11px] text-slate-300 whitespace-nowrap opacity-0 group-hover:opacity-100 pointer-events-none transition-opacity z-10 shadow-lg">{q.drives}</span>
                                    </span>
                                )}
                            </div>
                        </div>
                        <div className="relative">
                            <input type="checkbox" className="sr-only" checked={!!value}
                                onChange={e => setCategoryAnswers(prev => ({ ...prev, [q.id]: e.target.checked }))} />
                            <div className={`w-11 h-6 rounded-full transition-colors ${value ? 'bg-indigo-600' : 'bg-slate-600'}`}>
                                <div className={`w-5 h-5 bg-white rounded-full shadow transform transition-transform mt-0.5 ${value ? 'translate-x-5.5 ml-[22px]' : 'translate-x-0.5 ml-[2px]'}`} />
                            </div>
                        </div>
                    </label>
                );
            }
            
            if (q.type === 'select') {
                return (
                    <div key={q.id} className="p-3 bg-slate-700/50 rounded-lg">
                        <div className="text-sm font-medium mb-1 flex items-center gap-1.5">
                            {q.label}
                            {q.drives && (
                                <span className="relative group inline-flex">
                                    <span className="text-slate-500 hover:text-slate-300 cursor-help text-xs">â“˜</span>
                                    <span className="absolute bottom-full left-1/2 -translate-x-1/2 mb-1.5 px-2.5 py-1.5 bg-slate-900 border border-slate-600 rounded text-[11px] text-slate-300 whitespace-nowrap opacity-0 group-hover:opacity-100 pointer-events-none transition-opacity z-10 shadow-lg">{q.drives}</span>
                                </span>
                            )}
                        </div>
                        <select value={value !== undefined ? value : q.default}
                            onChange={e => {
                                let val = e.target.value;
                                // Handle boolean selects (multiItem)
                                if (val === 'true') val = true;
                                if (val === 'false') val = false;
                                setCategoryAnswers(prev => ({ ...prev, [q.id]: val }));
                            }}
                            className="w-full bg-slate-800 border border-slate-600 rounded px-3 py-1.5 text-sm">
                            {q.options.map((opt, oi) => <option key={String(opt)} value={opt}>{q.optionLabels?.[oi] || opt}</option>)}
                        </select>
                    </div>
                );
            }
            
            if (q.type === 'multi-select') {
                const selected = value || q.default || [];
                return (
                    <div key={q.id} className="p-3 bg-slate-700/50 rounded-lg">
                        <div className="text-sm font-medium mb-1 flex items-center gap-1.5">
                            {q.label}
                            {q.drives && (
                                <span className="relative group inline-flex">
                                    <span className="text-slate-500 hover:text-slate-300 cursor-help text-xs">â“˜</span>
                                    <span className="absolute bottom-full left-1/2 -translate-x-1/2 mb-1.5 px-2.5 py-1.5 bg-slate-900 border border-slate-600 rounded text-[11px] text-slate-300 whitespace-nowrap opacity-0 group-hover:opacity-100 pointer-events-none transition-opacity z-10 shadow-lg">{q.drives}</span>
                                </span>
                            )}
                        </div>
                        <div className="flex flex-wrap gap-2">
                            {q.options.map((opt, oi) => (
                                <button key={opt}
                                    onClick={() => {
                                        const next = selected.includes(opt) ? selected.filter(s => s !== opt) : [...selected, opt];
                                        setCategoryAnswers(prev => ({ ...prev, [q.id]: next }));
                                    }}
                                    className={`px-3 py-1 rounded text-xs font-medium transition-colors ${
                                        selected.includes(opt) ? 'bg-indigo-600 text-white' : 'bg-slate-800 text-slate-400 hover:bg-slate-600'
                                    }`}>
                                    {q.optionLabels?.[oi] || opt}
                                </button>
                            ))}
                        </div>
                    </div>
                );
            }
            
            if (q.type === 'text') {
                return (
                    <div key={q.id} className="p-3 bg-slate-700/50 rounded-lg">
                        <div className="text-sm font-medium mb-1 flex items-center gap-1.5">
                            {q.label}
                            {q.drives && (
                                <span className="relative group inline-flex">
                                    <span className="text-slate-500 hover:text-slate-300 cursor-help text-xs">â“˜</span>
                                    <span className="absolute bottom-full left-1/2 -translate-x-1/2 mb-1.5 px-2.5 py-1.5 bg-slate-900 border border-slate-600 rounded text-[11px] text-slate-300 whitespace-nowrap opacity-0 group-hover:opacity-100 pointer-events-none transition-opacity z-10 shadow-lg">{q.drives}</span>
                                </span>
                            )}
                        </div>
                        <input value={value || ''}
                            onChange={e => setCategoryAnswers(prev => ({ ...prev, [q.id]: e.target.value }))}
                            placeholder={q.placeholder}
                            className="w-full bg-slate-800 border border-slate-600 rounded px-3 py-1.5 text-sm" />
                    </div>
                );
            }
            
            return null;
        };
        
        return (
            <div className="fixed inset-0 bg-black/70 flex items-start justify-center z-50 overflow-y-auto p-4 pt-8">
                <div className="bg-slate-800 rounded-xl border border-slate-700 w-full max-w-3xl shadow-2xl">
                    {/* Header */}
                    <div className="flex items-center justify-between p-5 border-b border-slate-700">
                        <div>
                            <h2 className="text-lg font-bold flex items-center gap-2">
                                ðŸŽ¯ Project Scoping {app?.name ? `â€” ${app.icon || ''} ${app.name}` : ''}
                            </h2>
                            <p className="text-xs text-slate-400 mt-1">Define what to build â†’ get a prioritized feature list and work items ready for Claude.</p>
                        </div>
                        <button onClick={onCancel} className="text-slate-400 hover:text-white text-xl">âœ•</button>
                    </div>
                    
                    {/* Progress Steps */}
                    <div className="flex items-center gap-2 px-5 py-3 bg-slate-900/50">
                        {[
                            { n: 1, label: 'Describe' },
                            { n: 2, label: 'Clarify' },
                            { n: 3, label: 'Features' }
                        ].map((s, i) => (
                            <React.Fragment key={s.n}>
                                <button onClick={() => { if (s.n < step) setStep(s.n); }}
                                    className={`flex items-center gap-1.5 px-3 py-1.5 rounded-lg text-xs font-medium transition-colors ${
                                        step === s.n ? 'bg-indigo-600 text-white' : step > s.n ? 'bg-green-600/20 text-green-400 cursor-pointer hover:bg-green-600/30' : 'bg-slate-800 text-slate-500'
                                    }`}>
                                    {step > s.n ? 'âœ“' : s.n} {s.label}
                                </button>
                                {i < 2 && <div className={`flex-1 h-px ${step > s.n ? 'bg-green-600' : 'bg-slate-700'}`} />}
                            </React.Fragment>
                        ))}
                    </div>
                    
                    {/* Content */}
                    <div className="p-5 max-h-[60vh] overflow-y-auto">
                        
                        {/* Step 1: Describe */}
                        {step === 1 && (
                            <div className="space-y-4">
                                <div>
                                    <label className="block text-sm font-medium mb-2">What does this app do? Who is it for? What problem does it solve?</label>
                                    <textarea value={description} onChange={e => setDescription(e.target.value)}
                                        rows={4} placeholder="A daily word puzzle where players uncover a hidden quote by guessing letters..."
                                        className="w-full bg-slate-900 border border-slate-600 rounded-lg px-4 py-3 text-sm focus:border-indigo-500 focus:outline-none resize-none" />
                                    <p className="text-xs text-slate-500 mt-1">3-5 sentences describing purpose, audience, and core concept</p>
                                </div>
                                
                                <div>
                                    <label className="block text-sm font-medium mb-2">App Category</label>
                                    <div className="grid grid-cols-5 gap-2">
                                        {Object.entries(SCOPE_CATEGORIES).map(([id, cat]) => (
                                            <button key={id}
                                                onClick={() => setCategory(id)}
                                                className={`p-3 rounded-lg border text-center transition-all ${
                                                    category === id 
                                                        ? 'border-indigo-500 bg-indigo-500/15 ring-1 ring-indigo-500/50' 
                                                        : 'border-slate-600 hover:border-slate-500 bg-slate-700/30'
                                                }`}>
                                                <div className="text-2xl mb-1">{cat.icon}</div>
                                                <div className="text-xs font-medium">{cat.label}</div>
                                            </button>
                                        ))}
                                    </div>
                                </div>
                            </div>
                        )}
                        
                        {/* Step 2: Clarify */}
                        {step === 2 && (
                            <div>
                                <div className="flex items-center gap-2 mb-4">
                                    <span className="text-xl">{SCOPE_CATEGORIES[category]?.icon}</span>
                                    <h3 className="font-semibold">{SCOPE_CATEGORIES[category]?.label} Questions</h3>
                                </div>
                                <div className="space-y-2">
                                    {(CATEGORY_QUESTIONS[category] || []).map(q => renderQuestion(q))}
                                </div>
                            </div>
                        )}
                        
                        {/* Step 3: Features */}
                        {step === 3 && (
                            <div className="space-y-6">
                                {/* Launch Features */}
                                <div>
                                    <h3 className="font-semibold text-sm mb-2 flex items-center gap-2">
                                        ðŸŽ¯ Launch Features <span className="text-xs font-normal text-slate-400">must ship</span>
                                        <span className="text-xs px-2 py-0.5 bg-slate-700 rounded-full">{v1Features.length}</span>
                                    </h3>
                                    <div className="space-y-2 mb-3">
                                        {v1Features.map((f, idx) => (
                                            <div key={idx} className="bg-slate-700/50 rounded-lg p-3">
                                                <div className="flex items-start justify-between gap-2">
                                                    <div className="flex-1">
                                                        <input value={f.title} onChange={e => updateV1Feature(idx, 'title', e.target.value)}
                                                            className="w-full bg-transparent text-sm font-medium border-none outline-none" />
                                                        <input value={f.description || ''} onChange={e => updateV1Feature(idx, 'description', e.target.value)}
                                                            placeholder="Brief description..."
                                                            className="w-full bg-transparent text-xs text-slate-400 border-none outline-none mt-1" />
                                                    </div>
                                                    <div className="flex items-center gap-2 shrink-0">
                                                        <select value={f.priority} onChange={e => updateV1Feature(idx, 'priority', e.target.value)}
                                                            className="bg-slate-800 border border-slate-600 rounded px-2 py-1 text-xs">
                                                            <option value="core">Must have</option>
                                                            <option value="nice-to-have">Nice to have</option>
                                                            <option value="out-of-scope">Not now</option>
                                                        </select>
                                                        <select value={f.effort} onChange={e => updateV1Feature(idx, 'effort', e.target.value)}
                                                            className="bg-slate-800 border border-slate-600 rounded px-2 py-1 text-xs">
                                                            <option value="quick">Quick</option>
                                                            <option value="session">Session</option>
                                                            <option value="multi-session">Multi-session</option>
                                                            <option value="epic">Epic</option>
                                                        </select>
                                                        <button onClick={() => removeV1Feature(idx)} className="text-slate-500 hover:text-red-400 text-xs">âœ•</button>
                                                    </div>
                                                </div>
                                            </div>
                                        ))}
                                    </div>
                                    <div className="flex gap-2">
                                        <input value={newFeatureTitle} onChange={e => setNewFeatureTitle(e.target.value)}
                                            onKeyDown={e => e.key === 'Enter' && addV1Feature()}
                                            placeholder="Add a V1 feature..."
                                            className="flex-1 bg-slate-700 border border-slate-600 rounded px-3 py-1.5 text-sm" />
                                        <button onClick={addV1Feature} disabled={!newFeatureTitle.trim()}
                                            className="px-3 py-1.5 bg-indigo-600 hover:bg-indigo-500 disabled:bg-slate-700 disabled:text-slate-500 rounded text-sm">
                                            Add
                                        </button>
                                    </div>
                                </div>
                                
                                {/* Future Features */}
                                <div>
                                    <h3 className="font-semibold text-sm mb-2 flex items-center gap-2">
                                        ðŸ”® Future Features <span className="text-xs font-normal text-slate-400">V2+ â€” inform architecture, don't build yet</span>
                                        <span className="text-xs px-2 py-0.5 bg-slate-700 rounded-full">{futureFeatures.length}</span>
                                    </h3>
                                    <div className="space-y-1 mb-3">
                                        {futureFeatures.map((f, idx) => (
                                            <div key={idx} className="flex items-center gap-2 bg-slate-700/30 rounded px-3 py-2">
                                                <span className="flex-1 text-sm text-slate-300">{f.title}</span>
                                                <button onClick={() => removeFutureFeature(idx)} className="text-slate-500 hover:text-red-400 text-xs">âœ•</button>
                                            </div>
                                        ))}
                                    </div>
                                    <div className="flex gap-2">
                                        <input value={newFutureTitle} onChange={e => setNewFutureTitle(e.target.value)}
                                            onKeyDown={e => e.key === 'Enter' && addFutureFeature()}
                                            placeholder="Add a future feature idea..."
                                            className="flex-1 bg-slate-700 border border-slate-600 rounded px-3 py-1.5 text-sm" />
                                        <button onClick={addFutureFeature} disabled={!newFutureTitle.trim()}
                                            className="px-3 py-1.5 bg-slate-600 hover:bg-slate-500 disabled:bg-slate-700 disabled:text-slate-500 rounded text-sm">
                                            Add
                                        </button>
                                    </div>
                                </div>
                                
                                {/* Key Decisions */}
                                <div>
                                    <h3 className="font-semibold text-sm mb-2 flex items-center gap-2">
                                        ðŸ¤” Key Decisions <span className="text-xs font-normal text-slate-400">resolve before or during Session 1</span>
                                        <span className="text-xs px-2 py-0.5 bg-slate-700 rounded-full">{keyDecisions.length}</span>
                                    </h3>
                                    <div className="space-y-1 mb-3">
                                        {keyDecisions.map((d, idx) => (
                                            <div key={idx} className="flex items-center gap-2 bg-amber-900/10 border border-amber-800/30 rounded px-3 py-2">
                                                <span className="text-amber-400 text-xs">â“</span>
                                                <span className="flex-1 text-sm text-slate-300">{d.title}</span>
                                                <button onClick={() => removeKeyDecision(idx)} className="text-slate-500 hover:text-red-400 text-xs">âœ•</button>
                                            </div>
                                        ))}
                                    </div>
                                    <div className="flex gap-2">
                                        <input value={newDecisionTitle} onChange={e => setNewDecisionTitle(e.target.value)}
                                            onKeyDown={e => e.key === 'Enter' && addKeyDecision()}
                                            placeholder="Add a key decision to resolve..."
                                            className="flex-1 bg-slate-700 border border-slate-600 rounded px-3 py-1.5 text-sm" />
                                        <button onClick={addKeyDecision} disabled={!newDecisionTitle.trim()}
                                            className="px-3 py-1.5 bg-amber-700 hover:bg-amber-600 disabled:bg-slate-700 disabled:text-slate-500 rounded text-sm">
                                            Add
                                        </button>
                                    </div>
                                </div>
                            </div>
                        )}
                    </div>
                    
                    {/* Footer */}
                    <div className="flex items-center justify-between p-5 border-t border-slate-700">
                        <button onClick={() => step > 1 ? setStep(step - 1) : onCancel()}
                            className="px-4 py-2 text-sm text-slate-400 hover:text-white transition-colors">
                            {step > 1 ? 'â† Back' : 'Cancel'}
                        </button>
                        
                        <div className="flex items-center gap-3">
                            {step === 3 && (
                                <span className="text-xs text-slate-400">
                                    Will generate {v1Features.length + futureFeatures.length + keyDecisions.length} work items
                                </span>
                            )}
                            
                            {step < 3 ? (
                                <button onClick={() => {
                                        if (step === 1) { if (!description.trim() || !category) return; setStep(2); }
                                        else if (step === 2) handleStep2Next();
                                    }}
                                    disabled={step === 1 && (!description.trim() || !category)}
                                    className="px-6 py-2 bg-indigo-600 hover:bg-indigo-500 disabled:bg-slate-700 disabled:text-slate-500 rounded-lg text-sm font-medium transition-colors">
                                    Next â†’
                                </button>
                            ) : (
                                <button onClick={handleSave}
                                    className="px-6 py-2 bg-green-600 hover:bg-green-500 rounded-lg text-sm font-medium transition-colors flex items-center gap-2">
                                    âœ… Save Scope & Generate Work Items
                                </button>
                            )}
                        </div>
                    </div>
                </div>
            </div>
        );
    }
    
    // =========================================================================
    // BACKLOG VIEW - Work Item Tracking & Project Planning (v8.22.0)
    // =========================================================================
    
        // v8.70.15: Removed WorkItemEditModal
    
        // v8.70.15: Removed BacklogView component

    // =========================================================================
        // v8.70.15: Removed IdeaWorkCard + PHASE_COLORS + STALE constants

        // v8.70.15: Removed ExploreInChatModal component

    // =========================================================================
    // IDEAS VIEW â€” ODRC Concept Management + CLAUDE.md Generation + Idea-to-Chat (v8.61.0)
    // =========================================================================

    function IdeasView({ apps, globalIdeas, globalConcepts, firebaseUid, showAlert, showConfirm, showPrompt, config, setView, github, viewPayload, setViewPayload }) {
        const [mode, setMode] = React.useState('all'); // 'all' | 'app-aggregate' | 'idea-detail'
        const [selectedAppId, setSelectedAppId] = React.useState(null);
        const [selectedIdeaId, setSelectedIdeaId] = React.useState(null);
        const [showEditModal, setShowEditModal] = React.useState(null); // null | { concept, isNew, defaultIdeaId }
        const [showTransitionModal, setShowTransitionModal] = React.useState(null); // null | { concept, targetType }
        // [v8.63.0] showGenerateModal removed â€” GenerateCLAUDEModal replaced by pipeline
        // v8.70.15: Removed showExploreModal (ExploreInChatModal eliminated)
        const [showCreateIdeaModal, setShowCreateIdeaModal] = React.useState(false); // v8.62.0: two-field idea creation
        const [sessionHistoryExpanded, setSessionHistoryExpanded] = React.useState(false);
        const [typeFilter, setTypeFilter] = React.useState('all');
        const [statusFilter, setStatusFilter] = React.useState('active');
        const [appFilter, setAppFilter] = React.useState('all');
        const [activeConceptTab, setActiveConceptTab] = React.useState('OPEN'); // v8.64.2: Mode 3 ODRC tabs
        const [conceptSearchFilter, setConceptSearchFilter] = React.useState(''); // v8.64.2: cross-mode text search
        const [conceptStatusFilter, setConceptStatusFilter] = React.useState('all'); // v8.64.2: Mode 3 status filter

        const configuredApps = React.useMemo(() => Object.values(apps).filter(a => a.testRepo || a.prodRepo || a.repos), [apps]);

        // v8.65.0: Deep-link from DashboardView work cards
        React.useEffect(() => {
            if (!viewPayload) return;
            if (viewPayload.ideaId) {
                const idea = globalIdeas.find(i => i.id === viewPayload.ideaId);
                if (idea) {
                    if (idea.appId) { setSelectedAppId(idea.appId); setSelectedIdeaId(idea.id); setMode('idea-detail'); }
                    else { setSelectedIdeaId(idea.id); setMode('idea-detail'); }
                }
            }
            if (viewPayload.createIdea) { setShowCreateIdeaModal(true); }
            if (setViewPayload) setViewPayload(null);
        }, [viewPayload]);

        // v8.70.15: Removed exploreIdea memo (ExploreInChatModal eliminated)

        // === Type/Status styling constants ===
        const TYPE_STYLES = {
            'RULE':       { color: 'bg-red-900/50 text-red-300 border-red-800/50', icon: 'ðŸ“' },
            'CONSTRAINT': { color: 'bg-amber-900/50 text-amber-300 border-amber-800/50', icon: 'ðŸ”’' },
            'DECISION':   { color: 'bg-blue-900/50 text-blue-300 border-blue-800/50', icon: 'ðŸŽ¯' },
            'OPEN':       { color: 'bg-purple-900/50 text-purple-300 border-purple-800/50', icon: 'â“' }
        };
        const STATUS_STYLES = {
            'active': 'bg-green-900/50 text-green-300',
            'superseded': 'bg-slate-700 text-slate-400 line-through',
            'resolved': 'bg-emerald-900/50 text-emerald-300',
            'transitioned': 'bg-indigo-900/50 text-indigo-300'
        };

        // === Computed data ===
        const filteredConcepts = React.useMemo(() => {
            let list = globalConcepts;
            if (typeFilter !== 'all') list = list.filter(c => c.type === typeFilter);
            if (statusFilter !== 'all') list = list.filter(c => c.status === statusFilter);
            if (appFilter !== 'all') {
                const ideaIds = globalIdeas.filter(i => i.appId === appFilter).map(i => i.id);
                list = list.filter(c => ideaIds.includes(c.ideaOrigin));
            }
            if (conceptSearchFilter) {
                const q = conceptSearchFilter.toLowerCase();
                list = list.filter(c => c.content.toLowerCase().includes(q));
            }
            return list;
        }, [globalConcepts, typeFilter, statusFilter, appFilter, globalIdeas, conceptSearchFilter]);

        const appIdeas = React.useMemo(() => {
            if (!selectedAppId) return [];
            return globalIdeas.filter(i => i.appId === selectedAppId).sort((a, b) => (a.sequence || 0) - (b.sequence || 0));
        }, [globalIdeas, selectedAppId]);

        const appActiveConcepts = React.useMemo(() => {
            if (!selectedAppId) return [];
            const ideaIds = appIdeas.map(i => i.id);
            return globalConcepts.filter(c => ideaIds.includes(c.ideaOrigin) && c.status === 'active');
        }, [globalConcepts, appIdeas, selectedAppId]);

        const ideaConcepts = React.useMemo(() => {
            if (!selectedIdeaId) return [];
            return globalConcepts.filter(c => c.ideaOrigin === selectedIdeaId);
        }, [globalConcepts, selectedIdeaId]);

        // v8.64.2: Filtered views for text search + status filter
        const filteredAppConcepts = React.useMemo(() => {
            let list = appActiveConcepts;
            if (conceptSearchFilter) {
                const q = conceptSearchFilter.toLowerCase();
                list = list.filter(c => c.content.toLowerCase().includes(q));
            }
            return list;
        }, [appActiveConcepts, conceptSearchFilter]);

        const filteredIdeaConcepts = React.useMemo(() => {
            let list = ideaConcepts;
            if (conceptStatusFilter !== 'all') list = list.filter(c => c.status === conceptStatusFilter);
            if (conceptSearchFilter) {
                const q = conceptSearchFilter.toLowerCase();
                list = list.filter(c => c.content.toLowerCase().includes(q));
            }
            return list;
        }, [ideaConcepts, conceptStatusFilter, conceptSearchFilter]);

        // v8.64.2: Auto-switch tab if OPEN has 0 items but another tab has items
        React.useEffect(() => {
            if (mode !== 'idea-detail' || !selectedIdeaId || filteredIdeaConcepts.length === 0) return;
            const currentCount = filteredIdeaConcepts.filter(c => c.type === activeConceptTab).length;
            if (currentCount === 0) {
                const best = ODRC_TYPES.reduce((max, t) => {
                    const count = filteredIdeaConcepts.filter(c => c.type === t).length;
                    return count > max.count ? { type: t, count } : max;
                }, { type: 'OPEN', count: 0 });
                if (best.count > 0) setActiveConceptTab(best.type);
            }
        }, [mode, selectedIdeaId, filteredIdeaConcepts, activeConceptTab]);

        const stats = React.useMemo(() => ({
            total: globalConcepts.length,
            active: globalConcepts.filter(c => c.status === 'active').length,
            byType: ODRC_TYPES.reduce((acc, t) => { acc[t] = globalConcepts.filter(c => c.type === t && c.status === 'active').length; return acc; }, {})
        }), [globalConcepts]);

        // === CRUD operations ===
        const createConcept = async (data) => {
            if (!firebaseUid) return;
            try {
                await ConceptManager.create(firebaseUid, data);
                setShowEditModal(null);
                await showAlert('Concept created', 'âœ… Success');
                console.log('[CC] Created concept:', data.type, data.content.slice(0, 50));
            } catch (e) { await showAlert(`Error: ${e.message}`, 'âŒ Error'); }
        };

        const updateConcept = async (conceptId, updates) => {
            if (!firebaseUid) return;
            try {
                await ConceptManager.update(firebaseUid, conceptId, updates);
                setShowEditModal(null);
                await showAlert('Concept updated', 'âœ… Success');
            } catch (e) { await showAlert(`Error: ${e.message}`, 'âŒ Error'); }
        };

        const deleteConcept = async (concept) => {
            const confirmed = await showConfirm(`Delete this ${concept.type}?\n\n"${concept.content.slice(0, 100)}..."`, 'ðŸ—‘ï¸ Delete Concept');
            if (!confirmed) return;
            try {
                await ConceptManager.remove(firebaseUid, concept.id);
                await showAlert('Concept deleted', 'âœ… Deleted');
            } catch (e) { await showAlert(`Error: ${e.message}`, 'âŒ Error'); }
        };

        const transitionConcept = async (conceptId, newType) => {
            if (!firebaseUid) return;
            try {
                const result = await ConceptManager.transition(firebaseUid, conceptId, newType);
                setShowTransitionModal(null);
                let msg = `Transitioned to ${newType}`;
                if (result?.flaggedConcepts?.length > 0) {
                    msg += `\n\nâš ï¸ ${result.flaggedConcepts.length} related concept(s) flagged for review (shared scope tags with transitioning CONSTRAINT)`;
                }
                await showAlert(msg, 'âœ… Transitioned');
                console.log('[CC] Transitioned concept to', newType);
            } catch (e) { await showAlert(`Error: ${e.message}`, 'âŒ Error'); }
        };

        // v8.62.0: Opens the two-field Create Idea modal instead of sequential prompts
        const createIdea = () => setShowCreateIdeaModal(true);

        const graduateIdea = async (ideaId) => {
            if (!selectedAppId) {
                await showAlert('Select an app first', 'âš ï¸ No App');
                return;
            }
            const confirmed = await showConfirm('Graduate this idea? It will be linked to the app and marked as graduated.', 'ðŸŽ“ Graduate Idea');
            if (!confirmed) return;
            try {
                await IdeaManager.graduate(firebaseUid, ideaId, selectedAppId);
                await showAlert('Idea graduated', 'âœ… Success');
            } catch (e) { await showAlert(`Error: ${e.message}`, 'âŒ Error'); }
        };

        const archiveIdea = async (ideaId) => {
            const confirmed = await showConfirm('Archive this idea?', 'ðŸ“¦ Archive Idea');
            if (!confirmed) return;
            try {
                await IdeaManager.archive(firebaseUid, ideaId);
                await showAlert('Idea archived', 'âœ… Archived');
            } catch (e) { await showAlert(`Error: ${e.message}`, 'âŒ Error'); }
        };

        // === CreateIdeaModal (v8.62.0 â€” A2: Separate name/description) ===
        const CreateIdeaModal = ({ onClose }) => {
            const [ideaName, setIdeaName] = React.useState('');
            const [ideaDescription, setIdeaDescription] = React.useState('');
            const [creating, setCreating] = React.useState(false);
            // v8.69.2: App picker state â€” when not in app-aggregate mode, user must pick an app
            const [pickedAppId, setPickedAppId] = React.useState(mode === 'app-aggregate' ? selectedAppId : '');
            const NAME_MAX = 80;
            const nameLen = ideaName.length;

            const handleCreate = async () => {
                if (!ideaName.trim()) return;
                setCreating(true);
                const appId = mode === 'app-aggregate' ? selectedAppId : (pickedAppId || null);
                const parentIdeas = appId ? (globalIdeas || []).filter(i => i.appId === appId && i.status === 'active') : [];
                const parentIdeaId = parentIdeas.length > 0 ? parentIdeas[parentIdeas.length - 1].id : null;
                try {
                    await IdeaManager.create(firebaseUid, {
                        name: ideaName.trim(),
                        description: ideaDescription.trim(),
                        type: parentIdeaId ? 'addon' : 'base',
                        appId, parentIdeaId
                    });
                    await showAlert('Idea created', 'âœ… Success');
                    console.log('[CC] Created idea:', ideaName.trim());
                    onClose();
                } catch (e) {
                    await showAlert(`Error: ${e.message}`, 'âŒ Error');
                }
                setCreating(false);
            };

            return (
                <div className="fixed inset-0 bg-black/70 flex items-center justify-center z-50 p-4" onClick={onClose}>
                    <div className="bg-slate-800 rounded-xl border border-slate-700 w-full max-w-md p-6" onClick={e => e.stopPropagation()}>
                        <h2 className="text-lg font-bold mb-4">ðŸ’¡ New Idea</h2>

                        <div className="mb-4">
                            <label className="text-xs text-slate-400 block mb-1">
                                Name <span className="text-slate-500">(short title)</span>
                            </label>
                            <input value={ideaName} onChange={e => setIdeaName(e.target.value)}
                                maxLength={NAME_MAX + 10}
                                className="w-full bg-slate-700 border border-slate-600 rounded px-3 py-2 text-sm"
                                placeholder="e.g. Smart Intake for ODRC Concepts"
                                autoFocus />
                            <div className="flex justify-between mt-1">
                                {nameLen > 60 && (
                                    <span className="text-xs text-amber-400">Consider moving details to Description</span>
                                )}
                                {nameLen <= 60 && <span />}
                                <span className={`text-xs ${
                                    nameLen > NAME_MAX ? 'text-red-400' :
                                    nameLen > 60 ? 'text-amber-400' :
                                    'text-slate-500'
                                }`}>{NAME_MAX - nameLen}</span>
                            </div>
                        </div>

                        <div className="mb-4">
                            <label className="text-xs text-slate-400 block mb-1">
                                Description <span className="text-slate-500">(optional â€” what this idea is about)</span>
                            </label>
                            <textarea value={ideaDescription} onChange={e => setIdeaDescription(e.target.value)}
                                rows={4}
                                className="w-full bg-slate-700 border border-slate-600 rounded px-3 py-2 text-sm resize-y"
                                placeholder="Detailed description of the idea, goals, context..." />
                        </div>

                        {mode === 'app-aggregate' && selectedAppId ? (
                            <div className="text-xs text-slate-400 mb-4 bg-slate-700/50 rounded px-3 py-2">
                                Will be linked to: <span className="text-slate-300 font-medium">{apps[selectedAppId]?.name || selectedAppId}</span>
                                {appIdeas.length > 0 && <span> (add-on to idea #{appIdeas.length})</span>}
                            </div>
                        ) : (
                            <div className="mb-4">
                                <label className="text-xs text-slate-400 block mb-1">
                                    App / Project <span className="text-red-400">*</span>
                                </label>
                                <select value={pickedAppId} onChange={e => setPickedAppId(e.target.value)}
                                    className="w-full bg-slate-700 border border-slate-600 rounded px-3 py-2 text-sm">
                                    <option value="">â€” Select an app â€”</option>
                                    {configuredApps.map(a => {
                                        const ideaCount = (globalIdeas || []).filter(i => i.appId === a.id).length;
                                        return (
                                            <option key={a.id} value={a.id}>
                                                {a.name}{ideaCount > 0 ? ` (${ideaCount} idea${ideaCount !== 1 ? 's' : ''})` : ''}
                                            </option>
                                        );
                                    })}
                                </select>
                                {!pickedAppId && (
                                    <div className="text-xs text-amber-400 mt-1">
                                        Every idea must be linked to an app. Select an existing app or create one in Projects first.
                                    </div>
                                )}
                            </div>
                        )}

                        <div className="flex gap-2 justify-end">
                            <button onClick={onClose} className="px-4 py-2 rounded text-sm bg-slate-700 hover:bg-slate-600">Cancel</button>
                            <button onClick={handleCreate} disabled={creating || !ideaName.trim() || nameLen > NAME_MAX || (mode !== 'app-aggregate' && !pickedAppId)}
                                className="px-4 py-2 rounded text-sm bg-indigo-600 hover:bg-indigo-500 font-medium disabled:opacity-50">
                                {creating ? 'â³ Creating...' : 'Create Idea'}
                            </button>
                        </div>
                    </div>
                </div>
            );
        };

        // === Navigation helpers ===
        const navigateToApp = (appId) => { setSelectedAppId(appId); setSelectedIdeaId(null); setConceptSearchFilter(''); setConceptStatusFilter('all'); setMode('app-aggregate'); };
        const navigateToIdea = (ideaId) => {
            setSelectedIdeaId(ideaId);
            const idea = globalIdeas.find(i => i.id === ideaId);
            if (idea?.appId && !selectedAppId) setSelectedAppId(idea.appId);
            setConceptSearchFilter(''); setConceptStatusFilter('all'); setActiveConceptTab('OPEN');
            setMode('idea-detail');
        };
        const goBack = () => {
            setConceptSearchFilter(''); setConceptStatusFilter('all');
            if (mode === 'idea-detail') { setMode('app-aggregate'); setSelectedIdeaId(null); }
            else if (mode === 'app-aggregate') { setMode('all'); setSelectedAppId(null); }
        };

        // === ConceptCard sub-component ===
        const ConceptCard = ({ concept, showOrigin = true }) => {
            const originIdea = globalIdeas.find(i => i.id === concept.ideaOrigin);
            const style = TYPE_STYLES[concept.type] || {};
            const validTransitions = ODRC_TRANSITIONS[concept.type] || [];

            return (
                <div className={`border rounded-lg p-3 mb-2 ${style.color}`}>
                    <div className="flex items-center justify-between mb-1">
                        <div className="flex items-center gap-2">
                            <span className="text-sm">{style.icon}</span>
                            <span className={`px-2 py-0.5 rounded text-xs font-medium ${style.color}`}>{concept.type}</span>
                            <span className={`px-2 py-0.5 rounded text-xs ${STATUS_STYLES[concept.status] || ''}`}>{concept.status}</span>
                        </div>
                        <div className="flex items-center gap-1">
                            {validTransitions.length > 0 && concept.status === 'active' && (
                                <select
                                    className="bg-slate-700 border border-slate-600 rounded px-1 py-0.5 text-xs"
                                    value=""
                                    onChange={(e) => {
                                        if (e.target.value) setShowTransitionModal({ concept, targetType: e.target.value });
                                    }}
                                >
                                    <option value="">â†’ Transition...</option>
                                    {validTransitions.map(t => <option key={t} value={t}>{t}</option>)}
                                </select>
                            )}
                            <button onClick={() => setShowEditModal({ concept, isNew: false })}
                                className="px-2 py-0.5 rounded text-xs hover:bg-slate-600 text-slate-300">âœï¸</button>
                            <button onClick={() => deleteConcept(concept)}
                                className="px-2 py-0.5 rounded text-xs hover:bg-red-900/50 text-red-400">ðŸ—‘ï¸</button>
                        </div>
                    </div>
                    <p className="text-sm text-slate-200 mb-1">{concept.content}</p>
                    <div className="flex items-center gap-2 flex-wrap">
                        {(concept.scopeTags || []).map(tag => (
                            <span key={tag} className="px-1.5 py-0.5 bg-slate-700 rounded text-xs text-slate-400">{tag}</span>
                        ))}
                        {showOrigin && originIdea && (
                            <button onClick={() => navigateToIdea(concept.ideaOrigin)}
                                className="text-xs text-indigo-400 hover:text-indigo-300 ml-auto">
                                from: {originIdea.name}
                            </button>
                        )}
                    </div>
                </div>
            );
        };

        // === ConceptEditModal ===
        const ConceptEditModal = ({ concept, isNew, defaultIdeaId, onClose }) => {
            const [formData, setFormData] = React.useState({
                type: concept?.type || 'OPEN',
                content: concept?.content || '',
                scopeTags: (concept?.scopeTags || []).join(', '),
                ideaOrigin: concept?.ideaOrigin || defaultIdeaId || ''
            });
            const update = (field, value) => setFormData(prev => ({ ...prev, [field]: value }));

            const handleSave = () => {
                if (!formData.content.trim()) return;
                if (!formData.ideaOrigin) { showAlert('Select an idea', 'âš ï¸ Required'); return; }
                const tags = formData.scopeTags.split(',').map(t => t.trim()).filter(Boolean);
                if (isNew) {
                    createConcept({ type: formData.type, content: formData.content.trim(), ideaOrigin: formData.ideaOrigin, scopeTags: tags });
                } else {
                    updateConcept(concept.id, { content: formData.content.trim(), scopeTags: tags });
                }
            };

            return (
                <div className="fixed inset-0 bg-black/70 flex items-center justify-center z-50 p-4" onClick={onClose}>
                    <div className="bg-slate-800 rounded-xl border border-slate-700 w-full max-w-lg p-6" onClick={e => e.stopPropagation()}>
                        <div className="flex items-center justify-between mb-4">
                            <h2 className="text-lg font-bold">{isNew ? 'âž• New Concept' : 'âœï¸ Edit Concept'}</h2>
                            <button onClick={onClose} className="text-slate-400 hover:text-white text-xl">âœ•</button>
                        </div>
                        <div className="space-y-3">
                            {isNew && (
                                <div>
                                    <label className="text-xs text-slate-400 block mb-1">Type</label>
                                    <div className="flex gap-2">
                                        {ODRC_TYPES.map(t => (
                                            <button key={t} onClick={() => update('type', t)}
                                                className={`px-3 py-1.5 rounded text-xs font-medium ${formData.type === t ? TYPE_STYLES[t].color : 'bg-slate-700 text-slate-400'}`}>
                                                {TYPE_STYLES[t].icon} {t}
                                            </button>
                                        ))}
                                    </div>
                                </div>
                            )}
                            <div>
                                <label className="text-xs text-slate-400 block mb-1">Content</label>
                                <textarea value={formData.content} onChange={e => update('content', e.target.value)}
                                    className="w-full bg-slate-700 border border-slate-600 rounded px-3 py-2 text-sm min-h-[80px]"
                                    placeholder="Describe the concept..." />
                            </div>
                            <div>
                                <label className="text-xs text-slate-400 block mb-1">Scope Tags (comma-separated)</label>
                                <input value={formData.scopeTags} onChange={e => update('scopeTags', e.target.value)}
                                    className="w-full bg-slate-700 border border-slate-600 rounded px-3 py-2 text-sm"
                                    placeholder="architecture, data-model, ux" />
                            </div>
                            {isNew && (
                                <div>
                                    <label className="text-xs text-slate-400 block mb-1">Origin Idea</label>
                                    <select value={formData.ideaOrigin} onChange={e => update('ideaOrigin', e.target.value)}
                                        className="w-full bg-slate-700 border border-slate-600 rounded px-3 py-2 text-sm">
                                        <option value="">Select idea...</option>
                                        {globalIdeas.filter(i => i.status === 'active').map(i => (
                                            <option key={i.id} value={i.id}>{i.name} ({apps[i.appId]?.name || 'unlinked'})</option>
                                        ))}
                                    </select>
                                </div>
                            )}
                        </div>
                        <div className="flex gap-2 mt-4 justify-end">
                            <button onClick={onClose} className="px-4 py-2 rounded text-sm bg-slate-700 hover:bg-slate-600">Cancel</button>
                            <button onClick={handleSave} className="px-4 py-2 rounded text-sm bg-indigo-600 hover:bg-indigo-500 font-medium">
                                {isNew ? 'Create' : 'Save'}
                            </button>
                        </div>
                    </div>
                </div>
            );
        };

        // === TransitionConfirmationModal ===
        const TransitionConfirmationModal = ({ concept, targetType, onClose }) => {
            const sharedTagConcepts = targetType && concept.type === 'CONSTRAINT'
                ? globalConcepts.filter(c => c.id !== concept.id && c.status === 'active'
                    && ['DECISION', 'RULE'].includes(c.type)
                    && (concept.scopeTags || []).some(tag => (c.scopeTags || []).includes(tag)))
                : [];

            return (
                <div className="fixed inset-0 bg-black/70 flex items-center justify-center z-50 p-4" onClick={onClose}>
                    <div className="bg-slate-800 rounded-xl border border-slate-700 w-full max-w-md p-6" onClick={e => e.stopPropagation()}>
                        <h2 className="text-lg font-bold mb-3">Transition Concept</h2>
                        <div className="flex items-center gap-3 mb-3">
                            <span className={`px-2 py-1 rounded text-sm ${TYPE_STYLES[concept.type]?.color || ''}`}>{concept.type}</span>
                            <span className="text-slate-400">â†’</span>
                            <span className={`px-2 py-1 rounded text-sm ${TYPE_STYLES[targetType]?.color || ''}`}>{targetType}</span>
                        </div>
                        <p className="text-sm text-slate-300 mb-3">"{concept.content.slice(0, 120)}{concept.content.length > 120 ? '...' : ''}"</p>
                        <p className="text-xs text-slate-400 mb-3">The original {concept.type} will be marked as "transitioned" and a new {targetType} will be created.</p>
                        {sharedTagConcepts.length > 0 && (
                            <div className="bg-amber-900/30 border border-amber-700/50 rounded p-3 mb-3">
                                <p className="text-sm text-amber-300 font-medium">âš ï¸ {sharedTagConcepts.length} related concept(s) will be flagged for review:</p>
                                <ul className="text-xs text-amber-200 mt-1 ml-4 list-disc">
                                    {sharedTagConcepts.slice(0, 5).map(c => <li key={c.id}>{c.type}: {c.content.slice(0, 60)}...</li>)}
                                    {sharedTagConcepts.length > 5 && <li>...and {sharedTagConcepts.length - 5} more</li>}
                                </ul>
                            </div>
                        )}
                        <div className="flex gap-2 justify-end">
                            <button onClick={onClose} className="px-4 py-2 rounded text-sm bg-slate-700 hover:bg-slate-600">Cancel</button>
                            <button onClick={() => transitionConcept(concept.id, targetType)}
                                className="px-4 py-2 rounded text-sm bg-indigo-600 hover:bg-indigo-500 font-medium">Confirm Transition</button>
                        </div>
                    </div>
                </div>
            );
        };

        // [v8.63.0] GenerateCLAUDEModal removed â€” replaced by pipeline CLAUDE.md generation


        // === ExploreInChatModal â€” extracted to top-level (v8.63.4 fix: prevent remount loop) ===
        // See ExploreInChatModal definition above IdeasView

        // === Auth guard ===
        if (!firebaseUid) {
            return (
                <div className="text-center py-20">
                    <div className="text-4xl mb-4">ðŸ’¡</div>
                    <h2 className="text-xl font-bold mb-2">Sign in Required</h2>
                    <p className="text-slate-400 mb-4">Sign in to manage ideas and concepts.</p>
                    <button onClick={() => setView('settings')} className="px-4 py-2 bg-indigo-600 hover:bg-indigo-500 rounded text-sm font-medium">Go to Settings</button>
                </div>
            );
        }

        const selectedApp = apps[selectedAppId];
        const selectedIdea = globalIdeas.find(i => i.id === selectedIdeaId);

        // === Render helper: grouped concept list ===
        const renderConceptGroup = (type, concepts, showOrigin = true) => {
            const items = concepts.filter(c => c.type === type);
            if (items.length === 0) return null;
            const style = TYPE_STYLES[type];
            return (
                <div key={type} className="mb-4">
                    <h3 className="text-sm font-medium text-slate-300 mb-2 flex items-center gap-2">
                        <span>{style.icon}</span> {type}s
                        <span className="px-1.5 py-0.5 bg-slate-700 rounded text-xs text-slate-400">{items.length}</span>
                    </h3>
                    {items.map(c => <ConceptCard key={c.id} concept={c} showOrigin={showOrigin} />)}
                </div>
            );
        };

        return (
            <div className="max-w-5xl mx-auto">
                {/* Breadcrumbs */}
                {mode !== 'all' && (
                    <div className="flex items-center gap-2 mb-3 text-sm">
                        <button onClick={() => { setMode('all'); setSelectedAppId(null); setSelectedIdeaId(null); }}
                            className="text-indigo-400 hover:text-indigo-300">All Concepts</button>
                        {mode === 'app-aggregate' && selectedApp && (
                            <><span className="text-slate-600">/</span><span className="text-slate-300">{selectedApp.name}</span></>
                        )}
                        {mode === 'idea-detail' && (
                            <>
                                <span className="text-slate-600">/</span>
                                <button onClick={goBack} className="text-indigo-400 hover:text-indigo-300">{selectedApp?.name || '...'}</button>
                                <span className="text-slate-600">/</span>
                                <span className="text-slate-300">{selectedIdea?.name || '...'}</span>
                            </>
                        )}
                    </div>
                )}

                {/* === MODE 1: All Concepts === */}
                {mode === 'all' && (
                    <div>
                        <div className="flex items-center justify-between mb-4">
                            <h1 className="text-xl font-bold flex items-center gap-2">ðŸ’¡ Ideas & Concepts
                                <span className="text-sm font-normal text-slate-400">{stats.active} active / {stats.total} total</span>
                            </h1>
                            <div className="flex gap-2">
                                <button onClick={createIdea} className="px-3 py-1.5 rounded text-sm bg-slate-700 hover:bg-slate-600">+ New Idea</button>
                                <button onClick={() => setShowEditModal({ concept: null, isNew: true })}
                                    className="px-3 py-1.5 rounded text-sm bg-indigo-600 hover:bg-indigo-500 font-medium">+ New Concept</button>
                            </div>
                        </div>

                        {/* Filter bar */}
                        <div className="flex gap-2 mb-4 flex-wrap">
                            <div className="relative flex-1 min-w-48">
                                <input type="text" value={conceptSearchFilter}
                                    onChange={e => setConceptSearchFilter(e.target.value)}
                                    placeholder="Search concepts..."
                                    className="w-full bg-slate-700 border border-slate-600 rounded px-3 py-1 text-sm pr-7" />
                                {conceptSearchFilter && (
                                    <button onClick={() => setConceptSearchFilter('')}
                                        className="absolute right-2 top-1/2 -translate-y-1/2 text-slate-400 hover:text-slate-200 text-sm">Ã—</button>
                                )}
                            </div>
                            <select value={typeFilter} onChange={e => setTypeFilter(e.target.value)}
                                className="bg-slate-700 border border-slate-600 rounded px-2 py-1 text-sm">
                                <option value="all">All Types</option>
                                {ODRC_TYPES.map(t => <option key={t} value={t}>{TYPE_STYLES[t].icon} {t} ({stats.byType[t] || 0})</option>)}
                            </select>
                            <select value={statusFilter} onChange={e => setStatusFilter(e.target.value)}
                                className="bg-slate-700 border border-slate-600 rounded px-2 py-1 text-sm">
                                <option value="all">All Statuses</option>
                                {CONCEPT_STATUSES.map(s => <option key={s} value={s}>{s}</option>)}
                            </select>
                            <select value={appFilter} onChange={e => setAppFilter(e.target.value)}
                                className="bg-slate-700 border border-slate-600 rounded px-2 py-1 text-sm">
                                <option value="all">All Apps</option>
                                {configuredApps.map(a => <option key={a.id} value={a.id}>{a.name}</option>)}
                            </select>
                        </div>

                        {/* Apps with concepts â€” v8.62.0 A4: sort active first, collapse empties */}
                        {configuredApps.length > 0 && (() => {
                            const appsWithContent = configuredApps.filter(app => {
                                const hasIdeas = globalIdeas.some(i => i.appId === app.id);
                                const appIdeaIds = globalIdeas.filter(i => i.appId === app.id).map(i => i.id);
                                const hasConcepts = globalConcepts.some(c => appIdeaIds.includes(c.ideaOrigin) && c.status === 'active');
                                return hasIdeas || hasConcepts;
                            });
                            const emptyApps = configuredApps.filter(app => !appsWithContent.includes(app));

                            return (
                                <div className="mb-6">
                                    <h2 className="text-sm font-medium text-slate-400 mb-2">Apps</h2>
                                    <div className="grid grid-cols-2 sm:grid-cols-3 gap-2">
                                        {appsWithContent.map(app => {
                                            const appIdeaIds = globalIdeas.filter(i => i.appId === app.id).map(i => i.id);
                                            const count = globalConcepts.filter(c => appIdeaIds.includes(c.ideaOrigin) && c.status === 'active').length;
                                            const ideaCount = globalIdeas.filter(i => i.appId === app.id).length;
                                            return (
                                                <button key={app.id} onClick={() => navigateToApp(app.id)}
                                                    className="bg-slate-800 border border-slate-700 rounded-lg p-3 text-left hover:border-indigo-600 transition-colors">
                                                    <div className="font-medium text-sm">{app.name}</div>
                                                    <div className="text-xs text-slate-400 mt-1">
                                                        {count > 0 ? `${count} active concept${count !== 1 ? 's' : ''}` : 'No concepts'}
                                                        {' Â· '}{ideaCount > 0 ? `${ideaCount} idea${ideaCount !== 1 ? 's' : ''}` : 'No ideas'}
                                                    </div>
                                                </button>
                                            );
                                        })}
                                    </div>
                                    {emptyApps.length > 0 && (
                                        <details className="mt-2">
                                            <summary className="text-xs text-slate-500 cursor-pointer hover:text-slate-400">
                                                {emptyApps.length} app{emptyApps.length !== 1 ? 's' : ''} with no active concepts
                                            </summary>
                                            <div className="grid grid-cols-2 sm:grid-cols-3 gap-2 mt-2">
                                                {emptyApps.map(app => (
                                                    <button key={app.id} onClick={() => navigateToApp(app.id)}
                                                        className="bg-slate-800/50 border border-slate-700/50 rounded-lg p-3 text-left hover:border-indigo-600 transition-colors opacity-60">
                                                        <div className="font-medium text-sm text-slate-400">{app.name}</div>
                                                        <div className="text-xs text-slate-500 mt-1">No concepts Â· No ideas</div>
                                                    </button>
                                                ))}
                                            </div>
                                        </details>
                                    )}
                                </div>
                            );
                        })()}

                        {/* v8.69.2: Unlinked Ideas â€” ideas with no appId */}
                        {(() => {
                            const unlinkedIdeas = (globalIdeas || []).filter(i => !i.appId && i.status === 'active');
                            if (unlinkedIdeas.length === 0) return null;
                            return (
                                <div className="mb-6 bg-amber-900/10 border border-amber-800/30 rounded-lg p-4">
                                    <h2 className="text-sm font-medium text-amber-400 mb-2">
                                        âš  Unlinked Ideas ({unlinkedIdeas.length})
                                    </h2>
                                    <p className="text-xs text-amber-400/60 mb-3">
                                        These ideas are not linked to any app. Link them to start working.
                                    </p>
                                    <div className="space-y-2">
                                        {unlinkedIdeas.map(idea => (
                                            <div key={idea.id}
                                                className="flex items-center justify-between bg-slate-800/70 rounded-lg px-3 py-2 border border-slate-700">
                                                <div className="flex-1 min-w-0 cursor-pointer" onClick={() => navigateToIdea(idea.id)}>
                                                    <div className="font-medium text-sm truncate">{idea.name}</div>
                                                    {idea.description && (
                                                        <div className="text-xs text-slate-400 truncate">{idea.description}</div>
                                                    )}
                                                </div>
                                                <select
                                                    defaultValue=""
                                                    onChange={async (e) => {
                                                        if (!e.target.value) return;
                                                        try {
                                                            await IdeaManager.update(firebaseUid, idea.id, { appId: e.target.value });
                                                            await showAlert(`Linked "${idea.name}" to ${apps[e.target.value]?.name || e.target.value}`, 'âœ… Linked');
                                                        } catch (err) {
                                                            await showAlert(`Error: ${err.message}`, 'âŒ Error');
                                                        }
                                                    }}
                                                    className="ml-3 bg-slate-700 border border-slate-600 rounded px-2 py-1 text-xs flex-shrink-0">
                                                    <option value="">Link to app...</option>
                                                    {configuredApps.map(a => (
                                                        <option key={a.id} value={a.id}>{a.name}</option>
                                                    ))}
                                                </select>
                                            </div>
                                        ))}
                                    </div>
                                </div>
                            );
                        })()}

                        {/* Concepts grouped by type */}
                        {filteredConcepts.length === 0 ? (
                            <div className="text-center py-12">
                                <div className="text-4xl mb-4">{globalConcepts.length === 0 ? 'ðŸ’¡' : 'ðŸ”'}</div>
                                <h2 className="text-lg font-bold mb-2">{globalConcepts.length === 0 ? 'No concepts yet' : 'No concepts match filters'}</h2>
                                <p className="text-slate-400">{globalConcepts.length === 0 ? 'Create your first concept to get started.' : 'Try adjusting your filters.'}</p>
                            </div>
                        ) : (
                            <div>
                                {ODRC_TYPES.map(type => renderConceptGroup(type, filteredConcepts))}
                            </div>
                        )}
                    </div>
                )}

                {/* === MODE 2: App Aggregate === */}
                {mode === 'app-aggregate' && selectedApp && (
                    <div>
                        <div className="flex items-center justify-between mb-4">
                            <h1 className="text-xl font-bold flex items-center gap-2">
                                {selectedApp.name}
                                <span className="text-sm font-normal text-slate-400">{appActiveConcepts.length} active concepts</span>
                            </h1>
                            <div className="flex gap-2">
                                <button onClick={createIdea} className="px-3 py-1.5 rounded text-sm bg-slate-700 hover:bg-slate-600">+ New Idea</button>
                                <button onClick={() => setShowEditModal({ concept: null, isNew: true, defaultIdeaId: appIdeas.find(i => i.status === 'active')?.id })}
                                    className="px-3 py-1.5 rounded text-sm bg-slate-700 hover:bg-slate-600">+ New Concept</button>
                                {/* [v8.63.0] Generate CLAUDE.md button removed â€” use pipeline instead */}
                            </div>
                        </div>

                        {/* v8.65.3: Idea History â€” vertical list layout */}
                        {appIdeas.length > 0 && (
                            <div className="mb-4">
                                <h2 className="text-sm font-medium text-slate-400 mb-2">Idea History</h2>
                                <div className="space-y-1">
                                    {appIdeas.map((idea, idx) => {
                                        const ideaCpts = globalConcepts.filter(c => c.ideaOrigin === idea.id);
                                        const activeCpts = ideaCpts.filter(c => c.status === 'active');
                                        const phase = idea.phase || computeIdeaPhase(ideaCpts);
                                        // v8.70.15: Inlined session type logic (IdeationBriefGenerator removed)
                                        const st = idea.status === 'active' ? (() => {
                                            const p = idea.phase || computeIdeaPhase(ideaCpts);
                                            if (p === 'inception' || p === 'complete') return 'exploration';
                                            if (p === 'spec-ready' && (idea.sessionLog || []).some(s => s.type === 'spec')) return 'claude-md';
                                            if (p === 'spec-ready') return 'spec';
                                            return 'exploration';
                                        })() : null;
                                        const borderColor = idea.status === 'active' ? 'border-l-indigo-500' :
                                            idea.status === 'graduated' ? 'border-l-green-500' : 'border-l-slate-600';
                                        return (
                                            <div key={idea.id}
                                                className={`flex items-center gap-3 px-3 py-2 rounded-r-lg border-l-2 ${borderColor} bg-slate-800/50 hover:bg-slate-700/50 cursor-pointer transition-colors`}
                                                onClick={() => navigateToIdea(idea.id)}
                                                title="Click to view idea details">
                                                <span className="text-xs text-slate-500 w-5 text-right flex-shrink-0">{idx + 1}</span>
                                                <span className={`flex-1 text-sm truncate ${
                                                    idea.status === 'active' ? 'text-slate-200' :
                                                    idea.status === 'graduated' ? 'text-green-400/70' :
                                                    'text-slate-500'
                                                }`}>{idea.name}</span>
                                                <span className={`text-[10px] px-1.5 py-0.5 rounded flex-shrink-0 ${
                                                    idea.status === 'active' ? 'bg-indigo-900/40 text-indigo-300' :
                                                    idea.status === 'graduated' ? 'bg-green-900/30 text-green-400/70' :
                                                    'bg-slate-700 text-slate-500'
                                                }`}>{idea.status}</span>
                                                <span className={`text-[10px] px-1.5 py-0.5 rounded flex-shrink-0 ${
                                                    phase === 'exploring' ? 'bg-blue-900/50 text-blue-300' :
                                                    phase === 'converging' ? 'bg-amber-900/50 text-amber-300' :
                                                    'bg-green-900/50 text-green-300'
                                                }`}>{phase}</span>
                                                <span className="text-[10px] text-slate-500 w-12 text-right flex-shrink-0">{activeCpts.length} cpts</span>
                                                {/* v8.70.15: Removed explore button (ExploreInChatModal eliminated) */}
                                                <span className="w-8 flex-shrink-0"></span>
                                            </div>
                                        );
                                    })}
                                </div>
                            </div>
                        )}

                        {/* Current truth: active concepts grouped by type */}
                        {appActiveConcepts.length === 0 ? (
                            <div className="text-center py-12">
                                <div className="text-4xl mb-4">ðŸ“‹</div>
                                <h2 className="text-lg font-bold mb-2">No active concepts</h2>
                                <p className="text-slate-400">Create an idea and add concepts to build the app's specification.</p>
                            </div>
                        ) : (
                            <div>
                                <h2 className="text-sm font-medium text-slate-400 mb-2">Current Active State</h2>
                                {/* v8.64.2: Text search for Mode 2 */}
                                <div className="relative mb-3">
                                    <input type="text" value={conceptSearchFilter}
                                        onChange={e => setConceptSearchFilter(e.target.value)}
                                        placeholder="Search concepts..."
                                        className="w-full bg-slate-700 border border-slate-600 rounded px-3 py-1.5 text-sm pr-7" />
                                    {conceptSearchFilter && (
                                        <button onClick={() => setConceptSearchFilter('')}
                                            className="absolute right-2 top-1/2 -translate-y-1/2 text-slate-400 hover:text-slate-200 text-sm">Ã—</button>
                                    )}
                                </div>
                                {ODRC_TYPES.map(type => renderConceptGroup(type, filteredAppConcepts))}
                            </div>
                        )}
                    </div>
                )}

                {/* === MODE 3: Idea Detail === */}
                {mode === 'idea-detail' && selectedIdea && (
                    <div>
                        <div className="flex items-center justify-between mb-4">
                            <div>
                                <h1 className="text-xl font-bold flex items-center gap-2">
                                    {selectedIdea.name}
                                    <span className={`px-2 py-0.5 rounded text-xs ${
                                        selectedIdea.status === 'active' ? 'bg-green-900/50 text-green-300' :
                                        selectedIdea.status === 'graduated' ? 'bg-emerald-900/50 text-emerald-300' :
                                        'bg-slate-700 text-slate-400'
                                    }`}>{selectedIdea.status}</span>
                                    <span className="px-2 py-0.5 bg-slate-700 rounded text-xs text-slate-400">{selectedIdea.type}</span>
                                    {(() => {
                                        const ideaConceptsForPhase = globalConcepts.filter(c => c.ideaOrigin === selectedIdea.id);
                                        const computed = computeIdeaPhase(ideaConceptsForPhase);
                                        const phase = selectedIdea.phase || computed;
                                        const mismatch = selectedIdea.phase && selectedIdea.phase !== computed;
                                        return (
                                            <React.Fragment>
                                                <span className={`px-2 py-0.5 rounded text-xs ${
                                                    phase === 'exploring' ? 'bg-blue-900/50 text-blue-300' :
                                                    phase === 'converging' ? 'bg-amber-900/50 text-amber-300' :
                                                    'bg-green-900/50 text-green-300'
                                                }`}>{phase}</span>
                                                {mismatch && <span className="text-amber-400 text-xs" title={`Computed: ${computed}, Override: ${selectedIdea.phase}`}>âš </span>}
                                            </React.Fragment>
                                        );
                                    })()}
                                </h1>
                                <div className="flex items-center gap-3 mt-1">
                                    {selectedIdea.description && <p className="text-sm text-slate-400">{selectedIdea.description}</p>}
                                    {selectedIdea.slug && <span className="text-xs text-slate-500 font-mono">slug: {selectedIdea.slug}</span>}
                                    {selectedIdea.lastSessionDate && (
                                        <span className={`text-xs ${
                                            Date.now() - new Date(selectedIdea.lastSessionDate).getTime() > 14 * 24 * 60 * 60 * 1000 ? 'text-amber-400' : 'text-slate-500'
                                        }`}>
                                            Last session: {new Date(selectedIdea.lastSessionDate).toLocaleDateString()}
                                            {Date.now() - new Date(selectedIdea.lastSessionDate).getTime() > 14 * 24 * 60 * 60 * 1000 &&
                                                globalConcepts.filter(c => c.ideaOrigin === selectedIdea.id && c.type === 'OPEN' && c.status === 'active').length > 0 &&
                                                ' âš  stale'}
                                        </span>
                                    )}
                                </div>
                            </div>
                            <div className="flex gap-2">
                                <button onClick={() => setShowEditModal({ concept: null, isNew: true, defaultIdeaId: selectedIdea.id })}
                                    className="px-3 py-1.5 rounded text-sm bg-indigo-600 hover:bg-indigo-500 font-medium">+ Add Concept</button>
                                {/* v8.70.15: Removed explore/spec/claude-md button (ExploreInChatModal eliminated) */}
                                {selectedIdea.status === 'active' && !selectedIdea.appId && (
                                    <button onClick={() => graduateIdea(selectedIdea.id)}
                                        className="px-3 py-1.5 rounded text-sm bg-green-700 hover:bg-green-600">ðŸŽ“ Graduate</button>
                                )}
                                {selectedIdea.status === 'active' && (
                                    <button onClick={() => archiveIdea(selectedIdea.id)}
                                        className="px-3 py-1.5 rounded text-sm bg-slate-700 hover:bg-slate-600">ðŸ“¦ Archive</button>
                                )}
                            </div>
                        </div>

                        {/* Session History (collapsible) */}
                        {selectedIdea.sessionLog?.length > 0 && (
                            <div className="mb-4 bg-slate-800/50 rounded-lg border border-slate-700 p-3">
                                <button onClick={() => setSessionHistoryExpanded(!sessionHistoryExpanded)}
                                    className="flex items-center gap-2 w-full text-left text-sm font-medium text-slate-300">
                                    <span>{sessionHistoryExpanded ? 'â–¾' : 'â–¸'}</span>
                                    ðŸ“‹ Session History ({selectedIdea.sessionLog.length} session{selectedIdea.sessionLog.length !== 1 ? 's' : ''})
                                </button>
                                {sessionHistoryExpanded && (
                                    <div className="mt-2 space-y-1">
                                        {selectedIdea.sessionLog.map((s, i) => (
                                            <div key={i} className="py-1.5 border-t border-slate-700/50">
                                                <div className="flex items-center gap-3 text-xs">
                                                    <span className="text-indigo-400 font-mono">{s.sessionId}</span>
                                                    <span className="text-slate-500">{new Date(s.date).toLocaleDateString()}</span>
                                                    <span className="text-slate-400 flex-1">{s.summary}</span>
                                                    <span className="text-green-400">+{s.conceptsCreated}</span>
                                                    <span className="text-amber-400">-{s.conceptsResolved}</span>
                                                    {s.status === 'abandoned' && (
                                                        <span className="text-red-400 font-medium">abandoned</span>
                                                    )}
                                                </div>
                                                {s.chain && (
                                                    <div className="text-xs text-slate-500 mt-1 ml-0.5">
                                                        {s.chain.linkCount} link{s.chain.linkCount !== 1 ? 's' : ''} Â· {s.chain.totalConceptBlocks || 0} concept blocks Â· {s.chain.totalElapsedMinutes || 0}min
                                                    </div>
                                                )}
                                                {s.debriefSummary && (
                                                    <details className="mt-1.5">
                                                        <summary className="text-xs text-indigo-400 cursor-pointer hover:text-indigo-300">
                                                            View debrief summary
                                                        </summary>
                                                        <p className="text-xs text-slate-400 mt-1 pl-3 border-l-2 border-slate-700 whitespace-pre-wrap">
                                                            {s.debriefSummary}
                                                        </p>
                                                    </details>
                                                )}
                                                {s.nextSession && (
                                                    <div className="text-xs text-slate-500 mt-1 italic">
                                                        Next: {s.nextSession}
                                                    </div>
                                                )}
                                                {s.ideaPhaseAtStart && s.ideaPhaseAtEnd &&
                                                 s.ideaPhaseAtStart !== s.ideaPhaseAtEnd && (
                                                    <div className="text-xs mt-1">
                                                        Phase: <span className="text-slate-400">{s.ideaPhaseAtStart}</span>
                                                        {' â†’ '}<span className="text-green-400">{s.ideaPhaseAtEnd}</span>
                                                    </div>
                                                )}
                                            </div>
                                        ))}
                                    </div>
                                )}
                            </div>
                        )}

                        {ideaConcepts.length === 0 ? (
                            <div className="text-center py-12">
                                <div className="text-4xl mb-4">ðŸ“</div>
                                <h2 className="text-lg font-bold mb-2">No concepts in this idea</h2>
                                <p className="text-slate-400">Add concepts to define the scope of this idea.</p>
                            </div>
                        ) : (
                            <div>
                                {/* v8.64.2 T2: Concept summary bar */}
                                <div className="text-sm text-slate-400 mb-3 flex flex-wrap gap-x-2">
                                    <span>ðŸ“Š {ideaConcepts.length} concept{ideaConcepts.length !== 1 ? 's' : ''}:</span>
                                    {ODRC_TYPES.map(type => {
                                        const total = ideaConcepts.filter(c => c.type === type).length;
                                        const resolved = type === 'OPEN' ? ideaConcepts.filter(c => c.type === 'OPEN' && c.status === 'resolved').length : 0;
                                        const style = TYPE_STYLES[type];
                                        if (total === 0) return <span key={type} className="text-slate-600">{total} {type.toLowerCase()}s</span>;
                                        return <span key={type}>
                                            <span style={{color: type === 'OPEN' ? '#c084fc' : type === 'DECISION' ? '#93c5fd' : type === 'RULE' ? '#fca5a5' : '#fcd34d'}}>
                                                {total} {type.toLowerCase()}{total !== 1 ? 's' : ''}{resolved > 0 ? ` (${resolved} resolved)` : ''}
                                            </span>
                                            {type !== 'CONSTRAINT' ? ' Â· ' : ''}
                                        </span>;
                                    })}
                                </div>

                                {/* v8.64.2 T5: Filter bar â€” text search + status filter */}
                                <div className="flex gap-2 mb-3 flex-wrap">
                                    <div className="relative flex-1 min-w-48">
                                        <input type="text" value={conceptSearchFilter}
                                            onChange={e => setConceptSearchFilter(e.target.value)}
                                            placeholder="Search concepts..."
                                            className="w-full bg-slate-700 border border-slate-600 rounded px-3 py-1.5 text-sm pr-7" />
                                        {conceptSearchFilter && (
                                            <button onClick={() => setConceptSearchFilter('')}
                                                className="absolute right-2 top-1/2 -translate-y-1/2 text-slate-400 hover:text-slate-200 text-sm">Ã—</button>
                                        )}
                                    </div>
                                    <select value={conceptStatusFilter} onChange={e => setConceptStatusFilter(e.target.value)}
                                        className="bg-slate-700 border border-slate-600 rounded px-2 py-1.5 text-sm">
                                        <option value="all">All Statuses</option>
                                        {CONCEPT_STATUSES.map(s => <option key={s} value={s}>{s}</option>)}
                                    </select>
                                </div>

                                {/* v8.64.2 T3: Tab bar */}
                                <div className="flex gap-1 border-b border-slate-700 mb-3">
                                    {ODRC_TYPES.map(type => {
                                        const count = filteredIdeaConcepts.filter(c => c.type === type).length;
                                        const style = TYPE_STYLES[type];
                                        return (
                                            <button key={type}
                                                onClick={() => setActiveConceptTab(type)}
                                                className={`px-4 py-2 text-sm font-medium border-b-2 transition-colors ${
                                                    activeConceptTab === type
                                                        ? 'border-indigo-400 text-white'
                                                        : count > 0
                                                            ? 'border-transparent text-slate-400 hover:text-slate-200'
                                                            : 'border-transparent text-slate-600'
                                                }`}>
                                                <span>{style.icon}</span> {type}s
                                                <span className="ml-1.5 px-1.5 py-0.5 bg-slate-700 rounded text-xs">{count}</span>
                                            </button>
                                        );
                                    })}
                                </div>

                                {/* v8.64.2 T4: Tab panel */}
                                {renderConceptGroup(activeConceptTab, filteredIdeaConcepts, false) || (
                                    <div className="text-center py-8 text-slate-500">
                                        No {activeConceptTab.toLowerCase()}s {conceptSearchFilter || conceptStatusFilter !== 'all' ? 'match filters' : 'in this idea'}
                                    </div>
                                )}
                            </div>
                        )}
                    </div>
                )}

                {/* Modals */}
                {showEditModal && (
                    <ConceptEditModal
                        concept={showEditModal.concept}
                        isNew={showEditModal.isNew}
                        defaultIdeaId={showEditModal.defaultIdeaId}
                        onClose={() => setShowEditModal(null)}
                    />
                )}
                {showTransitionModal && (
                    <TransitionConfirmationModal
                        concept={showTransitionModal.concept}
                        targetType={showTransitionModal.targetType}
                        onClose={() => setShowTransitionModal(null)}
                    />
                )}
                {/* [v8.63.0] GenerateCLAUDEModal removed */}
                {/* v8.70.15: Removed ExploreInChatModal trigger in IdeasView */}
                {showCreateIdeaModal && (
                    <CreateIdeaModal onClose={() => setShowCreateIdeaModal(false)} />
                )}
            </div>
        );
    }

    // =========================================================================
    // JOB HISTORY VIEW (v8.58.0 â€” Ingestion Pipeline Phase 1)
    // =========================================================================

        // v8.70.15: Removed JobHistoryView component
    // =========================================================================
    
    
    // StreamEditModal â€” Create/edit work streams
    

        // v8.70.15: Removed ConfigView component
    
    // App Edit Modal Component
    function AppEditModal({ app, isNew, environments, envLabels, projects, availableRepos, allApps, onSave, onCancel }) {
        const [form, setForm] = React.useState({
            id: app.id || '',
            name: app.name || '',
            icon: app.icon || 'ðŸ“¦',
            project: app.project || 'other',
            subPath: app.subPath || '',
            targetPath: app.targetPath || 'index.html',
            swPath: app.swPath || '',
            hasServiceWorker: app.hasServiceWorker || false,
            repos: app.repos || {},
            detectionPatterns: (app.detectionPatterns || []).join('\n'),
            repoPatterns: Object.fromEntries(
                environments.map(env => [env, (app.repoPatterns?.[env] || []).join(', ')])
            ),
            // v8.20.0: Lifecycle fields
            lifecycle: {
                category: app.lifecycle?.category || null,
                currentMaturity: app.lifecycle?.currentMaturity || null,
                maturityTarget: app.lifecycle?.maturityTarget || null,
                problemStatement: app.lifecycle?.problemStatement || '',
                targetAudience: app.lifecycle?.targetAudience || '',
                userGoal: app.lifecycle?.userGoal || '',
                successMetric: app.lifecycle?.successMetric || ''
            }
        });
        
        const [activeTab, setActiveTab] = React.useState('general'); // 'general' or 'lifecycle'
        const [repoMode, setRepoMode] = React.useState('dropdown'); // 'dropdown' or 'manual'
        const [patternsManuallyEdited, setPatternsManuallyEdited] = React.useState(!isNew);
        const [showEmojiPicker, setShowEmojiPicker] = React.useState(false);
        
        // Common emoji options for apps grouped by category
        const emojiOptions = [
            { label: 'Tools', emojis: ['ðŸ”§', 'ðŸ› ï¸', 'âš™ï¸', 'ðŸ”¨', 'ðŸª›', 'ðŸ—ï¸', 'ðŸ”©'] },
            { label: 'Games', emojis: ['ðŸŽ®', 'ðŸŽ²', 'ðŸƒ', 'â™Ÿï¸', 'ðŸŽ¯', 'ðŸ†', 'ðŸŽª'] },
            { label: 'Objects', emojis: ['ðŸ“¦', 'ðŸ“‹', 'ðŸ“Š', 'ðŸ“', 'ðŸ’¾', 'ðŸ—‚ï¸', 'ðŸ“'] },
            { label: 'Symbols', emojis: ['ðŸš€', 'âš¡', 'ðŸ”¥', 'ðŸ’¡', 'ðŸ§ª', 'ðŸŽ¨', 'ðŸŒŸ'] },
            { label: 'Combo', emojis: ['ðŸªœðŸ”§', 'ðŸªœðŸ› ï¸', 'ðŸ—ï¸ðŸªœ', 'âš™ï¸ðŸªœ'] }
        ];
        
        // Generate detection patterns from app name
        const generatePatterns = (name) => {
            if (!name.trim()) return '';
            const trimmed = name.trim();
            const lower = trimmed.toLowerCase();
            const noSpaces = trimmed.replace(/\s+/g, '');
            const kebab = lower.replace(/[^a-z0-9]+/g, '-').replace(/^-|-$/g, '');
            const underscored = lower.replace(/[^a-z0-9]+/g, '_').toUpperCase();
            
            const patterns = new Set();
            patterns.add(`<title>${trimmed}`);
            if (kebab !== lower) patterns.add(kebab);
            if (noSpaces !== trimmed) patterns.add(noSpaces);
            patterns.add(underscored);
            return [...patterns].join('\n');
        };
        
        // Handle name changes - auto-generate ID and detection patterns
        const handleNameChange = (newName) => {
            const updates = { name: newName };
            
            // Auto-generate ID for new apps
            if (isNew) {
                updates.id = newName.toLowerCase().replace(/[^a-z0-9]+/g, '-').replace(/^-|-$/g, '');
            }
            
            // Auto-generate detection patterns for new apps (unless manually edited)
            if (isNew && !patternsManuallyEdited) {
                updates.detectionPatterns = generatePatterns(newName);
            }
            
            setForm(prev => ({ ...prev, ...updates }));
        };
        
        // Build list of repos already assigned to other apps (for context)
        const assignedRepos = React.useMemo(() => {
            const map = {};
            if (allApps) {
                Object.values(allApps).forEach(a => {
                    if (a.id === app.id) return; // skip current app
                    environments.forEach(env => {
                        const repo = a.repos?.[env];
                        if (repo) {
                            if (!map[repo]) map[repo] = [];
                            map[repo].push(`${a.name} ${envLabels[env]}`);
                        }
                    });
                });
            }
            return map;
        }, [allApps, app.id, environments, envLabels]);
        
        // Group repos: shared repos (used by multiple apps via subPath) vs dedicated
        const repoOptions = React.useMemo(() => {
            if (!availableRepos?.length) return [];
            return availableRepos.map(r => ({
                ...r,
                assignedTo: assignedRepos[r.fullName] || [],
                isShared: (assignedRepos[r.fullName] || []).length > 0
            })).sort((a, b) => {
                // Sort: shared repos first (likely candidates for subPath apps), then alpha
                if (a.isShared && !b.isShared) return -1;
                if (!a.isShared && b.isShared) return 1;
                return a.name.localeCompare(b.name);
            });
        }, [availableRepos, assignedRepos]);
        
        const handleSave = () => {
            const effectiveId = form.id || form.name.toLowerCase().replace(/[^a-z0-9]+/g, '-').replace(/^-|-$/g, '');
            
            // Build repo patterns from selected repos
            const repoPatterns = {};
            environments.forEach(env => {
                if (repoMode === 'dropdown') {
                    // In dropdown mode, derive patterns from selected repo
                    const selectedRepo = form.repos[env];
                    if (selectedRepo) {
                        const repoName = selectedRepo.split('/').pop();
                        repoPatterns[env] = [repoName];
                    } else {
                        repoPatterns[env] = [];
                    }
                } else {
                    // Manual mode - parse comma-separated
                    repoPatterns[env] = form.repoPatterns[env]?.split(',').map(s => s.trim()).filter(Boolean) || [];
                }
            });
            
            const data = {
                ...form,
                id: effectiveId,
                detectionPatterns: form.detectionPatterns.split('\n').filter(p => p.trim()),
                repoPatterns,
                // v8.20.0: Include lifecycle data
                lifecycle: form.lifecycle
            };
            onSave(data);
        };
        
        return (
            <div className="fixed inset-0 bg-black/70 flex items-center justify-center z-50 p-4">
                <div className="bg-slate-800 rounded-xl border border-slate-600 w-full max-w-2xl max-h-[90vh] overflow-y-auto">
                    <div className="p-6 border-b border-slate-700">
                        <h3 className="text-lg font-bold">{isNew ? 'Add New App' : `Edit ${app.name}`}</h3>
                        {/* v8.20.0: Tab navigation */}
                        <div className="flex gap-1 mt-3">
                            <button 
                                onClick={() => setActiveTab('general')}
                                className={`px-3 py-1.5 rounded text-sm font-medium ${activeTab === 'general' ? 'bg-indigo-600 text-white' : 'bg-slate-700 text-slate-300 hover:bg-slate-600'}`}
                            >
                                âš™ï¸ General
                            </button>
                            <button 
                                onClick={() => setActiveTab('lifecycle')}
                                className={`px-3 py-1.5 rounded text-sm font-medium ${activeTab === 'lifecycle' ? 'bg-indigo-600 text-white' : 'bg-slate-700 text-slate-300 hover:bg-slate-600'}`}
                            >
                                ðŸ“Š Lifecycle
                            </button>
                        </div>
                    </div>
                    
                    {activeTab === 'general' && <div className="p-6 space-y-4">
                        <div className="grid grid-cols-2 gap-4">
                            <div>
                                <label className="block text-sm font-medium mb-1">App Name</label>
                                <input 
                                    type="text"
                                    value={form.name}
                                    onChange={e => handleNameChange(e.target.value)}
                                    className="w-full p-2 bg-slate-900 border border-slate-600 rounded"
                                    placeholder="My App"
                                />
                            </div>
                            <div>
                                <label className="block text-sm font-medium mb-1">Icon (emoji)</label>
                                <div className="relative">
                                    <div className="flex gap-2">
                                        <input 
                                            type="text"
                                            value={form.icon}
                                            onChange={e => setForm({ ...form, icon: e.target.value })}
                                            className="w-full p-2 bg-slate-900 border border-slate-600 rounded"
                                        />
                                        <button 
                                            type="button"
                                            onClick={() => setShowEmojiPicker(!showEmojiPicker)}
                                            className={`px-3 py-2 rounded border text-sm whitespace-nowrap ${showEmojiPicker ? 'bg-indigo-600 border-indigo-500 text-white' : 'bg-slate-700 border-slate-600 hover:bg-slate-600 text-slate-300'}`}
                                        >
                                            ðŸ˜€ Pick
                                        </button>
                                    </div>
                                    {showEmojiPicker && (
                                        <div className="absolute right-0 top-full mt-1 bg-slate-800 border border-slate-600 rounded-lg shadow-xl z-50 p-3 w-72">
                                            {emojiOptions.map(group => (
                                                <div key={group.label} className="mb-2">
                                                    <div className="text-xs text-slate-500 mb-1">{group.label}</div>
                                                    <div className="flex flex-wrap gap-1">
                                                        {group.emojis.map(emoji => (
                                                            <button
                                                                key={emoji}
                                                                type="button"
                                                                onClick={() => { setForm({ ...form, icon: emoji }); setShowEmojiPicker(false); }}
                                                                className={`w-9 h-9 rounded hover:bg-slate-700 text-lg flex items-center justify-center ${form.icon === emoji ? 'bg-indigo-600/30 ring-1 ring-indigo-500' : ''}`}
                                                            >
                                                                {emoji}
                                                            </button>
                                                        ))}
                                                    </div>
                                                </div>
                                            ))}
                                        </div>
                                    )}
                                </div>
                            </div>
                        </div>
                        <div>
                            <label className="block text-sm font-medium mb-1">Project</label>
                            <select value={form.project} onChange={e => setForm({ ...form, project: e.target.value })}
                                className="w-full p-2 bg-slate-900 border border-slate-600 rounded">
                                {Object.values(projects || SEED_PROJECTS).sort((a, b) => (a.order || 99) - (b.order || 99)).map(p => (
                                    <option key={p.id} value={p.id}>{p.icon === 'cc-logo' ? 'â¬¡' : p.icon} {p.name}</option>
                                ))}
                            </select>
                        </div>
                        
                        <div>
                            <label className="block text-sm font-medium mb-1">Sub Path</label>
                            <input 
                                type="text"
                                value={form.subPath}
                                onChange={e => setForm({ ...form, subPath: e.target.value })}
                                className="w-full p-2 bg-slate-900 border border-slate-600 rounded font-mono text-sm"
                                placeholder="e.g. rungs, rungs/builder (leave empty for repo root)"
                            />
                            <div className="text-xs text-slate-500 mt-1">Directory within the repo where app files live. Supports nested paths.</div>
                        </div>
                        
                        <div className="grid grid-cols-2 gap-4">
                            <div>
                                <label className="block text-sm font-medium mb-1">Target Path</label>
                                <input 
                                    type="text"
                                    value={form.targetPath}
                                    onChange={e => setForm({ ...form, targetPath: e.target.value })}
                                    className="w-full p-2 bg-slate-900 border border-slate-600 rounded"
                                    placeholder="index.html"
                                />
                            </div>
                            <div>
                                <label className="block text-sm font-medium mb-1">Service Worker Path</label>
                                <input 
                                    type="text"
                                    value={form.swPath}
                                    onChange={e => setForm({ ...form, swPath: e.target.value })}
                                    className="w-full p-2 bg-slate-900 border border-slate-600 rounded"
                                    placeholder="sw.js (leave empty if none)"
                                />
                            </div>
                        </div>
                        
                        <div>
                            <label className="flex items-center gap-2">
                                <input 
                                    type="checkbox"
                                    checked={form.hasServiceWorker}
                                    onChange={e => setForm({ ...form, hasServiceWorker: e.target.checked })}
                                    className="rounded"
                                />
                                <span className="text-sm">Has Service Worker (PWA)</span>
                            </label>
                        </div>
                        
                        <div>
                            <label className="block text-sm font-medium mb-1">
                                Detection Patterns (one per line, regex)
                                {isNew && !patternsManuallyEdited && form.name.trim() && (
                                    <span className="text-xs text-indigo-400 ml-2">âœ¨ auto-generated from name</span>
                                )}
                            </label>
                            <textarea 
                                value={form.detectionPatterns}
                                onChange={e => { setPatternsManuallyEdited(true); setForm({ ...form, detectionPatterns: e.target.value }); }}
                                className="w-full p-2 bg-slate-900 border border-slate-600 rounded font-mono text-sm"
                                rows={4}
                                placeholder="<title>my app&#10;myapp-container"
                            />
                        </div>
                        
                        {/* Repository Assignment */}
                        <div>
                            <div className="flex items-center justify-between mb-2">
                                <label className="block text-sm font-medium">Repository Assignment</label>
                                <button 
                                    onClick={() => setRepoMode(repoMode === 'dropdown' ? 'manual' : 'dropdown')}
                                    className="text-xs text-indigo-400 hover:text-indigo-300"
                                >
                                    {repoMode === 'dropdown' ? 'âœï¸ Manual entry' : 'ðŸ“‹ Select from repos'}
                                </button>
                            </div>
                            
                            {repoMode === 'dropdown' ? (
                                <div className="grid grid-cols-2 gap-3">
                                    {environments.map(env => (
                                        <div key={env}>
                                            <label className="block text-xs text-slate-400 mb-1">{envLabels[env]}</label>
                                            <select
                                                value={form.repos[env] || ''}
                                                onChange={e => setForm({
                                                    ...form,
                                                    repos: { ...form.repos, [env]: e.target.value },
                                                    repoPatterns: { 
                                                        ...form.repoPatterns, 
                                                        [env]: e.target.value ? e.target.value.split('/').pop() : '' 
                                                    }
                                                })}
                                                className="w-full p-2 bg-slate-900 border border-slate-600 rounded text-sm"
                                            >
                                                <option value="">â€” None â€”</option>
                                                {repoOptions.length > 0 && (() => {
                                                    const shared = repoOptions.filter(r => r.isShared);
                                                    const unassigned = repoOptions.filter(r => !r.isShared);
                                                    return (
                                                        <>
                                                            {shared.length > 0 && (
                                                                <optgroup label="Shared Repos (used by other apps)">
                                                                    {shared.map(r => (
                                                                        <option key={r.fullName} value={r.fullName}>
                                                                            {r.name} â€” {r.assignedTo.join(', ')}
                                                                        </option>
                                                                    ))}
                                                                </optgroup>
                                                            )}
                                                            {unassigned.length > 0 && (
                                                                <optgroup label="Available Repos">
                                                                    {unassigned.map(r => (
                                                                        <option key={r.fullName} value={r.fullName}>{r.name}</option>
                                                                    ))}
                                                                </optgroup>
                                                            )}
                                                        </>
                                                    );
                                                })()}
                                            </select>
                                            {form.repos[env] && form.subPath && (
                                                <div className="text-xs text-slate-500 mt-1 font-mono">
                                                    â†’ {form.subPath}/{form.targetPath || 'index.html'}
                                                </div>
                                            )}
                                        </div>
                                    ))}
                                </div>
                            ) : (
                                <div>
                                    <div className="text-xs text-slate-500 mb-2">Enter repo name patterns for auto-mapping (comma-separated)</div>
                                    <div className="grid grid-cols-2 gap-3">
                                        {environments.map(env => (
                                            <div key={env}>
                                                <label className="block text-xs text-slate-400 mb-1">{envLabels[env]}</label>
                                                <input 
                                                    type="text"
                                                    value={form.repoPatterns[env] || ''}
                                                    onChange={e => setForm({ 
                                                        ...form, 
                                                        repoPatterns: { ...form.repoPatterns, [env]: e.target.value }
                                                    })}
                                                    className="w-full p-2 bg-slate-900 border border-slate-600 rounded text-sm"
                                                    placeholder={`myapp-${env}, myapp${env}`}
                                                />
                                            </div>
                                        ))}
                                    </div>
                                </div>
                            )}
                        </div>
                    </div>}
                    
                    {/* v8.20.0: Lifecycle Tab */}
                    {activeTab === 'lifecycle' && <div className="p-6 space-y-4">
                        <div className="grid grid-cols-2 gap-4">
                            <div>
                                <label className="block text-sm font-medium mb-1">Category</label>
                                <select
                                    value={form.lifecycle.category || ''}
                                    onChange={e => setForm({ ...form, lifecycle: { ...form.lifecycle, category: e.target.value || null }})}
                                    className="w-full p-2 bg-slate-900 border border-slate-600 rounded"
                                >
                                    <option value="">Not set</option>
                                    <option value="game">ðŸŽ® Game</option>
                                    <option value="tool">ðŸ”§ Tool</option>
                                    <option value="dashboard">ðŸ“Š Dashboard</option>
                                    <option value="content">ðŸ“„ Content</option>
                                    <option value="admin">âš™ï¸ Admin</option>
                                </select>
                            </div>
                            <div>
                                <label className="block text-sm font-medium mb-1">Current Maturity</label>
                                <select
                                    value={form.lifecycle.currentMaturity || ''}
                                    onChange={e => setForm({ ...form, lifecycle: { ...form.lifecycle, currentMaturity: e.target.value || null }})}
                                    className="w-full p-2 bg-slate-900 border border-slate-600 rounded"
                                >
                                    <option value="">Not set</option>
                                    <option value="prototype">ðŸ§ª Prototype</option>
                                    <option value="alpha">ðŸ”¬ Alpha</option>
                                    <option value="beta">ðŸ”§ Beta</option>
                                    <option value="production">ðŸš€ Production</option>
                                </select>
                            </div>
                        </div>
                        
                        <div>
                            <label className="block text-sm font-medium mb-1">Maturity Target</label>
                            <select
                                value={form.lifecycle.maturityTarget || ''}
                                onChange={e => setForm({ ...form, lifecycle: { ...form.lifecycle, maturityTarget: e.target.value || null }})}
                                className="w-full p-2 bg-slate-900 border border-slate-600 rounded"
                            >
                                <option value="">Not set</option>
                                <option value="prototype">ðŸ§ª Prototype</option>
                                <option value="alpha">ðŸ”¬ Alpha</option>
                                <option value="beta">ðŸ”§ Beta</option>
                                <option value="production">ðŸš€ Production</option>
                            </select>
                        </div>
                        
                        <div>
                            <label className="block text-sm font-medium mb-1">Problem Statement</label>
                            <textarea
                                value={form.lifecycle.problemStatement}
                                onChange={e => setForm({ ...form, lifecycle: { ...form.lifecycle, problemStatement: e.target.value }})}
                                className="w-full p-2 bg-slate-900 border border-slate-600 rounded text-sm"
                                rows="2"
                                placeholder="What problem does this app solve?"
                            />
                        </div>
                        
                        <div className="grid grid-cols-2 gap-4">
                            <div>
                                <label className="block text-sm font-medium mb-1">Target Audience</label>
                                <input
                                    type="text"
                                    value={form.lifecycle.targetAudience}
                                    onChange={e => setForm({ ...form, lifecycle: { ...form.lifecycle, targetAudience: e.target.value }})}
                                    className="w-full p-2 bg-slate-900 border border-slate-600 rounded text-sm"
                                    placeholder="Who is this for?"
                                />
                            </div>
                            <div>
                                <label className="block text-sm font-medium mb-1">User Goal</label>
                                <input
                                    type="text"
                                    value={form.lifecycle.userGoal}
                                    onChange={e => setForm({ ...form, lifecycle: { ...form.lifecycle, userGoal: e.target.value }})}
                                    className="w-full p-2 bg-slate-900 border border-slate-600 rounded text-sm"
                                    placeholder="What should users accomplish?"
                                />
                            </div>
                        </div>
                        
                        <div>
                            <label className="block text-sm font-medium mb-1">Success Metric</label>
                            <input
                                type="text"
                                value={form.lifecycle.successMetric}
                                onChange={e => setForm({ ...form, lifecycle: { ...form.lifecycle, successMetric: e.target.value }})}
                                className="w-full p-2 bg-slate-900 border border-slate-600 rounded text-sm"
                                placeholder="How do we measure success?"
                            />
                        </div>
                        
                        {form.lifecycle.currentMaturity && form.lifecycle.maturityTarget && (
                            <div className="bg-slate-900/50 rounded-lg p-3 border border-slate-700">
                                <div className="text-sm font-medium mb-2">Maturity Progress</div>
                                <div className="flex items-center gap-2 text-sm">
                                    {['prototype', 'alpha', 'beta', 'production'].map((m, i) => {
                                        const milestones = ['prototype', 'alpha', 'beta', 'production'];
                                        const currentIdx = milestones.indexOf(form.lifecycle.currentMaturity);
                                        const targetIdx = milestones.indexOf(form.lifecycle.maturityTarget);
                                        const icons = { prototype: 'ðŸ§ª', alpha: 'ðŸ”¬', beta: 'ðŸ”§', production: 'ðŸš€' };
                                        const isComplete = i <= currentIdx;
                                        const isCurrent = i === currentIdx;
                                        const isTarget = i === targetIdx;
                                        const isInRange = i <= targetIdx;
                                        return React.createElement(React.Fragment, { key: m },
                                            i > 0 && React.createElement('div', { className: `flex-1 h-0.5 ${isComplete ? 'bg-emerald-500' : isInRange ? 'bg-slate-600' : 'bg-slate-800'}` }),
                                            React.createElement('div', { 
                                                className: `flex flex-col items-center ${isComplete ? 'text-emerald-400' : isInRange ? 'text-slate-400' : 'text-slate-600'}`,
                                                title: m.charAt(0).toUpperCase() + m.slice(1)
                                            },
                                                React.createElement('span', { className: 'text-base' }, icons[m]),
                                                React.createElement('span', { className: `text-xs mt-0.5 ${isCurrent ? 'font-bold underline' : ''} ${isTarget ? 'font-bold' : ''}` }, 
                                                    m.charAt(0).toUpperCase() + m.slice(1).substring(0, 4) + (isTarget ? ' â˜…' : '')
                                                )
                                            )
                                        );
                                    })}
                                </div>
                            </div>
                        )}
                    </div>}
                    
                    <div className="p-6 border-t border-slate-700 flex justify-end gap-3">
                        <button 
                            onClick={onCancel}
                            className="px-4 py-2 bg-slate-700 hover:bg-slate-600 rounded"
                        >
                            Cancel
                        </button>
                        <button 
                            onClick={handleSave}
                            className="px-4 py-2 bg-indigo-600 hover:bg-indigo-500 rounded"
                        >
                            {isNew ? 'Add App' : 'Save Changes'}
                        </button>
                    </div>
                </div>
            </div>
        );
    }

    // =========================================================================
    // PROJECTS DRILL-DOWN (v8.70.20) â€” 4-level hierarchy: Projects â†’ Apps â†’ Ideas â†’ Concepts
    // Replaces both ProjectsTab and IdeasView in the routing.
    // =========================================================================
    function ProjectsDrillDown({ config, updateConfig, apps, globalIdeas, globalConcepts,
        globalSessions, globalJobs, firebaseUid, showAlert, showConfirm, showPrompt,
        github, availableRepos, setView }) {

        // â”€â”€â”€ Navigation State â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        const [drillLevel, setDrillLevel] = React.useState('projects');
        const [selectedProjectId, setSelectedProjectId] = React.useState(null);
        const [selectedAppId, setSelectedAppId] = React.useState(null);
        const [expandedIdeaId, setExpandedIdeaId] = React.useState(null);

        // â”€â”€â”€ Level 4 Filters â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        const [conceptTypeFilter, setConceptTypeFilter] = React.useState('all');
        const [conceptStatusFilter, setConceptStatusFilter] = React.useState('all');
        const [conceptSearch, setConceptSearch] = React.useState('');

        // â”€â”€â”€ Navigation Helpers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        const drillToProject = (projectId) => {
            setSelectedProjectId(projectId);
            setSelectedAppId(null);
            setExpandedIdeaId(null);
            setDrillLevel('project-detail');
        };

        const drillToApp = (appId) => {
            setSelectedAppId(appId);
            setExpandedIdeaId(null);
            setConceptTypeFilter('all');
            setConceptStatusFilter('all');
            setConceptSearch('');
            setDrillLevel('app-detail');
        };

        const goBack = () => {
            if (drillLevel === 'app-detail') {
                setSelectedAppId(null);
                setExpandedIdeaId(null);
                setDrillLevel('project-detail');
            } else if (drillLevel === 'project-detail') {
                setSelectedProjectId(null);
                setDrillLevel('projects');
            }
        };

        // â”€â”€â”€ Computed Data â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        const projectsData = React.useMemo(() => {
            const projectDefs = config.projects || {};
            const projectMap = {};

            // Initialize from project definitions
            Object.entries(projectDefs).forEach(([id, projDef]) => {
                projectMap[id] = {
                    ...projDef,
                    id: projDef.id || id,
                    state: projDef.state || 'active',
                    apps: [],
                    ideaCount: 0,
                    openCount: 0
                };
            });

            // Assign apps to projects
            Object.values(config.apps || {}).forEach(app => {
                const projId = app.project || 'other';
                if (!projectMap[projId]) {
                    projectMap[projId] = {
                        id: projId, name: projId, icon: 'ðŸ“¦', color: 'slate',
                        order: 99, state: 'active', apps: [], ideaCount: 0, openCount: 0
                    };
                }
                projectMap[projId].apps.push(app);
            });

            // Count ideas and OPENs per project
            Object.values(projectMap).forEach(proj => {
                const appIds = proj.apps.map(a => a.id);
                const projIdeas = globalIdeas.filter(i =>
                    (i.appId && appIds.includes(i.appId)) || i.projectId === proj.id
                );
                proj.ideaCount = projIdeas.length;
                const ideaIds = projIdeas.map(i => i.id);
                proj.openCount = globalConcepts.filter(c =>
                    ideaIds.includes(c.ideaOrigin) && c.type === 'OPEN' && c.status === 'active'
                ).length;
            });

            return Object.values(projectMap)
                .sort((a, b) => (a.order || 99) - (b.order || 99));
        }, [config.apps, config.projects, globalIdeas, globalConcepts]);

        // App-level stats helper
        const getAppStats = React.useCallback((appId) => {
            const ideas = globalIdeas.filter(i => i.appId === appId);
            const ideaIds = ideas.map(i => i.id);
            const concepts = globalConcepts.filter(c => ideaIds.includes(c.ideaOrigin));
            const active = concepts.filter(c => c.status === 'active');
            return {
                ideaCount: ideas.length,
                conceptCount: active.length,
                openCount: active.filter(c => c.type === 'OPEN').length,
                unbuiltDecisions: active.filter(c => c.type === 'DECISION').length
            };
        }, [globalIdeas, globalConcepts]);

        // Ideas for selected app (Level 3)
        const appIdeas = React.useMemo(() => {
            if (!selectedAppId) return [];
            return globalIdeas
                .filter(i => i.appId === selectedAppId)
                .sort((a, b) => (a.sequence || 0) - (b.sequence || 0));
        }, [globalIdeas, selectedAppId]);

        // Genesis ideas for selected project (ideas without appId)
        const genesisIdeas = React.useMemo(() => {
            if (!selectedProjectId) return [];
            return globalIdeas.filter(i =>
                !i.appId && i.projectId === selectedProjectId && i.status !== 'archived'
            );
        }, [globalIdeas, selectedProjectId]);

        // Concepts for expanded idea (Level 4)
        const ideaConcepts = React.useMemo(() => {
            if (!expandedIdeaId) return [];
            let list = globalConcepts.filter(c => c.ideaOrigin === expandedIdeaId);
            if (conceptTypeFilter !== 'all') list = list.filter(c => c.type === conceptTypeFilter);
            if (conceptStatusFilter !== 'all') list = list.filter(c => c.status === conceptStatusFilter);
            if (conceptSearch) {
                const q = conceptSearch.toLowerCase();
                list = list.filter(c => (c.content || '').toLowerCase().includes(q));
            }
            return list.sort((a, b) => {
                // Sort by type priority: OPEN first, then DECISION, RULE, CONSTRAINT
                const order = { 'OPEN': 0, 'DECISION': 1, 'RULE': 2, 'CONSTRAINT': 3 };
                return (order[a.type] || 4) - (order[b.type] || 4);
            });
        }, [globalConcepts, expandedIdeaId, conceptTypeFilter, conceptStatusFilter, conceptSearch]);

        // â”€â”€â”€ Write Handlers (Light Edits Only) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        const handleArchiveIdea = async (ideaId) => {
            const confirmed = await showConfirm('Archive this idea? It will be hidden from the drill-down.', 'ðŸ“¦ Archive Idea');
            if (!confirmed) return;
            try {
                await IdeaManager.archive(firebaseUid, ideaId);
                showAlert('Idea archived', 'âœ… Archived');
            } catch (e) { showAlert(`Error: ${e.message}`, 'âŒ Error'); }
        };

        const handleIdeaStatusChange = async (ideaId, newStatus) => {
            try {
                await IdeaManager.update(firebaseUid, ideaId, { status: newStatus });
                showAlert(`Status changed to ${newStatus}`, 'âœ… Updated');
            } catch (e) { showAlert(`Error: ${e.message}`, 'âŒ Error'); }
        };

        // â”€â”€â”€ Breadcrumb â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        const renderBreadcrumb = () => {
            if (drillLevel === 'projects') return null;
            const proj = (config.projects || {})[selectedProjectId];
            const app = apps && apps[selectedAppId];
            return (
                <div className="flex items-center gap-2 mb-4 text-sm">
                    <button onClick={() => { setDrillLevel('projects'); setSelectedProjectId(null); setSelectedAppId(null); setExpandedIdeaId(null); }}
                        className="text-indigo-400 hover:text-indigo-300">Projects</button>
                    {drillLevel === 'project-detail' && proj && (
                        <React.Fragment>
                            <span className="text-slate-600">â€º</span>
                            <span className="text-slate-300">{proj.icon} {proj.name}</span>
                        </React.Fragment>
                    )}
                    {drillLevel === 'app-detail' && (
                        <React.Fragment>
                            <span className="text-slate-600">â€º</span>
                            <button onClick={goBack} className="text-indigo-400 hover:text-indigo-300">
                                {proj?.icon} {proj?.name}
                            </button>
                            <span className="text-slate-600">â€º</span>
                            <span className="text-slate-300">{app?.icon} {app?.name}</span>
                        </React.Fragment>
                    )}
                </div>
            );
        };

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // LEVEL 1: Project Cards
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        const renderProjectCards = () => {
            const visibleProjects = projectsData.filter(p => p.state !== 'hidden');
            return (
                <div>
                    <div className="flex items-center gap-3 mb-6">
                        <span className="text-2xl">ðŸ“‚</span>
                        <div>
                            <h1 className="text-2xl font-bold">Projects</h1>
                            <p className="text-slate-400 text-sm">
                                {visibleProjects.length} project{visibleProjects.length !== 1 ? 's' : ''} Â· {Object.keys(config.apps || {}).length} apps
                            </p>
                        </div>
                    </div>
                    {visibleProjects.length === 0 ? (
                        <div className="text-center py-12">
                            <div className="text-4xl mb-3">ðŸ“‚</div>
                            <div className="text-lg font-bold mb-2">No Projects Yet</div>
                            <p className="text-slate-400">Projects are configured via MCP or the Settings tab.</p>
                        </div>
                    ) : (
                        <div className="grid grid-cols-1 md:grid-cols-2 gap-3">
                            {visibleProjects.map(proj => {
                                const colors = getProjectColor(proj.color);
                                return (
                                    <div key={proj.id}
                                        className={`rounded-xl border p-4 cursor-pointer hover:border-indigo-500 transition-colors ${colors.border} ${colors.bg}`}
                                        onClick={() => drillToProject(proj.id)}>
                                        <div className="flex items-center gap-3 mb-2">
                                            <AppIcon icon={proj.icon} size={28} />
                                            <div className="flex-1 min-w-0">
                                                <div className={`font-semibold ${colors.text}`}>{proj.name}</div>
                                                {proj.description && (
                                                    <div className="text-xs text-slate-500 truncate">{proj.description}</div>
                                                )}
                                            </div>
                                            <span className="text-slate-600 text-lg">â€º</span>
                                        </div>
                                        <div className="flex gap-4 text-xs text-slate-400">
                                            <span>{proj.apps.length} app{proj.apps.length !== 1 ? 's' : ''}</span>
                                            <span>{proj.ideaCount} idea{proj.ideaCount !== 1 ? 's' : ''}</span>
                                            {proj.openCount > 0 && (
                                                <span className="text-purple-400">
                                                    {proj.openCount} open concept{proj.openCount !== 1 ? 's' : ''}
                                                </span>
                                            )}
                                        </div>
                                    </div>
                                );
                            })}
                        </div>
                    )}
                </div>
            );
        };

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // LEVEL 2: Project Detail (Apps + Genesis Ideas)
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        const renderProjectDetail = () => {
            const proj = (config.projects || {})[selectedProjectId];
            if (!proj) return <div className="text-slate-500">Project not found</div>;

            const projApps = Object.values(config.apps || {})
                .filter(a => (a.project || 'other') === selectedProjectId)
                .sort((a, b) => (a.name || '').localeCompare(b.name || ''));

            return (
                <div>
                    {/* Project Header */}
                    <div className="flex items-center gap-3 mb-6">
                        <AppIcon icon={proj.icon} size={32} />
                        <div>
                            <h1 className="text-xl font-bold">{proj.name}</h1>
                            {proj.description && <p className="text-slate-400 text-sm">{proj.description}</p>}
                        </div>
                    </div>

                    {/* Apps Section */}
                    <h2 className="text-sm font-semibold text-slate-400 uppercase tracking-wide mb-3">
                        Apps ({projApps.length})
                    </h2>
                    {projApps.length === 0 ? (
                        <div className="text-center py-6 text-slate-500 text-sm">No apps in this project</div>
                    ) : (
                        <div className="space-y-2 mb-6">
                            {projApps.map(app => {
                                const stats = getAppStats(app.id);
                                const version = app.versions?.prod || app.versions?.test || '';
                                return (
                                    <div key={app.id}
                                        className="flex items-center gap-3 p-3 rounded-lg border border-slate-700 hover:border-indigo-500 cursor-pointer transition-colors bg-slate-800/50"
                                        onClick={() => drillToApp(app.id)}>
                                        <AppIcon icon={app.icon} size={24} />
                                        <div className="flex-1 min-w-0">
                                            <div className="font-medium text-sm">{app.name}</div>
                                            {version && <span className="text-xs text-slate-500">v{version}</span>}
                                        </div>
                                        <div className="flex gap-3 text-xs text-slate-400">
                                            <span>{stats.ideaCount} idea{stats.ideaCount !== 1 ? 's' : ''}</span>
                                            <span>{stats.conceptCount} concept{stats.conceptCount !== 1 ? 's' : ''}</span>
                                            {stats.openCount > 0 && (
                                                <span className="text-purple-400">{stats.openCount} OPEN{stats.openCount !== 1 ? 's' : ''}</span>
                                            )}
                                        </div>
                                        <span className="text-slate-600 text-sm">â€º</span>
                                    </div>
                                );
                            })}
                        </div>
                    )}

                    {/* Genesis Ideas Section */}
                    {genesisIdeas.length > 0 && (
                        <div>
                            <h2 className="text-sm font-semibold text-slate-400 uppercase tracking-wide mb-3">
                                Genesis Ideas ({genesisIdeas.length})
                            </h2>
                            <div className="space-y-2">
                                {genesisIdeas.map(idea => {
                                    const ideaConcepts = globalConcepts.filter(c => c.ideaOrigin === idea.id);
                                    const activeOPENs = ideaConcepts.filter(c => c.type === 'OPEN' && c.status === 'active').length;
                                    return (
                                        <div key={idea.id} className="p-3 rounded-lg border border-slate-700 bg-slate-800/50">
                                            <div className="flex items-center gap-2">
                                                <span className="text-sm">ðŸ’¡</span>
                                                <span className="font-medium text-sm flex-1">{idea.name}</span>
                                                <span className={`px-2 py-0.5 rounded text-xs ${
                                                    idea.status === 'active' ? 'bg-indigo-900/40 text-indigo-300' :
                                                    idea.status === 'graduated' ? 'bg-green-900/30 text-green-400' :
                                                    'bg-slate-700 text-slate-500'
                                                }`}>{idea.status}</span>
                                                {activeOPENs > 0 && (
                                                    <span className="text-xs text-purple-400">{activeOPENs} OPEN{activeOPENs !== 1 ? 's' : ''}</span>
                                                )}
                                            </div>
                                            {idea.description && (
                                                <p className="text-xs text-slate-400 mt-1 ml-6">{idea.description}</p>
                                            )}
                                        </div>
                                    );
                                })}
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // LEVEL 3: App Detail (Ideas as Accordions)
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        const renderAppDetail = () => {
            const app = apps && apps[selectedAppId];
            if (!app) return <div className="text-slate-500">App not found</div>;

            const version = app.currentProdVersion || app.currentTestVersion || '';
            const repoName = app.prodRepo || app.testRepo || '';

            return (
                <div>
                    {/* App Header */}
                    <div className="flex items-center gap-3 mb-4 pb-4 border-b border-slate-700">
                        <AppIcon icon={app.icon} size={32} />
                        <div className="flex-1">
                            <h1 className="text-xl font-bold flex items-center gap-2">
                                {app.name}
                                {version && <span className="text-sm font-normal text-slate-400">v{version}</span>}
                            </h1>
                            {repoName && (
                                <a href={`https://github.com/${repoName}`} target="_blank" rel="noopener noreferrer"
                                    className="text-xs text-indigo-400 hover:text-indigo-300 font-mono">{repoName}</a>
                            )}
                        </div>
                    </div>

                    {/* Ideas as Accordions */}
                    <h2 className="text-sm font-semibold text-slate-400 uppercase tracking-wide mb-3">
                        Ideas ({appIdeas.length})
                    </h2>
                    {appIdeas.length === 0 ? (
                        <div className="text-center py-8">
                            <div className="text-3xl mb-2">ðŸ’¡</div>
                            <div className="text-sm text-slate-400">No ideas linked to this app yet.</div>
                            <div className="text-xs text-slate-500 mt-1">Ideas are created during ideation sessions via MCP.</div>
                        </div>
                    ) : (
                        <div className="space-y-2">
                            {appIdeas.map((idea, idx) => {
                                const isExpanded = expandedIdeaId === idea.id;
                                const ideaConcepts = globalConcepts.filter(c => c.ideaOrigin === idea.id);
                                const activeConcepts = ideaConcepts.filter(c => c.status === 'active');
                                const openCount = activeConcepts.filter(c => c.type === 'OPEN').length;
                                const unbuiltDecisions = activeConcepts.filter(c => c.type === 'DECISION').length;
                                const phase = idea.phase || computeIdeaPhase(ideaConcepts);
                                const lastActivity = idea.updatedAt || idea.createdAt;

                                const borderColor =
                                    idea.status === 'active' ? 'border-l-indigo-500' :
                                    idea.status === 'graduated' ? 'border-l-green-500' :
                                    'border-l-slate-600';

                                return (
                                    <div key={idea.id}
                                        className={`rounded-lg border border-slate-700 overflow-hidden border-l-2 ${borderColor}`}>
                                        {/* Accordion Header */}
                                        <div className="flex items-center gap-2 px-4 py-3 cursor-pointer hover:bg-slate-800/50 transition-colors"
                                            onClick={() => {
                                                if (isExpanded) {
                                                    setExpandedIdeaId(null);
                                                } else {
                                                    setExpandedIdeaId(idea.id);
                                                    setConceptTypeFilter('all');
                                                    setConceptStatusFilter('all');
                                                    setConceptSearch('');
                                                }
                                            }}>
                                            <span className={`text-xs text-slate-500 transition-transform ${isExpanded ? 'rotate-90' : ''}`}>â–¶</span>
                                            <span className="text-xs text-slate-600 w-5 flex-shrink-0 text-center">{idx + 1}</span>
                                            <span className="flex-1 text-sm font-medium truncate">{idea.name}</span>

                                            {/* Status badge */}
                                            <span className={`text-[10px] px-1.5 py-0.5 rounded ${
                                                idea.status === 'active' ? 'bg-indigo-900/40 text-indigo-300' :
                                                idea.status === 'graduated' ? 'bg-green-900/30 text-green-400' :
                                                'bg-slate-700 text-slate-500'
                                            }`}>{idea.status}</span>

                                            {/* Phase badge */}
                                            <span className={`text-[10px] px-1.5 py-0.5 rounded ${
                                                phase === 'inception' ? 'bg-slate-700 text-slate-400' :
                                                phase === 'exploring' ? 'bg-blue-900/50 text-blue-300' :
                                                phase === 'converging' ? 'bg-amber-900/50 text-amber-300' :
                                                phase === 'spec-ready' ? 'bg-green-900/50 text-green-300' :
                                                phase === 'complete' ? 'bg-emerald-900/30 text-emerald-400' :
                                                'bg-slate-700 text-slate-400'
                                            }`}>{phase}</span>

                                            {/* Counts */}
                                            {openCount > 0 && (
                                                <span className="text-[10px] px-1.5 py-0.5 rounded bg-purple-900/30 text-purple-400">
                                                    {openCount} OPEN{openCount !== 1 ? 's' : ''}
                                                </span>
                                            )}
                                            {unbuiltDecisions > 0 && (
                                                <span className="text-[10px] px-1.5 py-0.5 rounded bg-blue-900/30 text-blue-400">
                                                    {unbuiltDecisions} DECISION{unbuiltDecisions !== 1 ? 's' : ''}
                                                </span>
                                            )}
                                            <span className="text-[10px] text-slate-500 ml-1">
                                                {activeConcepts.length} pos
                                            </span>
                                            {lastActivity && (
                                                <span className="text-[10px] text-slate-600 ml-1" title={lastActivity}>
                                                    {formatTimeAgo(lastActivity)}
                                                </span>
                                            )}
                                        </div>

                                        {/* Expanded: Level 4 Inline */}
                                        {isExpanded && renderIdeaDetail(idea, ideaConcepts)}
                                    </div>
                                );
                            })}
                        </div>
                    )}
                </div>
            );
        };

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // LEVEL 4: Idea Detail (Concepts + Activity) â€” inline in accordion
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        const renderIdeaDetail = (idea, allIdeaConcepts) => {
            // Activity: sessions and jobs linked to this idea
            const ideaSessions = globalSessions
                .filter(s => s.ideaId === idea.id || s.idea === idea.id)
                .sort((a, b) => new Date(b.createdAt || 0) - new Date(a.createdAt || 0))
                .slice(0, 5);
            const ideaJobs = globalJobs
                .filter(j => j.ideaId === idea.id)
                .sort((a, b) => new Date(b.createdAt || 0) - new Date(a.createdAt || 0))
                .slice(0, 5);

            return (
                <div className="border-t border-slate-700 bg-slate-900/30 px-4 py-3">
                    {/* Idea description + actions */}
                    <div className="flex items-start gap-2 mb-3">
                        <div className="flex-1">
                            {idea.description && (
                                <p className="text-xs text-slate-400 mb-2">{idea.description}</p>
                            )}
                            <div className="flex gap-3 text-[10px] text-slate-500">
                                <span>Type: {idea.type || 'base'}</span>
                                {idea.createdAt && <span>Created: {formatTimeAgo(idea.createdAt)}</span>}
                                <span>Concepts: {allIdeaConcepts.length} total, {allIdeaConcepts.filter(c => c.status === 'active').length} active</span>
                            </div>
                        </div>
                        <div className="flex gap-1 flex-shrink-0">
                            {idea.status === 'active' && (
                                <button
                                    onClick={(e) => { e.stopPropagation(); handleArchiveIdea(idea.id); }}
                                    className="px-2 py-1 rounded text-xs bg-slate-700 hover:bg-slate-600 text-slate-300"
                                    title="Archive this idea">
                                    ðŸ“¦
                                </button>
                            )}
                            <select
                                value={idea.status}
                                onClick={(e) => e.stopPropagation()}
                                onChange={(e) => { e.stopPropagation(); handleIdeaStatusChange(idea.id, e.target.value); }}
                                className="bg-slate-700 border border-slate-600 rounded px-1.5 py-1 text-xs text-slate-300">
                                <option value="active">active</option>
                                <option value="graduated">graduated</option>
                                <option value="archived">archived</option>
                            </select>
                        </div>
                    </div>

                    {/* â”€â”€â”€ Concepts Section â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */}
                    <div className="mb-3">
                        <h3 className="text-xs font-semibold text-slate-400 uppercase tracking-wide mb-2">
                            Concepts ({ideaConcepts.length}{conceptTypeFilter !== 'all' || conceptStatusFilter !== 'all' || conceptSearch ? ` of ${allIdeaConcepts.length}` : ''})
                        </h3>

                        {/* Filter bar */}
                        <div className="flex gap-2 mb-2 flex-wrap">
                            <input type="text" value={conceptSearch}
                                onChange={e => setConceptSearch(e.target.value)}
                                placeholder="Search concepts..."
                                className="flex-1 min-w-[120px] bg-slate-700 border border-slate-600 rounded px-2 py-1 text-xs text-slate-200 placeholder-slate-500"
                                onClick={e => e.stopPropagation()} />
                            <select value={conceptTypeFilter}
                                onChange={e => setConceptTypeFilter(e.target.value)}
                                onClick={e => e.stopPropagation()}
                                className="bg-slate-700 border border-slate-600 rounded px-2 py-1 text-xs text-slate-300">
                                <option value="all">All Types</option>
                                {ODRC_TYPES.map(t => (
                                    <option key={t} value={t}>{CONCEPT_TYPE_STYLES[t]?.icon || ''} {t}</option>
                                ))}
                            </select>
                            <select value={conceptStatusFilter}
                                onChange={e => setConceptStatusFilter(e.target.value)}
                                onClick={e => e.stopPropagation()}
                                className="bg-slate-700 border border-slate-600 rounded px-2 py-1 text-xs text-slate-300">
                                <option value="all">All Statuses</option>
                                {['active', 'built', 'superseded', 'resolved', 'transitioned'].map(s => (
                                    <option key={s} value={s}>{s}</option>
                                ))}
                            </select>
                        </div>

                        {/* Concept cards (read-only) */}
                        {ideaConcepts.length === 0 ? (
                            <div className="text-xs text-slate-500 py-4 text-center">
                                {allIdeaConcepts.length === 0 ? 'No concepts in this idea yet' : 'No concepts match current filters'}
                            </div>
                        ) : (
                            <div className="space-y-1.5 max-h-[500px] overflow-y-auto">
                                {ideaConcepts.map(concept => {
                                    const typeStyle = CONCEPT_TYPE_STYLES[concept.type] || { color: 'bg-slate-700 text-slate-400', icon: '?' };
                                    const statusStyle = CONCEPT_STATUS_STYLES[concept.status] || 'bg-slate-700 text-slate-400';
                                    return (
                                        <div key={concept.id}
                                            className="border border-slate-700 rounded-lg p-2.5 bg-slate-800/30">
                                            <div className="flex items-center gap-2 mb-1">
                                                <span className="text-xs">{typeStyle.icon}</span>
                                                <span className={`px-1.5 py-0.5 rounded text-[10px] font-medium ${typeStyle.color}`}>
                                                    {concept.type}
                                                </span>
                                                <span className={`px-1.5 py-0.5 rounded text-[10px] ${statusStyle}`}>
                                                    {concept.status}
                                                </span>
                                                {concept.createdAt && (
                                                    <span className="text-[10px] text-slate-600 ml-auto" title={concept.createdAt}>
                                                        {formatTimeAgo(concept.createdAt)}
                                                    </span>
                                                )}
                                            </div>
                                            <p className="text-xs text-slate-200 leading-relaxed">{concept.content}</p>
                                            {(concept.scopeTags || []).length > 0 && (
                                                <div className="flex gap-1 mt-1.5 flex-wrap">
                                                    {concept.scopeTags.map(tag => (
                                                        <span key={tag}
                                                            className="px-1.5 py-0.5 bg-slate-700/50 rounded text-[10px] text-slate-400">
                                                            {tag}
                                                        </span>
                                                    ))}
                                                </div>
                                            )}
                                        </div>
                                    );
                                })}
                            </div>
                        )}
                    </div>

                    {/* â”€â”€â”€ Activity Section â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */}
                    {(ideaSessions.length > 0 || ideaJobs.length > 0 || (idea.sessionLog || []).length > 0) && (
                        <details className="mt-2">
                            <summary className="text-xs font-semibold text-slate-400 uppercase tracking-wide cursor-pointer hover:text-slate-300 select-none">
                                Activity
                            </summary>
                            <div className="mt-2 space-y-0.5">
                                {/* Session log entries */}
                                {(idea.sessionLog || []).slice(-5).reverse().map((s, i) => (
                                    <div key={`log-${i}`} className="flex items-center gap-2 text-[10px] text-slate-500 py-1.5 border-t border-slate-800">
                                        <span>ðŸ’¬</span>
                                        <span className="flex-1 truncate">{s.summary || s.sessionId || 'Session'}</span>
                                        {s.date && <span className="text-slate-600 flex-shrink-0">{formatTimeAgo(s.date)}</span>}
                                    </div>
                                ))}
                                {/* Recent sessions */}
                                {ideaSessions.map(session => (
                                    <div key={session.id} className="flex items-center gap-2 text-[10px] text-slate-500 py-1.5 border-t border-slate-800">
                                        <span>ðŸ’¬</span>
                                        <span className="flex-1 truncate">{session.sessionGoal || session.title || 'Session'}</span>
                                        <span className={`px-1 py-0.5 rounded flex-shrink-0 ${
                                            session.status === 'completed' ? 'bg-green-900/30 text-green-400' :
                                            session.status === 'active' ? 'bg-blue-900/30 text-blue-400' :
                                            'bg-slate-700 text-slate-400'
                                        }`}>{session.status}</span>
                                        {session.createdAt && (
                                            <span className="text-slate-600 flex-shrink-0">{formatTimeAgo(session.createdAt)}</span>
                                        )}
                                    </div>
                                ))}
                                {/* Recent jobs */}
                                {ideaJobs.map(job => (
                                    <div key={job.id} className="flex items-center gap-2 text-[10px] text-slate-500 py-1.5 border-t border-slate-800">
                                        <span>ðŸ”¨</span>
                                        <span className="flex-1 truncate">{job.title || job.type || 'Job'}</span>
                                        <span className={`px-1 py-0.5 rounded flex-shrink-0 ${
                                            job.status === 'completed' ? 'bg-green-900/30 text-green-400' :
                                            job.status === 'active' ? 'bg-blue-900/30 text-blue-400' :
                                            'bg-slate-700 text-slate-400'
                                        }`}>{job.status}</span>
                                        {job.createdAt && (
                                            <span className="text-slate-600 flex-shrink-0">{formatTimeAgo(job.createdAt)}</span>
                                        )}
                                    </div>
                                ))}
                            </div>
                        </details>
                    )}
                </div>
            );
        };

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // MAIN RENDER
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        return (
            <div>
                {renderBreadcrumb()}
                {drillLevel === 'projects' && renderProjectCards()}
                {drillLevel === 'project-detail' && renderProjectDetail()}
                {drillLevel === 'app-detail' && renderAppDetail()}
            </div>
        );
    }

    // =========================================================================
    // PROJECTS TAB (v8.8.0) â€” Replaces Apps tab in Configure [LEGACY â€” no longer rendered, kept for reference]
    // =========================================================================
    function ProjectsTab({ config, updateConfig, activeEnvs, envColors, github, githubOwner, availableRepos, showAlert, showConfirm, showPrompt, onRefreshRepos, deployments, globalWorkItems, firebaseUid, globalStreams }) {
        const [expandedProject, setExpandedProject] = React.useState(null);
        const [editingApp, setEditingApp] = React.useState(null);
        const [editingProject, setEditingProject] = React.useState(null);
        const [newProjectForm, setNewProjectForm] = React.useState(null);
        const [newAppForm, setNewAppForm] = React.useState(null);
        const [prepApp, setPrepApp] = React.useState(null);

        
        const formatDate = (ts) => {
            if (!ts) return 'â€”';
            const d = new Date(ts);
            return d.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
        };
        
        // Save project (create or update)
        const saveProject = (projectData) => {
            let newConfig = { ...config, projects: { ...(config.projects || {}) } };
            if (editingProject) {
                newConfig = ConfigManager.updateProject(newConfig, editingProject.id, projectData);
            } else {
                newConfig = ConfigManager.addProject(newConfig, projectData);
            }
            updateConfig(newConfig);
            setEditingProject(null);
            setNewProjectForm(null);
        };
        
        // Delete project
        const deleteProject = async (projectId) => {
            const appCount = ConfigManager.getProjectAppCount(config, projectId);
            const msg = appCount > 0 
                ? `Delete "${config.projects[projectId]?.name}"? Its ${appCount} app${appCount !== 1 ? 's' : ''} will be moved to Other.`
                : `Delete "${config.projects[projectId]?.name}"?`;
            const confirmed = await showConfirm(msg, 'Delete Project');
            if (!confirmed) return;
            const newConfig = ConfigManager.removeProject({ ...config, projects: { ...config.projects }, apps: { ...config.apps } }, projectId);
            updateConfig(newConfig);
            setEditingProject(null);
        };
        
        // Build project data with computed attributes
        const projectsData = React.useMemo(() => {
            const projectDefs = config.projects || SEED_PROJECTS;
            const projectMap = {};
            
            // First, create entries for all defined projects (even those with no apps yet)
            Object.values(projectDefs).forEach(projDef => {
                projectMap[projDef.id] = {
                    ...projDef,
                    state: projDef.state || 'active',
                    apps: [],
                    allRepos: new Set(),
                    createdAt: null,
                    updatedAt: null
                };
            });
            
            // Then assign apps to their projects
            Object.values(config.apps).forEach(app => {
                const projId = app.project || 'other';
                if (!projectMap[projId]) {
                    // App references a project not in config â€” show it under 'other'
                    if (!projectMap['other']) {
                        const otherDef = projectDefs['other'] || { id: 'other', name: 'Other', icon: 'ðŸ“¦', color: 'slate', order: 99 };
                        projectMap['other'] = { ...otherDef, state: 'active', apps: [], allRepos: new Set(), createdAt: null, updatedAt: null };
                    }
                    projectMap['other'].apps.push(app);
                } else {
                    projectMap[projId].apps.push(app);
                }
                const p = projectMap[projId] || projectMap['other'];
                // Collect repos
                Object.values(app.repos || {}).forEach(r => { if (r) p.allRepos.add(r); });
                // Track dates from app versions
                if (app.createdAt && (!p.createdAt || app.createdAt < p.createdAt)) p.createdAt = app.createdAt;
                if (app.updatedAt && (!p.updatedAt || app.updatedAt > p.updatedAt)) p.updatedAt = app.updatedAt;
            });
            
            return Object.values(projectMap)
                .sort((a, b) => (a.order || 99) - (b.order || 99))
                .map(p => {
                    // Determine deployment structure
                    const hasTest = p.apps.some(a => a.repos?.test);
                    const repoArr = [...p.allRepos];
                    const structure = repoArr.length <= 1 ? 'single' : hasTest ? 'dual' : 'multi';
                    return { ...p, allRepos: repoArr, structure };
                });
        }, [config.apps, config.projects]);
        
        // Get deployment structure label
        const getStructureLabel = (s) => {
            if (s === 'single') return { label: 'Single Repo', icon: 'ðŸ“¦', color: 'text-slate-400' };
            if (s === 'dual') return { label: 'Dual Repo (Test â†’ Prod)', icon: 'ðŸ”€', color: 'text-blue-400' };
            return { label: 'Multi Repo', icon: 'ðŸ—‚ï¸', color: 'text-purple-400' };
        };
        
        // Get app deployment structure
        const getAppStructure = (app) => {
            if (app.repos?.test && app.repos?.prod) return 'dual';
            return 'single';
        };
        
        // Save app edits
        const saveApp = (appData) => {
            const newConfig = { ...config, apps: { ...config.apps } };
            const id = appData.id || appData.name.toLowerCase().replace(/\s+/g, '-');
            newConfig.apps[id] = {
                ...(config.apps[id] || {}),
                ...appData,
                id,
                detectionPatterns: typeof appData.detectionPatterns === 'string' 
                    ? appData.detectionPatterns.split('\n').filter(p => p.trim()) 
                    : (appData.detectionPatterns || []),
                repoPatterns: typeof appData.repoPatterns === 'object' && !Array.isArray(appData.repoPatterns)
                    ? Object.fromEntries(Object.entries(appData.repoPatterns).map(([k, v]) => [k, typeof v === 'string' ? v.split(',').map(s => s.trim()).filter(Boolean) : v]))
                    : (appData.repoPatterns || {}),
                updatedAt: Date.now(),
                createdAt: config.apps[id]?.createdAt || Date.now()
            };
            updateConfig(newConfig);
            setEditingApp(null);
            setNewAppForm(null);
        };
        
        const deleteApp = async (appId) => {
            const confirmed = await showConfirm(`Delete ${config.apps[appId]?.name || appId}?`, 'Delete App');
            if (!confirmed) return;
            const newConfig = { ...config, apps: { ...config.apps } };
            delete newConfig.apps[appId];
            updateConfig(newConfig);
        };
        
        // Toggle project state
        const toggleProjectState = (projId) => {
            const newConfig = { ...config, projects: { ...config.projects } };
            if (newConfig.projects[projId]) {
                newConfig.projects[projId] = { ...newConfig.projects[projId], state: newConfig.projects[projId].state === 'hidden' ? 'active' : 'hidden' };
                updateConfig(newConfig);
            }
        };
        
        
        // Stats
        const totalApps = Object.keys(config.apps).length;
        const totalProjects = projectsData.length;
        
        return (
            <div className="space-y-4">
                {/* Header */}
                <div className="flex justify-between items-center">
                    <div className="text-sm text-slate-400">
                        {totalProjects} project{totalProjects !== 1 ? 's' : ''} Â· {totalApps} app{totalApps !== 1 ? 's' : ''}
                    </div>
                    <div className="flex gap-2">
                        <button onClick={() => setNewProjectForm(true)}
                            className="flex items-center gap-2 px-4 py-2 bg-slate-700 hover:bg-slate-600 rounded-lg text-sm">
                            <Icons.Plus /> New Project
                        </button>
                        <button onClick={() => setNewAppForm({ name: '', icon: 'ðŸ“¦', targetPath: 'index.html', project: 'other' })}
                            className="flex items-center gap-2 px-4 py-2 bg-indigo-600 hover:bg-indigo-500 rounded-lg text-sm">
                            <Icons.Plus /> Add App
                        </button>
                    </div>
                </div>
                
                {/* Project Cards */}
                {projectsData.map(proj => {
                    const colors = getProjectColor(proj.color);
                    const structInfo = getStructureLabel(proj.structure);
                    const isExpanded = expandedProject === proj.id;
                    const projState = proj.state || 'active';
                    const isHidden = projState === 'hidden';
                    
                    return (
                        <div key={proj.id} className={`rounded-xl border overflow-hidden transition-all ${isHidden ? 'border-slate-700/50 opacity-60' : colors.border}`}>
                            {/* Project Header */}
                            <div className={`p-4 cursor-pointer transition-colors ${isExpanded ? colors.bg : 'hover:bg-white/5'}`}
                                onClick={() => setExpandedProject(isExpanded ? null : proj.id)}>
                                <div className="flex items-center gap-3">
                                    <span className={`transform transition-transform text-sm ${isExpanded ? 'rotate-90' : ''}`}>â–¶</span>
                                    <AppIcon icon={proj.icon} size={28} />
                                    <div className="flex-1 min-w-0">
                                        <div className="flex items-center gap-2">
                                            <span className={`font-semibold ${colors.text}`}>{proj.name}</span>
                                            <span className={`text-xs px-2 py-0.5 rounded-full ${isHidden ? 'bg-slate-700 text-slate-500' : 'bg-slate-700/50 text-slate-400'}`}>
                                                {projState}
                                            </span>
                                        </div>
                                        {proj.description && <div className="text-xs text-slate-500 mt-0.5">{proj.description}</div>}
                                    </div>
                                    
                                    {/* Compact attributes */}
                                    <div className="flex items-center gap-3 text-xs text-slate-400">
                                        <div className="flex items-center gap-1" title="Deployment Structure">
                                            <span>{structInfo.icon}</span>
                                            <span className={structInfo.color}>{structInfo.label}</span>
                                        </div>
                                        <span className="text-slate-600">|</span>
                                        <span>{proj.apps.length} app{proj.apps.length !== 1 ? 's' : ''}</span>
                                        <span className="text-slate-600">|</span>
                                        <span>{proj.allRepos.length} repo{proj.allRepos.length !== 1 ? 's' : ''}</span>
                                    </div>
                                    
                                    {/* Edit project button */}
                                    <button onClick={(e) => { e.stopPropagation(); setEditingProject(proj); }}
                                        className="p-1.5 rounded hover:bg-white/10 text-slate-500 hover:text-slate-300 transition-colors"
                                        title="Edit project">
                                        âœï¸
                                    </button>
                                </div>
                            </div>
                            
                            {/* Expanded Project Detail */}
                            {isExpanded && (
                                <div className="border-t border-slate-700/50">
                                    {/* Project Attributes */}
                                    <div className="p-4 bg-slate-800/50 grid grid-cols-2 md:grid-cols-5 gap-4 text-xs">
                                        <div>
                                            <div className="text-slate-500 uppercase tracking-wide mb-1">State</div>
                                            <button onClick={(e) => { e.stopPropagation(); toggleProjectState(proj.id); }}
                                                className={`px-2 py-1 rounded text-xs font-medium ${isHidden ? 'bg-slate-700 text-slate-400 hover:bg-slate-600' : 'bg-green-900/30 text-green-400 hover:bg-green-900/50'}`}>
                                                {projState === 'hidden' ? 'ðŸ‘ï¸ Show' : 'ðŸŸ¢ Active'}
                                            </button>
                                        </div>
                                        <div>
                                            <div className="text-slate-500 uppercase tracking-wide mb-1">Structure</div>
                                            <div className={`font-medium ${structInfo.color}`}>{structInfo.icon} {structInfo.label}</div>
                                        </div>
                                        <div>
                                            <div className="text-slate-500 uppercase tracking-wide mb-1">Repositories</div>
                                            <div className="space-y-0.5">
                                                {proj.allRepos.length > 0 ? proj.allRepos.map(r => (
                                                    <div key={r} className="font-mono text-slate-300 truncate">{r.split('/')[1]}</div>
                                                )) : <span className="text-slate-500 italic">None assigned</span>}
                                            </div>
                                        </div>
                                        <div>
                                            <div className="text-slate-500 uppercase tracking-wide mb-1">Created</div>
                                            <div className="text-slate-300">{formatDate(proj.createdAt)}</div>
                                        </div>
                                        <div>
                                            <div className="text-slate-500 uppercase tracking-wide mb-1">Last Updated</div>
                                            <div className="text-slate-300">{formatDate(proj.updatedAt)}</div>
                                        </div>
                                    </div>
                                    
                                    {/* Apps Table */}
                                    <div className="p-4">
                                        <div className="flex items-center justify-between mb-3">
                                            <div className="text-sm font-semibold text-slate-300">Apps ({proj.apps.length})</div>
                                            <button onClick={() => setNewAppForm({ name: '', icon: 'ðŸ“¦', targetPath: 'index.html', project: proj.id })}
                                                className="text-xs px-3 py-1 bg-slate-700 hover:bg-slate-600 rounded flex items-center gap-1">
                                                <Icons.Plus className="w-3 h-3" /> Add App to {proj.name}
                                            </button>
                                        </div>
                                        
                                        {/* Table Header */}
                                        <div className="grid grid-cols-12 gap-2 px-3 py-2 text-xs text-slate-500 uppercase tracking-wide border-b border-slate-700">
                                            <div className="col-span-3">App</div>
                                            <div className="col-span-1">Structure</div>
                                            <div className="col-span-3">Repos</div>
                                            <div className="col-span-2">Version</div>
                                            <div className="col-span-1">Created</div>
                                            <div className="col-span-1">Updated</div>
                                            <div className="col-span-1"></div>
                                        </div>
                                        
                                        {/* App Rows */}
                                        {proj.apps.sort((a, b) => a.name.localeCompare(b.name)).map(app => {
                                            const appStruct = getAppStructure(app);
                                            const appStructInfo = getStructureLabel(appStruct);
                                            const latestVersion = app.versions?.prod || app.versions?.test || '';
                                            const testVersion = app.versions?.test || '';
                                            const prodVersion = app.versions?.prod || '';
                                            
                                            return (
                                                <div key={app.id} className="grid grid-cols-12 gap-2 px-3 py-3 text-sm border-b border-slate-800 hover:bg-slate-800/50 items-center">
                                                    {/* App Name */}
                                                    <div className="col-span-3 flex items-center gap-2 min-w-0">
                                                        <AppIcon icon={app.icon} size={20} />
                                                        <div className="min-w-0">
                                                            <div className="font-medium truncate">{app.name}</div>
                                                            <div className="text-xs text-slate-500 flex items-center gap-1">
                                                                {app.hasServiceWorker && <span className="text-purple-400" title="PWA">ðŸ“±</span>}
                                                                {app.appType === 'internal' && <span className="text-amber-400" title="Internal">ðŸ”’</span>}
                                                                <span className="font-mono">{app.targetPath}</span>
                                                                {app.subPath && <span className="text-slate-600">/{app.subPath}/</span>}
                                                            </div>
                                                        </div>
                                                    </div>
                                                    
                                                    {/* Structure */}
                                                    <div className="col-span-1">
                                                        <span className={`text-xs ${appStructInfo.color}`}>
                                                            {appStructInfo.icon} {appStruct === 'dual' ? 'Dual' : 'Single'}
                                                        </span>
                                                    </div>
                                                    
                                                    {/* Repos */}
                                                    <div className="col-span-3 text-xs font-mono min-w-0 space-y-0.5">
                                                        {app.repos?.test && (
                                                            <div className="flex items-center gap-1 truncate">
                                                                <span className="text-blue-400 w-8 shrink-0">TEST</span>
                                                                <span className="text-slate-400 truncate">{app.repos.test.split('/')[1]}</span>
                                                            </div>
                                                        )}
                                                        {app.repos?.prod && (
                                                            <div className="flex items-center gap-1 truncate">
                                                                <span className="text-green-400 w-8 shrink-0">PROD</span>
                                                                <span className="text-slate-400 truncate">{app.repos.prod.split('/')[1]}</span>
                                                            </div>
                                                        )}
                                                        {!app.repos?.test && !app.repos?.prod && <span className="text-slate-600 italic">No repos</span>}
                                                    </div>
                                                    
                                                    {/* Versions */}
                                                    <div className="col-span-2 text-xs space-y-0.5">
                                                        {testVersion && (
                                                            <div className="flex items-center gap-1">
                                                                <span className="bg-blue-900/40 text-blue-300 px-1.5 py-0.5 rounded">T: v{testVersion}</span>
                                                            </div>
                                                        )}
                                                        {prodVersion && (
                                                            <div className="flex items-center gap-1">
                                                                <span className="bg-green-900/40 text-green-300 px-1.5 py-0.5 rounded">P: v{prodVersion}</span>
                                                            </div>
                                                        )}
                                                        {!testVersion && !prodVersion && <span className="text-slate-600">â€”</span>}
                                                    </div>
                                                    
                                                    {/* Created */}
                                                    <div className="col-span-1 text-xs text-slate-500">
                                                        {formatDate(app.createdAt)}
                                                    </div>
                                                    
                                                    {/* Updated */}
                                                    <div className="col-span-1 text-xs text-slate-400">
                                                        {formatDate(app.updatedAt)}
                                                    </div>
                                                    
                                                    {/* Actions */}
                                                    <div className="col-span-1 flex gap-1 justify-end">
                                                        <button onClick={() => setPrepApp(app)}
                                                            className="p-1.5 text-slate-500 hover:text-purple-400 hover:bg-slate-700 rounded" title="Claude Prep">
                                                            ðŸ¤–
                                                        </button>
                                                        <button onClick={() => setEditingApp(app)}
                                                            className="p-1.5 text-slate-500 hover:text-white hover:bg-slate-700 rounded" title="Edit">
                                                            <Icons.Edit className="w-3.5 h-3.5" />
                                                        </button>
                                                        <button onClick={() => deleteApp(app.id)}
                                                            className="p-1.5 text-slate-500 hover:text-red-400 hover:bg-slate-700 rounded" title="Delete">
                                                            <Icons.Trash className="w-3.5 h-3.5" />
                                                        </button>
                                                    </div>
                                                </div>
                                            );
                                        })}
                                    </div>
                                </div>
                            )}
                        </div>
                    );
                })}
                
                {/* Add/Edit App Modal */}
                {(newAppForm || editingApp) && (
                    <AppEditModal 
                        app={editingApp || newAppForm}
                        isNew={!editingApp}
                        environments={activeEnvs}
                        envLabels={config.environments.labels}
                        projects={config.projects}
                        availableRepos={availableRepos}
                        allApps={config.apps}
                        onSave={saveApp}
                        onCancel={() => { setEditingApp(null); setNewAppForm(null); }}
                    />
                )}
                
                {/* Add/Edit Project Modal */}
                {(newProjectForm || editingProject) && (
                    <ProjectEditModal
                        project={editingProject || null}
                        isNew={!editingProject}
                        appCount={editingProject ? ConfigManager.getProjectAppCount(config, editingProject.id) : 0}
                        onSave={saveProject}
                        onDelete={deleteProject}
                        onCancel={() => { setEditingProject(null); setNewProjectForm(null); }}
                    />
                )}
                
                {/* Claude Prep Modal */}
                {prepApp && (
                    <ClaudePrepModal
                        app={prepApp}
                        config={config}
                        github={github}
                        githubOwner={githubOwner}
                        deployments={[]}
                        onClose={() => setPrepApp(null)}
                        showAlert={showAlert}
                        showPrompt={showPrompt}
                        globalWorkItems={globalWorkItems}
                        firebaseUid={firebaseUid}
                        globalStreams={globalStreams}
                    />
                )}
                
            </div>
        );
    }

    // (ProductBriefModal extracted to Analytics satellite)

    // =========================================================================
    // PROJECT EDIT MODAL (v8.12.0)
    // =========================================================================
    function ProjectEditModal({ project, isNew, onSave, onDelete, onCancel, appCount }) {
        const [form, setForm] = React.useState({
            id: project?.id || '',
            name: project?.name || '',
            icon: project?.icon || 'ðŸ“¦',
            color: project?.color || 'slate',
            description: project?.description || '',
            order: project?.order ?? 50
        });
        
        const [autoId, setAutoId] = React.useState(isNew);
        
        // Auto-generate ID from name for new projects
        React.useEffect(() => {
            if (autoId && isNew) {
                setForm(prev => ({ ...prev, id: prev.name.toLowerCase().replace(/[^a-z0-9]+/g, '-').replace(/^-|-$/g, '') }));
            }
        }, [form.name, autoId, isNew]);
        
        const handleSave = () => {
            if (!form.name.trim()) return;
            if (!form.id.trim()) return;
            const { _showPicker, ...saveData } = form;
            onSave({
                ...saveData,
                order: parseInt(form.order) || 50
            });
        };
        
        const colorKeys = Object.keys(PROJECT_COLORS);
        const isOther = project?.id === 'other';
        
        return (
            <div className="fixed inset-0 bg-black/70 flex items-center justify-center z-50" onClick={onCancel}>
                <div className="bg-slate-800 rounded-xl border border-slate-600 p-6 w-full max-w-lg" onClick={e => e.stopPropagation()}>
                    <h3 className="text-lg font-semibold mb-4">{isNew ? 'âœ¨ New Project' : `Edit ${project.name}`}</h3>
                    
                    <div className="space-y-4">
                        {/* Name */}
                        <div>
                            <label className="block text-sm font-medium mb-1">Project Name</label>
                            <input type="text" value={form.name}
                                onChange={e => setForm({ ...form, name: e.target.value })}
                                className="w-full p-2 bg-slate-900 border border-slate-600 rounded focus:border-indigo-500 focus:outline-none"
                                placeholder="My Project" autoFocus />
                        </div>
                        
                        {/* ID */}
                        <div>
                            <label className="block text-sm font-medium mb-1">
                                Project ID
                                {isNew && <span className="text-xs text-slate-500 ml-2">(auto-generated from name)</span>}
                            </label>
                            <input type="text" value={form.id}
                                onChange={e => { setForm({ ...form, id: e.target.value }); setAutoId(false); }}
                                disabled={!isNew}
                                className={`w-full p-2 bg-slate-900 border border-slate-600 rounded font-mono text-sm ${!isNew ? 'opacity-60' : 'focus:border-indigo-500 focus:outline-none'}`}
                                placeholder="my-project" />
                        </div>
                        
                        {/* Icon + Order */}
                        <div className="grid grid-cols-2 gap-4">
                            <div>
                                <label className="block text-sm font-medium mb-1">Icon</label>
                                <div className="flex gap-2">
                                    <input type="text" value={form.icon}
                                        onChange={e => setForm({ ...form, icon: e.target.value })}
                                        className="flex-1 p-2 bg-slate-900 border border-slate-600 rounded focus:border-indigo-500 focus:outline-none"
                                        placeholder="ðŸ“¦ or cc-logo" />
                                    <button type="button" onClick={() => setForm(prev => ({ ...prev, _showPicker: !prev._showPicker }))}
                                        className="px-3 py-2 bg-slate-700 hover:bg-slate-600 rounded text-sm">
                                        ðŸ˜€ Pick
                                    </button>
                                </div>
                                {form._showPicker && (
                                    <div className="mt-2 p-2 bg-slate-900 border border-slate-600 rounded-lg max-h-36 overflow-y-auto">
                                        <div className="flex flex-wrap gap-1">
                                            {['ðŸ“¦','ðŸ“‹','ðŸ“Š','ðŸ“','ðŸ’¾','ðŸ—‚ï¸','ðŸ“','ðŸŽ®','ðŸŽ²','ðŸƒ','â™Ÿï¸','ðŸŽ¯','ðŸ†','ðŸŽª','ðŸ”§','ðŸ› ï¸','âš™ï¸','ðŸ”¨','ðŸª›','ðŸ—ï¸','ðŸ”©','ðŸš€','âš¡','ðŸ”¥','ðŸ’¡','ðŸ§ª','ðŸŽ¨','ðŸŒŸ','ðŸªœ','ðŸ’»','ðŸ“±','ðŸ–¥ï¸','âŒ¨ï¸','ðŸ–±ï¸','ðŸ’¿','ðŸ“¡','ðŸ”Œ','ðŸ”‹','ðŸ“¸','ðŸŽµ','ðŸŽ¬','ðŸ“š','âœï¸','ðŸ–Šï¸','ðŸ“Œ','ðŸ—ƒï¸','ðŸ“ˆ','ðŸ“‰','ðŸ§®','ðŸ”¬','ðŸ”­','ðŸ’°','ðŸ¦','ðŸ›’','ðŸ ','ðŸŒ','âœˆï¸','ðŸš—','â›µ','ðŸŽ“','ðŸ¥','âš–ï¸','ðŸŽ›ï¸','ðŸ¤–','ðŸ‘¾','ðŸ•¹ï¸','ðŸ§©','ðŸª„','âœ¨'].map(emoji => (
                                                <button key={emoji} type="button"
                                                    onClick={() => setForm(prev => ({ ...prev, icon: emoji, _showPicker: false }))}
                                                    className={`w-8 h-8 flex items-center justify-center rounded hover:bg-slate-700 text-lg ${form.icon === emoji ? 'bg-indigo-600 ring-1 ring-indigo-400' : ''}`}>
                                                    {emoji}
                                                </button>
                                            ))}
                                        </div>
                                    </div>
                                )}
                                <div className="text-xs text-slate-500 mt-1">Emoji or "cc-logo" for CC hexagonal logo</div>
                            </div>
                            <div>
                                <label className="block text-sm font-medium mb-1">Sort Order</label>
                                <input type="number" value={form.order}
                                    onChange={e => setForm({ ...form, order: e.target.value })}
                                    className="w-full p-2 bg-slate-900 border border-slate-600 rounded focus:border-indigo-500 focus:outline-none"
                                    min="1" max="99" />
                            </div>
                        </div>
                        
                        {/* Color Picker */}
                        <div>
                            <label className="block text-sm font-medium mb-2">Color Theme</label>
                            <div className="flex gap-2 flex-wrap">
                                {colorKeys.map(c => {
                                    const colors = PROJECT_COLORS[c];
                                    return (
                                        <button key={c}
                                            onClick={() => setForm({ ...form, color: c })}
                                            className={`px-3 py-1.5 rounded-lg text-sm capitalize transition-all ${colors.bg} ${colors.text} border ${form.color === c ? `${colors.border} ring-2 ring-offset-1 ring-offset-slate-800 ring-${c}-500` : 'border-transparent hover:border-slate-600'}`}>
                                            {c}
                                        </button>
                                    );
                                })}
                            </div>
                        </div>
                        
                        {/* Description */}
                        <div>
                            <label className="block text-sm font-medium mb-1">Description</label>
                            <input type="text" value={form.description}
                                onChange={e => setForm({ ...form, description: e.target.value })}
                                className="w-full p-2 bg-slate-900 border border-slate-600 rounded focus:border-indigo-500 focus:outline-none"
                                placeholder="What this project is about" />
                        </div>
                    </div>
                    
                    {/* Actions */}
                    <div className="flex justify-between mt-6">
                        <div>
                            {!isNew && !isOther && onDelete && (
                                <button onClick={() => onDelete(project.id)}
                                    className="px-4 py-2 text-red-400 hover:bg-red-900/30 rounded-lg text-sm">
                                    ðŸ—‘ï¸ Delete {appCount > 0 ? `(${appCount} app${appCount !== 1 ? 's' : ''} â†’ Other)` : ''}
                                </button>
                            )}
                        </div>
                        <div className="flex gap-2">
                            <button onClick={onCancel} className="px-4 py-2 bg-slate-700 hover:bg-slate-600 rounded-lg text-sm">Cancel</button>
                            <button onClick={handleSave} disabled={!form.name.trim() || !form.id.trim()}
                                className="px-4 py-2 bg-indigo-600 hover:bg-indigo-500 disabled:opacity-50 disabled:cursor-not-allowed rounded-lg text-sm">
                                {isNew ? 'Create Project' : 'Save Changes'}
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        );
    }
    // =========================================================================
    // CLAUDE PREP MODAL (v8.13.0)
    // =========================================================================
    
    // Standard doc filenames for the Claude Prep package convention
    const CLAUDE_PREP_DOCS = ['CLAUDE.md', 'CONTEXT.md', 'PROJECT_PLAN.md', 'CHANGELOG.md', 'RELEASE_NOTES.txt', 'ARCHITECTURE.md', 'CLAUDE-PREP-STANDARD.md', 'CLAUDE_INSTRUCTIONS.md'];

    // Detect if file content is a CLAUDE.md regardless of upload filename.
    // Returns 'CLAUDE.md' if detected, otherwise returns the original filename.
    function detectClaudeMd(fileName, content) {
        if (!content || typeof content !== 'string') return fileName;
        const baseName = fileName.split('/').pop();
        // Already named correctly
        if (baseName === 'CLAUDE.md') return fileName;
        // Only consider .md files
        if (!/\.md$/i.test(baseName)) return fileName;
        // Signal 1: cc-meta tag with targetPath: CLAUDE.md (machine-generated)
        if (/<!--\s*cc-meta[\s\S]*?targetPath:\s*CLAUDE\.md[\s\S]*?-->/.test(content.slice(0, 500))) {
            console.log(`[ClaudeMD] Detected CLAUDE.md by cc-meta tag in "${fileName}"`);
            return fileName.replace(baseName, 'CLAUDE.md');
        }
        // Signal 2: Content heuristics â€” heading + ODRC section markers
        const hasHeading = /^#\s+CLAUDE\.md/m.test(content.slice(0, 200));
        const odrcSections = ['## RULEs', '## CONSTRAINTs', '## DECISIONs', '## OPENs'];
        const odrcHits = odrcSections.filter(s => content.includes(s)).length;
        if (hasHeading && odrcHits >= 2) {
            console.log(`[ClaudeMD] Detected CLAUDE.md by content heuristics in "${fileName}" (heading + ${odrcHits} ODRC sections)`);
            return fileName.replace(baseName, 'CLAUDE.md');
        }
        return fileName;
    }
    
    // =========================================================================
    // SESSION_RETURN.json â€” Validation & Session Matching (Phase B)
    // =========================================================================
    
        // v8.70.15: Removed SESSION_RETURN_SCHEMA + validateSessionReturn + matchSessionReturn
    
    // File action classification: deploy to GitHub Pages or push to source repo
    const DOC_FILE_EXTENSIONS = /\.(md|txt)$/i;
    const DEPLOY_FILE_EXTENSIONS = /\.(html|js|json|css|xml|svg|yml|yaml)$/i;
    
    function classifyFileAction(fileName) {
        const baseName = fileName.split('/').pop();
        // Known doc files always push to repo (check basename for docs/ subfolder support)
        if (CLAUDE_PREP_DOCS.includes(baseName)) return 'push-doc';
        if (baseName === 'SESSION_BRIEF.md') return 'skip'; // Auto-generated, don't push
        if (baseName === 'PRODUCT_BRIEF.md') return 'skip'; // Auto-generated, don't push (Phase 5.5)
        if (baseName === 'SESSION_RETURN.json') return 'skip'; // Session return manifest, processed by CC on drop (Phase A)
        // Files in docs/ folder â†’ push to repo
        if (fileName.startsWith('docs/')) return 'push-doc';
        // .md and .txt files â†’ push to repo
        if (DOC_FILE_EXTENSIONS.test(baseName)) return 'push-doc';
        // Everything else â†’ deploy to GitHub Pages
        return 'deploy';
    }
    
    // Required docs for a full doc set (per CLAUDE-PREP-STANDARD)
    const REQUIRED_DOCS = ['CONTEXT.md', 'PROJECT_PLAN.md', 'CHANGELOG.md', 'RELEASE_NOTES.txt'];
    
    // =========================================================================
    // CONCEPT PARSER (Streams Evolution v8.55.2)
    // Extracts key concepts from <!-- cc-concepts --> markers in documents.
    // Called after doc push to prompt user for stream association.
    // =========================================================================
    
    /**
     * Parse concepts from document content using cc-concepts markers.
     * Returns array of concept objects ready for stream storage.
     * 
     * Format:
     *   <!-- cc-concepts scope="deploy,packaging" -->
     *   - RULE: Path in zip = path in repo.
     *   - DECISION: gs-active is dev archive.
     *   <!-- /cc-concepts -->
     */
    function parseConcepts(docContent, sourceName) {
        const concepts = [];
        if (!docContent || typeof docContent !== 'string') return concepts;
        
        // Match all cc-concepts blocks (there may be multiple)
        const blockRegex = /<!--\s*cc-concepts\s*(.*?)\s*-->([\s\S]*?)<!--\s*\/cc-concepts\s*-->/g;
        let blockMatch;
        
        while ((blockMatch = blockRegex.exec(docContent)) !== null) {
            const attrString = blockMatch[1] || '';
            const blockContent = blockMatch[2] || '';
            
            // Parse scope from attributes: scope="deploy,packaging"
            const scopeMatch = attrString.match(/scope\s*=\s*"([^"]*)"/);
            const scope = scopeMatch ? scopeMatch[1].split(',').map(s => s.trim()).filter(Boolean) : [];
            
            // Parse individual concept lines: - TYPE: text
            const lineRegex = /^[\s]*-\s*(RULE|DECISION|CONSTRAINT|PROCESS|LESSON|OPEN|FIX):\s*(.+)$/gm;
            let lineMatch;
            
            while ((lineMatch = lineRegex.exec(blockContent)) !== null) {
                const type = lineMatch[1].toLowerCase();
                const text = lineMatch[2].trim();
                
                concepts.push({
                    id: `C-${Date.now()}-${concepts.length}`,
                    type,
                    text,
                    scope,
                    source: sourceName || 'unknown',
                    date: new Date().toISOString().split('T')[0],
                    status: 'active'
                });
            }
        }
        
        console.log(`[Concepts] Extracted ${concepts.length} concepts from ${sourceName || 'document'}${concepts.length > 0 ? ': ' + concepts.map(c => c.type.toUpperCase()).join(', ') : ''}`);
        return concepts;
    }
    
    /**
     * Check pushed docs for concepts and prompt user to associate with a stream.
     * Called after successful doc push.
     * 
     * @param {Array} pushedDocs - Array of {name, content} objects that were pushed
     * @param {Array} streams - Current global streams list
     * @param {Function} showConfirm - Dialog function  
     * @param {Function} showPrompt - Prompt dialog function
     * @param {Object} firebaseRefs - {uid, updateStream} for saving
     */
    async function checkPushedDocsForConcepts(pushedDocs, streams, showConfirm, showPrompt, firebaseRefs) {
        if (!pushedDocs || pushedDocs.length === 0 || !streams || streams.length === 0) return;
        
        // Collect all concepts from all pushed docs
        const allConcepts = [];
        for (const doc of pushedDocs) {
            if (!doc.content || typeof doc.content !== 'string') continue;
            const concepts = parseConcepts(doc.content, doc.name);
            if (concepts.length > 0) {
                allConcepts.push(...concepts);
            }
        }
        
        if (allConcepts.length === 0) return;
        
        console.log(`[Concepts] Found ${allConcepts.length} total concepts in ${pushedDocs.length} pushed doc(s)`);
        
        // Build stream selection list
        const activeStreams = streams.filter(s => s.status === 'active' || s.status === 'planning' || s.status === 'testing');
        if (activeStreams.length === 0) {
            console.log('[Concepts] No active streams to attach concepts to');
            return;
        }
        
        // Summarize by type
        const typeCounts = {};
        allConcepts.forEach(c => { typeCounts[c.type] = (typeCounts[c.type] || 0) + 1; });
        const typeSummary = Object.entries(typeCounts).map(([t, n]) => `${n} ${t.toUpperCase()}`).join(', ');
        
        // Build stream options string
        const streamOptions = activeStreams.map((s, i) => `${i + 1}. ${s.name} (${s.status})`).join('\n');
        
        const result = await showPrompt(
            `Found ${allConcepts.length} concepts (${typeSummary}).\n\nAdd to which stream?\n\n${streamOptions}\n\nEnter number (or leave blank to skip):`,
            '',
            `ðŸ’¡ ${allConcepts.length} Concepts Found`
        );
        
        if (!result || !result.trim()) {
            console.log('[Concepts] User skipped concept import');
            return;
        }
        
        const idx = parseInt(result.trim()) - 1;
        if (isNaN(idx) || idx < 0 || idx >= activeStreams.length) {
            console.log('[Concepts] Invalid stream selection:', result);
            return;
        }
        
        const targetStream = activeStreams[idx];
        
        // Merge with existing concepts, avoiding duplicates by text
        const existingTexts = new Set((targetStream.concepts || []).map(c => c.text.toLowerCase()));
        const newConcepts = allConcepts.filter(c => !existingTexts.has(c.text.toLowerCase()));
        const dupeCount = allConcepts.length - newConcepts.length;
        
        if (newConcepts.length === 0) {
            console.log(`[Concepts] All ${allConcepts.length} concepts already exist on stream ${targetStream.id}`);
            return;
        }
        
        const mergedConcepts = [...(targetStream.concepts || []), ...newConcepts];
        
        // Save to Firebase
        if (firebaseRefs?.uid && firebaseRefs?.updateStream) {
            await firebaseRefs.updateStream(firebaseRefs.uid, targetStream.id, { concepts: mergedConcepts });
            console.log(`[Concepts] Added ${newConcepts.length} concepts to stream ${targetStream.id}: "${targetStream.name}"${dupeCount > 0 ? ` (${dupeCount} duplicates skipped)` : ''}`);
        }
    }
    
    /**
     * Check if a doc's content matches what's already in the repo.
     * Returns true if unchanged (skip the push), false if new or different.
     * 
     * @param {Object} existing - GitHub file object from getFile() (has .content base64 + .sha)
     * @param {string} newContent - The local doc content to compare
     * @returns {boolean} true if content is identical
     */
    function isDocUnchanged(existing, newContent) {
        if (!existing || !existing.content) return false; // File doesn't exist or no content â†’ push it
        try {
            // GitHub returns base64-encoded content (may have newlines in the base64 string)
            const decoded = decodeURIComponent(escape(atob(existing.content.replace(/\n/g, ''))));
            // Normalize line endings for comparison
            const normalizedExisting = decoded.replace(/\r\n/g, '\n').trim();
            const normalizedNew = newContent.replace(/\r\n/g, '\n').trim();
            return normalizedExisting === normalizedNew;
        } catch (e) {
            console.warn('[DocPush] Content comparison failed, will push:', e.message);
            return false;
        }
    }

    // =========================================================================
    // UNIFIED PACKAGE VALIDATION (v8.36.0)
    // Selection-driven: runs on selected files to determine intent and issues.
    // Replaces: validateDocPackage, post-extraction showAlerts, deploy-time confirms
    // =========================================================================

        // v8.70.15: Removed getValidationIntent, validatePackage, generateClaudeFixPrompt (deploy pipeline eliminated)
    
    // v8.70.15: detectConfigDrift removed (deploy pipeline eliminated)
    
    function getDocsPath(app) {
        // Standalone repos (no subPath): docs at root
        // Consolidated repos (has subPath): docs at {subPath}/docs/
        const subPath = app.subPath || '';
        if (!subPath) return '';
        return `${subPath}/docs`;
    }
    
    // [v8.63.0] generateSessionBrief() removed â€” replaced by IdeationBriefGenerator

    // Generate skeleton CONTEXT.md for bootstrapping
    function generateSkeletonContext(app, config) {
        const projectDef = config.projects?.[app.project] || {};
        const repos = Object.entries(app.repos || {}).filter(([,v]) => v);
        const repoStr = repos.map(([k,v]) => `- **${k.toUpperCase()}:** ${v}`).join('\n');
        
        return `# ${app.name} â€” CONTEXT.md

> **Read this first** at the start of every session.

## Current Version

**v${app.versions?.prod || app.versions?.test || '0.0.0'}**

## What ${app.name} Is

*TODO: Describe what this app does and who it's for.*

## Architecture

- **Single-file HTML app**: All CSS/JS inline in ${app.targetPath || 'index.html'}
- **Framework**: *TODO: React via CDN / vanilla JS / etc.*
- **Data**: *TODO: Firebase RTDB / localStorage / none*
- **PWA**: ${app.hasServiceWorker ? 'Yes â€” sw.js + manifest.json' : 'No'}
- **Deploy target**: *TODO: URL*

## Key Technical Details

### Meta Tags (Required)
\`\`\`html
<meta name="version" content="X.X.X">
<meta name="gs-app-id" content="${app.id}">
\`\`\`

### Data Schema
*TODO: Key data structures, Firebase paths, localStorage keys*

### Key Components / Functions
*TODO: Map of major components or functions*

## Deployment

${repoStr || '- *No repos configured*'}
- **SubPath:** ${app.subPath || '(root)'}
- **Structure:** ${repos.length > 1 ? 'Dual (Test â†’ Prod)' : 'Single repo'}
- **PWA Package:** ${app.hasServiceWorker ? 'Yes â€” include sw.js, manifest.json, icons/' : 'No â€” single HTML file'}
- **Detection patterns:** ${(app.detectionPatterns || []).join(', ')}

## Conventions

*TODO: App-specific rules, CSS patterns, state management*

## Recent Changes

*TODO: Updated each session*
`;
    }
    
    // Generate skeleton PROJECT_PLAN.md
    function generateSkeletonPlan(app) {
        return `# ${app.name} â€” Project Plan

## Mission

*TODO: What this app exists to do.*

## Completed Features

*TODO: List completed features.*

## In Progress

*TODO: What's actively being worked on.*

## Planned Features

### Near Term
*TODO: Next priorities.*

### Medium Term
*TODO: Roadmap items.*

## Architecture Decisions

*TODO: Why key technical choices were made.*

## Open Questions

*TODO: Unresolved decisions.*
`;
    }
    
    // Generate skeleton CHANGELOG.md
    function generateSkeletonChangelog(app) {
        const ver = app.versions?.prod || app.versions?.test || '0.0.0';
        return `# ${app.name} â€” Changelog

## [${ver}] - ${new Date().toISOString().split('T')[0]}

### Added
- Initial changelog created by Claude Prep

*Use format: Added / Changed / Fixed / Removed per version.*
`;
    }
    // [v8.63.0] SessionLaunchModal removed â€” replaced by ExploreInChatModal

    
    function ClaudePrepModal({ app, config, github, githubOwner, deployments, onClose, showAlert, showPrompt, globalWorkItems, firebaseUid, globalStreams }) {
        // === Wizard State (v8.37.0: 3-step Session Wizard) ===
        const [wizardStep, setWizardStep] = React.useState(1); // 1: Work Items, 2: Session Type + Context, 3: Generate
        const [phase, setPhase] = React.useState('wizard'); // wizard | building | done | error
        const [sessionType, setSessionType] = React.useState(null);
        const [selectedWorkItems, setSelectedWorkItems] = React.useState([]);
        const [status, setStatus] = React.useState('idle');
        const [log, setLog] = React.useState([]);
        const [progress, setProgress] = React.useState({ current: 0, total: 0 });
        const [result, setResult] = React.useState(null);
        const [uploadMode, setUploadMode] = React.useState(false);
        const [uploadFiles, setUploadFiles] = React.useState([]);
        const [uploading, setUploading] = React.useState(false);
        const [uploadLog, setUploadLog] = React.useState([]);
        const [sessionRecord, setSessionRecord] = React.useState(null);
        
        // Get work items for this app
        const [streamFilter, setStreamFilter] = React.useState('all'); // Phase 5.2: stream filter for work items
        
        const appStreams = React.useMemo(() => {
            return (globalStreams || []).filter(s => s.appId === app.id);
        }, [globalStreams, app.id]);
        
        const appWorkItems = React.useMemo(() => {
            if (!globalWorkItems) return [];
            let items = globalWorkItems.filter(wi => wi.appId === app.id && (wi.status === 'ready' || wi.status === 'in-progress'));
            if (streamFilter !== 'all') {
                items = items.filter(wi => streamFilter === 'unassigned' ? !wi.streamId : wi.streamId === streamFilter);
            }
            return items;
        }, [globalWorkItems, app.id, streamFilter]);
        
        // Auto-suggest session type when a work item is selected
        const handleWorkItemToggle = (wi) => {
            setSelectedWorkItems(prev => {
                const exists = prev.find(w => w.id === wi.id);
                const next = exists ? prev.filter(w => w.id !== wi.id) : [...prev, wi];
                if (next.length > 0 && !sessionType) {
                    setSessionType(SessionBriefGenerator.suggestFromWorkItem(next[0]));
                }
                return next;
            });
        };
        
        const typeInfo = sessionType ? SESSION_TYPES[sessionType] : null;
        const suggestedEngine = typeInfo ? EngineRegistryService.get(typeInfo.suggestedEngine) : null;
        const defaultEngine = EngineRegistryService.getDefault();
        const activeEngine = suggestedEngine || defaultEngine;
        
        const addLog = (msg, type = 'info') => {
            setLog(prev => [...prev, { msg, type, time: new Date().toLocaleTimeString() }]);
        };
        
        // Wizard navigation
        const canProceed = (step) => {
            if (step === 1) return true; // Can always proceed from step 1 (general session is fine)
            if (step === 2) return true; // Session type is optional
            return false;
        };
        
        const goNext = () => setWizardStep(prev => Math.min(prev + 1, 3));
        const goBack = () => setWizardStep(prev => Math.max(prev - 1, 1));
        
        // Quick Skip: jump to building immediately
        const quickBuild = () => {
            setSessionType(null);
            setSelectedWorkItems([]);
            startPrep();
        };
        
        const startPrep = async () => {
            if (!github) {
                await showAlert('GitHub token not configured. Go to Settings to add one.');
                return;
            }
            
            setPhase('building');
            setStatus('fetching');
            setLog([]);
            
            try {
                const zip = new JSZip();
                const appFolder = zip.folder(app.id);
                const files = [];
                const missingDocs = [];
                
                const repo = app.repos?.prod || app.repos?.test;
                if (!repo) {
                    addLog('\u274c No repo configured for this app', 'error');
                    setStatus('error');
                    setPhase('error');
                    return;
                }
                
                addLog(`\ud83d\udcc2 Using repo: ${repo}`);
                const subPath = app.subPath || '';
                const docsPath = getDocsPath(app);
                const strategy = typeInfo?.contextStrategy || null;
                
                // === Fetch source files (session-type-aware) ===
                const includeSource = strategy ? strategy.includeSource : true;
                
                if (includeSource) {
                    addLog('\ud83d\udce5 Fetching source files...');
                    const targetPath = subPath 
                        ? `${subPath}/${app.targetPath || 'index.html'}`
                        : (app.targetPath || 'index.html');
                    
                    setProgress({ current: 1, total: 8 });
                    const mainFile = await github.getFileContent(repo, targetPath);
                    if (mainFile?.textContent) {
                        appFolder.file(app.targetPath || 'index.html', mainFile.textContent);
                        const mainName = app.targetPath || 'index.html';
                        files.push({ name: mainName, size: mainFile.textContent.length, tokens: TokenRegistryService.estimateTokens(mainFile.textContent, mainName) });
                        addLog(`\u2705 ${mainName} (${(mainFile.textContent.length / 1024).toFixed(0)}KB)`);
                    } else {
                        addLog(`\u26a0\ufe0f Could not fetch ${targetPath}`, 'warn');
                    }
                    
                    if (app.hasServiceWorker) {
                        setProgress({ current: 2, total: 8 });
                        const swPath = subPath ? `${subPath}/sw.js` : 'sw.js';
                        const swFile = await github.getFileContent(repo, swPath);
                        if (swFile?.textContent) {
                            appFolder.file('sw.js', swFile.textContent);
                            files.push({ name: 'sw.js', size: swFile.textContent.length, tokens: TokenRegistryService.estimateTokens(swFile.textContent, 'sw.js') });
                            addLog(`\u2705 sw.js (${(swFile.textContent.length / 1024).toFixed(0)}KB)`);
                        } else {
                            addLog('\u26a0\ufe0f sw.js not found (PWA app)', 'warn');
                        }
                        
                        setProgress({ current: 3, total: 8 });
                        const manifestPath = subPath ? `${subPath}/manifest.json` : 'manifest.json';
                        const manifestFile = await github.getFileContent(repo, manifestPath);
                        if (manifestFile?.textContent) {
                            appFolder.file('manifest.json', manifestFile.textContent);
                            files.push({ name: 'manifest.json', size: manifestFile.textContent.length, tokens: TokenRegistryService.estimateTokens(manifestFile.textContent, 'manifest.json') });
                            addLog(`\u2705 manifest.json`);
                        }
                    }
                } else {
                    addLog('\u23ed\ufe0f Skipping source files (not needed for this session type)');
                }
                
                // === Fetch doc files (session-type-aware filtering) ===
                addLog('\ud83d\udcc4 Looking for project docs...');
                setProgress({ current: 4, total: 8 });
                
                const skipSet = new Set(strategy?.skipWhenTight || []);
                const alwaysSet = new Set(strategy?.alwaysInclude || []);
                const preferSet = new Set(strategy?.preferInclude || []);
                
                let docsFound = 0;
                for (const docName of CLAUDE_PREP_DOCS) {
                    if (strategy && !alwaysSet.has(docName) && !preferSet.has(docName) && skipSet.has(docName)) {
                        addLog(`\u23ed\ufe0f Skipping ${docName} (session type: ${typeInfo?.label || 'N/A'})`, 'info');
                        continue;
                    }
                    
                    const paths = docsPath 
                        ? [`${docsPath}/${docName}`, `${subPath}/${docName}`, docName]
                        : [docName];
                    
                    let found = false;
                    for (const tryPath of paths) {
                        const docFile = await github.getFileContent(repo, tryPath);
                        if (docFile?.textContent) {
                            appFolder.file(docName, docFile.textContent);
                            files.push({ name: docName, size: docFile.textContent.length, tokens: TokenRegistryService.estimateTokens(docFile.textContent, docName) });
                            addLog(`\u2705 ${docName} (from ${tryPath})`);
                            docsFound++;
                            found = true;
                            break;
                        }
                    }
                    if (!found && docName !== 'ARCHITECTURE.md' && docName !== 'CLAUDE_INSTRUCTIONS.md' && docName !== 'CLAUDE-PREP-STANDARD.md') {
                        missingDocs.push(docName);
                    }
                }
                
                // === Bootstrap missing docs ===
                if (missingDocs.length > 0) {
                    addLog(`\ud83d\udcdd Generating ${missingDocs.length} missing doc${missingDocs.length > 1 ? 's' : ''}...`, 'warn');
                    setProgress({ current: 6, total: 8 });
                    
                    for (const docName of missingDocs) {
                        let content = '';
                        if (docName === 'CONTEXT.md') content = generateSkeletonContext(app, config);
                        else if (docName === 'PROJECT_PLAN.md') content = generateSkeletonPlan(app);
                        else if (docName === 'CHANGELOG.md') content = generateSkeletonChangelog(app);
                        else if (docName === 'RELEASE_NOTES.txt') content = `${app.name} - Release Notes\n${'='.repeat(app.name.length + 18)}\n\nv${app.versions?.prod || app.versions?.test || '0.0.0'}\n- Initial release notes created by Claude Prep\n`;
                        if (content) {
                            appFolder.file(docName, content);
                            files.push({ name: docName, size: content.length, generated: true, tokens: TokenRegistryService.estimateTokens(content, docName) });
                            addLog(`\ud83d\udcdd Generated skeleton: ${docName}`, 'warn');
                        }
                    }
                }
                
                // === Generate CLAUDE_INSTRUCTIONS.md from scope (if not in repo) ===
                const hasClaudeInstructions = files.some(f => f.name === 'CLAUDE_INSTRUCTIONS.md');
                if (!hasClaudeInstructions && firebaseDb && firebaseAuth?.currentUser) {
                    try {
                        const scopeSnap = await firebaseDb.ref(`command-center/${firebaseAuth.currentUser.uid}/appScopes/${app.id}`).once('value');
                        const scopeData = scopeSnap.val();
                        if (scopeData) {
                            const instructions = generateClaudeInstructions(app, scopeData, config);
                            if (instructions) {
                                appFolder.file('CLAUDE_INSTRUCTIONS.md', instructions);
                                files.push({ name: 'CLAUDE_INSTRUCTIONS.md', size: instructions.length, generated: true, tokens: TokenRegistryService.estimateTokens(instructions, 'CLAUDE_INSTRUCTIONS.md') });
                                addLog('\ud83c\udfaf Generated CLAUDE_INSTRUCTIONS.md from project scope');
                            }
                        }
                    } catch (e) {
                        addLog('\u26a0\ufe0f Could not generate CLAUDE_INSTRUCTIONS.md: ' + e.message, 'warn');
                    }
                }
                
                // === Generate PRODUCT_BRIEF.md (Phase 5.5) ===
                const hasProductBrief = files.some(f => f.name === 'PRODUCT_BRIEF.md');
                if (!hasProductBrief && firebaseDb && firebaseAuth?.currentUser) {
                    try {
                        // Fetch scope data if not already fetched for CLAUDE_INSTRUCTIONS
                        let briefScopeData = null;
                        try {
                            const scopeSnap = await firebaseDb.ref(`command-center/${firebaseAuth.currentUser.uid}/appScopes/${app.id}`).once('value');
                            briefScopeData = scopeSnap.val();
                        } catch (e) { /* scope data optional */ }
                        
                        if (ProductBriefGenerator.hasData(app, briefScopeData, globalWorkItems)) {
                            const brief = ProductBriefGenerator.generate(app, briefScopeData, config, globalWorkItems, deployments, globalStreams);
                            if (brief) {
                                appFolder.file('PRODUCT_BRIEF.md', brief);
                                files.push({ name: 'PRODUCT_BRIEF.md', size: brief.length, generated: true, tokens: TokenRegistryService.estimateTokens(brief, 'PRODUCT_BRIEF.md') });
                                addLog('ðŸ“„ Generated PRODUCT_BRIEF.md â€” product context for all streams');
                            }
                        }
                    } catch (e) {
                        addLog('\u26a0\ufe0f Could not generate PRODUCT_BRIEF.md: ' + e.message, 'warn');
                    }
                }
                
                // === Scan for extra docs ===
                addLog('\ud83d\udd0d Scanning for extra reference docs...');
                setProgress({ current: 6, total: 9 });
                
                const alreadyFetched = new Set([...CLAUDE_PREP_DOCS, ...files.map(f => f.name), 'SESSION_BRIEF.md', 'PRODUCT_BRIEF.md']);
                const scanPath = subPath || '';
                
                try {
                    const repoContents = await github.listRepoContents(repo, scanPath);
                    const extraMdFiles = repoContents.filter(f => 
                        f.type === 'file' && 
                        (f.name.endsWith('.md') || f.name.endsWith('.txt')) &&
                        !alreadyFetched.has(f.name) &&
                        f.name !== 'README.md' && f.name !== 'LICENSE' && f.name !== 'LICENSE.md'
                    );
                    
                    for (const extra of extraMdFiles) {
                        const filePath = scanPath ? `${scanPath}/${extra.name}` : extra.name;
                        const extraFile = await github.getFileContent(repo, filePath);
                        if (extraFile?.textContent) {
                            appFolder.file(extra.name, extraFile.textContent);
                            files.push({ name: extra.name, size: extraFile.textContent.length, tokens: TokenRegistryService.estimateTokens(extraFile.textContent, extra.name) });
                            addLog(`\u2705 ${extra.name} (extra reference doc)`);
                        }
                    }
                    if (extraMdFiles.length === 0) addLog('\u2139\ufe0f No extra reference docs found');
                } catch (e) {
                    addLog('\u26a0\ufe0f Could not scan for extra docs: ' + e.message, 'warn');
                }
                
                // === Phase 2.2: Create session record via SessionService (moved before brief for ID embedding) ===
                let newSession = null;
                if (firebaseUid) {
                    try {
                        newSession = await SessionService.create(firebaseUid, {
                            appId: app.id,
                            type: sessionType || 'build',
                            workItemId: selectedWorkItems.length > 0 ? selectedWorkItems.map(wi => wi.id).join(',') : null,
                            engineId: typeInfo?.suggestedEngine || 'claude-sonnet-4.5',
                            packageTokens: totalTokens,
                            packageFiles: files.map(f => f.name)
                        });
                        if (newSession) {
                            setSessionRecord(newSession);
                            addLog(`\ud83d\udcdd Session ${newSession.id} recorded`, 'success');
                            // Phase 3.4: Log session creation
                            const actor = config?.ownerName || 'Owner';
                            ActivityLogService.logSessionCreate(firebaseUid, actor, app.name, sessionType || 'build', newSession.id).catch(() => {});
                        }
                    } catch (e) {
                        addLog(`\u26a0\ufe0f Could not create session record: ${e.message}`, 'warn');
                    }
                }
                
                // === Generate SESSION_BRIEF.md ===
                addLog('\ud83d\udccb Generating session brief...');
                setProgress({ current: 8, total: 9 });
                
                if (sessionType) addLog(`\ud83c\udfaf Session type: ${SESSION_TYPES[sessionType]?.icon || ''} ${SESSION_TYPES[sessionType]?.label || sessionType}`);
                if (selectedWorkItems.length > 0) addLog(`\ud83d\udccb Targeting ${selectedWorkItems.length} work item${selectedWorkItems.length > 1 ? 's' : ''}: ${selectedWorkItems.map(wi => wi.id).join(', ')}`);
                
                const brief = SessionBriefGenerator.generate(app, config, deployments, {
                    sessionType: sessionType || null,
                    targetWorkItems: selectedWorkItems.length > 0 ? selectedWorkItems : null,
                    allWorkItems: globalWorkItems || [],
                    streams: globalStreams || [],  // Phase 5.2: stream context
                    sessionId: newSession?.id || null  // Phase C: embed session ID for return matching
                });
                const manifest = '\n## Files in This Package\n| File | Size | Tokens | Source |\n|------|------|--------|--------|\n' +
                    files.map(f => `| ${f.name} | ${(f.size / 1024).toFixed(1)}KB | ${TokenRegistryService.formatTokens(f.tokens || 0)} | ${f.generated ? '\u26a1 Generated skeleton' : '\ud83d\udcc2 From repo'} |`).join('\n') + '\n';
                const fullBrief = brief + manifest;
                appFolder.file('SESSION_BRIEF.md', fullBrief);
                files.push({ name: 'SESSION_BRIEF.md', size: fullBrief.length, tokens: TokenRegistryService.estimateTokens(fullBrief, 'SESSION_BRIEF.md') });
                
                // === Build zip ===
                addLog('\ud83d\udce6 Building zip...');
                setProgress({ current: 9, total: 9 });
                
                const ver = app.versions?.prod || app.versions?.test || '0.0.0';
                const filename = `${app.id}-project-v${ver}.zip`;
                const blob = await zip.generateAsync({ type: 'blob', compression: 'DEFLATE', compressionOptions: { level: 6 } });
                const blobUrl = URL.createObjectURL(blob);
                const totalSize = files.reduce((sum, f) => sum + f.size, 0);
                
                addLog(`\ud83c\udf89 Package ready: ${filename} (${(blob.size / 1024).toFixed(0)}KB compressed)`, 'success');
                if (missingDocs.length > 0) addLog(`\u26a0\ufe0f ${missingDocs.length} doc${missingDocs.length > 1 ? 's were' : ' was'} generated as skeleton${missingDocs.length > 1 ? 's' : ''} \u2014 flesh out during the session`, 'warn');
                
                const totalTokens = files.reduce((sum, f) => sum + (f.tokens || 0), 0);
                const budget = EngineRegistryService.checkBudget(totalTokens);
                
                addLog(`\ud83d\udcca Token estimate: ${TokenRegistryService.formatTokens(totalTokens)} (${budget.percentUsed}% of ${budget.engine.name} budget)`, budget.fits ? 'success' : 'warn');
                
                // === Phase 2.2: Work item auto-transition to in-progress ===
                if (firebaseUid && selectedWorkItems.length > 0) {
                    for (const wi of selectedWorkItems) {
                        if (wi.status === 'ready') {
                            try {
                                await WorkItemService.updateStatus(firebaseUid, wi.id, 'in-progress');
                                addLog(`\u27a1\ufe0f ${wi.id} \u2192 in-progress`, 'success');
                            } catch (e) {
                                addLog(`\u26a0\ufe0f Could not transition ${wi.id}: ${e.message}`, 'warn');
                            }
                        }
                    }
                }
                
                setResult({ blobUrl, filename, fileCount: files.length, totalSize, missingDocs, files, totalTokens, budget, sessionType });
                setStatus('done');
                setPhase('done');
                
            } catch (e) {
                addLog(`\u274c Error: ${e.message}`, 'error');
                setStatus('error');
                setPhase('error');
            }
        };
        
        // Cleanup blob URL on unmount
        React.useEffect(() => {
            return () => { if (result?.blobUrl) URL.revokeObjectURL(result.blobUrl); };
        }, [result]);
        
        const download = () => {
            if (!result) return;
            const a = document.createElement('a');
            a.href = result.blobUrl;
            a.download = result.filename;
            a.click();
        };
        
        // === Doc Upload Functions (preserved from Phase 2.1) ===
        const ALLOWED_DOC_NAMES = ['CONTEXT.md', 'PROJECT_PLAN.md', 'CHANGELOG.md', 'RELEASE_NOTES.txt', 'ARCHITECTURE.md', 'DATA_MODEL.md', 'UX_LAYERS.md', 'VOICE_OPTIMIZATION.md', 'QUOTE_MIGRATION.md'];
        
        const handleDocDrop = async (e) => {
            e.preventDefault();
            e.stopPropagation();
            const files = Array.from(e.dataTransfer?.files || e.target?.files || []);
            if (files.length === 0) return;
            // Prefer test repo (development-first workflow)
            const repo = app.repos?.test || app.testRepo || app.repos?.prod || app.prodRepo;
            if (!repo) return;
            const subPath = app.subPath || '';
            let docFiles = [];
            for (const file of files) {
                if (file.name.endsWith('.zip')) {
                    try {
                        const zipData = await file.arrayBuffer();
                        const zip = await JSZip.loadAsync(zipData);
                        for (const [path, entry] of Object.entries(zip.files)) {
                            if (entry.dir) continue;
                            const name = path.split('/').pop();
                            if (name.endsWith('.md') || name.endsWith('.txt')) {
                                const content = await entry.async('string');
                                docFiles.push({ name, content });
                            }
                        }
                    } catch (err) { await showAlert('Failed to read zip: ' + err.message); return; }
                } else if (file.name.endsWith('.md') || file.name.endsWith('.txt')) {
                    const content = await file.text();
                    docFiles.push({ name: file.name, content });
                }
            }
            if (docFiles.length === 0) { await showAlert('No .md or .txt doc files found.'); return; }
            const deduped = {};
            for (const f of docFiles) { deduped[f.name] = f; }
            docFiles = Object.values(deduped);
            const parsed = [];
            for (const doc of docFiles) {
                const docsPathLocal = getDocsPath(app);
                const paths = docsPathLocal
                    ? [`${docsPathLocal}/${doc.name}`, `${subPath}/${doc.name}`, doc.name]
                    : subPath ? [`${subPath}/${doc.name}`, doc.name] : [doc.name];
                let existingSha = null;
                let targetPath = paths[0];
                for (const tryPath of paths) {
                    try {
                        const existing = await github.getFile(repo, tryPath);
                        if (existing) { existingSha = existing.sha; targetPath = tryPath; break; }
                    } catch (e) { /* not found */ }
                }
                if (!existingSha && !subPath) targetPath = doc.name;
                else if (!existingSha && subPath) targetPath = docsPathLocal ? `${docsPathLocal}/${doc.name}` : `${subPath}/${doc.name}`;
                parsed.push({ name: doc.name, content: doc.content, size: doc.content.length, existing: !!existingSha, sha: existingSha, targetPath });
            }
            setUploadFiles(parsed);
        };
        
        const pushDocsToRepo = async () => {
            if (!github || uploadFiles.length === 0) return;
            // Prefer test repo (development-first workflow)
            const repo = app.repos?.test || app.testRepo || app.repos?.prod || app.prodRepo;
            if (!repo) return;
            setUploading(true);
            setUploadLog([]);
            const actuallyPushedDocs = [];
            let skippedCount = 0;
            for (const doc of uploadFiles) {
                try {
                    // For existing files, check if content actually changed
                    if (doc.existing) {
                        const existing = await github.getFile(repo, doc.targetPath);
                        if (existing && isDocUnchanged(existing, doc.content)) {
                            setUploadLog(prev => [...prev, { msg: `\u23ed\ufe0f ${doc.name} unchanged, skipping`, type: 'info' }]);
                            skippedCount++;
                            continue;
                        }
                    }
                    
                    const action = doc.existing ? 'Updating' : 'Creating';
                    setUploadLog(prev => [...prev, { msg: `\ud83d\udce4 ${action} ${doc.targetPath}...`, type: 'info' }]);
                    await github.createOrUpdateFile(repo, doc.targetPath, doc.content, `${doc.existing ? 'Update' : 'Add'} ${doc.name} via Command Center`, doc.sha);
                    setUploadLog(prev => [...prev, { msg: `\u2705 ${doc.name} pushed to ${doc.targetPath}`, type: 'success' }]);
                    actuallyPushedDocs.push({ name: doc.name, content: doc.content });
                } catch (e) {
                    setUploadLog(prev => [...prev, { msg: `\u274c Failed to push ${doc.name}: ${e.message}`, type: 'error' }]);
                }
            }
            setUploading(false);
            const doneMsg = skippedCount > 0
                ? `\ud83c\udf89 Done! ${actuallyPushedDocs.length} pushed, ${skippedCount} unchanged.`
                : '\ud83c\udf89 Done! Docs are now in the repo.';
            setUploadLog(prev => [...prev, { msg: doneMsg, type: 'success' }]);
            
            // Check actually-changed docs for concepts (skip unchanged)
            if (actuallyPushedDocs.length > 0 && showPrompt) {
                checkPushedDocsForConcepts(actuallyPushedDocs, globalStreams, null, showPrompt, {
                    uid: firebaseUid,
                    updateStream: WorkStreamService.update.bind(WorkStreamService)
                }).catch(e => console.error('[Concepts] Error during concept check:', e));
            }
        };
        
        const logColors = { info: 'text-slate-400', success: 'text-green-400', warn: 'text-amber-400', error: 'text-red-400' };
        
        // === Wizard Step Labels ===
        const WIZARD_STEPS = [
            { num: 1, label: 'Work Items', icon: '\ud83d\udccb' },
            { num: 2, label: 'Session Type', icon: '\ud83c\udfaf' },
            { num: 3, label: 'Generate', icon: '\ud83d\udce6' }
        ];
        
        // === RENDER ===
        return (
            <div className="fixed inset-0 bg-black/70 flex items-center justify-center z-50" onClick={onClose}>
                <div className="bg-slate-800 rounded-xl border border-slate-600 w-full max-w-xl mx-4 max-h-[85vh] flex flex-col" onClick={e => e.stopPropagation()}>
                    {/* Header */}
                    <div className="flex items-center justify-between p-4 border-b border-slate-700">
                        <div className="flex items-center gap-3">
                            <span className="text-2xl">\ud83e\udd16</span>
                            <div>
                                <h2 className="text-lg font-semibold">Claude Session Wizard</h2>
                                <div className="text-sm text-slate-400 flex items-center gap-2">
                                    <AppIcon icon={app.icon} size={16} />
                                    {app.name}
                                    {app.versions?.prod && <span className="text-xs bg-green-900/40 text-green-300 px-1.5 rounded">v{app.versions.prod}</span>}
                                </div>
                            </div>
                        </div>
                        <button onClick={onClose} className="text-slate-400 hover:text-white text-xl px-2">\u2715</button>
                    </div>
                    
                    {/* === Wizard Step Indicator === */}
                    {phase === 'wizard' && (
                        <div className="flex items-center gap-1 px-4 pt-3 pb-1">
                            {WIZARD_STEPS.map((s, i) => (
                                <React.Fragment key={s.num}>
                                    <button 
                                        onClick={() => s.num < wizardStep && setWizardStep(s.num)}
                                        className={`flex items-center gap-1.5 px-2.5 py-1.5 rounded-full text-xs font-medium transition-all ${
                                            wizardStep === s.num 
                                                ? 'bg-purple-600/30 text-purple-200 border border-purple-500' 
                                                : wizardStep > s.num 
                                                    ? 'bg-green-900/20 text-green-400 border border-green-800 cursor-pointer hover:bg-green-900/30'
                                                    : 'bg-slate-700/30 text-slate-500 border border-slate-700'
                                        }`}>
                                        <span>{wizardStep > s.num ? '\u2713' : s.icon}</span>
                                        <span className="hidden sm:inline">{s.label}</span>
                                        <span className="sm:hidden">{s.num}</span>
                                    </button>
                                    {i < WIZARD_STEPS.length - 1 && (
                                        <div className={`flex-1 h-px ${wizardStep > s.num ? 'bg-green-700' : 'bg-slate-700'}`} />
                                    )}
                                </React.Fragment>
                            ))}
                        </div>
                    )}
                    
                    {/* === STEP 1: Work Items === */}
                    {phase === 'wizard' && wizardStep === 1 && (
                        appWorkItems.length === 0 ? (
                            /* Quick Build Bypass: 0 work items â†’ one-screen summary */
                            <div className="flex-1 overflow-y-auto p-5 min-h-0 space-y-4">
                                <div className="text-sm font-medium text-slate-300 mb-1">Quick Build</div>
                                <div className="text-xs text-slate-500 mb-3">No open work items â€” this will generate a general session package.</div>
                                
                                <div className="bg-slate-900/50 rounded-lg p-4 space-y-3 text-xs">
                                    <div className="flex items-center justify-between">
                                        <span className="text-slate-500">App</span>
                                        <span className="text-slate-300 flex items-center gap-1.5"><AppIcon icon={app.icon} size={14} /> {app.name}</span>
                                    </div>
                                    <div className="flex items-center justify-between">
                                        <span className="text-slate-500">Session Type</span>
                                        <span className="text-slate-300">General (no targeted items)</span>
                                    </div>
                                    <div className="flex items-center justify-between">
                                        <span className="text-slate-500">Engine</span>
                                        <span className="text-slate-300">{activeEngine?.name || 'Default'}</span>
                                    </div>
                                    <div className="flex items-center justify-between">
                                        <span className="text-slate-500">Source Files</span>
                                        <span className="text-slate-300">Included</span>
                                    </div>
                                </div>
                                
                                <div className="bg-green-900/15 border border-green-800/30 rounded-lg p-3 text-xs text-green-300 flex items-center gap-2">
                                    <span className="text-green-400">\u2713</span>
                                    <span>Package fits â€” Claude will see everything needed.</span>
                                </div>
                                
                                <div className="pt-2">
                                    <button onClick={quickBuild}
                                        className="w-full py-3 bg-purple-600 hover:bg-purple-500 rounded-lg font-medium text-sm flex items-center justify-center gap-2 transition-colors">
                                        \ud83d\udce6 Generate Package
                                    </button>
                                </div>
                            </div>
                        ) : (
                        <div className="flex-1 overflow-y-auto p-5 min-h-0 space-y-4">
                            <div className="text-sm font-medium text-slate-300 mb-1">What are you working on?</div>
                            <div className="text-xs text-slate-500 mb-3">Build a Claude briefing package. Select work items to focus on, or skip for a general session.</div>
                            
                            {/* Stream filter (Phase 5.2) */}
                            {appStreams.length > 0 && (
                                <div className="flex items-center gap-2 mb-2">
                                    <span className="text-xs text-slate-500">Stream:</span>
                                    <select value={streamFilter} onChange={e => setStreamFilter(e.target.value)}
                                        className="bg-slate-700 border border-slate-600 rounded px-2 py-1 text-xs">
                                        <option value="all">All streams</option>
                                        {appStreams.map(s => (
                                            <option key={s.id} value={s.id}>ðŸ”€ {s.name}</option>
                                        ))}
                                        <option value="unassigned">ðŸ“‹ Unassigned</option>
                                    </select>
                                </div>
                            )}
                            
                            {appWorkItems.length > 0 ? (
                                <div className="space-y-1.5 max-h-64 overflow-y-auto">
                                    {appWorkItems.map(wi => {
                                        const isSelected = selectedWorkItems.some(w => w.id === wi.id);
                                        const typeColors = { feature: 'text-blue-400', bugfix: 'text-red-400', enhancement: 'text-green-400', chore: 'text-slate-400', research: 'text-amber-400' };
                                        return (
                                            <button key={wi.id}
                                                onClick={() => handleWorkItemToggle(wi)}
                                                className={`w-full text-left px-3 py-2.5 rounded-lg text-xs flex items-center gap-2 transition-all border ${
                                                    isSelected 
                                                        ? 'bg-purple-600/20 border-purple-500/50 text-slate-200' 
                                                        : 'bg-slate-700/30 border-transparent text-slate-400 hover:bg-slate-700/50'
                                                }`}>
                                                <span className={`w-4 h-4 flex items-center justify-center rounded border ${
                                                    isSelected ? 'bg-purple-600 border-purple-500 text-white' : 'border-slate-600'
                                                }`}>
                                                    {isSelected && '\u2713'}
                                                </span>
                                                <span className="font-mono text-slate-500">{wi.id}</span>
                                                <span className={typeColors[wi.type] || 'text-slate-400'}>{wi.type}</span>
                                                <span className="flex-1 truncate text-slate-300">{wi.title}</span>
                                                <span className={`px-1.5 py-0.5 rounded text-[10px] ${
                                                    wi.status === 'in-progress' ? 'bg-blue-900/30 text-blue-300' : 'bg-slate-700 text-slate-400'
                                                }`}>{wi.status}</span>
                                            </button>
                                        );
                                    })}
                                </div>
                            ) : (
                                <div className="bg-slate-900/30 rounded-lg p-4 text-center text-sm text-slate-500">
                                    No open work items for this app.
                                    <div className="text-xs mt-1 text-slate-600">This will be a general session.</div>
                                </div>
                            )}
                            
                            {selectedWorkItems.length > 0 && (
                                <div className="bg-purple-900/20 border border-purple-800/50 rounded-lg p-3 text-xs text-purple-300">
                                    \ud83d\udccb {selectedWorkItems.length} item{selectedWorkItems.length > 1 ? 's' : ''} selected
                                    {selectedWorkItems.filter(wi => wi.status === 'ready').length > 0 && (
                                        <span className="text-purple-400 ml-2">
                                            \u2192 {selectedWorkItems.filter(wi => wi.status === 'ready').length} will transition to in-progress
                                        </span>
                                    )}
                                </div>
                            )}
                        </div>
                        )
                    )}
                    
                    {/* === STEP 2: Session Type + Context Preview === */}
                    {phase === 'wizard' && wizardStep === 2 && (
                        <div className="flex-1 overflow-y-auto p-5 min-h-0 space-y-4">
                            <div className="text-sm font-medium text-slate-300 mb-1">Session Type</div>
                            <div className="text-xs text-slate-500 mb-3">
                                {selectedWorkItems.length > 0 && sessionType 
                                    ? `Auto-suggested from work item type. This determines how Claude approaches the work and what context it receives.` 
                                    : 'Choose what kind of work you\'ll be doing. This shapes Claude\'s approach and the files included.'}
                            </div>
                            
                            <div className="grid grid-cols-4 gap-1.5">
                                {SessionBriefGenerator.getAll().map(t => (
                                    <button key={t.id}
                                        onClick={() => setSessionType(sessionType === t.id ? null : t.id)}
                                        className={`py-2.5 px-1.5 rounded-lg text-center text-xs transition-all border ${
                                            sessionType === t.id 
                                                ? 'bg-purple-600/30 border-purple-500 text-purple-200' 
                                                : 'bg-slate-700/50 border-slate-600/50 text-slate-400 hover:bg-slate-700 hover:text-slate-300'
                                        }`}>
                                        <div className="text-lg mb-0.5">{t.icon}</div>
                                        <div>{t.label}</div>
                                    </button>
                                ))}
                            </div>
                            
                            {typeInfo && (
                                <div className="bg-slate-900/50 rounded-lg p-3 text-xs space-y-2">
                                    <div className="text-slate-300">{typeInfo.description}</div>
                                    {suggestedEngine && (
                                        <div className="text-slate-500">Suggested engine: <span className="text-slate-400">{suggestedEngine.name}</span></div>
                                    )}
                                    <div className="text-slate-400 italic text-[11px]">"{typeInfo.roleFrame}"</div>
                                    <div className="space-y-0.5 mt-1">
                                        {typeInfo.scopeRules.map((rule, i) => (
                                            <div key={i} className="text-slate-500 flex items-start gap-1.5">
                                                <span className="text-slate-600 mt-0.5">\u2022</span> {rule}
                                            </div>
                                        ))}
                                    </div>
                                    <div className="pt-2 border-t border-slate-800">
                                        <div className="text-slate-500 font-medium mb-1">Delivery requirements:</div>
                                        {typeInfo.deliveryRequirements.map((req, i) => (
                                            <div key={i} className="text-slate-500 flex items-start gap-1.5">
                                                <span className="text-green-700 mt-0.5">\u2713</span> {req}
                                            </div>
                                        ))}
                                    </div>
                                </div>
                            )}
                            
                            {/* Context confidence indicator (replaces old Step 3) */}
                            <div className="bg-green-900/15 border border-green-800/30 rounded-lg p-3 text-xs text-green-300 flex items-center gap-2">
                                <span className="text-green-400">\u2713</span>
                                <span>Package fits â€” Claude will see everything needed for this session.</span>
                            </div>
                            
                            {/* Collapsible: What Claude will see */}
                            <details className="group">
                                <summary className="text-xs text-slate-500 cursor-pointer hover:text-slate-300 transition-colors select-none flex items-center gap-1">
                                    <span className="text-[10px] group-open:rotate-90 transition-transform inline-block">\u25b6</span>
                                    What Claude will see
                                </summary>
                                <div className="mt-2 space-y-2">
                                    {typeInfo ? (
                                        <div className="space-y-1">
                                            {typeInfo.contextStrategy.includeSource && (
                                                <div className="flex items-center gap-2 px-3 py-1.5 bg-green-900/20 rounded text-xs">
                                                    <span className="text-green-400">\u2713</span>
                                                    <span className="text-green-300 font-mono">{app.targetPath || 'index.html'}</span>
                                                    <span className="text-green-600 ml-auto">source</span>
                                                </div>
                                            )}
                                            {!typeInfo.contextStrategy.includeSource && (
                                                <div className="flex items-center gap-2 px-3 py-1.5 bg-slate-800 rounded text-xs">
                                                    <span className="text-slate-600">\u2212</span>
                                                    <span className="text-slate-500 font-mono line-through">{app.targetPath || 'index.html'}</span>
                                                    <span className="text-amber-600 ml-auto">skipped</span>
                                                </div>
                                            )}
                                            {typeInfo.contextStrategy.alwaysInclude.map(f => (
                                                <div key={f} className="flex items-center gap-2 px-3 py-1.5 bg-green-900/20 rounded text-xs">
                                                    <span className="text-green-400">\u2713</span>
                                                    <span className="text-green-300 font-mono">{f}</span>
                                                    <span className="text-green-600 ml-auto">always</span>
                                                </div>
                                            ))}
                                            {typeInfo.contextStrategy.preferInclude.map(f => (
                                                <div key={f} className="flex items-center gap-2 px-3 py-1.5 bg-slate-700/50 rounded text-xs">
                                                    <span className="text-slate-400">+</span>
                                                    <span className="text-slate-300 font-mono">{f}</span>
                                                    <span className="text-slate-500 ml-auto">preferred</span>
                                                </div>
                                            ))}
                                            {typeInfo.contextStrategy.skipWhenTight.map(f => (
                                                <div key={f} className="flex items-center gap-2 px-3 py-1.5 bg-slate-800 rounded text-xs">
                                                    <span className="text-slate-600">\u2212</span>
                                                    <span className="text-slate-500 font-mono">{f}</span>
                                                    <span className="text-slate-600 ml-auto">skipped</span>
                                                </div>
                                            ))}
                                            <div className="text-xs text-slate-500 mt-2">
                                                + SESSION_BRIEF.md (auto-generated) + any extra .md/.txt files found in repo
                                            </div>
                                        </div>
                                    ) : (
                                        <div className="bg-slate-900/30 rounded-lg p-3 text-xs text-slate-500">
                                            All standard docs + source files will be included. Select a session type above to optimize file selection.
                                        </div>
                                    )}
                                </div>
                            </details>
                            
                            {/* Work item context note */}
                            {selectedWorkItems.length > 0 && (
                                <div className="bg-purple-900/15 border border-purple-800/30 rounded-lg p-3 text-xs text-purple-300">
                                    \ud83d\udccb Session brief will include acceptance criteria, files affected, and dependencies for {selectedWorkItems.length} targeted work item{selectedWorkItems.length > 1 ? 's' : ''}.
                                </div>
                            )}
                        </div>
                    )}
                    
                    {/* === STEP 3: Generate (summary before building) === */}
                    {phase === 'wizard' && wizardStep === 3 && (
                        <div className="flex-1 overflow-y-auto p-5 min-h-0 space-y-4">
                            <div className="text-sm font-medium text-slate-300 mb-1">Ready to Generate</div>
                            <div className="text-xs text-slate-500 mb-3">Generate a zip package with source, docs, and a session brief to upload to Claude.</div>
                            
                            {/* Summary */}
                            <div className="bg-slate-900/50 rounded-lg p-4 space-y-3 text-xs">
                                <div className="flex items-center justify-between">
                                    <span className="text-slate-500">Session Type</span>
                                    <span className="text-slate-300">{typeInfo ? `${typeInfo.icon} ${typeInfo.label}` : 'General (no type)'}</span>
                                </div>
                                <div className="flex items-center justify-between">
                                    <span className="text-slate-500">Work Items</span>
                                    <span className="text-slate-300">{selectedWorkItems.length > 0 ? selectedWorkItems.map(wi => wi.id).join(', ') : 'None (general session)'}</span>
                                </div>
                                <div className="flex items-center justify-between">
                                    <span className="text-slate-500">Engine</span>
                                    <span className="text-slate-300">{activeEngine?.name || 'Default'}</span>
                                </div>
                                <div className="flex items-center justify-between">
                                    <span className="text-slate-500">Source Files</span>
                                    <span className="text-slate-300">{typeInfo?.contextStrategy?.includeSource === false ? 'Excluded' : 'Included'}</span>
                                </div>
                                {selectedWorkItems.filter(wi => wi.status === 'ready').length > 0 && (
                                    <div className="pt-2 border-t border-slate-700 text-purple-300">
                                        \u27a1\ufe0f {selectedWorkItems.filter(wi => wi.status === 'ready').length} work item{selectedWorkItems.filter(wi => wi.status === 'ready').length > 1 ? 's' : ''} will transition to <strong>in-progress</strong>
                                    </div>
                                )}
                            </div>
                        </div>
                    )}
                    
                    {/* === Wizard Footer (navigation) === */}
                    {phase === 'wizard' && (
                        <div className="p-4 border-t border-slate-700 space-y-2">
                            <div className="flex gap-2">
                                {wizardStep > 1 && (
                                    <button onClick={goBack}
                                        className="px-4 py-2.5 bg-slate-700 hover:bg-slate-600 rounded-lg text-sm transition-colors">
                                        \u2190 Back
                                    </button>
                                )}
                                {wizardStep < 3 && (
                                    <button onClick={goNext}
                                        className="flex-1 py-2.5 bg-purple-600 hover:bg-purple-500 rounded-lg font-medium text-sm transition-colors">
                                        Next \u2192
                                    </button>
                                )}
                                {wizardStep === 3 && (
                                    <button onClick={startPrep}
                                        className="flex-1 py-2.5 bg-purple-600 hover:bg-purple-500 rounded-lg font-medium text-sm flex items-center justify-center gap-2 transition-colors">
                                        \ud83d\udce6 Generate Package{sessionType ? ` (${SESSION_TYPES[sessionType].icon} ${SESSION_TYPES[sessionType].label})` : ''}
                                    </button>
                                )}
                            </div>
                            {wizardStep === 1 && (
                                <button onClick={quickBuild}
                                    className="w-full py-2 text-sm text-slate-500 hover:text-slate-300 transition-colors">
                                    Skip wizard \u2014 Quick package
                                </button>
                            )}
                        </div>
                    )}
                    
                    {/* === Building/Done/Error Phase (same as before) === */}
                    {(phase === 'building' || phase === 'done' || phase === 'error') && (
                        <React.Fragment>
                    
                    {status === 'fetching' && progress.total > 0 && (
                        <div className="px-5 pt-3">
                            <div className="h-1.5 bg-slate-700 rounded-full overflow-hidden">
                                <div className="h-full bg-purple-500 rounded-full transition-all duration-300"
                                    style={{ width: `${(progress.current / progress.total) * 100}%` }} />
                            </div>
                        </div>
                    )}
                    
                    <div className="flex-1 overflow-y-auto p-5 min-h-0">
                        <div className="space-y-1 font-mono text-xs">
                            {log.map((entry, i) => (
                                <div key={i} className={logColors[entry.type] || 'text-slate-400'}>
                                    <span className="text-slate-600 mr-2">{entry.time}</span>
                                    {entry.msg}
                                </div>
                            ))}
                            {status === 'fetching' && (
                                <div className="text-purple-400 animate-pulse">\u23f3 Working...</div>
                            )}
                        </div>
                    </div>
                    
                    <div className="p-5 border-t border-slate-700">
                        {status === 'done' && result && (
                            <div className="space-y-3">
                                <div className="flex items-center gap-4 text-sm flex-wrap">
                                    <div className="flex items-center gap-1.5 text-slate-300"><span>\ud83d\udce6</span> {result.fileCount} files</div>
                                    <div className="flex items-center gap-1.5 text-slate-300"><span>\ud83d\udcbe</span> {(result.totalSize / 1024).toFixed(0)}KB</div>
                                    <div className="flex items-center gap-1.5 text-slate-300"><span>\ud83e\uddee</span> {TokenRegistryService.formatTokens(result.totalTokens)} tokens</div>
                                    {result.missingDocs.length > 0 && (
                                        <div className="flex items-center gap-1.5 text-amber-400"><span>\u26a1</span> {result.missingDocs.length} skeleton{result.missingDocs.length > 1 ? 's' : ''}</div>
                                    )}
                                    {sessionRecord && (
                                        <div className="flex items-center gap-1.5 text-green-400"><span>\ud83d\udcdd</span> {sessionRecord.id}</div>
                                    )}
                                </div>
                                
                                {result.budget && (() => {
                                    const b = result.budget;
                                    const pct = Math.min(b.percentUsed, 100);
                                    const barColor = b.percentUsed <= 50 ? 'bg-green-500' : b.percentUsed <= 75 ? 'bg-emerald-500' : b.percentUsed <= 90 ? 'bg-amber-500' : b.fits ? 'bg-orange-500' : 'bg-red-500';
                                    const textColor = b.fits ? 'text-slate-400' : 'text-red-400';
                                    return (
                                        <div className="bg-slate-900 rounded-lg p-3">
                                            <div className="flex items-center justify-between text-xs mb-1.5">
                                                <span className="text-slate-400 font-medium">{b.engine.name}</span>
                                                <span className={textColor}>{TokenRegistryService.formatTokens(b.tokenCount)} / {TokenRegistryService.formatTokens(b.usableLimit)} usable ({b.percentUsed}%)</span>
                                            </div>
                                            <div className="h-2.5 bg-slate-700 rounded-full overflow-hidden">
                                                <div className={`h-full rounded-full transition-all duration-500 ${barColor}`} style={{ width: `${pct}%` }} />
                                            </div>
                                            <div className="flex justify-between text-[10px] text-slate-600 mt-1">
                                                <span>0</span>
                                                <span>{TokenRegistryService.formatTokens(b.limit)} total ({TokenRegistryService.formatTokens(b.usableLimit)} usable \u00b7 20% reserved)</span>
                                            </div>
                                            {!b.fits && b.recommendations.length > 0 && (
                                                <div className="mt-2.5 pt-2.5 border-t border-slate-700">
                                                    <div className="text-xs text-red-400 font-medium mb-1.5">\u26a0\ufe0f Over budget by {TokenRegistryService.formatTokens(b.overBy)} tokens</div>
                                                    <div className="space-y-1">{b.recommendations.map((rec, i) => (
                                                        <div key={i} className="flex items-start gap-2 text-xs">
                                                            <span className="text-slate-500 mt-0.5">\u2022</span>
                                                            <div><span className="text-slate-300">{rec.label}</span>{rec.savings && <span className="text-green-500 ml-1">({rec.savings})</span>}{rec.cost && <span className="text-amber-500 ml-1">({rec.cost})</span>}</div>
                                                        </div>
                                                    ))}</div>
                                                </div>
                                            )}
                                        </div>
                                    );
                                })()}
                                
                                {result.files && result.files.length > 0 && (
                                    <details className="group">
                                        <summary className="text-xs text-slate-500 cursor-pointer hover:text-slate-300 select-none">\ud83d\udccb File manifest ({result.files.length} files)</summary>
                                        <div className="mt-2 bg-slate-900 rounded-lg overflow-hidden">
                                            <table className="w-full text-xs">
                                                <thead><tr className="text-slate-500 border-b border-slate-700">
                                                    <th className="text-left py-1.5 px-2 font-medium">File</th>
                                                    <th className="text-right py-1.5 px-2 font-medium">Size</th>
                                                    <th className="text-right py-1.5 px-2 font-medium">Tokens</th>
                                                    <th className="text-right py-1.5 px-2 font-medium">%</th>
                                                </tr></thead>
                                                <tbody>{[...result.files].sort((a, b) => (b.tokens || 0) - (a.tokens || 0)).map((f, i) => {
                                                    const pctOfTotal = result.totalTokens ? Math.round(((f.tokens || 0) / result.totalTokens) * 100) : 0;
                                                    return (<tr key={i} className="border-b border-slate-800 hover:bg-slate-800/50">
                                                        <td className="py-1 px-2 font-mono text-slate-300">{f.generated ? '\u26a1 ' : ''}{f.name}</td>
                                                        <td className="py-1 px-2 text-right text-slate-500">{(f.size / 1024).toFixed(1)}KB</td>
                                                        <td className="py-1 px-2 text-right text-slate-400">{TokenRegistryService.formatTokens(f.tokens || 0)}</td>
                                                        <td className="py-1 px-2 text-right"><span className={pctOfTotal > 50 ? 'text-amber-400' : pctOfTotal > 25 ? 'text-slate-300' : 'text-slate-500'}>{pctOfTotal}%</span></td>
                                                    </tr>);
                                                })}</tbody>
                                                <tfoot><tr className="border-t border-slate-600 font-medium">
                                                    <td className="py-1.5 px-2 text-slate-300">Total</td>
                                                    <td className="py-1.5 px-2 text-right text-slate-400">{(result.totalSize / 1024).toFixed(0)}KB</td>
                                                    <td className="py-1.5 px-2 text-right text-slate-300">{TokenRegistryService.formatTokens(result.totalTokens)}</td>
                                                    <td className="py-1.5 px-2 text-right text-slate-500">100%</td>
                                                </tr></tfoot>
                                            </table>
                                        </div>
                                    </details>
                                )}
                                
                                <button onClick={download} className="w-full py-3 bg-purple-600 hover:bg-purple-500 rounded-lg font-medium flex items-center justify-center gap-2 transition-colors">
                                    \u2b07\ufe0f Download {result.filename}
                                </button>
                                
                                {result.missingDocs.length > 0 && (
                                    <div className="text-xs text-amber-400/80 bg-amber-900/20 rounded-lg p-3">
                                        <strong>Skeleton docs generated:</strong> {result.missingDocs.join(', ')}. 
                                        These are templates \u2014 flesh them out during your first session with this app, 
                                        then commit the docs to the repo so future preps pull the real versions.
                                    </div>
                                )}
                                
                                {!uploadMode && uploadFiles.length === 0 && (
                                    <button onClick={() => setUploadMode(true)}
                                        className="w-full py-2 rounded-lg text-sm flex items-center justify-center gap-2 transition-colors bg-slate-700 hover:bg-slate-600 text-slate-300">
                                        \ud83d\udcc4 Push Docs to Repo
                                    </button>
                                )}
                            </div>
                        )}
                        
                        {(uploadMode || uploadFiles.length > 0) && (
                            <div className="space-y-3 mt-3">
                                {uploadFiles.length === 0 && (
                                    <div>
                                        <div onDrop={handleDocDrop} onDragOver={e => { e.preventDefault(); e.stopPropagation(); }}
                                            onClick={() => { const input = document.createElement('input'); input.type = 'file'; input.multiple = true; input.accept = '.md,.txt,.zip'; input.onchange = handleDocDrop; input.click(); }}
                                            className="border-2 border-dashed border-slate-600 hover:border-indigo-500 rounded-lg p-4 text-center cursor-pointer transition-colors">
                                            <div className="text-slate-400 text-sm">\ud83d\udcc4 Drop doc files or a project zip here</div>
                                            <div className="text-xs text-slate-500 mt-1">Accepts .md, .txt files or .zip packages</div>
                                        </div>
                                        <button onClick={() => setUploadMode(false)} className="w-full mt-2 py-1.5 text-xs text-slate-500 hover:text-slate-300">Cancel</button>
                                    </div>
                                )}
                                {uploadFiles.length > 0 && (
                                    <div className="space-y-2">
                                        <div className="flex items-center justify-between">
                                            <div className="text-xs text-slate-400 font-medium">Files to push:</div>
                                            <button onClick={() => { setUploadFiles([]); setUploadLog([]); }} className="text-xs text-slate-500 hover:text-red-400">\u2715 Clear</button>
                                        </div>
                                        {uploadFiles.map((f, i) => (
                                            <div key={i} className="flex items-center justify-between bg-slate-900 rounded px-3 py-2 text-sm">
                                                <div className="flex items-center gap-2">
                                                    <span>{f.existing ? '\ud83d\udd04' : '\ud83c\udd95'}</span>
                                                    <span className="font-mono text-slate-300">{f.name}</span>
                                                    <span className="text-xs text-slate-500">({(f.size / 1024).toFixed(1)}KB)</span>
                                                </div>
                                                <div className="text-xs text-slate-500 font-mono">{f.targetPath}</div>
                                            </div>
                                        ))}
                                        {!uploading && uploadLog.length === 0 && (
                                            <button onClick={pushDocsToRepo} className="w-full py-2.5 rounded-lg font-medium flex items-center justify-center gap-2 transition-colors bg-green-600 hover:bg-green-500 text-white">
                                                \ud83d\ude80 Push {uploadFiles.length} file{uploadFiles.length > 1 ? 's' : ''} to {(app.repos?.test || app.testRepo || app.repos?.prod || app.prodRepo || 'repo').split('/').pop()}
                                            </button>
                                        )}
                                        {uploading && (
                                            <div className="w-full py-2.5 rounded-lg font-medium flex items-center justify-center gap-2 bg-slate-700 text-amber-400 animate-pulse">\u23f3 Pushing files to repo...</div>
                                        )}
                                    </div>
                                )}
                                {uploadLog.length > 0 && (
                                    <div className="space-y-2">
                                        <div className="bg-slate-900 rounded-lg p-3 space-y-1 font-mono text-xs max-h-40 overflow-y-auto">
                                            {uploadLog.map((entry, i) => (<div key={i} className={logColors[entry.type] || 'text-slate-400'}>{entry.msg}</div>))}
                                        </div>
                                        {!uploading && uploadLog.some(e => e.type === 'success' && e.msg.includes('Done')) && (
                                            <div className="bg-green-900/30 border border-green-700 rounded-lg p-3 text-center">
                                                <div className="text-green-400 font-medium">\u2705 All docs pushed to repo</div>
                                                <div className="text-xs text-green-500 mt-1">Next Claude Prep will pull these docs automatically</div>
                                            </div>
                                        )}
                                        {!uploading && uploadLog.some(e => e.type === 'error') && !uploadLog.some(e => e.msg.includes('Done')) && (
                                            <div className="bg-red-900/30 border border-red-700 rounded-lg p-3 text-center">
                                                <div className="text-red-400 font-medium">\u26a0\ufe0f Some files failed to push</div>
                                                <button onClick={() => setUploadLog([])} className="text-xs text-slate-400 hover:text-white mt-1">Retry</button>
                                            </div>
                                        )}
                                    </div>
                                )}
                            </div>
                        )}
                        
                        {status === 'error' && (
                            <div className="flex gap-2">
                                <button onClick={() => { setPhase('wizard'); setWizardStep(4); setStatus('idle'); }} className="flex-1 py-2 bg-slate-700 hover:bg-slate-600 rounded-lg text-sm">\u2190 Back</button>
                                <button onClick={startPrep} className="flex-1 py-2 bg-slate-700 hover:bg-slate-600 rounded-lg text-sm">\ud83d\udd04 Retry</button>
                                <button onClick={onClose} className="flex-1 py-2 bg-slate-700 hover:bg-slate-600 rounded-lg text-sm">Close</button>
                            </div>
                        )}
                    </div>
                    
                    </React.Fragment>
                    )}
                </div>
            </div>
        );
    }

    // =========================================================================
    // SESSIONS VIEW â€” Read-only MCP session visualization (v8.70.18)
    // =========================================================================
    function SessionsView({ globalSessions, apps, globalIdeas, firebaseUid, setView }) {
        const [appFilter, setAppFilter] = React.useState('all');
        const [statusFilter, setStatusFilter] = React.useState('all');
        const [modeFilter, setModeFilter] = React.useState('all');
        const [expandedId, setExpandedId] = React.useState(null);

        const MODE_STYLES = {
            'base': 'bg-slate-700 text-slate-300',
            'ideation': 'bg-purple-900/50 text-purple-300',
            'build-review': 'bg-blue-900/50 text-blue-300',
            'debrief': 'bg-emerald-900/50 text-emerald-300'
        };

        const SESSION_STATUS_STYLES = {
            'active': 'bg-green-900/50 text-green-300',
            'prep': 'bg-blue-900/50 text-blue-300',
            'review': 'bg-amber-900/50 text-amber-300',
            'completed': 'bg-slate-700 text-slate-400',
            'abandoned': 'bg-red-900/30 text-red-400/70'
        };

        // Build unique app list from sessions
        const appOptions = React.useMemo(() => {
            const ids = [...new Set(globalSessions.map(s => s.appId).filter(Boolean))];
            return ids.map(id => {
                const app = apps && apps[id];
                return { id, name: app ? app.name : id };
            }).sort((a, b) => a.name.localeCompare(b.name));
        }, [globalSessions, apps]);

        // Build unique mode list from sessions
        const modeOptions = React.useMemo(() => {
            return [...new Set(globalSessions.map(s => s.mode || s.type || 'base').filter(Boolean))].sort();
        }, [globalSessions]);

        const filtered = React.useMemo(() => {
            return globalSessions
                .filter(s => appFilter === 'all' || s.appId === appFilter)
                .filter(s => statusFilter === 'all' || s.status === statusFilter)
                .filter(s => modeFilter === 'all' || (s.mode || s.type || 'base') === modeFilter);
        }, [globalSessions, appFilter, statusFilter, modeFilter]);

        const resolveAppName = (appId) => {
            if (!appId) return 'Unlinked';
            const app = apps && apps[appId];
            return app ? app.name : appId;
        };

        const resolveIdeaName = (ideaId) => {
            if (!ideaId) return null;
            const idea = globalIdeas.find(i => i.id === ideaId);
            return idea ? idea.name : ideaId;
        };

        if (globalSessions.length === 0) {
            return (
                <div className="text-center py-12">
                    <div className="text-4xl mb-3">ðŸ’¬</div>
                    <div className="text-lg font-bold text-white mb-1">No Sessions Yet</div>
                    <div className="text-slate-400 text-sm">Sessions created via MCP will appear here.</div>
                </div>
            );
        }

        return (
            <div>
                <div className="flex items-center justify-between mb-4">
                    <h2 className="text-lg font-bold text-white flex items-center gap-2">
                        ðŸ’¬ Sessions
                        <span className="text-sm font-normal text-slate-400">({filtered.length}{filtered.length !== globalSessions.length ? ` of ${globalSessions.length}` : ''})</span>
                    </h2>
                </div>

                {/* Filter bar */}
                <div className="flex gap-2 mb-4 flex-wrap">
                    <select value={appFilter} onChange={e => setAppFilter(e.target.value)}
                        className="bg-slate-700 border border-slate-600 rounded px-2 py-1 text-sm text-white">
                        <option value="all">All Apps</option>
                        {appOptions.map(a => <option key={a.id} value={a.id}>{a.name}</option>)}
                    </select>
                    <select value={statusFilter} onChange={e => setStatusFilter(e.target.value)}
                        className="bg-slate-700 border border-slate-600 rounded px-2 py-1 text-sm text-white">
                        <option value="all">All Statuses</option>
                        <option value="active">Active</option>
                        <option value="prep">Prep</option>
                        <option value="review">Review</option>
                        <option value="completed">Completed</option>
                        <option value="abandoned">Abandoned</option>
                    </select>
                    <select value={modeFilter} onChange={e => setModeFilter(e.target.value)}
                        className="bg-slate-700 border border-slate-600 rounded px-2 py-1 text-sm text-white">
                        <option value="all">All Modes</option>
                        {modeOptions.map(m => <option key={m} value={m}>{m}</option>)}
                    </select>
                </div>

                {/* Session list */}
                <div className="space-y-2">
                    {filtered.length === 0 ? (
                        <div className="text-center py-8 text-slate-500">No sessions match the current filters.</div>
                    ) : filtered.map(session => {
                        const mode = session.mode || session.type || 'base';
                        const isExpanded = expandedId === session.id;
                        const conceptCount = session.concepts ? Object.keys(session.concepts).length : 0;

                        return (
                            <div key={session.id}
                                className="bg-slate-800 border border-slate-700 rounded-lg overflow-hidden">
                                <button
                                    onClick={() => setExpandedId(isExpanded ? null : session.id)}
                                    className="w-full px-4 py-3 flex items-center gap-3 text-left hover:bg-slate-750 transition-colors"
                                >
                                    <span className="text-xs text-slate-500">{isExpanded ? 'â–¼' : 'â–¶'}</span>
                                    <div className="flex-1 min-w-0">
                                        <div className="flex items-center gap-2 flex-wrap">
                                            <span className="text-white font-medium truncate">
                                                {session.sessionGoal || session.title || session.id}
                                            </span>
                                            <span className={`px-2 py-0.5 rounded text-xs font-medium ${MODE_STYLES[mode] || 'bg-slate-700 text-slate-300'}`}>
                                                {mode}
                                            </span>
                                            <span className={`px-2 py-0.5 rounded text-xs font-medium ${SESSION_STATUS_STYLES[session.status] || 'bg-slate-700 text-slate-400'}`}>
                                                {session.status}
                                            </span>
                                        </div>
                                        <div className="flex items-center gap-3 mt-1 text-xs text-slate-400">
                                            <span>{resolveAppName(session.appId)}</span>
                                            {session.ideaId && <span>â€¢ {resolveIdeaName(session.ideaId)}</span>}
                                            {conceptCount > 0 && <span>â€¢ {conceptCount} concepts</span>}
                                            <span title={session.createdAt}>
                                                {formatTimeAgo(session.createdAt)}
                                            </span>
                                        </div>
                                    </div>
                                </button>

                                {isExpanded && (
                                    <div className="px-4 pb-4 border-t border-slate-700 pt-3 space-y-3">
                                        {session.sessionGoal && (
                                            <div>
                                                <div className="text-xs text-slate-500 font-medium mb-1">Goal</div>
                                                <div className="text-sm text-slate-300">{session.sessionGoal}</div>
                                            </div>
                                        )}
                                        {session.summary && (
                                            <div>
                                                <div className="text-xs text-slate-500 font-medium mb-1">Summary</div>
                                                <div className="text-sm text-slate-300 whitespace-pre-wrap">{session.summary}</div>
                                            </div>
                                        )}
                                        {session.closingSummary && (
                                            <div>
                                                <div className="text-xs text-slate-500 font-medium mb-1">Closing Summary</div>
                                                <div className="text-sm text-slate-300 whitespace-pre-wrap">{session.closingSummary}</div>
                                            </div>
                                        )}
                                        {session.lens && (
                                            <div>
                                                <div className="text-xs text-slate-500 font-medium mb-1">Lens</div>
                                                <div className="text-sm text-slate-300">{session.lens}</div>
                                            </div>
                                        )}
                                        {session.contextEstimate && (
                                            <div>
                                                <div className="text-xs text-slate-500 font-medium mb-1">Context</div>
                                                <div className="text-sm text-slate-300">{typeof session.contextEstimate === 'object' ? JSON.stringify(session.contextEstimate) : session.contextEstimate}</div>
                                            </div>
                                        )}
                                        {session.events && Object.keys(session.events).length > 0 && (
                                            <div>
                                                <div className="text-xs text-slate-500 font-medium mb-1">Events ({Object.keys(session.events).length})</div>
                                                <div className="space-y-1 max-h-48 overflow-y-auto">
                                                    {Object.entries(session.events).sort(([,a],[,b]) => (a.timestamp || '').localeCompare(b.timestamp || '')).map(([eventId, evt]) => (
                                                        <div key={eventId} className="flex items-center gap-2 text-xs">
                                                            <span className="text-slate-500 shrink-0">{evt.timestamp ? formatTimeAgo(evt.timestamp) : 'â€”'}</span>
                                                            <span className="px-1.5 py-0.5 rounded bg-slate-700 text-slate-300 shrink-0">{evt.type || 'event'}</span>
                                                            <span className="text-slate-400 truncate">{evt.summary || evt.description || evt.content || eventId}</span>
                                                        </div>
                                                    ))}
                                                </div>
                                            </div>
                                        )}
                                        <div className="text-xs text-slate-600 pt-2 border-t border-slate-700/50">
                                            ID: {session.id} â€¢ Created: {session.createdAt || 'â€”'}
                                            {session.completedAt && ` â€¢ Completed: ${session.completedAt}`}
                                        </div>
                                    </div>
                                )}
                            </div>
                        );
                    })}
                </div>
            </div>
        );
    }

    // =========================================================================
    // JOBS VIEW â€” Read-only MCP job visualization (v8.70.18)
    // =========================================================================
    function JobsView({ globalJobs, apps, globalIdeas, firebaseUid, setView }) {
        const [appFilter, setAppFilter] = React.useState('all');
        const [statusFilter, setStatusFilter] = React.useState('all');
        const [typeFilter, setTypeFilter] = React.useState('all');
        const [expandedId, setExpandedId] = React.useState(null);
        const [showFullInstructions, setShowFullInstructions] = React.useState({});
        const [olderJobs, setOlderJobs] = React.useState([]);
        const [loadingMore, setLoadingMore] = React.useState(false);
        const [hasMore, setHasMore] = React.useState(true);

        const JOB_STATUS_STYLES = {
            'draft': 'bg-slate-700 text-slate-400',
            'active': 'bg-blue-900/50 text-blue-300',
            'review': 'bg-amber-900/50 text-amber-300',
            'pending_review': 'bg-amber-900/50 text-amber-300',
            'pending': 'bg-amber-900/50 text-amber-300',
            'ready': 'bg-green-900/50 text-green-300',
            'approved': 'bg-green-900/50 text-green-300',
            'in_progress': 'bg-blue-900/50 text-blue-300',
            'completed': 'bg-green-900/30 text-green-400/70',
            'failed': 'bg-red-900/50 text-red-300',
            'abandoned': 'bg-red-900/30 text-red-400/70'
        };

        const JOB_TYPE_STYLES = {
            'build': 'bg-indigo-900/50 text-indigo-300',
            'maintenance': 'bg-slate-700 text-slate-300',
            'test': 'bg-cyan-900/50 text-cyan-300',
            'skill-update': 'bg-purple-900/50 text-purple-300',
            'cleanup': 'bg-amber-900/50 text-amber-300',
            'deploy': 'bg-teal-900/50 text-teal-300'
        };

        // v8.71.4: Merge live listener jobs with on-demand older jobs (deduplicated)
        const allJobs = React.useMemo(() => {
            const liveIds = new Set(globalJobs.map(j => j.id));
            const merged = [...globalJobs, ...olderJobs.filter(j => !liveIds.has(j.id))];
            return merged.sort((a, b) => new Date(b.createdAt || 0) - new Date(a.createdAt || 0));
        }, [globalJobs, olderJobs]);

        // Build unique app list from jobs
        const appOptions = React.useMemo(() => {
            const ids = [...new Set(allJobs.map(j => j.appId).filter(Boolean))];
            return ids.map(id => {
                const app = apps && apps[id];
                return { id, name: app ? app.name : id };
            }).sort((a, b) => a.name.localeCompare(b.name));
        }, [allJobs, apps]);

        // Build unique status list from jobs
        const statusOptions = React.useMemo(() => {
            return [...new Set(allJobs.map(j => j.status).filter(Boolean))].sort();
        }, [allJobs]);

        // Build unique type list from jobs
        const typeOptions = React.useMemo(() => {
            return [...new Set(allJobs.map(j => j.type).filter(Boolean))].sort();
        }, [allJobs]);

        const filtered = React.useMemo(() => {
            return allJobs
                .filter(j => appFilter === 'all' || j.appId === appFilter)
                .filter(j => statusFilter === 'all' || j.status === statusFilter)
                .filter(j => typeFilter === 'all' || j.type === typeFilter);
        }, [allJobs, appFilter, statusFilter, typeFilter]);

        const resolveAppName = (appId) => {
            if (!appId) return 'Unlinked';
            const app = apps && apps[appId];
            return app ? app.name : appId;
        };

        const resolveIdeaName = (ideaId) => {
            if (!ideaId) return null;
            const idea = globalIdeas.find(i => i.id === ideaId);
            return idea ? idea.name : ideaId;
        };

        if (globalJobs.length === 0) {
            return (
                <div className="text-center py-12">
                    <div className="text-4xl mb-3">ðŸ”¨</div>
                    <div className="text-lg font-bold text-white mb-1">No Jobs Yet</div>
                    <div className="text-slate-400 text-sm">Jobs created via MCP will appear here.</div>
                </div>
            );
        }

        return (
            <div>
                <div className="flex items-center justify-between mb-4">
                    <h2 className="text-lg font-bold text-white flex items-center gap-2">
                        ðŸ”¨ Jobs
                        <span className="text-sm font-normal text-slate-400">({filtered.length}{filtered.length !== globalJobs.length ? ` of ${globalJobs.length}` : ''})</span>
                    </h2>
                </div>

                {/* Filter bar */}
                <div className="flex gap-2 mb-4 flex-wrap">
                    <select value={appFilter} onChange={e => setAppFilter(e.target.value)}
                        className="bg-slate-700 border border-slate-600 rounded px-2 py-1 text-sm text-white">
                        <option value="all">All Apps</option>
                        {appOptions.map(a => <option key={a.id} value={a.id}>{a.name}</option>)}
                    </select>
                    <select value={statusFilter} onChange={e => setStatusFilter(e.target.value)}
                        className="bg-slate-700 border border-slate-600 rounded px-2 py-1 text-sm text-white">
                        <option value="all">All Statuses</option>
                        {statusOptions.map(s => <option key={s} value={s}>{s}</option>)}
                    </select>
                    <select value={typeFilter} onChange={e => setTypeFilter(e.target.value)}
                        className="bg-slate-700 border border-slate-600 rounded px-2 py-1 text-sm text-white">
                        <option value="all">All Types</option>
                        {typeOptions.map(t => <option key={t} value={t}>{t}</option>)}
                    </select>
                </div>

                {/* Job list */}
                <div className="space-y-2">
                    {filtered.length === 0 ? (
                        <div className="text-center py-8 text-slate-500">No jobs match the current filters.</div>
                    ) : filtered.map(job => {
                        const isExpanded = expandedId === job.id;
                        const instructions = job.instructions || '';
                        const isLong = instructions.length > 500;
                        const showFull = showFullInstructions[job.id];

                        return (
                            <div key={job.id}
                                className="bg-slate-800 border border-slate-700 rounded-lg overflow-hidden">
                                <button
                                    onClick={() => setExpandedId(isExpanded ? null : job.id)}
                                    className="w-full px-4 py-3 flex items-center gap-3 text-left hover:bg-slate-750 transition-colors"
                                >
                                    <span className="text-xs text-slate-500">{isExpanded ? 'â–¼' : 'â–¶'}</span>
                                    <div className="flex-1 min-w-0">
                                        <div className="flex items-center gap-2 flex-wrap">
                                            <span className="text-white font-medium truncate">
                                                {job.title || job.id}
                                            </span>
                                            {job.type && (
                                                <span className={`px-2 py-0.5 rounded text-xs font-medium ${JOB_TYPE_STYLES[job.type] || 'bg-slate-700 text-slate-300'}`}>
                                                    {job.type}
                                                </span>
                                            )}
                                            <span className={`px-2 py-0.5 rounded text-xs font-medium ${JOB_STATUS_STYLES[job.status] || 'bg-slate-700 text-slate-400'}`}>
                                                {job.status}
                                            </span>
                                        </div>
                                        <div className="flex items-center gap-3 mt-1 text-xs text-slate-400">
                                            <span>{resolveAppName(job.appId)}</span>
                                            {job.ideaId && <span>â€¢ {resolveIdeaName(job.ideaId)}</span>}
                                            {job.source && <span>â€¢ {job.source}</span>}
                                            {job.createdBy && <span>â€¢ by {job.createdBy}</span>}
                                            <span title={job.createdAt}>
                                                {formatTimeAgo(job.createdAt)}
                                            </span>
                                        </div>
                                    </div>
                                </button>

                                {isExpanded && (
                                    <div className="px-4 pb-4 border-t border-slate-700 pt-3 space-y-3">
                                        {instructions && (
                                            <div>
                                                <div className="text-xs text-slate-500 font-medium mb-1">Instructions</div>
                                                <div className="text-sm text-slate-300 whitespace-pre-wrap">
                                                    {isLong && !showFull ? instructions.substring(0, 500) + '...' : instructions}
                                                </div>
                                                {isLong && (
                                                    <button
                                                        onClick={(e) => { e.stopPropagation(); setShowFullInstructions(prev => ({...prev, [job.id]: !prev[job.id]})); }}
                                                        className="text-xs text-indigo-400 hover:text-indigo-300 mt-1"
                                                    >
                                                        {showFull ? 'Show less' : 'Show more'}
                                                    </button>
                                                )}
                                            </div>
                                        )}
                                        {job.summary && (
                                            <div>
                                                <div className="text-xs text-slate-500 font-medium mb-1">Summary</div>
                                                <div className="text-sm text-slate-300 whitespace-pre-wrap">{job.summary}</div>
                                            </div>
                                        )}
                                        {/* Completion stats */}
                                        {(job.filesChanged || job.linesChanged || job.testsRun) && (
                                            <div className="flex gap-4 text-xs">
                                                {job.filesChanged && (
                                                    <div className="text-slate-400">
                                                        <span className="text-white font-medium">{job.filesChanged}</span> files changed
                                                    </div>
                                                )}
                                                {job.linesChanged && (
                                                    <div className="text-slate-400">
                                                        <span className="text-white font-medium">{job.linesChanged}</span> lines
                                                    </div>
                                                )}
                                                {job.testsRun && (
                                                    <div className="text-slate-400">
                                                        <span className="text-white font-medium">{job.testsRun}</span> tests
                                                    </div>
                                                )}
                                            </div>
                                        )}
                                        {/* Attachments */}
                                        {job.attachments && (
                                            <div>
                                                <div className="text-xs text-slate-500 font-medium mb-1">
                                                    Attachments ({Array.isArray(job.attachments) ? job.attachments.length : Object.keys(job.attachments).length})
                                                </div>
                                                <div className="space-y-1">
                                                    {(Array.isArray(job.attachments) ? job.attachments : Object.values(job.attachments)).map((att, i) => (
                                                        <div key={i} className="flex items-center gap-2 text-xs text-slate-400">
                                                            <span>ðŸ“Ž</span>
                                                            <span>{att.name || att.filename || 'unnamed'}</span>
                                                            {att.content && <span className="text-slate-600">({att.content.length.toLocaleString()} chars)</span>}
                                                        </div>
                                                    ))}
                                                </div>
                                            </div>
                                        )}
                                        {/* Events timeline */}
                                        {job.events && Object.keys(job.events).length > 0 && (
                                            <div>
                                                <div className="text-xs text-slate-500 font-medium mb-1">Events ({Object.keys(job.events).length})</div>
                                                <div className="space-y-1 max-h-48 overflow-y-auto">
                                                    {Object.entries(job.events).sort(([,a],[,b]) => (a.timestamp || '').localeCompare(b.timestamp || '')).map(([eventId, evt]) => (
                                                        <div key={eventId} className="flex items-center gap-2 text-xs">
                                                            <span className="text-slate-500 shrink-0">{evt.timestamp ? formatTimeAgo(evt.timestamp) : 'â€”'}</span>
                                                            <span className="px-1.5 py-0.5 rounded bg-slate-700 text-slate-300 shrink-0">{evt.type || 'event'}</span>
                                                            <span className="text-slate-400 truncate">{evt.summary || evt.description || evt.message || eventId}</span>
                                                        </div>
                                                    ))}
                                                </div>
                                            </div>
                                        )}
                                        <div className="text-xs text-slate-600 pt-2 border-t border-slate-700/50">
                                            ID: {job.id} â€¢ Created: {job.createdAt || 'â€”'}
                                            {job.completedAt && ` â€¢ Completed: ${job.completedAt}`}
                                            {job.updatedAt && ` â€¢ Updated: ${job.updatedAt}`}
                                        </div>
                                    </div>
                                )}
                            </div>
                        );
                    })}
                </div>

                {/* v8.71.4: Load More â€” on-demand fetch of older jobs to avoid heavy persistent listener */}
                {hasMore && filtered.length > 0 && (
                    <div className="text-center pt-4">
                        <button
                            onClick={async () => {
                                setLoadingMore(true);
                                const oldest = allJobs.reduce((min, j) =>
                                    !min || (j.createdAt && j.createdAt < min) ? j.createdAt : min, null);
                                if (!oldest) { setHasMore(false); setLoadingMore(false); return; }
                                const more = await JobService.loadBefore(firebaseUid, oldest, 10);
                                if (more.length === 0) setHasMore(false);
                                else setOlderJobs(prev => {
                                    const ids = new Set(prev.map(j => j.id));
                                    return [...prev, ...more.filter(j => !ids.has(j.id))];
                                });
                                setLoadingMore(false);
                            }}
                            disabled={loadingMore}
                            className="px-4 py-2 text-sm bg-slate-700 hover:bg-slate-600 text-slate-300 rounded transition-colors"
                        >
                            {loadingMore ? 'â³ Loading...' : 'ðŸ“‚ Load older jobs'}
                        </button>
                    </div>
                )}
            </div>
        );
    }

    // =========================================================================
    // SETUP NEW APP VIEW (v8.7.7)
    // =========================================================================
    function SetupNewAppView({ apps, github, config, updateConfig, showAlert, showConfirm, onRefreshRepos, githubOwner, firebaseUid }) {
        const [step, setStep] = React.useState(1);
        const [appData, setAppData] = React.useState({
            name: '',
            id: '',
            description: '',
            structure: 'prod-only',  // 'prod-only' or 'test-prod'
            isPWA: false,
            appType: 'other',  // 'public', 'internal', 'other'
            project: '',  // v8.8.0: Project grouping
            icon: 'ðŸ“¦',
            hasAdmin: false,
            adminSubPath: 'admin',
            customDomain: ''
        });
        const [scopeData, setScopeData] = React.useState(null); // v8.23.0: Project scope
        const [skipScope, setSkipScope] = React.useState(false); // v8.23.0: Quick setup option
        const [showScopeInline, setShowScopeInline] = React.useState(false); // v8.23.0: Inline scope modal
        const [repoStatus, setRepoStatus] = React.useState({ checking: false, prodExists: null, testExists: null });
        const [creating, setCreating] = React.useState(false);
        const [creationLog, setCreationLog] = React.useState([]);
        const [promptGenerated, setPromptGenerated] = React.useState('');
        const [workItemsCreated, setWorkItemsCreated] = React.useState([]); // v8.28.0: Track created work items
        const [reviewData, setReviewData] = React.useState(null); // v8.28.0: Review summary for Step 5
        const [activeDocTab, setActiveDocTab] = React.useState('instructions'); // v8.29.0: Doc viewer tab

        const addLog = (msg, type = 'info') => setCreationLog(prev => [...prev, { msg, type, time: new Date().toLocaleTimeString() }]);

        // Auto-generate ID from name
        const handleNameChange = (name) => {
            const id = name.toLowerCase().replace(/[^a-z0-9]+/g, '-').replace(/-+$/, '');
            setAppData(prev => ({ ...prev, name, id }));
        };

        // Get repo names
        const prodRepoName = appData.id || 'my-app';
        const testRepoName = `${prodRepoName}-test`;

        // Step 1: Check repos
        const checkRepos = async () => {
            if (!github || !githubOwner) { await showAlert('Configure GitHub token first'); return; }
            setRepoStatus({ checking: true, prodExists: null, testExists: null });
            try {
                const prodExists = await github.repoExists(githubOwner, prodRepoName);
                let testExists = null;
                if (appData.structure === 'test-prod') {
                    testExists = await github.repoExists(githubOwner, testRepoName);
                }
                setRepoStatus({ checking: false, prodExists, testExists });
            } catch (e) {
                setRepoStatus({ checking: false, prodExists: null, testExists: null });
                await showAlert('Error checking repos: ' + e.message);
            }
        };

        // Step 2: Create repos + configure
        const setupApp = async () => {
            if (!github || !githubOwner) return;
            setCreating(true);
            setCreationLog([]);

            try {
                // Create prod repo if needed
                let prodFullName = `${githubOwner}/${prodRepoName}`;
                if (!repoStatus.prodExists) {
                    addLog(`Creating repository: ${prodRepoName}...`);
                    const result = await github.createRepo(prodRepoName, appData.description, false);
                    prodFullName = result.fullName;
                    addLog(`âœ… Repository created: ${prodFullName}`, 'success');

                    await new Promise(r => setTimeout(r, 2000));
                    addLog('Enabling GitHub Pages...');
                    try { await github.enablePages(prodFullName); addLog('âœ… GitHub Pages enabled', 'success'); }
                    catch (e) { addLog('âš ï¸ Pages may need manual enabling', 'warn'); }
                } else {
                    addLog(`âœ… Prod repo exists: ${prodFullName}`, 'success');
                }

                // Create test repo if needed
                let testFullName = '';
                if (appData.structure === 'test-prod') {
                    testFullName = `${githubOwner}/${testRepoName}`;
                    if (!repoStatus.testExists) {
                        addLog(`Creating test repository: ${testRepoName}...`);
                        const result = await github.createRepo(testRepoName, `${appData.description} (Test)`, false);
                        testFullName = result.fullName;
                        addLog(`âœ… Test repository created: ${testFullName}`, 'success');
                        await new Promise(r => setTimeout(r, 2000));
                        try { await github.enablePages(testFullName); addLog('âœ… Test Pages enabled', 'success'); }
                        catch (e) { addLog('âš ï¸ Test Pages may need manual enabling', 'warn'); }
                    } else {
                        addLog(`âœ… Test repo exists: ${testFullName}`, 'success');
                    }
                }

                // Seed initial index.html with meta tags for detection
                addLog('Seeding initial files...');
                const initialHTML = generateInitialHTML(appData);
                try {
                    // Check if index.html already exists
                    try {
                        await github.request(`/repos/${prodFullName}/contents/index.html`);
                        addLog('index.html already exists, skipping seed', 'info');
                    } catch {
                        await github.createOrUpdateFile(prodFullName, 'index.html', initialHTML, `Initial setup: ${appData.name}`);
                        addLog('âœ… Seeded index.html with app meta tags', 'success');
                    }
                } catch (e) {
                    addLog(`âš ï¸ Could not seed index.html: ${e.message}`, 'warn');
                }

                // Create admin directory if requested
                if (appData.hasAdmin) {
                    const adminHTML = generateAdminHTML(appData);
                    try {
                        try {
                            await github.request(`/repos/${prodFullName}/contents/${appData.adminSubPath}/index.html`);
                            addLog(`${appData.adminSubPath}/index.html already exists, skipping`, 'info');
                        } catch {
                            await github.createOrUpdateFile(prodFullName, `${appData.adminSubPath}/index.html`, adminHTML, `Initial setup: ${appData.name} Admin`);
                            addLog(`âœ… Seeded ${appData.adminSubPath}/index.html`, 'success');
                        }
                    } catch (e) {
                        addLog(`âš ï¸ Could not seed admin: ${e.message}`, 'warn');
                    }
                }

                // Add app to Command Center config
                addLog('Adding to Command Center configuration...');
                const newAppDef = {
                    id: appData.id,
                    name: appData.name,
                    icon: appData.icon,
                    appType: appData.appType,
                    project: appData.project || appData.id,  // v8.8.0: Use selected project or create new one from app id
                    targetPath: 'index.html',
                    swPath: appData.isPWA ? 'sw.js' : '',
                    hasServiceWorker: appData.isPWA,
                    subPath: '',
                    repos: appData.structure === 'test-prod'
                        ? { test: testFullName, prod: prodFullName }
                        : { prod: prodFullName },
                    versions: appData.structure === 'test-prod'
                        ? { test: '', prod: '' }
                        : { prod: '' },
                    repoPatterns: appData.structure === 'test-prod'
                        ? { test: [testRepoName], prod: [prodRepoName] }
                        : { prod: [prodRepoName] },
                    detectionPatterns: [`gs-app-id.*${appData.id}`, `<title>.*${appData.name}`]
                };

                // Also add admin as a separate app entry if requested
                const newConfig = { ...config, apps: { ...config.apps } };
                newConfig.apps[appData.id] = {
                    ...newAppDef,
                    repos: { ...newAppDef.repos }
                };

                if (appData.hasAdmin) {
                    newConfig.apps[`${appData.id}-admin`] = {
                        id: `${appData.id}-admin`,
                        name: `${appData.name} Admin`,
                        icon: appData.icon + 'ðŸ”§',
                        appType: appData.appType === 'public' ? 'internal' : appData.appType,
                        project: appData.project || appData.id,
                        targetPath: 'index.html',
                        swPath: '',
                        hasServiceWorker: false,
                        subPath: appData.adminSubPath,
                        repos: { prod: prodFullName },
                        versions: { prod: '' },
                        repoPatterns: { prod: [prodRepoName] },
                        detectionPatterns: [`gs-app-id.*${appData.id}-admin`]
                    };
                }

                updateConfig(newConfig);
                addLog('âœ… App added to Command Center', 'success');

                // v8.28.0: Store lifecycle metadata with scope if available
                if (scopeData) {
                    const lifecycleData = {
                        currentMaturity: 'seed',
                        complexity: scopeData.v1Features?.length > 5 ? 'medium' : 'simple',
                        scope: {
                            description: scopeData.description || '',
                            category: scopeData.category || '',
                            categoryAnswers: scopeData.categoryAnswers || {},
                            v1Features: scopeData.v1Features || [],
                            futureFeatures: scopeData.futureFeatures || [],
                            keyDecisions: scopeData.keyDecisions || [],
                            startingStandards: scopeData.startingStandards || [],
                            scopedAt: new Date().toISOString(),
                            source: 'manual'
                        }
                    };
                    // Update the config with lifecycle data on the app
                    const configWithLifecycle = { ...newConfig, apps: { ...newConfig.apps } };
                    configWithLifecycle.apps[appData.id] = {
                        ...configWithLifecycle.apps[appData.id],
                        lifecycle: lifecycleData
                    };
                    updateConfig(configWithLifecycle);
                    addLog('ðŸ“‹ Lifecycle metadata stored with project scope', 'success');
                }

                // v8.28.0: Auto-create work items from scope
                let createdItems = [];
                const ownerName = config?.ownerName || 'Owner';
                if (scopeData && firebaseUid) {
                    const itemsToCreate = [];
                    let nextNum = 1;
                    const padId = (n) => `WI-${String(n).padStart(3, '0')}`;

                    // V1 features â†’ work items (status: ready, source: scoped)
                    (scopeData.v1Features || []).forEach(f => {
                        itemsToCreate.push({
                            id: padId(nextNum++),
                            appId: appData.id,
                            title: f.title,
                            description: f.description || '',
                            type: 'feature',
                            priority: f.priority || 'core',
                            status: 'ready',
                            effort: f.effort || 'session',
                            source: 'scoped',
                            createdBy: ownerName,
                            tags: ['v1', scopeData.category || '']
                        });
                    });

                    // Future features â†’ work items (status: idea, source: scoped)
                    (scopeData.futureFeatures || []).forEach(f => {
                        itemsToCreate.push({
                            id: padId(nextNum++),
                            appId: appData.id,
                            title: f.title,
                            description: f.description || '',
                            type: 'feature',
                            priority: 'nice-to-have',
                            status: 'idea',
                            effort: f.effort || 'session',
                            source: 'scoped',
                            createdBy: ownerName,
                            tags: ['future']
                        });
                    });

                    // Key decisions â†’ work items (type: research, status: ready, source: scoped)
                    (scopeData.keyDecisions || []).filter(d => !d.resolved).forEach(d => {
                        itemsToCreate.push({
                            id: padId(nextNum++),
                            appId: appData.id,
                            title: d.title,
                            description: d.description || '',
                            type: 'research',
                            priority: 'core',
                            status: 'ready',
                            effort: 'quick',
                            source: 'scoped',
                            createdBy: ownerName,
                            tags: ['decision']
                        });
                    });

                    if (itemsToCreate.length > 0) {
                        try {
                            addLog(`Creating ${itemsToCreate.length} work items from scope...`);
                            createdItems = await WorkItemService.createBatch(firebaseUid, itemsToCreate);
                            addLog(`âœ… ${createdItems.length} work items created in backlog`, 'success');
                        } catch (e) {
                            addLog(`âš ï¸ Could not create work items: ${e.message}`, 'warn');
                        }
                    }
                } else if (scopeData && !firebaseUid) {
                    addLog('âš ï¸ Sign in to Firebase to auto-create work items from scope', 'warn');
                }
                setWorkItemsCreated(createdItems);

                if (onRefreshRepos) {
                    addLog('Refreshing repo list...');
                    await onRefreshRepos();
                    addLog('âœ… Repos refreshed', 'success');
                }

                // Generate Claude prompt (use CLAUDE_INSTRUCTIONS.md if scope available)
                let generatedPromptType = 'basic';
                let generatedInstructions = null;
                let generatedContextMd = null;
                let generatedProjectPlanMd = null;
                let generatedChangelogMd = null;
                let generatedReleaseNotes = null;
                
                if (scopeData) {
                    const instructions = generateClaudeInstructions(appData, scopeData, config);
                    if (instructions) {
                        generatedInstructions = instructions;
                        setPromptGenerated(instructions);
                        generatedPromptType = 'instructions';
                        addLog('ðŸŽ¯ Generated CLAUDE_INSTRUCTIONS.md from project scope', 'success');
                    } else {
                        const prompt = generateClaudePrompt(appData, prodFullName, testFullName);
                        setPromptGenerated(prompt);
                        addLog('âœ… Claude project prompt generated', 'success');
                    }
                    
                    // v8.29.0: Generate CONTEXT.md and PROJECT_PLAN.md
                    generatedContextMd = generateContextMd(appData, scopeData, config);
                    generatedProjectPlanMd = generateProjectPlanMd(appData, scopeData);
                    addLog('ðŸ“„ Generated CONTEXT.md and PROJECT_PLAN.md from scope', 'success');
                    
                    // Generate initial CHANGELOG.md and RELEASE_NOTES.txt
                    const today = new Date().toLocaleDateString();
                    generatedChangelogMd = `# ${appData.name} â€” Changelog\n\nAll notable changes to this project will be documented in this file.\n\n## [0.1.0] - ${today}\n\n### Added\n- Initial seed generated by Command Center\n- App shell with placeholder content\n`;
                    generatedReleaseNotes = `${appData.name} â€” Release Notes\n${'='.repeat(40)}\n\nv0.1.0 (${today})\n${'â”€'.repeat(30)}\n- Initial seed generated by Command Center\n- App shell with placeholder content\n`;
                    addLog('ðŸ“ Generated CHANGELOG.md and RELEASE_NOTES.txt', 'success');
                    
                } else {
                    const prompt = generateClaudePrompt(appData, prodFullName, testFullName);
                    setPromptGenerated(prompt);
                    addLog('âœ… Claude project prompt generated', 'success');
                }
                
                // v8.29.0: Commit generated docs to repo
                let docsCommitted = 0;
                if (scopeData && github) {
                    addLog('ðŸ“‚ Committing generated docs to repository...');
                    const docsToCommit = [];
                    
                    // Determine doc path based on subPath (consolidated vs standalone repo)
                    const docPrefix = appData.subPath ? `${appData.subPath}/docs/` : '';
                    
                    if (generatedPromptType === 'instructions' && generatedInstructions) {
                        docsToCommit.push({ path: `${docPrefix}CLAUDE_INSTRUCTIONS.md`, content: generatedInstructions });
                    }
                    if (generatedContextMd) docsToCommit.push({ path: `${docPrefix}CONTEXT.md`, content: generatedContextMd });
                    if (generatedProjectPlanMd) docsToCommit.push({ path: `${docPrefix}PROJECT_PLAN.md`, content: generatedProjectPlanMd });
                    if (generatedChangelogMd) docsToCommit.push({ path: `${docPrefix}CHANGELOG.md`, content: generatedChangelogMd });
                    if (generatedReleaseNotes) docsToCommit.push({ path: `${docPrefix}RELEASE_NOTES.txt`, content: generatedReleaseNotes });
                    
                    for (const doc of docsToCommit) {
                        try {
                            // Check if file already exists
                            try {
                                await github.request(`/repos/${prodFullName}/contents/${doc.path}`);
                                addLog(`  â­ï¸ ${doc.path} already exists, skipping`, 'info');
                            } catch {
                                await github.createOrUpdateFile(prodFullName, doc.path, doc.content, `Add ${doc.path.split('/').pop()} â€” generated by Command Center setup`);
                                docsCommitted++;
                                addLog(`  âœ… ${doc.path}`, 'success');
                            }
                        } catch (e) {
                            addLog(`  âš ï¸ Could not commit ${doc.path}: ${e.message}`, 'warn');
                        }
                    }
                    
                    if (docsCommitted > 0) {
                        addLog(`ðŸ“‚ ${docsCommitted} docs committed to ${prodFullName}`, 'success');
                    }
                }
                
                // v8.29.0: Auto-deploy seed to test environment
                let seedDeployedToTest = false;
                if (appData.structure === 'test-prod' && testFullName && github) {
                    addLog('ðŸš€ Auto-deploying seed to test environment...');
                    try {
                        // Check if test already has index.html
                        try {
                            await github.request(`/repos/${testFullName}/contents/${appData.subPath ? appData.subPath + '/' : ''}index.html`);
                            addLog('  â­ï¸ Test already has index.html, skipping seed deploy', 'info');
                        } catch {
                            const testPath = appData.subPath ? `${appData.subPath}/index.html` : 'index.html';
                            const initialHTML = generateInitialHTML(appData);
                            await github.createOrUpdateFile(testFullName, testPath, initialHTML, `Seed deploy: ${appData.name} v0.1.0`);
                            seedDeployedToTest = true;
                            addLog('âœ… Seed deployed to test environment', 'success');
                        }
                    } catch (e) {
                        addLog(`âš ï¸ Could not deploy seed to test: ${e.message}`, 'warn');
                    }
                }

                // v8.29.0: Build review summary (enhanced with doc generation info)
                setReviewData({
                    appName: appData.name,
                    appId: appData.id,
                    repos: {
                        prod: prodFullName,
                        test: appData.structure === 'test-prod' ? testFullName : null
                    },
                    hasScope: !!scopeData,
                    category: scopeData?.category ? (SCOPE_CATEGORIES[scopeData.category]?.icon + ' ' + SCOPE_CATEGORIES[scopeData.category]?.label) : null,
                    v1FeatureCount: scopeData?.v1Features?.length || 0,
                    futureFeatureCount: scopeData?.futureFeatures?.length || 0,
                    standardsCount: scopeData?.startingStandards?.length || 0,
                    workItemsCreated: createdItems.length,
                    promptType: generatedPromptType,
                    hasAdmin: appData.hasAdmin,
                    isPWA: appData.isPWA,
                    lifecycleStored: !!scopeData,
                    docsCommitted,
                    docsGenerated: scopeData ? ['CLAUDE_INSTRUCTIONS.md', 'CONTEXT.md', 'PROJECT_PLAN.md', 'CHANGELOG.md', 'RELEASE_NOTES.txt'] : [],
                    seedDeployedToTest,
                    generatedContextMd,
                    generatedProjectPlanMd,
                    generatedChangelogMd,
                    generatedReleaseNotes
                });

                addLog('ðŸŽ‰ Setup complete!', 'success');

            } catch (e) {
                addLog(`âŒ Error: ${e.message}`, 'error');
            } finally {
                setCreating(false);
            }
        };

        // Generate initial HTML with proper meta tags
        const SEED_VERSION = '0.1.0';  // Initial version for new apps â€” extracted as constant to avoid version scanner false positives
        function generateInitialHTML(app) {
            const pwaHead = app.isPWA ? `\n    <link rel="manifest" href="manifest.json">\n    <meta name="theme-color" content="#0f172a">\n    <link rel="apple-touch-icon" href="icons/icon-192.png">` : '';
            const pwaScript = app.isPWA ? `\n    <scr` + `ipt>\n    if ('serviceWorker' in navigator) {\n        navigator.serviceWorker.register('sw.js').catch(e => console.error('SW:', e));\n    }\n    </scr` + `ipt>` : '';

            return `<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>${app.name}</title>
    <meta name="version" content="${SEED_VERSION}">
    <meta name="gs-app-id" content="${app.id}">
    <meta name="description" content="${app.description}">${pwaHead}
    <style>
        body { margin:0; font-family:system-ui,-apple-system,sans-serif; background:#0f172a; color:#e2e8f0; display:flex; align-items:center; justify-content:center; min-height:100vh; }
        .container { text-align:center; max-width:500px; padding:40px; }
        h1 { font-size:2rem; margin-bottom:8px; }
        p { color:#94a3b8; }
    </style>
</head>
<body>
    <div class="container">
        <h1>${app.icon} ${app.name}</h1>
        <p>${app.description || 'Coming soon'}</p>
        <p style="font-size:0.8rem;color:#475569;margin-top:24px;">v${SEED_VERSION} Â· Part of the Game Shelf ecosystem</p>
    </div>${pwaScript}
</body>
</html>`;
        }

        function generateAdminHTML(app) {
            return `<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>${app.name} â€” Admin</title>
    <meta name="version" content="${SEED_VERSION}">
    <meta name="gs-app-id" content="${app.id}-admin">
    <style>
        body { margin:0; font-family:system-ui,-apple-system,sans-serif; background:#0f172a; color:#e2e8f0; display:flex; align-items:center; justify-content:center; min-height:100vh; }
        .container { text-align:center; max-width:500px; padding:40px; }
    </style>
</head>
<body>
    <div class="container">
        <h1>ðŸ”§ ${app.name} Admin</h1>
        <p style="color:#94a3b8;">Admin panel placeholder â€” replace with your admin tool</p>
        <p style="font-size:0.8rem;color:#475569;margin-top:24px;">v${SEED_VERSION}</p>
    </div>
</body>
</html>`;
        }

        // Generate the Claude project prompt
        function generateClaudePrompt(app, prodRepo, testRepo) {
            const isPWA = app.isPWA;
            const hasTest = app.structure === 'test-prod';
            const hasAdmin = app.hasAdmin;

            const deployFilesList = isPWA
                ? `- index.html (main app â€” single file, all CSS/JS inline)
- sw.js (service worker for offline support)
- manifest.json (PWA manifest with app name, icons, theme)
- icons/ folder (icon-192.png, icon-512.png, icon-maskable-192.png, icon-maskable-512.png, apple-touch-icon.png)
- RELEASE_NOTES.txt (optional changelog)`
                : `- index.html (main app â€” single file, all CSS/JS inline)
- RELEASE_NOTES.txt (optional changelog)`;

            const adminSection = hasAdmin ? `
## Admin Tool (${app.adminSubPath}/)
- Located at ${app.adminSubPath}/index.html in the same repo
- Has its own gs-app-id: "${app.id}-admin"
- Has its own version meta tag
- Deployed separately via Command Center
` : '';

            const testSection = hasTest ? `
## Test â†’ Prod Workflow
- Test repo: ${testRepo} (deployed at https://${githubOwner}.github.io/${testRepoName}/)
- Prod repo: ${prodRepo} (deployed at https://${githubOwner}.github.io/${prodRepoName}/)
- Always deploy to test first, verify, then promote to prod via Command Center
` : `
## Deployment
- Single prod repo: ${prodRepo}
- Deployed at: https://${githubOwner}.github.io/${prodRepoName}/
${app.customDomain ? `- Custom domain: ${app.customDomain}` : ''}
`;

            return `# ${app.name} â€” Project Brief

## Overview
${app.description || app.name + ' is a web application.'}

## Technical Requirements

### App Identity (Required for Command Center)
Every HTML file must include these meta tags in <head>:
\`\`\`html
<meta name="version" content="X.Y.Z">
<meta name="gs-app-id" content="${app.id}">
\`\`\`
Version must follow semver (e.g., 1.0.0). Bump on every deploy.

### Architecture
- **Single-file HTML app**: All CSS and JS must be inline in index.html (no external files except CDN libraries)
- **Dark mode by default**: Background #0f172a or similar dark theme
- **Mobile-first responsive design**
${isPWA ? '- **Progressive Web App**: Must include service worker, manifest.json, and app icons' : '- **Standard web app**: No service worker needed'}
- **Firebase integration**: Uses the shared Game Shelf Firebase project (word-boxing-default-rtdb)

### Firebase Config
\`\`\`javascript
const firebaseConfig = {
    apiKey: "AIzaSyBQVwn8vOrFTzLlm2MYIPBwgZV2xR9AuhM",
    authDomain: "word-boxing.firebaseapp.com",
    databaseURL: "https://word-boxing-default-rtdb.firebaseio.com",
    projectId: "word-boxing"
};
\`\`\`
${testSection}
### Deploy Package Structure
The Command Center deploys these files to GitHub Pages:
${deployFilesList}
${adminSection}
### Version Management
- Use \`<meta name="version" content="X.Y.Z">\` in the HTML head
- Command Center reads this to track deployed versions
- Bump the patch version for bug fixes, minor for features, major for breaking changes

## Project Plan

### Phase 1: Foundation
- [ ] Basic UI with app branding and layout
- [ ] Firebase integration (auth if needed, database read/write)
- [ ] Core feature implementation
- [ ] Mobile responsive design

### Phase 2: Polish
- [ ] Error handling and edge cases
- [ ] Loading states and transitions
- [ ] Accessibility basics (semantic HTML, keyboard nav)
${isPWA ? '- [ ] Service worker for offline support\n- [ ] PWA manifest and icons' : ''}

### Phase 3: Launch
- [ ] Test deployment via Command Center
- [ ] Version tracking verified
- [ ] Performance optimization
${hasAdmin ? '- [ ] Admin tool deployment' : ''}

## Current Status
- Version: 0.1.0 (placeholder)
- Status: Initial setup complete
- Repo: ${prodRepo}
${hasTest ? `- Test repo: ${testRepo}` : ''}

## Session Continuity
When starting a new session, provide this document plus any updates to the project plan.
The developer uses Claude for iterative development â€” each session should:
1. Review this brief and any RELEASE_NOTES.txt
2. Understand what was built previously
3. Continue from where the last session left off
4. Produce deploy-ready files (single HTML with inline CSS/JS)
5. Include updated version meta tags
`;
        }

        // =================== RENDER ===================
        return (
            <div className="max-w-3xl mx-auto">
                <div className="flex items-center gap-3 mb-6">
                    <span className="text-3xl">ðŸ†•</span>
                    <div>
                        <h1 className="text-2xl font-bold">Setup New App</h1>
                        <p className="text-slate-400 text-sm">Create repos, configure Command Center, and generate a Claude project brief</p>
                    </div>
                </div>

                {/* Progress */}
                <div className="flex items-center gap-2 mb-8">
                    {[
                        { n: 1, label: 'Define' },
                        { n: 2, label: 'Scope' },
                        { n: 3, label: 'Check Repos' },
                        { n: 4, label: 'Create & Configure' },
                        { n: 5, label: 'Review & Launch' }
                    ].map(s => (
                        <React.Fragment key={s.n}>
                            <div className={`flex items-center gap-2 px-3 py-1.5 rounded-lg text-sm font-medium ${
                                step === s.n ? 'bg-indigo-600 text-white' : step > s.n ? 'bg-green-600/20 text-green-400' : 'bg-slate-800 text-slate-500'
                            }`}>
                                {step > s.n ? 'âœ“' : s.n} {s.label}
                            </div>
                            {s.n < 5 && <div className={`flex-1 h-px ${step > s.n ? 'bg-green-600' : 'bg-slate-700'}`} />}
                        </React.Fragment>
                    ))}
                </div>

                {/* Step 1: Define App */}
                {step === 1 && (
                    <div className="bg-slate-800 rounded-xl p-6 border border-slate-700">
                        <h2 className="text-lg font-semibold mb-4">ðŸ“ Define Your App</h2>
                        <div className="space-y-4">
                            <div>
                                <label className="block text-sm text-slate-400 mb-1">App Name <span className="text-red-400">*</span></label>
                                <input value={appData.name} onChange={e => handleNameChange(e.target.value)}
                                    className="w-full px-3 py-2 bg-slate-900 border border-slate-600 rounded-lg text-white focus:border-indigo-500 focus:outline-none"
                                    placeholder="My Awesome App" />
                            </div>
                            <div className="grid grid-cols-2 gap-4">
                                <div>
                                    <label className="block text-sm text-slate-400 mb-1">App ID (auto-generated)</label>
                                    <input value={appData.id} onChange={e => setAppData(prev => ({ ...prev, id: e.target.value }))}
                                        className="w-full px-3 py-2 bg-slate-900 border border-slate-600 rounded-lg text-white font-mono text-sm focus:border-indigo-500 focus:outline-none" />
                                </div>
                                <div>
                                    <label className="block text-sm text-slate-400 mb-1">Icon (emoji)</label>
                                    <input value={appData.icon} onChange={e => setAppData(prev => ({ ...prev, icon: e.target.value }))}
                                        className="w-full px-3 py-2 bg-slate-900 border border-slate-600 rounded-lg text-white text-center text-2xl focus:border-indigo-500 focus:outline-none" />
                                </div>
                            </div>
                            <div>
                                <label className="block text-sm text-slate-400 mb-1">Description</label>
                                <textarea value={appData.description} onChange={e => setAppData(prev => ({ ...prev, description: e.target.value }))}
                                    className="w-full px-3 py-2 bg-slate-900 border border-slate-600 rounded-lg text-white focus:border-indigo-500 focus:outline-none resize-none"
                                    rows={2} placeholder="Brief description of what this app does" />
                            </div>
                            <div className="grid grid-cols-2 gap-4">
                                <div>
                                    <label className="block text-sm text-slate-400 mb-2">Deploy Structure</label>
                                    <div className="space-y-2">
                                        {[['prod-only', 'ðŸš€ Prod Only', 'Single repo, deploy directly'],
                                          ['test-prod', 'ðŸ§ªâ†’ðŸš€ Test â†’ Prod', 'Two repos, promote test to prod']
                                        ].map(([val, label, desc]) => (
                                            <label key={val} className={`flex items-start gap-3 p-3 rounded-lg border cursor-pointer ${
                                                appData.structure === val ? 'border-indigo-500 bg-indigo-500/10' : 'border-slate-600 hover:border-slate-500'
                                            }`}>
                                                <input type="radio" name="structure" value={val} checked={appData.structure === val}
                                                    onChange={e => setAppData(prev => ({ ...prev, structure: e.target.value }))} className="mt-1" />
                                                <div><div className="text-sm font-medium">{label}</div><div className="text-xs text-slate-500">{desc}</div></div>
                                            </label>
                                        ))}
                                    </div>
                                </div>
                                <div>
                                    <label className="block text-sm text-slate-400 mb-2">App Category</label>
                                    <select value={appData.appType} onChange={e => setAppData(prev => ({ ...prev, appType: e.target.value }))}
                                        className="w-full px-3 py-2 bg-slate-900 border border-slate-600 rounded-lg text-white focus:border-indigo-500 focus:outline-none mb-3">
                                        <option value="public">Public App</option>
                                        <option value="internal">Internal Tool</option>
                                        <option value="other">Other Project</option>
                                    </select>
                                    <label className="block text-sm text-slate-400 mb-2">Project</label>
                                    <select value={appData.project} onChange={e => setAppData(prev => ({ ...prev, project: e.target.value }))}
                                        className="w-full px-3 py-2 bg-slate-900 border border-slate-600 rounded-lg text-white focus:border-indigo-500 focus:outline-none mb-3">
                                        <option value="">â€” Select a project â€”</option>
                                        {Object.values(config.projects || SEED_PROJECTS).filter(p => p.id !== 'other').sort((a, b) => (a.order || 99) - (b.order || 99)).map(p => (
                                            <option key={p.id} value={p.id}>{p.icon === 'cc-logo' ? 'â¬¡' : p.icon} {p.name}</option>
                                        ))}
                                        <option value="other">Other</option>
                                    </select>
                                    <label className="flex items-center gap-3 p-3 rounded-lg border border-slate-600 cursor-pointer hover:border-slate-500">
                                        <input type="checkbox" checked={appData.isPWA} onChange={e => setAppData(prev => ({ ...prev, isPWA: e.target.checked }))} />
                                        <div><div className="text-sm font-medium">ðŸ“± Progressive Web App</div><div className="text-xs text-slate-500">SW, manifest, icons</div></div>
                                    </label>
                                </div>
                            </div>
                            <div className="grid grid-cols-2 gap-4">
                                <label className="flex items-center gap-3 p-3 rounded-lg border border-slate-600 cursor-pointer hover:border-slate-500">
                                    <input type="checkbox" checked={appData.hasAdmin} onChange={e => setAppData(prev => ({ ...prev, hasAdmin: e.target.checked }))} />
                                    <div><div className="text-sm font-medium">ðŸ”§ Admin Panel</div><div className="text-xs text-slate-500">Separate page in subdirectory</div></div>
                                </label>
                                {appData.hasAdmin && (
                                    <div>
                                        <label className="block text-sm text-slate-400 mb-1">Admin Path</label>
                                        <input value={appData.adminSubPath} onChange={e => setAppData(prev => ({ ...prev, adminSubPath: e.target.value }))}
                                            className="w-full px-3 py-2 bg-slate-900 border border-slate-600 rounded-lg text-white font-mono text-sm focus:border-indigo-500 focus:outline-none"
                                            placeholder="admin" />
                                    </div>
                                )}
                            </div>
                            <div>
                                <label className="block text-sm text-slate-400 mb-1">Custom Domain (optional)</label>
                                <input value={appData.customDomain} onChange={e => setAppData(prev => ({ ...prev, customDomain: e.target.value }))}
                                    className="w-full px-3 py-2 bg-slate-900 border border-slate-600 rounded-lg text-white focus:border-indigo-500 focus:outline-none"
                                    placeholder="myapp.com" />
                            </div>
                        </div>

                        {/* Preview */}
                        {appData.name && (
                            <div className="mt-6 p-4 bg-slate-900 rounded-lg border border-slate-700">
                                <div className="text-xs text-slate-500 uppercase tracking-wide mb-2">Preview</div>
                                <div className="flex items-center gap-2 mb-2">
                                    <span className="text-xl">{appData.icon}</span>
                                    <span className="font-semibold">{appData.name}</span>
                                    <span className="text-xs px-2 py-0.5 bg-slate-700 rounded">{appData.appType}</span>
                                    {appData.isPWA && <span className="text-xs px-2 py-0.5 bg-purple-600/30 text-purple-300 rounded">PWA</span>}
                                </div>
                                <div className="text-sm text-slate-400 space-y-1">
                                    <div>Prod repo: <code className="text-indigo-400">{githubOwner}/{prodRepoName}</code></div>
                                    {appData.structure === 'test-prod' && <div>Test repo: <code className="text-yellow-400">{githubOwner}/{testRepoName}</code></div>}
                                    {appData.hasAdmin && <div>Admin path: <code className="text-green-400">/{appData.adminSubPath}/index.html</code></div>}
                                    {appData.customDomain && <div>Domain: <code className="text-cyan-400">{appData.customDomain}</code></div>}
                                    <div>gs-app-id: <code className="text-slate-300">{appData.id}</code></div>
                                </div>
                            </div>
                        )}

                        <div className="mt-6 flex justify-end">
                            <button onClick={() => { if (!appData.name) return; setStep(2); }}
                                disabled={!appData.name}
                                className="px-6 py-2 bg-indigo-600 hover:bg-indigo-500 disabled:bg-slate-700 disabled:text-slate-500 rounded-lg font-medium transition-colors">
                                Next: Scope â†’
                            </button>
                        </div>
                    </div>
                )}

                {/* Step 2: Scope (v8.23.0) */}
                {step === 2 && (
                    <div className="bg-slate-800 rounded-xl p-6 border border-slate-700">
                        <h2 className="text-lg font-semibold mb-4">ðŸŽ¯ Project Scope</h2>
                        <p className="text-sm text-slate-400 mb-4">
                            Define what this app does and how it should be built. This generates work items and starting standards for Claude.
                        </p>
                        
                        {!skipScope && !scopeData ? (
                            <div className="space-y-4">
                                <button onClick={() => {
                                        // Create a temporary app object for the scope modal
                                        const tempApp = { id: appData.id, name: appData.name, icon: appData.icon, lifecycle: {} };
                                        // Open inline scope flow
                                        setShowScopeInline(true);
                                    }}
                                    className="w-full p-6 bg-indigo-600/10 border-2 border-dashed border-indigo-500/50 rounded-xl hover:bg-indigo-600/20 transition-colors text-center">
                                    <div className="text-3xl mb-2">ðŸŽ¯</div>
                                    <div className="font-medium">Start Scoping Flow</div>
                                    <div className="text-xs text-slate-400 mt-1">Category-driven questions â†’ features â†’ standards (~2 min)</div>
                                </button>
                                <button onClick={() => { setSkipScope(true); }}
                                    className="w-full p-3 text-slate-400 hover:text-white text-sm transition-colors">
                                    Skip scope â€” I'll add details later
                                </button>
                            </div>
                        ) : scopeData ? (
                            <div className="space-y-3">
                                <div className="bg-green-900/20 border border-green-700/50 rounded-lg p-4">
                                    <div className="flex items-center gap-2 mb-2">
                                        <span className="text-green-400">âœ…</span>
                                        <span className="font-medium text-green-300">Scope captured</span>
                                    </div>
                                    <div className="text-sm text-slate-300 grid grid-cols-3 gap-3">
                                        <div><span className="text-slate-500">Category:</span> {SCOPE_CATEGORIES[scopeData.category]?.icon} {SCOPE_CATEGORIES[scopeData.category]?.label}</div>
                                        <div><span className="text-slate-500">Features:</span> {scopeData.v1Features?.length || 0} V1</div>
                                        <div><span className="text-slate-500">Standards:</span> {scopeData.startingStandards?.length || 0}</div>
                                    </div>
                                </div>
                                <button onClick={() => { setScopeData(null); setSkipScope(false); }}
                                    className="text-xs text-slate-400 hover:text-white">Edit scope</button>
                            </div>
                        ) : (
                            <div className="bg-slate-700/30 rounded-lg p-4 text-center text-sm text-slate-400">
                                <p>Scope skipped â€” you can add one later from the Backlog view.</p>
                                <button onClick={() => setSkipScope(false)} className="mt-2 text-xs text-indigo-400 hover:text-indigo-300">
                                    Actually, let me scope this
                                </button>
                            </div>
                        )}
                        
                        <div className="mt-6 flex justify-between">
                            <button onClick={() => setStep(1)} className="px-4 py-2 text-slate-400 hover:text-white transition-colors">â† Back</button>
                            <button onClick={() => { setStep(3); checkRepos(); }}
                                disabled={!skipScope && !scopeData}
                                className="px-6 py-2 bg-indigo-600 hover:bg-indigo-500 disabled:bg-slate-700 disabled:text-slate-500 rounded-lg font-medium transition-colors">
                                Next: Check Repos â†’
                            </button>
                        </div>
                        
                        {/* Inline Scope Modal */}
                        {showScopeInline && (
                            <ProjectScopeModal
                                app={{ id: appData.id, name: appData.name, icon: appData.icon, lifecycle: {} }}
                                apps={apps}
                                onSave={(scope) => { setScopeData(scope); setShowScopeInline(false); }}
                                onCancel={() => setShowScopeInline(false)}
                                showAlert={showAlert}
                                config={config}
                            />
                        )}
                    </div>
                )}

                {/* Step 3: Repo Check */}
                {step === 3 && (
                    <div className="bg-slate-800 rounded-xl p-6 border border-slate-700">
                        <h2 className="text-lg font-semibold mb-4">ðŸ” Repository Check</h2>
                        {repoStatus.checking ? (
                            <div className="text-center py-8 text-slate-400"><span className="animate-spin inline-block mr-2">â³</span> Checking repositories...</div>
                        ) : (
                            <div className="space-y-3">
                                <div className={`p-4 rounded-lg border ${repoStatus.prodExists ? 'border-yellow-600 bg-yellow-600/10' : 'border-green-600 bg-green-600/10'}`}>
                                    <div className="flex items-center gap-2">
                                        <span>{repoStatus.prodExists ? 'ðŸ“‚' : 'âœ¨'}</span>
                                        <span className="font-medium">{githubOwner}/{prodRepoName}</span>
                                        <span className={`text-xs px-2 py-0.5 rounded ${repoStatus.prodExists ? 'bg-yellow-600/30 text-yellow-300' : 'bg-green-600/30 text-green-300'}`}>
                                            {repoStatus.prodExists ? 'Already exists â€” will assign' : 'Will create'}
                                        </span>
                                    </div>
                                </div>
                                {appData.structure === 'test-prod' && (
                                    <div className={`p-4 rounded-lg border ${repoStatus.testExists ? 'border-yellow-600 bg-yellow-600/10' : 'border-green-600 bg-green-600/10'}`}>
                                        <div className="flex items-center gap-2">
                                            <span>{repoStatus.testExists ? 'ðŸ“‚' : 'âœ¨'}</span>
                                            <span className="font-medium">{githubOwner}/{testRepoName}</span>
                                            <span className={`text-xs px-2 py-0.5 rounded ${repoStatus.testExists ? 'bg-yellow-600/30 text-yellow-300' : 'bg-green-600/30 text-green-300'}`}>
                                                {repoStatus.testExists ? 'Already exists â€” will assign' : 'Will create'}
                                            </span>
                                        </div>
                                    </div>
                                )}
                            </div>
                        )}
                        <div className="mt-6 flex justify-between">
                            <button onClick={() => setStep(2)} className="px-4 py-2 text-slate-400 hover:text-white transition-colors">â† Back</button>
                            <button onClick={() => setStep(4)} disabled={repoStatus.checking}
                                className="px-6 py-2 bg-indigo-600 hover:bg-indigo-500 disabled:bg-slate-700 rounded-lg font-medium transition-colors">
                                Next: Create & Configure â†’
                            </button>
                        </div>
                    </div>
                )}

                {/* Step 4: Create & Configure */}
                {step === 4 && (
                    <div className="bg-slate-800 rounded-xl p-6 border border-slate-700">
                        <h2 className="text-lg font-semibold mb-4">âš¡ Create & Configure</h2>
                        {creationLog.length === 0 && !creating ? (
                            <div>
                                <p className="text-slate-400 mb-4">Ready to set up <strong className="text-white">{appData.name}</strong>. This will:</p>
                                <ul className="space-y-2 text-sm text-slate-300 mb-6">
                                    {!repoStatus.prodExists && <li>âœ¨ Create <code className="text-indigo-400">{prodRepoName}</code> repository</li>}
                                    {appData.structure === 'test-prod' && !repoStatus.testExists && <li>âœ¨ Create <code className="text-yellow-400">{testRepoName}</code> repository</li>}
                                    <li>ðŸ“„ Seed index.html with app meta tags (version + gs-app-id)</li>
                                    {appData.hasAdmin && <li>ðŸ”§ Seed {appData.adminSubPath}/index.html</li>}
                                    <li>âš™ï¸ Add app to Command Center configuration</li>
                                    <li>ðŸŒ Enable GitHub Pages</li>
                                    <li>ðŸ¤– Generate Claude project prompt</li>
                                </ul>
                                <div className="flex justify-between">
                                    <button onClick={() => setStep(2)} className="px-4 py-2 text-slate-400 hover:text-white transition-colors">â† Back</button>
                                    <button onClick={setupApp} className="px-6 py-2 bg-green-600 hover:bg-green-500 rounded-lg font-medium transition-colors">
                                        ðŸš€ Set Up Everything
                                    </button>
                                </div>
                            </div>
                        ) : (
                            <div>
                                <div className="bg-slate-900 rounded-lg p-4 max-h-64 overflow-y-auto space-y-1 font-mono text-sm">
                                    {creationLog.map((log, i) => (
                                        <div key={i} className={`${
                                            log.type === 'success' ? 'text-green-400' : log.type === 'error' ? 'text-red-400' : log.type === 'warn' ? 'text-yellow-400' : 'text-slate-400'
                                        }`}>
                                            <span className="text-slate-600 mr-2">{log.time}</span>{log.msg}
                                        </div>
                                    ))}
                                    {creating && <div className="text-slate-500"><span className="animate-spin inline-block">â³</span> Working...</div>}
                                </div>
                                {!creating && promptGenerated && (
                                    <div className="mt-4 flex justify-end">
                                        <button onClick={() => setStep(5)} className="px-6 py-2 bg-indigo-600 hover:bg-indigo-500 rounded-lg font-medium transition-colors">
                                            View Claude Prompt â†’
                                        </button>
                                    </div>
                                )}
                            </div>
                        )}
                    </div>
                )}

                {/* Step 5: Review & Launch (v8.29.0 â€” Phase 3.2 enhanced) */}
                {step === 5 && (
                    <div className="bg-slate-800 rounded-xl p-6 border border-slate-700 space-y-6">
                        <div>
                            <h2 className="text-lg font-semibold mb-1">ðŸš€ Review & Launch</h2>
                            <p className="text-slate-400 text-sm">Everything has been set up. Review what was created and grab your Claude instructions.</p>
                        </div>

                        {/* Setup Summary */}
                        {reviewData && (
                            <div className="grid grid-cols-2 gap-3">
                                <div className="bg-slate-900/60 rounded-lg p-3 border border-slate-700">
                                    <div className="text-xs text-slate-500 uppercase tracking-wide mb-1">App</div>
                                    <div className="font-medium">{appData.icon} {reviewData.appName}</div>
                                    <div className="text-xs text-slate-400 mt-1 font-mono">{reviewData.appId}</div>
                                </div>
                                <div className="bg-slate-900/60 rounded-lg p-3 border border-slate-700">
                                    <div className="text-xs text-slate-500 uppercase tracking-wide mb-1">Repositories</div>
                                    <div className="text-sm font-mono text-slate-300 truncate">{reviewData.repos?.prod}</div>
                                    {reviewData.repos?.test && <div className="text-xs font-mono text-slate-400 mt-1 truncate">{reviewData.repos.test}</div>}
                                </div>
                                {reviewData.hasScope && (
                                    <div className="bg-slate-900/60 rounded-lg p-3 border border-slate-700">
                                        <div className="text-xs text-slate-500 uppercase tracking-wide mb-1">Scope</div>
                                        <div className="text-sm">{reviewData.category || 'Scoped'}</div>
                                        <div className="text-xs text-slate-400 mt-1">
                                            {reviewData.v1FeatureCount} V1 features Â· {reviewData.standardsCount} standards
                                        </div>
                                    </div>
                                )}
                                <div className="bg-slate-900/60 rounded-lg p-3 border border-slate-700">
                                    <div className="text-xs text-slate-500 uppercase tracking-wide mb-1">Generated Artifacts</div>
                                    <div className="text-sm space-y-0.5">
                                        {reviewData.workItemsCreated > 0 && (
                                            <div className="text-green-400">âœ… {reviewData.workItemsCreated} work items</div>
                                        )}
                                        {reviewData.docsGenerated?.length > 0 && (
                                            <div className="text-green-400">âœ… {reviewData.docsGenerated.length} docs generated</div>
                                        )}
                                        {reviewData.docsCommitted > 0 && (
                                            <div className="text-green-400">ðŸ“‚ {reviewData.docsCommitted} committed to repo</div>
                                        )}
                                        {reviewData.seedDeployedToTest && (
                                            <div className="text-green-400">ðŸš€ Seed deployed to test</div>
                                        )}
                                        {reviewData.isPWA && <span className="text-xs text-slate-500">PWA</span>}
                                        {reviewData.hasAdmin && <span className="text-xs text-slate-500 ml-1">Admin</span>}
                                    </div>
                                </div>
                            </div>
                        )}

                        {/* Work Items Summary */}
                        {workItemsCreated.length > 0 && (
                            <div className="bg-slate-900/40 rounded-lg p-4 border border-slate-700">
                                <div className="flex items-center justify-between mb-3">
                                    <h3 className="text-sm font-semibold">ðŸ“‹ Work Items Created</h3>
                                    <span className="text-xs text-slate-500">{workItemsCreated.length} items in backlog</span>
                                </div>
                                <div className="space-y-1 max-h-40 overflow-y-auto">
                                    {workItemsCreated.map((wi, i) => (
                                        <div key={i} className="flex items-center gap-2 text-sm py-1">
                                            <span className={`text-xs px-1.5 py-0.5 rounded font-mono ${
                                                wi.status === 'ready' ? 'bg-blue-600/20 text-blue-400' : 'bg-slate-700 text-slate-400'
                                            }`}>{wi.status}</span>
                                            <span className={`text-xs px-1.5 py-0.5 rounded ${
                                                wi.type === 'feature' ? 'bg-purple-600/20 text-purple-400' : 'bg-amber-600/20 text-amber-400'
                                            }`}>{wi.type}</span>
                                            <span className="text-slate-300 truncate">{wi.title}</span>
                                            <span className={`text-xs ml-auto ${
                                                wi.priority === 'core' ? 'text-red-400' : 'text-slate-500'
                                            }`}>{wi.priority}</span>
                                        </div>
                                    ))}
                                </div>
                            </div>
                        )}

                        {/* Generated Docs Viewer (v8.29.0) */}
                        {reviewData?.docsGenerated?.length > 0 && (() => {
                            const docTabs = [
                                { id: 'instructions', label: 'CLAUDE_INSTRUCTIONS', content: promptGenerated },
                                { id: 'context', label: 'CONTEXT.md', content: reviewData.generatedContextMd },
                                { id: 'plan', label: 'PROJECT_PLAN.md', content: reviewData.generatedProjectPlanMd },
                                { id: 'changelog', label: 'CHANGELOG.md', content: reviewData.generatedChangelogMd },
                                { id: 'release', label: 'RELEASE_NOTES.txt', content: reviewData.generatedReleaseNotes }
                            ].filter(t => t.content);
                            const activeContent = docTabs.find(t => t.id === activeDocTab)?.content || docTabs[0]?.content || '';
                            const activeLabel = docTabs.find(t => t.id === activeDocTab)?.label || docTabs[0]?.label || '';
                            
                            return (
                                <div>
                                    <div className="flex items-center justify-between mb-2">
                                        <h3 className="text-sm font-semibold">ðŸ“„ Generated Project Docs</h3>
                                        <button onClick={() => { navigator.clipboard.writeText(activeContent); showAlert(`Copied ${activeLabel} to clipboard!`, 'Copied'); }}
                                            className="px-3 py-1.5 bg-indigo-600 hover:bg-indigo-500 rounded text-sm font-medium transition-colors">
                                            ðŸ“‹ Copy {activeLabel}
                                        </button>
                                    </div>
                                    <p className="text-slate-400 text-xs mb-2">
                                        {reviewData.docsCommitted > 0 
                                            ? `These docs have been committed to your repo. They'll be included in Claude Prep packages.`
                                            : `These docs were generated but not committed (no GitHub access). Copy and add to your repo manually.`
                                        }
                                    </p>
                                    <div className="flex gap-1 mb-2 overflow-x-auto">
                                        {docTabs.map(tab => (
                                            <button key={tab.id}
                                                onClick={() => setActiveDocTab(tab.id)}
                                                className={`px-2 py-1 rounded text-xs font-medium whitespace-nowrap transition-colors ${
                                                    activeDocTab === tab.id 
                                                        ? 'bg-indigo-600 text-white' 
                                                        : 'bg-slate-700 text-slate-400 hover:text-white'
                                                }`}>
                                                {tab.label}
                                            </button>
                                        ))}
                                    </div>
                                    <pre className="bg-slate-900 rounded-lg p-4 text-sm text-slate-300 max-h-64 overflow-y-auto whitespace-pre-wrap border border-slate-700">
                                        {activeContent}
                                    </pre>
                                </div>
                            );
                        })()}

                        {/* Fallback: Simple prompt viewer if no docs generated */}
                        {(!reviewData?.docsGenerated?.length && promptGenerated) && (
                            <div>
                                <div className="flex items-center justify-between mb-2">
                                    <h3 className="text-sm font-semibold">
                                        ðŸ¤– {reviewData?.promptType === 'instructions' ? 'CLAUDE_INSTRUCTIONS.md' : 'Claude Project Prompt'}
                                    </h3>
                                    <button onClick={() => { navigator.clipboard.writeText(promptGenerated); showAlert('Copied to clipboard!', 'Copied'); }}
                                        className="px-3 py-1.5 bg-indigo-600 hover:bg-indigo-500 rounded text-sm font-medium transition-colors">
                                        ðŸ“‹ Copy
                                    </button>
                                </div>
                                <p className="text-slate-400 text-xs mb-2">Copy this into a Claude Project or use as a session starter.</p>
                                <pre className="bg-slate-900 rounded-lg p-4 text-sm text-slate-300 max-h-64 overflow-y-auto whitespace-pre-wrap border border-slate-700">
                                    {promptGenerated}
                                </pre>
                            </div>
                        )}

                        {/* Actions */}
                        <div className="flex justify-between items-center pt-2 border-t border-slate-700">
                            <button onClick={() => { setStep(1); setAppData({ name:'',id:'',description:'',structure:'prod-only',isPWA:false,appType:'other',project:'',icon:'ðŸ“¦',hasAdmin:false,adminSubPath:'admin',customDomain:'' }); setScopeData(null); setSkipScope(false); setCreationLog([]); setPromptGenerated(''); setRepoStatus({checking:false,prodExists:null,testExists:null}); setWorkItemsCreated([]); setReviewData(null); setActiveDocTab('instructions'); }}
                                className="px-4 py-2 text-slate-400 hover:text-white transition-colors">
                                ðŸ†• Setup Another App
                            </button>
                            <div className="text-green-400 text-sm font-medium">âœ… Setup Complete</div>
                        </div>
                    </div>
                )}
            </div>
        );
    }

    // =========================================================================
    // FIREBASE ADMIN SETTINGS (v8.9.0)
    // =========================================================================
    
    // =========================================================================
    // DOMAIN REGISTRAR SETTINGS (v8.35.0)
    // =========================================================================
    
    
    function ProviderConfigPanel({ provider }) {
        const [config, setConfig] = React.useState(provider.service.getConfig());
        const [showKeys, setShowKeys] = React.useState(false);
        const [testing, setTesting] = React.useState(false);
        const [testResult, setTestResult] = React.useState(null);
        const [domains, setDomains] = React.useState(null);
        const [loadingDomains, setLoadingDomains] = React.useState(false);
        
        const updateConfig = (field, value) => {
            const updated = { ...config, [field]: value };
            setConfig(updated);
            provider.service.saveConfig(updated);
        };
        
        const handleTest = async () => {
            setTesting(true);
            setTestResult(null);
            try {
                const result = await provider.service.ping();
                const msg = result.yourIp && result.yourIp !== 'N/A' 
                    ? `Connected! Your IP: ${result.yourIp}`
                    : `Connected! ${result.domainCount !== undefined ? `${result.domainCount}+ domains found` : 'API responding'}`;
                setTestResult({ ok: true, msg });
                await handleFetchDomains();
            } catch (e) {
                setTestResult({ ok: false, msg: e.message });
            }
            setTesting(false);
        };
        
        const handleFetchDomains = async () => {
            setLoadingDomains(true);
            try {
                const domainList = await provider.service.listDomains();
                setDomains(domainList);
            } catch (e) {
                console.error(`Failed to fetch domains from ${provider.name}:`, e);
            }
            setLoadingDomains(false);
        };
        
        React.useEffect(() => {
            if (provider.service.isConfigured() && !domains) {
                handleFetchDomains();
            }
        }, [provider.id]);
        
        const allKeysPresent = provider.keyFields.filter(f => f.type !== 'select').every(f => config[f.key]);

        return (
            <div className="space-y-4">
                <p className="text-sm text-slate-400">
                    {provider.setupNote}{' '}
                    <a href={provider.setupUrl} target="_blank" className="text-indigo-400 hover:underline">
                        Get API keys â†’
                    </a>
                </p>

                {/* Key Fields (dynamic per provider) */}
                {provider.keyFields.map(field => (
                    <div key={field.key}>
                        <label className="text-xs text-slate-400 block mb-1.5">{field.label}</label>
                        {field.type === 'select' ? (
                            <select
                                value={config[field.key] || field.default || ''}
                                onChange={e => updateConfig(field.key, e.target.value)}
                                className="w-full p-2 bg-slate-700 border border-slate-600 rounded text-sm"
                            >
                                {field.options.map(opt => (
                                    <option key={opt.value} value={opt.value}>{opt.label}</option>
                                ))}
                            </select>
                        ) : (
                            <input
                                type={showKeys ? 'text' : 'password'}
                                value={config[field.key] || ''}
                                onChange={e => updateConfig(field.key, e.target.value.trim())}
                                placeholder={field.placeholder}
                                className="w-full p-2 bg-slate-700 border border-slate-600 rounded text-sm font-mono"
                            />
                        )}
                    </div>
                ))}
                
                {/* Action Buttons */}
                <div className="flex items-center gap-3 flex-wrap">
                    <button onClick={() => setShowKeys(!showKeys)}
                        className="text-xs px-3 py-1.5 bg-slate-700 rounded hover:bg-slate-600">
                        {showKeys ? 'ðŸ”’ Hide' : 'ðŸ‘ï¸ Show'} Keys
                    </button>
                    <button onClick={handleTest} disabled={testing || !allKeysPresent}
                        className="text-xs px-3 py-1.5 bg-indigo-600 rounded hover:bg-indigo-500 disabled:opacity-40 disabled:hover:bg-indigo-600">
                        {testing ? 'â³ Testing...' : 'ðŸ”Œ Test Connection'}
                    </button>
                    {provider.service.isConfigured() && (
                        <button onClick={handleFetchDomains} disabled={loadingDomains}
                            className="text-xs px-3 py-1.5 bg-slate-700 rounded hover:bg-slate-600 disabled:opacity-40">
                            {loadingDomains ? 'â³ Loading...' : 'ðŸ”„ Refresh Domains'}
                        </button>
                    )}
                </div>
                
                {testResult && (
                    <div className={`p-3 rounded-lg border text-sm ${testResult.ok ? 'bg-green-900/30 border-green-700 text-green-300' : 'bg-red-900/30 border-red-700 text-red-300'}`}>
                        {testResult.ok ? 'âœ…' : 'âŒ'} {testResult.msg}
                    </div>
                )}
                
                {/* Domain List */}
                {domains && domains.length > 0 && (
                    <div className="mt-4">
                        <div className="text-xs text-slate-400 mb-2">{provider.icon} {provider.name} Domains ({domains.length})</div>
                        <div className="space-y-1.5">
                            {domains.map(d => {
                                const isExpiringSoon = d.expireDate && new Date(d.expireDate) - Date.now() < 60 * 24 * 60 * 60 * 1000;
                                return (
                                    <div key={d.domain} className="flex items-center gap-3 p-2.5 bg-slate-900/50 rounded-lg text-sm">
                                        <span className="text-lg">ðŸŒ</span>
                                        <span className="font-mono text-slate-200 flex-1">{d.domain}</span>
                                        <span className={`text-xs px-2 py-0.5 rounded ${
                                            d.status === 'ACTIVE' ? 'bg-green-900/30 text-green-400' : 'bg-amber-900/30 text-amber-400'
                                        }`}>
                                            {d.status || 'unknown'}
                                        </span>
                                        {d.expireDate && (
                                            <span className={`text-xs ${isExpiringSoon ? 'text-amber-400' : 'text-slate-500'}`}>
                                                {isExpiringSoon ? 'âš ï¸ ' : ''}expires {new Date(d.expireDate).toLocaleDateString()}
                                            </span>
                                        )}
                                        <span className={`text-xs ${d.autoRenew ? 'text-green-500' : 'text-slate-600'}`}>
                                            {d.autoRenew ? 'ðŸ”„ auto' : 'â¸ï¸ manual'}
                                        </span>
                                    </div>
                                );
                            })}
                        </div>
                    </div>
                )}
                
                {domains && domains.length === 0 && (
                    <div className="text-sm text-slate-500 p-4 text-center bg-slate-900/50 rounded-lg">
                        No domains found on this {provider.name} account.
                    </div>
                )}
            </div>
        );
    }


    // =========================================================================
    // INFRASTRUCTURE COMPONENTS (ported from Infrastructure satellite, v8.71.0)
    // =========================================================================

    function FirebaseRulesManager({ showAlert, showConfirm }) {
        const [rules, setRules] = React.useState(null);
        const [editedRules, setEditedRules] = React.useState('');
        const [loading, setLoading] = React.useState(false);
        const [deploying, setDeploying] = React.useState(false);
        const [error, setError] = React.useState(null);
        const [isEditing, setIsEditing] = React.useState(false);
        const [parseError, setParseError] = React.useState(null);
        const [history, setHistory] = React.useState(() => {
            try {
                return JSON.parse(localStorage.getItem('cc_rulesHistory') || '[]');
            } catch { return []; }
        });
        const [showHistory, setShowHistory] = React.useState(false);
        const [selectedSnapshot, setSelectedSnapshot] = React.useState(null);
        const [diffView, setDiffView] = React.useState(false);
        const [hasChanges, setHasChanges] = React.useState(false);
        
        const configured = firebaseAdmin.isConfigured();
        
        // Fetch current rules
        const fetchRules = async () => {
            if (!configured) return;
            setLoading(true);
            setError(null);
            try {
                const result = await firebaseAdmin.getRules();
                setRules(result);
                const formatted = JSON.stringify(result, null, 2);
                setEditedRules(formatted);
                setIsEditing(false);
                setHasChanges(false);
                setParseError(null);
            } catch (e) {
                setError(e.message);
            }
            setLoading(false);
        };
        
        // Validate JSON on edit
        const handleEditChange = (value) => {
            setEditedRules(value);
            setParseError(null);
            try {
                const parsed = JSON.parse(value);
                if (!parsed.rules) {
                    setParseError('Rules JSON must have a top-level "rules" key');
                }
            } catch (e) {
                setParseError(e.message);
            }
            // Check if different from fetched rules
            try {
                const currentStr = JSON.stringify(rules, null, 2);
                setHasChanges(value.trim() !== currentStr.trim());
            } catch {
                setHasChanges(true);
            }
        };
        
        // Save snapshot to history
        const saveSnapshot = (rulesObj, label = 'Before deploy') => {
            const snapshot = {
                id: Date.now(),
                timestamp: new Date().toISOString(),
                label,
                rules: rulesObj,
                size: JSON.stringify(rulesObj).length
            };
            const updated = [snapshot, ...history].slice(0, 20); // Keep last 20
            setHistory(updated);
            try {
                localStorage.setItem('cc_rulesHistory', JSON.stringify(updated));
            } catch (e) {
                console.warn('Failed to save rules history:', e);
            }
            return snapshot;
        };
        
        // Deploy rules
        const handleDeploy = async () => {
            if (parseError) {
                showAlert('Cannot deploy â€” there are JSON errors:\n\n' + parseError, 'Validation Error');
                return;
            }
            
            let parsed;
            try {
                parsed = JSON.parse(editedRules);
            } catch (e) {
                showAlert('Invalid JSON: ' + e.message, 'Validation Error');
                return;
            }
            
            if (!parsed.rules) {
                showAlert('Rules JSON must have a top-level "rules" key.\n\nExample:\n{\n  "rules": {\n    ".read": false,\n    ".write": false\n  }\n}', 'Invalid Rules Structure');
                return;
            }
            
            // Count paths for context
            const countPaths = (obj, depth = 0) => {
                if (!obj || typeof obj !== 'object') return 0;
                return Object.keys(obj).reduce((sum, key) => sum + 1 + countPaths(obj[key], depth + 1), 0);
            };
            const pathCount = countPaths(parsed.rules);
            
            const confirmed = await showConfirm(
                `Deploy security rules to ${FIREBASE_CONFIG.projectId}?\n\nThis will OVERWRITE all existing rules (${pathCount} paths/properties).\n\nA snapshot of the current rules will be saved to history before deploying.`,
                'Deploy Rules'
            );
            if (!confirmed) return;
            
            setDeploying(true);
            setError(null);
            
            try {
                // Snapshot current rules before overwriting
                if (rules) {
                    saveSnapshot(rules, 'Before deploy');
                }
                
                const result = await firebaseAdmin.putRules(parsed);
                setRules(result);
                const formatted = JSON.stringify(result, null, 2);
                setEditedRules(formatted);
                setIsEditing(false);
                setHasChanges(false);
                showAlert('Rules deployed successfully!', 'Deploy Complete');
            } catch (e) {
                setError('Deploy failed: ' + e.message);
            }
            
            setDeploying(false);
        };
        
        // Restore from snapshot
        const handleRestore = async (snapshot) => {
            const confirmed = await showConfirm(
                `Restore rules from ${new Date(snapshot.timestamp).toLocaleString()}?\n\nThis will replace the editor content. You still need to click "Deploy" to push to Firebase.`,
                'Restore Snapshot'
            );
            if (!confirmed) return;
            
            const formatted = JSON.stringify(snapshot.rules, null, 2);
            setEditedRules(formatted);
            setIsEditing(true);
            setHasChanges(true);
            setParseError(null);
            setShowHistory(false);
            setSelectedSnapshot(null);
        };
        
        // Delete a snapshot
        const handleDeleteSnapshot = (snapshotId) => {
            const updated = history.filter(h => h.id !== snapshotId);
            setHistory(updated);
            try {
                localStorage.setItem('cc_rulesHistory', JSON.stringify(updated));
            } catch {}
            if (selectedSnapshot?.id === snapshotId) {
                setSelectedSnapshot(null);
            }
        };
        
        // Compute simple line-by-line diff
        const computeDiff = (oldText, newText) => {
            const oldLines = oldText.split('\n');
            const newLines = newText.split('\n');
            const maxLen = Math.max(oldLines.length, newLines.length);
            const result = [];
            for (let i = 0; i < maxLen; i++) {
                const oldLine = oldLines[i];
                const newLine = newLines[i];
                if (oldLine === newLine) {
                    result.push({ type: 'same', line: oldLine, num: i + 1 });
                } else {
                    if (oldLine !== undefined) result.push({ type: 'removed', line: oldLine, num: i + 1 });
                    if (newLine !== undefined) result.push({ type: 'added', line: newLine, num: i + 1 });
                }
            }
            return result;
        };
        
        // Not configured state
        if (!configured) {
            return (
                <div className="bg-slate-800 rounded-xl border border-slate-700 p-6">
                    <h2 className="text-lg font-semibold mb-4 flex items-center gap-2">
                        ðŸ”’ Security Rules Manager
                    </h2>
                    <div className="p-4 bg-amber-900/20 border border-amber-700 rounded-lg">
                        <p className="text-amber-400 font-medium">Service account required</p>
                        <p className="text-sm text-slate-400 mt-2">
                            To manage Firebase security rules, configure a service account key in 
                            <strong className="text-white"> Configure â†’ Settings â†’ Firebase Admin</strong>.
                        </p>
                    </div>
                </div>
            );
        }
        
        return (
            <div className="space-y-6">
                {/* Header & Actions */}
                <div className="bg-slate-800 rounded-xl border border-slate-700 p-6">
                    <div className="flex items-center justify-between mb-4">
                        <h2 className="text-lg font-semibold flex items-center gap-2">
                            ðŸ”’ Security Rules â€” <span className="font-mono text-indigo-400">{FIREBASE_CONFIG.projectId}</span>
                        </h2>
                        <div className="flex items-center gap-2">
                            <button 
                                onClick={() => setShowHistory(!showHistory)}
                                className={`px-3 py-1.5 rounded text-sm flex items-center gap-1.5 ${
                                    showHistory ? 'bg-indigo-600' : 'bg-slate-700 hover:bg-slate-600'
                                }`}
                            >
                                ðŸ“œ History ({history.length})
                            </button>
                            <button 
                                onClick={fetchRules} 
                                disabled={loading}
                                className="px-4 py-1.5 bg-slate-700 hover:bg-slate-600 rounded text-sm flex items-center gap-1.5"
                            >
                                {loading ? 'â³' : 'ðŸ”„'} {loading ? 'Loading...' : 'Fetch Rules'}
                            </button>
                        </div>
                    </div>
                    
                    {/* Admin info */}
                    {(() => {
                        const info = firebaseAdmin.getInfo();
                        return info ? (
                            <div className="text-xs text-slate-500 flex items-center gap-4">
                                <span>SA: {info.email}</span>
                                <span>Token: {info.tokenValid ? 'ðŸŸ¢ Active' : info.tokenCached ? 'ðŸŸ¡ Expired' : 'âšª Not requested'}</span>
                            </div>
                        ) : null;
                    })()}
                    
                    {error && (
                        <div className="mt-4 p-3 bg-red-900/30 border border-red-700 rounded text-red-400 text-sm">
                            {error}
                        </div>
                    )}
                </div>
                
                {/* History Panel */}
                {showHistory && (
                    <div className="bg-slate-800 rounded-xl border border-slate-700 p-6">
                        <h3 className="font-semibold mb-4 flex items-center gap-2">
                            ðŸ“œ Rules History
                            <span className="text-xs text-slate-500 font-normal">({history.length} snapshots, stored in localStorage)</span>
                        </h3>
                        
                        {history.length === 0 ? (
                            <p className="text-slate-500 text-sm">No snapshots yet. A snapshot is saved automatically before each deploy.</p>
                        ) : (
                            <div className="space-y-2">
                                {history.map((snap) => (
                                    <div key={snap.id} className={`flex items-center justify-between p-3 rounded-lg border transition-colors ${
                                        selectedSnapshot?.id === snap.id 
                                            ? 'bg-indigo-900/30 border-indigo-600' 
                                            : 'bg-slate-900 border-slate-700 hover:border-slate-600'
                                    }`}>
                                        <div className="flex-1 min-w-0">
                                            <div className="flex items-center gap-2">
                                                <span className="text-sm font-medium">{snap.label}</span>
                                                <span className="text-xs text-slate-500">
                                                    {(snap.size / 1024).toFixed(1)} KB
                                                </span>
                                            </div>
                                            <div className="text-xs text-slate-500 mt-0.5">
                                                {new Date(snap.timestamp).toLocaleString()}
                                            </div>
                                        </div>
                                        <div className="flex items-center gap-2 ml-4">
                                            <button 
                                                onClick={() => setSelectedSnapshot(selectedSnapshot?.id === snap.id ? null : snap)}
                                                className="px-2 py-1 bg-slate-700 hover:bg-slate-600 rounded text-xs"
                                            >
                                                {selectedSnapshot?.id === snap.id ? 'Hide' : 'View'}
                                            </button>
                                            <button 
                                                onClick={() => handleRestore(snap)}
                                                className="px-2 py-1 bg-indigo-600 hover:bg-indigo-500 rounded text-xs"
                                            >
                                                Restore
                                            </button>
                                            <button 
                                                onClick={() => handleDeleteSnapshot(snap.id)}
                                                className="px-2 py-1 hover:bg-red-900/50 rounded text-xs text-red-400"
                                                title="Delete snapshot"
                                            >
                                                âœ•
                                            </button>
                                        </div>
                                    </div>
                                ))}
                            </div>
                        )}
                        
                        {/* Snapshot preview */}
                        {selectedSnapshot && (
                            <div className="mt-4">
                                <div className="flex items-center justify-between mb-2">
                                    <h4 className="text-sm font-medium text-slate-300">
                                        Snapshot: {new Date(selectedSnapshot.timestamp).toLocaleString()}
                                    </h4>
                                    {rules && (
                                        <button 
                                            onClick={() => setDiffView(!diffView)}
                                            className={`px-2 py-1 rounded text-xs ${diffView ? 'bg-amber-600' : 'bg-slate-700 hover:bg-slate-600'}`}
                                        >
                                            {diffView ? 'Raw View' : 'Diff vs Current'}
                                        </button>
                                    )}
                                </div>
                                {diffView && rules ? (
                                    <div className="bg-slate-900 rounded p-4 max-h-[400px] overflow-auto font-mono text-xs">
                                        {computeDiff(
                                            JSON.stringify(selectedSnapshot.rules, null, 2),
                                            JSON.stringify(rules, null, 2)
                                        ).map((line, i) => (
                                            <div key={i} className={`${
                                                line.type === 'removed' ? 'bg-red-900/30 text-red-400' :
                                                line.type === 'added' ? 'bg-green-900/30 text-green-400' :
                                                'text-slate-500'
                                            }`}>
                                                <span className="inline-block w-8 text-right mr-3 text-slate-600 select-none">{line.num}</span>
                                                <span>{line.type === 'removed' ? '- ' : line.type === 'added' ? '+ ' : '  '}</span>
                                                {line.line}
                                            </div>
                                        ))}
                                    </div>
                                ) : (
                                    <pre className="bg-slate-900 rounded p-4 max-h-[400px] overflow-auto font-mono text-xs text-slate-300 whitespace-pre-wrap">
                                        {JSON.stringify(selectedSnapshot.rules, null, 2)}
                                    </pre>
                                )}
                            </div>
                        )}
                    </div>
                )}
                
                {/* Rules Editor */}
                {rules !== null && (
                    <div className="bg-slate-800 rounded-xl border border-slate-700 p-6">
                        <div className="flex items-center justify-between mb-4">
                            <h3 className="font-semibold flex items-center gap-2">
                                {isEditing ? 'âœï¸ Editing Rules' : 'ðŸ“„ Current Rules'}
                                {hasChanges && (
                                    <span className="px-2 py-0.5 bg-amber-600/30 text-amber-400 text-xs rounded-full">
                                        Unsaved changes
                                    </span>
                                )}
                            </h3>
                            <div className="flex items-center gap-2">
                                {!isEditing ? (
                                    <>
                                        <button 
                                            onClick={() => {
                                                navigator.clipboard.writeText(editedRules);
                                                showAlert('Rules copied to clipboard', 'Copied');
                                            }}
                                            className="px-3 py-1.5 bg-slate-700 hover:bg-slate-600 rounded text-sm"
                                        >
                                            ðŸ“‹ Copy
                                        </button>
                                        <button 
                                            onClick={() => {
                                                saveSnapshot(rules, 'Manual snapshot');
                                                showAlert('Snapshot saved to history', 'Snapshot Saved');
                                            }}
                                            className="px-3 py-1.5 bg-slate-700 hover:bg-slate-600 rounded text-sm"
                                        >
                                            ðŸ“¸ Snapshot
                                        </button>
                                        <button 
                                            onClick={() => setIsEditing(true)}
                                            className="px-3 py-1.5 bg-indigo-600 hover:bg-indigo-500 rounded text-sm"
                                        >
                                            âœï¸ Edit
                                        </button>
                                    </>
                                ) : (
                                    <>
                                        <button 
                                            onClick={() => {
                                                setEditedRules(JSON.stringify(rules, null, 2));
                                                setIsEditing(false);
                                                setHasChanges(false);
                                                setParseError(null);
                                            }}
                                            className="px-3 py-1.5 bg-slate-700 hover:bg-slate-600 rounded text-sm"
                                        >
                                            Cancel
                                        </button>
                                        <button 
                                            onClick={() => {
                                                // Format / prettify
                                                try {
                                                    const parsed = JSON.parse(editedRules);
                                                    setEditedRules(JSON.stringify(parsed, null, 2));
                                                    setParseError(null);
                                                } catch (e) {
                                                    setParseError(e.message);
                                                }
                                            }}
                                            className="px-3 py-1.5 bg-slate-700 hover:bg-slate-600 rounded text-sm"
                                        >
                                            ðŸ§¹ Format
                                        </button>
                                        <button 
                                            onClick={handleDeploy}
                                            disabled={deploying || !!parseError || !hasChanges}
                                            className={`px-4 py-1.5 rounded text-sm font-medium flex items-center gap-1.5 ${
                                                deploying || !!parseError || !hasChanges
                                                    ? 'bg-slate-600 text-slate-400 cursor-not-allowed'
                                                    : 'bg-green-600 hover:bg-green-500 text-white'
                                            }`}
                                        >
                                            {deploying ? 'â³ Deploying...' : 'ðŸš€ Deploy Rules'}
                                        </button>
                                    </>
                                )}
                            </div>
                        </div>
                        
                        {/* Parse error banner */}
                        {parseError && (
                            <div className="mb-4 p-3 bg-red-900/30 border border-red-700 rounded text-sm">
                                <span className="text-red-400 font-medium">JSON Error: </span>
                                <span className="text-red-300 font-mono">{parseError}</span>
                            </div>
                        )}
                        
                        {/* Editor area */}
                        {isEditing ? (
                            <textarea
                                value={editedRules}
                                onChange={e => handleEditChange(e.target.value)}
                                className={`w-full bg-slate-900 border rounded p-4 font-mono text-sm text-slate-300 leading-relaxed resize-y ${
                                    parseError ? 'border-red-600' : 'border-slate-600 focus:border-indigo-500'
                                } focus:outline-none`}
                                style={{ minHeight: '400px', maxHeight: '700px', tabSize: 2 }}
                                spellCheck={false}
                                onKeyDown={e => {
                                    // Tab support in textarea
                                    if (e.key === 'Tab') {
                                        e.preventDefault();
                                        const start = e.target.selectionStart;
                                        const end = e.target.selectionEnd;
                                        const val = e.target.value;
                                        const newVal = val.substring(0, start) + '  ' + val.substring(end);
                                        handleEditChange(newVal);
                                        // Set cursor position after React re-renders
                                        requestAnimationFrame(() => {
                                            e.target.selectionStart = e.target.selectionEnd = start + 2;
                                        });
                                    }
                                }}
                            />
                        ) : (
                            <div className="relative">
                                <pre className="bg-slate-900 border border-slate-700 rounded p-4 font-mono text-sm text-slate-300 leading-relaxed overflow-auto max-h-[600px] whitespace-pre-wrap">
                                    {editedRules}
                                </pre>
                                <div className="absolute top-3 right-3 text-xs text-slate-600">
                                    {(editedRules.length / 1024).toFixed(1)} KB Â· {editedRules.split('\n').length} lines
                                </div>
                            </div>
                        )}
                        
                        {/* Editor stats */}
                        {isEditing && (
                            <div className="mt-2 flex items-center justify-between text-xs text-slate-500">
                                <div className="flex items-center gap-3">
                                    <span>{editedRules.split('\n').length} lines</span>
                                    <span>{(editedRules.length / 1024).toFixed(1)} KB</span>
                                    {!parseError && <span className="text-green-500">âœ“ Valid JSON</span>}
                                </div>
                                <div>Tab inserts spaces Â· Ctrl+Z to undo</div>
                            </div>
                        )}
                    </div>
                )}
                
                {/* Empty state â€” no rules loaded yet */}
                {rules === null && !loading && !error && (
                    <div className="bg-slate-800 rounded-xl border border-slate-700 p-8 text-center">
                        <div className="text-4xl mb-3">ðŸ”’</div>
                        <p className="text-slate-400 mb-4">Click <strong>Fetch Rules</strong> to load the current security rules from Firebase.</p>
                        <button 
                            onClick={fetchRules}
                            className="px-6 py-2.5 bg-indigo-600 hover:bg-indigo-500 rounded-lg font-medium"
                        >
                            Fetch Rules
                        </button>
                    </div>
                )}
            </div>
        );
    }

    function DomainsView({ apps, config, githubToken, showAlert, showConfirm }) {
        const [domains, setDomains] = React.useState(null);
        const [loading, setLoading] = React.useState(false);
        const [error, setError] = React.useState(null);
        const [selectedDomain, setSelectedDomain] = React.useState(null);
        const [dnsRecords, setDnsRecords] = React.useState(null);
        const [loadingDNS, setLoadingDNS] = React.useState(false);
        const [addingRecord, setAddingRecord] = React.useState(false);
        const [newRecord, setNewRecord] = React.useState({ type: 'A', name: '', content: '', ttl: '600' });
        const [wiringDomain, setWiringDomain] = React.useState(null);
        const [wireLog, setWireLog] = React.useState([]);
        const [wireProgress, setWireProgress] = React.useState(false);
        const [providerErrors, setProviderErrors] = React.useState([]);

        // Get the service for the currently selected domain
        const getServiceForDomain = (domain) => {
            return DomainProviderRegistry.getServiceForDomain(domain, domains || []);
        };

        // Load domains from all configured providers
        const fetchDomains = async () => {
            setLoading(true);
            setError(null);
            setProviderErrors([]);
            try {
                const { domains: allDomains, errors } = await DomainProviderRegistry.getAllDomains();
                setDomains(allDomains);
                setProviderErrors(errors);
                if (allDomains.length > 0 && !selectedDomain) {
                    setSelectedDomain(allDomains[0].domain);
                }
            } catch (e) {
                setError(e.message);
            }
            setLoading(false);
        };
        
        // Load DNS records for selected domain
        const fetchDNS = async (domain) => {
            setLoadingDNS(true);
            try {
                const service = getServiceForDomain(domain);
                if (!service) throw new Error('No provider found for this domain');
                const records = await service.listDNSRecords(domain);
                setDnsRecords(records);
            } catch (e) {
                showAlert(`Failed to load DNS: ${e.message}`, 'error');
            }
            setLoadingDNS(false);
        };
        
        // Fetch on mount
        React.useEffect(() => {
            if (DomainProviderRegistry.getConfigured().length > 0) fetchDomains();
        }, []);
        
        // Fetch DNS when domain changes
        React.useEffect(() => {
            if (selectedDomain) fetchDNS(selectedDomain);
        }, [selectedDomain]);
        
        // Add DNS record
        const handleAddRecord = async () => {
            if (!newRecord.type || !newRecord.content) return;
            setAddingRecord(true);
            try {
                const service = getServiceForDomain(selectedDomain);
                if (!service) throw new Error('No provider found for this domain');
                await service.createDNSRecord(
                    selectedDomain, newRecord.type, newRecord.name, 
                    newRecord.content, parseInt(newRecord.ttl) || 600,
                    newRecord.type === 'MX' ? parseInt(newRecord.prio) || 10 : null
                );
                showAlert('DNS record created', 'success');
                setNewRecord({ type: 'A', name: '', content: '', ttl: '600' });
                await fetchDNS(selectedDomain);
            } catch (e) {
                showAlert(`Failed to create record: ${e.message}`, 'error');
            }
            setAddingRecord(false);
        };
        
        // Delete DNS record
        const handleDeleteRecord = async (recordId, recordDesc) => {
            const confirmed = await showConfirm(`Delete ${recordDesc}?`, 'Delete DNS Record');
            if (!confirmed) return;
            try {
                const service = getServiceForDomain(selectedDomain);
                if (!service) throw new Error('No provider found for this domain');
                // GoDaddy needs all records to do a replace-minus-one
                await service.deleteDNSRecord(selectedDomain, recordId, dnsRecords);
                showAlert('Record deleted', 'success');
                await fetchDNS(selectedDomain);
            } catch (e) {
                showAlert(`Failed to delete: ${e.message}`, 'error');
            }
        };
        
        // Wire domain for GitHub Pages
        const handleWireForGitHubPages = async (domain, repo) => {
            setWireProgress(true);
            setWireLog(['ðŸš€ Starting GitHub Pages configuration...']);
            
            try {
                const service = getServiceForDomain(domain);
                if (!service) throw new Error('No provider found for this domain');
                const domainEntry = (domains || []).find(d => d.domain === domain);
                const providerName = domainEntry?.providerName || 'registrar';
                
                // Step 1: Configure DNS at registrar
                setWireLog(prev => [...prev, `ðŸ“¡ Configuring DNS records at ${providerName}...`]);
                const githubUsername = repo.split('/')[0];
                const dnsResult = await service.configureForGitHubPages(domain, githubUsername);
                dnsResult.log.forEach(l => setWireLog(prev => [...prev, `  ${l}`]));
                setWireLog(prev => [...prev, `âœ… ${dnsResult.recordsCreated} DNS records created`]);
                
                // Step 2: Create CNAME file in repo
                setWireLog(prev => [...prev, 'ðŸ“„ Committing CNAME file to repo...']);
                const github = new GitHubAPI(githubToken);
                await github.createOrUpdateFile(repo, 'CNAME', domain, `Add custom domain CNAME for ${domain}`);
                setWireLog(prev => [...prev, 'âœ… CNAME file committed']);
                
                // Step 3: Update GitHub Pages config
                setWireLog(prev => [...prev, 'âš™ï¸ Updating GitHub Pages configuration...']);
                await github.updatePagesConfig(repo, domain, false);
                setWireLog(prev => [...prev, 'âœ… Custom domain set on GitHub Pages']);
                
                setWireLog(prev => [...prev, '', 'ðŸŽ‰ Domain configuration complete!', `ðŸŒ ${domain} will be live once DNS propagates (5-30 minutes)`, 'ðŸ”’ HTTPS will auto-enable after DNS propagation']);
                
                showAlert(`${domain} configured for GitHub Pages! DNS may take 5-30 minutes to propagate.`, 'success');
                
                // Refresh DNS records view
                await fetchDNS(domain);
            } catch (e) {
                setWireLog(prev => [...prev, `âŒ Error: ${e.message}`]);
                showAlert(`Wiring failed: ${e.message}`, 'error');
            }
            setWireProgress(false);
        };
        
        // Not configured
        if (DomainProviderRegistry.getConfigured().length === 0) {
            return (
                <div className="max-w-4xl mx-auto">
                    <div className="flex items-center gap-3 mb-6">
                        <span className="text-2xl">ðŸŒ</span>
                        <h1 className="text-2xl font-bold">Domains</h1>
                    </div>
                    <div className="bg-slate-800 rounded-xl border border-slate-700 p-8 text-center">
                        <span className="text-4xl block mb-4">ðŸ”‘</span>
                        <h3 className="text-lg font-semibold mb-2">No Domain Registrars Configured</h3>
                        <p className="text-slate-400 text-sm mb-4">Add API keys for Porkbun, GoDaddy, or both in Settings to manage domains from Command Center.</p>
                        <p className="text-slate-500 text-xs">Configure â†’ Settings â†’ ðŸŒ Domain Registrar</p>
                    </div>
                </div>
            );
        }
        
        // Record type colors
        const typeColors = {
            A: 'bg-blue-600/20 text-blue-400',
            AAAA: 'bg-cyan-600/20 text-cyan-400',
            CNAME: 'bg-green-600/20 text-green-400',
            MX: 'bg-purple-600/20 text-purple-400',
            TXT: 'bg-amber-600/20 text-amber-400',
            NS: 'bg-slate-600/20 text-slate-400',
            SRV: 'bg-pink-600/20 text-pink-400',
            ALIAS: 'bg-emerald-600/20 text-emerald-400',
            CAA: 'bg-orange-600/20 text-orange-400',
        };
        
        // Check if domain is already wired for GitHub Pages
        const isGitHubPagesWired = (records) => {
            if (!records) return false;
            const ghIPs = PorkbunService.GITHUB_PAGES_IPS; // Same IPs regardless of provider
            const aRecords = records.filter(r => r.type === 'A').map(r => r.content);
            const hasGHIPs = ghIPs.every(ip => aRecords.includes(ip));
            const hasCNAME = records.some(r => r.type === 'CNAME' && r.content.includes('.github.io'));
            return hasGHIPs && hasCNAME;
        };
        
        // Find which apps could use this domain (have repos assigned)
        const getAppsWithRepos = () => {
            return Object.entries(apps)
                .filter(([_, a]) => a.testRepo || a.prodRepo)
                .map(([id, a]) => ({ id, ...a }));
        };
        
        return (
            <div className="max-w-6xl mx-auto">
                <div className="flex items-center justify-between mb-6">
                    <div className="flex items-center gap-3">
                        <span className="text-2xl">ðŸŒ</span>
                        <div>
                            <h1 className="text-2xl font-bold">Domains</h1>
                            <p className="text-slate-400 text-sm">DNS management and GitHub Pages domain wiring</p>
                        </div>
                    </div>
                    <button onClick={fetchDomains} disabled={loading}
                        className="px-3 py-1.5 text-sm bg-slate-700 rounded hover:bg-slate-600 disabled:opacity-40">
                        {loading ? 'â³' : 'ðŸ”„'} Refresh
                    </button>
                </div>
                
                {error && (
                    <div className="bg-red-900/30 border border-red-700 text-red-300 rounded-xl p-4 mb-6 text-sm">
                        âŒ {error}
                    </div>
                )}

                {providerErrors.length > 0 && providerErrors.map((pe, i) => (
                    <div key={i} className="bg-amber-900/30 border border-amber-700 text-amber-300 rounded-xl p-4 mb-4 text-sm">
                        âš ï¸ {pe.icon} {pe.provider}: {pe.error}
                    </div>
                ))}

                {/* Domain Selector */}
                {domains && domains.length > 0 && (
                    <div className="flex gap-2 mb-6 flex-wrap">
                        {domains.map(d => (
                            <button key={d.domain}
                                onClick={() => setSelectedDomain(d.domain)}
                                className={`px-4 py-2 rounded-lg text-sm font-mono transition-all flex items-center gap-2 ${
                                    selectedDomain === d.domain 
                                        ? 'bg-indigo-600 text-white ring-1 ring-indigo-400' 
                                        : 'bg-slate-800 border border-slate-700 text-slate-300 hover:bg-slate-700'
                                }`}>
                                <span>{d.providerIcon || 'ðŸŒ'}</span>
                                <span>{d.domain}</span>
                            </button>
                        ))}
                    </div>
                )}
                
                {domains && domains.length === 0 && !loading && (
                    <div className="text-center text-slate-400 py-12">
                        <div className="text-3xl mb-3">ðŸŒ</div>
                        <div>No domains found across configured providers.</div>
                        <div className="text-xs mt-2 text-slate-500">If using GoDaddy OTE, only test domains are available. Switch to Production environment for real domains.</div>
                    </div>
                )}

                {loading && <div className="text-center text-slate-400 py-12">â³ Loading domains...</div>}

                {/* DNS Records Panel */}
                {selectedDomain && !loading && (
                    <div className="space-y-6">
                        {/* Domain Info + Quick Actions */}
                        <div className="bg-slate-800 rounded-xl border border-slate-700 p-5">
                            <div className="flex items-center justify-between mb-4">
                                <h3 className="font-semibold flex items-center gap-2">
                                    ðŸ“¡ DNS Records â€” <span className="font-mono text-indigo-300">{selectedDomain}</span>
                                </h3>
                                <div className="flex gap-2">
                                    {!isGitHubPagesWired(dnsRecords) && (
                                        <button onClick={() => setWiringDomain(selectedDomain)}
                                            className="text-xs px-3 py-1.5 bg-green-600 rounded hover:bg-green-500 font-medium">
                                            âš¡ Wire for GitHub Pages
                                        </button>
                                    )}
                                    {isGitHubPagesWired(dnsRecords) && (
                                        <span className="text-xs px-3 py-1.5 bg-green-900/30 text-green-400 rounded border border-green-700/30">
                                            âœ… GitHub Pages configured
                                        </span>
                                    )}
                                    <button onClick={() => fetchDNS(selectedDomain)} disabled={loadingDNS}
                                        className="text-xs px-3 py-1.5 bg-slate-700 rounded hover:bg-slate-600 disabled:opacity-40">
                                        {loadingDNS ? 'â³' : 'ðŸ”„'}
                                    </button>
                                </div>
                            </div>
                            
                            {/* DNS Records Table */}
                            {loadingDNS && <div className="text-center text-slate-400 py-8">â³ Loading DNS records...</div>}
                            
                            {dnsRecords && !loadingDNS && (
                                <div className="overflow-x-auto">
                                    <table className="w-full text-sm">
                                        <thead>
                                            <tr className="border-b border-slate-700 text-left">
                                                <th className="py-2 px-3 text-slate-400 font-medium w-20">Type</th>
                                                <th className="py-2 px-3 text-slate-400 font-medium">Name</th>
                                                <th className="py-2 px-3 text-slate-400 font-medium">Content</th>
                                                <th className="py-2 px-3 text-slate-400 font-medium w-16">TTL</th>
                                                <th className="py-2 px-3 text-slate-400 font-medium w-16">Prio</th>
                                                <th className="py-2 px-3 text-slate-400 font-medium w-12"></th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {dnsRecords.map(record => (
                                                <tr key={record.id} className="border-b border-slate-700/50 hover:bg-slate-700/30">
                                                    <td className="py-2 px-3">
                                                        <span className={`text-xs px-2 py-0.5 rounded font-medium ${typeColors[record.type] || 'bg-slate-600/20 text-slate-400'}`}>
                                                            {record.type}
                                                        </span>
                                                    </td>
                                                    <td className="py-2 px-3 font-mono text-slate-300 text-xs">{record.name || '@'}</td>
                                                    <td className="py-2 px-3 font-mono text-slate-200 text-xs break-all max-w-xs">{record.content}</td>
                                                    <td className="py-2 px-3 text-xs text-slate-500">{record.ttl}</td>
                                                    <td className="py-2 px-3 text-xs text-slate-500">{record.prio || 'â€”'}</td>
                                                    <td className="py-2 px-3">
                                                        <button onClick={() => handleDeleteRecord(record.id, `${record.type} ${record.name}`)}
                                                            className="text-red-500 hover:text-red-400 text-xs" title="Delete record">
                                                            ðŸ—‘ï¸
                                                        </button>
                                                    </td>
                                                </tr>
                                            ))}
                                            {dnsRecords.length === 0 && (
                                                <tr><td colSpan="6" className="py-8 text-center text-slate-500">No DNS records found</td></tr>
                                            )}
                                        </tbody>
                                    </table>
                                </div>
                            )}
                        </div>
                        
                        {/* Add DNS Record */}
                        <div className="bg-slate-800 rounded-xl border border-slate-700 p-5">
                            <h3 className="font-semibold mb-4 flex items-center gap-2">âž• Add DNS Record</h3>
                            <div className="grid grid-cols-2 sm:grid-cols-5 gap-3">
                                <div>
                                    <label className="text-xs text-slate-400 block mb-1">Type</label>
                                    <select value={newRecord.type} onChange={e => setNewRecord({...newRecord, type: e.target.value})}
                                        className="w-full p-2 bg-slate-700 border border-slate-600 rounded text-sm">
                                        {['A', 'AAAA', 'CNAME', 'MX', 'TXT', 'NS', 'SRV', 'CAA', 'ALIAS'].map(t => (
                                            <option key={t} value={t}>{t}</option>
                                        ))}
                                    </select>
                                </div>
                                <div>
                                    <label className="text-xs text-slate-400 block mb-1">Name <span className="text-slate-600">(subdomain)</span></label>
                                    <input value={newRecord.name} onChange={e => setNewRecord({...newRecord, name: e.target.value})}
                                        placeholder="@ or www" className="w-full p-2 bg-slate-700 border border-slate-600 rounded text-sm font-mono" />
                                </div>
                                <div className="sm:col-span-2">
                                    <label className="text-xs text-slate-400 block mb-1">Content</label>
                                    <input value={newRecord.content} onChange={e => setNewRecord({...newRecord, content: e.target.value})}
                                        placeholder="1.2.3.4 or target.example.com" className="w-full p-2 bg-slate-700 border border-slate-600 rounded text-sm font-mono" />
                                </div>
                                <div className="flex items-end gap-2">
                                    <div className="flex-1">
                                        <label className="text-xs text-slate-400 block mb-1">TTL</label>
                                        <input value={newRecord.ttl} onChange={e => setNewRecord({...newRecord, ttl: e.target.value})}
                                            className="w-full p-2 bg-slate-700 border border-slate-600 rounded text-sm font-mono" />
                                    </div>
                                    <button onClick={handleAddRecord} disabled={addingRecord || !newRecord.content}
                                        className="px-4 py-2 bg-indigo-600 rounded text-sm hover:bg-indigo-500 disabled:opacity-40 whitespace-nowrap">
                                        {addingRecord ? 'â³' : 'âž•'} Add
                                    </button>
                                </div>
                            </div>
                        </div>
                        
                        {/* Wire for GitHub Pages Modal */}
                        {wiringDomain && (
                            <div className="bg-slate-800 rounded-xl border border-indigo-700/50 p-5">
                                <h3 className="font-semibold mb-3 flex items-center gap-2">âš¡ Wire {wiringDomain} for GitHub Pages</h3>
                                
                                {!wireProgress && wireLog.length === 0 && (
                                    <div>
                                        <p className="text-sm text-slate-400 mb-4">
                                            This will configure DNS records and GitHub Pages to serve your app from <strong className="text-white">{wiringDomain}</strong>. 
                                            It creates 4 A records + 1 CNAME record, commits a CNAME file, and updates the GitHub Pages settings.
                                        </p>
                                        <div className="mb-4">
                                            <label className="text-xs text-slate-400 block mb-1.5">Select Repository to Wire</label>
                                            <div className="space-y-1.5">
                                                {getAppsWithRepos().map(app => (
                                                    <div key={app.id} className="flex items-center gap-3">
                                                        {app.prodRepo && (
                                                            <button onClick={() => handleWireForGitHubPages(wiringDomain, app.prodRepo)}
                                                                className="flex items-center gap-2 px-3 py-2 bg-slate-900/50 rounded-lg hover:bg-slate-700/50 text-sm border border-slate-700 w-full text-left">
                                                                <AppIcon icon={app.icon} size={16} />
                                                                <span className="font-medium">{app.name}</span>
                                                                <span className="text-xs text-slate-500 font-mono ml-auto">{app.prodRepo}</span>
                                                                <span className="text-xs px-1.5 py-0.5 bg-green-900/30 text-green-400 rounded">prod</span>
                                                            </button>
                                                        )}
                                                    </div>
                                                ))}
                                            </div>
                                        </div>
                                        <button onClick={() => { setWiringDomain(null); setWireLog([]); }}
                                            className="text-xs text-slate-400 hover:text-white">Cancel</button>
                                    </div>
                                )}
                                
                                {/* Wire Progress Log */}
                                {wireLog.length > 0 && (
                                    <div>
                                        <div className="bg-slate-900 rounded-lg p-4 max-h-64 overflow-y-auto font-mono text-xs space-y-1">
                                            {wireLog.map((line, i) => (
                                                <div key={i} className={`${line.startsWith('âŒ') ? 'text-red-400' : line.startsWith('âœ…') ? 'text-green-400' : line.startsWith('ðŸŽ‰') ? 'text-yellow-400 font-bold' : 'text-slate-300'}`}>
                                                    {line}
                                                </div>
                                            ))}
                                            {wireProgress && <div className="text-indigo-400 animate-pulse">â³ Working...</div>}
                                        </div>
                                        {!wireProgress && (
                                            <button onClick={() => { setWiringDomain(null); setWireLog([]); }}
                                                className="mt-3 text-xs px-3 py-1.5 bg-slate-700 rounded hover:bg-slate-600">
                                                âœ“ Done
                                            </button>
                                        )}
                                    </div>
                                )}
                            </div>
                        )}
                    </div>
                )}
                
                {!loading && domains && domains.length === 0 && (
                    <div className="bg-slate-800 rounded-xl border border-slate-700 p-8 text-center">
                        <span className="text-4xl block mb-4">ðŸŒ</span>
                        <h3 className="text-lg font-semibold mb-2">No Domains Found</h3>
                        <p className="text-slate-400 text-sm">No domains found across your configured registrars. Purchase a domain at your registrar, then manage it here.</p>
                    </div>
                )}
            </div>
        );
    }

    function AuthorizedDomainsManager({ showAlert }) {
        const [domains, setDomains] = React.useState(null);
        const [loading, setLoading] = React.useState(false);
        const [error, setError] = React.useState(null);
        const [newDomain, setNewDomain] = React.useState('');
        const [adding, setAdding] = React.useState(false);
        const [removing, setRemoving] = React.useState(null);
        
        const loadDomains = async () => {
            setLoading(true);
            setError(null);
            try {
                const list = await firebaseAdmin.getAuthorizedDomains();
                setDomains(list);
            } catch (e) {
                setError(e.message);
            }
            setLoading(false);
        };
        
        const handleAdd = async () => {
            if (!newDomain.trim()) return;
            const domain = newDomain.trim().toLowerCase();
            setAdding(true);
            setError(null);
            try {
                const result = await firebaseAdmin.addAuthorizedDomain(domain);
                if (result.alreadyExists) {
                    showAlert?.(`${domain} is already in the authorized domains list.`, 'Already Exists');
                } else {
                    showAlert?.(`âœ… Added ${domain} to Firebase authorized domains.`, 'Domain Added');
                }
                setDomains(result.authorizedDomains);
                setNewDomain('');
            } catch (e) {
                setError(e.message);
            }
            setAdding(false);
        };
        
        const handleRemove = async (domain) => {
            // Protect system domains
            const protectedDomains = ['localhost', 'word-boxing.firebaseapp.com', 'word-boxing.web.app'];
            if (protectedDomains.some(p => domain.includes(p) || domain === 'localhost')) {
                showAlert?.(`Cannot remove system domain: ${domain}`, 'Protected Domain');
                return;
            }
            setRemoving(domain);
            setError(null);
            try {
                const result = await firebaseAdmin.removeAuthorizedDomain(domain);
                if (result.notFound) {
                    showAlert?.(`${domain} was not found in authorized domains.`, 'Not Found');
                } else {
                    showAlert?.(`Removed ${domain} from Firebase authorized domains.`, 'Domain Removed');
                }
                setDomains(result.authorizedDomains);
            } catch (e) {
                setError(e.message);
            }
            setRemoving(null);
        };
        
        const handleKeyDown = (e) => {
            if (e.key === 'Enter') handleAdd();
        };
        
        // Categorize domains for display
        const systemDomains = (domains || []).filter(d => 
            d === 'localhost' || d.endsWith('.firebaseapp.com') || d.endsWith('.web.app')
        );
        const customDomains = (domains || []).filter(d => 
            d !== 'localhost' && !d.endsWith('.firebaseapp.com') && !d.endsWith('.web.app')
        );
        
        return (
            <div className="space-y-4">
                {/* Load button or domain list */}
                {domains === null ? (
                    <div className="text-center">
                        <button onClick={loadDomains} disabled={loading}
                            className="px-4 py-2 bg-indigo-600 hover:bg-indigo-500 rounded text-sm disabled:opacity-50">
                            {loading ? 'â³ Loading...' : 'ðŸ” Load Authorized Domains'}
                        </button>
                    </div>
                ) : (
                    <div className="space-y-3">
                        {/* Custom domains */}
                        <div>
                            <div className="text-xs text-slate-500 uppercase tracking-wide mb-2">Custom Domains ({customDomains.length})</div>
                            <div className="space-y-1">
                                {customDomains.map(domain => (
                                    <div key={domain} className="flex items-center justify-between p-2 bg-slate-900 rounded border border-slate-700 group">
                                        <div className="flex items-center gap-2">
                                            <span className="inline-block w-2 h-2 rounded-full bg-green-400"></span>
                                            <span className="text-sm text-slate-300 font-mono">{domain}</span>
                                        </div>
                                        <button 
                                            onClick={() => handleRemove(domain)} 
                                            disabled={removing === domain}
                                            className="text-xs text-red-400 hover:text-red-300 opacity-0 group-hover:opacity-100 transition-opacity px-2 py-1 rounded hover:bg-red-900/30"
                                        >
                                            {removing === domain ? 'â³' : 'âœ• Remove'}
                                        </button>
                                    </div>
                                ))}
                                {customDomains.length === 0 && (
                                    <div className="text-xs text-slate-500 italic p-2">No custom domains configured</div>
                                )}
                            </div>
                        </div>
                        
                        {/* System domains (collapsed) */}
                        <details className="text-xs">
                            <summary className="text-slate-500 uppercase tracking-wide cursor-pointer hover:text-slate-400">
                                System Domains ({systemDomains.length})
                            </summary>
                            <div className="space-y-1 mt-2">
                                {systemDomains.map(domain => (
                                    <div key={domain} className="flex items-center gap-2 p-2 bg-slate-900/50 rounded border border-slate-700/50">
                                        <span className="inline-block w-2 h-2 rounded-full bg-slate-500"></span>
                                        <span className="text-xs text-slate-500 font-mono">{domain}</span>
                                        <span className="text-xs text-slate-600 ml-auto">protected</span>
                                    </div>
                                ))}
                            </div>
                        </details>
                        
                        {/* Add domain */}
                        <div className="flex gap-2">
                            <input
                                type="text"
                                value={newDomain}
                                onChange={e => setNewDomain(e.target.value)}
                                onKeyDown={handleKeyDown}
                                placeholder="e.g. aicommandcenter.dev"
                                className="flex-1 px-3 py-2 bg-slate-900 border border-slate-600 rounded text-sm text-slate-300 font-mono placeholder-slate-600"
                            />
                            <button onClick={handleAdd} disabled={adding || !newDomain.trim()}
                                className="px-4 py-2 bg-green-600 hover:bg-green-500 rounded text-sm disabled:opacity-50 whitespace-nowrap">
                                {adding ? 'â³' : '+ Add'}
                            </button>
                        </div>
                        
                        {/* Refresh */}
                        <button onClick={loadDomains} disabled={loading}
                            className="text-xs text-slate-500 hover:text-slate-400">
                            ðŸ”„ Refresh list
                        </button>
                    </div>
                )}
                
                {/* Error display */}
                {error && (
                    <div className="p-3 bg-red-900/30 border border-red-700 rounded text-sm text-red-300">
                        âŒ {error}
                    </div>
                )}
                
                <div className="text-xs text-slate-500 space-y-1">
                    <div>âš ï¸ After adding a domain here, you also need to update:</div>
                    <div className="ml-3">â€¢ <a href="https://console.cloud.google.com/apis/credentials?project=word-boxing" target="_blank" className="text-indigo-400 hover:underline">Google Cloud Console â†’ OAuth Redirect URIs</a></div>
                    <div className="ml-3 text-slate-600">Add: https://DOMAIN/__/auth/handler (redirect URI) + https://DOMAIN (JS origin)</div>
                </div>
            </div>
        );
    }

    // =========================================================================

    function FirebaseAdminSettings() {
        const [showKeyInput, setShowKeyInput] = React.useState(false);
        const [keyInput, setKeyInput] = React.useState('');
        const [info, setInfo] = React.useState(() => firebaseAdmin.getInfo());
        const [testing, setTesting] = React.useState(false);
        const [testResult, setTestResult] = React.useState(null);
        const [saveResult, setSaveResult] = React.useState(null);
        
        const refreshInfo = () => setInfo(firebaseAdmin.getInfo());
        
        const handleSave = () => {
            setSaveResult(null);
            setTestResult(null);
            const result = firebaseAdmin.saveServiceAccount(keyInput);
            setSaveResult(result);
            if (result.success) {
                setKeyInput('');
                setShowKeyInput(false);
                refreshInfo();
            }
        };
        
        const handleClear = () => {
            firebaseAdmin.clearServiceAccount();
            setSaveResult(null);
            setTestResult(null);
            refreshInfo();
        };
        
        const handleTest = async () => {
            setTesting(true);
            setTestResult(null);
            try {
                const result = await firebaseAdmin.testConnection();
                setTestResult(result);
                refreshInfo();
            } catch (e) {
                setTestResult({ token: false, rules: false, authConfig: false, errors: [e.message] });
            }
            setTesting(false);
        };
        
        const handleRefreshToken = async () => {
            setTesting(true);
            setTestResult(null);
            try {
                firebaseAdmin.clearToken();
                await firebaseAdmin.getAccessToken();
                refreshInfo();
                setTestResult({ token: true, errors: [], message: 'Token refreshed' });
            } catch (e) {
                setTestResult({ token: false, errors: [e.message] });
            }
            setTesting(false);
        };
        
        const configured = info !== null;
        
        return (
            <div className="space-y-4">
                {/* Status display */}
                {configured ? (
                    <div className="space-y-3">
                        <div className="p-4 bg-slate-900 rounded-lg border border-slate-600">
                            <div className="grid grid-cols-2 gap-3 text-sm">
                                <div>
                                    <div className="text-xs text-slate-500 uppercase tracking-wide mb-1">Service Account</div>
                                    <div className="font-mono text-slate-300 text-xs truncate" title={info.email}>{info.email}</div>
                                </div>
                                <div>
                                    <div className="text-xs text-slate-500 uppercase tracking-wide mb-1">Firebase Project</div>
                                    <div className="font-mono text-slate-300 text-xs">{info.projectId}</div>
                                </div>
                                <div>
                                    <div className="text-xs text-slate-500 uppercase tracking-wide mb-1">Key ID</div>
                                    <div className="font-mono text-slate-300 text-xs">{info.keyId}</div>
                                </div>
                                <div>
                                    <div className="text-xs text-slate-500 uppercase tracking-wide mb-1">OAuth Token</div>
                                    <div className="flex items-center gap-2">
                                        {info.tokenValid ? (
                                            <span className="text-green-400 text-xs flex items-center gap-1">
                                                <span className="inline-block w-2 h-2 rounded-full bg-green-400"></span>
                                                Active â€” expires {info.tokenExpiry}
                                            </span>
                                        ) : info.tokenCached ? (
                                            <span className="text-amber-400 text-xs flex items-center gap-1">
                                                <span className="inline-block w-2 h-2 rounded-full bg-amber-400"></span>
                                                Expired
                                            </span>
                                        ) : (
                                            <span className="text-slate-500 text-xs flex items-center gap-1">
                                                <span className="inline-block w-2 h-2 rounded-full bg-slate-500"></span>
                                                Not yet requested
                                            </span>
                                        )}
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        {/* Actions */}
                        <div className="flex gap-2 flex-wrap">
                            <button onClick={handleTest} disabled={testing}
                                className="px-4 py-2 bg-indigo-600 hover:bg-indigo-500 rounded text-sm disabled:opacity-50">
                                {testing ? 'â³ Testing...' : 'ðŸ§ª Test Connection'}
                            </button>
                            <button onClick={handleRefreshToken} disabled={testing}
                                className="px-4 py-2 bg-slate-700 hover:bg-slate-600 rounded text-sm disabled:opacity-50">
                                ðŸ”„ Refresh Token
                            </button>
                            <button onClick={() => setShowKeyInput(true)}
                                className="px-4 py-2 bg-slate-700 hover:bg-slate-600 rounded text-sm">
                                ðŸ”‘ Update Key
                            </button>
                            <button onClick={handleClear}
                                className="px-4 py-2 bg-red-900/50 hover:bg-red-900/70 text-red-400 border border-red-800 rounded text-sm">
                                ðŸ—‘ï¸ Remove
                            </button>
                        </div>
                    </div>
                ) : (
                    <div className="p-4 bg-slate-900/50 rounded-lg border border-dashed border-slate-600 text-center">
                        <div className="text-slate-400 text-sm mb-3">No service account configured</div>
                        <button onClick={() => setShowKeyInput(true)}
                            className="px-4 py-2 bg-indigo-600 hover:bg-indigo-500 rounded text-sm">
                            ðŸ”‘ Add Service Account Key
                        </button>
                    </div>
                )}
                
                {/* Key input area */}
                {showKeyInput && (
                    <div className="p-4 bg-slate-900 rounded-lg border border-indigo-500/30">
                        <div className="text-sm text-slate-300 mb-2 font-medium">
                            Paste Service Account JSON Key
                        </div>
                        <p className="text-xs text-slate-500 mb-3">
                            Firebase Console â†’ Project Settings â†’ Service Accounts â†’ Generate New Private Key. 
                            Paste the entire JSON file contents below.
                        </p>
                        <textarea
                            value={keyInput}
                            onChange={e => setKeyInput(e.target.value)}
                            placeholder='{"type": "service_account", "project_id": "...", ...}'
                            className="w-full h-32 bg-slate-800 border border-slate-600 rounded p-3 font-mono text-xs text-slate-300 resize-y"
                            spellCheck="false"
                        />
                        <div className="flex gap-2 mt-3">
                            <button onClick={handleSave} disabled={!keyInput.trim()}
                                className="px-4 py-2 bg-green-600 hover:bg-green-500 rounded text-sm disabled:opacity-50">
                                ðŸ’¾ Save Key
                            </button>
                            <button onClick={() => { setShowKeyInput(false); setKeyInput(''); setSaveResult(null); }}
                                className="px-4 py-2 bg-slate-700 hover:bg-slate-600 rounded text-sm">
                                Cancel
                            </button>
                        </div>
                        
                        {/* Save result */}
                        {saveResult && (
                            <div className={`mt-3 p-3 rounded text-sm ${saveResult.success ? 'bg-green-900/30 border border-green-700 text-green-300' : 'bg-red-900/30 border border-red-700 text-red-300'}`}>
                                {saveResult.success 
                                    ? `âœ… Saved â€” ${saveResult.email} (project: ${saveResult.project})`
                                    : `âŒ ${saveResult.error}`
                                }
                            </div>
                        )}
                    </div>
                )}
                
                {/* Test results */}
                {testResult && (
                    <div className="p-4 bg-slate-900 rounded-lg border border-slate-600">
                        <div className="text-sm font-medium text-slate-300 mb-3">Connection Test Results</div>
                        <div className="space-y-2">
                            <div className="flex items-center gap-2 text-sm">
                                <span className={testResult.token ? 'text-green-400' : 'text-red-400'}>
                                    {testResult.token ? 'âœ…' : 'âŒ'}
                                </span>
                                <span>OAuth2 Token</span>
                                <span className="text-slate-500 text-xs">â€” JWT signing & token exchange</span>
                            </div>
                            {testResult.rules !== undefined && (
                                <div className="flex items-center gap-2 text-sm">
                                    <span className={testResult.rules ? 'text-green-400' : 'text-red-400'}>
                                        {testResult.rules ? 'âœ…' : 'âŒ'}
                                    </span>
                                    <span>RTDB Rules</span>
                                    <span className="text-slate-500 text-xs">â€” read security rules via REST API</span>
                                </div>
                            )}
                            {testResult.authConfig !== undefined && (
                                <div className="flex items-center gap-2 text-sm">
                                    <span className={testResult.authConfig ? 'text-green-400' : 'text-red-400'}>
                                        {testResult.authConfig ? 'âœ…' : 'âŒ'}
                                    </span>
                                    <span>Auth Config</span>
                                    <span className="text-slate-500 text-xs">â€” Identity Toolkit authorized domains</span>
                                </div>
                            )}
                            {testResult.authorizedDomains && (
                                <div className="mt-1 ml-7 text-xs text-slate-500">
                                    {testResult.authorizedDomains.length} authorized domain{testResult.authorizedDomains.length !== 1 ? 's' : ''} configured
                                </div>
                            )}
                        </div>
                        {testResult.errors?.length > 0 && (
                            <div className="mt-3 space-y-1">
                                {testResult.errors.map((err, i) => (
                                    <div key={i} className="text-xs text-red-400 bg-red-900/20 px-3 py-1.5 rounded font-mono">{err}</div>
                                ))}
                            </div>
                        )}
                    </div>
                )}
                
                {/* Info about what admin access enables */}
                <div className="text-xs text-slate-500 space-y-1">
                    <div>Admin access enables:</div>
                    <div className="ml-3">â€¢ Read & deploy RTDB security rules</div>
                    <div className="ml-3">â€¢ List Cloud Functions and their status</div>
                    <div className="ml-3">â€¢ View Cloud Logging entries and errors</div>
                    <div className="ml-3">â€¢ Manage Firebase Auth authorized domains</div>
                    <div className="ml-3">â€¢ Admin-level RTDB data access</div>
                </div>
            </div>
        );
    }
    // =========================================================================
    // SETTINGS VIEW
    // =========================================================================
    
    function SettingsView({ token, setToken, repoCount, syncStatus, onForceSync, config, onConfigChange, firebaseUid, firebaseUser, teamMembers, teamMembership, showAlert, showConfirm, apps }) {
        const [settingsSection, setSettingsSection] = React.useState('deploy');
        const [show, setShow] = React.useState(false);
        const [testing, setTesting] = React.useState(false);
        const [result, setResult] = React.useState(null);
        const [storageDiag, setStorageDiag] = React.useState(null);
        const [cleanupResult, setCleanupResult] = React.useState(null);
        
        // Firebase Sync state
        const [syncAction, setSyncAction] = React.useState(null); // 'pushing' | 'pulling' | 'clearing'
        const [syncResult, setSyncResult] = React.useState(null);
        const [dataSize, setDataSize] = React.useState(null);
        const [loadingSize, setLoadingSize] = React.useState(false);
        const [lastSyncTime, setLastSyncTime] = React.useState(null);
        
        // Fetch data size on mount and when sync status changes
        React.useEffect(() => {
            if (FirebaseConfigSync.initialized && syncStatus === 'synced') {
                fetchDataSize();
            }
        }, [syncStatus]);
        
        const fetchDataSize = async () => {
            setLoadingSize(true);
            const size = await FirebaseConfigSync.getDataSize();
            setDataSize(size);
            setLoadingSize(false);
        };
        
        const formatBytes = (bytes) => {
            if (bytes < 1024) return `${bytes} B`;
            if (bytes < 1024 * 1024) return `${(bytes / 1024).toFixed(1)} KB`;
            return `${(bytes / (1024 * 1024)).toFixed(1)} MB`;
        };
        
        const handlePushAll = async () => {
            setSyncAction('pushing');
            setSyncResult(null);
            try {
                const localConfig = ConfigManager.load();
                const ok = await FirebaseConfigSync.pushAll({
                    config: localConfig
                });
                
                setSyncResult(ok ? { ok: true, msg: 'All local data pushed to Firebase' } : { ok: false, msg: 'Push failed' });
                setLastSyncTime(Date.now());
                await fetchDataSize();
            } catch (e) {
                setSyncResult({ ok: false, msg: e.message });
            }
            setSyncAction(null);
        };
        
        const handlePullAll = async () => {
            setSyncAction('pulling');
            setSyncResult(null);
            try {
                if (onForceSync) {
                    await onForceSync('pull');
                    setSyncResult({ ok: true, msg: 'Firebase data pulled and overlaid onto local state' });
                    setLastSyncTime(Date.now());
                } else {
                    setSyncResult({ ok: false, msg: 'Force sync not available' });
                }
            } catch (e) {
                setSyncResult({ ok: false, msg: e.message });
            }
            setSyncAction(null);
        };
        
        const handleClearFirebase = async () => {
            if (!window.confirm('Are you sure you want to clear ALL Command Center data from Firebase?\n\nThis cannot be undone. Your local data will remain intact.')) {
                return;
            }
            setSyncAction('clearing');
            setSyncResult(null);
            try {
                const ok = await FirebaseConfigSync.clearAll();
                setSyncResult(ok ? { ok: true, msg: 'All Command Center data cleared from Firebase' } : { ok: false, msg: 'Clear failed' });
                setDataSize({ totalBytes: 0, keys: {} });
            } catch (e) {
                setSyncResult({ ok: false, msg: e.message });
            }
            setSyncAction(null);
        };
        
        // Token expiration tracking (v8.3.3)
        const [tokenExpires, setTokenExpires] = React.useState(() => {
            try { return SecretManager.get('token_expires') || localStorage.getItem('cc_token_expires') || ''; } catch { return ''; }
        });
        
        const saveTokenWithExpiry = (newToken, days = 90) => {
            setToken(newToken);
            if (newToken) {
                const expires = new Date();
                expires.setDate(expires.getDate() + days);
                const expiresStr = expires.toISOString();
                setTokenExpires(expiresStr);
                try { SecretManager.set('token_expires', expiresStr); } catch {}
            }
        };
        
        const daysUntilExpiry = tokenExpires ? Math.ceil((new Date(tokenExpires) - new Date()) / (1000 * 60 * 60 * 24)) : null;
        const expiryWarning = daysUntilExpiry !== null && daysUntilExpiry <= 14;
        const expiryDanger = daysUntilExpiry !== null && daysUntilExpiry <= 3;
        
        return (
            <div className="space-y-6">
                {/* Settings Section Tabs (v8.71.0) */}
                <div className="flex gap-1 bg-slate-800/50 p-1 rounded-lg border border-slate-700">
                    {[
                        { id: 'deploy', icon: 'ðŸš€', label: 'Deploy Management' },
                        { id: 'infrastructure', icon: 'ðŸ”§', label: 'Infrastructure' },
                        { id: 'credentials', icon: 'ðŸ”‘', label: 'Credentials' }
                    ].map(tab => (
                        <button key={tab.id}
                            onClick={() => setSettingsSection(tab.id)}
                            className={`flex-1 px-3 py-2 rounded text-sm font-medium transition-colors flex items-center justify-center gap-1.5 ${
                                settingsSection === tab.id
                                    ? 'bg-indigo-600 text-white shadow-sm'
                                    : 'text-slate-400 hover:text-white hover:bg-slate-700'
                            }`}>
                            <span>{tab.icon}</span> {tab.label}
                        </button>
                    ))}
                </div>

                {/* â•â•â• DEPLOY MANAGEMENT SECTION â•â•â• */}
                <div style={{ display: settingsSection === 'deploy' ? 'contents' : 'none' }}>
                {/* Your Name (v8.37.0) */}
                <div className="bg-slate-800 rounded-xl border border-slate-700 p-6">
                    <h2 className="text-lg font-semibold mb-2 flex items-center gap-2">
                        ðŸ‘¤ Your Name
                    </h2>
                    <p className="text-sm text-slate-400 mb-3">
                        Used to attribute work items, deploys, and session activity. Leave blank to use "Owner".
                    </p>
                    <input 
                        type="text" 
                        value={config?.ownerName || ''} 
                        onChange={e => {
                            if (onConfigChange) {
                                onConfigChange({ ...config, ownerName: e.target.value });
                            }
                        }}
                        placeholder="e.g. Dave"
                        className="w-full max-w-xs p-2 bg-slate-700 border border-slate-600 rounded text-sm focus:border-indigo-500 focus:outline-none" />
                    {config?.ownerName && (
                        <div className="mt-2 text-xs text-green-400">âœ“ Records will be attributed to "{config.ownerName}"</div>
                    )}
                </div>
                
                {/* v8.71.0: Anthropic API Key moved to Credentials section */}

                {/* Team Management (v8.46.0 â€” Phase 5.7) */}
                <div className="bg-slate-800 rounded-xl border border-slate-700 p-6">
                    <h2 className="text-lg font-semibold mb-2 flex items-center gap-2">
                        ðŸ‘¥ Team
                        <span className="px-2 py-0.5 bg-slate-600/50 text-slate-400 text-xs rounded-full font-medium">Coming Soon</span>
                    </h2>
                    <p className="text-sm text-slate-500 mb-4">
                        Invite collaborators to share your Command Center workspace. Team members see your apps, work items, streams, and activity.
                    </p>

                    <div style={{ opacity: 0.4, pointerEvents: 'none' }}>
                    {!firebaseUid ? (
                        <div className="text-sm text-amber-400 bg-amber-900/20 border border-amber-700/30 rounded-lg p-3">
                            âš ï¸ Sign in with Google to manage team members
                        </div>
                    ) : teamMembership ? (
                        <div className="text-sm text-slate-300 bg-slate-700/50 rounded-lg p-3">
                            You're a <span className="font-semibold text-indigo-400">{teamMembership.role}</span> in{' '}
                            <span className="font-semibold">{teamMembership.workspaceName || 'a shared workspace'}</span>.
                            Team management is handled by the workspace owner.
                        </div>
                    ) : (() => {
                        const [inviteEmail, setInviteEmail] = React.useState('');
                        const [inviteRole, setInviteRole] = React.useState('editor');
                        const [inviting, setInviting] = React.useState(false);
                        const [showRules, setShowRules] = React.useState(false);
                        
                        const handleInvite = async () => {
                            if (!inviteEmail.trim() || !inviteEmail.includes('@')) return;
                            setInviting(true);
                            try {
                                await TeamService.invite(firebaseUid, inviteEmail.trim(), inviteRole, config?.ownerName || 'Owner');
                                setInviteEmail('');
                            } catch (e) {
                                console.error('[Team] Invite failed:', e);
                            }
                            setInviting(false);
                        };
                        
                        return (
                            <div className="space-y-4">
                                {/* Current owner */}
                                <div className="flex items-center gap-3 p-3 bg-slate-700/30 rounded-lg">
                                    {firebaseUser?.photoURL ? (
                                        <img src={firebaseUser.photoURL} className="w-8 h-8 rounded-full" alt="" />
                                    ) : (
                                        <div className="w-8 h-8 rounded-full bg-indigo-600 flex items-center justify-center text-sm font-bold">
                                            {(config?.ownerName || 'O')[0]}
                                        </div>
                                    )}
                                    <div className="flex-1">
                                        <div className="text-sm font-medium">{config?.ownerName || firebaseUser?.displayName || 'Owner'}</div>
                                        <div className="text-xs text-slate-400">{firebaseUser?.email}</div>
                                    </div>
                                    <span className="px-2 py-0.5 bg-indigo-600/30 text-indigo-300 text-xs rounded-full font-medium">Owner</span>
                                </div>
                                
                                {/* Team members list */}
                                {(teamMembers || []).length > 0 && (
                                    <div className="space-y-2">
                                        {(teamMembers || []).map(member => (
                                            <div key={member.uid} className="flex items-center gap-3 p-3 bg-slate-700/30 rounded-lg">
                                                {member.photoURL ? (
                                                    <img src={member.photoURL} className="w-8 h-8 rounded-full" alt="" />
                                                ) : (
                                                    <div className="w-8 h-8 rounded-full bg-slate-600 flex items-center justify-center text-sm font-bold">
                                                        {(member.name || member.email || '?')[0]}
                                                    </div>
                                                )}
                                                <div className="flex-1">
                                                    <div className="text-sm font-medium">{member.name || member.email}</div>
                                                    <div className="text-xs text-slate-400">{member.email}</div>
                                                </div>
                                                <div className="flex items-center gap-2">
                                                    {member.status === 'invited' && (
                                                        <span className="px-2 py-0.5 bg-amber-600/20 text-amber-400 text-xs rounded-full">Pending</span>
                                                    )}
                                                    <select value={member.role} onChange={async (e) => {
                                                        try { await TeamService.updateRole(firebaseUid, member.uid, e.target.value); }
                                                        catch (err) { console.error('[Team] Role update failed:', err); }
                                                    }} className="px-2 py-0.5 bg-slate-700 border border-slate-600 rounded text-xs">
                                                        <option value="editor">Editor</option>
                                                        <option value="viewer">Viewer</option>
                                                    </select>
                                                    <button onClick={async () => {
                                                        if (window.confirm(`Remove ${member.name || member.email} from team?`)) {
                                                            try { await TeamService.remove(firebaseUid, member.uid); }
                                                            catch (err) { console.error('[Team] Remove failed:', err); }
                                                        }
                                                    }} className="text-red-400 hover:text-red-300 text-xs px-1" title="Remove">âœ•</button>
                                                </div>
                                            </div>
                                        ))}
                                    </div>
                                )}
                                
                                {/* Invite form */}
                                <div className="flex gap-2">
                                    <input type="email" value={inviteEmail} onChange={e => setInviteEmail(e.target.value)}
                                        placeholder="email@example.com"
                                        onKeyDown={e => e.key === 'Enter' && handleInvite()}
                                        className="flex-1 p-2 bg-slate-700 border border-slate-600 rounded text-sm focus:border-indigo-500 focus:outline-none" />
                                    <select value={inviteRole} onChange={e => setInviteRole(e.target.value)}
                                        className="px-2 bg-slate-700 border border-slate-600 rounded text-xs">
                                        <option value="editor">Editor</option>
                                        <option value="viewer">Viewer</option>
                                    </select>
                                    <button onClick={handleInvite} disabled={inviting || !inviteEmail.includes('@')}
                                        className="px-4 py-2 bg-indigo-600 hover:bg-indigo-500 disabled:opacity-50 rounded text-sm font-medium">
                                        {inviting ? '...' : 'Invite'}
                                    </button>
                                </div>
                                
                                {/* v8.71.7: Firebase Security Rules viewer removed â€” rules will be automated when team capability is activated */}
                            </div>
                        );
                    })()}
                    </div>
                </div>

                {/* v8.71.0: GitHub Token + Firebase Admin moved to Credentials section */}
                
                {/* v8.71.0: Domain management moved to Infrastructure section */}
                {/* Firebase Config Sync (v8.18.0) */}
                <div className="bg-slate-800 rounded-xl border border-slate-700 p-6">
                    <h2 className="text-lg font-semibold mb-4 flex items-center gap-2">
                        â˜ï¸ Firebase Config Sync
                    </h2>
                    <p className="text-sm text-slate-400 mb-4">
                        Non-sensitive CC data (config, deploy history, session log, rules history) is synced to Firebase RTDB at <code className="text-xs bg-slate-700 px-1.5 py-0.5 rounded">command-center/</code>. 
                        Secrets (GitHub PAT, Firebase SA key) stay in localStorage only.
                    </p>
                    
                    {/* Status row */}
                    <div className="grid grid-cols-1 sm:grid-cols-3 gap-3 mb-4">
                        <div className="bg-slate-700/50 rounded-lg p-3">
                            <div className="text-xs text-slate-400 mb-1">Status</div>
                            <div className="text-sm font-medium flex items-center gap-2">
                                {syncStatus === 'synced' && <><span className="text-green-400">â˜ï¸</span> Synced</>}
                                {syncStatus === 'syncing' && <><span className="text-yellow-400 animate-pulse">ðŸ”„</span> Syncing...</>}
                                {syncStatus === 'offline' && <><span className="text-slate-500">âš¡</span> Offline</>}
                                {syncStatus === 'error' && <><span className="text-red-400">âš ï¸</span> Error</>}
                            </div>
                        </div>
                        <div className="bg-slate-700/50 rounded-lg p-3">
                            <div className="text-xs text-slate-400 mb-1">Firebase Data Size</div>
                            <div className="text-sm font-medium">
                                {loadingSize ? '...' : dataSize ? formatBytes(dataSize.totalBytes) : 'â€”'}
                                {!loadingSize && dataSize && dataSize.totalBytes > 0 && (
                                    <button onClick={fetchDataSize} className="ml-2 text-xs text-slate-400 hover:text-slate-300">ðŸ”„</button>
                                )}
                            </div>
                        </div>
                        <div className="bg-slate-700/50 rounded-lg p-3">
                            <div className="text-xs text-slate-400 mb-1">Last Manual Sync</div>
                            <div className="text-sm font-medium">
                                {lastSyncTime ? new Date(lastSyncTime).toLocaleTimeString() : 'â€”'}
                            </div>
                        </div>
                    </div>
                    
                    {/* Data breakdown */}
                    {dataSize && dataSize.keys && Object.keys(dataSize.keys).length > 0 && (
                        <div className="mb-4 bg-slate-700/30 rounded-lg p-3">
                            <div className="text-xs text-slate-400 mb-2">Data Breakdown</div>
                            <div className="grid grid-cols-2 sm:grid-cols-3 gap-2">
                                {Object.entries(dataSize.keys).sort((a, b) => b[1] - a[1]).map(([key, bytes]) => (
                                    <div key={key} className="flex justify-between items-center text-xs">
                                        <span className="text-slate-300">{key}</span>
                                        <span className="text-slate-500 ml-2">{formatBytes(bytes)}</span>
                                    </div>
                                ))}
                            </div>
                        </div>
                    )}
                    
                    {/* Action buttons */}
                    <div className="flex flex-wrap gap-2 mb-3">
                        <button 
                            onClick={handlePushAll}
                            disabled={!!syncAction || !FirebaseConfigSync.initialized}
                            className="px-4 py-2 bg-indigo-600 hover:bg-indigo-500 disabled:opacity-50 disabled:cursor-not-allowed rounded text-sm font-medium transition-colors">
                            {syncAction === 'pushing' ? 'â³ Pushing...' : 'â¬†ï¸ Push All to Firebase'}
                        </button>
                        <button 
                            onClick={handlePullAll}
                            disabled={!!syncAction || !FirebaseConfigSync.initialized}
                            className="px-4 py-2 bg-emerald-700 hover:bg-emerald-600 disabled:opacity-50 disabled:cursor-not-allowed rounded text-sm font-medium transition-colors">
                            {syncAction === 'pulling' ? 'â³ Pulling...' : 'â¬‡ï¸ Pull All from Firebase'}
                        </button>
                        <button 
                            onClick={handleClearFirebase}
                            disabled={!!syncAction || !FirebaseConfigSync.initialized}
                            className="px-4 py-2 bg-red-900/50 text-red-400 border border-red-700 hover:bg-red-900 disabled:opacity-50 disabled:cursor-not-allowed rounded text-sm font-medium transition-colors">
                            {syncAction === 'clearing' ? 'â³ Clearing...' : 'ðŸ—‘ï¸ Clear Firebase Data'}
                        </button>
                    </div>
                    
                    {!FirebaseConfigSync.initialized && (
                        <div className="text-sm text-amber-400 mb-3">âš ï¸ Firebase not initialized â€” sync features unavailable</div>
                    )}
                    
                    {/* Result feedback */}
                    {syncResult && (
                        <div className={`p-3 rounded-lg text-sm ${syncResult.ok ? 'bg-green-900/30 border border-green-700 text-green-400' : 'bg-red-900/30 border border-red-700 text-red-400'}`}>
                            {syncResult.ok ? 'âœ“' : 'âœ—'} {syncResult.msg}
                        </div>
                    )}
                </div>
                
                {/* AI Engines (v8.21.0) */}
                <div className="bg-slate-800 rounded-xl border border-slate-700 p-6">
                    <h2 className="text-lg font-semibold mb-4 flex items-center gap-2">
                        ðŸ¤– AI Engines
                    </h2>
                    <p className="text-sm text-slate-400 mb-4">
                        Engine profiles used for context budget calculations in Claude Prep. Set your default engine to match your primary Claude plan.
                    </p>
                    
                    {/* Default Engine Selector */}
                    <div className="mb-4">
                        <label className="text-xs text-slate-400 block mb-1.5">Default Engine</label>
                        <select 
                            value={EngineRegistryService.getDefault()}
                            onChange={e => { EngineRegistryService.setDefault(e.target.value); }}
                            className="w-full sm:w-auto p-2 bg-slate-700 border border-slate-600 rounded text-sm"
                        >
                            {EngineRegistryService.getAll().map(e => (
                                <option key={e.id} value={e.id}>{e.name} â€” {TokenRegistryService.formatTokens(e.contextWindow)} context</option>
                            ))}
                        </select>
                    </div>
                    
                    {/* Engine Comparison Table */}
                    <div className="overflow-x-auto -mx-2 px-2">
                        <table className="w-full text-xs">
                            <thead>
                                <tr className="text-slate-500 border-b border-slate-700">
                                    <th className="text-left py-2 px-2 font-medium">Engine</th>
                                    <th className="text-center py-2 px-1 font-medium">Tier</th>
                                    <th className="text-right py-2 px-2 font-medium">Context</th>
                                    <th className="text-right py-2 px-2 font-medium">Extended</th>
                                    <th className="text-right py-2 px-2 font-medium">~$/Session</th>
                                    <th className="text-center py-2 px-1 font-medium">Projects</th>
                                    <th className="text-center py-2 px-1 font-medium">Skills</th>
                                </tr>
                            </thead>
                            <tbody>
                                {EngineRegistryService.getAll().map(engine => {
                                    const isDefault = engine.id === EngineRegistryService.getDefault();
                                    const tierColors = { fast: 'text-cyan-400 bg-cyan-900/30', balanced: 'text-blue-400 bg-blue-900/30', flagship: 'text-purple-400 bg-purple-900/30' };
                                    return (
                                        <tr key={engine.id} className={`border-b border-slate-800 ${isDefault ? 'bg-indigo-900/20' : 'hover:bg-slate-700/30'}`}>
                                            <td className="py-2 px-2">
                                                <div className="flex items-center gap-1.5">
                                                    {isDefault && <span className="text-indigo-400 text-[10px]">â˜…</span>}
                                                    <span className={`font-medium ${isDefault ? 'text-indigo-300' : 'text-slate-300'}`}>{engine.name}</span>
                                                </div>
                                                <div className="text-[10px] text-slate-500 mt-0.5">{engine.strengths.slice(0, 2).join(', ')}</div>
                                            </td>
                                            <td className="py-2 px-1 text-center">
                                                <span className={`px-1.5 py-0.5 rounded text-[10px] font-medium ${tierColors[engine.tier] || 'text-slate-400'}`}>
                                                    {engine.tier}
                                                </span>
                                            </td>
                                            <td className="py-2 px-2 text-right text-slate-300 font-mono">{TokenRegistryService.formatTokens(engine.contextWindow)}</td>
                                            <td className="py-2 px-2 text-right font-mono">
                                                {engine.contextWindowExtended 
                                                    ? <span className="text-green-400">{TokenRegistryService.formatTokens(engine.contextWindowExtended)}</span>
                                                    : <span className="text-slate-600">â€”</span>
                                                }
                                            </td>
                                            <td className="py-2 px-2 text-right text-slate-400 font-mono" title={`$${engine.cost.input.toFixed(2)}/$${engine.cost.output.toFixed(2)} per MTok`}>
                                                ~${(EngineRegistryService.estimateSessionCost(50000, 10000, engine.id)?.totalCost || 0).toFixed(2)}
                                            </td>
                                            <td className="py-2 px-1 text-center">{engine.features.projects ? <span className="text-green-400">âœ“</span> : <span className="text-slate-600">â€”</span>}</td>
                                            <td className="py-2 px-1 text-center">{engine.features.skills ? <span className="text-green-400">âœ“</span> : <span className="text-slate-600">â€”</span>}</td>
                                        </tr>
                                    );
                                })}
                            </tbody>
                        </table>
                    </div>
                    
                    {/* Engine Details (expandable) */}
                    <details className="mt-3">
                        <summary className="text-xs text-slate-500 cursor-pointer hover:text-slate-300 select-none">Session type â†’ engine recommendations</summary>
                        <div className="mt-2 grid grid-cols-2 sm:grid-cols-4 gap-2">
                            {SessionBriefGenerator.getAll().map(t => {
                                const engine = EngineRegistryService.get(t.suggestedEngine);
                                return (
                                    <div key={t.id} className="bg-slate-900 rounded px-2.5 py-1.5" title={t.description}>
                                        <div className="text-[10px] text-slate-500 uppercase flex items-center gap-1">{t.icon} {t.label}</div>
                                        <div className="text-xs text-slate-300">{engine?.name?.split(' ').pop()}</div>
                                    </div>
                                );
                            })}
                        </div>
                    </details>
                </div>
                
                {/* v8.70.15: Removed Options section (createTag was deploy-only) */}
                
                <div className="bg-slate-800 rounded-xl border border-slate-700 p-6">
                    <h2 className="text-lg font-semibold mb-4">Reset</h2>
                    <div className="space-y-3">
                        <button onClick={() => { 
                            localStorage.removeItem('cc_apps_v6'); 
                            location.reload(); 
                        }}
                            className="px-4 py-2 bg-amber-900/50 text-amber-400 border border-amber-700 rounded mr-3">
                            Reset App Mappings
                        </button>
                        <button onClick={() => { localStorage.clear(); location.reload(); }}
                            className="px-4 py-2 bg-red-900/50 text-red-400 border border-red-700 rounded">
                            Clear All Data
                        </button>
                        <p className="text-xs text-slate-500 mt-2">
                            "Reset App Mappings" keeps your token but resets all appâ†’repo mappings to defaults and re-runs auto-detection.
                        </p>
                    </div>
                </div>
                
                {/* Storage Management */}
                <div className="bg-slate-800 rounded-xl border border-slate-700 p-6">
                    <h2 className="text-lg font-semibold mb-4 flex items-center gap-2">
                        ðŸ’¾ Local Storage
                    </h2>
                    
                    {!storageDiag ? (
                        <button onClick={() => setStorageDiag(StorageManager.getDiagnostics())}
                            className="px-4 py-2 bg-slate-700 rounded hover:bg-slate-600 text-sm">
                            ðŸ“Š Analyze Storage
                        </button>
                    ) : (
                        <div className="space-y-3">
                            {/* Usage bar */}
                            <div>
                                <div className="flex justify-between text-sm mb-1">
                                    <span>{storageDiag.totalFormatted} / {storageDiag.quotaFormatted}</span>
                                    <span className={storageDiag.percent > 80 ? 'text-red-400' : storageDiag.percent > 60 ? 'text-amber-400' : 'text-green-400'}>
                                        {storageDiag.percent}%
                                    </span>
                                </div>
                                <div className="w-full bg-slate-700 rounded-full h-3">
                                    <div className={`h-3 rounded-full transition-all ${
                                        storageDiag.percent > 80 ? 'bg-red-500' : storageDiag.percent > 60 ? 'bg-amber-500' : 'bg-green-500'
                                    }`} style={{ width: `${Math.min(storageDiag.percent, 100)}%` }} />
                                </div>
                            </div>
                            
                            {/* Breakdown */}
                            <div className="space-y-1 max-h-48 overflow-y-auto">
                                {storageDiag.entries.map(e => (
                                    <div key={e.key} className="flex items-center gap-2 text-xs">
                                        <span className={`w-2 h-2 rounded-full ${e.protected ? 'bg-blue-400' : 'bg-slate-500'}`} />
                                        <span className="flex-1 font-mono truncate text-slate-400">{e.key}</span>
                                        <span className="text-slate-500">{e.sizeFormatted}</span>
                                        <span className="text-slate-600 w-10 text-right">{e.percent}%</span>
                                    </div>
                                ))}
                            </div>
                            <div className="text-xs text-slate-500">
                                <span className="inline-flex items-center gap-1"><span className="w-2 h-2 rounded-full bg-blue-400 inline-block" /> Protected</span>
                                {' Â· '}
                                <span className="inline-flex items-center gap-1"><span className="w-2 h-2 rounded-full bg-slate-500 inline-block" /> Prunable</span>
                            </div>
                            
                            {/* Actions */}
                            <div className="flex gap-2 pt-2">
                                <button onClick={() => {
                                    const r = StorageManager.cleanup(false);
                                    setCleanupResult(r);
                                    setStorageDiag(StorageManager.getDiagnostics());
                                }} className="px-3 py-1.5 bg-amber-700 rounded hover:bg-amber-600 text-sm">
                                    ðŸ§¹ Smart Cleanup
                                </button>
                                <button onClick={() => {
                                    const r = StorageManager.cleanup(true);
                                    setCleanupResult(r);
                                    setStorageDiag(StorageManager.getDiagnostics());
                                }} className="px-3 py-1.5 bg-red-700 rounded hover:bg-red-600 text-sm">
                                    ðŸ—‘ï¸ Aggressive Cleanup
                                </button>
                                <button onClick={() => { setStorageDiag(StorageManager.getDiagnostics()); setCleanupResult(null); }}
                                    className="px-3 py-1.5 bg-slate-700 rounded hover:bg-slate-600 text-sm">
                                    ðŸ”„ Refresh
                                </button>
                            </div>
                            
                            {cleanupResult && (
                                <div className="p-3 bg-slate-900 rounded text-xs space-y-1">
                                    <div className="text-green-400">Freed {StorageManager._formatBytes(cleanupResult.freed)}</div>
                                    {cleanupResult.actions.map((a, i) => (
                                        <div key={i} className="text-slate-400">
                                            {a.key}: {a.action} ({StorageManager._formatBytes(a.freed)})
                                        </div>
                                    ))}
                                    {cleanupResult.actions.length === 0 && (
                                        <div className="text-slate-500">Nothing to clean up</div>
                                    )}
                                </div>
                            )}
                        </div>
                    )}
                </div>
                </div>

                {/* â•â•â• INFRASTRUCTURE SECTION â•â•â• */}
                <div style={{ display: settingsSection === 'infrastructure' ? 'block' : 'none' }}>
                <div className="space-y-6">
                    {/* v8.71.7: FirebaseRulesManager removed â€” rules managed via firebase-functions repo, not UI */}
                    <DomainsView apps={apps} config={config} githubToken={token} showAlert={showAlert} showConfirm={showConfirm} />
                    <AuthorizedDomainsManager showAlert={showAlert} />
                </div>
                </div>

                {/* â•â•â• CREDENTIALS SECTION â•â•â• */}
                <div className="space-y-6" style={{ display: settingsSection === 'credentials' ? 'flex' : 'none', flexDirection: 'column', gap: '1.5rem' }}>
                {/* GitHub Token */}
                <div className="bg-slate-800 rounded-xl border border-slate-700 p-6">
                    <h2 className="text-lg font-semibold mb-4 flex items-center gap-2">
                        ðŸ”‘ GitHub Token
                    </h2>
                    <p className="text-sm text-slate-400 mb-3">
                        Personal Access Token for GitHub API operations. Required for deploys and domain wiring.
                    </p>
                    <div className="flex items-center gap-2 mb-3">
                        <span className={`inline-block w-2 h-2 rounded-full ${token ? 'bg-green-400' : 'bg-red-400'}`}></span>
                        <span className="text-sm text-slate-300">{token ? 'Configured' : 'Not configured'}</span>
                        {daysUntilExpiry !== null && (
                            <span className={`text-xs px-2 py-0.5 rounded ${expiryDanger ? 'bg-red-900/50 text-red-300' : expiryWarning ? 'bg-amber-900/50 text-amber-300' : 'bg-green-900/50 text-green-300'}`}>
                                {daysUntilExpiry > 0 ? `${daysUntilExpiry}d until expiry` : 'Expired'}
                            </span>
                        )}
                    </div>
                    <div className="flex gap-2 mb-2">
                        <input type={show ? 'text' : 'password'} value={token || ''} onChange={e => saveTokenWithExpiry(e.target.value)}
                            placeholder="ghp_xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx"
                            className="flex-1 p-2 bg-slate-700 border border-slate-600 rounded text-sm font-mono focus:border-indigo-500 focus:outline-none" />
                        <button onClick={() => setShow(!show)} className="px-3 py-2 bg-slate-700 hover:bg-slate-600 rounded text-sm">{show ? 'ðŸ™ˆ' : 'ðŸ‘ï¸'}</button>
                        <button onClick={async () => {
                            setTesting(true);
                            try { const gh = new GitHubAPI(token); const r = await gh.listRepos(); setResult({ ok: true, count: r.length }); }
                            catch (e) { setResult({ ok: false, error: e.message }); }
                            setTesting(false);
                        }} disabled={testing} className="px-4 py-2 bg-indigo-600 hover:bg-indigo-500 rounded text-sm">{testing ? '...' : 'Test'}</button>
                    </div>
                    <div className="flex items-center gap-4">
                        <a href="https://github.com/settings/tokens/new?scopes=repo" target="_blank" className="text-xs text-indigo-400">Create token â†’</a>
                        {token && (
                            <button onClick={() => saveTokenWithExpiry(token, 90)}
                                className="text-xs px-2 py-1 bg-slate-700 border border-slate-600 rounded hover:bg-slate-600">
                                ðŸ”„ Reset 90-day timer
                            </button>
                        )}
                    </div>
                    {result && <div className={`mt-2 text-sm ${result.ok ? 'text-green-400' : 'text-red-400'}`}>
                        {result.ok ? `âœ“ Found ${result.count} repos` : `âœ— ${result.error}`}
                    </div>}
                </div>

                {/* Anthropic API Key */}
                {(() => {
                    const [apiKeyVal, setApiKeyVal] = React.useState(() => {
                        try { return SecretManager.get('anthropic_api_key') || localStorage.getItem('cc_anthropic_api_key') || ''; } catch { return ''; }
                    });
                    const [showKey, setShowKey] = React.useState(false);
                    const [saved, setSaved] = React.useState(false);
                    return (
                        <div className="bg-slate-800 rounded-xl border border-slate-700 p-6">
                            <h2 className="text-lg font-semibold mb-4 flex items-center gap-2">ðŸ¤– Anthropic API Key</h2>
                            <div className="flex items-center gap-2 mb-3">
                                <span className={`inline-block w-2 h-2 rounded-full ${apiKeyVal ? 'bg-green-400' : 'bg-red-400'}`}></span>
                                <span className="text-sm text-slate-300">{apiKeyVal ? 'Configured' : 'Not configured'}</span>
                            </div>
                            <div className="flex gap-2">
                                <input type={showKey ? 'text' : 'password'} value={apiKeyVal}
                                    onChange={e => { setApiKeyVal(e.target.value); setSaved(false); }}
                                    placeholder="sk-ant-api03-..."
                                    className="flex-1 p-2 bg-slate-700 border border-slate-600 rounded text-sm font-mono focus:border-indigo-500 focus:outline-none" />
                                <button onClick={() => setShowKey(!showKey)} className="px-3 py-2 bg-slate-700 hover:bg-slate-600 rounded text-sm">{showKey ? 'ðŸ™ˆ' : 'ðŸ‘ï¸'}</button>
                                <button onClick={() => { SecretManager.set('anthropic_api_key', apiKeyVal); localStorage.setItem('cc_api_key', apiKeyVal); localStorage.setItem('cc_anthropic_api_key', apiKeyVal); setSaved(true); }}
                                    className="px-3 py-2 bg-indigo-600 hover:bg-indigo-500 rounded text-sm">{saved ? 'âœ“ Saved' : 'Save'}</button>
                            </div>
                            {saved && <div className="mt-2 text-xs text-green-400">âœ“ API key saved</div>}
                        </div>
                    );
                })()}

                {/* Firebase Service Account */}
                <div className="bg-slate-800 rounded-xl border border-slate-700 p-6">
                    <h2 className="text-lg font-semibold mb-4 flex items-center gap-2">
                        ðŸ”¥ Firebase Service Account
                    </h2>
                    <p className="text-sm text-slate-400 mb-4">
                        Service account credentials for admin access to Firebase RTDB rules, Auth domains, and Cloud APIs.
                        Generate a key at <a href="https://console.firebase.google.com/project/word-boxing/settings/serviceaccounts/adminsdk" target="_blank" className="text-indigo-400 hover:underline">Firebase Console â†’ Service Accounts</a>.
                    </p>
                    <FirebaseAdminSettings />
                </div>

                {/* Domain Registrar Credentials */}
                {DomainProviderRegistry.getAll().map(provider => {
                    const CredCard = () => {
                        const [cfg, setCfg] = React.useState(() => provider.service.getConfig());
                        const [editing, setEditing] = React.useState(false);
                        const [draft, setDraft] = React.useState({});
                        const [pinging, setPinging] = React.useState(false);
                        const [pingResult, setPingResult] = React.useState(null);
                        const isConfigured = provider.service.isConfigured();

                        const handleSave = () => {
                            provider.service.saveConfig(editing ? { ...cfg, ...draft } : cfg);
                            setCfg(provider.service.getConfig());
                            setEditing(false);
                            setDraft({});
                            setPingResult(null);
                        };

                        const handleClear = () => {
                            localStorage.removeItem(provider.configKey);
                            setCfg({});
                            setPingResult(null);
                        };

                        const handlePing = async () => {
                            setPinging(true);
                            setPingResult(null);
                            try {
                                const result = await provider.service.ping();
                                const detail = result.domainCount !== undefined
                                    ? ` (${result.domainCount} domain${result.domainCount !== 1 ? 's' : ''} found)`
                                    : '';
                                setPingResult({ ok: true, detail });
                            } catch (e) {
                                setPingResult({ ok: false, error: e.message });
                            }
                            setPinging(false);
                        };

                        return (
                            <div className="bg-slate-800 rounded-xl border border-slate-700 p-6">
                                <h2 className="text-lg font-semibold mb-4 flex items-center gap-2">
                                    {provider.icon} {provider.name} API Keys
                                </h2>
                                <div className="flex items-center gap-2 mb-3">
                                    <span className={`inline-block w-2 h-2 rounded-full ${isConfigured ? 'bg-green-400' : 'bg-red-400'}`}></span>
                                    <span className="text-sm text-slate-300">{isConfigured ? 'Configured' : 'Not configured'}</span>
                                    {isConfigured && !editing && (
                                        <div className="ml-auto flex gap-2">
                                            <button onClick={handlePing} disabled={pinging} className="px-2 py-1 text-xs bg-slate-700 hover:bg-slate-600 rounded">
                                                {pinging ? 'â³' : 'ðŸ”Œ Test'}
                                            </button>
                                            <button onClick={() => { setEditing(true); setDraft(cfg); }} className="px-2 py-1 text-xs bg-slate-700 hover:bg-slate-600 rounded">âœï¸ Edit</button>
                                            <button onClick={handleClear} className="px-2 py-1 text-xs bg-red-900/50 hover:bg-red-800/50 text-red-300 rounded">ðŸ—‘ï¸ Clear</button>
                                        </div>
                                    )}
                                </div>
                                {pingResult && (
                                    <div className={`mb-3 p-2 rounded text-xs ${pingResult.ok ? 'bg-green-900/30 text-green-300' : 'bg-red-900/30 text-red-300'}`}>
                                        {pingResult.ok ? `âœ… Connection successful${pingResult.detail || ''}` : `âŒ ${pingResult.error}`}
                                    </div>
                                )}
                                {(!isConfigured || editing) && (
                                    <div className="space-y-3">
                                        {provider.keyFields.map(field => (
                                            <div key={field.key}>
                                                <label className="text-xs text-slate-400 mb-1 block">{field.label}</label>
                                                {field.type === 'select' ? (
                                                    <select
                                                        value={editing ? (draft[field.key] || field.default || '') : (cfg[field.key] || field.default || '')}
                                                        onChange={e => editing ? setDraft({...draft, [field.key]: e.target.value}) : setCfg({...cfg, [field.key]: e.target.value})}
                                                        className="w-full p-2 bg-slate-700 border border-slate-600 rounded text-sm focus:border-indigo-500 focus:outline-none"
                                                    >
                                                        {field.options.map(opt => (
                                                            <option key={opt.value} value={opt.value}>{opt.label}</option>
                                                        ))}
                                                    </select>
                                                ) : (
                                                    <input type="password"
                                                        value={editing ? (draft[field.key] || '') : (cfg[field.key] || '')}
                                                        onChange={e => editing ? setDraft({...draft, [field.key]: e.target.value}) : setCfg({...cfg, [field.key]: e.target.value})}
                                                        placeholder={field.placeholder}
                                                        className="w-full p-2 bg-slate-700 border border-slate-600 rounded text-sm font-mono focus:border-indigo-500 focus:outline-none" />
                                                )}
                                            </div>
                                        ))}
                                        <div className="flex gap-2">
                                            <button onClick={handleSave}
                                                className="px-3 py-2 bg-indigo-600 hover:bg-indigo-500 rounded text-sm">Save</button>
                                            {editing && <button onClick={() => { setEditing(false); setDraft({}); }}
                                                className="px-3 py-2 bg-slate-700 hover:bg-slate-600 rounded text-sm">Cancel</button>}
                                        </div>
                                        <p className="text-xs text-slate-500">
                                            {provider.setupNote} <a href={provider.setupUrl} target="_blank" className="text-indigo-400 hover:underline">Get API keys â†’</a>
                                        </p>
                                    </div>
                                )}
                            </div>
                        );
                    };
                    return <CredCard key={provider.id} />;
                })}
                </div>
            </div>
        );
    }

    // =========================================================================
    // RENDER
    // =========================================================================
    
    try {
        ReactDOM.createRoot(document.getElementById('root')).render(<App />);
    } catch (error) {
        document.getElementById('root').innerHTML = `<div style="padding:20px;background:#7f1d1d;margin:20px;border-radius:10px;">
            <h2>Error</h2><pre>${error.message}</pre>
            <button onclick="localStorage.clear();location.reload();" style="margin-top:10px;padding:10px;cursor:pointer;">Clear & Reload</button>
        </div>`;
    }
    </script>
</body>
</html>
